<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:08:36 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3243/HBASE-3243.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3243] Disable Table closed region on wrong host</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3243</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I ran some YCSB benchmarks which resulted in about 150 regions worth of data overnight. Then I disabled the table, and the master for some reason closed one region on the wrong server. The server ignored this, but the region remained open on a different server, which later flipped out when it tried to flush due to hlog accumulation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12480177">HBASE-3243</key>
            <summary>Disable Table closed region on wrong host</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="tlipcon">Todd Lipcon</reporter>
                        <labels>
                            <label>delete</label>
                    </labels>
                <created>Wed, 17 Nov 2010 04:56:57 +0000</created>
                <updated>Tue, 13 Jan 2015 00:47:16 +0000</updated>
                            <resolved>Tue, 13 Jan 2015 00:47:16 +0000</resolved>
                                    <version>0.90.0</version>
                                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12932814" author="tlipcon" created="Wed, 17 Nov 2010 05:05:01 +0000"  >&lt;p&gt;Here are some relevant logs... the region in question is user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1&lt;/p&gt;

&lt;p&gt;Here&apos;s the birth of the region on haus01:&lt;br/&gt;
2010-11-16 02:28:10,471 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Instantiated usertable,user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1.&lt;br/&gt;
2010-11-16 02:28:11,432 INFO org.apache.hadoop.hbase.regionserver.CompactSplitThread: Region split, META updated, and report to master. Parent=usertable,user1057689679,1289901563182.24d8aec47045a86b97b3508ed16ced29., new regions: usertable,user1057689679,1289903283192.b313a3864e1eb1aaf2a72dcf2c2814b3., usertable,user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1.. Split took 8sec&lt;/p&gt;

&lt;p&gt;Master gets split:&lt;br/&gt;
2010-11-16 02:28:11,450 INFO org.apache.hadoop.hbase.master.ServerManager: Received REGION_SPLIT: usertable,user1057689679,1289901563182.24d8aec47045a86b97b3508ed16ced29.: Daughters; usertable,user1057689679,1289903283192.b313a3864e1eb1aaf2a72dcf2c2814b3., usertable,user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1. from haus01.sf.cloudera.com,60020,1289890926766&lt;/p&gt;

&lt;p&gt;.. then plenty of successful flushes/compactions on haus01, no mention on any other region server. The benchmark finished around 3:20am, and no mention of this region in any logs from that point until I disabled the table this evening:&lt;/p&gt;

&lt;p&gt;Master says:&lt;br/&gt;
2010-11-16 18:16:17,223 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Starting unassignment of region usertable,user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1. (offlining)&lt;/p&gt;

&lt;p&gt;Region server &lt;b&gt;haus02&lt;/b&gt; (NOTE: this is the wrong regionserver!!) says:&lt;br/&gt;
2010-11-16 18:16:17,238 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Received close region: usertable,user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1.&lt;br/&gt;
2010-11-16 18:16:17,239 WARN org.apache.hadoop.hbase.regionserver.HRegionServer: Received close for region we are not serving; 8a2c525797cad9fd9882cc6304362bd1&lt;/p&gt;

&lt;p&gt;Master says:&lt;br/&gt;
2010-11-16 18:16:17,240 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Attempted to send CLOSE to serverName=haus02.sf.cloudera.com,60020,1289890927217, load=(requests=1029, regions=28, usedHeap=4772, maxHeap=8185) for region usertable,user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1. but failed, setting region as OFFLINE and reassigning&lt;br/&gt;
...&lt;br/&gt;
2010-11-16 18:16:17,248 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Forcing OFFLINE; was=usertable,user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1. state=PENDING_CLOSE, ts=1289960177227&lt;br/&gt;
2010-11-16 18:16:17,248 INFO org.apache.hadoop.hbase.master.AssignmentManager: Table usertable disabling; skipping assign of usertable,user1072135606,1289903283192.8a2c525797cad9fd9882cc6304362bd1.&lt;br/&gt;
2010-11-16 18:16:17,248 DEBUG org.apache.hadoop.hbase.zookeeper.ZKAssign: master:60000-0x12c537d84e10000 Deleting existing unassigned node for 8a2c525797cad9fd9882cc6304362bd1 that is in expected state RS_ZK_REGION_CLOSED&lt;br/&gt;
2010-11-16 18:16:17,248 DEBUG org.apache.hadoop.hbase.zookeeper.ZKUtil: master:60000-0x12c537d84e10000 Unable to get data of znode /hbase/unassigned/8a2c525797cad9fd9882cc6304362bd1 because node does not exist (not necessarily an error)&lt;/p&gt;


&lt;p&gt;So basically, the master randomly got the wrong regionserver for this region, and there&apos;s little indication why.&lt;/p&gt;</comment>
                            <comment id="12932818" author="tlipcon" created="Wed, 17 Nov 2010 05:15:59 +0000"  >&lt;p&gt;No idea if it&apos;s related but it seems like AssignmentManager&apos;s &lt;tt&gt;regions&lt;/tt&gt; member is accessed without synchronization sometimes... could end up getting some incorrect data due to this.&lt;/p&gt;</comment>
                            <comment id="12932825" author="tlipcon" created="Wed, 17 Nov 2010 05:48:07 +0000"  >&lt;p&gt;Just grasping at straws here... but another thought is this:&lt;br/&gt;
The keys of the &lt;tt&gt;regions&lt;/tt&gt; map are HRegionInfo, where compareTo() includes calling down to compareTo() on HTableDescriptor. HTableDescriptor&apos;s compareTo eventually delegates to hashcode on the &lt;tt&gt;values&lt;/tt&gt; instance... do we end up changing the &lt;tt&gt;values&lt;/tt&gt; instance when a table gets disabled? Perhaps this is then changing the sort order in the TreeMap and confusing things?&lt;/p&gt;</comment>
                            <comment id="12932894" author="streamy" created="Wed, 17 Nov 2010 10:52:11 +0000"  >&lt;p&gt;Dug into code around compareTo() and the values instance.  Pretty sure we are not touching that while a cluster is running, and definitely not during disabling.  We&apos;ve actually even taken the &apos;offline&apos; flag out of META as well, it&apos;s a node in ZK now that signals the state of a table (enabling/disabling/disabled).&lt;/p&gt;

&lt;p&gt;It is interesting that HRI comparator uses the full HTD comparator.  It should probably just use the tableName itself to compare though considering HTD is a member it might make sense in some circumstances to do the full HTD.compareTo()?&lt;/p&gt;

&lt;p&gt;Looking around the code, it does look like there are multiple places we&apos;re using regions w/o a lock in the disable table path.  Pretty sure this is the cause.  Patch soon.&lt;/p&gt;</comment>
                            <comment id="12932901" author="streamy" created="Wed, 17 Nov 2010 11:12:31 +0000"  >&lt;p&gt;Fixes to &lt;tt&gt;regions&lt;/tt&gt; synchronization including one misuse of &lt;tt&gt;servers&lt;/tt&gt; modification under it&apos;s own lock rather than the &lt;tt&gt;regions&lt;/tt&gt; lock.&lt;/p&gt;

&lt;p&gt;Looking at this more, I&apos;m not sure synchronization is the issue here because TreeMap appears to only be not thread-safe when there are mutations.  The two critical pieces of code where a conflict could happen are where we read the server a region is assigned to, and where we set the server a region is assigned to.&lt;/p&gt;

&lt;p&gt;AssignmentManager:525 in &lt;tt&gt;regionOnline()&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    synchronized (this.regions) {
      // Add check
      HServerInfo hsi = this.regions.get(regionInfo);
      if (hsi != null) LOG.warn(&quot;Overwriting &quot; + regionInfo.getEncodedName() +
        &quot; on &quot; + hsi);
      this.regions.put(regionInfo, serverInfo);
      addToServers(serverInfo, regionInfo);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;AssignmentManager:1008 in &lt;tt&gt;unassign()&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    synchronized (this.regions) {
      server = regions.get(region);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Seems like this is okay as-is.  We should definitely still apply this patch to fix the synchronization issues but I&apos;m not sure it is the cause.&lt;/p&gt;

&lt;p&gt;Digging more.&lt;/p&gt;</comment>
                            <comment id="12932947" author="streamy" created="Wed, 17 Nov 2010 13:36:47 +0000"  >&lt;p&gt;This is very weird.  Can you put up the full logs somewhere?&lt;/p&gt;</comment>
                            <comment id="12933094" author="tlipcon" created="Wed, 17 Nov 2010 19:29:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking at this more, I&apos;m not sure synchronization is the issue here because TreeMap appears to only be not thread-safe when there are mutations. The two critical pieces of code where a conflict could happen are where we read the server a region is assigned to, and where we set the server a region is assigned to&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What about removals? I thought I saw a couple places with remove() that were unsynchronized. Will take a look at your patch momentarily.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This is very weird. Can you put up the full logs somewhere&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep, will upload them here, it&apos;s just fake data, nothing secret.&lt;/p&gt;</comment>
                            <comment id="12933103" author="tlipcon" created="Wed, 17 Nov 2010 19:40:24 +0000"  >&lt;p&gt;Here are all the logs that contain that region ID.&lt;/p&gt;</comment>
                            <comment id="12933628" author="stack" created="Fri, 19 Nov 2010 00:36:26 +0000"  >&lt;p&gt;This is an odd one.  I don&apos;t see anything jumping out at me.  Need to dig more.&lt;/p&gt;</comment>
                            <comment id="12934530" author="streamy" created="Mon, 22 Nov 2010 17:48:31 +0000"  >&lt;p&gt;Been through this several times on the code paths and have found nothing other than what is in my patch.&lt;/p&gt;

&lt;p&gt;There is a weird potential race condition around the master handling of a split (we offline parent and online regions one after the other w/ no locking between operations).  But that does not appear to be the issue here.&lt;/p&gt;

&lt;p&gt;I&apos;m yet to really dig through logs though and will do that next.&lt;/p&gt;</comment>
                            <comment id="12934531" author="tlipcon" created="Mon, 22 Nov 2010 17:53:05 +0000"  >&lt;p&gt;Thanks for looking at this, Jon. I can run some tests with my &quot;crazy config&quot; which generates lots and lots of regions, and see if it happens again. Any good log messages you can suggest adding for this test?&lt;/p&gt;</comment>
                            <comment id="12934535" author="streamy" created="Mon, 22 Nov 2010 18:08:09 +0000"  >&lt;p&gt;Well try running again with my patch.  Or you could even run it again without to see if it happens again and we could get another set of logs.  I guess run it with the patch and then if it doesn&apos;t ever happen again we can punt the issue or resolve it until we see it again.&lt;/p&gt;</comment>
                            <comment id="12964917" author="stack" created="Mon, 29 Nov 2010 20:17:54 +0000"  >&lt;p&gt;This little patch makes HRI compare use tablename only rather than full compareTo.  Full compareTo is OTT and looks error-prone.&lt;/p&gt;

&lt;p&gt;I&apos;ve spent some time looking at this issue and I can&apos;t figure how it came about.  I think we should apply the two patches that are in this issue, down the issues priority, and then cut a new RC.  We then test the new RC and see if we can reproduce.  If we do, recast this issue as a blocker.  Hows that sound?&lt;/p&gt;</comment>
                            <comment id="12964918" author="streamy" created="Mon, 29 Nov 2010 20:20:48 +0000"  >&lt;p&gt;+1 to your proposal stack&lt;/p&gt;

&lt;p&gt;I&apos;ve also gone through this several times and have not been able to come up with anything besides what is contained in these patches.&lt;/p&gt;

&lt;p&gt;Todd, do your best to break the new RC &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12964924" author="stack" created="Mon, 29 Nov 2010 20:27:08 +0000"  >&lt;p&gt;Did you intend to do this in your patch Jon?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@@ -1359,11 +1361,6 @@
     }
     &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions) {
       &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions.remove(hri);
-    }
-    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionPlans) {
-      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionPlans.remove(hri.getEncodedName());
-    }
-    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.servers) {
       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (List&amp;lt;HRegionInfo&amp;gt; regions : &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.servers.values()) {
         &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i&amp;lt;regions.size();i++) {
           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (regions.get(i).equals(hri)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12964926" author="streamy" created="Mon, 29 Nov 2010 20:28:40 +0000"  >&lt;p&gt;Yes.  That was wrong, we never use this.servers as a lock, we always manipulate this.regions and this.servers under the this.regions lock.&lt;/p&gt;

&lt;p&gt;The removal from regionPlans was just moved underneath it, I didn&apos;t take that part out.  It&apos;s in the next chunk of the diff.&lt;/p&gt;</comment>
                            <comment id="12964943" author="stack" created="Mon, 29 Nov 2010 21:07:56 +0000"  >&lt;p&gt;Here&apos;s what I applied.&lt;/p&gt;</comment>
                            <comment id="12964944" author="stack" created="Mon, 29 Nov 2010 21:08:31 +0000"  >&lt;p&gt;Moving out of 0.90... to 0.90.1 and made it major for now until we see it again.&lt;/p&gt;</comment>
                            <comment id="12965020" author="tlipcon" created="Tue, 30 Nov 2010 00:12:15 +0000"  >&lt;p&gt;Sounds good to me.&lt;/p&gt;</comment>
                            <comment id="13047550" author="stack" created="Fri, 10 Jun 2011 22:45:47 +0000"  >&lt;p&gt;Moving out of 0.92.0. Pull it back in if you think different.&lt;/p&gt;</comment>
                            <comment id="14274513" author="clehene" created="Tue, 13 Jan 2015 00:47:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tlipcon&quot; class=&quot;user-hover&quot; rel=&quot;tlipcon&quot;&gt;Todd Lipcon&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=streamy&quot; class=&quot;user-hover&quot; rel=&quot;streamy&quot;&gt;Jonathan Gray&lt;/a&gt; this is old. Closing as probably everything changed in the meantime and not an issue anymore.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12464901" name="3243-v2.patch" size="2927" author="stack" created="Mon, 29 Nov 2010 21:07:56 +0000"/>
                            <attachment id="12459789" name="HBASE-3243-v1.patch" size="2500" author="streamy" created="Wed, 17 Nov 2010 11:12:31 +0000"/>
                            <attachment id="12459819" name="hbase-3243-logs.tar.bz2" size="490065" author="tlipcon" created="Wed, 17 Nov 2010 19:40:24 +0000"/>
                            <attachment id="12464896" name="hri.diff" size="540" author="stack" created="Mon, 29 Nov 2010 20:17:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 17 Nov 2010 10:52:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26735</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02bzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11543</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>