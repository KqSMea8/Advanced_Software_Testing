<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:11:24 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3583/HBASE-3583.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3583] Coprocessors: RegionObserver: ScannerNext and ScannerClose hooks are called when get() is invoked</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3583</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;RegionObserver upcalls are expected to be triggered by corresponding client calls. &lt;/p&gt;

&lt;p&gt;I found that if a HTable.get() is issued, ScannerNext, and ScannerClose hooks are also invoked. &lt;/p&gt;

&lt;p&gt;Here is the reason: HRegion.get() is implemented with an internal scanner:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    InternalScanner scanner = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      scanner = getScanner(scan);
      scanner.next(results);
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (scanner != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        scanner.close();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where scanner.next, and scanner.close() are implemented with RegionObserver hooks. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12499994">HBASE-3583</key>
            <summary>Coprocessors: RegionObserver: ScannerNext and ScannerClose hooks are called when get() is invoked</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mingjielai">Mingjie Lai</assignee>
                                    <reporter username="mingjielai">Mingjie Lai</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Feb 2011 23:25:10 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:24 +0000</updated>
                            <resolved>Thu, 24 Mar 2011 06:29:38 +0000</resolved>
                                    <version>0.92.0</version>
                                    <fixVersion>0.92.0</fixVersion>
                                    <component>Coprocessors</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13001096" author="apurtell" created="Tue, 1 Mar 2011 20:25:50 +0000"  >&lt;p&gt;We discussed this internally. Reasonable options are:&lt;/p&gt;

&lt;p&gt;1) Rework the Coprocessor RegionObserver API so &quot;everything is a scan&quot;&lt;/p&gt;

&lt;p&gt;2) Pass booleans to internal functions to distinguish between the code paths&lt;/p&gt;

&lt;p&gt;We are opting for #2. A feature of the RegionObserver API is it mirrors HRegionInterface so the user/implementor has precise options for overriding or augmenting client actions. &lt;/p&gt;</comment>
                            <comment id="13001722" author="mingjielai" created="Wed, 2 Mar 2011 22:24:51 +0000"  >&lt;p&gt;After reviewed the current implementation, I think it makes more sense to pull the scannerNext and scannerClose hooks from HRegion to HRegionServer, instead of using a flag to indicate whether to invoke coprocessor hooks or not. Reason 1) the internalScanner are called at several different places, there are potential misfires as this case; 2) it would be ugly to pass a boolean flag to the internalscanner(it&apos;s an interface). &lt;/p&gt;

&lt;p&gt;Patch posted here and reviewboard. &lt;br/&gt;
&lt;a href=&quot;https://review.cloudera.org/r/1617/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://review.cloudera.org/r/1617/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13001723" author="mingjielai" created="Wed, 2 Mar 2011 22:26:07 +0000"  >&lt;p&gt;Patch.&lt;/p&gt;</comment>
                            <comment id="13002481" author="stack" created="Fri, 4 Mar 2011 07:02:23 +0000"  >&lt;p&gt;I added a few comments over on rb Mingjie.  Good stuff.&lt;/p&gt;</comment>
                            <comment id="13007744" author="mingjielai" created="Wed, 16 Mar 2011 23:42:46 +0000"  >&lt;p&gt;Stack. Need your feedback for your first comments: &lt;br/&gt;
&lt;a href=&quot;https://review.cloudera.org/r/1617/diff/1/?file=26436#file26436line1812&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://review.cloudera.org/r/1617/diff/1/?file=26436#file26436line1812&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;My original purpose of this addition map is to have a way to obtain region name from scanner id, then get region instance, in order to call corresponding region coprocessors: &lt;/p&gt;

&lt;p&gt;Result[] next(final long scannerId, int nbRows) &lt;/p&gt;
{
  // need to get to region to access coprocessors
  ... 
}

&lt;p&gt;There are several options can do it:&lt;/p&gt;

&lt;p&gt;1) add a map along with original scanners map (as the 1st patch)&lt;br/&gt;
2) as you suggested, to change the meaning/data type of scanner id, but it will impact other components, ie. client lib, etc. &lt;br/&gt;
3) instead of Map&amp;lt;InternalScanner&amp;gt;, just use Map&amp;lt;HRegion.RegionScanner&amp;gt; as scanners. There are a lot of ugly thing like: &lt;/p&gt;

&lt;p&gt;if (scanner instanceof HRegion.RegionScanner) &lt;/p&gt;
{
  ...
}

&lt;p&gt;so why not just using HRegion.RegionScanner directly. &lt;/p&gt;

&lt;p&gt;4) ugly way: don&apos;t add anything, just use existing suff &lt;/p&gt;

&lt;p&gt;if (scanner instanceof HRegion.RegionScanner)&lt;/p&gt;
{ 
  ... 
  HRegionInfo regionName = rs.getRegionName(); ... 
}
&lt;p&gt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&lt;/p&gt;

&lt;p&gt;What do you think? &lt;/p&gt;</comment>
                            <comment id="13007753" author="mingjielai" created="Thu, 17 Mar 2011 00:15:00 +0000"  >&lt;p&gt;For option 2, the impact would be wide, since client also uses the same scanner id. &lt;/p&gt;

&lt;p&gt;Option 3 is not feasible since changing the Map type would require changing the return type for HRegion.getScanner(). Sorry about it.  &lt;/p&gt;</comment>
                            <comment id="13008029" author="yuzhihong@gmail.com" created="Thu, 17 Mar 2011 17:45:53 +0000"  >&lt;p&gt;In HRegion, I didn&apos;t find caller of the following method which passes non-null additionalScanners:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; InternalScanner getScanner(Scan scan, List&amp;lt;KeyValueScanner&amp;gt; additionalScanners) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13008032" author="yuzhihong@gmail.com" created="Thu, 17 Mar 2011 17:51:01 +0000"  >&lt;p&gt;Can we consider a simpler change - directly cast scanner to HRegion.RegionScanner ?&lt;br/&gt;
In the future, if the dependency is broken (unlikely), we can change the cast to &apos;instanceof&apos; check.&lt;/p&gt;</comment>
                            <comment id="13008305" author="stack" created="Fri, 18 Mar 2011 03:20:44 +0000"  >&lt;p&gt;Mingie: I commented over on rb.  I&apos;m w/ Gary thinking #3 could work.  Just keep it as InternalScanner everywhere, in particular as return out of getScanner but then internally doc. why its so ugly.  Do the instanceof test and if not as expected, throw ugly exception.  I think this least intrusive route and you CYA with comments on why it is the way it is and that should be changed when we have some elbow room for API changing (though, thinking on it, we have elbow room?  This comes out in 0.92 &amp;#8211; don&apos;t we break interfaces in 0.92?  I haven&apos;t checked)&lt;/p&gt;</comment>
                            <comment id="13010517" author="mingjielai" created="Wed, 23 Mar 2011 23:28:31 +0000"  >&lt;p&gt;The 3rd patch to rb. Also cc here. &lt;/p&gt;</comment>
                            <comment id="13010574" author="apurtell" created="Thu, 24 Mar 2011 06:29:38 +0000"  >&lt;p&gt;Committed to trunk. &lt;/p&gt;</comment>
                            <comment id="13010629" author="hudson" created="Thu, 24 Mar 2011 10:59:37 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1807 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/HBase-TRUNK/1807/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/HBase-TRUNK/1807/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3583&quot; title=&quot;Coprocessors: RegionObserver: ScannerNext and ScannerClose hooks are called when get() is invoked&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3583&quot;&gt;&lt;del&gt;HBASE-3583&lt;/del&gt;&lt;/a&gt;  Coprocessors: scannerNext and scannerClose hooks are called when HRegionInterface#get is invoked&lt;/p&gt;</comment>
                            <comment id="15017242" author="lars_francke" created="Fri, 20 Nov 2015 12:42:24 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12474452" name="HBase3583-3.patch" size="26577" author="mingjielai" created="Wed, 23 Mar 2011 23:28:31 +0000"/>
                            <attachment id="12472479" name="HBase3583.patch" size="25246" author="mingjielai" created="Wed, 2 Mar 2011 22:26:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 1 Mar 2011 20:25:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26925</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hmvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100969</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>