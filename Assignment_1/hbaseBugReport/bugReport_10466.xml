<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:14:03 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-10466/HBASE-10466.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-10466] Bugs that make flushes skipped during HRegion close could cause data loss</title>
                <link>https://issues.apache.org/jira/browse/HBASE-10466</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;During region close, there are two flushes to ensure nothing is persisted in memory. When there is data in current memstore only, 1 flush is required. When there is data also in memstore&apos;s snapshot, 2 flushes are essential otherwise we have data loss. However, recently we found two bugs that lead to at least 1 flush skipped and caused data loss.&lt;/p&gt;

&lt;p&gt;Bug 1: Wrong calculation of HRegion.memstoreSize&lt;br/&gt;
When a flush fails, data to be flushed is kept in each MemStore&apos;s snapshot and wait for next flush attempt to continue on it. But when the next flush succeeds, the counter of total memstore size in HRegion is always deduced by the sum of current memstore sizes instead of snapshots left from previous failed flush. This calculation is problematic that almost every time there is failed flush, HRegion.memstoreSize gets reduced by a wrong value. If region flush could not proceed for a couple cycles, the size in current memstore could be much larger than the snapshot. It&apos;s likely to drift memstoreSize much smaller than expected. In extreme case, if the error accumulates to even bigger than HRegion&apos;s memstore size limit, any further flush is skipped because flush does not do anything if memstoreSize is not larger than 0.&lt;br/&gt;
When the region is closing, if the two flushes get skipped and leave data in current memstore and/or snapshot, we could lose data up to the memstore size limit of the region.&lt;br/&gt;
The fix is deducing correct size of data that is going to be flushed from memstoreSize.&lt;/p&gt;

&lt;p&gt;Bug 2: Conditions for the first flush of region close (so-called pre-flush)&lt;br/&gt;
If memstoreSize is smaller than a certain value, or when region close starts a flush is ongoing, the first flush is skipped and only the second flush takes place. However, two flushes are required in case previous flush fails and leaves some data in snapshot. The bug could cause loss of data in current memstore.&lt;br/&gt;
The fix is removing all conditions except abort check so we ensure 2 flushes for region close.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12693241">HBASE-10466</key>
            <summary>Bugs that make flushes skipped during HRegion close could cause data loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="fantasist">Yunfan Zhong</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Feb 2014 22:04:05 +0000</created>
                <updated>Fri, 14 Mar 2014 08:20:42 +0000</updated>
                            <resolved>Fri, 14 Feb 2014 01:17:16 +0000</resolved>
                                    <version>0.89-fb</version>
                                    <fixVersion>0.89-fb</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13900986" author="fantasist" created="Fri, 14 Feb 2014 01:22:05 +0000"  >&lt;p&gt;I rewrote the jira to reflect latest discoveries and fix.&lt;/p&gt;</comment>
                            <comment id="13924132" author="stack" created="Fri, 7 Mar 2014 18:10:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fantasist&quot; class=&quot;user-hover&quot; rel=&quot;fantasist&quot;&gt;Yunfan Zhong&lt;/a&gt; Nice work.  Thanks.&lt;/p&gt;</comment>
                            <comment id="13934424" author="hudson" created="Fri, 14 Mar 2014 01:25:20 +0000"  >&lt;p&gt;FAILURE: Integrated in hbase-0.96-hadoop2 #237 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96-hadoop2/237/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96-hadoop2/237/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10514&quot; title=&quot;Forward port HBASE-10466, possible data loss when failed flushes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10514&quot;&gt;&lt;del&gt;HBASE-10514&lt;/del&gt;&lt;/a&gt; Forward port &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10466&quot; title=&quot;Bugs that make flushes skipped during HRegion close could cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10466&quot;&gt;&lt;del&gt;HBASE-10466&lt;/del&gt;&lt;/a&gt;, possible data loss when failed flushes (stack: rev 1577386)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreConfigInformation.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionBusyWait.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13934460" author="hudson" created="Fri, 14 Mar 2014 02:04:32 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK #5007 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/5007/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/5007/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10514&quot; title=&quot;Forward port HBASE-10466, possible data loss when failed flushes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10514&quot;&gt;&lt;del&gt;HBASE-10514&lt;/del&gt;&lt;/a&gt; Forward port &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10466&quot; title=&quot;Bugs that make flushes skipped during HRegion close could cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10466&quot;&gt;&lt;del&gt;HBASE-10466&lt;/del&gt;&lt;/a&gt;, possible data loss when failed flushes (stack: rev 1577353)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreConfigInformation.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionBusyWait.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13934477" author="hudson" created="Fri, 14 Mar 2014 02:28:03 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98 #227 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/227/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/227/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10514&quot; title=&quot;Forward port HBASE-10466, possible data loss when failed flushes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10514&quot;&gt;&lt;del&gt;HBASE-10514&lt;/del&gt;&lt;/a&gt; Forward port &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10466&quot; title=&quot;Bugs that make flushes skipped during HRegion close could cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10466&quot;&gt;&lt;del&gt;HBASE-10466&lt;/del&gt;&lt;/a&gt;, possible data loss when failed flushes (stack: rev 1577371)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreConfigInformation.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionBusyWait.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13934581" author="hudson" created="Fri, 14 Mar 2014 04:34:33 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98-on-Hadoop-1.1 #213 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/213/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/213/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10514&quot; title=&quot;Forward port HBASE-10466, possible data loss when failed flushes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10514&quot;&gt;&lt;del&gt;HBASE-10514&lt;/del&gt;&lt;/a&gt; Forward port &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10466&quot; title=&quot;Bugs that make flushes skipped during HRegion close could cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10466&quot;&gt;&lt;del&gt;HBASE-10466&lt;/del&gt;&lt;/a&gt;, possible data loss when failed flushes (stack: rev 1577371)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreConfigInformation.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionBusyWait.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13934662" author="hudson" created="Fri, 14 Mar 2014 06:04:57 +0000"  >&lt;p&gt;SUCCESS: Integrated in hbase-0.96 #346 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96/346/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96/346/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10514&quot; title=&quot;Forward port HBASE-10466, possible data loss when failed flushes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10514&quot;&gt;&lt;del&gt;HBASE-10514&lt;/del&gt;&lt;/a&gt; Forward port &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10466&quot; title=&quot;Bugs that make flushes skipped during HRegion close could cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10466&quot;&gt;&lt;del&gt;HBASE-10466&lt;/del&gt;&lt;/a&gt;, possible data loss when failed flushes (stack: rev 1577386)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreConfigInformation.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionBusyWait.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13934765" author="hudson" created="Fri, 14 Mar 2014 08:20:42 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK-on-Hadoop-1.1 #117 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-1.1/117/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-1.1/117/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10514&quot; title=&quot;Forward port HBASE-10466, possible data loss when failed flushes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10514&quot;&gt;&lt;del&gt;HBASE-10514&lt;/del&gt;&lt;/a&gt; Forward port &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10466&quot; title=&quot;Bugs that make flushes skipped during HRegion close could cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10466&quot;&gt;&lt;del&gt;HBASE-10466&lt;/del&gt;&lt;/a&gt;, possible data loss when failed flushes (stack: rev 1577353)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreConfigInformation.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionBusyWait.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12694852">HBASE-10514</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12628913" name="Fix-bugs-that-causes-flushes-being-skipped-during-re.patch" size="13256" author="fantasist" created="Fri, 14 Feb 2014 01:17:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 7 Mar 2014 18:10:02 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>371827</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1s2wv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372131</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>