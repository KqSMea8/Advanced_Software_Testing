<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:05:49 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2915/HBASE-2915.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2915] Deadlock between HRegion.ICV and HRegion.close</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2915</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;HRegion.ICV gets a row lock then gets a newScanner lock.&lt;/p&gt;

&lt;p&gt;HRegion.close gets a newScanner lock, slitCloseLock and finally waits for all row locks to finish.&lt;/p&gt;

&lt;p&gt;If the ICV got the row lock and then close got the newScannerLock, both end up waiting on the other. This was introduced when Get became a Scan.&lt;/p&gt;

&lt;p&gt;Stack thinks we can get rid of the newScannerLock in close since we setClosing to true.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12471578">HBASE-2915</key>
            <summary>Deadlock between HRegion.ICV and HRegion.close</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Aug 2010 19:20:04 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:34 +0000</updated>
                            <resolved>Mon, 23 Aug 2010 22:49:59 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12900367" author="jdcryans" created="Thu, 19 Aug 2010 17:21:19 +0000"  >&lt;p&gt;There is another deadlock that needs fixing in the scope of this jira. Since the split code was redone, there&apos;s a deadlock when SplitTransaction acquires the splitAndCloses writelock while a flush is running for it. It looks like:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
&quot;regionserver60021.compactor&quot; daemon prio=10 tid=0x00007fc31845b800 nid=0x5f62 in Object.wait() [0x00007fc31e9e7000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	at java.lang.Object.wait(Object.java:485)
	at org.apache.hadoop.hbase.regionserver.HRegion.close(HRegion.java:493)
	- locked &amp;lt;0x00007fc336877998&amp;gt; (a org.apache.hadoop.hbase.regionserver.HRegion$WriteState)
	at org.apache.hadoop.hbase.regionserver.SplitTransaction.execute(SplitTransaction.java:213)
	at org.apache.hadoop.hbase.regionserver.SplitTransaction.execute(SplitTransaction.java:186)
	at org.apache.hadoop.hbase.regionserver.CompactSplitThread.split(CompactSplitThread.java:157)
	at org.apache.hadoop.hbase.regionserver.CompactSplitThread.run(CompactSplitThread.java:87)

&quot;regionserver60021.cacheFlusher&quot; daemon prio=10 tid=0x00007fc31845a000 nid=0x5f61 waiting on condition [0x00007fc31eae8000]
   java.lang.Thread.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  &amp;lt;0x00007fc336561750&amp;gt; (a java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:747)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireShared(AbstractQueuedSynchronizer.java:877)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireShared(AbstractQueuedSynchronizer.java:1197)
	at java.util.concurrent.locks.ReentrantReadWriteLock$ReadLock.lock(ReentrantReadWriteLock.java:594)
	at org.apache.hadoop.hbase.regionserver.HRegion.flushcache(HRegion.java:793)
	at org.apache.hadoop.hbase.regionserver.MemStoreFlusher.flushRegion(MemStoreFlusher.java:249)
	at org.apache.hadoop.hbase.regionserver.MemStoreFlusher.flushRegion(MemStoreFlusher.java:223)
	at org.apache.hadoop.hbase.regionserver.MemStoreFlusher.run(MemStoreFlusher.java:146)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12900492" author="hbasereviewboard" created="Thu, 19 Aug 2010 22:13:58 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This patch removes newScannerLock and renames splitAndClose lock to just &quot;lock&quot;. Every operation is now required to obtain the read lock on &quot;lock&quot; before doing anything (including getting a row lock). This is done by calling openRegionTransaction inside a try statement and by calling closeRegionTransaction in finally.&lt;/p&gt;

&lt;p&gt;flushcache got refactored some more in order to do the locking in the proper order; first get the read lock, then do the writestate handling.&lt;/p&gt;

&lt;p&gt;Finally, it removes the need to have a writeLock when flushing when subclassers give atomic work do to via internalPreFlushcacheCommit. This means that this patch breaks external contribs. This is required to keep our whole locking mechanism simpler.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2915&quot; title=&quot;Deadlock between HRegion.ICV and HRegion.close&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2915&quot;&gt;&lt;del&gt;HBASE-2915&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-2915&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-2915&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 987300 &lt;br/&gt;
  /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java 987300 &lt;br/&gt;
  /trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransaction.java 987300 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/691/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;5 concurrent ICV threads + randomWrite 3 + scans on a single RS. I&apos;m also in the process of deploying it on a cluster.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jean-Daniel&lt;/p&gt;

</comment>
                            <comment id="12900510" author="hbasereviewboard" created="Thu, 19 Aug 2010 22:52:46 +0000"  >&lt;p&gt;Message from: &quot;Ryan Rawson&quot; &amp;lt;ryanobjc@gmail.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review966&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review966&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3144&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3144&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    oh wow i cant believe this was ever here&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3145&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3145&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    i thought we agreed that the closing flag had to be set BEFORE the write lock was acquired to prevent race conditions?&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3146&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3146&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    lets just excise this and break compile time compatibility.  Also remove internalPreFlushcacheCommit too&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3147&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3147&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    ditto remove this whole try/finally bit&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3148&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3148&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    maybe we shouldnt call this &apos;transaction&apos; might confuse people into thinking we support real transactions... not sure what to call it at this moment tho&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ryan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12900515" author="hbasereviewboard" created="Thu, 19 Aug 2010 22:59:36 +0000"  >&lt;p&gt;Message from: &quot;Ted Yu&quot; &amp;lt;ted_yu@yahoo.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review967&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review967&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3151&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3151&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    How about naming this method openRegionProlog ?&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3149&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3149&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Please add:&lt;br/&gt;
    It has to be called inside the corresponding finally block&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3150&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3150&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    How about naming this method closeRegionEpilog ?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12900527" author="hbasereviewboard" created="Thu, 19 Aug 2010 23:33:35 +0000"  >&lt;p&gt;Message from: &quot;Ted Yu&quot; &amp;lt;ted_yu@yahoo.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review969&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review969&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3155&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3155&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Or regionOperationProlog()&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3156&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3156&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    and regionOperationEpilog()&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12900893" author="hbasereviewboard" created="Fri, 20 Aug 2010 22:22:55 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review973&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review973&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Further testing shows that I completely forgot to properly lock incrementColumnValue, thus missing the point of the title of the jira :S Uploading a new patch soon that addresses that, along with comments from the reviews.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jean-Daniel&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12900912" author="hbasereviewboard" created="Fri, 20 Aug 2010 23:19:41 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review975&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review975&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;oh, one other thing, in discussions, we talked of no longer needing to wait on row locks to expire... I don&apos;t see this being excised from the close method.  Should that be in here?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12900914" author="hbasereviewboard" created="Fri, 20 Aug 2010 23:24:13 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review974&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;+1  Nice fix.  A few comments below.&lt;/p&gt;


&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3163&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I suppose this order is ok if the first thing we do on entrance to HRegion is get the read lock before check of closing.&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3164&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3164&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Seems like you could use your opentransaction/closetransaction methods here and in flush too to be consistent?&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3165&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3165&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Yeah, just remove.&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3166&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3166&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Aren&apos;t these lines unnecessary?  openRegionTransaction does it?&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3167&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3167&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    So, this javadoc is good but do you think we need some more doc?  Does there need to be more detail on new locking regime? Maybe there is no more to be said that what is here in this paragraph.  You&apos;ve done all the work unravelling our lock mess.  With time your nice unravelling will rot unless its clear what the pattern is.    I&apos;m just trying to think of ways of preventing that happening.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12900916" author="hbasereviewboard" created="Fri, 20 Aug 2010 23:32:56 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 507&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line507&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line507&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I suppose this order is ok if the first thing we do on entrance to HRegion is get the read lock before check of closing.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So I just redid that part. setClosing is first taken so that when the client threads arrive they can fast fail by looking at closing.get before trying to get the readLock.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 712&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Seems like you could use your opentransaction/closetransaction methods here and in flush too to be consistent?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah the issue with compact and flush is that the callers don&apos;t expect to see NSRE, the want null values.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 1115&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line1115&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line1115&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Aren&apos;t these lines unnecessary?  openRegionTransaction does it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good catch.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 3142&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line3142&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line3142&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     So, this javadoc is good but do you think we need some more doc?  Does there need to be more detail on new locking regime? Maybe there is no more to be said that what is here in this paragraph.  You&apos;ve done all the work unravelling our lock mess.  With time your nice unravelling will rot unless its clear what the pattern is.    I&apos;m just trying to think of ways of preventing that happening.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah I&apos;ll included some more javadoc, maybe with code examples?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jean-Daniel&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review974&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12900917" author="hbasereviewboard" created="Fri, 20 Aug 2010 23:35:36 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:58:23, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; oh, one other thing, in discussions, we talked of no longer needing to wait on row locks to expire... I don&apos;t see this being excised from the close method.  Should that be in here?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep, it needs to go.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jean-Daniel&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review975&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review975&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12900919" author="hbasereviewboard" created="Fri, 20 Aug 2010 23:40:58 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 507&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line507&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line507&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I suppose this order is ok if the first thing we do on entrance to HRegion is get the read lock before check of closing.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;So I just redid that part. setClosing is first taken so that when the client threads arrive they can fast fail by looking at closing.get before trying to get the readLock.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Don&apos;t you have to check again the setClosing after you get the read lock?&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 712&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Seems like you could use your opentransaction/closetransaction methods here and in flush too to be consistent?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Yeah the issue with compact and flush is that the callers don&apos;t expect to see NSRE, the want null values.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK. Not important. This is deep internal stuff or make a version that takes a flag on whether to throw exception (default throws exception .. might get messy though... not important).&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review974&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12900922" author="hbasereviewboard" created="Fri, 20 Aug 2010 23:44:42 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 507&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line507&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line507&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I suppose this order is ok if the first thing we do on entrance to HRegion is get the read lock before check of closing.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;So I just redid that part. setClosing is first taken so that when the client threads arrive they can fast fail by looking at closing.get before trying to get the readLock.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Don&apos;t you have to check again the setClosing after you get the read lock?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I&apos;m about to post a new patch, but it looks like this and it has to be called just before &quot;try&quot; instead of inside:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;if (this.closing.get()) {
bq.            throw new NotServingRegionException(regionInfo.getRegionNameAsString() +
bq.                &quot; is closing&quot;);
bq.          }&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;lock.readLock().lock();&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;if (this.closed.get()) {
bq.            throw new NotServingRegionException(regionInfo.getRegionNameAsString() +
bq.                &quot; is closed&quot;);
bq.          }&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That looks right.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 712&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Seems like you could use your opentransaction/closetransaction methods here and in flush too to be consistent?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Yeah the issue with compact and flush is that the callers don&apos;t expect to see NSRE, the want null values.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;OK. Not important. This is deep internal stuff or make a version that takes a flag on whether to throw exception (default throws exception .. might get messy though... not important).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I&apos;m afraid those little methods could be clogged fast.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah. Not important.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review974&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12900925" author="hbasereviewboard" created="Fri, 20 Aug 2010 23:50:28 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 507&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line507&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line507&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I suppose this order is ok if the first thing we do on entrance to HRegion is get the read lock before check of closing.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;So I just redid that part. setClosing is first taken so that when the client threads arrive they can fast fail by looking at closing.get before trying to get the readLock.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Don&apos;t you have to check again the setClosing after you get the read lock?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m about to post a new patch, but it looks like this and it has to be called just before &quot;try&quot; instead of inside:&lt;br/&gt;
     if (this.closing.get()) &lt;/p&gt;
{
      throw new NotServingRegionException(regionInfo.getRegionNameAsString() +
          &quot; is closing&quot;);
    }
&lt;p&gt;    lock.readLock().lock();&lt;br/&gt;
    if (this.closed.get()) &lt;/p&gt;
{
      throw new NotServingRegionException(regionInfo.getRegionNameAsString() +
          &quot; is closed&quot;);
    }


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 712&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Seems like you could use your opentransaction/closetransaction methods here and in flush too to be consistent?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Yeah the issue with compact and flush is that the callers don&apos;t expect to see NSRE, the want null values.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;OK. Not important. This is deep internal stuff or make a version that takes a flag on whether to throw exception (default throws exception .. might get messy though... not important).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m afraid those little methods could be clogged fast.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jean-Daniel&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review974&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12900928" author="hbasereviewboard" created="Fri, 20 Aug 2010 23:53:42 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 15:57:34, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 712&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/1/?file=7612#file7612line712&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Seems like you could use your opentransaction/closetransaction methods here and in flush too to be consistent?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Yeah the issue with compact and flush is that the callers don&apos;t expect to see NSRE, the want null values.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;OK. Not important. This is deep internal stuff or make a version that takes a flag on whether to throw exception (default throws exception .. might get messy though... not important).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I&apos;m afraid those little methods could be clogged fast.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Yeah. Not important.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Moreover, and this should be added to the documentation, none of the user-facing methods now directly use the lock, it has to go through those new methods. Means that flush, compact, split and close are the only ones with direct access.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jean-Daniel&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review974&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12900951" author="hbasereviewboard" created="Sat, 21 Aug 2010 00:59:56 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-08-20 17:43:52.668799)&lt;/p&gt;


&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Updated patch with &quot;closing&quot; handling and ICV locking, still needs more javadoc.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This patch removes newScannerLock and renames splitAndClose lock to just &quot;lock&quot;. Every operation is now required to obtain the read lock on &quot;lock&quot; before doing anything (including getting a row lock). This is done by calling openRegionTransaction inside a try statement and by calling closeRegionTransaction in finally.&lt;/p&gt;

&lt;p&gt;flushcache got refactored some more in order to do the locking in the proper order; first get the read lock, then do the writestate handling.&lt;/p&gt;

&lt;p&gt;Finally, it removes the need to have a writeLock when flushing when subclassers give atomic work do to via internalPreFlushcacheCommit. This means that this patch breaks external contribs. This is required to keep our whole locking mechanism simpler.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2915&quot; title=&quot;Deadlock between HRegion.ICV and HRegion.close&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2915&quot;&gt;&lt;del&gt;HBASE-2915&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-2915&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-2915&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 987355 &lt;br/&gt;
  /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java 987355 &lt;br/&gt;
  /trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransaction.java 987355 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/691/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;5 concurrent ICV threads + randomWrite 3 + scans on a single RS. I&apos;m also in the process of deploying it on a cluster.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jean-Daniel&lt;/p&gt;

</comment>
                            <comment id="12900971" author="hbasereviewboard" created="Sat, 21 Aug 2010 04:10:36 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review988&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review988&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;if below are issues address on commit.&lt;/p&gt;


&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3194&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3194&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Any reason this does not follow the pattern used elsewhere?  You are not testing closing before getting the read lock?&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3195&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3195&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    ditto&lt;/p&gt;



&lt;p&gt;/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/#comment3196&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#comment3196&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Is this supposed to be inside the try?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12901482" author="hbasereviewboard" created="Mon, 23 Aug 2010 17:00:25 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 20:49:15, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 716&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/2/?file=7680#file7680line716&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/2/?file=7680#file7680line716&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Any reason this does not follow the pattern used elsewhere?  You are not testing closing before getting the read lock?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;mmm didn&apos;t want to copy the same chunk of code over there, but yeah it will also give us a fail-fast behavior which will speed up flushing.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 20:49:15, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 785&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/2/?file=7680#file7680line785&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/2/?file=7680#file7680line785&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     ditto&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ditto&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-08-20 20:49:15, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 2960&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/691/diff/2/?file=7680#file7680line2960&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/diff/2/?file=7680#file7680line2960&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Is this supposed to be inside the try?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Per that method&apos;s javadoc, no. The reason is that if it&apos;s all in a try block, and that closing is true, then you won&apos;t hold a readLock and you can&apos;t do a isHeldByCurrent thread on that lock. So I thought we could catch IllegalStateException in closeRegionOperation, but that would be really ugly. This leaves us to the current situation where if an exception is thrown when we are on this line:&lt;br/&gt;
     if (this.closed.get()) {&lt;br/&gt;
that it would leave the readLock locked by the thread, although in this case the region is closing so we&apos;re getting rid of it anyways. Although, thinking about it, I should probably do this instead:&lt;/p&gt;

&lt;p&gt;    if (this.closed.get()) &lt;/p&gt;
{
      lock.readLock().unlock();
      throw new NotServingRegionException(regionInfo.getRegionNameAsString() +
          &quot; is closed&quot;);
    }


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jean-Daniel&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/691/#review988&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/691/#review988&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12901640" author="jdcryans" created="Mon, 23 Aug 2010 22:43:26 +0000"  >&lt;p&gt;This patch is the same as the last one I posted on rb, with the addition of the unlocking in case the region is closed but the thread was able to get a readLock. I tested it on a 13 nodes cluster with 200 YCSB threads hitting it in different ways, didn&apos;t see any deadlock. Going to commit.&lt;/p&gt;</comment>
                            <comment id="12901644" author="jdcryans" created="Mon, 23 Aug 2010 22:49:59 +0000"  >&lt;p&gt;Committed to trunk, thanks for the review Stack!&lt;/p&gt;</comment>
                            <comment id="15016745" author="lars_francke" created="Fri, 20 Nov 2015 12:40:34 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12452874" name="HBASE-2915-v4.patch" size="24134" author="jdcryans" created="Mon, 23 Aug 2010 22:43:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 19 Aug 2010 22:13:58 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26534</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hjt3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100471</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>