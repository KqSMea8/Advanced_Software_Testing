<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:13:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3872/HBASE-3872.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3872] Hole in split transaction rollback; edits to .META. need to be rolled back even if it seems like they didn&apos;t make it</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3872</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Saw this interesting one on a cluster of ours.  The cluster was configured with too few handlers so lots of the phenomeneon where actions were queued but then by the time they got into the server and tried respond to the client, the client had disconnected because of the timeout of 60 seconds.  Well, the meta edits for a split were queued at the regionserver carrying .META. and by the time it went to write back, the client had gone (the first insert of parent offline with daughter regions added as info:splitA and info:splitB).  The client presumed the edits failed and &apos;successfully&apos; rolled back the transaction (failing to undo .META. edits thinking they didn&apos;t go through).&lt;/p&gt;

&lt;p&gt;A few minutes later the .META. scanner on master runs.  It sees &apos;no references&apos; in daughters &amp;#8211; the daughters had been cleaned up as part of the split transaction rollback &amp;#8211; so it thinks its safe to delete the parent.&lt;/p&gt;

&lt;p&gt;Two things:&lt;/p&gt;

&lt;p&gt;+ Tighten up check in master... need to check daughter region at least exists and possibly the daughter region has an entry in .META.&lt;br/&gt;
+ Dependent on the edit that fails, schedule rollback edits though it will seem like they didn&apos;t go through.&lt;/p&gt;

&lt;p&gt;This is pretty critical one.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12506681">HBASE-3872</key>
            <summary>Hole in split transaction rollback; edits to .META. need to be rolled back even if it seems like they didn&apos;t make it</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 May 2011 05:12:44 +0000</created>
                <updated>Fri, 20 Nov 2015 12:44:02 +0000</updated>
                            <resolved>Fri, 22 Jul 2011 22:22:25 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.90.4</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13031025" author="stack" created="Tue, 10 May 2011 05:27:45 +0000"  >&lt;p&gt;Look at OFFLINED_PARENT state in split transaction too.  It looks like we do not record it in journal as we run execution.&lt;/p&gt;</comment>
                            <comment id="13031028" author="stack" created="Tue, 10 May 2011 05:42:33 +0000"  >&lt;p&gt;This bug caused hbase to delete a whole region.  Critical.&lt;/p&gt;</comment>
                            <comment id="13031032" author="stack" created="Tue, 10 May 2011 05:51:27 +0000"  >&lt;p&gt;offlineParentInMeta doesn&apos;t have an entry in the journal (OFFLINED_PARENT is something else) but I think that is ok&lt;/p&gt;</comment>
                            <comment id="13038736" author="stack" created="Tue, 24 May 2011 19:17:09 +0000"  >&lt;p&gt;Not finished but I think best tactic is moving meta edit beyond point-of-no-return splitting; if it fails at all, crash out the regionserver and let servershutdownhandler do the fixup.  Fixup will now have this second case to deal with.  Do the fixup in one place only.  Need to also amend CatalogJanitor so it does not mistakenly cleanup the parent region.&lt;/p&gt;</comment>
                            <comment id="13053654" author="kimballa" created="Thu, 23 Jun 2011 04:55:06 +0000"  >&lt;p&gt;We were bit by a bug that I believe is the same as this one. A regionserver started performing a split, but got a SocketTimeoutException connecting to the regionserver with .META. on it, triggering a rollback; the rollback was reported as successful, but the region has now gone completely missing from the table.&lt;/p&gt;

&lt;p&gt;Would definitely like to see this get in. Would also like to know if there&apos;s a way to retrieve the pre-split storefile and get that region back online? &lt;/p&gt;</comment>
                            <comment id="13053655" author="kimballa" created="Thu, 23 Jun 2011 04:55:53 +0000"  >&lt;p&gt;(This was on HBase 0.90.1-cdh3u0)&lt;/p&gt;</comment>
                            <comment id="13053658" author="stack" created="Thu, 23 Jun 2011 05:13:40 +0000"  >&lt;p&gt;@Aaron If same issue as I saw, the split parent was deleted.  The region is gone.&lt;/p&gt;</comment>
                            <comment id="13053659" author="kimballa" created="Thu, 23 Jun 2011 05:16:07 +0000"  >&lt;p&gt;A further observation: this seems to have occurred when splitting multiple regions within the same table (during a day of large bulk loads). The logs show the parent region being offlined, then both daughter regions being instantiated. The following sequence of log messages appeared both times:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-06-21 21:51:17,594 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Instantiated (redacted-a-daughter).
2011-06-21 21:51:17,630 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Instantiated (redacted-b-daughter).
2011-06-21 21:52:05,412 DEBUG org.apache.hadoop.hbase.regionserver.LogRoller: Hlog roll period 3600000ms elapsed
2011-06-21 21:52:17,666 INFO org.apache.hadoop.hbase.regionserver.CompactSplitThread: Running rollback of failed split of (redacted-parent-region); Call to (redacted-server-address):60020 failed on socket timeout exception: java.net.SocketTimeoutException: 60000 millis timeout &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; channel to be ready &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; read. ch : java.nio.channels.SocketChannel[connected local=(redacted-server-ip):54054 remote=(redacted-server-address):60020]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I find it noteworthy that the &quot;Hlog roll period elapsed&quot; message occurred between the &quot;B&quot; daughter instantiation and the socket timeout in both cases of missing regions I am aware of in my table.&lt;/p&gt;</comment>
                            <comment id="13053660" author="stack" created="Thu, 23 Jun 2011 05:28:08 +0000"  >&lt;p&gt;@Aaron That might be different to what I saw at head of this issue.  Is the parent still in .META.?&lt;/p&gt;</comment>
                            <comment id="13053661" author="stack" created="Thu, 23 Jun 2011 05:28:35 +0000"  >&lt;p&gt;Stick in more log from around the fail&lt;/p&gt;</comment>
                            <comment id="13053667" author="kimballa" created="Thu, 23 Jun 2011 05:59:18 +0000"  >&lt;p&gt;The parent is &lt;b&gt;not&lt;/b&gt; in .META. There is a &quot;hole&quot; in the list of regions, as seen by running a scan on .META. from the hbase shell and/or by looking at table.jsp on the master server&apos;s website.&lt;/p&gt;

&lt;p&gt;Also, running &lt;tt&gt;hbase hbck&lt;/tt&gt; identified one of the missing regions (&quot;chain of regions in table ... is broken; edges does not contain &amp;lt;rowkey&amp;gt;&quot;). It did not notice the second missing region. Is that because the process that checks the region chain gives up after the first error? Or could that be unrelated?&lt;/p&gt;</comment>
                            <comment id="13053768" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 09:59:47 +0000"  >&lt;p&gt;For the case Aaron described, should HRegionServer.splitRegion() inform LogRoller that a split is pending so that Hlog roll can be delayed ?&lt;/p&gt;</comment>
                            <comment id="13054009" author="kimballa" created="Thu, 23 Jun 2011 18:10:04 +0000"  >&lt;p&gt;Stack,&lt;/p&gt;

&lt;p&gt;I&apos;m still working on getting more log data available. Hopefully I can get you more info. Here&apos;s something interesting: I believe the parent regions are still hanging around in HBase regionservers.&lt;/p&gt;

&lt;p&gt;hbck reports:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR: Region UNKNOWN_REGION on &amp;lt;regionserver-redacted&amp;gt;:60020, key=4f424608930f7b3ae7c05c49e2bac2c1, not on HDFS or in META but deployed on &amp;lt;regionserver-redacted&amp;gt;:60020
ERROR: Region UNKNOWN_REGION on &amp;lt;regionserver-redacted&amp;gt;:60020, key=81c5fb35e10f8ef61da78bbba28db7f9, not on HDFS or in META but deployed on &amp;lt;regionserver-redacted&amp;gt;:60020
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The region keys match those of the split parents which were abandoned when the &quot;successful&quot; rollback didn&apos;t restore the parent entries in &lt;tt&gt;.META.&lt;/tt&gt;. Is there a way to force these back to storefiles on disk, and then manually add them to &lt;tt&gt;.META.&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="13054019" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 18:32:27 +0000"  >&lt;p&gt;From HBaseFsck.WorkItemRegion.run():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        List&amp;lt;HRegionInfo&amp;gt; regions = server.getOnlineRegions();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think the above error log just means that UNKNOWN_REGION is in the memory of regionserver-redacted.&lt;/p&gt;</comment>
                            <comment id="13056981" author="stack" created="Wed, 29 Jun 2011 03:57:36 +0000"  >&lt;p&gt;Yeah, what Ted says.  If region is gone from filesystem then there is likely little of data up in the RS memory.  Any chance of more log from around the &apos;event&apos; Aaron.&lt;/p&gt;

&lt;p&gt;Meantime I&apos;ll work more on the attached patch.&lt;/p&gt;</comment>
                            <comment id="13057021" author="stack" created="Wed, 29 Jun 2011 06:11:32 +0000"  >&lt;p&gt;Update patch to apply to trunk.&lt;/p&gt;</comment>
                            <comment id="13061960" author="yuzhihong@gmail.com" created="Fri, 8 Jul 2011 13:55:49 +0000"  >&lt;p&gt;A separate patch for 0.90 is needed.&lt;/p&gt;</comment>
                            <comment id="13064337" author="jiraposter@reviews.apache.org" created="Wed, 13 Jul 2011 04:06:59 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/1097/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Fix is two-fold.&lt;/p&gt;

&lt;p&gt;1. Fix catalogjanitor so that it does not remove parent if daughter regions are not present.&lt;br/&gt;
2. Fix the SplitTransaction so that if we go past the point of no return, DO NOT REMOVE daughter regions as part of cleanup; leave them in place.  Because we went past PONR, we are going to abort and server shutdown processing has what it needs to do fixup.&lt;/p&gt;


&lt;p&gt;This addresses bug hbase-3872.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/hbase-3872&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/hbase-3872&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 7082342 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 977115d &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerServices.java c402b87 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/SplitRequest.java 16e970e &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java ab88766 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java 49333ac &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java 56fc0b8 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransaction.java 98a7ee7 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/CatalogJanitor.java 4a35d09 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/1097/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Added two new unit tests.  One to test we do not remove parent if no daughter region in fs and another to test that the right answer pops out of the call to rollback if we go past PONR (and that the daughter regions are still in place after rollback).&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Michael&lt;/p&gt;
</comment>
                            <comment id="13064912" author="jiraposter@reviews.apache.org" created="Wed, 13 Jul 2011 22:15:00 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/1097/#review1049&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/#review1049&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;There are a few white spaces.&lt;/p&gt;


&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/1097/#comment2122&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/#comment2122&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I assume this is a copy-and-paste issue.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-07-13 04:06:54, Michael Stack wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/1097/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-07-13 04:06:54)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Fix is two-fold.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1. Fix catalogjanitor so that it does not remove parent if daughter regions are not present.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2. Fix the SplitTransaction so that if we go past the point of no return, DO NOT REMOVE daughter regions as part of cleanup; leave them in place.  Because we went past PONR, we are going to abort and server shutdown processing has what it needs to do fixup.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug hbase-3872.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/hbase-3872&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/hbase-3872&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 7082342 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 977115d &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerServices.java c402b87 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/SplitRequest.java 16e970e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java ab88766 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java 49333ac &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java 56fc0b8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransaction.java 98a7ee7 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/CatalogJanitor.java 4a35d09 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/1097/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Added two new unit tests.  One to test we do not remove parent if no daughter region in fs and another to test that the right answer pops out of the call to rollback if we go past PONR (and that the daughter regions are still in place after rollback).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Michael&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13064925" author="jiraposter@reviews.apache.org" created="Wed, 13 Jul 2011 22:50:00 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/1097/#review1050&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/#review1050&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/1097/#comment2123&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/#comment2123&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Good one.  You +1 on committing?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Michael&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-07-13 04:06:54, Michael Stack wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/1097/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-07-13 04:06:54)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Fix is two-fold.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1. Fix catalogjanitor so that it does not remove parent if daughter regions are not present.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2. Fix the SplitTransaction so that if we go past the point of no return, DO NOT REMOVE daughter regions as part of cleanup; leave them in place.  Because we went past PONR, we are going to abort and server shutdown processing has what it needs to do fixup.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug hbase-3872.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/hbase-3872&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/hbase-3872&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 7082342 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 977115d &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerServices.java c402b87 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/SplitRequest.java 16e970e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java ab88766 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java 49333ac &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java 56fc0b8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransaction.java 98a7ee7 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/CatalogJanitor.java 4a35d09 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/1097/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Added two new unit tests.  One to test we do not remove parent if no daughter region in fs and another to test that the right answer pops out of the call to rollback if we go past PONR (and that the daughter regions are still in place after rollback).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Michael&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13064930" author="jiraposter@reviews.apache.org" created="Wed, 13 Jul 2011 22:59:00 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/1097/#review1051&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/#review1051&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-07-13 04:06:54, Michael Stack wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/1097/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-07-13 04:06:54)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Fix is two-fold.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1. Fix catalogjanitor so that it does not remove parent if daughter regions are not present.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2. Fix the SplitTransaction so that if we go past the point of no return, DO NOT REMOVE daughter regions as part of cleanup; leave them in place.  Because we went past PONR, we are going to abort and server shutdown processing has what it needs to do fixup.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug hbase-3872.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/hbase-3872&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/hbase-3872&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 7082342 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 977115d &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerServices.java c402b87 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/SplitRequest.java 16e970e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java ab88766 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java 49333ac &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java 56fc0b8 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransaction.java 98a7ee7 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/CatalogJanitor.java 4a35d09 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/1097/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/1097/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Added two new unit tests.  One to test we do not remove parent if no daughter region in fs and another to test that the right answer pops out of the call to rollback if we go past PONR (and that the daughter regions are still in place after rollback).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Michael&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13064981" author="stack" created="Thu, 14 Jul 2011 00:31:35 +0000"  >&lt;p&gt;I applied patch to TRUNK.  Working on version for 0.90.0 now.&lt;/p&gt;</comment>
                            <comment id="13065019" author="hudson" created="Thu, 14 Jul 2011 02:53:40 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2028 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2028/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2028/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3872&quot; title=&quot;Hole in split transaction rollback; edits to .META. need to be rolled back even if it seems like they didn&amp;#39;t make it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3872&quot;&gt;&lt;del&gt;HBASE-3872&lt;/del&gt;&lt;/a&gt; Hole in split transaction rollback; edits to .META. need to be rolled back even if it seems like they didn&apos;t make it&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3872&quot; title=&quot;Hole in split transaction rollback; edits to .META. need to be rolled back even if it seems like they didn&amp;#39;t make it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3872&quot;&gt;&lt;del&gt;HBASE-3872&lt;/del&gt;&lt;/a&gt; Hole in split transaction rollback; edits to .META. need to be rolled back even if it seems like they didn&apos;t make it&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/CatalogJanitor.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransaction.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/SplitRequest.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/RegionServerServices.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13065086" author="hudson" created="Thu, 14 Jul 2011 06:59:05 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2029 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2029/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2029/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3872&quot; title=&quot;Hole in split transaction rollback; edits to .META. need to be rolled back even if it seems like they didn&amp;#39;t make it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3872&quot;&gt;&lt;del&gt;HBASE-3872&lt;/del&gt;&lt;/a&gt; Hole in split transaction rollback; edits to .META. need to be rolled back even if it seems like they didn&apos;t make it; fix failing HRegion test &amp;#8211; server passed is null, allow for this in tests when running splits&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13069811" author="stack" created="Fri, 22 Jul 2011 22:22:25 +0000"  >&lt;p&gt;I committed this to branch a while back (and earlier to trunk)&lt;/p&gt;</comment>
                            <comment id="13070104" author="hudson" created="Sun, 24 Jul 2011 05:00:56 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2049 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2049/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2049/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4129&quot; title=&quot;hbase-3872 added a warn message &amp;#39;CatalogJanitor: Daughter regiondir does not exist&amp;#39; that is triggered though its often legit that daughter is not present&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4129&quot;&gt;&lt;del&gt;HBASE-4129&lt;/del&gt;&lt;/a&gt; hbase-3872 added a warn message &apos;CatalogJanitor: Daughter regiondir does not exist&apos; that is triggered though its often legit that daughter is not present&lt;/p&gt;</comment>
                            <comment id="13103135" author="stack" created="Mon, 12 Sep 2011 22:34:12 +0000"  >&lt;p&gt;This patch plugged this hole two ways:&lt;/p&gt;

&lt;p&gt;1. not removing parent region unless the daughter region existed&lt;br/&gt;
2. on split transaction failure, do NOT remove daughter regions; crash out the regionserver and let fix up of the shutdown server do the fixup in meta adding daughters.&lt;/p&gt;

&lt;p&gt;#1 in the above created &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4238&quot; title=&quot;CatalogJanitor can clear a daughter that split before processing its parent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4238&quot;&gt;&lt;del&gt;HBASE-4238&lt;/del&gt;&lt;/a&gt; where we won&apos;t delete parents if daughters that have themselves split get cleaned up before their parent has all its references let go.  So #1 is being undone over in the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4238&quot; title=&quot;CatalogJanitor can clear a daughter that split before processing its parent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4238&quot;&gt;&lt;del&gt;HBASE-4238&lt;/del&gt;&lt;/a&gt; since its possible daughter regions may not exist in the fs legitimately.&lt;/p&gt;</comment>
                            <comment id="13123662" author="koven2049" created="Sun, 9 Oct 2011 10:50:32 +0000"  >&lt;p&gt;@stack: Do you think delete daughter regions when rollbacking will cause data loss?&lt;br/&gt;
  We can replay this bug while using the follow code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;SplitTransaction.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!testing) {
      MetaEditor.offlineParentInMeta(server.getCatalogTracker(),
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.parent.getRegionInfo(), a.getRegionInfo(), b.getRegionInfo());
&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; test!&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;  we think we could move &quot;this.journal.add(JournalEntry.PONR);&quot; before MetaEditor.offlineParentInMeta, then rollback would cause RS exit, not delete Daughter regions.&lt;br/&gt;
  Do you think so?&lt;/p&gt;</comment>
                            <comment id="13123670" author="bluedavy" created="Sun, 9 Oct 2011 12:07:51 +0000"  >&lt;p&gt;@stack&lt;br/&gt;
current patch will cause data-loss in this situation:&lt;br/&gt;
1. change the SplitTransaction just like @mingjian said;&lt;br/&gt;
2. then create a table &amp;amp; put some data in hbase shell;&lt;br/&gt;
3. split the table in hbase shell;&lt;br/&gt;
4. kill the region server hosted the table;&lt;br/&gt;
5. after master do servershutdownhandler,then the table can be wrote again,but the data previous wrote to the table lost.&lt;/p&gt;

&lt;p&gt;and in above code,if we don&apos;t kill the region server,then the parent region cann&apos;t be wrote,even if restart the cluster.&lt;/p&gt;</comment>
                            <comment id="13123837" author="bluedavy" created="Mon, 10 Oct 2011 02:11:39 +0000"  >&lt;p&gt;We fix the bug using below code:&lt;br/&gt;
 if (!testing) &lt;/p&gt;
{
+        this.journal.add(JournalEntry.PONR);
         MetaEditor.offlineParentInMeta(server.getCatalogTracker(),this.parent.getRegionInfo(),
a.getRegionInfo(), b.getRegionInfo());
    }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this.journal.add(JournalEntry.PONR);&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13123838" author="bluedavy" created="Mon, 10 Oct 2011 02:13:51 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Bar.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!testing) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.journal.add(JournalEntry.PONR); 
      MetaEditor.offlineParentInMeta(server.getCatalogTracker(),
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.parent.getRegionInfo(), a.getRegionInfo(), b.getRegionInfo());
    }
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.journal.add(JournalEntry.PONR); &lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="13123842" author="yuzhihong@gmail.com" created="Mon, 10 Oct 2011 02:23:29 +0000"  >&lt;p&gt;I think the above code should be improved.&lt;br/&gt;
If testing is true, JournalEntry.PONR wouldn&apos;t be set.&lt;br/&gt;
It seems JournalEntry.PONR should be set before the check for testing.&lt;/p&gt;

&lt;p&gt;A new JIRA should be opened.&lt;/p&gt;</comment>
                            <comment id="13123861" author="bluedavy" created="Mon, 10 Oct 2011 03:14:41 +0000"  >&lt;p&gt;I created the &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4562&quot; title=&quot;When split doing offlineParentInMeta encounters error, it&amp;#39;ll cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4562&quot;&gt;&lt;del&gt;HBASE-4562&lt;/del&gt;&lt;/a&gt;,&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4563&quot; title=&quot;When error occurs in this.parent.close(false) of split, the split region cannot write or read&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4563&quot;&gt;&lt;del&gt;HBASE-4563&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15017689" author="lars_francke" created="Fri, 20 Nov 2015 12:44:02 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12484596" name="3872-v2.txt" size="13139" author="stack" created="Wed, 29 Jun 2011 06:11:32 +0000"/>
                            <attachment id="12480304" name="3872.txt" size="13212" author="stack" created="Tue, 24 May 2011 19:17:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 23 Jun 2011 04:55:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27067</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ho9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101195</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>