<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:07:07 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3071/HBASE-3071.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3071] Graceful decommissioning of a regionserver</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3071</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Currently if you stop a regionserver nicely, it&apos;ll put up its stopping flag and then close all hosted regions.  While the stopping flag is in place all region requests are rejected.  If this server was under load, closing could take a while.  Only after all is closed is the master informed and it&apos;ll restart assigning (in old master, master woud get a report with list of all regions closed, in new master the zk expired is triggered and we&apos;ll run shutdown handler).&lt;/p&gt;

&lt;p&gt;At least in new master, we have means of disabling balancer, and then moving the regions off the server one by one via HBaseAdmin methods &amp;#8211; we shoud write a script to do this at least for rolling restarts &amp;#8211; but we need something better.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12475672">HBASE-3071</key>
            <summary>Graceful decommissioning of a regionserver</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Oct 2010 23:08:47 +0000</created>
                <updated>Fri, 20 Nov 2015 12:43:06 +0000</updated>
                            <resolved>Tue, 5 Apr 2011 04:09:41 +0000</resolved>
                                                    <fixVersion>0.90.3</fixVersion>
                    <fixVersion>0.92.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12917091" author="jdcryans" created="Fri, 1 Oct 2010 23:18:34 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13012347" author="stack" created="Tue, 29 Mar 2011 06:27:03 +0000"  >&lt;p&gt;A graceful shutdown shell script and a ruby script that will move the regions off the regionserver one by one confirming region in new location before moving to the next.&lt;/p&gt;</comment>
                            <comment id="13012640" author="jdcryans" created="Tue, 29 Mar 2011 19:32:01 +0000"  >&lt;p&gt;Typo in &quot;minus the ond to decommission&quot;&lt;/p&gt;

&lt;p&gt;Don&apos;t create two new HTable per region moved in move(), it&apos;s gonna get expensive very soon.&lt;/p&gt;

&lt;p&gt;When trying to get the first row, you could just use the FirstKeyOnlyFilter and even the KeyOnlyFilter.&lt;/p&gt;

&lt;p&gt;The &quot;Moving&quot; message is weird, it&apos;s not clear it&apos;s iterating starting from 0.&lt;/p&gt;

&lt;p&gt;Could admin.move fail and abort the whole process if the region has split?&lt;/p&gt;</comment>
                            <comment id="13013687" author="stack" created="Wed, 30 Mar 2011 21:45:27 +0000"  >&lt;p&gt;Addressed J-D issues.&lt;/p&gt;

&lt;p&gt;Changed names of scripts and how they run.  now there is a graceful_stop.sh script that manages running of the region_mover.rb script and subsequent remote shutdown.  graceful_stop.sh takes flags to restart the node subsequently and then another reload flag which will put back the old region set on the just-started node.&lt;/p&gt;

&lt;p&gt;I played trying to add the load/unload region script to hbase-daemon.sh so we could do stuff like ./bin/hbase-daemons.sh unload regionserver but that gets messy in bash.  I already had to add flag to bin/hbase to optionally not run java with an exec.&lt;/p&gt;

&lt;p&gt;Testing on cluster seems to basically work.   Going to try with a cluster under load next.&lt;/p&gt;</comment>
                            <comment id="13013689" author="stack" created="Wed, 30 Mar 2011 21:50:40 +0000"  >&lt;p&gt;Other notes:&lt;/p&gt;

&lt;p&gt;Currently I run it like this:&lt;/p&gt;

&lt;p&gt;for i in `cat regionserver`; do ./bin/graceful.sh SERVERNAME; done&lt;/p&gt;

&lt;p&gt;You should turn off the balancer before you do the above.  The region_mover.rb doesn&apos;t care in that if regions show up since it started, it&apos;ll just start in on the new ones until its down to zero regions (though could be race in here if balancer is running).  Script doesn&apos;t turn it on/off because need to trap to turn it back on again AND the current api for balancer is dumb; there is no way to query current state... so this is manual step for now.&lt;/p&gt;

&lt;p&gt;We can move off ~2 regions per second on unloaded cluster.  Moving back on the regions takes longer for some reason &amp;#8211; about 1 a second.  This means a rolling restart could take a while on a big loaded cluster.  Could parallellize this script but would need more work to make sure concurrent graceful_restarts all read a common set of restarting servers.&lt;/p&gt;
</comment>
                            <comment id="13013832" author="stack" created="Thu, 31 Mar 2011 05:10:28 +0000"  >&lt;p&gt;Added more retries of move (saw case where server wasn&apos;t fully up yet so move to that server failed and on retry, we put it back in old location.. which looked like it&apos;d never moved).&lt;/p&gt;

&lt;p&gt;Tested under load.  All just runs slower.  But loading keeps going.&lt;/p&gt;

&lt;p&gt;More notes.&lt;/p&gt;

&lt;p&gt;So, we unload a region at a time till zero.  Then we do clean shutdown.  This triggers over in master the recover of an expired server only there are no logs to process because it had a clean shutdown, so the server comes up pretty fast and is then ready to take on regions again.&lt;/p&gt;

&lt;p&gt;If balancer runs, it doesn&apos;t cause &apos;failure&apos; but what it does is that while unloading, it can add some new regions to a server.  We&apos;ll then move those off.  Now, this RS will have the old burden plus the new associated with it.  On replay the cluster will be out of kilter, off-balance... so its kinda important having the cluster basically balanced before running this script.&lt;/p&gt;

&lt;p&gt;If exception processing a server, we&apos;ll skip it.  It can be hard to figure a failure if you don&apos;t keep logs and look at them after.  The region mover logs each region move which can be a bunch and if server 50 of 100 failed, you could have a cluster that was 99% upgraded, only.&lt;/p&gt;

&lt;p&gt;A wrapper script that runs the rolling restart &amp;#8211; enable/disabling balancer, upping and downing masters (see current bin/rolling_restart.sh) &amp;#8211; we could check zk to see if a servers&apos; servername changed (servername is hostname + port + startcode).  If it hadn&apos;t, we could on the end flag it as failed rolling restart.&lt;/p&gt;

&lt;p&gt;I&apos;m figuring wrapper script outside the scope of this issue.  For now I do a manual enable/disable of balancer and then do a for loop calling bin/graceful_stop.sh...&lt;/p&gt;</comment>
                            <comment id="13013833" author="stack" created="Thu, 31 Mar 2011 05:11:28 +0000"  >&lt;p&gt;Looking for a bit of a review.  Was figuring this could go into branch and trunk.  It doesn&apos;t change any server code, not yet anyways, just scripts.&lt;/p&gt;</comment>
                            <comment id="13015742" author="stack" created="Tue, 5 Apr 2011 03:46:44 +0000"  >&lt;p&gt;More testing.  Added some waits on machines to come up, a --debug flag, and some more helpful logging.&lt;/p&gt;</comment>
                            <comment id="13015746" author="stack" created="Tue, 5 Apr 2011 04:09:41 +0000"  >&lt;p&gt;Applied branch and trunk.  Added doc. to book on how to decommission a node and how you could do a rolling restart using this script.&lt;/p&gt;</comment>
                            <comment id="13016236" author="hudson" created="Wed, 6 Apr 2011 03:51:08 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1831 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/HBase-TRUNK/1831/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/HBase-TRUNK/1831/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="13204028" author="jmhsieh" created="Wed, 8 Feb 2012 21:46:47 +0000"  >&lt;p&gt;Updated jira to include the the 0.90.x version it was included in.&lt;/p&gt;</comment>
                            <comment id="15017433" author="lars_francke" created="Fri, 20 Nov 2015 12:43:06 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12475454" name="3071-v5.txt" size="18385" author="stack" created="Tue, 5 Apr 2011 03:46:44 +0000"/>
                            <attachment id="12474848" name="3071.txt" size="8470" author="stack" created="Tue, 29 Mar 2011 06:27:03 +0000"/>
                            <attachment id="12475019" name="3701-v2.txt" size="16488" author="stack" created="Wed, 30 Mar 2011 21:45:27 +0000"/>
                            <attachment id="12475057" name="3701-v3.txt" size="16886" author="stack" created="Thu, 31 Mar 2011 05:10:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 1 Oct 2010 23:18:34 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32892</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hkmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100603</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Adds bin/graceful_stop.sh.  See the reference guide decommission section for documentation: &lt;a href=&quot;http://hbase.apache.org/book.html#decommission&quot;&gt;http://hbase.apache.org/book.html#decommission&lt;/a&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>