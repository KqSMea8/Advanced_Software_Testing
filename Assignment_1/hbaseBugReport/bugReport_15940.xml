<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:08:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-15940/HBASE-15940.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-15940] HBCK unnecessary moves reference files when a table has split region to fix non-existing overlap regions</title>
                <link>https://issues.apache.org/jira/browse/HBASE-15940</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When repair option (the -fixHdfsOverlaps option specifically) is specified against a table, if the table has splitted regions (both parent region and child regions exists with reference files), Hbck would wrongly think that there exists overlapped regions and try to merge them and fix it.  &lt;/p&gt;

&lt;p&gt;This is by-design, as current implementation of Hbck uses HDFS as the trusted source without consulting META table.&lt;/p&gt;

&lt;p&gt;Here is the comments from one of unit tests:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-comment&quot;&gt;// TODO: fixHdfsHoles does not work against splits, since the parent dir lingers on
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; some time until children references are deleted. HBCK erroneously sees &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; as
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// overlapping regions&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, this is undesirable.  when the reference files moved to a new region, the parent region would have no daugher regions and hence it could be cleaned up by CatalogJanitor.  This would create real inconsistency: lingering reference files.  &lt;/p&gt;

&lt;p&gt;Another bad consequence is that we would merge splitted regions back to one.  Even it is undesirable, at least this would not cause more inconsistency.  this JIRA would not try to solve this unsplit issue, as it requires bigger design change in Hbck.  &lt;/p&gt;

&lt;p&gt;This JIRA is  trying to address the potential lingering reference files issue, as multiple customers using branch-1 faced this issue in production.  (workaround is that run major compaction on all split regions before run HBCK, this could take longer time and have production impact).&lt;/p&gt;

&lt;p&gt;Attached is the log and modified unit test to repro the issue.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12975021">HBASE-15940</key>
            <summary>HBCK unnecessary moves reference files when a table has split region to fix non-existing overlap regions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="syuanjiang">Stephen Yuan Jiang</assignee>
                                    <reporter username="syuanjiang">Stephen Yuan Jiang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Jun 2016 02:42:02 +0000</created>
                <updated>Sat, 4 Jun 2016 00:02:11 +0000</updated>
                                            <version>1.0.0</version>
                                                    <component>hbck</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15311627" author="syuanjiang" created="Thu, 2 Jun 2016 02:44:55 +0000"  >&lt;p&gt;One possible solution is that we really don&apos;t need to copy referenced files to a new region during  fixHdfsOverlaps - either the referenced file is orphaned; or the real files that the referenced files point to are already in the new region.&lt;/p&gt;</comment>
                            <comment id="15314161" author="syuanjiang" created="Fri, 3 Jun 2016 14:12:58 +0000"  >&lt;p&gt;After HBCK identifies the overlapped regions, it first offline those regions, then moves files in those regions into a new region to repair.  So the real root cause is that catalog janitor is running during repair; before the files are moved, after the regions are offline, catalog janitor would clean up parent region and leave reference files orphaned.  Therefore, another possible solution (simpler and safer) is just to disable catalog janitor during HBCK.  &lt;/p&gt;

&lt;p&gt;I still believe that we should not copy reference files around (the files it referenced would be copied to the same location so reference files are unneeded; or the reference files are orphaned and it should be removed any way - in both cases, reference files are not useful in a new region).  &lt;/p&gt;

&lt;p&gt;Attached a patch to have both change  (UT testing indicates no problem if we skipped reference file, but it is risky and needs more testing).&lt;/p&gt;</comment>
                            <comment id="15314758" author="enis" created="Fri, 3 Jun 2016 20:39:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is by-design, as current implementation of Hbck uses HDFS as the trusted source without consulting META table.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yep, we should fix that. Both holes and overlaps should be modeled similar to the rest of the HBCK fixes in terms of looking at both meta and HDFS. We can deprecate &lt;tt&gt;-fixHdfsHoles&lt;/tt&gt; and &lt;tt&gt;-fixHdfsOverlaps&lt;/tt&gt; and instead introduce &lt;tt&gt;-fixHoles&lt;/tt&gt; and &lt;tt&gt;-fixOverlaps&lt;/tt&gt; which &lt;tt&gt;-repair&lt;/tt&gt; uses by default. Are you gonna create a different issue to track this? &lt;/p&gt;
</comment>
                            <comment id="15314776" author="enis" created="Fri, 3 Jun 2016 20:48:02 +0000"  >&lt;p&gt;Can we check whether the parent file is moved (or will be moved) to the new region before deleting the ref file. Otherwise, sideline the reference file just in case. &lt;/p&gt;

&lt;p&gt;Did you see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15406&quot; title=&quot;Split / merge switch left disabled after early termination of hbck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15406&quot;&gt;&lt;del&gt;HBASE-15406&lt;/del&gt;&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="15314796" author="syuanjiang" created="Fri, 3 Jun 2016 20:58:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15941&quot; title=&quot;HBCK repair should not unsplit healthy splitted region&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15941&quot;&gt;HBASE-15941&lt;/a&gt; would address this.&lt;/p&gt;</comment>
                            <comment id="15315073" author="syuanjiang" created="Fri, 3 Jun 2016 23:08:49 +0000"  >&lt;p&gt;The existing flow is: offline region, move some of the files in the overlapped regions to a new region, then sidelined the old region directory.  So any files (eg. the old .regioninfo file) that are not moved will be sidelined.  I don&apos;t have to write any new code for this.  the unmoved reference file is automatically sidelined at the end of merge.&lt;/p&gt;

&lt;p&gt;Yeah, I did see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15406&quot; title=&quot;Split / merge switch left disabled after early termination of hbck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15406&quot;&gt;&lt;del&gt;HBASE-15406&lt;/del&gt;&lt;/a&gt; when I add the new admin.setCatalogJanitor(false) code.  If HBCK run is killed by Ctrl-C, the Catalog Janitor would be disabled until manual enable.  I think a Ctrl-C is not a common practice and not running Catalog Janitor is not a big deal (at least to me, how often do we split/merge regions and then run major compaction).  I feel that using zookeeper to keep track of catalog janitor enable/disable is a little bit overkill for this problem.  That is why I prefer just have a simple disable and enable in the finally-block. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12975029">HBASE-15941</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12807625" name="org.apache.hadoop.hbase.util.TestHBaseFsck-output.txt" size="710394" author="syuanjiang" created="Thu, 2 Jun 2016 06:17:07 +0000"/>
                            <attachment id="12807626" name="repro-hbck-repair-healthy-splitted=region.patch" size="19480" author="syuanjiang" created="Thu, 2 Jun 2016 06:17:07 +0000"/>
                            <attachment id="12807969" name="skipReferenceFiles.patch" size="2070" author="syuanjiang" created="Fri, 3 Jun 2016 14:12:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 3 Jun 2016 20:39:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yv5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>