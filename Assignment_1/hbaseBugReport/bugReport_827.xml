<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:47:52 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-827/HBASE-827.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-827] Failed to open scanner in shell after series of action executed</title>
                <link>https://issues.apache.org/jira/browse/HBASE-827</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Background introduction :&lt;br/&gt;
I was intent to implement a large queue-liked structure based on HBase.&lt;br/&gt;
Different from normal queue structure, in my structure, a pop action means &apos;randomly&apos; pick one elements(which is key/value pair from a row) in queue, and decrease the queueSize of that queue.&lt;/p&gt;

&lt;p&gt;For performance consideration, I implemented pop action by following steps :&lt;br/&gt;
1.get the queue size&lt;br/&gt;
2.random a number between 0~queueSize&lt;br/&gt;
3.take step2 as a qualifier, get the value of that element, and put the last element&apos;s value to the original qualifier.&lt;br/&gt;
4.decrease the queue size. (I didn&apos;t delete the last elements since storage space is not my primary consideration)&lt;/p&gt;

&lt;p&gt;When the queueSize and number of pop action become large, hbase failed to open a scanner. (Even the data of database is correct)&lt;/p&gt;

&lt;p&gt;My program can be split into few steps:&lt;br/&gt;
1.create a large queue.&lt;br/&gt;
2.pop until the queue empty&lt;br/&gt;
3.keep popping the queue &lt;br/&gt;
4.delete the queue ( delete a row with deleteAll )&lt;br/&gt;
5.create a small queue with same name (i.e: same row)&lt;/p&gt;

&lt;p&gt;After create a small queue, I checked every key/value in the hbase and found it is correct. But when I tried to open a scanner, it got Unknown Exception as follows:&lt;/p&gt;

&lt;p&gt;In shell :&lt;br/&gt;
NativeException: org.apache.hadoop.hbase.client.RetriesExhaustedException: Trying to contact region server 127.0.0.1:54141 for region pleaseCrash,,1218621377152, row &apos;&apos;, but failed after 3 attempts.&lt;br/&gt;
Exceptions:&lt;br/&gt;
java.net.SocketTimeoutException: timed out waiting for rpc response&lt;br/&gt;
java.net.SocketTimeoutException: timed out waiting for rpc response&lt;br/&gt;
java.net.SocketTimeoutException: timed out waiting for rpc response&lt;/p&gt;

&lt;p&gt;        from org/apache/hadoop/hbase/client/HConnectionManager.java:873:in `getRegionServerWithRetries&apos;&lt;br/&gt;
        from org/apache/hadoop/hbase/client/HTable.java:1415:in `nextScanner&apos;&lt;br/&gt;
        from org/apache/hadoop/hbase/client/HTable.java:1360:in `&amp;lt;init&amp;gt;&apos;&lt;br/&gt;
        from org/apache/hadoop/hbase/client/HTable.java:985:in `getScanner&apos;&lt;br/&gt;
        from org/apache/hadoop/hbase/client/HTable.java:779:in `getScanner&apos;&lt;br/&gt;
        from org/apache/hadoop/hbase/client/HTable.java:706:in `getScanner&apos;&lt;br/&gt;
        from sun/reflect/NativeMethodAccessorImpl.java:-2:in `invoke0&apos;&lt;br/&gt;
        from sun/reflect/NativeMethodAccessorImpl.java:39:in `invoke&apos;&lt;br/&gt;
        from sun/reflect/DelegatingMethodAccessorImpl.java:25:in `invoke&apos;&lt;br/&gt;
        from java/lang/reflect/Method.java:597:in `invoke&apos;&lt;br/&gt;
        from org/jruby/javasupport/JavaMethod.java:250:in `invokeWithExceptionHandling&apos;&lt;br/&gt;
        from org/jruby/javasupport/JavaMethod.java:219:in `invoke&apos;&lt;br/&gt;
        from org/jruby/javasupport/JavaClass.java:416:in `execute&apos;&lt;br/&gt;
        from org/jruby/internal/runtime/methods/SimpleCallbackMethod.java:67:in `call&apos;&lt;br/&gt;
        from org/jruby/internal/runtime/methods/DynamicMethod.java:78:in `call&apos;&lt;br/&gt;
        from org/jruby/runtime/CallSite.java:155:in `cacheAndCall&apos;&lt;br/&gt;
... 128 levels...&lt;br/&gt;
        from ruby.home.itspeter.hbase_minus_0_dot_3_dot_0_minus_dev.bin.hirbInvokermethod__23$RUBY$startOpt:-1:in `call&apos;&lt;br/&gt;
        from org/jruby/internal/runtime/methods/DynamicMethod.java:74:in `call&apos;&lt;br/&gt;
        from org/jruby/internal/runtime/methods/CompiledMethod.java:48:in `call&apos;&lt;br/&gt;
        from org/jruby/runtime/CallSite.java:123:in `cacheAndCall&apos;&lt;br/&gt;
        from org/jruby/runtime/CallSite.java:298:in `call&apos;&lt;br/&gt;
        from ruby/home/itspeter/hbase_minus_0_dot_3_dot_0_minus_dev/bin//home/itspeter/hbase-0.3.0-dev/bin/../bin/hirb.rb:350:in `_&lt;em&gt;file&lt;/em&gt;_&apos;&lt;br/&gt;
        from ruby/home/itspeter/hbase_minus_0_dot_3_dot_0_minus_dev/bin//home/itspeter/hbase-0.3.0-dev/bin/../bin/hirb.rb:-1:in `_&lt;em&gt;file&lt;/em&gt;_&apos;&lt;br/&gt;
        from ruby/home/itspeter/hbase_minus_0_dot_3_dot_0_minus_dev/bin//home/itspeter/hbase-0.3.0-dev/bin/../bin/hirb.rb:-1:in `load&apos;&lt;br/&gt;
        from org/jruby/Ruby.java:512:in `runScript&apos;&lt;br/&gt;
        from org/jruby/Ruby.java:432:in `runNormally&apos;&lt;br/&gt;
        from org/jruby/Ruby.java:312:in `runFromMain&apos;&lt;br/&gt;
        from org/jruby/Main.java:144:in `run&apos;&lt;br/&gt;
        from org/jruby/Main.java:89:in `run&apos;&lt;br/&gt;
        from org/jruby/Main.java:80:in `main&apos;&lt;br/&gt;
        from /home/itspeter/hbase-0.3.0-dev/bin/../bin/hirb.rb:271:in `scan&apos;&lt;br/&gt;
        from (hbase):3:in `binding&apos;&lt;/p&gt;

&lt;p&gt;Side effects :&lt;br/&gt;
	After scan got time out, I discovered that I also failed to disable the table (But not every time), somehow more strange is that table will be dropped successfully even disable failed (but not every time).&lt;/p&gt;

&lt;p&gt;System Resources:&lt;br/&gt;
	Hbase will rob the cpu...&lt;br/&gt;
	In my platform(4-core), cpu usage will raise from 10% -&amp;gt; 50% ..100% -&amp;gt; 200% -&amp;gt; 300% ..&lt;/p&gt;

&lt;p&gt;Procedure to reproduce :&lt;br/&gt;
Run the attached java file. &lt;br/&gt;
Try to type &quot;scan &apos;pleaseCrash&apos;&quot; in hbase shell after program finished.&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Java runtime version : 1.6.0_06&lt;br/&gt;
Hbase version : occured in both 0.2.0 RC2 &amp;amp; 0.3.0 trunk (svn 685494)&lt;br/&gt;
Hbase configuration: run in localhost without hadoop&lt;/p&gt;</environment>
        <key id="12402293">HBASE-827</key>
            <summary>Failed to open scanner in shell after series of action executed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="6">Invalid</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="itspeter">PeterL in</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Aug 2008 11:34:08 +0000</created>
                <updated>Fri, 22 Aug 2008 21:35:06 +0000</updated>
                            <resolved>Wed, 20 Aug 2008 02:50:37 +0000</resolved>
                                    <version>0.18.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12622179" author="itspeter" created="Wed, 13 Aug 2008 11:36:31 +0000"  >&lt;p&gt;Code to reproduce problem : MyClient.java&lt;br/&gt;
jstack log : jstack.log&lt;br/&gt;
Hbase log : hbase.log (From empty database to scanner failed)&lt;/p&gt;</comment>
                            <comment id="12623175" author="rafan" created="Sun, 17 Aug 2008 05:21:16 +0000"  >&lt;p&gt;I grab the MyClient.java and latest trunk (r686572) to try it out. So, the example program do the following things:&lt;/p&gt;

&lt;p&gt;1. insert 40000 columns under one col family&lt;br/&gt;
2. insert a number into the same col family to record the total # of cols in this family&lt;br/&gt;
3. repeat 100,000 times, do read one column value, modify it, insert back&lt;br/&gt;
4. delete everything&lt;br/&gt;
5. repeat 1 but with much smaller columns to insert&lt;/p&gt;

&lt;p&gt;Then I try to get a scanner from java client:&lt;/p&gt;

&lt;p&gt;table.getScanner(new String[]&lt;/p&gt;
{&quot;insPool:&quot;}
&lt;p&gt;);&lt;/p&gt;

&lt;p&gt;The table in question has only few columns but lots of deleted records (about 140,000). The scanner needs some time to finish it&apos;s job. The line above requires 240 seconds to finish (that&apos;s 4 mins).&lt;/p&gt;

&lt;p&gt;However, in hirb.rb, we have&lt;/p&gt;

&lt;p&gt;@configuration.setInt(&quot;hbase.client.retries.number&quot;, 3)&lt;br/&gt;
@configuration.setInt(&quot;ipc.client.connect.max.retries&quot;, 3)&lt;/p&gt;

&lt;p&gt;These are smaller than hbase-default.xml, and this is why scan shell fails.&lt;/p&gt;</comment>
                            <comment id="12623228" author="stack" created="Sun, 17 Aug 2008 20:42:58 +0000"  >&lt;p&gt;(Thanks for digging in Rong-en)&lt;/p&gt;

&lt;p&gt;I set the timeouts and retries down from the default in the shell to try and make it more &apos;responsive&apos; (one thing having a program hang round but another asking a human do the same).&lt;/p&gt;

&lt;p&gt; &apos;@configuration&apos; is the global HBaseConfiguration for the hirb shell and it seems easy enough changing the shell configuration to be something else:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
durruti:~/Documents/checkouts/hbase/trunk stack$ ./bin/hbase shell
HBase Shell; enter &apos;help&amp;lt;RETURN&amp;gt;&apos; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; list of supported commands.
Version: 0.3.0-dev, r686335, Fri Aug 15 16:42:18 PDT 2008
hbase(main):001:0&amp;gt; @configuration.get(&apos;hbase.client.retries.number&apos;)
=&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt;
hbase(main):003:0&amp;gt; @configuration.setInt(&apos;hbase.client.retries.number&apos;, 10)
hbase(main):005:0&amp;gt; @configuration.get(&apos;hbase.client.retries.number&apos;)   
=&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;10&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12623886" author="itspeter" created="Wed, 20 Aug 2008 02:50:37 +0000"  >&lt;p&gt;Thanks for Rong-en and stack&apos;s solution : )&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12388127" name="MyClient.java" size="4353" author="itspeter" created="Wed, 13 Aug 2008 11:36:30 +0000"/>
                            <attachment id="12388133" name="hbase.log" size="31999" author="itspeter" created="Wed, 13 Aug 2008 12:06:25 +0000"/>
                            <attachment id="12388128" name="jstack.log" size="21374" author="itspeter" created="Wed, 13 Aug 2008 11:39:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 17 Aug 2008 05:21:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25421</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 18 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h9on:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98831</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>