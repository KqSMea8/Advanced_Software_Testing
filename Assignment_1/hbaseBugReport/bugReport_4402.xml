<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:18:36 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4402/HBASE-4402.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4402] Retaining locality after restart broken</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4402</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In DefaultLoadBalancer, we implement the &quot;retain assignment&quot; function like so:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sn != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; servers.contains(sn)) {
        assignments.get(sn).add(region.getKey());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but this will never work since after a cluster restart, all servers have a new ServerName with a new startcode.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12523007">HBASE-4402</key>
            <summary>Retaining locality after restart broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tlipcon">Todd Lipcon</assignee>
                                    <reporter username="tlipcon">Todd Lipcon</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Sep 2011 07:19:33 +0000</created>
                <updated>Fri, 20 Nov 2015 11:52:20 +0000</updated>
                            <resolved>Thu, 6 Oct 2011 20:12:56 +0000</resolved>
                                    <version>0.92.0</version>
                                    <fixVersion>0.92.0</fixVersion>
                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13105152" author="tlipcon" created="Thu, 15 Sep 2011 06:44:15 +0000"  >&lt;p&gt;Turns out the test basically duplicated the same faulty logic. Fixed both the test and the code. Haven&apos;t tried on a cluster yet.&lt;/p&gt;</comment>
                            <comment id="13105378" author="yuzhihong@gmail.com" created="Thu, 15 Sep 2011 14:05:36 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        ServerName randomServer = servers.get(RANDOM.nextInt(servers.size()));
+        assignments.get(randomServer).add(region);
+        numRandomAssignments++;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think we should log the (region, server) pairs for the above case.&lt;/p&gt;</comment>
                            <comment id="13105532" author="stack" created="Thu, 15 Sep 2011 17:37:25 +0000"  >&lt;p&gt;+1 on patch.  I like the new log message on how much assignment retained old locations.&lt;/p&gt;</comment>
                            <comment id="13105570" author="tlipcon" created="Thu, 15 Sep 2011 18:24:40 +0000"  >&lt;p&gt;New patch addresses Ted&apos;s comments. The log messages are as follows:&lt;/p&gt;

&lt;p&gt;For the case where all are retained:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-09-15 11:22:57,592 INFO  [main] master.DefaultLoadBalancer(643): Reassigned 100 regions. 100 retained the pre-restart assignment.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the case where some were reassigned:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
2011-09-15 11:22:57,604 INFO  [main] master.DefaultLoadBalancer(643): Reassigned 100 regions. 80 retained the pre-restart assignment. 20 regions were assigned to random hosts, since the old hosts &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; these regions are no longer present in the cluster. These hosts were:
  server29568
  server80916
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13105577" author="yuzhihong@gmail.com" created="Thu, 15 Sep 2011 18:32:23 +0000"  >&lt;p&gt;Thanks Todd for the quick response, appreciate it.&lt;/p&gt;

&lt;p&gt;If I were Ops, I would be more interested in knowing the regions that were randomly assigned.&lt;/p&gt;</comment>
                            <comment id="13119596" author="tlipcon" created="Mon, 3 Oct 2011 20:54:30 +0000"  >&lt;p&gt;Since we now have locality metrics on regions, it seems like we can already see that information elsewhere. The log output here is helpful since you can quickly see which servers didn&apos;t properly rejoin the cluster.&lt;/p&gt;</comment>
                            <comment id="13120527" author="stack" created="Tue, 4 Oct 2011 22:19:28 +0000"  >&lt;p&gt;OK if I commit this?  Ted?&lt;/p&gt;</comment>
                            <comment id="13120530" author="yuzhihong@gmail.com" created="Tue, 4 Oct 2011 22:22:41 +0000"  >&lt;p&gt;Sure.&lt;/p&gt;</comment>
                            <comment id="13120680" author="stack" created="Wed, 5 Oct 2011 05:19:26 +0000"  >&lt;p&gt;Ran test suite w/o on 0.92 and all tests passed and with it these failed:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Failed tests:   testOnlineChangeTableSchema(org.apache.hadoop.hbase.client.TestAdmin)
  testForceSplit(org.apache.hadoop.hbase.client.TestAdmin): expected:&amp;lt;2&amp;gt; but was:&amp;lt;1&amp;gt;
  testForceSplitMultiFamily(org.apache.hadoop.hbase.client.TestAdmin): expected:&amp;lt;2&amp;gt; but was:&amp;lt;1&amp;gt;

Tests in error:
  testMergeTable(org.apache.hadoop.hbase.util.TestMergeTable): test timed out after 300000 milliseconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m taking a look.&lt;/p&gt;</comment>
                            <comment id="13121042" author="stack" created="Wed, 5 Oct 2011 15:23:37 +0000"  >&lt;p&gt;I ran it again and got this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

Results :

Failed tests:   testSingleMethod(org.apache.hadoop.hbase.regionserver.TestServerCustomProtocol): Results should contain region test,ccc,1317795815964.d181ee3cf99a2f9e33d6b4561f52a72f. &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row &apos;ccc&apos;
  testOnlineChangeTableSchema(org.apache.hadoop.hbase.client.TestAdmin)
  testForceSplitMultiFamily(org.apache.hadoop.hbase.client.TestAdmin): expected:&amp;lt;2&amp;gt; but was:&amp;lt;1&amp;gt;

Tests in error:
  testMergeTable(org.apache.hadoop.hbase.util.TestMergeTable): test timed out after 300000 milliseconds

Tests run: 1017, Failures: 3, Errors: 1, Skipped: 21
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Similar machine did clean build of 0.92.  Will keep at it.&lt;/p&gt;</comment>
                            <comment id="13121559" author="stack" created="Wed, 5 Oct 2011 22:42:04 +0000"  >&lt;p&gt;Looks like the testMergeTable failure is because of this patch.  Adding the below gets us past the testMergeTable failure (NPEs causing master shutdown and then test would hang looking for the absconded master).  This test is weird too anyways hand-creating regions in fs then bringing all online; needs to be refactored but meantime....&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
68,69c140,143
&amp;lt; +      List&amp;lt;ServerName&amp;gt; localServers = serversByHostname.get(
&amp;lt; +          oldServerName.getHostname());
---
&amp;gt; +      List&amp;lt;ServerName&amp;gt; localServers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;ServerName&amp;gt;();
&amp;gt; +      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldServerName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&amp;gt; +        localServers = serversByHostname.get(oldServerName.getHostname());
&amp;gt; +      }
76c150
&amp;lt; +        oldHostsNoLongerPresent.add(oldServerName.getHostname());
---
&amp;gt; +        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldServerName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) oldHostsNoLongerPresent.add(oldServerName.getHostname());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13121610" author="tlipcon" created="Wed, 5 Oct 2011 23:55:23 +0000"  >&lt;p&gt;Your fix looks good. I didn&apos;t think about the fact that there might be nulls due to regions that were added while the server was offline, or if a table was disabled when shutdown, but ZK was wiped before the cluster was brought back up.&lt;/p&gt;</comment>
                            <comment id="13121741" author="lhofhansl" created="Thu, 6 Oct 2011 05:48:56 +0000"  >&lt;p&gt;We just ran into this yesterday in our 0.92 based (small) test cluster.&lt;br/&gt;
Nice patch!&lt;/p&gt;</comment>
                            <comment id="13122207" author="stack" created="Thu, 6 Oct 2011 20:05:22 +0000"  >&lt;p&gt;Let me apply the updated patch.  The below failures seem unrelated:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

Failed tests:   testOnlineChangeTableSchema(org.apache.hadoop.hbase.client.TestAdmin)
  testForceSplit(org.apache.hadoop.hbase.client.TestAdmin): expected:&amp;lt;2&amp;gt; but was:&amp;lt;1&amp;gt;
  testForceSplitMultiFamily(org.apache.hadoop.hbase.client.TestAdmin): expected:&amp;lt;2&amp;gt; but was:&amp;lt;1&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I saw them in a clean 0.92 run.  I&apos;m working on fixing these elsewhere.&lt;/p&gt;</comment>
                            <comment id="13122225" author="stack" created="Thu, 6 Oct 2011 20:12:29 +0000"  >&lt;p&gt;Here is what I committed (Todd&apos;s work plus the little amendment).&lt;/p&gt;</comment>
                            <comment id="13122227" author="stack" created="Thu, 6 Oct 2011 20:12:56 +0000"  >&lt;p&gt;Applied to 0.92 branch and trunk.  Thanks Todd.&lt;/p&gt;</comment>
                            <comment id="13122364" author="hudson" created="Thu, 6 Oct 2011 22:32:53 +0000"  >&lt;p&gt;Integrated in HBase-0.92 #48 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92/48/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92/48/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4402&quot; title=&quot;Retaining locality after restart broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4402&quot;&gt;&lt;del&gt;HBASE-4402&lt;/del&gt;&lt;/a&gt; Retaining locality after restart broken&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/master/DefaultLoadBalancer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/master/TestDefaultLoadBalancer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15015721" author="lars_francke" created="Fri, 20 Nov 2015 11:52:20 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12498062" name="4402-v3.txt" size="8634" author="stack" created="Thu, 6 Oct 2011 20:12:28 +0000"/>
                            <attachment id="12494670" name="hbase-4402.txt" size="7745" author="tlipcon" created="Thu, 15 Sep 2011 18:24:40 +0000"/>
                            <attachment id="12494575" name="hbase-4402.txt" size="6760" author="tlipcon" created="Thu, 15 Sep 2011 06:44:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 15 Sep 2011 14:05:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27289</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hqq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101592</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>