<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:23:21 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-17305/HBASE-17305.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-17305] Two active HBase Masters can run at the same time under certain circumstances </title>
                <link>https://issues.apache.org/jira/browse/HBASE-17305</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;This needs a little more investigation, but we found a very edgy case when the active master is restarted and a stand-by master tries to become active, however the original active master was able to become the active master again and just before the standby master passed the point of the transition to become active we ended up with two active masters running at the same time. Assuming the clock on both masters were accurate to milliseconds, this race happened in less than 85ms. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13027867">HBASE-17305</key>
            <summary>Two active HBase Masters can run at the same time under certain circumstances </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="esteban">Esteban Gutierrez</assignee>
                                    <reporter username="esteban">Esteban Gutierrez</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Dec 2016 18:40:04 +0000</created>
                <updated>Thu, 15 Dec 2016 20:21:40 +0000</updated>
                                            <version>2.0.0</version>
                                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="15746506" author="qwertymaniac" created="Tue, 13 Dec 2016 22:42:36 +0000"  >&lt;p&gt;Note that its sorta possible to simulate this by forcing a deletion of znode. If the previous active master is pre-assignment phase, and the new active moves to assignment after the deletion, then both end up trying to assign over the cluster. The failure of one master only ever happens if log splitting is still involved (thanks to HDFS&apos; lease fencing).&lt;/p&gt;</comment>
                            <comment id="15746867" author="enis" created="Wed, 14 Dec 2016 01:29:46 +0000"  >&lt;p&gt;This is interesting. Did the previous active master lose the zookeeper connection, and reconnected? Or it is restarted? &lt;/p&gt;</comment>
                            <comment id="15752410" author="esteban" created="Thu, 15 Dec 2016 20:21:40 +0000"  >&lt;p&gt;Was a regular restart &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;. I&apos;m sure this is very rare. What I think is the culprit here is this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
blockUntilBecomingActiveMaster() {
...
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.clusterHasActiveMaster.set(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
...
&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = ZKUtil.getDataAndWatch(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.watcher, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.watcher.znodePaths.masterAddressZNode) &amp;lt;--- [0]
...
currentMaster = ProtobufUtil.parseServerNameFrom(bytes);
...
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ServerName.isSameHostnameAndPort(currentMaster, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sn)) { 
            msg = (&lt;span class=&quot;code-quote&quot;&gt;&quot;Current master has &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; master&apos;s address, &quot;&lt;/span&gt; +
              currentMaster + &lt;span class=&quot;code-quote&quot;&gt;&quot;; master was restarted? Deleting node.&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-comment&quot;&gt;// Hurry along the expiration of the znode.
&lt;/span&gt;            ZKUtil.deleteNode(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.watcher, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.watcher.znodePaths.masterAddressZNode); &amp;lt;--- [1]

            &lt;span class=&quot;code-comment&quot;&gt;// We may have failed to delete the znode at the previous step, but
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;//  we delete the file anyway: a second attempt to delete the znode is likely to fail again.
&lt;/span&gt;            ZNodeClearer.deleteMyEphemeralNodeOnDisk();
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think the problem lies between &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; when the old master thinks there was a restart and between &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; a backup master becomes active. As I mentioned this happened in a very short time, somewhere around 85ms but it could be less due clock jitter. &lt;/p&gt;

&lt;p&gt;One solution might be to update the znode instead of delete it when the there is a restart of the active master.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Dec 2016 22:42:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37jwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>