<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:51:31 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-14281/HBASE-14281.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-14281] ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray, part 2</title>
                <link>https://issues.apache.org/jira/browse/HBASE-14281</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Follow-on issue for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt;: CellComparator#getMinimumMidpointArray seems to have had a necessary change omitted and the patch only covered one of the two places diffIdx could overflow the short.&lt;/p&gt;

&lt;p&gt;For some background, we ran into the &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt; issue where a flush would cause a regionserver abort. After abort, the region in question would almost indefinitely sit in the FAILED_OPEN state. Applying the patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt; didn&apos;t solve the issue, but I noticed a comment in that issue which applied the same change in CellComparator#getMinimumMidpointArray, but the change was omitted from the attached patch.&lt;/p&gt;

&lt;p&gt;RS abort for reference:&lt;/p&gt;

&lt;p&gt;slave3.xxx.xxx.xxx,60020,1440131603772: Replay of WAL required. Forcing server shutdown&lt;br/&gt;
org.apache.hadoop.hbase.DroppedSnapshotException: region: deduplication,P\xDFt\x10\x053e73ceff5a2717d2ba76887ea21a2a8e353d1372\xFE,1438362391124.2bb6a602be6b1bfcea0508af4ba42235.&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegion.internalFlushCacheAndCommit(HRegion.java:2243)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegion.internalFlushcache(HRegion.java:1972)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegion.internalFlushcache(HRegion.java:1935)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegion.flushcache(HRegion.java:1833)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.MemStoreFlusher.flushRegion(MemStoreFlusher.java:452)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.MemStoreFlusher.flushRegion(MemStoreFlusher.java:413)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.MemStoreFlusher.access$800(MemStoreFlusher.java:70)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.MemStoreFlusher$FlushHandler.run(MemStoreFlusher.java:229)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
Caused by: java.lang.NegativeArraySizeException&lt;br/&gt;
at org.apache.hadoop.hbase.CellComparator.getMinimumMidpointArray(CellComparator.java:494)&lt;br/&gt;
at org.apache.hadoop.hbase.CellComparator.getMidpoint(CellComparator.java:448)&lt;br/&gt;
at org.apache.hadoop.hbase.io.hfile.HFileWriterV2.finishBlock(HFileWriterV2.java:165)&lt;br/&gt;
at org.apache.hadoop.hbase.io.hfile.HFileWriterV2.checkBlockBoundary(HFileWriterV2.java:146)&lt;br/&gt;
at org.apache.hadoop.hbase.io.hfile.HFileWriterV2.append(HFileWriterV2.java:263)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.StoreFile$Writer.append(StoreFile.java:949)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12857875">HBASE-14281</key>
            <summary>ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray, part 2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="xorlev">Michael Rose</assignee>
                                    <reporter username="xorlev">Michael Rose</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Aug 2015 15:16:15 +0000</created>
                <updated>Wed, 26 Aug 2015 00:43:10 +0000</updated>
                            <resolved>Tue, 25 Aug 2015 03:02:54 +0000</resolved>
                                    <version>1.0.0</version>
                    <version>1.0.1</version>
                    <version>1.0.2</version>
                                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="14706911" author="busbey" created="Fri, 21 Aug 2015 15:54:37 +0000"  >&lt;p&gt;thanks for filing this Michael. can you post up your additional fixes as a patch here?&lt;/p&gt;</comment>
                            <comment id="14706933" author="xorlev" created="Fri, 21 Aug 2015 16:12:28 +0000"  >&lt;p&gt;Patch submitted, has no supporting test cases yet. I&apos;ll look at what &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt; had and try to replicate it.&lt;/p&gt;</comment>
                            <comment id="14706943" author="yuzhihong@gmail.com" created="Fri, 21 Aug 2015 16:15:27 +0000"  >&lt;p&gt;I checked hbase-common/src/main/java/org/apache/hadoop/hbase/CellComparator.java in master where the patch no longer applies.&lt;/p&gt;

&lt;p&gt;For branch-1, diffIdx is declared as int already.&lt;/p&gt;</comment>
                            <comment id="14706951" author="xorlev" created="Fri, 21 Aug 2015 16:19:50 +0000"  >&lt;p&gt;Interesting, the blame says it landed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt;, but it wasn&apos;t in the patch for that issue. Apologies for not checking the branch first, I was working off 1.0.0.&lt;/p&gt;</comment>
                            <comment id="14706955" author="xorlev" created="Fri, 21 Aug 2015 16:22:55 +0000"  >&lt;p&gt;The specific change addressed by the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt; is not in branch-1 (short diffIdx, KeyValue.java L2367). Any concerns there?&lt;/p&gt;</comment>
                            <comment id="14706958" author="busbey" created="Fri, 21 Aug 2015 16:25:14 +0000"  >&lt;p&gt;if things aren&apos;t fixed in all branches, that&apos;s still a bug. If you name your patch HBASE-XXXXX-branch-foo.2.patch, then it will test against branch-foo. i.e.: &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14281&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray, part 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14281&quot;&gt;&lt;del&gt;HBASE-14281&lt;/del&gt;&lt;/a&gt;-branch-1.v2.patch, HBASE-142810-branch-1.0.v2.patch, etc.&lt;/p&gt;</comment>
                            <comment id="14706961" author="yuzhihong@gmail.com" created="Fri, 21 Aug 2015 16:26:31 +0000"  >&lt;p&gt;Interesting, that line led to the following JIRA:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9247&quot; title=&quot;Cleanup Key/KV/Meta/MetaKey Comparators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9247&quot;&gt;&lt;del&gt;HBASE-9247&lt;/del&gt;&lt;/a&gt; Cleanup Key/KV/Meta/MetaKey Comparators&lt;/p&gt;</comment>
                            <comment id="14707015" author="busbey" created="Fri, 21 Aug 2015 16:51:40 +0000"  >&lt;p&gt;KeyValue has the short diffIdx on all branch 0.98+.&lt;/p&gt;

&lt;p&gt;presumably the short is also a problem?&lt;/p&gt;</comment>
                            <comment id="14707018" author="xorlev" created="Fri, 21 Aug 2015 16:53:05 +0000"  >&lt;p&gt;It&apos;s unknown to me if the patch to change KeyValue to use ints is strictly necessary. Some quick poking around reveals KeyValue#getShortMidpointKey to be deprecated and only be used by KeyValue#calcIndexKey. calcIndexKey is unused in the HBase project @ 1.0.x, but both are public for external use. It&apos;d likely be desirable to update KeyValue#calcIndexKey to use CellComparator&apos;s code.&lt;/p&gt;</comment>
                            <comment id="14707167" author="hadoopqa" created="Fri, 21 Aug 2015 18:03:00 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12751746/14281-v1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12751746/14281-v1.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit bcef28eefaf192b0ad48c8011f98b8e944340da5.&lt;br/&gt;
  ATTACHMENT ID: 12751746&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/15202//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/15202//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14708575" author="lhofhansl" created="Sun, 23 Aug 2015 22:37:16 +0000"  >&lt;p&gt;This is the same stack track as in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt;. Did that change get reverted somehow?&lt;/p&gt;</comment>
                            <comment id="14708579" author="lhofhansl" created="Sun, 23 Aug 2015 22:46:43 +0000"  >&lt;p&gt;Can somebody clean up the confusion? I checked in branch-1 and trunk and the change (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt;) is there as expected. What&apos;s missing?&lt;/p&gt;

&lt;p&gt;Did you apply the trunk patch to 1.0? The attached patch is definitely already in branch-1. Hence my confusion.&lt;/p&gt;</comment>
                            <comment id="14708580" author="lhofhansl" created="Sun, 23 Aug 2015 22:48:03 +0000"  >&lt;p&gt;(not sure how it got assigned to me... assigned it back to Michael)&lt;/p&gt;</comment>
                            <comment id="14710489" author="xorlev" created="Tue, 25 Aug 2015 03:01:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; We can close this. My confusion came from &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt;, whose posted patch does not match what&apos;s in branch-1, however the change in branch-1 is the correct change. It was my mistake not checking the branch before opening this ticket.&lt;/p&gt;

&lt;p&gt;There still is the question if the original patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt; should be applied (change the midpoint code in KeyValue to use ints as well), but I think that can be addressed separately.&lt;/p&gt;</comment>
                            <comment id="14710490" author="xorlev" created="Tue, 25 Aug 2015 03:01:29 +0000"  >&lt;p&gt;Patch not necessary, applied. See comments for confusion.&lt;/p&gt;</comment>
                            <comment id="14710493" author="xorlev" created="Tue, 25 Aug 2015 03:02:54 +0000"  >&lt;p&gt;The issue &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt; set out to fix is fixed, this JIRA is a duplicate issue. The patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13329&quot; title=&quot;ArrayIndexOutOfBoundsException in CellComparator#getMinimumMidpointArray&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13329&quot;&gt;&lt;del&gt;HBASE-13329&lt;/del&gt;&lt;/a&gt; does not match what&apos;s in branch-1, however it the correct change.&lt;/p&gt;</comment>
                            <comment id="14712257" author="lhofhansl" created="Wed, 26 Aug 2015 00:43:10 +0000"  >&lt;p&gt;OK. Thanks for keeping us honest &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xorlev&quot; class=&quot;user-hover&quot; rel=&quot;xorlev&quot;&gt;Michael Rose&lt;/a&gt;. Much better to file an issue and then close it than leaving a bug in HBase &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12785274">HBASE-13329</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12751746" name="14281-v1.patch" size="795" author="xorlev" created="Fri, 21 Aug 2015 16:11:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 21 Aug 2015 15:54:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 16 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2j7rj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>