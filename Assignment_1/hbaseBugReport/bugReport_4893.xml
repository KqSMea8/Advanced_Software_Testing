<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:22:57 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4893/HBASE-4893.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4893] HConnectionImplementation is closed but not deleted</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4893</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In abort() of HConnectionManager$HConnectionImplementation, instance of HConnectionImplementation is marked as this.closed=true.&lt;/p&gt;

&lt;p&gt;There is no way for client application to check the hbase client connection whether it is still opened/good (this.closed=false) or not. We need a method to validate the state of a connection like isClosed().&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isClosed(){
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.closed;
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once the connection is closed and it should get deleted. Client application still gets a connection from HConnectionManager.getConnection(Configuration) and tries to make a RPC call to RS, since connection is already closed, HConnectionImplementation.getRegionServerWithRetries throws RetriesExhaustedException with error message&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: org.apache.hadoop.hbase.client.RetriesExhaustedException: Trying to contact region server &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region , row &apos;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxx&apos;, but failed after 10 attempts.
Exceptions:
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
java.io.IOException: org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation@7eab48a7 closed
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getRegionServerWithRetries(HConnectionManager.java:1008)
	at org.apache.hadoop.hbase.client.HTable.get(HTable.java:546)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Linux 2.6, HBase-0.90.1&lt;/p&gt;</environment>
        <key id="12533181">HBASE-4893</key>
            <summary>HConnectionImplementation is closed but not deleted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mubarakseyed">Mubarak Seyed</assignee>
                                    <reporter username="mubarakseyed">Mubarak Seyed</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Nov 2011 19:45:00 +0000</created>
                <updated>Fri, 20 Nov 2015 11:52:27 +0000</updated>
                            <resolved>Thu, 26 Jan 2012 07:27:59 +0000</resolved>
                                    <version>0.90.1</version>
                                    <fixVersion>0.90.6</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13159533" author="stack" created="Tue, 29 Nov 2011 20:45:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4805&quot; title=&quot;Allow better control of resource consumption in HTable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4805&quot;&gt;&lt;del&gt;HBASE-4805&lt;/del&gt;&lt;/a&gt; added HConnection.isClosed.  &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4805&quot; title=&quot;Allow better control of resource consumption in HTable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4805&quot;&gt;&lt;del&gt;HBASE-4805&lt;/del&gt;&lt;/a&gt; was committed to 0.92 and to TRUNK.  Does that work for you Mubarak?  If so, can we close this issue as duplicate?  Thanks.&lt;/p&gt;</comment>
                            <comment id="13159605" author="mubarakseyed" created="Tue, 29 Nov 2011 22:52:47 +0000"  >&lt;p&gt;Stack,&lt;/p&gt;

&lt;p&gt;How about delete the HConnectionImplementation instance from HBASE_INSTANCES map if HConnectionImplementation instance is in closed state. When application uses connection pool and if the HConnection is closed, it can check the isClosed() and tries to create a new HTable(), which in turn gets the connection from HConnectionManager.getConnection(conf), which is a stale connection (meaning the connection state is closed).&lt;/p&gt;

&lt;p&gt;In abort() of HConnectionManager$HConnectionImplementation, when we mark this.closed=true, can&apos;t we clean-up the HConnectionImplementation instance for a configuration in HBASE_INSTANCES map so that HConnectionManager.getConnection(conf) creates a new instance of HConnectionImplementation with new ZK connection (to ZK ensemble).&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Mubarak&lt;/p&gt;</comment>
                            <comment id="13159613" author="yuzhihong@gmail.com" created="Tue, 29 Nov 2011 23:00:42 +0000"  >&lt;p&gt;HConnectionManager.deleteStaleConnection() can be utilized in the above proposal.&lt;/p&gt;</comment>
                            <comment id="13164090" author="mubarakseyed" created="Wed, 7 Dec 2011 02:51:32 +0000"  >&lt;p&gt;HConnectionManager.deleteStaleConnection() is part of 0.92 but i would like to fix it in 0.90.5. Can we back-port deleteStaleConnection() to 0.90.5?&lt;br/&gt;
If i use HConnectionManager.deleteConnection(connection, true) in 0.90.5, it is not going to clean-up the stale connection unless connection.isZeroReference() == true but it is not as getConnection(Conf) increments the count &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; HConnection getConnection(Configuration conf)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ZooKeeperConnectionException {
    HConnectionKey connectionKey = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HConnectionKey(conf);
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (HBASE_INSTANCES) {
      ..
      connection.incCount();
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; connection;
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We need the following methods in 0.90.5 &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void deleteStaleConnection(HConnection connection) {
    deleteConnection(connection, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
  }

 &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void deleteConnection(HConnection connection, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; stopProxy,
      &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; staleConnection) {
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (HBASE_INSTANCES) {
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Entry&amp;lt;HConnectionKey, HConnectionImplementation&amp;gt; connectionEntry : HBASE_INSTANCES
          .entrySet()) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connectionEntry.getValue() == connection) {
          deleteConnection(connectionEntry.getKey(), stopProxy, staleConnection);
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
      }
    }
  }

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void deleteConnection(HConnectionKey connectionKey,
      &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; stopProxy, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; staleConnection) {
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (HBASE_INSTANCES) {
      HConnectionImplementation connection = HBASE_INSTANCES
          .get(connectionKey);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connection != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        connection.decCount();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connection.isZeroReference() || staleConnection) {
          HBASE_INSTANCES.remove(connectionKey);
          connection.close(stopProxy);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stopProxy) {
          connection.stopProxyOnClose(stopProxy);
        }
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and deleteConnection(conf, stopProxy) needs to call deleteConnection(new HConnectionKey(conf), stopProxy, false)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void deleteConnection(Configuration conf, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; stopProxy) {
    deleteConnection(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HConnectionKey(conf), stopProxy, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13164111" author="mubarakseyed" created="Wed, 7 Dec 2011 03:37:36 +0000"  >&lt;p&gt;Waiting for corporate approval to contribute this patch. Thanks.&lt;/p&gt;</comment>
                            <comment id="13169915" author="mubarakseyed" created="Thu, 15 Dec 2011 01:59:26 +0000"  >&lt;p&gt;The attached file &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4893&quot; title=&quot;HConnectionImplementation is closed but not deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4893&quot;&gt;&lt;del&gt;HBASE-4893&lt;/del&gt;&lt;/a&gt;.v1.patch is a patch&lt;/p&gt;</comment>
                            <comment id="13169968" author="stack" created="Thu, 15 Dec 2011 05:01:09 +0000"  >&lt;p&gt;That looks fine Mubarak.  Do all tests pass in 0.90?  This is for 0.90 only?&lt;/p&gt;</comment>
                            <comment id="13170029" author="mubarakseyed" created="Thu, 15 Dec 2011 08:33:24 +0000"  >&lt;p&gt;Yup, all tests were passed in 0.90.5. This is for 0.90.5. Thanks.&lt;/p&gt;</comment>
                            <comment id="13170387" author="zhihyu@ebaysf.com" created="Thu, 15 Dec 2011 18:24:38 +0000"  >&lt;p&gt;One minor question about the patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
       &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; LOG.fatal(msg);
-      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.closed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+      HConnectionManager.deleteStaleConnection(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Why do we need to remove the assignment to this.closed ?&lt;/p&gt;

&lt;p&gt;Please use appropriate command to generate patch, such as &apos;svn diff&apos;&lt;br/&gt;
The current patch cannot be applied at the root of source tree.&lt;/p&gt;

&lt;p&gt;Good work Mubarak.&lt;/p&gt;</comment>
                            <comment id="13170441" author="mubarakseyed" created="Thu, 15 Dec 2011 19:40:09 +0000"  >&lt;p&gt;If we keep this.closed=true, after removing the key from HBASE_INSTANCES map, connection.close(stopProxy) is getting called, since it is already marked as closed, close(stopProxy) will not stop the proxy for Master/RS and will not close the ZK connection.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
void close(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; stopProxy) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.closed) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }
      ..
      ..
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Will submit a patch.&lt;/p&gt;</comment>
                            <comment id="13170443" author="zhihyu@ebaysf.com" created="Thu, 15 Dec 2011 19:48:12 +0000"  >&lt;p&gt;Thanks for the explanation.&lt;/p&gt;

&lt;p&gt;In that case, I think the assignment should be moved to after HConnectionManager.deleteStaleConnection() call.&lt;/p&gt;</comment>
                            <comment id="13170472" author="mubarakseyed" created="Thu, 15 Dec 2011 20:25:24 +0000"  >&lt;p&gt;close(boolean stopProxy) already sets this.closed=true. close(stopProxy) will be called after removing the key from HBASE_INSTANCES map.&lt;/p&gt;</comment>
                            <comment id="13170477" author="zhihyu@ebaysf.com" created="Thu, 15 Dec 2011 20:30:48 +0000"  >&lt;p&gt;Should have read the code further &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Will integrate the new patch.&lt;/p&gt;</comment>
                            <comment id="13170479" author="mubarakseyed" created="Thu, 15 Dec 2011 20:36:43 +0000"  >&lt;p&gt;The attached file &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4893&quot; title=&quot;HConnectionImplementation is closed but not deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4893&quot;&gt;&lt;del&gt;HBASE-4893&lt;/del&gt;&lt;/a&gt;.v2.patch is an updated patch (generated from root of the source)&lt;/p&gt;</comment>
                            <comment id="13170488" author="zhihyu@ebaysf.com" created="Thu, 15 Dec 2011 21:07:37 +0000"  >&lt;p&gt;Integrated patch v2 to 0.90&lt;br/&gt;
It should be in 0.90.6 because 0.90.5 RC has been cut.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Mubarak.&lt;/p&gt;

&lt;p&gt;Thanks for the review Stack.&lt;/p&gt;</comment>
                            <comment id="13170493" author="mubarakseyed" created="Thu, 15 Dec 2011 21:16:17 +0000"  >&lt;p&gt;Thanks Zhihong Yu. One basic question: Do i need to merge the fix into 0.92? Thanks.&lt;/p&gt;</comment>
                            <comment id="13170499" author="zhihyu@ebaysf.com" created="Thu, 15 Dec 2011 21:24:29 +0000"  >&lt;p&gt;Patch for 0.92 is welcome.&lt;/p&gt;</comment>
                            <comment id="13193615" author="ram_krish" created="Thu, 26 Jan 2012 07:27:59 +0000"  >&lt;p&gt;Resolving the issue&lt;/p&gt;</comment>
                            <comment id="15015751" author="lars_francke" created="Fri, 20 Nov 2015 11:52:27 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12539964">HBASE-5289</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12507467" name="HBASE-4893.v1.patch" size="3008" author="mubarakseyed" created="Thu, 15 Dec 2011 01:59:26 +0000"/>
                            <attachment id="12507585" name="HBASE-4893.v2.patch" size="3143" author="mubarakseyed" created="Thu, 15 Dec 2011 20:36:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 29 Nov 2011 20:45:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>218909</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i06a73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34583</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>