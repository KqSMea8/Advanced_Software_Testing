<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:23:48 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4993/HBASE-4993.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4993] Performance regression in minicluster creation</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4993</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Side effect of 4610: the mini cluster needs 4,5 seconds to start&lt;/p&gt;</description>
                <environment>&lt;p&gt;all&lt;/p&gt;</environment>
        <key id="12534510">HBASE-4993</key>
            <summary>Performance regression in minicluster creation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkeywal">Nicolas Liochon</assignee>
                                    <reporter username="nkeywal">Nicolas Liochon</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Dec 2011 17:35:17 +0000</created>
                <updated>Fri, 12 Oct 2012 05:35:06 +0000</updated>
                            <resolved>Wed, 14 Dec 2011 19:39:51 +0000</resolved>
                                    <version>0.94.0</version>
                                    <fixVersion>0.94.0</fixVersion>
                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13166726" author="nkeywal" created="Sat, 10 Dec 2011 01:17:28 +0000"  >&lt;p&gt;That&apos;s the v1. There is still the timeout issue in it. If I don&apos;t have an answer in hbase-4610 tomorrow, I will provide a v2 with a real timeout, but it will make the behavior very different from the current one.&lt;/p&gt;</comment>
                            <comment id="13166774" author="hadoopqa" created="Sat, 10 Dec 2011 03:28:55 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12506817/4993.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12506817/4993.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -160 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 75 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.master.TestMasterFailover&lt;br/&gt;
                  org.apache.hadoop.hbase.client.TestAdmin&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/483//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/483//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/483//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/483//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/483//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/483//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13168371" author="hadoopqa" created="Tue, 13 Dec 2011 13:25:51 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12507169/4993.v3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12507169/4993.v3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -152 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 75 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.client.TestAdmin&lt;br/&gt;
                  org.apache.hadoop.hbase.client.TestInstantSchemaChange&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/497//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/497//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/497//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/497//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/497//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/497//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13168374" author="nkeywal" created="Tue, 13 Dec 2011 13:34:35 +0000"  >&lt;p&gt;Errors are hadoop-qa related, usual &quot;Too many open files&quot;&lt;br/&gt;
client.TestAdmin#testCheckHBaseAvailableClosesConnection: 559 threads (was 293), 1016 file descriptors (was 478).&lt;/p&gt;

&lt;p&gt;java.io.FileNotFoundException: /home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/trunk/target/test-data/41fdcdb6-e088-480d-b131-18b5ad56356b/dfscluster_822e8789-caad-4a9f-a090-44b5e9e28fc8/dfs/data/data5/blocksBeingWritten/blk_-3873967043651795350_1007.meta (Too many open files)  &lt;br/&gt;
client.TestInstantSchemaChange#testInstantSchemaJanitor: 343 threads (was 120), 874 file descriptors (was 598).&lt;/p&gt;


&lt;p&gt;Can be committed imho.&lt;/p&gt;</comment>
                            <comment id="13168653" author="zhihyu@ebaysf.com" created="Tue, 13 Dec 2011 19:47:25 +0000"  >&lt;p&gt;13 minutes after TestAdmin started to run, it seemed to hang:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; prio=5 tid=104000800 nid=0x100601000 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [1005fe000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:485)
	at org.apache.zookeeper.ClientCnxn.submitRequest(ClientCnxn.java:1259)
	- locked &amp;lt;78448ef88&amp;gt; (a org.apache.zookeeper.ClientCnxn$Packet)
	at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:998)
	at org.apache.hadoop.hbase.zookeeper.RecoverableZooKeeper.exists(RecoverableZooKeeper.java:154)
	at org.apache.hadoop.hbase.zookeeper.ZKUtil.watchAndCheckExists(ZKUtil.java:229)
	at org.apache.hadoop.hbase.zookeeper.ZooKeeperNodeTracker.start(ZooKeeperNodeTracker.java:76)
	- locked &amp;lt;78448ee80&amp;gt; (a org.apache.hadoop.hbase.MasterAddressTracker)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.setupZookeeperTrackers(HConnectionManager.java:579)
	- locked &amp;lt;784467418&amp;gt; (a org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.&amp;lt;init&amp;gt;(HConnectionManager.java:568)
	at org.apache.hadoop.hbase.client.HConnectionManager.getConnection(HConnectionManager.java:185)
	- locked &amp;lt;790cd5d10&amp;gt; (a org.apache.hadoop.hbase.client.HConnectionManager$1)
	at org.apache.hadoop.hbase.client.HBaseAdmin.&amp;lt;init&amp;gt;(HBaseAdmin.java:98)
	at org.apache.hadoop.hbase.client.HBaseAdmin.checkHBaseAvailable(HBaseAdmin.java:1534)
	at org.apache.hadoop.hbase.client.TestAdmin.testCheckHBaseAvailableClosesConnection(TestAdmin.java:1485)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I ran the test on MacBook:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Darwin LM-SJN-00713032 10.8.0 Darwin Kernel Version 10.8.0: Tue Jun  7 16:32:41 PDT 2011; root:xnu-1504.15.3~1/RELEASE_X86_64 x86_64
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13168676" author="nkeywal" created="Tue, 13 Dec 2011 20:14:41 +0000"  >&lt;p&gt;I&apos;ve retested it. Executed 5 times here, worked 4 times, failed once.&lt;br/&gt;
I doubt it&apos;s related to this patch, the changes in 4993 should have no impact on it.&lt;/p&gt;</comment>
                            <comment id="13168802" author="zhihyu@ebaysf.com" created="Tue, 13 Dec 2011 22:42:01 +0000"  >&lt;p&gt;Attempt of running TestAdmin timed out the second time:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[INFO] Total time: 15:12.890s
[INFO] Finished at: Tue Dec 13 14:00:06 PST 2011
[INFO] Final Memory: 22M/120M
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.10:test (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-test) on project hbase: Failure or timeout -&amp;gt; [Help 1]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13168882" author="zhihyu@ebaysf.com" created="Tue, 13 Dec 2011 23:44:47 +0000"  >&lt;p&gt;testCheckHBaseAvailableClosesConnection hangs without this patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13169106" author="stack" created="Wed, 14 Dec 2011 06:15:44 +0000"  >&lt;p&gt;Something wrong w/ that test.  It loops 1000 times and each loop takes a couple of seconds.  Either test was dumb in first place or something changed to slow it down (I was thinking it was the cloning of Configuration added below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void checkHBaseAvailable(Configuration conf)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MasterNotRunningException, ZooKeeperConnectionException {
    Configuration copyOfConf = HBaseConfiguration.create(conf);
    copyOfConf.setInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.client.retries.number&quot;&lt;/span&gt;, 1);
    HBaseAdmin admin = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HBaseAdmin(copyOfConf);
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      admin.close();
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ioe) {
      admin.LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to close connection&quot;&lt;/span&gt;, ioe);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;... but it doesn&apos;t seem so (I tried changing it).  I think we should either figure what slowed this down or punt it over to IntegrationTests because it takes too long for unit tests.&lt;/p&gt;
</comment>
                            <comment id="13169109" author="stack" created="Wed, 14 Dec 2011 06:23:13 +0000"  >&lt;p&gt;I take it back.  It is the above change that causes this test to fail.  If I do not clone, then the test runs to completion in a couple of seconds otherwise its a couple of seconds per time through the loop.&lt;/p&gt;</comment>
                            <comment id="13169115" author="stack" created="Wed, 14 Dec 2011 06:42:27 +0000"  >&lt;p&gt;TestAdmin passes if you do something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java b/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java
index 6bff130..1189696 100644
--- a/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java
+++ b/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java
@@ -1529,9 +1529,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class HBaseAdmin &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Abortable, Closeable {
    */
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void checkHBaseAvailable(Configuration conf)
   &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MasterNotRunningException, ZooKeeperConnectionException {
-    Configuration copyOfConf = HBaseConfiguration.create(conf);
-    copyOfConf.setInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.client.retries.number&quot;&lt;/span&gt;, 1);
-    HBaseAdmin admin = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HBaseAdmin(copyOfConf);
+    &lt;span class=&quot;code-comment&quot;&gt;// Configuration copyOfConf = HBaseConfiguration.create(conf);
&lt;/span&gt;+    &lt;span class=&quot;code-comment&quot;&gt;// copyOfConf.setInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.client.retries.number&quot;&lt;/span&gt;, 1);
&lt;/span&gt;+    HBaseAdmin admin = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HBaseAdmin(conf);
     &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
       admin.close();
     } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ioe) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13169186" author="nkeywal" created="Wed, 14 Dec 2011 08:36:47 +0000"  >&lt;p&gt;HBase#Configuration is expensive by nature, see the comment in @return.&lt;/p&gt;

&lt;p&gt;As well the two comments are not saying the same thing: &quot;Creates a clone&quot; is not &quot;reloading the xml file and adding the given conf&quot;.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  /**
   * Creates a clone of passed configuration.
   * @param that Configuration to clone.
   * @return a Configuration created with the hbase-*.xml files plus
   * the given configuration.
   */
  public static Configuration create(final Configuration that) {
    Configuration conf = create(); // this loads the xml files
    merge(conf, that); // for every entry in &apos;that&apos;, replace the content of &apos;conf&apos; by the content of &apos;that&apos;
    return conf;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To  be compared with a call to clone as implemented in Configuration&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public static Configuration create(final Configuration that) {
  new Configuration(that);
return conf;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When I replace the former by the later, the tests is 3 times faster.&lt;/p&gt;

&lt;p&gt;We can either:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;remove the function&lt;/li&gt;
	&lt;li&gt;replace the former implementation with the one mentioned above&lt;/li&gt;
	&lt;li&gt;keep the function, add a performance warning, and replace the calls to this function by a call to the Configuration constructor.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m going to check the tests results on option 2.&lt;/p&gt;





</comment>
                            <comment id="13169526" author="nkeywal" created="Wed, 14 Dec 2011 17:45:10 +0000"  >&lt;p&gt;@ted, stack;&lt;br/&gt;
Can be committed imho, it seems we all agree that the TestAdmin issues are not linked to this patch&lt;/p&gt;</comment>
                            <comment id="13169565" author="zhihyu@ebaysf.com" created="Wed, 14 Dec 2011 18:28:55 +0000"  >&lt;p&gt;What about Stack&apos;s proposed changes @ 14/Dec/11 06:42 ?&lt;/p&gt;</comment>
                            <comment id="13169572" author="nkeywal" created="Wed, 14 Dec 2011 18:41:22 +0000"  >&lt;p&gt;It not really related to the patch, but to TestAdmin flakiness, so it can be done separately. Note that I still have random failures with 5022, I am not sure if removing the clone will change so much. I will try.&lt;/p&gt;</comment>
                            <comment id="13169584" author="stack" created="Wed, 14 Dec 2011 18:58:51 +0000"  >&lt;p&gt;So yeah, HBaseConfiguration#create(Configuration) should be deprecated?  And replaced by a clone method that does return new Configuration(conf)?  Will a cloned Configuration have same identity &amp;#8211; connection key &amp;#8211; when it comes to connections (see HConnectionManager#getConnection)?  Do we want that?  Should it have a new identity?  I opened hbase-5027 to address this.&lt;/p&gt;

&lt;p&gt;Meantime let me apply this patch.&lt;/p&gt;</comment>
                            <comment id="13169585" author="nkeywal" created="Wed, 14 Dec 2011 18:59:14 +0000"  >&lt;p&gt;Test done:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it&apos;s much much faster if we remove the clone, even after hbase-5022 (3 times faster)&lt;/li&gt;
	&lt;li&gt;the time is now constant, while I have a lot of variation when I keep the clone&lt;/li&gt;
	&lt;li&gt;it still fails sometimes (1 out 5).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13169619" author="stack" created="Wed, 14 Dec 2011 19:39:51 +0000"  >&lt;p&gt;Committed to TRUNK.  Thanks for patch Nicolas.&lt;/p&gt;</comment>
                            <comment id="13169929" author="hudson" created="Thu, 15 Dec 2011 02:23:17 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2545 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2545/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2545/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4993&quot; title=&quot;Performance regression in minicluster creation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4993&quot;&gt;&lt;del&gt;HBASE-4993&lt;/del&gt;&lt;/a&gt; Performance regression in minicluster creation&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/resources/hbase-site.xml&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13170136" author="hudson" created="Thu, 15 Dec 2011 11:47:05 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-security #32 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-security/32/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-security/32/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4993&quot; title=&quot;Performance regression in minicluster creation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4993&quot;&gt;&lt;del&gt;HBASE-4993&lt;/del&gt;&lt;/a&gt; Performance regression in minicluster creation&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/resources/hbase-site.xml&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13237196" author="jdcryans" created="Fri, 23 Mar 2012 22:07:01 +0000"  >&lt;p&gt;@Nic&lt;/p&gt;

&lt;p&gt;I think a bug was introduced here. Here&apos;s the new waiting logic in waitForRegionServers:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
- the &apos;hbase.master.wait.on.regionservers.mintostart&apos; is reached AND
   there have been no &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; region server in &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
      &apos;hbase.master.wait.on.regionservers.interval&apos; time
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the code that verifies that:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  !(lastCountChange+interval &amp;gt; now &amp;amp;&amp;amp; count &amp;gt;= minToStart)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you have 0 region servers that checked in and you are under the interval, you wait: not (true and false) = true.&lt;br/&gt;
If you have 0 region servers but you are above the interval, you wait: not (false and false) = true.&lt;br/&gt;
If you have 1 or more region servers that checked in and you are under the interval, you continue: not (true and true) = false.&lt;/p&gt;

&lt;p&gt;Here&apos;s an example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-03-23 21:45:22,002 INFO org.apache.hadoop.hbase.master.ServerManager: Waiting for region servers count to settle; currently checked in 0, slept for 0 ms, expecting minimum of 1, maximum of 2147483647, timeout of 4500 ms, interval of 1500 ms.
2012-03-23 21:45:22,882 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r27s44,62023,1332539122398
2012-03-23 21:45:22,883 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r29s44,62023,1332539122438
2012-03-23 21:45:22,883 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r25s44,62023,1332539122404
2012-03-23 21:45:22,885 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r6s38,62023,1332539122354
2012-03-23 21:45:22,885 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r8s38,62023,1332539122396
2012-03-23 21:45:22,886 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r5s38,62023,1332539122427
2012-03-23 21:45:22,886 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r28s44,62023,1332539122402
2012-03-23 21:45:22,887 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r31s44,62023,1332539122387
2012-03-23 21:45:22,887 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=sv4r30s44,62023,1332539122392
2012-03-23 21:45:22,906 INFO org.apache.hadoop.hbase.master.ServerManager: Finished waiting for region servers count to settle; checked in 9, slept for 904 ms, expecting minimum of 1, maximum of 2147483647, master is running.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see we haven&apos;t waited a second and the master is proceeding. This is here not too bad because in the cluster I have 9 servers, but the first time I ran 0.94 it proceeded with only 1 server. This could be disastrous at scale, we really need to wait more than that here. In fact I think I preferred the old way of doing it.&lt;/p&gt;</comment>
                            <comment id="13237342" author="nkeywal" created="Sat, 24 Mar 2012 00:27:23 +0000"  >&lt;p&gt;Hi JD,&lt;/p&gt;

&lt;p&gt;You&apos;re right, there is a bug. The code does not do what the documentation&lt;br/&gt;
says it does.&lt;br/&gt;
It seems that changing the code to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; (count &amp;lt; minToStart ||
lastCountChange+interval &amp;gt; now)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; would make the code works as&lt;br/&gt;
documented.&lt;/p&gt;

&lt;p&gt;If you have 0 region servers that checked in and you are under the&lt;br/&gt;
interval, you wait: (true or true) = true.&lt;br/&gt;
If you have 0 region servers but you are above the interval, you wait:&lt;br/&gt;
(true or false) = true.&lt;br/&gt;
If you have 1 or more region servers that checked in and you are under the&lt;br/&gt;
interval, you wait: (false or true) = true.&lt;/p&gt;

&lt;p&gt;Would that be ok for you, or do you want to change the documented behavior&lt;br/&gt;
as well?&lt;br/&gt;
Note that we could also change the default values for the min number of&lt;br/&gt;
servers or the interval.&lt;/p&gt;

&lt;p&gt;On Fri, Mar 23, 2012 at 11:07 PM, Jean-Daniel Cryans (Commented) (JIRA) &amp;lt;&lt;/p&gt;
</comment>
                            <comment id="13238962" author="jdcryans" created="Mon, 26 Mar 2012 23:11:34 +0000"  >&lt;p&gt;It seems this would work better, also reviewing the 0.90/0.92 code it think we should keep the new logic you introduced in this jira (with the fixed code). I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5639&quot; title=&quot;The logic used in waiting for region servers during startup is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5639&quot;&gt;&lt;del&gt;HBASE-5639&lt;/del&gt;&lt;/a&gt; and assigned it to you.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12527521">HBASE-4610</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12535128">HBASE-5022</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12527439">HBASE-4602</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12506817" name="4993.patch" size="4290" author="nkeywal" created="Sat, 10 Dec 2011 01:15:29 +0000"/>
                            <attachment id="12507169" name="4993.v3.patch" size="6747" author="nkeywal" created="Tue, 13 Dec 2011 11:10:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 10 Dec 2011 03:28:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>220232</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 38 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i06a1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>