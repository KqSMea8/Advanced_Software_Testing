<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:26:03 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11729/HBASE-11729.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11729] Document HFile v3</title>
                <link>https://issues.apache.org/jira/browse/HBASE-11729</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;0.98 added HFile v3. There are a couple of mentions of it in the book on the sections on cell tags, but there isn&apos;t an actual overview or design explanation like there is for &lt;a href=&quot;http://hbase.apache.org/book/hfilev2.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HFile v2&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12733778">HBASE-11729</key>
            <summary>Document HFile v3</summary>
                <type id="3" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/task.png">Task</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="busbey">Sean Busbey</assignee>
                                    <reporter username="busbey">Sean Busbey</reporter>
                        <labels>
                            <label>beginner</label>
                    </labels>
                <created>Wed, 13 Aug 2014 14:41:04 +0000</created>
                <updated>Mon, 25 Aug 2014 22:23:36 +0000</updated>
                            <resolved>Mon, 25 Aug 2014 19:13:01 +0000</resolved>
                                    <version>0.98.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>documentation</component>
                    <component>HFile</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                <comments>
                            <comment id="14095609" author="anoop.hbase" created="Wed, 13 Aug 2014 15:42:02 +0000"  >&lt;p&gt;There is min change from V2 to V3. There is no layout change or so. Along with every KV, the tags part will come extra.&lt;br/&gt;
HFile V2 -  KeyLength  ValueLength  Key  Value&lt;br/&gt;
HFile V3 -  KeyLength  ValueLength  Key  Value  TagsLength  Tags&lt;br/&gt;
Even if there are no tags, a 0 tags length will have to be written.&lt;br/&gt;
Tags length will be stored with 2 bytes.&lt;/p&gt;

&lt;p&gt;+1 for documenting.&lt;/p&gt;</comment>
                            <comment id="14095667" author="apurtell" created="Wed, 13 Aug 2014 16:22:07 +0000"  >&lt;p&gt;HFile V3 needs only a paragraph or two enumerating Anoop&apos;s items above.&lt;/p&gt;</comment>
                            <comment id="14095924" author="ram_krish" created="Wed, 13 Aug 2014 18:51:40 +0000"  >&lt;p&gt;+1 and thanks for raising this.  We plan to raise JIRAs for documenting other items based on HFile V3 and see enhance the existing documentation where ever needed.&lt;/p&gt;</comment>
                            <comment id="14095936" author="apurtell" created="Wed, 13 Aug 2014 18:59:31 +0000"  >&lt;p&gt;Almost forgot: We also introduce in V3 a optional field in the FixedFileTrailer containing the wrapped data encryption key for the file. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
optional bytes encryption_key = 13;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14095952" author="busbey" created="Wed, 13 Aug 2014 19:10:04 +0000"  >&lt;p&gt;The above V2 to V3 change is in how Data Blocks store cells, correct?&lt;/p&gt;

&lt;p&gt;We don&apos;t have any description of Data Blocks currently. How about I document the change in a section on v3 and just refer people to &lt;a href=&quot;http://www.larsgeorge.com/2009/10/hbase-architecture-101-storage.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Lars&apos; HBase storage 101 blog post on the V1 version of data blocks&lt;/a&gt;? Then if we expand the overall HFile documentation later we can update it to point internally.&lt;/p&gt;</comment>
                            <comment id="14096525" author="busbey" created="Thu, 14 Aug 2014 03:53:35 +0000"  >&lt;p&gt;Initial draft.&lt;/p&gt;

&lt;p&gt;Unfortunately, the hfile appendix was in hte main book.xml. Since that&apos;s so over burdened (6k lines), I took the opportunity to break it out into its own file.&lt;/p&gt;

&lt;p&gt;I didn&apos;t fix the formatting on parts of the text that I wasn&apos;t changing, but I could do that as well if folks would like.&lt;/p&gt;</comment>
                            <comment id="14096536" author="busbey" created="Thu, 14 Aug 2014 04:12:36 +0000"  >&lt;p&gt;attaching review board for changes, since the changeset is so large.&lt;/p&gt;

&lt;p&gt;Mind taking a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=misty&quot; class=&quot;user-hover&quot; rel=&quot;misty&quot;&gt;Misty Stanley-Jones&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14096550" author="misty" created="Thu, 14 Aug 2014 04:34:24 +0000"  >&lt;p&gt;+1 from me, of course someone else should check the technical bits.&lt;/p&gt;</comment>
                            <comment id="14096703" author="hadoopqa" created="Thu, 14 Aug 2014 07:40:44 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12661625/HBASE-11729.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12661625/HBASE-11729.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12661625&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+0 tests included&lt;/font&gt;.  The patch appears to be a documentation patch that doesn&apos;t require tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 lineLengths&lt;/font&gt;.  The patch introduces the following lines longer than 100:&lt;br/&gt;
    +    &amp;lt;para&amp;gt;As we will be discussing changes to the HFile format, it is useful to give a short overview of the original (HFile version 1) format.&amp;lt;/para&amp;gt;&lt;br/&gt;
+           &amp;lt;footnote&amp;gt;&amp;lt;para&amp;gt;Image courtesy of Lars George, &amp;lt;link xlink:href=&quot;http://www.larsgeorge.com/2009/10/hbase-architecture-101-storage.html&quot;&amp;gt;hbase-architecture-101-storage.html&amp;lt;/link&amp;gt;.&amp;lt;/para&amp;gt;&amp;lt;/footnote&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;The number of entries in the block index is stored in the fixed file trailer, and has to be passed in to the method that reads the block index. One of the limitations of the block index in version 1 is that it does not provide the compressed size of a block, which turns out to be necessary for decompression. Therefore, the HFile reader has to infer this compressed size from the offset difference between blocks. We fix this limitation in version 2, where we store on-disk block size instead of uncompressed size, and get uncompressed size from the block header.&amp;lt;/para&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;We found it necessary to revise the HFile format after encountering high memory usage and slow startup times caused by large Bloom filters and block indexes in the region server. Bloom filters can get as large as 100 MB per HFile, which adds up to 2 GB when aggregated over 20 regions. Block indexes can grow as large as 6 GB in aggregate size over the same set of regions. A region is not considered opened until all of its block index data is loaded. Large Bloom filters produce a different performance problem: the first get request that requires a Bloom filter lookup will incur the latency of loading the entire Bloom filter bit array.&amp;lt;/para&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;To speed up region server startup we break Bloom filters and block indexes into multiple blocks and write those blocks out as they fill up, which also reduces the HFile writer&#65533;&#65533;&#65533;s memory footprint. In the Bloom filter case, &#65533;&#65533;&#65533;filling up a block&#65533;&#65533;&#65533; means accumulating enough keys to efficiently utilize a fixed-size bit array, and in the block index case we accumulate an &#65533;&#65533;&#65533;index block&#65533;&#65533;&#65533; of the desired size. Bloom filter blocks and index blocks (we call these &#65533;&#65533;&#65533;inline blocks&#65533;&#65533;&#65533;) become interspersed with data blocks, and as a side effect we can no longer rely on the difference between block offsets to determine data block length, as it was done in version 1.&amp;lt;/para&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;HFile is a low-level file format by design, and it should not deal with application-specific details such as Bloom filters, which are handled at StoreFile level. Therefore, we call Bloom filter blocks in an HFile &quot;inline&quot; blocks. We also supply HFile with an interface to write those inline blocks. &amp;lt;/para&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;Another format modification aimed at reducing the region server startup time is to use a contiguous &#65533;&#65533;&#65533;load-on-open&#65533;&#65533;&#65533; section that has to be loaded in memory at the time an HFile is being opened. Currently, as an HFile opens, there are separate seek operations to read the trailer, data/meta indexes, and file info. To read the Bloom filter, there are two more seek operations for its &#65533;&#65533;&#65533;data&#65533;&#65533;&#65533; and &#65533;&#65533;&#65533;meta&#65533;&#65533;&#65533; portions. In version 2, we seek once to read the trailer and seek again to read everything else we need to open the file from a contiguous block.&amp;lt;/para&amp;gt;&amp;lt;/section&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;The version of HBase introducing the above features reads both version 1 and 2 HFiles, but only writes version 2 HFiles. A version 2 HFile is structured as follows:&lt;br/&gt;
+         &amp;lt;para&amp;gt;8 bytes: Block type, a sequence of bytes equivalent to version 1&apos;s &quot;magic records&quot;. Supported block types are: &amp;lt;/para&amp;gt;&lt;br/&gt;
+                     INTERMEDIATE_INDEX &#65533;&#65533;&#65533; intermediate-level index blocks in a multi-level blockindex&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.replication.TestPerTableCFReplication&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10430//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14097287" author="apurtell" created="Thu, 14 Aug 2014 17:56:14 +0000"  >&lt;p&gt;lgtm&lt;/p&gt;</comment>
                            <comment id="14098278" author="anoop.hbase" created="Fri, 15 Aug 2014 07:19:39 +0000"  >&lt;p&gt;Great work Sean!&lt;br/&gt;
Just small comment&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The number of bytes in the longest tag in this hfile (int)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This info is actually the tags length of the Cell with longest tagsLength. (Not an individual tags length)&lt;/p&gt;

&lt;p&gt;Also FYI..  During compaction, if all the files under compaction having max tags length as 0, we even skip the 2 bytes tags length part with every KV and saving that overhead. Absence of MAX_TAGS_LENGTH file info means the Cell format is just like as in HFile V2&lt;/p&gt;</comment>
                            <comment id="14098543" author="busbey" created="Fri, 15 Aug 2014 13:36:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also FYI.. During compaction, if all the files under compaction having max tags length as 0, we even skip the 2 bytes tags length part with every KV and saving that overhead. Absence of MAX_TAGS_LENGTH file info means the Cell format is just like as in HFile V2&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Okay, to make sure I understand let me try restating things.&lt;/p&gt;

&lt;p&gt;1) If an HFile has a version number of 3.0+, I need to read the File Info Block before I can read any Data Blocks.&lt;/p&gt;

&lt;p&gt;2) If the File Info Block contains an entry for MAX_TAGS_LENGTH, then KeyValues will be serialized as KeyValues + Tags (even if that length is 0). Otherwise, they&apos;ll be serialized the same as in earlier versions.&lt;/p&gt;

&lt;p&gt;3) a File Info Block should only contain a TAGS_COMPRESSED entry if it has a MAX_TAGS_LENGTH entry.&lt;/p&gt;

&lt;p&gt;Is that all correct?&lt;/p&gt;</comment>
                            <comment id="14098551" author="busbey" created="Fri, 15 Aug 2014 13:44:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also FYI.. During compaction, if all the files under compaction having max tags length as 0&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How does the writer know if it&apos;s in a compaction vs a flush?&lt;/p&gt;</comment>
                            <comment id="14098562" author="anoop.hbase" created="Fri, 15 Aug 2014 14:02:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;How does the writer know if it&apos;s in a compaction vs a flush?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The writer decided whether to write the tags part (0 length atleast) based on HFileContext#isIncludesTags()&lt;br/&gt;
Up the layer, during flush this will be true.&lt;br/&gt;
In compaction we check the MAX_TAGS_LENGTH and decide.&lt;/p&gt;</comment>
                            <comment id="14105019" author="busbey" created="Thu, 21 Aug 2014 04:19:30 +0000"  >&lt;p&gt;updated patch and rendering based on feedback.&lt;/p&gt;</comment>
                            <comment id="14105347" author="hadoopqa" created="Thu, 21 Aug 2014 13:04:18 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12663339/HBASE-11729-v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12663339/HBASE-11729-v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12663339&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+0 tests included&lt;/font&gt;.  The patch appears to be a documentation patch that doesn&apos;t require tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 javadoc&lt;/font&gt;.  The javadoc tool appears to have generated 7 warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 lineLengths&lt;/font&gt;.  The patch introduces the following lines longer than 100:&lt;br/&gt;
    +    &amp;lt;para&amp;gt;As we will be discussing changes to the HFile format, it is useful to give a short overview of the original (HFile version 1) format.&amp;lt;/para&amp;gt;&lt;br/&gt;
+           &amp;lt;footnote&amp;gt;&amp;lt;para&amp;gt;Image courtesy of Lars George, &amp;lt;link xlink:href=&quot;http://www.larsgeorge.com/2009/10/hbase-architecture-101-storage.html&quot;&amp;gt;hbase-architecture-101-storage.html&amp;lt;/link&amp;gt;.&amp;lt;/para&amp;gt;&amp;lt;/footnote&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;The number of entries in the block index is stored in the fixed file trailer, and has to be passed in to the method that reads the block index. One of the limitations of the block index in version 1 is that it does not provide the compressed size of a block, which turns out to be necessary for decompression. Therefore, the HFile reader has to infer this compressed size from the offset difference between blocks. We fix this limitation in version 2, where we store on-disk block size instead of uncompressed size, and get uncompressed size from the block header.&amp;lt;/para&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;We found it necessary to revise the HFile format after encountering high memory usage and slow startup times caused by large Bloom filters and block indexes in the region server. Bloom filters can get as large as 100 MB per HFile, which adds up to 2 GB when aggregated over 20 regions. Block indexes can grow as large as 6 GB in aggregate size over the same set of regions. A region is not considered opened until all of its block index data is loaded. Large Bloom filters produce a different performance problem: the first get request that requires a Bloom filter lookup will incur the latency of loading the entire Bloom filter bit array.&amp;lt;/para&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;To speed up region server startup we break Bloom filters and block indexes into multiple blocks and write those blocks out as they fill up, which also reduces the HFile writer&#65533;&#65533;&#65533;s memory footprint. In the Bloom filter case, &#65533;&#65533;&#65533;filling up a block&#65533;&#65533;&#65533; means accumulating enough keys to efficiently utilize a fixed-size bit array, and in the block index case we accumulate an &#65533;&#65533;&#65533;index block&#65533;&#65533;&#65533; of the desired size. Bloom filter blocks and index blocks (we call these &#65533;&#65533;&#65533;inline blocks&#65533;&#65533;&#65533;) become interspersed with data blocks, and as a side effect we can no longer rely on the difference between block offsets to determine data block length, as it was done in version 1.&amp;lt;/para&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;HFile is a low-level file format by design, and it should not deal with application-specific details such as Bloom filters, which are handled at StoreFile level. Therefore, we call Bloom filter blocks in an HFile &quot;inline&quot; blocks. We also supply HFile with an interface to write those inline blocks. &amp;lt;/para&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;Another format modification aimed at reducing the region server startup time is to use a contiguous &#65533;&#65533;&#65533;load-on-open&#65533;&#65533;&#65533; section that has to be loaded in memory at the time an HFile is being opened. Currently, as an HFile opens, there are separate seek operations to read the trailer, data/meta indexes, and file info. To read the Bloom filter, there are two more seek operations for its &#65533;&#65533;&#65533;data&#65533;&#65533;&#65533; and &#65533;&#65533;&#65533;meta&#65533;&#65533;&#65533; portions. In version 2, we seek once to read the trailer and seek again to read everything else we need to open the file from a contiguous block.&amp;lt;/para&amp;gt;&amp;lt;/section&amp;gt;&lt;br/&gt;
+   &amp;lt;para&amp;gt;The version of HBase introducing the above features reads both version 1 and 2 HFiles, but only writes version 2 HFiles. A version 2 HFile is structured as follows:&lt;br/&gt;
+         &amp;lt;para&amp;gt;8 bytes: Block type, a sequence of bytes equivalent to version 1&apos;s &quot;magic records&quot;. Supported block types are: &amp;lt;/para&amp;gt;&lt;br/&gt;
+                     INTERMEDIATE_INDEX &#65533;&#65533;&#65533; intermediate-level index blocks in a multi-level blockindex&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.master.TestAssignmentManagerOnCluster&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/10516//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14105363" author="busbey" created="Thu, 21 Aug 2014 13:22:41 +0000"  >&lt;p&gt;AFAICT, both the javadoc warnings and the test failures are unrelated to this patch.&lt;/p&gt;</comment>
                            <comment id="14105656" author="apurtell" created="Thu, 21 Aug 2014 17:36:32 +0000"  >&lt;p&gt;I think we can ignore Jenkins in lieu of cut-and-paste of a successful conclusion of a local &apos;mvn site&apos;.&lt;/p&gt;</comment>
                            <comment id="14109164" author="busbey" created="Mon, 25 Aug 2014 14:55:41 +0000"  >&lt;p&gt;bump. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoop.hbase&quot; class=&quot;user-hover&quot; rel=&quot;anoop.hbase&quot;&gt;Anoop Sam John&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt; anything else y&apos;all would like to see included?&lt;/p&gt;</comment>
                            <comment id="14109283" author="ram_krish" created="Mon, 25 Aug 2014 16:38:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is equal to the compressed size if the compression algorithm is NON&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;May be not you, this should be NONE. Rest looks good.&lt;/p&gt;</comment>
                            <comment id="14109302" author="anoop.hbase" created="Mon, 25 Aug 2014 16:52:29 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14109303" author="busbey" created="Mon, 25 Aug 2014 16:52:36 +0000"  >&lt;p&gt;updated patch with NON -&amp;gt; NONE correction.&lt;/p&gt;</comment>
                            <comment id="14109576" author="stack" created="Mon, 25 Aug 2014 19:13:01 +0000"  >&lt;p&gt;Nice one Sean. Pushed to master.&lt;/p&gt;</comment>
                            <comment id="14109867" author="hudson" created="Mon, 25 Aug 2014 22:23:36 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK #5426 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/5426/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/5426/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11729&quot; title=&quot;Document HFile v3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11729&quot;&gt;&lt;del&gt;HBASE-11729&lt;/del&gt;&lt;/a&gt; Document hfile v3. (stack: rev 67646d36944213eb3b02433a4f4f9df51506fd31)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;src/main/docbkx/appendix_hfile_format.xml&lt;/li&gt;
	&lt;li&gt;src/main/docbkx/book.xml&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12663339" name="HBASE-11729-v2.patch" size="58674" author="busbey" created="Thu, 21 Aug 2014 04:19:30 +0000"/>
                            <attachment id="12663338" name="HBASE-11729-v2.pdf" size="261529" author="busbey" created="Thu, 21 Aug 2014 04:19:30 +0000"/>
                            <attachment id="12664170" name="HBASE-11729-v3.patch" size="58675" author="busbey" created="Mon, 25 Aug 2014 16:52:36 +0000"/>
                            <attachment id="12661625" name="HBASE-11729.patch" size="56622" author="busbey" created="Thu, 14 Aug 2014 03:53:35 +0000"/>
                            <attachment id="12661626" name="HBASE-11729.pdf" size="265614" author="busbey" created="Thu, 14 Aug 2014 03:56:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 13 Aug 2014 15:42:02 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411806</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yugv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411797</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>