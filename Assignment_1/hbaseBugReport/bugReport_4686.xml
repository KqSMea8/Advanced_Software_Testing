<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:21:09 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4686/HBASE-4686.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4686] [89-fb] Fix per-store metrics aggregation </title>
                <link>https://issues.apache.org/jira/browse/HBASE-4686</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In r1182034 per-Store metrics were broken, because the aggregation of StoreFile metrics over all stores in a region was replaced by overriding them every time. We saw these metrics drop by a factor of numRegions on a production cluster &amp;#8211; thanks to Kannan for noticing this!  We need to fix the metrics and add a unit test to ensure regressions like this don&apos;t happen in the future.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12529111">HBASE-4686</key>
            <summary>[89-fb] Fix per-store metrics aggregation </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikhail">Mikhail Bautin</assignee>
                                    <reporter username="mikhail">Mikhail Bautin</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Oct 2011 18:32:11 +0000</created>
                <updated>Tue, 22 May 2012 00:16:40 +0000</updated>
                            <resolved>Tue, 22 May 2012 00:16:40 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                            <comments>
                            <comment id="13137517" author="jiraposter@reviews.apache.org" created="Thu, 27 Oct 2011 20:42:32 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2590/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2590/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase and Liyin Tang.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;In r1182034 per-Store metrics were broken, because the aggregation of StoreFile metrics over all stores in a region was replaced by overriding them every time. We saw these metrics drop by a factor of numRegions on a production cluster &#8211; thanks to Kannan for noticing this! We need to fix the metrics and add a unit test to ensure regressions like this don&apos;t happen in the future.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4686&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 6c821c0 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 4a4436f &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java 8776ffe &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java 7fd8977 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/metrics/TestSchemaMetrics.java c03532a &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2590/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2590/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Still running unit tests.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Mikhail&lt;/p&gt;
</comment>
                            <comment id="13137643" author="mikhail" created="Thu, 27 Oct 2011 22:25:00 +0000"  >&lt;p&gt;I put another version of the patch on Differential: &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13137646" author="mikhail" created="Thu, 27 Oct 2011 22:26:10 +0000"  >&lt;p&gt;Second version of the patch.&lt;/p&gt;</comment>
                            <comment id="13137649" author="mikhail" created="Thu, 27 Oct 2011 22:27:44 +0000"  >&lt;p&gt;Sorry for confusing file names. The most recent patch is:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12501169/HBASE-4686-jira-89-fb-Fix-per-store-metrics-aggregat-20111027152723-05bea421.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12501169/HBASE-4686-jira-89-fb-Fix-per-store-metrics-aggregat-20111027152723-05bea421.patch&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13137687" author="phabricator@reviews.facebook.net" created="Thu, 27 Oct 2011 22:54:32 +0000"  >&lt;p&gt;mbautin requested code review of &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;br/&gt;
Reviewers: Liyin, JIRA&lt;/p&gt;

&lt;p&gt;  In r1182034 per-Store metrics were broken, because the aggregation of StoreFile metrics over all stores in a region was replaced by overriding them every time. We saw these metrics drop by a factor of numRegions on a production cluster &#8211; thanks to Kannan for noticing this! We need to fix the metrics and add a unit test to ensure regressions like this don&apos;t happen in the future.&lt;/p&gt;

&lt;p&gt;TEST PLAN&lt;br/&gt;
  Unit tests, dev cluster&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/metrics/TestSchemaMetrics.java&lt;/p&gt;</comment>
                            <comment id="13137761" author="phabricator@reviews.facebook.net" created="Thu, 27 Oct 2011 23:55:32 +0000"  >&lt;p&gt;Liyin has accepted the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;/p&gt;

&lt;p&gt;  It looks good to me. Just one minor comments:&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java:384 This api looks like very hard to use.&lt;br/&gt;
  Maybe we can elaborate what&apos;s in the map a little bit&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13138866" author="phabricator@reviews.facebook.net" created="Fri, 28 Oct 2011 22:30:32 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;br/&gt;
Reviewers: Liyin, JIRA&lt;/p&gt;

&lt;p&gt;  Fixing TestHeapSize after an unused field was removed from HRegion.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/metrics/TestSchemaMetrics.java&lt;/p&gt;</comment>
                            <comment id="13138972" author="phabricator@reviews.facebook.net" created="Fri, 28 Oct 2011 23:45:32 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;br/&gt;
Reviewers: Liyin, JIRA&lt;/p&gt;

&lt;p&gt;  Addressing Liyin&apos;s comment.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/metrics/TestSchemaMetrics.java&lt;/p&gt;</comment>
                            <comment id="13140663" author="phabricator@reviews.facebook.net" created="Mon, 31 Oct 2011 23:13:32 +0000"  >&lt;p&gt;Liyin has requested changes to the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;/p&gt;

&lt;p&gt;  Thanks Mikhail for the patch.&lt;br/&gt;
  There are some comments inline.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java:386 &lt;span class=&quot;error&quot;&gt;&amp;#91;code style&amp;#93;&lt;/span&gt; Please add an empty line here&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java:554 Why not move this comments to line 551 ?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java:704 &lt;span class=&quot;error&quot;&gt;&amp;#91;code style&amp;#93;&lt;/span&gt; please remove this empty line here&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java:1148 &lt;span class=&quot;error&quot;&gt;&amp;#91;code style&amp;#93;&lt;/span&gt; Please write the standard java doc format&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java:1157 &lt;span class=&quot;error&quot;&gt;&amp;#91;code style&amp;#93;&lt;/span&gt; Please remove the empty line here&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java:1219 &lt;span class=&quot;error&quot;&gt;&amp;#91;code style&amp;#93;&lt;/span&gt; Please add an empty line here&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java:90 &lt;span class=&quot;error&quot;&gt;&amp;#91;code style&amp;#93;&lt;/span&gt; Please remove the empty line here&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java:119 &lt;span class=&quot;error&quot;&gt;&amp;#91;code style&amp;#93;&lt;/span&gt; Please remove the empty line here&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13140686" author="phabricator@reviews.facebook.net" created="Mon, 31 Oct 2011 23:33:32 +0000"  >&lt;p&gt;Liyin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java:386 Can you elaborate what the key and value in this tmpMap is in the javadoc?&lt;br/&gt;
  It does no look very clear to me.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13140702" author="phabricator@reviews.facebook.net" created="Mon, 31 Oct 2011 23:59:32 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;/p&gt;

&lt;p&gt;  OK, this is now becoming a code style discussion, which is not a bad thing once in a while &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;  In general, the style guide for HBase seems to point to Oracle (former Sun)&apos;s coding conventions: &lt;a href=&quot;http://www.oracle.com/technetwork/java/codeconvtoc-136057.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.oracle.com/technetwork/java/codeconvtoc-136057.html&lt;/a&gt;, with the part pertaining to Javadoc at &lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/documentation/index-137868.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.oracle.com/technetwork/java/javase/documentation/index-137868.html&lt;/a&gt;. I guess it might not be a bad idea to actually read those docs some time...&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java:386 Actually I a lot of places around the codebase don&apos;t have these empty lines inside javadoc comments, and I think it is not necessary here. Java formatter adds trailing whitespace to those empty lines, which is annoying. I did not find a requirement that these lines have to be there at &lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/documentation/index-137868.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.oracle.com/technetwork/java/javase/documentation/index-137868.html&lt;/a&gt; (although I did not read that entire style guide).&lt;/p&gt;

&lt;p&gt;  I will expand the documentation  of tmpMap.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java:554 Will fix.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaMetrics.java:704 Agreed.&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java:1148 I think this saves space and is OK for one-line comments. This parses fine by Javadoc.&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java:1157 This empty line separates the bulky function header and the function body.&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java:1219 I will add one between 1218 and 1219.&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java:90 OK.&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java:119 This one is a matter of preference. There is one at the top, so I will keep the one at the bottom of the class definition.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13145678" author="phabricator@reviews.facebook.net" created="Mon, 7 Nov 2011 18:26:51 +0000"  >&lt;p&gt;nspiegelberg has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;/p&gt;

&lt;p&gt;  is there any functional problem with this code?  I don&apos;t see any code guideline violations severe enough to make for a negative impact on inheriting the code.  Maybe reading Code Complete would be a good way to adjust focus for code guideline severity on formatting that we can&apos;t automate away:  &lt;a href=&quot;http://www.amazon.com/Code-Complete-Practical-Handbook-Construction/dp/0735619670/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.amazon.com/Code-Complete-Practical-Handbook-Construction/dp/0735619670/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13178963" author="phabricator@reviews.facebook.net" created="Tue, 3 Jan 2012 19:26:38 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;br/&gt;
Reviewers: Liyin, JIRA&lt;/p&gt;

&lt;p&gt;  Added another load test in a unit test with encoding turned on. That found some bugs similar to those that I observed in cluster testing, and I added a smaller test reproducing the same bugs (TestEncodedSeekers). Fixed the bugs by correctly restoring additional state when going to previous key/value (previously, only the vanilla BufferedDataBlockEncoder.SeekerState was restored but not algorithm-specific state). I also had to remove BitsetKeyDeltaEncoder for now because I could not fix its encoded seeker yet (it seems to have some more complicated bugs) but we are not planning to use that algorithm for now&lt;/p&gt;

&lt;p&gt;  Also, fixed the most recent comment by Ted and TestHFileBlock.testBlockHeapSize failure on a 32-bit JVM (thanks to Ted for pointing that one out as well).&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/HColumnDescriptor.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/HalfStoreFileReader.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CompressionState.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoding.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncodedDataBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncoderBufferTooSmallException.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/AbstractHFileReader.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/AbstractHFileWriter.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/BlockType.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFile.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileBlockIndex.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoderImpl.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFilePrettyPrinter.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileReaderV1.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileReaderV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileWriterV1.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileWriterV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/NoOpDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/mapreduce/LoadIncrementalHFiles.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/StoreFile.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/StoreFileScanner.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/metrics/SchemaConfigured.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ByteBufferUtils.java&lt;br/&gt;
  src/main/ruby/hbase/admin.rb&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/BROKE_TODO_FIX_TestAcidGuarantees.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestCase.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HFilePerformanceEvaluation.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/TestAcidGuarantees.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/client/TestFromClientSide.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/TestHalfStoreFileReader.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/TestHeapSize.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/RedundantKVGenerator.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/TestBufferedDataBlockEncoder.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/TestDataBlockEncoders.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/TestEncodedSeekers.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/CacheTestUtils.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestCacheOnWrite.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlockIndex.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileDataBlockEncoder.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileWriterV2.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/mapreduce/TestImportExport.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/CreateRandomStoreFile.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/DataBlockEncodingTool.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/EncodedSeekPerformanceTest.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestCompactSelection.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestCompoundBloomFilter.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestFSErrorsExposed.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestMultiColumnScanner.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestScanWithBloomError.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestSeekOptimizations.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestStoreFile.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/wal/TestLogRolling.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/wal/TestWALReplay.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/LoadTestTool.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/MultiThreadedWriter.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/RestartMetaTest.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestByteBufferUtils.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestMiniClusterLoadEncoded.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestMiniClusterLoadParallel.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestMiniClusterLoadSequential.java&lt;/p&gt;</comment>
                            <comment id="13178967" author="phabricator@reviews.facebook.net" created="Tue, 3 Jan 2012 19:28:40 +0000"  >&lt;p&gt;mbautin has abandoned the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4686&quot; title=&quot;[89-fb] Fix per-store metrics aggregation &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4686&quot;&gt;&lt;del&gt;HBASE-4686&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Fix per-store metrics aggregation&lt;br/&gt;
&quot;.&lt;/p&gt;

&lt;p&gt;  Oops... Updated the wrong diff (I meant to update the delta encoding diff, sorry about that). Fortunately, this is a stale diff so closing.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D87&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D87&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13280641" author="mikhail" created="Tue, 22 May 2012 00:16:40 +0000"  >&lt;p&gt;This has already been committed to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12501181" name="ASF.LICENSE.NOT.GRANTED--D87.1.patch" size="26046" author="phabricator@reviews.facebook.net" created="Thu, 27 Oct 2011 22:54:32 +0000"/>
                            <attachment id="12501386" name="ASF.LICENSE.NOT.GRANTED--D87.2.patch" size="27078" author="phabricator@reviews.facebook.net" created="Fri, 28 Oct 2011 22:30:32 +0000"/>
                            <attachment id="12501407" name="ASF.LICENSE.NOT.GRANTED--D87.3.patch" size="26430" author="phabricator@reviews.facebook.net" created="Fri, 28 Oct 2011 23:45:33 +0000"/>
                            <attachment id="12509330" name="ASF.LICENSE.NOT.GRANTED--D87.4.patch" size="411784" author="phabricator@reviews.facebook.net" created="Tue, 3 Jan 2012 19:26:39 +0000"/>
                            <attachment id="12501157" name="HBASE-4686-TestRegionServerMetics-and-Store-metric-a-20111027134023-cc718144.patch" size="26784" author="mikhail" created="Thu, 27 Oct 2011 20:41:56 +0000"/>
                            <attachment id="12501169" name="HBASE-4686-jira-89-fb-Fix-per-store-metrics-aggregat-20111027152723-05bea421.patch" size="28380" author="mikhail" created="Thu, 27 Oct 2011 22:26:10 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12529131">HBASE-4689</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 27 Oct 2011 20:42:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>214971</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i015xz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4732</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>