<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:14:48 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3985/HBASE-3985.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3985] Same Region could be picked out twice in LoadBalancer</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3985</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;From the HMaster logs, I found something weird:&lt;/p&gt;

&lt;p&gt;2011-05-24 11:12:11,152 INFO org.apache.hadoop.hbase.master.HMaster: balance hri=hello,122130,1305944329350.7d6c96428e2563c3d8676474d0a9f814., src=158-1-101-202,20020,1306205409671, dest=158-1-101-222,20020,1306205940117&lt;br/&gt;
2011-05-24 11:12:31,536 INFO org.apache.hadoop.hbase.master.HMaster: balance hri=hello,122130,1305944329350.7d6c96428e2563c3d8676474d0a9f814., src=158-1-101-202,20020,1306205409671, dest=158-1-101-222,20020,1306205940117&lt;/p&gt;

&lt;p&gt;We can see that, the same region was balanced twice.&lt;/p&gt;

&lt;p&gt;To describe the problem, I give out one simple example:&lt;/p&gt;

&lt;p&gt;1. Suppose regions count is 10 in RegionServer A.&lt;br/&gt;
   Max: 5  Min:4&lt;br/&gt;
2. So the regions count need to move is: 5.&lt;br/&gt;
3. Before the movement of calculate, the list was shuffled.&lt;br/&gt;
4. The 5 moving region was picked out from the back.&lt;br/&gt;
5. The nextRegionForUnload value is 5.&lt;br/&gt;
6. So if the neededRegions is not zero. Maybe there&apos;s still one region should be picked out from RegionServer A.&lt;br/&gt;
   This time , the picked Index is 5 which has been picked once!!!!! &lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;lt;----&lt;del&gt;5&lt;/del&gt;------&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;-----------&lt;del&gt;&lt;b&gt;&lt;/del&gt;&lt;del&gt;&lt;/b&gt;&lt;/del&gt;&lt;del&gt;&lt;b&gt;&lt;/del&gt;&lt;del&gt;&lt;/b&gt;&lt;/del&gt;&lt;del&gt;&lt;b&gt;&lt;/del&gt;&lt;del&gt;&lt;/b&gt;&lt;/del&gt;&lt;del&gt;&lt;b&gt;&lt;/del&gt;&lt;del&gt;&lt;/b&gt;&lt;/del&gt;&lt;del&gt;&lt;b&gt;&lt;/del&gt;&lt;del&gt;&lt;/b&gt;&lt;/del&gt;---&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;                   getNextRegionForUnload                             &lt;/p&gt;

&lt;p&gt;Here&apos;s the analysis from code:           &lt;/p&gt;

&lt;p&gt;1. Walk down most loaded, pruning each to the max. Picked region from back of the list(by reverse order)   &lt;br/&gt;
Map&amp;lt;HServerInfo,BalanceInfo&amp;gt; serverBalanceInfo =&lt;br/&gt;
      new TreeMap&amp;lt;HServerInfo,BalanceInfo&amp;gt;();&lt;br/&gt;
    for(Map.Entry&amp;lt;HServerInfo, List&amp;lt;HRegionInfo&amp;gt;&amp;gt; server :&lt;br/&gt;
      serversByLoad.descendingMap().entrySet()) {&lt;br/&gt;
      HServerInfo serverInfo = server.getKey();&lt;br/&gt;
      int regionCount = serverInfo.getLoad().getNumberOfRegions();&lt;br/&gt;
      if(regionCount &amp;lt;= max) &lt;/p&gt;
{
        serverBalanceInfo.put(serverInfo, new BalanceInfo(0, 0));
        break;
      }
&lt;p&gt;      serversOverloaded++;&lt;br/&gt;
      List&amp;lt;HRegionInfo&amp;gt; regions = randomize(server.getValue());&lt;br/&gt;
      int numToOffload = Math.min(regionCount - max, regions.size());&lt;br/&gt;
      int numTaken = 0;&lt;br/&gt;
      for (int i = regions.size() - 1; i &amp;gt;= 0; i--) &lt;/p&gt;
{
        HRegionInfo hri = regions.get(i);
        // Don&apos;t rebalance meta regions.
        if (hri.isMetaRegion()) continue;
        regionsToMove.add(new RegionPlan(hri, serverInfo, null));
        numTaken++; 
        if (numTaken &amp;gt;= numToOffload) break;
      }
&lt;p&gt;      /**********************************************************/&lt;br/&gt;
      /***set the nextRegionForUnload  value is numToOffload ****/&lt;br/&gt;
      /**********************************************************/&lt;br/&gt;
      serverBalanceInfo.put(serverInfo,&lt;br/&gt;
          new BalanceInfo(numToOffload, (-1)*numTaken));&lt;br/&gt;
    }&lt;br/&gt;
2. The second pass of picked one region from the Max regionserver by order.&lt;br/&gt;
    if (neededRegions != 0) {&lt;br/&gt;
      // Walk down most loaded, grabbing one from each until we get enough&lt;br/&gt;
      for(Map.Entry&amp;lt;HServerInfo, List&amp;lt;HRegionInfo&amp;gt;&amp;gt; server :&lt;br/&gt;
        serversByLoad.descendingMap().entrySet()) {&lt;br/&gt;
        BalanceInfo balanceInfo = serverBalanceInfo.get(server.getKey());&lt;br/&gt;
        int idx =&lt;br/&gt;
          balanceInfo == null ? 0 : balanceInfo.getNextRegionForUnload();&lt;br/&gt;
        if (idx &amp;gt;= server.getValue().size()) break;&lt;br/&gt;
        HRegionInfo region = server.getValue().get(idx);&lt;br/&gt;
        if (region.isMetaRegion()) continue; // Don&apos;t move meta regions.&lt;br/&gt;
        regionsToMove.add(new RegionPlan(region, server.getKey(), null));&lt;br/&gt;
        if(--neededRegions == 0) &lt;/p&gt;
{
          // No more regions needed, done shedding
          break;
        }
&lt;p&gt;      }&lt;br/&gt;
    }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12510250">HBASE-3985</key>
            <summary>Same Region could be picked out twice in LoadBalancer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jeason">Jieshan Bean</assignee>
                                    <reporter username="jeason">Jieshan Bean</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jun 2011 00:50:15 +0000</created>
                <updated>Fri, 20 Nov 2015 11:52:29 +0000</updated>
                            <resolved>Thu, 16 Jun 2011 19:56:55 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.90.4</fixVersion>
                                    <component>master</component>
                        <due>Tue, 14 Jun 2011 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13048920" author="jeason" created="Tue, 14 Jun 2011 00:50:57 +0000"  >&lt;p&gt;The patch will be submitted later&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13049074" author="jeason" created="Tue, 14 Jun 2011 09:22:37 +0000"  >&lt;p&gt;I think, while running LoadBalancer, it&apos;s better to log more info about each server. So in the patch, It seems I modified more places.&lt;br/&gt;
If it can&apos;t be accept, and I also make another patch with less modify of logs.&lt;br/&gt;
So there&apos;s two patches. &lt;/p&gt;
</comment>
                            <comment id="13049300" author="stack" created="Tue, 14 Jun 2011 17:38:57 +0000"  >&lt;p&gt;Jieshan: Patch looks good. Minor things are that I&apos;d make the new balance info DEBUG rather than INFO level and I&apos;d test for length &amp;gt;= 2 before I went about subtracting 2 (I can make these changes on commit).  In general more info, if &apos;quality&apos;, is always better.&lt;/p&gt;

&lt;p&gt;One question.  Does it work?  This seems like a pretty big change:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = regions.size() - 1; i &amp;gt;= 0; i--) {
+      
+      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; regions.size(); i++) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This method is in bad need of rework.  Its way too long and should be standalone testable; currently it is not.  Making it so is not in scope w/ this fix but before commit, unless you are going to provide a test, I need evidence this fix does not break existing balancing.&lt;/p&gt;</comment>
                            <comment id="13049580" author="jeason" created="Wed, 15 Jun 2011 02:31:51 +0000"  >&lt;p&gt;Thanks stack!&lt;br/&gt;
I&apos;ll modify the patch as you suggested. And I&apos;ll take more test on it. If it possile, I will submit the test result.&lt;br/&gt;
But about your comments, I have little doubt, for I can&apos;t understand of &quot;in scope w/&quot;. Pardon?&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="13049585" author="yuzhihong@gmail.com" created="Wed, 15 Jun 2011 02:50:53 +0000"  >&lt;p&gt;Stack meant that making the method shorter is outside the scope of this JIRA.&lt;/p&gt;</comment>
                            <comment id="13049589" author="jeason" created="Wed, 15 Jun 2011 03:20:57 +0000"  >&lt;p&gt;Thanks Ted Yu, now I get it.&lt;/p&gt;</comment>
                            <comment id="13050168" author="jeason" created="Thu, 16 Jun 2011 00:51:40 +0000"  >&lt;p&gt;I have modified the patch, and take some tests on that(For the added logs, I think it&apos;s useful for analysis the balance process, so I keeped them in the patch. But the log level, I have lower it in debug.).&lt;br/&gt;
I have submitted the test results.&lt;br/&gt;
Any problem and the patch, please tell me if I still have some work to do.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="13050675" author="stack" created="Thu, 16 Jun 2011 19:40:49 +0000"  >&lt;p&gt;@Jieshan This is better:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = regions.size() - 1; i &amp;gt;= 0; i--) {                                                                                                                                                    |~                             
-        HRegionInfo hri = regions.get(i);                                                                                                                                                                |~                             
+                                                                                                                                                                                                         |~                             
+      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (HRegionInfo hri: regions) {  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thank you.&lt;/p&gt;

&lt;p&gt;Let me commit.  I changed one of the messages to DEBUG.&lt;/p&gt;</comment>
                            <comment id="13050691" author="stack" created="Thu, 16 Jun 2011 19:56:55 +0000"  >&lt;p&gt;Committed branch and trunk (though all that went into trunk is the extra logging detail &amp;#8211; it doesn&apos;t seem to have this issue)&lt;/p&gt;</comment>
                            <comment id="13050834" author="jeason" created="Fri, 17 Jun 2011 01:04:07 +0000"  >&lt;p&gt;Thanks stack!&lt;br/&gt;
Yes, this issue doesn&apos;t exist in trunk.&lt;br/&gt;
Next time, if the issue related to both 0.90 and trunk, I will remember to make a patch for trunk also.&lt;/p&gt;</comment>
                            <comment id="15015760" author="lars_francke" created="Fri, 20 Nov 2015 11:52:29 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12482737" name="AllProjectTestResults.txt" size="25214" author="jeason" created="Thu, 16 Jun 2011 00:46:01 +0000"/>
                            <attachment id="12482736" name="HBASE-2985-LoadBalancer-V2.patch" size="2842" author="jeason" created="Thu, 16 Jun 2011 00:45:46 +0000"/>
                            <attachment id="12482531" name="HBASE-3985-LoadBalancer.patch" size="2784" author="jeason" created="Tue, 14 Jun 2011 09:06:55 +0000"/>
                            <attachment id="12482532" name="HBASE-3985-LoadBalancer_(NoneServerLog).patch" size="1847" author="jeason" created="Tue, 14 Jun 2011 09:08:09 +0000"/>
                            <attachment id="12482738" name="org.apache.hadoop.hbase.master.TestLoadBalancer.txt" size="292" author="jeason" created="Thu, 16 Jun 2011 00:46:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 14 Jun 2011 17:38:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27120</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0houf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101287</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>