<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:58:10 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-14958/HBASE-14958.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-14958] regionserver.HRegionServer: Master passed us a different hostname to use; was=n04docker2, but now=192.168.3.114</title>
                <link>https://issues.apache.org/jira/browse/HBASE-14958</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I have two physical machines: c3m3n03docker and c3m3n04docker.&lt;br/&gt;
I started two docker instances per physical node. the topology is like:&lt;/p&gt;

&lt;p&gt;n03docker1(172.17.1.2)  -\&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; br0(172.17.1.1)  +  c3m3n03&lt;br/&gt;
n03docker2(172.17.1.3) -/&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;



&lt;p&gt;n04docker1(172.17.2.2)  -\&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; br0(172.17.2.1)  +  c3m3n04&lt;br/&gt;
n04docker2(172.17.2.3) -/&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;for physical machines, c3m3n03 is bundled with physical adapter enp11s0f0 with IP (192.168.3.113/16); c3m3n04 is bundled with physical adapter enp11s0f0 with IP(192.168.3.114/16). these two physical adapters are connecting to the same switch.&lt;/p&gt;

&lt;p&gt;Note: br0 is not bundled to physical adapter enp11s0f0  on both nodes. so, all requests in 172.17.2.x will be source NAT as 192.168.3.114(c3m3n04) and forwarded to c3m3n03.&lt;/p&gt;

&lt;p&gt;n03docker1: hbase(1.1.2) master&lt;br/&gt;
n03docker2: region server&lt;br/&gt;
n04docker1: region server&lt;br/&gt;
n04docker2: region server&lt;/p&gt;

&lt;p&gt;I first start the n03docker1 and n03docker2, it works; after that, I start n04docker2 and it will reported:&lt;/p&gt;

&lt;p&gt;2015-12-09 08:01:58,259 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;regionserver/n04docker2.gpfs.net/172.17.2.3:16020&amp;#93;&lt;/span&gt; regionserver.HRegionServer: Master passed us a different hostname to use; was=n04docker2.gpfs.net, but now=192.168.3.114&lt;/p&gt;

&lt;p&gt;on the master logs:&lt;br/&gt;
2015-12-09 08:11:12,234 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;PriorityRpcServer.handler=0,queue=0,port=16000&amp;#93;&lt;/span&gt; master.ServerManager: Registering server=192.168.3.114,16020,1449666670721&lt;/p&gt;

&lt;p&gt;So, you see, when hbase master receives the requests from n04docker2, all these requests are source NATed with 192.168.3.114(not 172.17.2.3).  and hbase master passes 192.168.3.114 back to 172.17.2.3(n04docker2). Thus, n04docker1(172.17.2.3) reported exceptions in logs.&lt;/p&gt;

&lt;p&gt;hbase doesn&apos;t support running in virtualization cluster? because SNAT is widely used in virtualization. if hbase master get remote hostname/ip(thus get 192.168.3.114) and pass it back to region server, it will hit this issues.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8667&quot; title=&quot;Master and Regionserver not able to communicate if both bound to different network interfaces on the same machine.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8667&quot;&gt;&lt;del&gt;HBASE-8667&lt;/del&gt;&lt;/a&gt; doesn&apos;t fix this issue because the fix has been hbase 0.98(I&apos;m taking hbase 1.1.2).&lt;/p&gt;</description>
                <environment>&lt;p&gt;physical machines: redhat7.1&lt;br/&gt;
docker version: 1.9.1&lt;/p&gt;</environment>
        <key id="12920479">HBASE-14958</key>
            <summary>regionserver.HRegionServer: Master passed us a different hostname to use; was=n04docker2, but now=192.168.3.114</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Yong">Yong Zheng</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Dec 2015 16:31:54 +0000</created>
                <updated>Thu, 10 Dec 2015 03:22:15 +0000</updated>
                                            <version>1.1.2</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15049004" author="ndimiduk" created="Wed, 9 Dec 2015 17:20:54 +0000"  >&lt;p&gt;HBase does work within a virtualized environment. Please see the bit about DNS in the prerequisites section of the book: &lt;a href=&quot;http://hbase.apache.org/book.html#basic.prerequisites&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hbase.apache.org/book.html#basic.prerequisites&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="15049753" author="yong" created="Thu, 10 Dec 2015 00:50:39 +0000"  >&lt;p&gt;Thanks for Nick so prompt response. &lt;/p&gt;

&lt;p&gt;After checking the prerequisites, DNS can&apos;t solve the issue. &lt;/p&gt;

&lt;p&gt;in my virtualized hbase cluster, it has only 4 nodes: &lt;br/&gt;
n03docker1(172.17.1.2)&lt;br/&gt;
n03docker2(172.17.1.3)&lt;/p&gt;

&lt;p&gt;n04docker1(172.17.2.2)&lt;br/&gt;
n04docker2(172.17.2.3)&lt;/p&gt;

&lt;p&gt;DNS is not configured but I configured /etc/hosts:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;cat /etc/hosts&lt;br/&gt;
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4&lt;br/&gt;
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;172.17.1.1   c3m3n03docker.gpfs.net c3m3n03docker            &amp;lt;== the br0 on the physical node c3m3n03&lt;br/&gt;
172.17.2.1   c3m3n04docker.gpfs.net c3m3n04docker             &amp;lt;== the br0 on the physical node c3m3n04&lt;/p&gt;

&lt;p&gt;172.17.1.2   n03docker1.gpfs.net n03docker1&lt;br/&gt;
172.17.1.3   n03docker2.gpfs.net n03docker2&lt;br/&gt;
172.17.2.2   n04docker1.gpfs.net n04docker1&lt;br/&gt;
172.17.2.3   n04docker2.gpfs.net n04docker2&lt;/p&gt;

&lt;p&gt;so, DNS resolution works(I do see the correct name for n03docker1 and n03docker2). However, for any region servers located over other physical machines, all network packet from those region servers  will be source NATed with the IP of c3m3n04(192.168.3.114)(that means, all IP packet will be changed with the source IP as 192.168.3.114. so that these packets can be transferred to the physical node c3m3n03).&lt;/p&gt;

&lt;p&gt;for hbase master, 192.168.3.113 or 192.168.3.114 are invisible for hbase. thus, DNS resolution for 192.168.3.114 inside VM doesn&apos;t help this.  e.g. 192.168.3.114&apos;s hostname should be c3m3n04, not n04docker1 or n04docker2.&lt;br/&gt;
if we configure DNS inside VM to map 192.168.3.114 into n04docker1 or n04docker2, this will mess up IP-hostname inside VM. Also, if we map 192.168.3.114 into n04docker1, that means, we can&apos;t start the 2nd region server over the same physical node because they will be recognized as the physical node&apos;s IP address/hostname.&lt;/p&gt;</comment>
                            <comment id="15049930" author="yong" created="Thu, 10 Dec 2015 03:04:11 +0000"  >&lt;p&gt;I did some simple test on n03docker2(172.17.1.3) with tcp_server; on n04docker2(172.17.2.3) with tcp_client.&lt;/p&gt;

&lt;p&gt;in tcp_server:&lt;br/&gt;
...&lt;br/&gt;
                sin_size=sizeof(struct   sockaddr_in);    &lt;br/&gt;
                if((new_fd=accept(sockfd,(struct   sockaddr   *)(&amp;amp;client_addr),&amp;amp;sin_size)) == -1)    &lt;/p&gt;
                {    
                        fprintf(stderr,&quot;Accept   error:%s\n\a&quot;,strerror(errno));    
                        exit(1);    
                }
&lt;p&gt;                fprintf(stderr,&quot;Server   get   connection   from   %x\n&quot;,    &lt;br/&gt;
                client_addr.sin_addr.s_addr);    &lt;/p&gt;

&lt;p&gt;                ret = getpeername(sockfd, (struct   sockaddr   *)(&amp;amp;client_peer_addr), &amp;amp;sin_size); &lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;on tcp_client, it just connects to the server and send one message.&lt;/p&gt;

&lt;p&gt;bash-4.1# hostname&lt;br/&gt;
n04docker2&lt;br/&gt;
bash-4.1# ./tcp_client 172.17.1.3 8030&lt;/p&gt;

&lt;p&gt;on tcp_server,&lt;br/&gt;
bash-4.1# hostname&lt;br/&gt;
n03docker2.gpfs.net&lt;br/&gt;
bash-4.1# ./tcp_server 8030&lt;br/&gt;
will accepting...&lt;br/&gt;
Server   get   connection ...&lt;br/&gt;
Server   get   connection   from   7203a8c0 &amp;lt;== this IP address is 192.168.3.114 after transforming to host address.&lt;/p&gt;

&lt;p&gt;So, in Source NAT-involved virtualization, it looks to me that the current hbase master/region server mechanism doesn&apos;t work. maybe, we could ask the region server/master to exchange the hostname,not depends on socket API to get the client IP address.&lt;/p&gt;</comment>
                            <comment id="15049957" author="apurtell" created="Thu, 10 Dec 2015 03:22:15 +0000"  >&lt;p&gt;This is the project dev tracker. Please write to user@hbase.apache.org for troubleshooting and general help. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 9 Dec 2015 17:20:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2po3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>