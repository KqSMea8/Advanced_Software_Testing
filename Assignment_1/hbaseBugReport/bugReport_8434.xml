<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:55:13 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8434/HBASE-8434.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8434] Allow enabling hbase 8354 to support real lease recovery</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8434</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Please see discussion in HBase 8389.&lt;/p&gt;

&lt;p&gt;For environments where lease recovery time can be bounded on the HDFS side through tight timeouts, provide a toggle for users who want the WAL splitting to continue only after the lease is truly recovered and the file is closed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12644540">HBASE-8434</key>
            <summary>Allow enabling hbase 8354 to support real lease recovery</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10">Implemented</resolution>
                                        <assignee username="varunsharma">Varun Sharma</assignee>
                                    <reporter username="varunsharma">Varun Sharma</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Apr 2013 06:01:55 +0000</created>
                <updated>Fri, 2 Aug 2013 23:20:13 +0000</updated>
                            <resolved>Fri, 2 Aug 2013 20:55:34 +0000</resolved>
                                                                    <component>MTTR</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13641485" author="enis" created="Thu, 25 Apr 2013 06:23:32 +0000"  >&lt;p&gt;-1 on this. Lease recovery should always be default otherwise we will allow data loss. The only use case, you maybe ok with trading lease recovery with MTTR would be that if all your table data is skip wal or deferred wal, which is not a common use case at all. &lt;/p&gt;</comment>
                            <comment id="13641498" author="varunsharma" created="Thu, 25 Apr 2013 06:40:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Are you -1 on 8389 as well, then, it disables lease recovery by undoing 7878, if yes, can you communicate in on HBASE 8389 too. This patch gives on option to enable it, if we choose to do 8389...&lt;/p&gt;</comment>
                            <comment id="13641534" author="nkeywal" created="Thu, 25 Apr 2013 07:45:56 +0000"  >&lt;p&gt;As Enis. But agreed, we need a better mttr with synchronous lease recovery.&lt;/p&gt;</comment>
                            <comment id="13641546" author="varunsharma" created="Thu, 25 Apr 2013 07:55:56 +0000"  >&lt;p&gt;Okay - but then we need synchronous lease recovery for 0.94 - in HBASE 8389 - the patch v5 makes us skip lease recovery. I think either we revert that patch or we provide an option to force lease recovery.&lt;/p&gt;

&lt;p&gt;As I said above, this one is 0.94 specific and not for trunk and depends on what will come out of 8389 - if we choose to ditch on lease recovery and revert to the same behaviour before HBASE 8354, then we should have this...&lt;/p&gt;</comment>
                            <comment id="13641721" author="nkeywal" created="Thu, 25 Apr 2013 12:23:41 +0000"  >&lt;p&gt;Yep, v5 is just a way to have a known but bad behaviour until we fix the issue for real. But to declare it fixed, we need to test with real failures. &lt;/p&gt;

&lt;p&gt;Imho, requiring the stale mode is not a big issue for HBase. If you don&apos;t have it, you will go to dead datanodes during the split, and this will lead you to a bad MTTR anyway...&lt;/p&gt;</comment>
                            <comment id="13641851" author="varunsharma" created="Thu, 25 Apr 2013 14:24:59 +0000"  >&lt;p&gt;I just changed the description and put it in simple words - the patch basically is:&lt;/p&gt;

&lt;p&gt;&quot;Do we want to be able to conditionally enable HBase 7878/8354 for 0.94 if we choose to move forward with patch v5 in HBase 8389&quot; ?&lt;/p&gt;

&lt;p&gt;That makes it easier to decide since we already have a lot of discussion in 7878 and 8389.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Varun&lt;/p&gt;</comment>
                            <comment id="13642016" author="enis" created="Thu, 25 Apr 2013 18:00:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;Okay - but then we need synchronous lease recovery for 0.94 - in HBASE 8389 - the patch v5 makes us skip lease recovery. I think either we revert that patch or we provide an option to force lease recovery&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As Nicolas said, patch v5 at &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8389&quot; title=&quot;HBASE-8354 forces Namenode into loop with lease recovery requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8389&quot;&gt;&lt;del&gt;HBASE-8389&lt;/del&gt;&lt;/a&gt; is just a temp fix until the real fix comes through. Ted is working on bringing isFileClosed() to Hadoop branch-1, so we might be able to have this functionality in all latest versions of hadoop branches. The remaining discussion we should have is what to do when isFileClosed() is not there.&lt;br/&gt;
Agreed, let&apos;s move the discussion back to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8389&quot; title=&quot;HBASE-8354 forces Namenode into loop with lease recovery requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8389&quot;&gt;&lt;del&gt;HBASE-8389&lt;/del&gt;&lt;/a&gt; first, then we can decide what to do here. &lt;/p&gt;</comment>
                            <comment id="13644806" author="varunsharma" created="Mon, 29 Apr 2013 19:57:58 +0000"  >&lt;p&gt;8389 is pretty much closed now and 8449 is for, how to get around this issue in trunk. So, after 8389, we need to decide if we will ever do  a real lease recovery in 0.94&lt;/p&gt;</comment>
                            <comment id="13648616" author="varunsharma" created="Fri, 3 May 2013 17:49:31 +0000"  >&lt;p&gt;Friendly ping...&lt;/p&gt;</comment>
                            <comment id="13648620" author="nkeywal" created="Fri, 3 May 2013 17:52:43 +0000"  >&lt;p&gt;I proposed this in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8389&quot; title=&quot;HBASE-8354 forces Namenode into loop with lease recovery requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8389&quot;&gt;&lt;del&gt;HBASE-8389&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;I see a possible common implementation (trunk / hbase 0.94)&lt;br/&gt;
    if &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4754&quot; title=&quot;Add an API in the namenode to mark a datanode as stale&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4754&quot;&gt;HDFS-4754&lt;/a&gt;, calls markAsStale to be sure this datanode won&apos;t be used.&lt;br/&gt;
    call recoverFileLease a first time&lt;br/&gt;
    if &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4525&quot; title=&quot;Provide an API for knowing that whether file is closed or not.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4525&quot;&gt;&lt;del&gt;HDFS-4525&lt;/del&gt;&lt;/a&gt; is available, call isFileClosed every second to detect that the recovery is done&lt;br/&gt;
    every 60s, call again recoverFileLease (either isFileClosed is missing, either we went into one of the bad scenario above).&lt;/p&gt;

&lt;p&gt;This would mean: no dataloss and a MTTR of:&lt;br/&gt;
    less than a minute if we have stale mode + &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4721&quot; title=&quot;Speed up lease/block recovery when DN fails and a block goes into recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4721&quot;&gt;&lt;del&gt;HDFS-4721&lt;/del&gt;&lt;/a&gt; + &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4754&quot; title=&quot;Add an API in the namenode to mark a datanode as stale&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4754&quot;&gt;HDFS-4754&lt;/a&gt; + &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4525&quot; title=&quot;Provide an API for knowing that whether file is closed or not.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4525&quot;&gt;&lt;del&gt;HDFS-4525&lt;/del&gt;&lt;/a&gt; + no retry in HDFS recoverLease or Varun&apos;s settings.&lt;br/&gt;
    around 12 minutes if we have none of the above. But that&apos;s what we have already without the stale mode imho.&lt;br/&gt;
    in the middle if we have a subset of the above patches and config.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="13658116" author="lhofhansl" created="Wed, 15 May 2013 06:41:11 +0000"  >&lt;p&gt;It looks like this will be a bit. Moving out to 0.94.9.&lt;/p&gt;</comment>
                            <comment id="13690750" author="lhofhansl" created="Fri, 21 Jun 2013 21:34:52 +0000"  >&lt;p&gt;How (if at all) is this related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8670&quot; title=&quot;[0.94] Backport HBASE-8449,HBASE-8204 and HBASE-8699 to 0.94 (Refactor recoverLease retries and pauses)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8670&quot;&gt;&lt;del&gt;HBASE-8670&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;No discussing for a long time, moving out to 0.94.10.&lt;br/&gt;
Do we need to do this at all in 0.94?&lt;/p&gt;</comment>
                            <comment id="13694488" author="varunsharma" created="Thu, 27 Jun 2013 04:47:19 +0000"  >&lt;p&gt;HBASE 8670 is a backport for HBASE 8449 which refactors lease recovery retries in wake of findings in HBASE 8389. &lt;/p&gt;

&lt;p&gt;In HBase 8389, we basically decided to give up lease recovery for 0.94 and accept data loss. The reason for giving up lease recovery was because it required a whole bunch of timeouts to fit in nicely or else you could have infinite race conditions and a super long recovery from region server failures. HBASE 8449 tried to fix it by refactoring these retries and timeouts a little bit and HBASE 8670 is trying to backport that refactoring.&lt;/p&gt;

&lt;p&gt;On the other hand, this one is a simple change which is allowing us to enable mandatory lease recovery through a config parameter who care about their data but also requires them to run with appropriate timeouts.&lt;/p&gt;

&lt;p&gt;I agree that this is not required for 0.94 but otherwise we may have data loss.&lt;/p&gt;</comment>
                            <comment id="13695163" author="stack" created="Thu, 27 Jun 2013 23:39:11 +0000"  >&lt;p&gt;+1 on adding this patche&apos;s config.  We should up the timeout too?  It is 4 seconds in 0.94.  Should we make it the 64 second change that was just made in trunk?&lt;/p&gt;

&lt;p&gt;    int waitingPeriod = conf.getInt(&quot;hbase.lease.recovery.waiting.period&quot;, 4000);&lt;/p&gt;
</comment>
                            <comment id="13704786" author="varunsharma" created="Wed, 10 Jul 2013 17:28:42 +0000"  >&lt;p&gt;So with 0.94 there are two cases:&lt;/p&gt;

&lt;p&gt;1) Without mandatory lease recovery&lt;br/&gt;
In this case, the above config could add upto 60s + 60s or 2 minutes to MTTR. This is because the first lease recovery will never truly happen without HDFS 4721 - the reason being that the dead datanode will be chosen as primary data node but then that data node is no longer heart beating - so the lease recovery will never truly commence. That adds 60 seconds, then another 60 second wait after the second invocation.&lt;/p&gt;

&lt;p&gt;For folks, who don&apos;t really care about lease recovery (minor data loss), I am not sure if changing the config is the write thign to do.&lt;/p&gt;

&lt;p&gt;2) With mandatory lease recovery&lt;br/&gt;
Again we add 120 seconds to MTTR, but then, we will end up enforcing real lease recovery even with the default hdfs timeouts.&lt;/p&gt;</comment>
                            <comment id="13709084" author="enis" created="Mon, 15 Jul 2013 22:38:40 +0000"  >&lt;p&gt;I am still -1 on this patch as it is. We cannot just default to possible data loss out of the box. I am not objecting to introducing the param, but we cannot default to bypassing recovery. &lt;/p&gt;

&lt;p&gt;If we get &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8670&quot; title=&quot;[0.94] Backport HBASE-8449,HBASE-8204 and HBASE-8699 to 0.94 (Refactor recoverLease retries and pauses)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8670&quot;&gt;&lt;del&gt;HBASE-8670&lt;/del&gt;&lt;/a&gt; in 0.94, and backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4721&quot; title=&quot;Speed up lease/block recovery when DN fails and a block goes into recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4721&quot;&gt;&lt;del&gt;HDFS-4721&lt;/del&gt;&lt;/a&gt; to hadoop-1.3, that would solve most of the problems for the hbase-0.94.10|0.96.0 + hdfs-1.3+|2.1 stack, right?&lt;/p&gt;</comment>
                            <comment id="13710573" author="lhofhansl" created="Wed, 17 Jul 2013 01:06:36 +0000"  >&lt;p&gt;Still discussing. Moving to 0.94.11.&lt;/p&gt;</comment>
                            <comment id="13727366" author="lhofhansl" created="Fri, 2 Aug 2013 05:44:47 +0000"  >&lt;p&gt;I am tempted to just close this.&lt;br/&gt;
Moving to 0.94.12, for now.&lt;/p&gt;</comment>
                            <comment id="13727959" author="varunsharma" created="Fri, 2 Aug 2013 18:57:25 +0000"  >&lt;p&gt;Can be closed since 8670 is now in..&lt;/p&gt;</comment>
                            <comment id="13728101" author="stack" created="Fri, 2 Aug 2013 20:55:34 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8670&quot; title=&quot;[0.94] Backport HBASE-8449,HBASE-8204 and HBASE-8699 to 0.94 (Refactor recoverLease retries and pauses)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8670&quot;&gt;&lt;del&gt;HBASE-8670&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12580483" name="8434.patch" size="659" author="varunsharma" created="Thu, 25 Apr 2013 06:05:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 25 Apr 2013 06:23:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>324905</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k1zb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325251</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>