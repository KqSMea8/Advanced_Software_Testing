<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:54:17 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8340/HBASE-8340.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8340] WAL compression handling of seeks seems to be either inefficient or incorrect</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8340</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In next(...):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (compressionContext != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; emptyCompressionContext) {
      emptyCompressionContext = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In seek()&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (compressionContext != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; emptyCompressionContext) {
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (next() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getPosition() == pos) {
          emptyCompressionContext = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
      }
...
reader.seek(pos);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, seek will seek the file directly if either any next, or any seek, has been called before.&lt;/p&gt;

&lt;p&gt;I am not sure what this code is for, but my best guess is that it is to populate the dictionary for compression.&lt;br/&gt;
If it is so, it would seem that one next() call (or even one seek() call) would not be enough, and seek must always use next(), otherwise it is incorrect.&lt;/p&gt;

&lt;p&gt;If we assume that one next() is enough to be able to use reader.seek, as the current code would seem to imply, then there&apos;s no need for the first seek to call next() in a loop - it can call next once and then do reader.seek.&lt;/p&gt;

&lt;p&gt;Note: even in case if all of this works fine because external usage creates the object and does one seek before any next-s, and no seeks after (the only bug-free pattern currently possible with both methods used if I&apos;m not mistaken), then the code needs to be tightened and bug potential removed.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12642337">HBASE-8340</key>
            <summary>WAL compression handling of seeks seems to be either inefficient or incorrect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sershe">Sergey Shelukhin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Apr 2013 22:56:10 +0000</created>
                <updated>Sat, 7 Feb 2015 04:40:38 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13630767" author="yuzhihong@gmail.com" created="Fri, 12 Apr 2013 23:46:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;does one seek before any next-s, and no seeks after &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think this is the case.&lt;/p&gt;

&lt;p&gt;Take a look at ReplicationSource#readAllEntriesToReplicateOrNextFile():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.repLogReader.seek();
    HLog.Entry entry =
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.repLogReader.readNextAndSetPosition(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.entriesArray, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.currentNbEntries);
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (entry != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13631976" author="jdcryans" created="Mon, 15 Apr 2013 18:23:36 +0000"  >&lt;p&gt;You are right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;Sergey Shelukhin&lt;/a&gt;, this piece of code was written only with replication&apos;s use case in mind when log compression is turned on. It doesn&apos;t support seeking back either.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If we assume that one next() is enough to be able to use reader.seek, as the current code would seem to imply, then there&apos;s no need for the first seek to call next() in a loop - it can call next once and then do reader.seek.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure what you mean here, calling next() just once we only populate the dict with whatever entries were needed to write the first WAL entry, and then you miss all the other entries.&lt;/p&gt;</comment>
                            <comment id="13631991" author="sershe" created="Mon, 15 Apr 2013 18:33:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure what you mean here, calling next() just once we only populate the dict with whatever entries were needed to write the first WAL entry, and then you miss all the other entries.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The current code sets the boolean flag after one next, though, that&apos;s what I meant&lt;/p&gt;</comment>
                            <comment id="13632039" author="jdcryans" created="Mon, 15 Apr 2013 19:01:35 +0000"  >&lt;p&gt;The way I read it, emptyCompressionContext is set to false only when we were able to next() all the way to the seek position.&lt;/p&gt;</comment>
                            <comment id="13632184" author="sershe" created="Mon, 15 Apr 2013 21:01:17 +0000"  >&lt;p&gt;According to next(), it will be set to false after any next(), so if seek is done after next(), or after previous seek it will be already false.&lt;/p&gt;</comment>
                            <comment id="13632246" author="jdcryans" created="Mon, 15 Apr 2013 21:46:51 +0000"  >&lt;p&gt;Ah ok yes I see, sounds like we may not need to change emptyCompressionContext in seek then. We still need to call next() in a loop tho.&lt;/p&gt;</comment>
                            <comment id="14269131" author="clehene" created="Thu, 8 Jan 2015 10:15:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;Sergey Shelukhin&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdcryans&quot; class=&quot;user-hover&quot; rel=&quot;jdcryans&quot;&gt;Jean-Daniel Cryans&lt;/a&gt; is this still the case? Is it worth a refresh?&lt;/p&gt;</comment>
                            <comment id="14269920" author="sershe" created="Thu, 8 Jan 2015 19:32:48 +0000"  >&lt;p&gt;Frankly speaking I don&apos;t remember &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; if the code is the same then these considerations still hold, but I don&apos;t have enough context in my head anymore&lt;/p&gt;</comment>
                            <comment id="14310546" author="lhofhansl" created="Sat, 7 Feb 2015 04:40:38 +0000"  >&lt;p&gt;Can we close this then?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 12 Apr 2013 23:46:56 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322751</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1jop3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>323096</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>