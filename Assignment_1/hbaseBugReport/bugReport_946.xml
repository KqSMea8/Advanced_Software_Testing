<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:49:03 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-946/HBASE-946.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-946] Row with 55k deletes timesout scanner lease</title>
                <link>https://issues.apache.org/jira/browse/HBASE-946</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Made a blocker because it was found by Jon Gray (smile)&lt;/p&gt;

&lt;p&gt;So, Jon Gray has a row with 55k deletes all in the same row.  When he tries to scan, his scanner timesout when it gets to this row.  The root cause is the mechanism we use to make sure a delete in a new store file overshadows an entry at same address in an old file.   We accumulate a List of all deletes encountered.  Before adding a delete to the List, we check if already a deleted.  This check is whats killing us.  One issue is that its doing super inefficient check of whether table is root but even fixing this inefficency &amp;#8211; and then removing the check for root since its redundant we&apos;re still too slow.&lt;/p&gt;

&lt;p&gt;Chatting with Jim K, he suggested that ArrayList check is linear.  Changing the aggregation of deletes to instead use HashSet makes all run an order of magnitude faster.&lt;/p&gt;

&lt;p&gt;Also part of this issue, need to figure why on compaction we are not letting go of these deletes.&lt;/p&gt;

&lt;p&gt;Filing this issue against 0.18.1 so it gets into the RC2 (after chatting w/ J-D and JK &amp;#8211; J-D is seeing the issue also).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12406947">HBASE-946</key>
            <summary>Row with 55k deletes timesout scanner lease</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Oct 2008 20:03:17 +0000</created>
                <updated>Sun, 13 Sep 2009 22:26:29 +0000</updated>
                            <resolved>Wed, 22 Oct 2008 18:58:10 +0000</resolved>
                                                    <fixVersion>0.18.1</fixVersion>
                    <fixVersion>0.19.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12641570" author="jdcryans" created="Tue, 21 Oct 2008 20:20:36 +0000"  >&lt;p&gt;Issue is easy to recreate. In the shell : &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(1..500000).each &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; |i|
put &apos;t1&apos;, &apos;r1&apos;, &apos;f1:&apos;, &apos;value&apos;
delete &apos;t1&apos;, &apos;r1&apos;, &apos;f1:&apos;
end
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then see the speed of that random read : &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
hbase(main):017:0&amp;gt; put &apos;t1&apos;, &apos;r1&apos;, &apos;f1:&apos;, &apos;value&apos;
0 row(s) in 0.0020 seconds
hbase(main):018:0&amp;gt; get &apos;t1&apos;, &apos;r1&apos;                
COLUMN                       CELL                                                                             
 f1:                         timestamp=1224620378984, value=value                                             
1 row(s) in 0.1090 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;0.1 sec instead of 0.01&lt;/p&gt;</comment>
                            <comment id="12641591" author="stack" created="Tue, 21 Oct 2008 21:07:34 +0000"  >&lt;p&gt;I forgot how deletes work.  We do not just let go of deletes on major compaction.  We only let go of cells if their timestamp exceeds the TTL or if there are &amp;gt; MAX_VERSIONS of the cell.  We do it this way because we don&apos;t want Scanners to get different answers just because a major compaction happened between two runs.&lt;/p&gt;</comment>
                            <comment id="12641597" author="stack" created="Tue, 21 Oct 2008 21:12:49 +0000"  >&lt;p&gt;Here is code I added to HStore to do store-scoped iteration and compactions:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: src/java/org/apache/hadoop/hbase/regionserver/HStore.java
===================================================================
--- src/java/org/apache/hadoop/hbase/regionserver/HStore.java   (revision 706719)
+++ src/java/org/apache/hadoop/hbase/regionserver/HStore.java   (working copy)
@@ -47,6 +47,7 @@
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HConstants;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HRegionInfo;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HStoreKey;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HTableDescriptor;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.RemoteExceptionHandler;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.filter.RowFilterInterface;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.io.Cell;
@@ -1977,4 +1978,40 @@
   HRegionInfo getHRegionInfo() {
     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.info; 
   }         
+
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+    Path storedir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/streams&quot;&lt;/span&gt;);
+    HTableDescriptor htd = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTableDescriptor(&lt;span class=&quot;code-quote&quot;&gt;&quot;streams&quot;&lt;/span&gt;);
+    HColumnDescriptor hcd = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HColumnDescriptor(&lt;span class=&quot;code-quote&quot;&gt;&quot;items:&quot;&lt;/span&gt;);
+    htd.addFamily(hcd);
+    htd.addFamily(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HColumnDescriptor(&lt;span class=&quot;code-quote&quot;&gt;&quot;content:&quot;&lt;/span&gt;));
+    HRegionInfo hri = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HRegionInfo(htd, HConstants.EMPTY_BYTE_ARRAY,
+      HConstants.EMPTY_BYTE_ARRAY, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 1);
+    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; startTime = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
+    HBaseConfiguration c = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HBaseConfiguration();
+    HStore store = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStore(storedir, hri, hcd, FileSystem.getLocal(c), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,
+      c, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
+    store.compact(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
+    HStoreKey hsk = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey();
+    SortedMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [], Cell&amp;gt; value =
+      &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [], Cell&amp;gt;(Bytes.BYTES_COMPARATOR);
+    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [][] columns = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [1][];
+    columns[0] = Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;items:.*&quot;&lt;/span&gt;);
+    InternalScanner s = store.getScanner(HConstants.LATEST_TIMESTAMP, columns,
+      HConstants.EMPTY_BYTE_ARRAY, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
+    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; rows = 0;
+    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; values = 0;
+    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(s.next(hsk, value)) {
+        rows++;
+        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot; + rows + &quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot; + hsk + &quot;&lt;/span&gt; &quot; + value.size());
+        values += value.size();
+        value.clear();
+      }
+      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;TIME: &quot;&lt;/span&gt; + (&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() - startTime) + &lt;span class=&quot;code-quote&quot;&gt;&quot; rows=&quot;&lt;/span&gt; + rows + &lt;span class=&quot;code-quote&quot;&gt;&quot;, values=&quot;&lt;/span&gt; + values);
+    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
+      s.close();
+      store.close();
+    }
+  }
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should have able to do it jruby.  Didn&apos;t try. &lt;/p&gt;</comment>
                            <comment id="12641620" author="stack" created="Tue, 21 Oct 2008 21:50:39 +0000"  >&lt;p&gt;I want to apply this to branch and trunk (Running unit tests now)&lt;/p&gt;</comment>
                            <comment id="12641636" author="stack" created="Tue, 21 Oct 2008 22:27:04 +0000"  >&lt;p&gt;Passes all tests locally.&lt;/p&gt;</comment>
                            <comment id="12641642" author="jdcryans" created="Tue, 21 Oct 2008 22:34:04 +0000"  >&lt;p&gt;Reviewed, +1&lt;/p&gt;</comment>
                            <comment id="12641646" author="apurtell" created="Tue, 21 Oct 2008 22:41:53 +0000"  >&lt;p&gt;Tested, +1&lt;/p&gt;</comment>
                            <comment id="12641738" author="streamy" created="Wed, 22 Oct 2008 08:24:38 +0000"  >&lt;p&gt;Fixes issue&lt;/p&gt;

&lt;p&gt;Thanks stack!&lt;/p&gt;</comment>
                            <comment id="12641941" author="stack" created="Wed, 22 Oct 2008 18:58:10 +0000"  >&lt;p&gt;Committed branch and trunk (Thanks for the reviews lads).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12392608" name="946.patch" size="9367" author="stack" created="Tue, 21 Oct 2008 21:50:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 21 Oct 2008 20:20:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25490</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0haf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98950</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>