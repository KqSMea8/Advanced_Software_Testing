<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:06:55 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3047/HBASE-3047.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3047] If new master crashes, restart is messy</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3047</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;If master crashes, the cluster-is-up flag is left stuck on.&lt;/p&gt;

&lt;p&gt;On restart of cluster, regionservers may come up before the master.  They&apos;ll have registered themselves in zk by time the master assumes its role and master will think its joining an up and running cluster when in fact this is a fresh startup.  Other probs. are that there&apos;ll be a root region that is bad up in zk.  Same for meta and at moment we&apos;re not handling bad root and meta very well.&lt;/p&gt;

&lt;p&gt;Here&apos;s sample of kinda of issues we&apos;re running into:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-09-25 23:53:13,938 FATAL org.apache.hadoop.hbase.master.HMaster:
Unhandled exception. Starting shutdown.
java.io.IOException: Call to /10.20.20.188:60020 failed on local
exception: java.io.IOException: Connection reset by peer
   at org.apache.hadoop.hbase.ipc.HBaseClient.wrapException(HBaseClient.java:781)
   at org.apache.hadoop.hbase.ipc.HBaseClient.call(HBaseClient.java:750)
   at org.apache.hadoop.hbase.ipc.HBaseRPC$Invoker.invoke(HBaseRPC.java:255)
   at $Proxy1.getProtocolVersion(Unknown Source)
   at org.apache.hadoop.hbase.ipc.HBaseRPC.getProxy(HBaseRPC.java:412)
   at org.apache.hadoop.hbase.ipc.HBaseRPC.getProxy(HBaseRPC.java:388)
   at org.apache.hadoop.hbase.ipc.HBaseRPC.getProxy(HBaseRPC.java:435)
   at org.apache.hadoop.hbase.ipc.HBaseRPC.waitForProxy(HBaseRPC.java:345)
   at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getHRegionConnection(HConnectionManager.java:889)
   at org.apache.hadoop.hbase.catalog.CatalogTracker.getCachedConnection(CatalogTracker.java:350)
   at org.apache.hadoop.hbase.catalog.CatalogTracker.getRootServerConnection(CatalogTracker.java:209)
   at org.apache.hadoop.hbase.catalog.CatalogTracker.getMetaServerConnection(CatalogTracker.java:241)
   at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMeta(CatalogTracker.java:286)
   at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMetaServerConnectionDefault(CatalogTracker.java:326)
   at org.apache.hadoop.hbase.catalog.MetaReader.fullScan(MetaReader.java:157)
   at org.apache.hadoop.hbase.catalog.MetaReader.fullScan(MetaReader.java:140)
   at org.apache.hadoop.hbase.master.AssignmentManager.rebuildUserRegions(AssignmentManager.java:753)
   at org.apache.hadoop.hbase.master.AssignmentManager.processFailover(AssignmentManager.java:174)
   at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:314)
Caused by: java.io.IOException: Connection reset by peer
   at sun.nio.ch.FileDispatcher.read0(Native Method)
   at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:21)
   at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:233)
   at sun.nio.ch.IOUtil.read(IOUtil.java:206)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Notice, we think its a case of processFailover so we think we can just scan meta to fixup our inmemory picture of the running cluster, only the scan of meta fails because the meta isn not assigned.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12475350">HBASE-3047</key>
            <summary>If new master crashes, restart is messy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Sep 2010 21:30:40 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:36 +0000</updated>
                            <resolved>Thu, 30 Sep 2010 03:31:55 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12915932" author="stack" created="Tue, 28 Sep 2010 21:42:17 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
M src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java
  Add test of &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; where HRegionInterface connection &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; a
  ConnectionException. Also tests two &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; verify root and meta 
  locations added to CatalogTracker.
M src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
  Change order in which we start up trackers in ZK.  Also add blocking
  until master is up to make it less likely we&apos;ll start before master
  comes up, especially around the cluster start up situation.
M src/main/java/org/apache/hadoop/hbase/master/HMaster.java
  Introduce &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; state on startup, the &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; where the cluster is
  NOT a fresh startup and its NOT a cluster where all is fully
  assigned.  The repair the master needs run to fixup &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;
  state is not yet done; we &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; a NotImplementedException &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
  now.  TODO.  Added &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; isRunningCluster checker used figuring
  what the cluster condition is when master is joining.  Not
  comprehensive but good enough &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; now.
M src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java
  Javadoc.
  Added &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; verifyRootRegionLocation and verifyMetaRegionLocation.
  Needed to verify whats in zk is actually locations of catalog
  regions.
M src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java
  Add fact that the verifying method, getRegionInfo, can &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt;
  ConnectException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12915967" author="hbasereviewboard" created="Tue, 28 Sep 2010 23:15:41 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/915/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase, stack and Jonathan Gray.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is patch from Stack, just putting up on rb.&lt;/p&gt;

&lt;p&gt;M src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java&lt;br/&gt;
  Add test of case where HRegionInterface connection throws a&lt;br/&gt;
  ConnectionException. Also tests two new verify root and meta &lt;br/&gt;
  locations added to CatalogTracker.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
  Change order in which we start up trackers in ZK.  Also add blocking&lt;br/&gt;
  until master is up to make it less likely we&apos;ll start before master&lt;br/&gt;
  comes up, especially around the cluster start up situation.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
  Introduce new state on startup, the case where the cluster is&lt;br/&gt;
  NOT a fresh startup and its NOT a cluster where all is fully&lt;br/&gt;
  assigned.  The repair the master needs run to fixup this new&lt;br/&gt;
  state is not yet done; we throw a NotImplementedException for&lt;br/&gt;
  now.  TODO.  Added new isRunningCluster checker used figuring&lt;br/&gt;
  what the cluster condition is when master is joining.  Not&lt;br/&gt;
  comprehensive but good enough for now.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;br/&gt;
  Javadoc.&lt;br/&gt;
  Added new verifyRootRegionLocation and verifyMetaRegionLocation.&lt;br/&gt;
  Needed to verify whats in zk is actually locations of catalog&lt;br/&gt;
  regions.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java&lt;br/&gt;
  Add fact that the verifying method, getRegionInfo, can throw&lt;br/&gt;
  ConnectException&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3047&quot; title=&quot;If new master crashes, restart is messy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3047&quot;&gt;&lt;del&gt;HBASE-3047&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3047&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3047&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 1002359 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java 1002359 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/915/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12915992" author="hbasereviewboard" created="Wed, 29 Sep 2010 01:11:25 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/915/#review1349&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#review1349&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Overall this looks like a good improvement over what we had.  I&apos;m still a little confused about isRunningCluster (or isProperRunningCluster per comments).&lt;/p&gt;

&lt;p&gt;Repeat from inline comments, but, is there ever a time a single region is deployed and we don&apos;t want to trigger the failover codepath?&lt;/p&gt;

&lt;p&gt;Isn&apos;t the case we&apos;re really protecting against here that the cluster was not shutdown properly so the cluster status flag is up when it shouldn&apos;t be?&lt;/p&gt;

&lt;p&gt;And does this handle case that cluster is killed quickly and then restarted again so the master ephemeral node is actually still there?  Then the RS will have master node and cluster up node and startup but potentially without a real master?&lt;/p&gt;


&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4482&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4482&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Why is this an &quot;implementation&quot;?  Doesn&apos;t the HRI represent the actual connection object?  I get that it&apos;s an implementation of HRI but normally that would be used in class names implementing?  No biggie, should just be consistent and seems a weird name to me (I think I was referring to this stuff as &quot;connection&quot; elsewhere in the class in method names/variable names)&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4481&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4481&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Is this really the exception we want to throw (commons.lang)?  Or this is just short-term temporary?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4483&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4483&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    yay thanks&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4484&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4484&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    So case that we are adding for here (but just throwing exception for now) is master came up, did not think it was fresh cluster (because cluster status flag in zk up? maybe note in comments above?), but we determine the cluster was not running because ROOT and META are not assigned.&lt;/p&gt;

&lt;p&gt;    What about case where other regions are assigned?  Should this check actually be whether &lt;em&gt;any&lt;/em&gt; regions are assigned?  I think we discussed this, and I think looking for root/meta covers most cases, but maybe add a TODO?&lt;/p&gt;

&lt;p&gt;    Though, even in failover case, we&apos;ll need to handle ROOT/META not being properly assigned, so if &lt;em&gt;any&lt;/em&gt; regions are assigned we would trigger failover, if no regions assigned we would assume it actually is a cluster startup and go into the branch of code which currently throws the exception.&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4485&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4485&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    javadoc about what this method does to determine if it&apos;s running cluster&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4486&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4486&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    So this method would be &quot;proper running cluster&quot;?&lt;/p&gt;

&lt;p&gt;    Isn&apos;t it the case that if a single region is deployed anywhere we are not in startup, we are failover?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4487&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4487&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    looks good&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12916007" author="hbasereviewboard" created="Wed, 29 Sep 2010 04:01:25 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/915/#review1353&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#review1353&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Here&apos;s a few comments on yours.&lt;/p&gt;

&lt;p&gt;Actually, testing this patch on cluster brought up some issues.  I think I should recast.  I have some ideas on how.  v2 coming.  Will incorporate your belows.&lt;/p&gt;


&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4495&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4495&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I can change it (you get my intent but it still confused so I should change it).&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4496&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4496&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Yeah, what you say.  Let me fix up comments.&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/915/#comment4497&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#comment4497&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    will do&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12916050" author="hbasereviewboard" created="Wed, 29 Sep 2010 06:40:28 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/915/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-09-28 23:31:22.975377)&lt;/p&gt;


&lt;p&gt;Review request for hbase, stack and Jonathan Gray.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Here, this should be more robust.  Your comments should be addressed also.  For sure, AM#processFailover has holes &amp;#8211; e.g. what if a regionserver crashed while new master was coming up &amp;#8211; but lets address that in another issue.  Below are notes on changes made since v1 of the patch.&lt;/p&gt;

&lt;p&gt;M src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java&lt;br/&gt;
  Change here was because saw a case where we hung for ever (my guess is that remaining became equal to NO_TIMEOUT).  Redid the logic here.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/regionserver/Leases.java&lt;br/&gt;
  Set this thread to be daemon.  Have seen it hold up RS shutdowns.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java&lt;br/&gt;
  Renamed the initialize method as createInitialFileSystemLayout, made it private it and called it from constructor.  Its idempotent, cheap, and no need others should be concerned with these mechanics; encapsulate it.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;br/&gt;
  Removed freshClusterStartup flag.  Now, let any &apos;unknown&apos; server in and register it UNLESS its a dead server (fixed up expiration so we add to dead servers BEFORE we remove from online servers).  Have waitForRegionServers return count of regions out on cluster.  This will be 0 if servers are coming in with clean regionServerStartup but if they came in and were registered on a regionServerReport, then they&apos;ll have a filled out HServerLoad with a count of regions.  Use count of regions as way to tell if regions out on cluster or not.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
  Removed freshClusterStartup.  Added logging of state of cluster-up flag, and # of regionservers out on cluster.  Use count of regions out on cluster to figure if we are to do assign of all user regions or if instead we are to do process failover.  Added splitting of WALs always and check and reassign of root and meta whether fresh start up or failover.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
  Added notes on holes in processFailover.&lt;br/&gt;
M src/main/resources/hbase-default.xml&lt;br/&gt;
  Set checkin down from 5 to 3 seconds again.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is patch from Stack, just putting up on rb.&lt;/p&gt;

&lt;p&gt;M src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java&lt;br/&gt;
  Add test of case where HRegionInterface connection throws a&lt;br/&gt;
  ConnectionException. Also tests two new verify root and meta &lt;br/&gt;
  locations added to CatalogTracker.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
  Change order in which we start up trackers in ZK.  Also add blocking&lt;br/&gt;
  until master is up to make it less likely we&apos;ll start before master&lt;br/&gt;
  comes up, especially around the cluster start up situation.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
  Introduce new state on startup, the case where the cluster is&lt;br/&gt;
  NOT a fresh startup and its NOT a cluster where all is fully&lt;br/&gt;
  assigned.  The repair the master needs run to fixup this new&lt;br/&gt;
  state is not yet done; we throw a NotImplementedException for&lt;br/&gt;
  now.  TODO.  Added new isRunningCluster checker used figuring&lt;br/&gt;
  what the cluster condition is when master is joining.  Not&lt;br/&gt;
  comprehensive but good enough for now.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;br/&gt;
  Javadoc.&lt;br/&gt;
  Added new verifyRootRegionLocation and verifyMetaRegionLocation.&lt;br/&gt;
  Needed to verify whats in zk is actually locations of catalog&lt;br/&gt;
  regions.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java&lt;br/&gt;
  Add fact that the verifying method, getRegionInfo, can throw&lt;br/&gt;
  ConnectException&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3047&quot; title=&quot;If new master crashes, restart is messy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3047&quot;&gt;&lt;del&gt;HBASE-3047&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3047&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3047&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Leases.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java 1001981 &lt;br/&gt;
  trunk/src/main/resources/hbase-default.xml 1001981 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java 1001981 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/915/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12916210" author="hbasereviewboard" created="Wed, 29 Sep 2010 17:31:37 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/915/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-09-29 10:23:49.845051)&lt;/p&gt;


&lt;p&gt;Review request for hbase, stack and Jonathan Gray.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;More cleanup&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is patch from Stack, just putting up on rb.&lt;/p&gt;

&lt;p&gt;M src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java&lt;br/&gt;
  Add test of case where HRegionInterface connection throws a&lt;br/&gt;
  ConnectionException. Also tests two new verify root and meta &lt;br/&gt;
  locations added to CatalogTracker.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
  Change order in which we start up trackers in ZK.  Also add blocking&lt;br/&gt;
  until master is up to make it less likely we&apos;ll start before master&lt;br/&gt;
  comes up, especially around the cluster start up situation.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
  Introduce new state on startup, the case where the cluster is&lt;br/&gt;
  NOT a fresh startup and its NOT a cluster where all is fully&lt;br/&gt;
  assigned.  The repair the master needs run to fixup this new&lt;br/&gt;
  state is not yet done; we throw a NotImplementedException for&lt;br/&gt;
  now.  TODO.  Added new isRunningCluster checker used figuring&lt;br/&gt;
  what the cluster condition is when master is joining.  Not&lt;br/&gt;
  comprehensive but good enough for now.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;br/&gt;
  Javadoc.&lt;br/&gt;
  Added new verifyRootRegionLocation and verifyMetaRegionLocation.&lt;br/&gt;
  Needed to verify whats in zk is actually locations of catalog&lt;br/&gt;
  regions.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java&lt;br/&gt;
  Add fact that the verifying method, getRegionInfo, can throw&lt;br/&gt;
  ConnectException&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3047&quot; title=&quot;If new master crashes, restart is messy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3047&quot;&gt;&lt;del&gt;HBASE-3047&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3047&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3047&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/RemoteExceptionHandler.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Leases.java 1001981 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java 1001981 &lt;br/&gt;
  trunk/src/main/resources/hbase-default.xml 1001981 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java 1001981 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/915/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12916291" author="hbasereviewboard" created="Wed, 29 Sep 2010 22:35:49 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/915/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-09-29 15:12:30.449220)&lt;/p&gt;


&lt;p&gt;Review request for hbase, stack and Jonathan Gray.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;New version.  Comes of back and forth w/ Jon&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is patch from Stack, just putting up on rb.&lt;/p&gt;

&lt;p&gt;M src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java&lt;br/&gt;
  Add test of case where HRegionInterface connection throws a&lt;br/&gt;
  ConnectionException. Also tests two new verify root and meta &lt;br/&gt;
  locations added to CatalogTracker.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
  Change order in which we start up trackers in ZK.  Also add blocking&lt;br/&gt;
  until master is up to make it less likely we&apos;ll start before master&lt;br/&gt;
  comes up, especially around the cluster start up situation.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
  Introduce new state on startup, the case where the cluster is&lt;br/&gt;
  NOT a fresh startup and its NOT a cluster where all is fully&lt;br/&gt;
  assigned.  The repair the master needs run to fixup this new&lt;br/&gt;
  state is not yet done; we throw a NotImplementedException for&lt;br/&gt;
  now.  TODO.  Added new isRunningCluster checker used figuring&lt;br/&gt;
  what the cluster condition is when master is joining.  Not&lt;br/&gt;
  comprehensive but good enough for now.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;br/&gt;
  Javadoc.&lt;br/&gt;
  Added new verifyRootRegionLocation and verifyMetaRegionLocation.&lt;br/&gt;
  Needed to verify whats in zk is actually locations of catalog&lt;br/&gt;
  regions.&lt;br/&gt;
M src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java&lt;br/&gt;
  Add fact that the verifying method, getRegionInfo, can throw&lt;br/&gt;
  ConnectException&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3047&quot; title=&quot;If new master crashes, restart is messy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3047&quot;&gt;&lt;del&gt;HBASE-3047&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3047&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3047&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/RemoteExceptionHandler.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/mapreduce/package-info.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Leases.java 1002359 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java 1002359 &lt;br/&gt;
  trunk/src/main/resources/hbase-default.xml 1002359 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java 1002359 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/915/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12916296" author="hbasereviewboard" created="Wed, 29 Sep 2010 22:55:58 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/915/#review1360&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/915/#review1360&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;Commit!  Just fix the missing insertion into deadServers map on commit as discussed.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12916358" author="stack" created="Thu, 30 Sep 2010 03:31:55 +0000"  >&lt;p&gt;Thanks for the review Jon.  The not-putting-servername-into-deadservers though big comment about how important doing so at that point was a good catch.  Committed earlier to day.&lt;/p&gt;</comment>
                            <comment id="12916368" author="stack" created="Thu, 30 Sep 2010 04:07:54 +0000"  >&lt;p&gt;What I committed &amp;#8211; last diff up on review board plus jon suggstion.&lt;/p&gt;</comment>
                            <comment id="15017293" author="lars_francke" created="Fri, 20 Nov 2015 12:42:36 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12455971" name="3047-final.txt" size="45698" author="stack" created="Thu, 30 Sep 2010 04:07:54 +0000"/>
                            <attachment id="12455877" name="3047.txt" size="14959" author="stack" created="Tue, 28 Sep 2010 21:42:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 28 Sep 2010 23:15:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26612</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hkhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100581</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>