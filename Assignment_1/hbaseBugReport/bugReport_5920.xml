<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:32:09 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5920/HBASE-5920.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5920] New Compactions Logic can silently prevent user-initiated compactions from occurring</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5920</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;There seem to be some tuning settings in which manually triggered major compactions will do nothing, including loggic&lt;/p&gt;

&lt;p&gt;From Store.java in the function&lt;br/&gt;
  List&amp;lt;StoreFile&amp;gt; compactSelection(List&amp;lt;StoreFile&amp;gt; candidates)&lt;/p&gt;

&lt;p&gt;When a user manually triggers a compaction, this follows the same logic as a normal compaction check.  when a user manually triggers a major compaction, something similar happens.  Putting this all together:&lt;/p&gt;

&lt;p&gt;1. If a user triggers a major compaction, this is checked against a max files threshold (hbase.hstore.compaction.max). If the number of storefiles to compact is &amp;gt; max files, then we downgrade to a minor compaction&lt;br/&gt;
2. If we are in a minor compaction, we do the following checks:&lt;br/&gt;
   a. If the file is less than a minimum size (hbase.hstore.compaction.min.size) we automatically include it&lt;br/&gt;
   b. Otherwise, we check how the size compares to the next largest size.  based on hbase.hstore.compaction.ratio.  &lt;br/&gt;
  c. If the number of files included is less than a minimum count (hbase.hstore.compaction.min) then don&apos;t compact.&lt;br/&gt;
In many of the exit strategies, we aren&apos;t seeing an error message.&lt;br/&gt;
The net-net of this is that if we have a mix of very large and very small files, we may end up having too many files to do a major compact, but too few files to do a minor compact.&lt;/p&gt;

&lt;p&gt;I&apos;m trying to go through and see if I&apos;m understanding things correctly, but this seems like the bug&lt;/p&gt;

&lt;p&gt;To put it another way&lt;br/&gt;
2012-05-02 20:09:36,389 DEBUG org.apache.hadoop.hbase.regionserver.CompactSplitThread: Large Compaction requested: regionName=str,44594594594594592,1334939064521.f7aed25b55d4d7988af763bede9ce74e., store&lt;br/&gt;
Name=c, fileCount=15, fileSize=1.5g (20.2k, 362.5m, 155.3k, 3.0m, 30.7k, 361.2m, 6.9m, 4.7m, 14.7k, 363.4m, 30.9m, 3.2m, 7.3k, 362.9m, 23.5m), priority=-9, time=3175046817624398; Because: Recursive enqueue; compaction_queue=(59:0), split_queue=0&lt;/p&gt;

&lt;p&gt;When we had a minimum compaction size of 128M, and default settings for hbase.hstore.compaction.min,hbase.hstore.compaction.max,hbase.hstore.compaction.ratio, we were not getting a compaction to run even if we ran&lt;br/&gt;
major_compact &apos;str,44594594594594592,1334939064521.f7aed25b55d4d7988af763bede9ce74e.&apos; from the ruby shell.  Note that we had many tiny regions (20k, 155k, 3m, 30k,..) and several large regions (362.5m,361.2m,363.4m,362.9m).  I think the bimodal nature of the sizes prevented us from doing a compaction.&lt;br/&gt;
I&apos;m not 100% sure where this errored out because when I manually triggered a compaction, I did not see&lt;br/&gt;
&apos;      // if we don&apos;t have enough files to compact, just wait             &lt;br/&gt;
      if (filesToCompact.size() &amp;lt; this.minFilesToCompact) {              &lt;br/&gt;
        if (LOG.isDebugEnabled()) &lt;/p&gt;
{                                      
          LOG.debug(&quot;Skipped compaction of &quot; + this.storeNameStr         
            + &quot;.  Only &quot; + (end - start) + &quot; file(s) of size &quot;           
            + StringUtils.humanReadableInt(totalSize)                    
            + &quot; have met compaction criteria.&quot;);                         
        }
&lt;p&gt;                                                                &lt;br/&gt;
&apos; &lt;br/&gt;
being printed in the logs (and I know DEBUG logging was enabled because I saw this elsewhere).  &lt;/p&gt;

&lt;p&gt;I&apos;d be happy with better error messages when we decide not to compact for user enabled compactions.&lt;br/&gt;
I&apos;d also like to see some override that says &quot;user triggered major compaction always occurs&quot;, but maybe that&apos;s a bad idea for other reasons.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12553663">HBASE-5920</key>
            <summary>New Compactions Logic can silently prevent user-initiated compactions from occurring</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dwollen">Derek Wollenstein</assignee>
                                    <reporter username="dwollen">Derek Wollenstein</reporter>
                        <labels>
                            <label>compaction</label>
                    </labels>
                <created>Wed, 2 May 2012 20:14:15 +0000</created>
                <updated>Fri, 25 May 2012 09:55:37 +0000</updated>
                            <resolved>Fri, 18 May 2012 22:23:05 +0000</resolved>
                                    <version>0.92.1</version>
                                                    <component>Client</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13266932" author="nspiegelberg" created="Wed, 2 May 2012 21:38:54 +0000"  >&lt;p&gt;tl;dr. The old master had a debug line about issuing major compactions.  This is removed in the new master and should be added back in &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Couple notes about your cluster:&lt;br/&gt;
1. Your cluster is obviously in a very bad state.  &quot;Recursive enqueue&quot; means that your files/store have been huge and the RS is trying to aggressively cut them down.  It can&apos;t do an online major compaction until the state of the cluster is better.&lt;br/&gt;
2. &quot;compaction_queue=(59:0)&quot; means that all compactions are being upgraded to the large queue (59 large, 0 small).  Either this is because all regions are congested or because you have &quot;hbase.regionserver.thread.compaction.throttle&quot; improperly configured.  See &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5867&quot; title=&quot;Improve Compaction Throttle Default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5867&quot;&gt;&lt;del&gt;HBASE-5867&lt;/del&gt;&lt;/a&gt;.  Optimally, all your tiny regions should go in one queue and substantial compactions on large regions should go in another.&lt;/p&gt;

&lt;p&gt;That said, let&apos;s talk about the compaction logic.  User-issued majors are asynchronous.  They are not guaranteed to happen immediately, just when the cluster is ready to handle the major compaction.  The RS will recursively do minor compactions until the cluster is in a good state and then do a major.  The major compaction flag will persist until this happens, but will not currently persist across reboots or region moves.&lt;/p&gt;</comment>
                            <comment id="13266980" author="dwollen" created="Wed, 2 May 2012 22:47:31 +0000"  >&lt;p&gt;Nicolas &amp;#8211;&lt;/p&gt;

&lt;p&gt;Regarding the queue size &amp;#8211; no question.  This is the result of aggressively disabling compactions with the intend of manually triggering them later, and then waiting two weeks.  I was just upset when all the manually triggered compactions went into a black hole.&lt;/p&gt;

&lt;p&gt;Before modifying all these throttling settings, I was getting no information whatsoever in logs.  the only reason I even knew the RPC worked was that when I turned on IPC debug logging I got a message saying that the request was serviced.&lt;/p&gt;

&lt;p&gt;All regions definitely were congested: this is because automatic compactions hadn&apos;t been running, and we weren&apos;t able to trigger manual compactions.  We were going to be running these 1 region at a time, but since we had to restart the regionservers to get new settings (correct me if this is wrong), we ended up enqueueing all of the 2-week-delayed compactions at once.&lt;/p&gt;</comment>
                            <comment id="13270795" author="stack" created="Tue, 8 May 2012 20:26:17 +0000"  >&lt;p&gt;@Derek You have a patch to do better logging when a manual request is made?  It should overrule all logic, at least at the extremes for cases like yours (major compact once a week during down times).&lt;/p&gt;</comment>
                            <comment id="13272097" author="dwollen" created="Thu, 10 May 2012 05:30:12 +0000"  >&lt;p&gt;I don&apos;t have a patch right now, but let me try to get something ready by early next week &amp;#8211; this should be relatively simple to push through.  Honestly, I could even deal with the delay if it wasn&apos;t just something so silent from the perspective of the client.  I only verified that my call really worked by turning on RPC Debug logging.&lt;/p&gt;</comment>
                            <comment id="13275988" author="dwollen" created="Tue, 15 May 2012 17:10:52 +0000"  >&lt;p&gt;This patch makes the following changes:&lt;br/&gt;
1) Trace-level logging whenever a compaction is requested&lt;br/&gt;
2) Debug-level logging whenever compaction is changed&lt;br/&gt;
3) If a user requests a major compaction, this will stay a major compaction even if it violated max files (easy to take this part out)&lt;br/&gt;
  3a) If a user-initiates a max compaction that requires too many files to be compacted, this will log an error.  &lt;br/&gt;
4) Migrates utility functions from HBaseTestCase (Deprecated?) to HBaseTestingUtility to ease testing compaction behavior in TestCompaction&lt;/p&gt;</comment>
                            <comment id="13275990" author="dwollen" created="Tue, 15 May 2012 17:11:56 +0000"  >&lt;p&gt;I&apos;m not sure if this is being done correctly, but I&apos;ve provided a patch that seems to do the right thing here.  It includes a large change area because of the refactoring of HBaseTestCase utilities into HBaseTestingUtility.&lt;/p&gt;</comment>
                            <comment id="13276030" author="hadoopqa" created="Tue, 15 May 2012 17:33:25 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527464/HBASE-5920.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527464/HBASE-5920.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 26 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1871//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1871//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13276546" author="dwollen" created="Wed, 16 May 2012 07:24:06 +0000"  >&lt;p&gt;Creating a new version of the patch with svn&lt;/p&gt;</comment>
                            <comment id="13276548" author="dwollen" created="Wed, 16 May 2012 07:25:34 +0000"  >&lt;p&gt;Trying one more time &amp;#8211; I was just using &quot;diff&quot; rather than svn diff last time. &lt;/p&gt;</comment>
                            <comment id="13276552" author="hadoopqa" created="Wed, 16 May 2012 07:32:15 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527577/HBASE-5920-0.92.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527577/HBASE-5920-0.92.1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 23 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1885//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1885//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13276562" author="dwollen" created="Wed, 16 May 2012 07:57:35 +0000"  >&lt;p&gt;changing location again&lt;/p&gt;</comment>
                            <comment id="13276567" author="hadoopqa" created="Wed, 16 May 2012 08:02:20 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527581/HBASE-5920-0.92.1-1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527581/HBASE-5920-0.92.1-1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 23 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1886//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1886//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13276570" author="dwollen" created="Wed, 16 May 2012 08:05:47 +0000"  >&lt;p&gt;I just noticed that this seems to be a jenkins error(patches seem to have been failing for several days?)  I&apos;ll reach out via IRC / etc to see what&apos;s wrong here&lt;br/&gt;
&quot;At revision 1339047.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5920&quot; title=&quot;New Compactions Logic can silently prevent user-initiated compactions from occurring&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5920&quot;&gt;&lt;del&gt;HBASE-5920&lt;/del&gt;&lt;/a&gt; patch is being downloaded at Wed May 16 08:01:44 UTC 2012 from&lt;br/&gt;
&lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527581/HBASE-5920-0.92.1-1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527581/HBASE-5920-0.92.1-1.patch&lt;/a&gt;&lt;br/&gt;
cp: cannot stat `/home/jenkins/buildSupport/lib/*&apos;: No such file or directory&lt;br/&gt;
&quot;&lt;/p&gt;</comment>
                            <comment id="13276778" author="zhihyu@ebaysf.com" created="Wed, 16 May 2012 14:55:07 +0000"  >&lt;p&gt;@Derek:&lt;br/&gt;
Hadoop QA only runs patch against trunk.&lt;/p&gt;

&lt;p&gt;Please provide svn patch for trunk.&lt;/p&gt;</comment>
                            <comment id="13276830" author="dwollen" created="Wed, 16 May 2012 15:58:06 +0000"  >&lt;p&gt;Thanks @zhihong - I&apos;ve re-created my patch against trunk.  I&apos;ve also removed some of the refactoring of unit tests since it looks like HBaseTestCase is continuing to see expanded use (and I don&apos;t want to mix a test refactoring with a compaction change)&lt;/p&gt;</comment>
                            <comment id="13276839" author="hadoopqa" created="Wed, 16 May 2012 16:02:12 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527641/HBASE-5920-trunk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527641/HBASE-5920-trunk.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1889//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1889//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13276853" author="dwollen" created="Wed, 16 May 2012 16:21:01 +0000"  >&lt;p&gt;That was odd &amp;#8211; the patch in the jenkins log was empty &amp;#8211; trying to upload again&lt;/p&gt;</comment>
                            <comment id="13276889" author="hadoopqa" created="Wed, 16 May 2012 17:06:39 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527649/HBASE-5920-trunk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527649/HBASE-5920-trunk.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop23.  The patch compiles against the hadoop 0.23.x profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 31 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestSplitLogManager&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1890//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1890//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1890//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1890//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1890//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1890//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13276891" author="zhihyu@ebaysf.com" created="Wed, 16 May 2012 17:11:02 +0000"  >&lt;p&gt;@Nicolas:&lt;br/&gt;
Can you take a look at the patch ?&lt;/p&gt;</comment>
                            <comment id="13276973" author="dwollen" created="Wed, 16 May 2012 18:25:41 +0000"  >&lt;p&gt;Is there anything I can be doing better on my side?  I have been running tests on my side iwhtout running into these issues, but I&apos;m clearly doing something wrong&lt;/p&gt;</comment>
                            <comment id="13278250" author="stack" created="Thu, 17 May 2012 20:52:38 +0000"  >&lt;p&gt;The test failures are probably not because of your patch Derek.&lt;/p&gt;

&lt;p&gt;There seems to be something wrong w/ your 0.92.x patches.  They are massive compared to the trunk one.&lt;/p&gt;

&lt;p&gt;Lines should be 100 characters max.  Fix lines like this:&lt;/p&gt;

&lt;p&gt;+    assertEquals(&quot;System-requested major compaction should not occur if there are too many store files&quot;, false, request.isMajor());&lt;/p&gt;

&lt;p&gt;Is this a bug fix:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-    CompactionRequest cr = s.requestCompaction();
+    CompactionRequest cr = s.requestCompaction(priority);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You need curlies around the second line because its on new line (rule is you don&apos;t need them if you are on same line):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(LOG.isDebugEnabled())
+        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Not compacting &quot;&lt;/span&gt; + r.getRegionNameAsString() + &lt;span class=&quot;code-quote&quot;&gt;&quot; because compaction request was cancelled&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Otherwise, patch looks great.&lt;/p&gt;</comment>
                            <comment id="13278642" author="dwollen" created="Fri, 18 May 2012 08:13:31 +0000"  >&lt;p&gt;@Stack &lt;/p&gt;

&lt;p&gt;To answer your questions&lt;br/&gt;
Yes, this compactPriority change is a bug fix in my opinion.  When we were setting priority, this was always based on the storefile count and ignored the user compaction count.  That seemed like incorrect behavior.&lt;/p&gt;

&lt;p&gt;I&apos;ve gone through and removed all the long lines that I saw in the patch (although one of them is exactly 100 characters)&lt;/p&gt;

&lt;p&gt;The original hbase 0.92-1 patch was longer because I was trying to avoid using HBaseTestCase features (it&apos;s marked as deprecated).  The large change area was caused by the fact that I had migrated the &quot;addContent&quot; feature out of HBaseTestCase and into HBaseTestingUtility.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a much shorter patch for hbase 0.92.1 which doesn&apos;t include the refactoring.&lt;/p&gt;</comment>
                            <comment id="13278655" author="hadoopqa" created="Fri, 18 May 2012 09:08:42 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12528014/HBASE-5920-trunk-1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12528014/HBASE-5920-trunk-1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop23.  The patch compiles against the hadoop 0.23.x profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 32 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.io.hfile.TestForceCacheImportantBlocks&lt;br/&gt;
                  org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1926//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1926//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1926//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1926//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1926//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1926//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13279257" author="stack" created="Fri, 18 May 2012 22:18:11 +0000"  >&lt;p&gt;Here is what I applied to 0.94.  Its trunk patch w/ some minor fixup in HRegionServer.&lt;/p&gt;</comment>
                            <comment id="13279258" author="stack" created="Fri, 18 May 2012 22:23:05 +0000"  >&lt;p&gt;Committed to 0.92, 0.94 and to trunk.  Thanks for the patch Derek&lt;/p&gt;</comment>
                            <comment id="13279267" author="zhihyu@ebaysf.com" created="Fri, 18 May 2012 22:31:56 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(priority != PRIORITY_USER) {
+            LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Compacting more than max files on a non user-requested compaction&quot;&lt;/span&gt;);
+          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Should pastMax be computed in the above case ?&lt;/p&gt;</comment>
                            <comment id="13279280" author="zhihyu@ebaysf.com" created="Fri, 18 May 2012 22:50:00 +0000"  >&lt;p&gt;The following line is too long:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Warning, compacting more than &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.maxFilesToCompact + &lt;span class=&quot;code-quote&quot;&gt;&quot; files, probably because of a user-requested major compaction&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13279328" author="hudson" created="Fri, 18 May 2012 23:19:38 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2903 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2903/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2903/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5920&quot; title=&quot;New Compactions Logic can silently prevent user-initiated compactions from occurring&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5920&quot;&gt;&lt;del&gt;HBASE-5920&lt;/del&gt;&lt;/a&gt; New Compactions Logic can silently prevent user-initiated compactions from occurring (Revision 1340280)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13279336" author="hudson" created="Fri, 18 May 2012 23:27:02 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #10 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/10/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/10/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5920&quot; title=&quot;New Compactions Logic can silently prevent user-initiated compactions from occurring&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5920&quot;&gt;&lt;del&gt;HBASE-5920&lt;/del&gt;&lt;/a&gt; New Compactions Logic can silently prevent user-initiated compactions from occurring (Revision 1340280)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13279348" author="hudson" created="Sat, 19 May 2012 00:02:05 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #202 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/202/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/202/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5920&quot; title=&quot;New Compactions Logic can silently prevent user-initiated compactions from occurring&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5920&quot;&gt;&lt;del&gt;HBASE-5920&lt;/del&gt;&lt;/a&gt; New Compactions Logic can silently prevent user-initiated compactions from occurring (Revision 1340283)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13279385" author="hudson" created="Sat, 19 May 2012 01:09:55 +0000"  >&lt;p&gt;Integrated in HBase-0.92 #413 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92/413/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92/413/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5920&quot; title=&quot;New Compactions Logic can silently prevent user-initiated compactions from occurring&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5920&quot;&gt;&lt;del&gt;HBASE-5920&lt;/del&gt;&lt;/a&gt; New Compactions Logic can silently prevent user-initiated compactions from occurring (Revision 1340285)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/CompactionRequest.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13279415" author="hudson" created="Sat, 19 May 2012 02:42:11 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #27 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/27/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/27/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5920&quot; title=&quot;New Compactions Logic can silently prevent user-initiated compactions from occurring&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5920&quot;&gt;&lt;del&gt;HBASE-5920&lt;/del&gt;&lt;/a&gt; New Compactions Logic can silently prevent user-initiated compactions from occurring (Revision 1340283)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13283274" author="hudson" created="Fri, 25 May 2012 09:55:37 +0000"  >&lt;p&gt;Integrated in HBase-0.92-security #108 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92-security/108/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92-security/108/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5920&quot; title=&quot;New Compactions Logic can silently prevent user-initiated compactions from occurring&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5920&quot;&gt;&lt;del&gt;HBASE-5920&lt;/del&gt;&lt;/a&gt; New Compactions Logic can silently prevent user-initiated compactions from occurring (Revision 1340285)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/CompactionRequest.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12528183" name="5290-094.txt" size="15699" author="stack" created="Fri, 18 May 2012 22:18:11 +0000"/>
                            <attachment id="12527581" name="HBASE-5920-0.92.1-1.patch" size="111327" author="dwollen" created="Wed, 16 May 2012 07:57:34 +0000"/>
                            <attachment id="12528013" name="HBASE-5920-0.92.1-2.patch" size="26302" author="dwollen" created="Fri, 18 May 2012 08:13:30 +0000"/>
                            <attachment id="12527577" name="HBASE-5920-0.92.1.patch" size="111558" author="dwollen" created="Wed, 16 May 2012 07:24:06 +0000"/>
                            <attachment id="12528014" name="HBASE-5920-trunk-1.patch" size="15988" author="dwollen" created="Fri, 18 May 2012 08:13:30 +0000"/>
                            <attachment id="12527649" name="HBASE-5920-trunk.patch" size="15881" author="dwollen" created="Wed, 16 May 2012 16:21:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 2 May 2012 21:38:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237856</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02gqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12314</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>This patch makes the following changes:&lt;br/&gt;
1) Trace-level logging whenever a compaction is requested&lt;br/&gt;
2) Debug-level logging whenever compaction is changed&lt;br/&gt;
3) If a user requests a major compaction, this will stay a major compaction even if it violated max files (easy to take this part out)&lt;br/&gt;
3a) If a user-initiates a max compaction that requires too many files to be compacted, this will log an error. &lt;br/&gt;
4) Migrates utility functions from HBaseTestCase (Deprecated?) to HBaseTestingUtility to ease testing compaction behavior in TestCompaction</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>