<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:44:23 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7294/HBASE-7294.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7294] Check for snapshot file cleaners on start</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7294</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Snapshots currently use the SnaphotHfileCleaner and SnapshotHLogCleaner to ensure that any hfiles or hlogs (respectively) that are currently part of a snapshot are not removed from their respective archive directories (.archive and .oldlogs).&lt;/p&gt;

&lt;p&gt;From Matteo Bertozzi:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;currently the snapshot cleaner is not in hbase-default.xml&lt;br/&gt;
and there&apos;s no warning/exception on snapshot/restore operation, if not enabled.&lt;/p&gt;

&lt;p&gt;even if we add the cleaner to the hbase-default.xml how do we ensure that the user doesn&apos;t remove it?&lt;br/&gt;
Do we want to hardcode the cleaner at master startup?&lt;br/&gt;
Do we want to add a check in snapshot/restore that throws an exception if the cleaner is not enabled?&lt;/p&gt;&lt;/blockquote&gt;
</description>
                <environment></environment>
        <key id="12622833">HBASE-7294</key>
            <summary>Check for snapshot file cleaners on start</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12556488">HBASE-6055</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mbertozzi">Matteo Bertozzi</assignee>
                                    <reporter username="jesse_yates">Jesse Yates</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Dec 2012 23:49:23 +0000</created>
                <updated>Mon, 23 Sep 2013 18:31:21 +0000</updated>
                            <resolved>Sat, 29 Dec 2012 19:04:17 +0000</resolved>
                                    <version>hbase-6055</version>
                                    <fixVersion>0.95.0</fixVersion>
                                    <component>Client</component>
                    <component>master</component>
                    <component>regionserver</component>
                    <component>snapshots</component>
                    <component>Zookeeper</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13526023" author="jmhsieh" created="Thu, 6 Dec 2012 23:56:38 +0000"  >&lt;p&gt;I think we should not allow snapshots if the proper cleaner is not installed, and I think the rs and hm startup code should also check to see if there are .snapshots present and abort startup if the proper cleaner is not installed with a log message saying that this must be done.&lt;/p&gt;

&lt;p&gt;We &lt;b&gt;do not&lt;/b&gt; want to even allow an admin accidentally change something that could result in data loss.&lt;/p&gt;</comment>
                            <comment id="13526026" author="jesse_yates" created="Thu, 6 Dec 2012 23:59:21 +0000"  >&lt;p&gt;I&apos;d like to see the cleaners added to hbase-default.xml and then have the snapshot manager check to make sure that the correct cleaners are enabled on startup (similar to how we cleanup the .snapshot/.tmp directory in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7240&quot; title=&quot;Cleanup old snapshots on start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7240&quot;&gt;&lt;del&gt;HBASE-7240&lt;/del&gt;&lt;/a&gt;). If the cleaners aren&apos;t enabled, we don&apos;t block startup, but instead prevent any snapshots from being taken. &lt;/p&gt;

&lt;p&gt;There is the consideration of &apos;what if there are existing snapshots&apos;? The last thing we want is unintentional data loss. Here we have two options: (1) fail startup with an error message telling the user to remove the snapshots before preceeding, or (2) add the snapshot cleaner back in.&lt;/p&gt;

&lt;p&gt;I think (1) is the better case, but it also requires adding another configuration option, specifiying the acceptable classes for snapshot cleaning. A user might want to have their own policies for cleaning up files related to snaphots (for instance, even if there is a snapshot, we want to remove the files after 30 days, but otherwise don&apos;t remove them). By default, we don&apos;t remove ANY files that are in a snapshot. (there also might be room here to make a configurable policy for the snapshot file cleaners to take a TTL, but that defaults to infinity, but that&apos;s probably a bit premature).&lt;/p&gt;</comment>
                            <comment id="13526484" author="jmhsieh" created="Fri, 7 Dec 2012 16:09:10 +0000"  >&lt;p&gt;The first should be the simplest &amp;#8211; no ability to take snapshots if data loss is possible, no ability to loss data from existing snapshots, and no &quot;fancy&quot; policies until we get the basic, default, and definitely correct implementation in first.&lt;/p&gt;</comment>
                            <comment id="13533372" author="mbertozzi" created="Sun, 16 Dec 2012 12:34:41 +0000"  >&lt;p&gt;Added check at startup to verify if the cleaners are present.&lt;/p&gt;

&lt;p&gt;If cleaners are not present, everything is fine unless there&apos;re snapshot in the .snapshot folder. Master should not start because otherwise we end up with data loss.&lt;/p&gt;

&lt;p&gt;If cleaners are not present in the conf, and there&apos;re no snapshot we can still use hbase without the snapshot feature. Any call to snapshot, clone or restore will fail with unsupported exception and the missing cleaner message.&lt;/p&gt;</comment>
                            <comment id="13533376" author="hadoopqa" created="Sun, 16 Dec 2012 12:54:17 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12561184/HBASE-7294-v0.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12561184/HBASE-7294-v0.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/3565//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/3565//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13533605" author="jesse_yates" created="Mon, 17 Dec 2012 02:29:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt; good on ya for taking this! What do you think about flipping the order of setup and checking for the cleaners on master startup in SnapshtManager#start()? &lt;/p&gt;

&lt;p&gt;There you could (1) set a boolean flag there if snapshots are allowed and (2) also check the on-disk state and throw an exception if the cleaners aren&apos;t enabled. This helps keep the encapsulation around snapshot management in the SnapshotManager and seems a cleaner place to do checking for allowing a snapshot operation rather than in the HMaster (similar to how we check if other snapshots are already running).&lt;/p&gt;</comment>
                            <comment id="13533798" author="mbertozzi" created="Mon, 17 Dec 2012 09:49:30 +0000"  >&lt;p&gt;moved the check inside SnapshotManager.start()&lt;br/&gt;
cleaners are started later so it&apos;s fine.&lt;/p&gt;</comment>
                            <comment id="13533815" author="hadoopqa" created="Mon, 17 Dec 2012 10:00:10 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12561265/HBASE-7294-v1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12561265/HBASE-7294-v1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/3568//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/3568//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13535437" author="jmhsieh" created="Tue, 18 Dec 2012 23:09:05 +0000"  >
&lt;p&gt;seems like info level.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Snapshot feature is not enabled, missing log and hfile cleaners.&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;slight reword of this &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;To been able to use snapshots HBase Master must have cleaners enabled. &quot;&lt;/span&gt; +
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to &quot;To use snapshots, the HBase Master must have the proper archive cleaners enabled.&quot;&lt;/p&gt;


&lt;p&gt;Does this print out exactly what we want for these *.class?  We want it to print &apos;org.apache.hadoop.hbase....SnapshotHFileCleaner&apos;.  See &lt;a href=&quot;http://docs.oracle.com/javase/1.5.0/docs/api/java/lang/Class.html#toString(&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://docs.oracle.com/javase/1.5.0/docs/api/java/lang/Class.html#toString(&lt;/a&gt;) about the Class#toString method.  I think you many need to make it SnapshotHFileCleaner.getName() (or maybe it is getCanonicalName()).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;hbase.master.hfilecleaner.plugins&apos; with &apos;&quot;&lt;/span&gt; +
+        HFileLinkCleaner.class + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;, &apos;&quot;&lt;/span&gt; + SnapshotHFileCleaner.class +
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; support. And add &apos;hbase.master.logcleaner.plugins&apos; with &apos;&quot;&lt;/span&gt; +
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13535996" author="mbertozzi" created="Wed, 19 Dec 2012 14:29:33 +0000"  >&lt;p&gt;fixed log.info() and class.getName()&lt;/p&gt;</comment>
                            <comment id="13536026" author="hadoopqa" created="Wed, 19 Dec 2012 15:24:00 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12561699/HBASE-7294-v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12561699/HBASE-7294-v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/3610//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/3610//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13536037" author="jmhsieh" created="Wed, 19 Dec 2012 15:32:14 +0000"  >&lt;p&gt;Please fix the &quot;To been...&quot; comment.   It is still grammatically incorrect.&lt;/p&gt;</comment>
                            <comment id="13536051" author="hadoopqa" created="Wed, 19 Dec 2012 15:44:13 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12561711/HBASE-7294-v3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12561711/HBASE-7294-v3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/3612//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/3612//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13536200" author="yuzhihong@gmail.com" created="Wed, 19 Dec 2012 17:59:48 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+   * Called at startup, to verify &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; snapshot operation are supported, and to avoid
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&apos;operation are&apos; -&amp;gt; &apos;operation is&apos;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void checkSnapshotSupport(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Configuration conf, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MasterFileSystem mfs)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please add @param for the two parameters.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-comment&quot;&gt;// Mark snapshot feature has enabled &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; cleaners are present&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&apos;feature has&apos; -&amp;gt; &apos;feature as&apos;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-comment&quot;&gt;// otherwise we end up snapshot with data loss.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&apos;end up snapshot with&apos; -&amp;gt; &apos;end up with snapshot&apos;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;hbase.master.hfilecleaner.plugins&apos; with &apos;&quot;&lt;/span&gt; +
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please refer to constants instead of hardcoding. Same with &apos;hbase.master.logcleaner.plugins&apos;&lt;/p&gt;</comment>
                            <comment id="13536240" author="jmhsieh" created="Wed, 19 Dec 2012 18:21:51 +0000"  >&lt;p&gt;We need to make sure the snapshots unit tests pass as well &amp;#8211; I believe they should all fail once this gets in because I don&apos;t think all install the cleaners.&lt;/p&gt;</comment>
                            <comment id="13536378" author="hadoopqa" created="Wed, 19 Dec 2012 20:12:52 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12561777/HBASE-7294-v4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12561777/HBASE-7294-v4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 21 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/3618//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/3618//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13537288" author="jesse_yates" created="Thu, 20 Dec 2012 19:24:56 +0000"  >&lt;p&gt;minor nit: we have a lot of snapshot tests that need the cleaners, maybe centralize to a single method to add the cleaners in a SnapshotTestingUtilitity (or something similar)? Could even be a setupCluster(Configuration) method so we can easily add on other things later (though this may all be excessive &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;

&lt;p&gt;+1 if tests are passing.&lt;/p&gt;</comment>
                            <comment id="13537293" author="jmhsieh" created="Thu, 20 Dec 2012 19:32:29 +0000"  >&lt;p&gt;Another consideration is to turn these cleaners on by default, or have a single is-snapshots-on? config var that does this work.  This would be a follow-on jira, and not necessary here.&lt;/p&gt;</comment>
                            <comment id="13538118" author="jmhsieh" created="Fri, 21 Dec 2012 15:05:25 +0000"  >&lt;p&gt;v4 Patch does not apply snapshot branch ff25969ea0b2ff38cc25512a02569c351e757d66&lt;/p&gt;

&lt;p&gt;Looks like this is built upon some of the online snaphots work.  What branch/hash does this go on Matteo?&lt;/p&gt;</comment>
                            <comment id="13538121" author="mbertozzi" created="Fri, 21 Dec 2012 15:10:14 +0000"  >&lt;p&gt;this was written on top of the online branch. to avoid move around the code from HMaster to SnapshotManager&lt;/p&gt;</comment>
                            <comment id="13538233" author="jmhsieh" created="Fri, 21 Dec 2012 17:31:13 +0000"  >&lt;p&gt;Ok, this make this hard to commit.  I&apos;ll add it to my working branch but not close this until we get the patches it depends upon committed to the online branch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jesse_yates&quot; class=&quot;user-hover&quot; rel=&quot;jesse_yates&quot;&gt;Jesse Yates&lt;/a&gt; &amp;#8211; we were in a similar position we were at with the offline stuff before &amp;#8211; we can&apos;t commit this because it depends on work that hasn&apos;t been committed to a common branch yet, and preventing other folks from working on this.  Can you do a pass and consider +1&apos;ing some things with caveats to follow-up on?  (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7208&quot; title=&quot;Transition Offline Snapshots to ForeignExceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7208&quot;&gt;&lt;del&gt;HBASE-7208&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7212&quot; title=&quot;Globally Barriered Procedure mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7212&quot;&gt;&lt;del&gt;HBASE-7212&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6864&quot; title=&quot;Online snapshots scaffolding&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6864&quot;&gt;&lt;del&gt;HBASE-6864&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7321&quot; title=&quot;Simple Flush Snapshot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7321&quot;&gt;&lt;del&gt;HBASE-7321&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;




</comment>
                            <comment id="13539404" author="mbertozzi" created="Tue, 25 Dec 2012 14:24:20 +0000"  >&lt;p&gt;v5 patch applies on jesse branch&lt;br/&gt;
added also &quot;hbase.snapshot.enabled&quot; property and it works like this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;No &quot;hbase.snapshot.enabled&quot; in the config
	&lt;ul&gt;
		&lt;li&gt;If cleaners are enabled snapshot feature is enabled&lt;/li&gt;
		&lt;li&gt;If cleaners are not enabled
		&lt;ul&gt;
			&lt;li&gt;if there&apos;re no snapshot in the .snapshot folder, snapshot feature is disabled&lt;/li&gt;
			&lt;li&gt;if there&apos;re snapshot in the .snapshot folder, an exception was raised to avoid to start the master and throw away the .snapshot present&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&quot;hbase.snapshot.enabled&quot; is true in the config
	&lt;ul&gt;
		&lt;li&gt;Force the snapshot cleaners to be in and enable the feature&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&quot;hbase.snapshot.enabled&quot; is false in the config
	&lt;ul&gt;
		&lt;li&gt;The feature is disabled but if cleaners are not enabled and there&apos;re snapshot in the .snapshot folder, an exception was raised to avoid to start the master and throw away the .snapshot present&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13539614" author="jmhsieh" created="Wed, 26 Dec 2012 17:50:18 +0000"  >&lt;p&gt;We really should push folks to use hbase.snapshot.enabled&lt;/p&gt;

&lt;p&gt;nit:&lt;/p&gt;

&lt;p&gt;Should we update this to describe hbase.snapshot.enabled?  (seems simpler)  also mention that you have data in the .snapshots dir (might be strange if it works with the same config, but later does not.  at least if we mention the dir users will have a pointer and an option to remove snapshots.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  /**
+   * Throws an exception &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; snapshot operations (take a snapshot, restore, clone) are not supported.
+   * Called at the beginning of snapshot() and restoreSnapshot() methods.
+   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; UnsupportedOperationException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; snapshot are not supported
+   */
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkSnapshotSupport() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; UnsupportedOperationException {
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.isSnapshotSupported) {
+      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsupportedOperationException(
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;To use snapshots, the HBase Master must have the proper archive cleaners enabled. &quot;&lt;/span&gt; +
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;You must add to the hbase-site.xml: &quot;&lt;/span&gt; +
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&quot;&lt;/span&gt; + HFileCleaner.MASTER_HFILE_CLEANER_PLUGINS + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; with &apos;&quot;&lt;/span&gt; +
+        HFileLinkCleaner.class.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;, &apos;&quot;&lt;/span&gt; + SnapshotHFileCleaner.class.getName() +
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; support. And add &apos;&quot;&lt;/span&gt; + HConstants.HBASE_MASTER_LOGCLEANER_PLUGINS + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; with &apos;&quot;&lt;/span&gt; +
+        SnapshotLogCleaner.class.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; support.&quot;&lt;/span&gt;);
+    }
+  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should behave the same but emit a warning if folks are using the plugins and not the hbase.snapshot.enabled property.&lt;/p&gt;

&lt;p&gt;We should have a test the verifies snapshots work if configured one way or the other (and possibly a negative test exercing the case where it does not.&lt;/p&gt;

</comment>
                            <comment id="13539944" author="mbertozzi" created="Thu, 27 Dec 2012 12:58:55 +0000"  >&lt;ul&gt;
	&lt;li&gt;Changed exception message using &quot;hbase.snapshot.enabled&quot; instead of the cleaners&lt;/li&gt;
	&lt;li&gt;Added warn on cleaners enabled, but snapshot.enabled false/not set&lt;/li&gt;
	&lt;li&gt;Added a test to verify different conf settings and expected result&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13540242" author="jmhsieh" created="Fri, 28 Dec 2012 00:43:24 +0000"  >&lt;p&gt;looks good. +1.  Running through tests and will commit if they pass.&lt;/p&gt;</comment>
                            <comment id="13540393" author="jmhsieh" created="Fri, 28 Dec 2012 08:47:29 +0000"  >&lt;p&gt;Came back with some consistent failures. The first two are likely related to this patch, the latter was an error present previously and on trunk (so ignoring it for this patch for now)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
17:09:14  Running org.apache.hadoop.hbase.TestInfoServers
17:09:14  Tests run: 3, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 15.757 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
...
17:12:05  Running org.apache.hadoop.hbase.master.cleaner.TestSnapshotFromMaster
17:12:05  Tests run: 4, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 35.534 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
...
17:19:07  Running org.apache.hadoop.hbase.client.TestHCM
17:19:07  Tests run: 7, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 76.637 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13540845" author="mbertozzi" created="Sat, 29 Dec 2012 10:46:43 +0000"  >&lt;p&gt;TestInfoServers got an exception generated from the snapshots not enabled.&lt;br/&gt;
TestSnapshotFromMaster had two problems:&lt;br/&gt;
The TTL on by default after the new snapshot.enabled property introduced (so files are not removed immediately after the first cleaner call)&lt;br/&gt;
and enableTable() trigger a compaction (async) and sometimes (on jenkins) is slow and the files are still there, and one of the assert fail.&lt;/p&gt;</comment>
                            <comment id="13540849" author="hadoopqa" created="Sat, 29 Dec 2012 10:53:26 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12562664/HBASE-7294-v7.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12562664/HBASE-7294-v7.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 15 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/3754//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/3754//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13540970" author="jmhsieh" created="Sat, 29 Dec 2012 19:03:58 +0000"  >&lt;p&gt;+1.  Thanks Matteo, Jesse. Committed to offline and online snapshots branches. &lt;/p&gt;</comment>
                            <comment id="13775368" author="stack" created="Mon, 23 Sep 2013 18:31:21 +0000"  >&lt;p&gt;Marking closed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12561265" name="HBASE-7294-v1.patch" size="7228" author="mbertozzi" created="Mon, 17 Dec 2012 09:49:30 +0000"/>
                            <attachment id="12561699" name="HBASE-7294-v2.patch" size="7061" author="mbertozzi" created="Wed, 19 Dec 2012 14:29:33 +0000"/>
                            <attachment id="12561711" name="HBASE-7294-v3.patch" size="7066" author="mbertozzi" created="Wed, 19 Dec 2012 15:37:50 +0000"/>
                            <attachment id="12561777" name="HBASE-7294-v4.patch" size="17150" author="mbertozzi" created="Wed, 19 Dec 2012 20:02:42 +0000"/>
                            <attachment id="12562350" name="HBASE-7294-v5.patch" size="17067" author="mbertozzi" created="Tue, 25 Dec 2012 14:24:20 +0000"/>
                            <attachment id="12562466" name="HBASE-7294-v6.patch" size="23359" author="mbertozzi" created="Thu, 27 Dec 2012 12:58:55 +0000"/>
                            <attachment id="12562664" name="HBASE-7294-v7.patch" size="28069" author="mbertozzi" created="Sat, 29 Dec 2012 10:46:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 6 Dec 2012 23:56:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>296405</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1495r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>232947</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>