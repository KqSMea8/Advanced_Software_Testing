<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:48:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7755/HBASE-7755.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7755] Experiment with LAB in BlockEndcoding</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7755</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I was looking at and profiling the BlockEncoding code to figure out how to make it faster. One issue that jumped out was we call ByteBuffer.allocate(...) for each single KV.&lt;br/&gt;
As an experiment I tried using the MemStoreLAB code to allocate those buffers.&lt;/p&gt;

&lt;p&gt;Here are some preliminary numbers, all scanning 10m rows (all in cache):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;no encoding: 5.2s&lt;/li&gt;
	&lt;li&gt;FAST_DIFF without patch: 7.3s&lt;/li&gt;
	&lt;li&gt;FAST_DIFF with patch and small LAB: 4.1s&lt;/li&gt;
	&lt;li&gt;FAST_DIFF with patch and large LAB: 11s&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So this is very sensitive to the right sizing of the LAB.&lt;/p&gt;

&lt;p&gt;Need to do a bit more testing, but it seems that there is a chance to actually make scanning with block encoding faster than without!&lt;/p&gt;</description>
                <environment></environment>
        <key id="12630614">HBASE-7755</key>
            <summary>Experiment with LAB in BlockEndcoding</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="lhofhansl">Lars Hofhansl</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Feb 2013 05:50:59 +0000</created>
                <updated>Sun, 11 Oct 2015 19:43:58 +0000</updated>
                            <resolved>Wed, 1 May 2013 05:43:58 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13570003" author="lhofhansl" created="Mon, 4 Feb 2013 06:02:37 +0000"  >&lt;p&gt;Making the LAB even smaller (my KVs are small, I&apos;ll have more data) I can get this down to 3.7s.&lt;/p&gt;</comment>
                            <comment id="13570004" author="mcorgan" created="Mon, 4 Feb 2013 06:06:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7323&quot; title=&quot;add Cell interface to SeekerState and BufferedEncodedSeeker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7323&quot;&gt;&lt;del&gt;HBASE-7323&lt;/del&gt;&lt;/a&gt; is a first step in avoiding any allocation+copying at all, but will require changes in the scanners and heap to use Cells all the way up.  Haven&apos;t had time to work on it lately.&lt;/p&gt;</comment>
                            <comment id="13570010" author="lhofhansl" created="Mon, 4 Feb 2013 06:24:15 +0000"  >&lt;p&gt;Here&apos;s a &lt;b&gt;work in progress&lt;/b&gt; that attempts to derive a reasonable size of the LAB from the block size.&lt;br/&gt;
It&apos;s not configurable, yet, it may crash and burn your machine.&lt;br/&gt;
Also still experimenting with who should own the LAB. BufferedEncodedSeeker in the end is probably not the right place, since it is created to frequently.&lt;/p&gt;</comment>
                            <comment id="13570011" author="lhofhansl" created="Mon, 4 Feb 2013 06:26:22 +0000"  >&lt;p&gt;Hey Matt... Yeah. I&apos;m seeing this as a 0.94-only change, whereas the bigger work on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7323&quot; title=&quot;add Cell interface to SeekerState and BufferedEncodedSeeker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7323&quot;&gt;&lt;del&gt;HBASE-7323&lt;/del&gt;&lt;/a&gt; et al is the right long term fix.&lt;/p&gt;</comment>
                            <comment id="13570022" author="lhofhansl" created="Mon, 4 Feb 2013 06:38:56 +0000"  >&lt;p&gt;Version that only LAB if the scanner does seek+read (as opposed to pread).&lt;/p&gt;

&lt;p&gt;With this there should be not detrimental performance for Gets (which will setup their scanners with pread).&lt;/p&gt;</comment>
                            <comment id="13570023" author="lhofhansl" created="Mon, 4 Feb 2013 06:39:25 +0000"  >&lt;p&gt;v1 might almost be useful, still needs to be made configurable and off by default.&lt;/p&gt;</comment>
                            <comment id="13570366" author="apurtell" created="Mon, 4 Feb 2013 16:29:08 +0000"  >&lt;p&gt;v1 looks plausible. &lt;/p&gt;

&lt;p&gt;Maybe the blockcache could own the LAB for block encoding, since it&apos;s already allocating another, and pass it down to BufferedDataBlockEncoder?&lt;/p&gt;</comment>
                            <comment id="13570678" author="lhofhansl" created="Mon, 4 Feb 2013 22:08:46 +0000"  >&lt;p&gt;I was thinking about this too.&lt;br/&gt;
On the other hand the decoding is a function of scanning through the blocks, and it seems the LAB should be independent from the caching of the block (maybe).&lt;br/&gt;
I think ideally a scanner would own the LAB, but it does not know the block size ahead of time.&lt;br/&gt;
Another option is having the HFile itself owning the LAB for all block access through it.&lt;/p&gt;

&lt;p&gt;I had almost convinced myself that BufferedEncodedSeeker &lt;b&gt;is&lt;/b&gt; right place.&lt;/p&gt;

&lt;p&gt;So the options are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;block cache&lt;/li&gt;
	&lt;li&gt;an HFileReader&lt;/li&gt;
	&lt;li&gt;a Scanner&lt;/li&gt;
	&lt;li&gt;more?&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="13571029" author="lhofhansl" created="Tue, 5 Feb 2013 04:25:42 +0000"  >&lt;p&gt;After thinking about this a bit more... It does not make sense to have the chunk size larger than an individual block&apos;s size, and thus it makes sense to create a new LAB when a block is scanned, and to do that for each block. The LAB is almost free to allocate; and since this is done only when we seek+read (i.e. scanning) and only when block encoding is enabled we&apos;ll be copying a lot of bytes during the decoding anyway.&lt;/p&gt;

&lt;p&gt;From that viewpoint BufferedEncodedSeeker is in fact the right place. The only part missing is the config option to disable this (which turns out to be a bit more tricky to do nicely - without passing information down a 10-depth call stack).&lt;br/&gt;
Also the alloc size should probably be less than chunksize. I&apos;m thinking to make 1/10th of the chunk size.&lt;/p&gt;</comment>
                            <comment id="13571572" author="apurtell" created="Tue, 5 Feb 2013 18:48:03 +0000"  >&lt;p&gt;Thanks. &lt;/p&gt;</comment>
                            <comment id="13572079" author="lhofhansl" created="Wed, 6 Feb 2013 02:06:34 +0000"  >&lt;p&gt;Interestingly when trying with KVs of 1k and 64k block size this patch actually slows things down.&lt;br/&gt;
So maybe this is a dud after all. (That I labeled it with &quot;experimenting&quot;).&lt;/p&gt;</comment>
                            <comment id="13646395" author="lhofhansl" created="Wed, 1 May 2013 05:43:58 +0000"  >&lt;p&gt;Marking as &quot;Won&apos;t fix&quot; as I have been unable to find a general heuristic that always improves performance.&lt;/p&gt;</comment>
                            <comment id="14952406" author="lhofhansl" created="Sun, 11 Oct 2015 19:43:58 +0000"  >&lt;p&gt;Just thought about this again. It&apos;s interesting that when I cannot find a good slab size here, how come we can find a good slab size for the memstore? I want to think about this again.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12623345">HBASE-7323</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12567804" name="7755-0.94-WORK_IN_PROGRESS.txt" size="10001" author="lhofhansl" created="Mon, 4 Feb 2013 06:24:15 +0000"/>
                            <attachment id="12567808" name="7755-0.94-W_I_P_v1.txt" size="10065" author="lhofhansl" created="Mon, 4 Feb 2013 06:38:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 4 Feb 2013 06:06:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311110</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hovr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311458</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>