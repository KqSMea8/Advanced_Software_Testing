<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:57:09 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1882/HBASE-1882.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1882] Put bad edits into a failed edits log rather than puke and crash</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1882</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Bits got flipped (it seems) on a read so a key going into hfile was &amp;lt; the previous.  We throw an exception that causes HRS restart.  Just put bad edits aside rather than die.&lt;/p&gt;

&lt;p&gt;From elsif up on list:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Our HBase system ended up in a looping situation trying to continuously
re-assign a damaged region across the HBase cluster. We could not properly
scan or store data in the affected table.

The triggering event that caused &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; cascade of errors was an
java.io.IOException: Added a key not lexically larger than previous

From the HBase shell &quot;scan &apos;.META.&apos; command we confirmed the name of the
damaged encoded
region stored in hdfs. In an attempt to fix &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, the data directory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
the impacted region
was moved off hdfs and the region was able to be restarted with a blank
slate.

Is there a better way to handle &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; type of failure?

Is there a way to generate an hlog to re-&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; the data files we moved
away?

HBase Version: 0.20.0, r805538
Hadoop Version: 0.20.0-plus4681, r767961

Here are the log entries leading up to the event:

2009-09-25 06:57:53,836 INFO org.apache.hadoop.hbase.regionserver.HLog:
Roll /hbase/.logs/hfs-030035,60020,1253122636703/hlog.dat.1253883473798,
entries=1479, calcsize=49659443, filesize=49589196. New hlog
/hbase/.logs/hfs-030035,60020,1253122636703/hlog.dat.1253887073833
2009-09-25 07:05:50,089 INFO
org.apache.hadoop.hbase.regionserver.MemStoreFlusher: Forced flushing of
fc_test,\x2Fdata\x2Fmalware\x2F873fc5b61af807827381f120ad7d746984d49426eb3c8b5523b6142285ee0844027f6b45eb8f18aff21b52071a9664e05ceca112a9ff5949c16cda3f27c9c7c2,1253728360248

because global memstore limit of 396.9m exceeded; currently 397.0m and
flushing till 24
8.1m


2009-09-25 07:05:53,294 INFO
org.apache.hadoop.hbase.regionserver.MemStoreFlusher: Forced flushing of
fc_test,\x2Fdata\x2Fdir\x2Fdfd2e9615461d03ba7c22d6d804ec23c3dba1587ffb91736d0e90df0b8aa659d6f55efe49552a83271d9e115bd1d706b865dc42008

52493400819628a7be0fc2\x2F2009-09-23_143101\x2Fxml,1253765882755 because
global memstore limit of 396.9m exceeded; currently 357.1m and flushing
till
248.1m

2009-09-25 07:05:55,583 FATAL
org.apache.hadoop.hbase.regionserver.MemStoreFlusher: Replay of hlog
required. Forcing serve
r
shutdown

org.apache.hadoop.hbase.DroppedSnapshotException: region:
fc_test,\x2Fdata\x2Fdir\x2Fdfd2e9615461d03ba7c22d6d804ec23c3dba1587ffb91736d0e90df0b8aa659d6f55efe49552a83271d9e115bd1d706b865dc4200852493400819628a7be0fc2\x2F2009-09-23_143101\

x2Fxml,1253765882755


at
org.apache.hadoop.hbase.regionserver.HRegion.internalFlushcache(HRegion.java:950)

at
org.apache.hadoop.hbase.regionserver.HRegion.flushcache(HRegion.java:843)
   at
org.apache.hadoop.hbase.regionserver.MemStoreFlusher.flushRegion(MemStoreFlusher.java:241)

at
org.apache.hadoop.hbase.regionserver.MemStoreFlusher.flushSomeRegions(MemStoreFlusher.java:352)

at
org.apache.hadoop.hbase.regionserver.MemStoreFlusher.reclaimMemStoreMemory(MemStoreFlusher.java:321)

   at
org.apache.hadoop.hbase.regionserver.HRegionServer.put(HRegionServer.java:1809)


   at sun.reflect.GeneratedMethodAccessor82.invoke(Unknown Source)
   at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)
   at java.lang.reflect.Method.invoke(Unknown Source)
   at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:650)
   at
org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:915)
Caused by: java.io.IOException: Added a key not lexically larger than
previous
key=^@?/data/dir/e22677afdb73cc17ed82a974058859e5e74b78ca5a7917cceaa500d2dd3198094ecf91792e8ddafc4768cfb4^D11ff79bb955c50b99c8f80fdff0b4beb413d8ea/2009-09-25_034206^Ejson:^@^@^A#?M?)^D,

lastkey=^@?/data/dir/e22677afdb73cc17ed82a974058859e5e74b78ca5a7917cceaa500d2dd3198094ecf91792e8ddafc4768cfb4d11ff79bb955c50b99c8f80fdff0b4beb413d8ea^Ejson:^@^@^A#?M?#^D

   at
org.apache.hadoop.hbase.io.hfile.HFile$Writer.checkKey(HFile.java:517)
   at org.apache.hadoop.hbase.io.hfile.HFile$Writer.append(HFile.java:479)
   at org.apache.hadoop.hbase.io.hfile.HFile$Writer.append(HFile.java:447)
   at
org.apache.hadoop.hbase.regionserver.Store.internalFlushCache(Store.java:525)

   at
org.apache.hadoop.hbase.regionserver.Store.flushCache(Store.java:489)
2009-09-25 07:05:55,608 INFO
org.apache.hadoop.hbase.regionserver.HRegionServer: Dump of metrics:
request=0.0, regions=15,
 stores=30, storefiles=43, storefileIndexSize=3, memstoreSize=396,
usedHeap=540, maxHeap=992, blockCacheSize=73256760, blo
ckCacheFree=967258312, blockCacheCount=1128, blockCacheHitRatio=90
2009-09-25 07:05:55,609 WARN
org.apache.hadoop.hbase.regionserver.MemStoreFlusher: Flush failed
2009-09-25 07:05:55,684 INFO org.apache.hadoop.ipc.HBaseServer: Stopping
server on 60020


Here are the log entries after restarting:

2009-09-28 11:36:16,608 INFO org.apache.hadoop.ipc.HBaseServer: IPC
Server handler 0 on 60020: starting
2009-09-28 11:36:16,620 ERROR
org.apache.hadoop.hbase.regionserver.HRegionServer:
org.apache.hadoop.hbase.NotServingRegionException:
[B@1a001ff               at
org.apache.hadoop.hbase.regionserver.HRegionServer.getRegion(HRegionS
erver.java:2263)

at org.apache.hadoop.hbase.regionserver.HRegionServer.get(HRegionServer.
java:1767)

at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
       at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown
Source)                  at
sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)
       at java.lang.reflect.Method.invoke(Unknown
Source)                              at
org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:650)
       at
org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:915)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;....&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stack wrote:
&amp;gt; On Mon, Sep 28, 2009 at 3:27 PM, elsif &amp;lt;elsif.then@gmail.com&amp;gt; wrote:
&amp;gt;
&amp;gt;
&amp;gt;&amp;gt; Our HBase system ended up in a looping situation trying to continuously
&amp;gt;&amp;gt; re-assign a damaged region across the HBase cluster. We could not properly
&amp;gt;&amp;gt; scan or store data in the affected table.
&amp;gt;&amp;gt;
&amp;gt;&amp;gt; The triggering event that caused &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; cascade of errors was an
&amp;gt;&amp;gt; java.io.IOException: Added a key not lexically larger than previous
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt; Here are the offending keys purportedly:
&amp;gt;
&amp;gt; key=^@?/data/dir/e22677afdb73cc17ed82a974058859e5e74b78ca5a7917cceaa500d2dd3198094ecf91792e8ddafc4768cfb4^D11ff79bb955c50b99c8f80fdff0b4beb413d8ea/2009-09-25_034206^Ejson:^@^@^A#?M?)^D,
&amp;gt; lastkey=^@?/data/dir/e22677afdb73cc17ed82a974058859e5e74b78ca5a7917cceaa500d2dd3198094ecf91792e8ddafc4768cfb4d11ff79bb955c50b99c8f80fdff0b4beb413d8ea^Ejson:^@^@^A#?M?#^D
&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt; It seems like keys are fine till we get to &apos;^D&apos;.    Can you make these keys
&amp;gt; or comment on them?  The &apos;^D&apos; is a printable version of whatever the bit of
&amp;gt; binary was here.  Do you have an idea what it was?  Can you remanufacture
&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; condition?  Something in our comparator is messing up?  Is that
&amp;gt; possible?
&amp;gt;
&amp;gt;

The keys are all plain text strings with no special characters.  Not
sure where the &apos;^D&apos; would come from since the same processes is used to
generate all the keys.
&amp;gt; This is in .META. table?
&amp;gt;

This is from a regular table.
&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt; &amp;gt;From the HBase shell &quot;scan &apos;.META.&apos; command we confirmed the name of the
&amp;gt;
&amp;gt;&amp;gt; damaged encoded
&amp;gt;&amp;gt; region stored in hdfs. In an attempt to fix &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, the data directory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
&amp;gt;&amp;gt; the impacted region
&amp;gt;&amp;gt; was moved off hdfs and the region was able to be restarted with a blank
&amp;gt;&amp;gt; slate.
&amp;gt;&amp;gt;
&amp;gt;&amp;gt; Is there a better way to handle &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; type of failure?
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt;
&amp;gt; There is a script that will repair the broke files rewriting them removing
&amp;gt; the offending edit.  I&apos;d point you at the script only its up in an Apache
&amp;gt; JIRA and thats sick at the moment.
&amp;gt;
&amp;gt; You could &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; running:
&amp;gt;
&amp;gt; ./bin/hbase org.apache.hadoop.hbase.io.hfile.HFile
&amp;gt;
&amp;gt; It has diagnostic and outputting facility.  Pass it the bad files.
&amp;gt;
&amp;gt;
&amp;gt;
I scanned each of the files with the -k option, no warnings were generated.

I also extracted all the key values from each file - none of them appear
to contain the key with the &apos;^D&apos;.

The &apos;key&apos; and &apos;lastkey&apos; listed above were contained in the
oldlogfile.log.  I opened the oldlogfile.log with a hex editor and
verified that the key does not contain any binary characters where the
&apos;^D&apos; is shown in the error log.  The character is actually a lowercase &apos;d&apos;:

/data/dir/e22677afdb73cc17ed82a974058859e5e74b78ca5a7917cceaa500d2dd3198094ecf91792e8ddafc4768cfb4d11ff79bb955c50b99c8f80fdff0b4beb413d8ea/2009-09-25_034206

It would seem &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; was a read error of some kind.

&amp;gt;
&amp;gt;
&amp;gt;&amp;gt; Is there a way to generate an hlog to re-&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; the data files we moved
&amp;gt;&amp;gt; away?
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt;
&amp;gt; Above mentioned script is probably the better way to go.
&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt;&amp;gt; HBase Version: 0.20.0, r805538
&amp;gt;&amp;gt; Hadoop Version: 0.20.0-plus4681, r767961
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt; Are these release 0.20.0?
&amp;gt;
The hadoop is release 0.20.0 - the hbase is a pre-release svn checkout.
&amp;gt; St.Ack
&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12437123">HBASE-1882</key>
            <summary>Put bad edits into a failed edits log rather than puke and crash</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Oct 2009 14:24:33 +0000</created>
                <updated>Wed, 16 Jul 2014 21:54:17 +0000</updated>
                            <resolved>Wed, 16 Jul 2014 21:54:17 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="14064175" author="apurtell" created="Wed, 16 Jul 2014 21:54:17 +0000"  >&lt;p&gt;Haven&apos;t seen stuff like this in ages. Reopen or file new issue if still relevant with modern HBase versions&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 16 Jul 2014 21:54:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26037</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02dq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11825</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>