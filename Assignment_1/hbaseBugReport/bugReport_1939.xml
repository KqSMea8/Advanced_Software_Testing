<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:57:38 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1939/HBASE-1939.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1939] HLog group commit</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1939</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Currently multiple clients writing to a RS are serialized when sync&apos;ing their appends. Implementing group commit can help this by being aware of all the clients in that queue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12439235">HBASE-1939</key>
            <summary>HLog group commit</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Oct 2009 00:24:10 +0000</created>
                <updated>Fri, 20 Nov 2015 13:02:09 +0000</updated>
                            <resolved>Mon, 2 Nov 2009 21:08:48 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12770726" author="apurtell" created="Wed, 28 Oct 2009 00:35:39 +0000"  >&lt;p&gt;How does this relate to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1416&quot; title=&quot;Pool of commit loggers in each HRegionServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1416&quot;&gt;&lt;del&gt;HBASE-1416&lt;/del&gt;&lt;/a&gt;? I was looking at that. I think work on that issue and this one would clobber each other. &lt;/p&gt;</comment>
                            <comment id="12770729" author="jdcryans" created="Wed, 28 Oct 2009 00:40:22 +0000"  >&lt;p&gt;Well if &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1416&quot; title=&quot;Pool of commit loggers in each HRegionServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1416&quot;&gt;&lt;del&gt;HBASE-1416&lt;/del&gt;&lt;/a&gt; is really just about the first issue then I think this jira plays well with it, we can have a commit thread per WAL for example. Also my patch is already done, I&apos;m currently running the unit tests to make sure I didn&apos;t forget something.&lt;/p&gt;</comment>
                            <comment id="12770731" author="apurtell" created="Wed, 28 Oct 2009 00:44:24 +0000"  >&lt;p&gt;Sounds good J-D.&lt;/p&gt;</comment>
                            <comment id="12770735" author="jdcryans" created="Wed, 28 Oct 2009 00:54:02 +0000"  >&lt;p&gt;Patch that implements the group commit but that also cleans up &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-200&quot; title=&quot;In HDFS, sync() not yet guarantees data available to the new readers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-200&quot;&gt;&lt;del&gt;HDFS-200&lt;/del&gt;&lt;/a&gt; era code. Passes all tests&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I remove LogFlusher in favor of the LogSyncer thread. This also fixes the fact that the optional log flush value was never use.&lt;/li&gt;
	&lt;li&gt;I use an AtomicBoolean to force sync. This part was tricky because there is no message passing between the client thread and the LogSyncer.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12770736" author="jdcryans" created="Wed, 28 Oct 2009 00:57:08 +0000"  >&lt;p&gt;Damn forgot to mention that according to my many tests, single thread writing is ~1% slower but using 9 threads you get a 15-20% improvement.&lt;/p&gt;</comment>
                            <comment id="12770765" author="stack" created="Wed, 28 Oct 2009 03:23:06 +0000"  >&lt;p&gt;This can be final:&lt;/p&gt;

&lt;p&gt;+  private LogSyncer logSyncerThread;&lt;/p&gt;

&lt;p&gt;Can this be static inner class?  Paass in flushinterval?  And the atomicboolean close?  Make it private?&lt;/p&gt;

&lt;p&gt;+  public class LogSyncer extends Thread {&lt;/p&gt;

&lt;p&gt;Why syncfs and not just sync?  syncfs was name of the method in hdfs-200... its now called hflush?&lt;/p&gt;

&lt;p&gt;Do the above on commit I&apos;d say.  They are small changes.   Looks good to me J-D.&lt;/p&gt;</comment>
                            <comment id="12770769" author="jdcryans" created="Wed, 28 Oct 2009 03:34:58 +0000"  >&lt;p&gt;I&apos;m good with the comments.&lt;/p&gt;

&lt;p&gt;There&apos;s already a method called sync in HLog that&apos;s used from HRS and such so I was searching for another name. I&apos;ll rename it to syncAppends maybe? Or syncOutputStream?&lt;/p&gt;

&lt;p&gt;Have you tried it on a heavy write job?&lt;/p&gt;

&lt;p&gt;Thx!&lt;/p&gt;</comment>
                            <comment id="12770770" author="stack" created="Wed, 28 Oct 2009 03:40:39 +0000"  >&lt;p&gt;call it hflush?  its the new style!&lt;/p&gt;

&lt;p&gt;I did not try your patch.  Will do after you commit.&lt;/p&gt;</comment>
                            <comment id="12770771" author="jdcryans" created="Wed, 28 Oct 2009 03:47:16 +0000"  >&lt;p&gt;Doh missed that part.&lt;/p&gt;

&lt;p&gt;BTW, I cannot have the class static because it relies on the instance of that HLog as it calls hsync and uses its close boolean.&lt;/p&gt;</comment>
                            <comment id="12770774" author="jdcryans" created="Wed, 28 Oct 2009 03:59:25 +0000"  >&lt;p&gt;Committed to trunk, please test your massive inserts and see how better (or worse, could happen) it is when syncing every edit.&lt;/p&gt;</comment>
                            <comment id="12770786" author="rangadi" created="Wed, 28 Oct 2009 04:59:37 +0000"  >
&lt;p&gt;&amp;gt;+    // Set force sync if force is true and forceSync is false&lt;br/&gt;
&amp;gt;+    forceSync.compareAndSet(!forceSync.get() &amp;amp;&amp;amp; force, true);&lt;/p&gt;

&lt;p&gt;Wouldn&apos;t this leave forceSync to &apos;true&apos; all the time?&lt;/p&gt;</comment>
                            <comment id="12770789" author="jdcryans" created="Wed, 28 Oct 2009 05:15:51 +0000"  >&lt;p&gt;Raghu,&lt;/p&gt;

&lt;p&gt;Thanks for looking at this patch, I guess I am wrong but in the way you described.&lt;/p&gt;

&lt;p&gt; !(true) &amp;amp;&amp;amp; false =&amp;gt; false == false then set it to true. That&apos;s ok you want to let it true&lt;br/&gt;
 !(false) &amp;amp;&amp;amp; false =&amp;gt; false == false then set it to true. That&apos;s not ok we want it to stay false&lt;br/&gt;
 !(false) &amp;amp;&amp;amp; true =&amp;gt; true != false then let it be false. That&apos;s not ok we want it to be true&lt;br/&gt;
 !(true) &amp;amp;&amp;amp; true =&amp;gt; false != true then let it be true. That&apos;s ok you want it true&lt;/p&gt;

&lt;p&gt;Also that value is reset in hsync to false.&lt;/p&gt;

&lt;p&gt;So I indeed need to fix this thx!&lt;/p&gt;</comment>
                            <comment id="12770795" author="rangadi" created="Wed, 28 Oct 2009 05:22:24 +0000"  >&lt;p&gt;&amp;gt; Wouldn&apos;t this leave forceSync to &apos;true&apos; all the time?&lt;br/&gt;
not all the time. forceSync will remain unchanged when &apos;force&apos; is true. &lt;/p&gt;

&lt;p&gt;syncDone needs to be signaled in finally? Otherwise might leave the waiters hanging. &lt;/p&gt;</comment>
                            <comment id="12771023" author="jdcryans" created="Wed, 28 Oct 2009 17:51:53 +0000"  >&lt;p&gt;Reopening since it seems I was too fast at committing.&lt;/p&gt;</comment>
                            <comment id="12771055" author="jdcryans" created="Wed, 28 Oct 2009 18:55:03 +0000"  >&lt;p&gt;Second version of the patch against current trunk with Raghu&apos;s comments.&lt;/p&gt;

&lt;p&gt;So I changed the condition so that it really sets to force if force == true and forceSync == false. In all the other cases it should stay to current value and hsync resets to false if the value was set to true. I also cleaned a LOG which has an unnecessary stack trace and removed now un-thrown exceptions.&lt;/p&gt;</comment>
                            <comment id="12771124" author="stack" created="Wed, 28 Oct 2009 21:22:04 +0000"  >&lt;p&gt;+1 Looks good to me.&lt;/p&gt;</comment>
                            <comment id="12771173" author="jdcryans" created="Wed, 28 Oct 2009 22:45:16 +0000"  >&lt;p&gt;Committed patch to trunk.&lt;/p&gt;</comment>
                            <comment id="12771542" author="rangadi" created="Thu, 29 Oct 2009 18:37:30 +0000"  >&lt;p&gt;Thanks J-D.&lt;/p&gt;

&lt;p&gt;I should have seen the update earlier... not sure how important &apos;force&apos; flag is. Currently it might not work properly.&lt;/p&gt;

&lt;p&gt;Say sync thread starts fs_sync() at time t0. At t1 a client appends and invokes a force-sync... I am assuming the contract is  it should return after next fs_sync. But in the current implementation, it may not : when fs_sync() returns at t2, it sets this flag to false.. client&apos;s force-sync could return without a fs_sync.&lt;/p&gt;

&lt;p&gt;I might implement it something like :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 addToSyncQ(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; force) {
   lock()
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (force) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.forceSync = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
   }
  &lt;span class=&quot;code-comment&quot;&gt;//...
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Rest of the implementation remains same.. with forceSync being a simple boolean rather than an atomic.&lt;/p&gt;</comment>
                            <comment id="12771563" author="jdcryans" created="Thu, 29 Oct 2009 19:05:19 +0000"  >&lt;p&gt;Raghu,&lt;/p&gt;

&lt;p&gt;Again thanks a lot for spending some time looking at my work.&lt;/p&gt;

&lt;p&gt;So the background is that the catalog tables like .META. must never lose any edits so, even if we sync every 100 edits for some reason, when this catalog edit comes in we want to make sure it&apos;s safely registered. &lt;/p&gt;

&lt;p&gt;And you are right, this is not the right place to set force as you pointed out.&lt;/p&gt;</comment>
                            <comment id="12771612" author="jdcryans" created="Thu, 29 Oct 2009 20:59:17 +0000"  >&lt;p&gt;v3 with Raghu&apos;s comments.&lt;/p&gt;</comment>
                            <comment id="12771617" author="stack" created="Thu, 29 Oct 2009 21:04:22 +0000"  >&lt;p&gt;Should the forceSync be volatile?  Otherwise patch looks good (make it volatile on commit?)&lt;/p&gt;</comment>
                            <comment id="12771634" author="rangadi" created="Thu, 29 Oct 2009 21:37:44 +0000"  >&lt;p&gt;+1. It does not need to be volatile since it is always accessed under the same lock.&lt;/p&gt;</comment>
                            <comment id="12771641" author="stack" created="Thu, 29 Oct 2009 21:48:55 +0000"  >&lt;p&gt;@Raghu Will that ensure all threads see most recent change to forceSync? &lt;/p&gt;</comment>
                            <comment id="12771700" author="rangadi" created="Thu, 29 Oct 2009 23:47:19 +0000"  >&lt;p&gt;yes. should be same as accessing inside a synchronized section. We could consider atomic or volatile if findbugs does not see that.&lt;/p&gt;</comment>
                            <comment id="12771710" author="jdcryans" created="Fri, 30 Oct 2009 00:12:05 +0000"  >&lt;p&gt;I committed without the volatile.&lt;/p&gt;</comment>
                            <comment id="12772690" author="jdcryans" created="Mon, 2 Nov 2009 21:08:48 +0000"  >&lt;p&gt;Resolving since it wasn&apos;t the source of Hudson&apos;s instability.&lt;/p&gt;</comment>
                            <comment id="12839121" author="nspiegelberg" created="Sat, 27 Feb 2010 01:46:43 +0000"  >&lt;p&gt;Ported this patch back to version 0.20.  Note that this refactoring incidentally fixed a bug on the tip with HLog.sync().  To summarize, the code under sync() should read &lt;br/&gt;
    sync(); syncFs() &lt;br/&gt;
instead of &lt;br/&gt;
    (syncFs) ? syncFs() : sync();  &lt;br/&gt;
sync() flushes the SequenceFile.Writer buffer to DFSOutputStream.  syncFs() flushes the output stream across the network to the datanodes.  So the current implementation isn&apos;t flushing the buffers properly and still gets stuck on local storage until the SequenceFile.Writer buffer is full. &lt;/p&gt;</comment>
                            <comment id="12842317" author="stack" created="Sat, 6 Mar 2010 21:25:26 +0000"  >&lt;p&gt;I applied Nicolas&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1939&quot; title=&quot;HLog group commit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1939&quot;&gt;&lt;del&gt;HBASE-1939&lt;/del&gt;&lt;/a&gt;-20.4.patch above under the aegis of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2298&quot; title=&quot;Backport of &amp;quot;HLog Group Commit&amp;quot; to 0.20 branch.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2298&quot;&gt;&lt;del&gt;HBASE-2298&lt;/del&gt;&lt;/a&gt;.  It doesn&apos;t look like TRUNK has the above issue calling sync (it don&apos;t use hdfs-200) but talking J-D in case.&lt;/p&gt;</comment>
                            <comment id="15017993" author="lars_francke" created="Fri, 20 Nov 2015 13:02:09 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12456602">HBASE-2234</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12425297">HBASE-1416</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12437297" name="HBASE-1939-20.4.patch" size="31585" author="nspiegelberg" created="Sat, 27 Feb 2010 01:46:42 +0000"/>
                            <attachment id="12423479" name="HBASE-1939-v2.patch" size="1674" author="jdcryans" created="Wed, 28 Oct 2009 18:55:03 +0000"/>
                            <attachment id="12423621" name="HBASE-1939-v3.patch" size="2308" author="jdcryans" created="Thu, 29 Oct 2009 20:59:17 +0000"/>
                            <attachment id="12423379" name="HBASE-1939.patch" size="15446" author="jdcryans" created="Wed, 28 Oct 2009 00:54:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 28 Oct 2009 00:35:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32321</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hfxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99844</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>