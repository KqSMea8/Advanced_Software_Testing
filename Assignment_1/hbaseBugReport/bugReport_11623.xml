<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:25:01 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11623/HBASE-11623.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11623] mutateRowsWithLocks might require updatesLock.readLock with waitTime=0</title>
                <link>https://issues.apache.org/jira/browse/HBASE-11623</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;mutateRowsWithLocks will acquire updatesLock.readLock by the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
lock(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.updatesLock.readLock(), acquiredRowLocks.size());
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, acquiredRowLocks might be empty, and then the waitTime of HRegion.lock(...) will be set to 0, which will make mutateRowsWithLocks fail if can not acquire updatesLock.readLock immediately. &lt;br/&gt;
In our environment, we implement a region coprocessor which need to hold row locks before invoke mutateRowsWithLocks. Then, the rowsToLock(passed to mutateRowsWithLocks) will be an empty set, and we get the following exception occasionally:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.hadoop.hbase.RegionTooBusyException: failed to get a lock in 0ms                                                                                          
 582   at org.apache.hadoop.hbase.regionserver.HRegion.lock(HRegion.java:6191)
 583   at org.apache.hadoop.hbase.regionserver.HRegion.mutateRowsWithLocks(HRegion.java:5126)
 584   at org.apache.hadoop.hbase.regionserver.HRegion.mutateRowsWithLocks(HRegion.java:5034)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;Is it reasonable that we use default waitTime when rowsToLock is empty? (as the following code)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
lock(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.updatesLock.readLock(), acquiredRowLocks.size() == 0 ? 1 : acquiredRowLocks.size());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12730992">HBASE-11623</key>
            <summary>mutateRowsWithLocks might require updatesLock.readLock with waitTime=0</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cuijianwei">Jianwei Cui</assignee>
                                    <reporter username="cuijianwei">Jianwei Cui</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Jul 2014 04:50:35 +0000</created>
                <updated>Sat, 9 Aug 2014 04:40:03 +0000</updated>
                            <resolved>Thu, 31 Jul 2014 23:55:58 +0000</resolved>
                                    <version>0.96.1.1</version>
                    <version>0.94.21</version>
                    <version>0.98.4</version>
                                    <fixVersion>0.99.0</fixVersion>
                    <fixVersion>0.98.5</fixVersion>
                    <fixVersion>0.94.22</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14080492" author="yuzhihong@gmail.com" created="Thu, 31 Jul 2014 04:53:39 +0000"  >&lt;p&gt;Sounds good.&lt;br/&gt;
Do you want to attach a patch ?&lt;/p&gt;</comment>
                            <comment id="14080510" author="cuijianwei" created="Thu, 31 Jul 2014 05:20:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu&quot; class=&quot;user-hover&quot; rel=&quot;tedyu&quot;&gt;Ted Yu&lt;/a&gt;, thanks for your comment, I added patches for trunk.&lt;/p&gt;</comment>
                            <comment id="14080515" author="yuzhihong@gmail.com" created="Thu, 31 Jul 2014 05:28:10 +0000"  >&lt;p&gt;lgtm&lt;/p&gt;</comment>
                            <comment id="14080522" author="lhofhansl" created="Thu, 31 Jul 2014 05:34:12 +0000"  >&lt;p&gt;Good find. Or just &lt;tt&gt;acquiredRowLocks.size() + 1&lt;/tt&gt;?&lt;br/&gt;
+1 for 0.94 as well.&lt;/p&gt;</comment>
                            <comment id="14080611" author="cuijianwei" created="Thu, 31 Jul 2014 07:37:48 +0000"  >&lt;p&gt;&quot;acquiredRowLocks.size() + 1&quot; is also ok. There is a little difference. When acquiredRowLocks is not empty, the waitTime might be different from that in HRegion.doMiniBatchMutation(...):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
lock(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.updatesLock.readLock(), numReadyToWrite); &lt;span class=&quot;code-comment&quot;&gt;// in HRegion.doMiniBatchMutation(...)&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;do we need to make the two places have the same waitTime when having the same number of writes?&lt;/p&gt;</comment>
                            <comment id="14081053" author="lhofhansl" created="Thu, 31 Jul 2014 16:17:29 +0000"  >&lt;p&gt;You version is fine. +1. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cuijianwei&quot; class=&quot;user-hover&quot; rel=&quot;cuijianwei&quot;&gt;Jianwei Cui&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14081148" author="lhofhansl" created="Thu, 31 Jul 2014 17:21:40 +0000"  >&lt;p&gt;Going to commit unless I hear objects. (want to get a 0.94.22 RC out)&lt;/p&gt;</comment>
                            <comment id="14081417" author="apurtell" created="Thu, 31 Jul 2014 20:33:03 +0000"  >&lt;p&gt;Same here, want to get the 0.98.5 RC out. Please commit to 0.94+ Lars. Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; for branch-1. &lt;/p&gt;</comment>
                            <comment id="14081701" author="lhofhansl" created="Thu, 31 Jul 2014 23:55:58 +0000"  >&lt;p&gt;Committed to everywhere (except 0.96)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12658861" name="HBASE-11623-0.94-v1.patch" size="654" author="cuijianwei" created="Thu, 31 Jul 2014 07:38:07 +0000"/>
                            <attachment id="12658842" name="HBASE-11623-trunk-v1.patch" size="836" author="cuijianwei" created="Thu, 31 Jul 2014 05:20:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 31 Jul 2014 04:53:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>409064</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ydtj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>409060</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>