<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:07:50 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3159/HBASE-3159.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3159] Double play of OpenedRegionHandler for a single region; fails second time through and aborts Master</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3159</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Here is master log with annotations: &lt;a href=&quot;http://people.apache.org/~stack/master.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://people.apache.org/~stack/master.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Region in question is:&lt;/p&gt;

&lt;p&gt;b8827a67a9d446f345095d25e1f375f7&lt;/p&gt;

&lt;p&gt;The running code is doctored in that I&apos;ve added in a bit of logging &amp;#8211; zk in particular &amp;#8211; and I&apos;ve also removed what I thought was a provocation of this condition, reassign inside in an assign if server has gone away when we try the open rpc (Turns out we have the condition even w/o this code in place).&lt;/p&gt;

&lt;p&gt;The log starts where the region in question timesout in RIT.&lt;/p&gt;

&lt;p&gt;We assign it to 186.&lt;/p&gt;

&lt;p&gt;Notice how we see &apos;Handling transition&apos; for this region TWICE.  This means two OpenedRegionHandlers will be scheduled &amp;#8211; and so the failure to delete a znode already gone.&lt;/p&gt;

&lt;p&gt;As best I can tell, the watcher for this region is triggered once only &amp;#8211; which is odd because how then the double scheduling of OpenedRegionHandler but also, why am I not seeing OPENING, OPENING, OPENED and only what I presume is an OPENED?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12478421">HBASE-3159</key>
            <summary>Double play of OpenedRegionHandler for a single region; fails second time through and aborts Master</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="streamy">Jonathan Gray</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Oct 2010 05:53:09 +0000</created>
                <updated>Fri, 20 Nov 2015 12:41:06 +0000</updated>
                            <resolved>Thu, 28 Oct 2010 21:33:42 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12925518" author="streamy" created="Wed, 27 Oct 2010 19:32:49 +0000"  >&lt;p&gt;Got a double OPENED of meta on the master running my new TestRollingRestart test which does lots of RS killing.&lt;/p&gt;

&lt;p&gt;Attaching two logs.  One is raw log from section where problem happened, the second is just the master part (this is unit test so RS+master combined).&lt;/p&gt;</comment>
                            <comment id="12925521" author="streamy" created="Wed, 27 Oct 2010 19:36:42 +0000"  >&lt;p&gt;This is fairly easy to &quot;fix&quot; in a way that will not make the master abort.  But this does not get to the underlying cause of triggered to OPENED handlers.  There&apos;s something going on there that we need to keep digging on (I&apos;m doing so now but with added logging it&apos;s not happening anymore).&lt;/p&gt;

&lt;p&gt;The fix to prevent abort is to transition the in-memory RIT to the OPEN state when we handleRegion(regionTransitionData).  Exactly like we&apos;re already doing in the CLOSED handling in that method, we need to do this:&lt;/p&gt;

&lt;p&gt;+          regionState.update(RegionState.State.OPEN, data.getStamp());&lt;/p&gt;

&lt;p&gt;When the next attempted handle of the OPENED state comes in, we won&apos;t process it because it&apos;s not in the expected states of PENDING_OPEN or OPENING, and then the closed handler won&apos;t be executed.&lt;/p&gt;

&lt;p&gt;But yeah, let&apos;s not put that fix in yet.  Seems like some screwy with ZK watches being fired though we don&apos;t expect a watch to be set or something.  Digging more...&lt;/p&gt;</comment>
                            <comment id="12925522" author="streamy" created="Wed, 27 Oct 2010 19:40:47 +0000"  >&lt;p&gt;Previous files were a bit borked.  These should not be missing lines.&lt;/p&gt;</comment>
                            <comment id="12925605" author="streamy" created="Wed, 27 Oct 2010 23:35:36 +0000"  >&lt;p&gt;Stack, when you rerun your tests again, turn off the ZK client logging and ensure all of our ZK logging is set to pickup DEBUG level.  There&apos;s always a slight chance we would want the raw ZK client logs, if something really crazy is happening, but there should be enough logging in our ZKW and ZKUtil as long as we pick up debug.&lt;/p&gt;

&lt;p&gt;One thing though, change the method at the bottom of ZKUtil to the following:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  private static void logRetrievedMsg(final ZooKeeperWatcher zkw,
      final String znode, final byte [] data, final boolean watcherSet) {
    if (!LOG.isDebugEnabled()) return;
    LOG.debug(zkw.prefix(&quot;Retrieved &quot; + ((data == null)? 0: data.length) +
      &quot; byte(s) of data from znode &quot; + znode +
      (watcherSet? &quot; and set watcher; &quot;: &quot;; data=&quot;) +
      (data == null? &quot;null&quot;: (
          znode.startsWith(zkw.assignmentZNode) ?
              RegionTransitionData.fromBytes(data).toString()
              : StringUtils.abbreviate(Bytes.toString(data), 32)))));
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The change is that we detect if we&apos;re logging an unassigned znode, and if so, we print the region transition data.  This will make debugging this much simpler.&lt;/p&gt;</comment>
                            <comment id="12925608" author="streamy" created="Thu, 28 Oct 2010 00:00:22 +0000"  >&lt;p&gt;This is my latest patch doing unit tests of rolling restarts.  Has some logging changes and a couple small fixes.&lt;/p&gt;

&lt;p&gt;Also includes the non-fix fix I described earlier but it&apos;s commented out so we can still detect this broken state.&lt;/p&gt;</comment>
                            <comment id="12925617" author="streamy" created="Thu, 28 Oct 2010 00:28:35 +0000"  >&lt;p&gt;Probably not related but just uncovered a small race condition in AssignmentManager around line 806 in assign(RegionState):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      // Send OPEN RPC. This can fail if the server on other end is is not up.
      serverManager.sendRegionOpen(plan.getDestination(), state.getRegion());
      // Transition RegionState to PENDING_OPEN
      state.update(RegionState.State.PENDING_OPEN);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We need to update the state to PENDING_OPEN before we send the RPC.  Otherwise we could get the OPENING and we&apos;ll still be in OFFLINE state locally so we will reject the transition.&lt;/p&gt;</comment>
                            <comment id="12925676" author="streamy" created="Thu, 28 Oct 2010 03:45:58 +0000"  >&lt;p&gt;Interesting failure w/ root assignment.  Stack, I think you&apos;re better to look at this one.&lt;/p&gt;</comment>
                            <comment id="12925852" author="streamy" created="Thu, 28 Oct 2010 16:04:02 +0000"  >&lt;p&gt;Another issue during TestRollingRestart.&lt;/p&gt;

&lt;p&gt;When RS is opening META, it goes to update ROOT location.&lt;/p&gt;

&lt;p&gt;In the code, it seems like it&apos;s supposed to wait indefinitely for a ROOT location before proceeding with the edit for the new meta location.  But in the log it hardly waits at all.  And seemingly returns a null location, which it should not if there&apos;s no root location.&lt;/p&gt;

&lt;p&gt;In CT.getCachedConnection(HServerAddress) it looks like we will return null in many different instances (and not even log that a connection exception happened).  Somehow we&apos;re returning true from the blocking calls waiting on root, but then when we go to verify it doesn&apos;t work?&lt;/p&gt;</comment>
                            <comment id="12925920" author="hbasereviewboard" created="Thu, 28 Oct 2010 19:14:05 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1108/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1108/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase and Jonathan Gray.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Here is patch I&apos;ve been testing with up on cluster.  Adds debugging and two fixes &amp;#8211; one setting state to OPEN on receipt of a rs opened event and two, resetting a watcher getting data over in zkutil (as per its documentation claims).&lt;/p&gt;


&lt;p&gt;This addresses bug hbase-3159.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/hbase-3159&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/hbase-3159&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 30e49c8 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/handler/ClosedRegionHandler.java 1a88700 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/handler/OpenedRegionHandler.java d4fa82b &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKAssign.java 81661ef &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java 21a4256 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1108/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1108/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Running on cluster&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;stack&lt;/p&gt;

</comment>
                            <comment id="12925953" author="streamy" created="Thu, 28 Oct 2010 21:32:56 +0000"  >&lt;p&gt;Patch committed.&lt;/p&gt;</comment>
                            <comment id="12925954" author="streamy" created="Thu, 28 Oct 2010 21:33:42 +0000"  >&lt;p&gt;Committed to trunk.  Thanks stack for working with me on this, reviewing, and being awesome at breaking stuff &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15016885" author="lars_francke" created="Fri, 20 Nov 2015 12:41:06 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12458282" name="HBASE-3159-FINAL.patch" size="30480" author="streamy" created="Thu, 28 Oct 2010 21:32:56 +0000"/>
                            <attachment id="12458208" name="TestRollingRestart-v4.patch" size="25419" author="streamy" created="Thu, 28 Oct 2010 00:00:22 +0000"/>
                            <attachment id="12458180" name="hbase-meta-dupe-opened-master-only.txt" size="8331" author="streamy" created="Wed, 27 Oct 2010 19:40:47 +0000"/>
                            <attachment id="12458181" name="hbase-meta-dupe-opened.txt" size="15412" author="streamy" created="Wed, 27 Oct 2010 19:42:02 +0000"/>
                            <attachment id="12458229" name="master-root-assign-abort.log" size="15600" author="streamy" created="Thu, 28 Oct 2010 03:45:58 +0000"/>
                            <attachment id="12458259" name="rs_death_on_meta_open_no_root.txt" size="13953" author="streamy" created="Thu, 28 Oct 2010 16:04:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 27 Oct 2010 19:32:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26681</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hkz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100660</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>