<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:29:47 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5659/HBASE-5659.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5659] TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5659</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;See run here: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1318//testReport/org.apache.hadoop.hbase.regionserver/TestAtomicOperation/testMultiRowMutationMultiThreads/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1318//testReport/org.apache.hadoop.hbase.regionserver/TestAtomicOperation/testMultiRowMutationMultiThreads/&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;2012-03-27 04:36:12,627 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-118&amp;#93;&lt;/span&gt; regionserver.StoreScanner(499): Storescanner.peek() is changed where before = rowB/colfamily11:qual1/7202/Put/vlen=6/ts=7922,and after = rowB/colfamily11:qual1/7199/DeleteColumn/vlen=0/ts=0&lt;br/&gt;
2012-03-27 04:36:12,629 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-121&amp;#93;&lt;/span&gt; regionserver.HRegion(1558): Finished memstore flush of ~2.9k/2952, currentsize=1.6k/1640 for region testtable,,1332822963417.7cd30e219714cfc5e91f69def66e7f81. in 14ms, sequenceid=7927, compaction requested=true&lt;br/&gt;
2012-03-27 04:36:12,629 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.TestAtomicOperation$2(362): flushing&lt;br/&gt;
2012-03-27 04:36:12,630 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.HRegion(1426): Started memstore flush for testtable,,1332822963417.7cd30e219714cfc5e91f69def66e7f81., current region memstore size 1.9k&lt;br/&gt;
2012-03-27 04:36:12,630 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.HRegion(1474): Finished snapshotting testtable,,1332822963417.7cd30e219714cfc5e91f69def66e7f81., commencing wait for mvcc, flushsize=1968&lt;br/&gt;
2012-03-27 04:36:12,630 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.HRegion(1484): Finished snapshotting, commencing flushing stores&lt;br/&gt;
2012-03-27 04:36:12,630 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; util.FSUtils(153): Creating file=/home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/trunk/target/test-data/b9091c3c-961e-4035-850a-83ad14d517cc/TestAtomicOperationtestMultiRowMutationMultiThreads/testtable/7cd30e219714cfc5e91f69def66e7f81/.tmp/61954619003e469baf1a34be5ff2ec57 with permission=rwxrwxrwx&lt;br/&gt;
2012-03-27 04:36:12,631 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; hfile.HFileWriterV2(143): Initialized with CacheConfig:enabled &lt;span class=&quot;error&quot;&gt;&amp;#91;cacheDataOnRead=true&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cacheDataOnWrite=false&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cacheIndexesOnWrite=false&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cacheBloomsOnWrite=false&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cacheEvictOnClose=false&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;cacheCompressed=false&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-03-27 04:36:12,631 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.StoreFile$Writer(997): Delete Family Bloom filter type for /home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/trunk/target/test-data/b9091c3c-961e-4035-850a-83ad14d517cc/TestAtomicOperationtestMultiRowMutationMultiThreads/testtable/7cd30e219714cfc5e91f69def66e7f81/.tmp/61954619003e469baf1a34be5ff2ec57: CompoundBloomFilterWriter&lt;br/&gt;
2012-03-27 04:36:12,632 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.StoreFile$Writer(1220): NO General Bloom and NO DeleteFamily was added to HFile (/home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/trunk/target/test-data/b9091c3c-961e-4035-850a-83ad14d517cc/TestAtomicOperationtestMultiRowMutationMultiThreads/testtable/7cd30e219714cfc5e91f69def66e7f81/.tmp/61954619003e469baf1a34be5ff2ec57) &lt;br/&gt;
2012-03-27 04:36:12,632 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.Store(770): Flushed , sequenceid=7934, memsize=1.9k, into tmp file /home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/trunk/target/test-data/b9091c3c-961e-4035-850a-83ad14d517cc/TestAtomicOperationtestMultiRowMutationMultiThreads/testtable/7cd30e219714cfc5e91f69def66e7f81/.tmp/61954619003e469baf1a34be5ff2ec57&lt;br/&gt;
2012-03-27 04:36:12,632 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.Store(795): Renaming flushed file at /home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/trunk/target/test-data/b9091c3c-961e-4035-850a-83ad14d517cc/TestAtomicOperationtestMultiRowMutationMultiThreads/testtable/7cd30e219714cfc5e91f69def66e7f81/.tmp/61954619003e469baf1a34be5ff2ec57 to /home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/trunk/target/test-data/b9091c3c-961e-4035-850a-83ad14d517cc/TestAtomicOperationtestMultiRowMutationMultiThreads/testtable/7cd30e219714cfc5e91f69def66e7f81/colfamily11/61954619003e469baf1a34be5ff2ec57&lt;br/&gt;
2012-03-27 04:36:12,634 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.Store(818): Added /home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/trunk/target/test-data/b9091c3c-961e-4035-850a-83ad14d517cc/TestAtomicOperationtestMultiRowMutationMultiThreads/testtable/7cd30e219714cfc5e91f69def66e7f81/colfamily11/61954619003e469baf1a34be5ff2ec57, entries=12, sequenceid=7934, filesize=1.3k&lt;br/&gt;
2012-03-27 04:36:12,642 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-118&amp;#93;&lt;/span&gt; regionserver.TestAtomicOperation$2(392): []&lt;br/&gt;
Exception in thread &quot;Thread-118&quot; junit.framework.AssertionFailedError	at junit.framework.Assert.fail(Assert.java:48)&lt;br/&gt;
	at junit.framework.Assert.fail(Assert.java:56)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.TestAtomicOperation$2.run(TestAtomicOperation.java:394)&lt;br/&gt;
2012-03-27 04:36:12,643 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-126&amp;#93;&lt;/span&gt; regionserver.HRegion(1558): Finished memstore flush of ~1.9k/1968, currentsize=1.3k/1312 for region testtable,,1332822963417.7cd30e219714cfc5e91f69def66e7f81. in 14ms, sequenceid=7934, compaction requested=true&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I think this issue is different from parent.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12548382">HBASE-5659</key>
            <summary>TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12546184">HBASE-5569</parent>
                                    <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lhofhansl">Lars Hofhansl</assignee>
                                    <reporter username="lhofhansl">Lars Hofhansl</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Mar 2012 20:48:59 +0000</created>
                <updated>Tue, 26 Feb 2013 16:56:31 +0000</updated>
                            <resolved>Tue, 24 Jul 2012 05:20:01 +0000</resolved>
                                                    <fixVersion>0.94.1</fixVersion>
                    <fixVersion>0.95.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13419722" author="lhofhansl" created="Sat, 21 Jul 2012 02:28:00 +0000"  >&lt;p&gt;Without parent the revised test fails every time. With parent it fails rarely.&lt;br/&gt;
I do not know what the issue is.&lt;/p&gt;

&lt;p&gt;This only happens when the test does heavy flushing (during the course of the test &amp;gt; 1000 flushes happen. So the problem might be there.&lt;/p&gt;

&lt;p&gt;I can offer to disable the test or to reduce the number of flushes for now, but of course that pastes over the problem.&lt;/p&gt;

&lt;p&gt;I also would not mind if somebody else has a look at the test and check whether test logic itself is flawed.&lt;/p&gt;</comment>
                            <comment id="13420098" author="lhofhansl" created="Sun, 22 Jul 2012 03:11:38 +0000"  >&lt;p&gt;This always comes after the change from &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; is triggered.&lt;br/&gt;
Looking back at &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; it should only be triggered during a major compaction, but apparently it is not. &lt;/p&gt;</comment>
                            <comment id="13420099" author="lhofhansl" created="Sun, 22 Jul 2012 03:14:24 +0000"  >&lt;p&gt;I think there is a subtle bug lurking somewhere. This test just happens to trigger that problem.&lt;/p&gt;</comment>
                            <comment id="13420110" author="lhofhansl" created="Sun, 22 Jul 2012 05:41:16 +0000"  >&lt;p&gt;While this (probably) won&apos;t fix the problem I would like to propose this simple change to the logic introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
The observation is that a change top KV is only a problem when the KV&apos;s row has changed from the previous one.&lt;/p&gt;</comment>
                            <comment id="13420114" author="hadoopqa" created="Sun, 22 Jul 2012 06:44:00 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12537477/5659.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12537477/5659.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    -1 javac.  The applied patch generated 5 javac compiler warnings (more than the trunk&apos;s current 4 warnings).&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 14 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.master.TestSplitLogManager&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2423//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13420281" author="lhofhansl" created="Sun, 22 Jul 2012 19:20:18 +0000"  >&lt;p&gt;The patch is also a slight performance improvement. &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; is too eager I think. The tests introduced with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; still pass with this change.&lt;/p&gt;</comment>
                            <comment id="13420314" author="lhofhansl" created="Sun, 22 Jul 2012 20:15:59 +0000"  >&lt;p&gt;In the latest failed runs I see this:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;org.apache.hadoop.hbase.DroppedSnapshotException: region: testtable,,1342893920897.74c4711d8d09b8d84618388ce125cedd.	at org.apache.hadoop.hbase.regionserver.HRegion.internalFlushcache(HRegion.java:1474)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegion.internalFlushcache(HRegion.java:1353)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegion.flushcache(HRegion.java:1294)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.TestAtomicOperation$1.run(TestAtomicOperation.java:278)&lt;br/&gt;
Caused by: java.io.FileNotFoundException: /home/hudson/hudson-slave/workspace/HBase-0.94/trunk/target/test-data/bca87d6a-50fb-4cdc-9e8c-72912928f4ed/TestAtomicOperationtestRowMutationMultiThreads/testtable/74c4711d8d09b8d84618388ce125cedd/.tmp/62b35712575041f28c04f6f953830b80 (Too many open files)&lt;br/&gt;
	at java.io.FileOutputStream.open(Native Method)&lt;br/&gt;
	at java.io.FileOutputStream.&amp;lt;init&amp;gt;(FileOutputStream.java:194)&lt;br/&gt;
	at org.apache.hadoop.fs.RawLocalFileSystem$LocalFSFileOutputStream.&amp;lt;init&amp;gt;(RawLocalFileSystem.java:188)&lt;br/&gt;
	at org.apache.hadoop.fs.RawLocalFileSystem$LocalFSFileOutputStream.&amp;lt;init&amp;gt;(RawLocalFileSystem.java:184)&lt;br/&gt;
	at org.apache.hadoop.fs.RawLocalFileSystem.create(RawLocalFileSystem.java:255)&lt;br/&gt;
	at org.apache.hadoop.fs.RawLocalFileSystem.create(RawLocalFileSystem.java:236)&lt;br/&gt;
	at org.apache.hadoop.fs.ChecksumFileSystem$ChecksumFSOutputSummer.&amp;lt;init&amp;gt;(ChecksumFileSystem.java:335)&lt;br/&gt;
	at org.apache.hadoop.fs.ChecksumFileSystem.create(ChecksumFileSystem.java:381)&lt;br/&gt;
	at org.apache.hadoop.fs.ChecksumFileSystem.create(ChecksumFileSystem.java:364)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.FSUtils.create(FSUtils.java:151)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.FSUtils.create(FSUtils.java:126)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.hfile.AbstractHFileWriter.createOutputStream(AbstractHFileWriter.java:271)&lt;br/&gt;
	at org.apache.hadoop.hbase.io.hfile.HFile$WriterFactory.create(HFile.java:393)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.StoreFile$Writer.&amp;lt;init&amp;gt;(StoreFile.java:956)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.StoreFile$Writer.&amp;lt;init&amp;gt;(StoreFile.java:901)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.StoreFile$WriterBuilder.build(StoreFile.java:815)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.Store.createWriterInTmp(Store.java:836)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.Store.createWriterInTmp(Store.java:816)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.Store.internalFlushCache(Store.java:717)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.Store.flushCache(Store.java:674)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.Store.access$400(Store.java:108)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.Store$StoreFlusherImpl.flushCache(Store.java:2247)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegion.internalFlushcache(HRegion.java:1449)&lt;br/&gt;
	... 3 more&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13420316" author="lhofhansl" created="Sun, 22 Jul 2012 20:23:02 +0000"  >&lt;p&gt;In fact all recent runs with this test failed show this exception.&lt;/p&gt;</comment>
                            <comment id="13420320" author="lhofhansl" created="Sun, 22 Jul 2012 20:28:50 +0000"  >&lt;p&gt;So then here&apos;s a new theory: The test produces &amp;gt; 1000 flushes. Compactions can&apos;t keep up, hence a scan will need to merge all these files together. The limit for the test is 1024 open files.&lt;br/&gt;
I would still like to include the first patch.&lt;/p&gt;</comment>
                            <comment id="13420322" author="lhofhansl" created="Sun, 22 Jul 2012 20:42:11 +0000"  >&lt;p&gt;Patch that only compares rows when top KV is changed and also reduces the number of ops/thread to 500 in testMultiRowMutationMultiThreads (same value now as in testRowMutationMultiThreads).&lt;/p&gt;

&lt;p&gt;I will commit this soon, if no objections.&lt;/p&gt;</comment>
                            <comment id="13420337" author="stack" created="Sun, 22 Jul 2012 21:32:17 +0000"  >&lt;p&gt;Patch seems fine to me.&lt;/p&gt;</comment>
                            <comment id="13420343" author="hadoopqa" created="Sun, 22 Jul 2012 21:40:04 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12537521/5659-v2.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12537521/5659-v2.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    -1 javac.  The applied patch generated 5 javac compiler warnings (more than the trunk&apos;s current 4 warnings).&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 14 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;/p&gt;


&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2427//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13420393" author="zjushch" created="Mon, 23 Jul 2012 02:07:52 +0000"  >&lt;p&gt;@Lars&lt;br/&gt;
Could you add the failed test result except the exception caused by too many open files.&lt;br/&gt;
From the description, I don&apos;t see the following debug log&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (r.size() != 1) {
                LOG.debug(r);
                failures.incrementAndGet();
                fail();
              }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13420395" author="zjushch" created="Mon, 23 Jul 2012 02:12:04 +0000"  >&lt;p&gt;Sorry, I find the debug log...Let me think about why...&lt;/p&gt;</comment>
                            <comment id="13420401" author="zjushch" created="Mon, 23 Jul 2012 02:55:49 +0000"  >&lt;p&gt;The description log is 2012-03-27,  from the log &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2012-03-27 04:36:12,627 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-118&amp;#93;&lt;/span&gt; regionserver.StoreScanner(499): Storescanner.peek() is changed where before = rowB/colfamily11:qual1/7202/Put/vlen=6/ts=7922,and after = rowB/colfamily11:qual1/7199/DeleteColumn/vlen=0/ts=0&lt;/p&gt;&lt;/blockquote&gt; 
&lt;p&gt;Major compaction deleted the two KVs(rowB/colfamily11:qual1/7202/Put/vlen=6/ts=7922 rowB/colfamily11:qual1/7202/DeleteColumn), but the scanner is not closed, we shouldn&apos;t do the deleting.&lt;/p&gt;

&lt;p&gt;However, it is previous log, is there any recent log?&lt;/p&gt;</comment>
                            <comment id="13420403" author="zjushch" created="Mon, 23 Jul 2012 02:59:44 +0000"  >&lt;p&gt;About the patch, I don&apos;t think so, it will affect the scan&apos;s correctness again&lt;br/&gt;
Why Storescanner.peek() will be changed when checkReseek()(Only do this action after Flush or Compaction), in current logic it shouldn&apos;t happen as per MVCC&lt;/p&gt;</comment>
                            <comment id="13420414" author="zjushch" created="Mon, 23 Jul 2012 03:57:14 +0000"  >&lt;p&gt;@Lars&lt;br/&gt;
The above is something wrong, I think patch is OK, sorry to make mistake.&lt;/p&gt;

&lt;p&gt;I run the test many times but can&apos;t reproduce,  so it&apos;s hard to find the reason, waiting for your recent logs, thanks!&lt;/p&gt;</comment>
                            <comment id="13420428" author="lhofhansl" created="Mon, 23 Jul 2012 04:48:34 +0000"  >&lt;p&gt;Thanks for looking at this Chunhui. This is a tricky area.&lt;br/&gt;
Let me check in this change and see whether it happens again.&lt;/p&gt;

&lt;p&gt;A failed run is here: &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/354/testReport/org.apache.hadoop.hbase.regionserver/TestAtomicOperation/testRowMutationMultiThreads/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/354/testReport/org.apache.hadoop.hbase.regionserver/TestAtomicOperation/testRowMutationMultiThreads/&lt;/a&gt;&lt;br/&gt;
and here: &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/353/testReport/org.apache.hadoop.hbase.regionserver/TestAtomicOperation/testRowMutationMultiThreads/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/353/testReport/org.apache.hadoop.hbase.regionserver/TestAtomicOperation/testRowMutationMultiThreads/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Although, now I am beginning to think this is something new.&lt;/p&gt;</comment>
                            <comment id="13420435" author="zjushch" created="Mon, 23 Jul 2012 05:11:15 +0000"  >&lt;p&gt;I think a case to fail the case&#65292; maybe it is quite rare,&lt;br/&gt;
For the testRowMutationMultiThreads, assume there are 3 threads&lt;/p&gt;

&lt;p&gt;1.Thread 1: rowA/colfamily11:qual1/1/Put/vlen=6/&lt;br/&gt;
rowA/colfamily11:qual2/1/DeleteColumn/vlen=6/&lt;/p&gt;

&lt;p&gt;2.Thread 3: rowA/colfamily11:qual1/3/DeleteColumn/vlen=6/&lt;br/&gt;
rowA/colfamily11:qual2/3/Put/vlen=6/&lt;/p&gt;

&lt;p&gt;3.Make major compaction&lt;/p&gt;

&lt;p&gt;4.Thread 2:rowA/colfamily11:qual1/2/Put/vlen=6/&lt;br/&gt;
rowA/colfamily11:qual2/2/DeleteColumn/vlen=6/&lt;/p&gt;

&lt;p&gt;5.Thread 2: Get rowA, and the result is &lt;br/&gt;
rowA/colfamily11:qual1/2/Put/vlen=6/ + rowA/colfamily11:qual2/3/Put/vlen=6/&lt;/p&gt;
</comment>
                            <comment id="13420441" author="lhofhansl" created="Mon, 23 Jul 2012 05:25:27 +0000"  >&lt;p&gt;Committed to 0.94 and 0.96. I&apos;ll watch the test results.&lt;/p&gt;</comment>
                            <comment id="13420442" author="zjushch" created="Mon, 23 Jul 2012 05:25:58 +0000"  >&lt;p&gt;For the above failed tests( &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/353/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/353/&lt;/a&gt; &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/354/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/354/&lt;/a&gt;), I took a look and find they were both caused by too many open files&lt;/p&gt;</comment>
                            <comment id="13420443" author="lhofhansl" created="Mon, 23 Jul 2012 05:28:32 +0000"  >&lt;p&gt;Oops. Didn&apos;t see the comment.&lt;br/&gt;
The problem in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; was that the scanner.next(...) would see a mix of KV from different rows, which would violate the scanner contract.&lt;/p&gt;

&lt;p&gt;Is this a different problem? Is the a problem with my change here?&lt;br/&gt;
Lastly, could you make a runnable test? That&apos;d be extremely helpful.&lt;/p&gt;

&lt;p&gt;If it fails, even if rarely, it is a bug. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13420444" author="lhofhansl" created="Mon, 23 Jul 2012 05:30:00 +0000"  >&lt;p&gt;Re: Failed tests. Yes, I cannot find a single run that was not caused by TooManyOpenFiles.&lt;/p&gt;</comment>
                            <comment id="13420445" author="lhofhansl" created="Mon, 23 Jul 2012 05:30:48 +0000"  >&lt;p&gt;So you think the change is bad (comparing just the row of the old and new top KV)?&lt;/p&gt;</comment>
                            <comment id="13420447" author="zjushch" created="Mon, 23 Jul 2012 05:40:13 +0000"  >&lt;p&gt;@Lars&lt;br/&gt;
I think patch won&apos;t make some problem, but I don&apos;t think it&apos;s the reason of the failed tests.&lt;/p&gt;

&lt;p&gt;If all failed test were caused by TooManyOpenFiles, maybe there&apos;s no problem in current logic.&lt;/p&gt;

&lt;p&gt;Correct me if wrong...Thanks&lt;/p&gt;</comment>
                            <comment id="13420468" author="hudson" created="Mon, 23 Jul 2012 06:47:40 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #3163 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/3163/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/3163/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally (Revision 1364501)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13420472" author="lhofhansl" created="Mon, 23 Jul 2012 06:54:33 +0000"  >&lt;p&gt;@Chunhui: I am not convinced either, honestly.&lt;br/&gt;
Since the failure is so hard to reproduce I can only wait until the next failure now.&lt;/p&gt;</comment>
                            <comment id="13420477" author="hudson" created="Mon, 23 Jul 2012 07:08:02 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #355 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/355/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/355/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally (Revision 1364502)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13420575" author="hudson" created="Mon, 23 Jul 2012 11:39:58 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #106 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/106/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/106/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally (Revision 1364501)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13421100" author="lhofhansl" created="Tue, 24 Jul 2012 01:59:13 +0000"  >&lt;p&gt;I think I figured out what causes the &quot;too many open files&quot; problem.&lt;br/&gt;
In Store.commitFile a StoreFile.reader is created, but never closed.&lt;/p&gt;</comment>
                            <comment id="13421104" author="lhofhansl" created="Tue, 24 Jul 2012 02:04:18 +0000"  >&lt;p&gt;From Store.commitFile(...)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    StoreFile sf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StoreFile(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fs, dstPath, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.conf, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.cacheConf,
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.family.getBloomFilterType(), &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataBlockEncoder);
    passSchemaMetricsTo(sf);

    StoreFile.Reader r = sf.createReader();
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.storeSize += r.length();
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.totalUncompressedBytes += r.getTotalUncompressedBytes();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The created reader then is not closed. Is that by design (i.e. the reader is preopened for performance, because we expect the flushed file to be read soon), or is this an oversight? &lt;/p&gt;

&lt;p&gt;Maybe somebody else could have a look?&lt;/p&gt;</comment>
                            <comment id="13421106" author="lhofhansl" created="Tue, 24 Jul 2012 02:05:37 +0000"  >&lt;p&gt;I tested this by setting the &quot;open files&quot; limit to small value. When the reader is closed in commitFile(...) the &quot;too many open files&quot; exception does not occur.&lt;/p&gt;</comment>
                            <comment id="13421113" author="lhofhansl" created="Tue, 24 Jul 2012 02:20:03 +0000"  >&lt;p&gt;Here&apos;s the addendum I have in mind.&lt;br/&gt;
Makes TestAtomicOperation pass even with a low &quot;open files&quot; setting (256, which previously would always fail).&lt;/p&gt;

&lt;p&gt;The previous changes are still valid.&lt;/p&gt;</comment>
                            <comment id="13421121" author="zhihyu@ebaysf.com" created="Tue, 24 Jul 2012 02:33:52 +0000"  >&lt;p&gt;Nice finding.&lt;/p&gt;

&lt;p&gt;Should true be passed to r.close() ?&lt;/p&gt;

&lt;p&gt;bulkLoadHFile() has a reader which is not closed. Should the reader be closed ?&lt;/p&gt;</comment>
                            <comment id="13421130" author="lhofhansl" created="Tue, 24 Jul 2012 02:55:45 +0000"  >&lt;p&gt;It&apos;s not 100% clear to me that the reader should be closed. There are other places where a reader is created but not closed (just searching for &quot;createreader&quot; in Store.java reveal a bunch).&lt;br/&gt;
In this case I just tried figure out why so many storefiles are opened (I used lsof to list the open files).&lt;/p&gt;

&lt;p&gt;In Store.completeCompation() loops over all StoreFiles and expects that each has an opened reader (suggesting my addendum change would actually be incorrect).&lt;br/&gt;
TestAtomicOperation just creates a &lt;b&gt;lot&lt;/b&gt; of storefiles.&lt;/p&gt;

&lt;p&gt;The other thing I found is that while TestAtomicOperation#testRowMutationMultiThreads causes 25 threads to have all storefiles open (even though the test only uses 10 threads). When I run the test with only one thread I see 16 threads having all storefiles open.&lt;br/&gt;
Something is funky.&lt;/p&gt;</comment>
                            <comment id="13421137" author="zhihyu@ebaysf.com" created="Tue, 24 Jul 2012 03:06:04 +0000"  >&lt;p&gt;I don&apos;t see completeCompation in Store.java&lt;br/&gt;
Can you list the line number ?&lt;/p&gt;</comment>
                            <comment id="13421142" author="lhofhansl" created="Tue, 24 Jul 2012 03:19:33 +0000"  >&lt;p&gt;Line 1664 (sorry, the 0.94 codeline)&lt;/p&gt;</comment>
                            <comment id="13421150" author="zhihyu@ebaysf.com" created="Tue, 24 Jul 2012 03:39:59 +0000"  >&lt;p&gt;Found it.&lt;/p&gt;

&lt;p&gt;I think StoreFile readers should be closed at the end of Store.completeCompaction()&lt;/p&gt;</comment>
                            <comment id="13421154" author="zhihyu@ebaysf.com" created="Tue, 24 Jul 2012 03:56:27 +0000"  >&lt;p&gt;Correction for above observation.&lt;br/&gt;
Readers for old store files are deleted already (line 1714):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-comment&quot;&gt;// Finally, delete old store files.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (StoreFile hsf: compactedFiles) {
        hsf.deleteReader();
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13421158" author="lhofhansl" created="Tue, 24 Jul 2012 04:08:58 +0000"  >&lt;p&gt;I think that all StoreFiles in Store.storefiles are supposed to have an open reader:&lt;br/&gt;
From completeCompaction.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// 4. Compute &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; store size
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.storeSize = 0L;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.totalUncompressedBytes = 0L;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (StoreFile hsf : &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.storefiles) {
      StoreFile.Reader r = hsf.getReader();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (r == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;StoreFile &quot;&lt;/span&gt; + hsf + &lt;span class=&quot;code-quote&quot;&gt;&quot; has a &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; Reader&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another change, which fixes TestAtomicOperation is to introduce a compaction for each 10 flushes.&lt;br/&gt;
I would still like to find out why so many have threads have the &lt;b&gt;same&lt;/b&gt; HFiles open.&lt;/p&gt;</comment>
                            <comment id="13421167" author="lhofhansl" created="Tue, 24 Jul 2012 04:30:19 +0000"  >&lt;p&gt;Never mind. Threads of the same process share the same open files of course.&lt;/p&gt;</comment>
                            <comment id="13421174" author="lhofhansl" created="Tue, 24 Jul 2012 04:56:18 +0000"  >&lt;p&gt;The reader being closed in commitFile was a dud, I think.&lt;br/&gt;
Here&apos;s a patch that throws in some compactions during the test. With that I can reliably run TestAtomicOperation with &quot;open files&quot; set to 512 (which would other reliably fail the test).&lt;/p&gt;

&lt;p&gt;The test machines have &quot;open files&quot; = 1024, so that would provide enough buffer.&lt;/p&gt;

&lt;p&gt;Addendum-v2 is not contentious I think. Will commit soon, unless there are objections.&lt;/p&gt;</comment>
                            <comment id="13421176" author="ram_krish" created="Tue, 24 Jul 2012 04:58:49 +0000"  >&lt;p&gt;I think by design we keep the storefiles open.  We have observed that if we have a bigger value for files to compact and we continuously keep flushing then lsof keeps raising. Frequent minor compaction reduces the count of lsof.  May be for this testcase we have so many flushes happening and the compaction is not happening so often.&lt;br/&gt;
Even when you do openRegion on a new RS one of the step is to open up all the readers and have it.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.storefiles = sortAndClone(loadStoreFiles());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13421177" author="ram_krish" created="Tue, 24 Jul 2012 05:00:11 +0000"  >&lt;p&gt;@Lars&lt;br/&gt;
Oops, comments crossed.  Just saw patch.  +1.  Doing frequent compactions should resolve this problem.&lt;/p&gt;</comment>
                            <comment id="13421188" author="lhofhansl" created="Tue, 24 Jul 2012 05:20:01 +0000"  >&lt;p&gt;OK... Committed addendum. I hope this is the end of this.&lt;br/&gt;
Thanks for looking at this Ram and Ted.&lt;/p&gt;</comment>
                            <comment id="13421204" author="hudson" created="Tue, 24 Jul 2012 06:08:10 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #359 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/359/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/359/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; Addendum (Revision 1364894)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13421224" author="hudson" created="Tue, 24 Jul 2012 06:53:13 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #3169 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/3169/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/3169/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; Addendum (Revision 1364895)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13421236" author="stack" created="Tue, 24 Jul 2012 07:27:36 +0000"  >&lt;p&gt;Yeah, we keep readers open so we don&apos;t pay the opening price once rather than inline w/ reads.&lt;/p&gt;</comment>
                            <comment id="13421341" author="hudson" created="Tue, 24 Jul 2012 11:42:44 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #108 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/108/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/108/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; Addendum (Revision 1364895)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13421667" author="hudson" created="Tue, 24 Jul 2012 19:08:12 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #45 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/45/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/45/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; Addendum (Revision 1364894)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally (Revision 1364502)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13428752" author="hudson" created="Sun, 5 Aug 2012 00:51:16 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security-on-Hadoop-23 #6 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/6/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/6/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; Addendum (Revision 1364894)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt; TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally (Revision 1364502)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestAtomicOperation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12537140">HBASE-5121</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12537646" name="5659-addendum-v2.txt" size="1013" author="lhofhansl" created="Tue, 24 Jul 2012 04:56:18 +0000"/>
                            <attachment id="12537639" name="5659-addendum.txt" size="487" author="lhofhansl" created="Tue, 24 Jul 2012 02:20:03 +0000"/>
                            <attachment id="12537521" name="5659-v2.txt" size="2068" author="lhofhansl" created="Sun, 22 Jul 2012 20:42:11 +0000"/>
                            <attachment id="12537477" name="5659.txt" size="851" author="lhofhansl" created="Sun, 22 Jul 2012 05:41:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 22 Jul 2012 06:44:00 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233479</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08rxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>49126</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>