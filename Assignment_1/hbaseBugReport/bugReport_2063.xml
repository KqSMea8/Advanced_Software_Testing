<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:58:39 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2063/HBASE-2063.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2063] For hfileoutputformat, on timeout/failure/kill clean up half-written hfile</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2063</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Below is from mailing list.  Read from bottom to top:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 I was going to write that perhaps you needed to turn mapred.reduce.tasks.speculative.execution off, but &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; enabling it and things work, that would seem to indicate that a our reducer first takes longer than the task timeout maximum and secondly, on failure, we should clean up the hfile.

On the first issue, you are using KeyValueSortReducer?  Are your values large?  We set reducer status every 100 values.  Maybe &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is not enough?  We should set status more frequently?  If you call context setstatus more frequently, &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; things work w/o speculative execution?
 
On the second, HFileOutputFormat close will set the metadata on the hfile and then close it.  On kill, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; code is not being called.   Let me see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; can &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something about that (e.g. register a shutdown hook to clean away incomplete files -- ).

Thanks,
St.Ack


On Sun, Dec 20, 2009 at 11:26 PM, ChingShen &amp;lt;chingshenchen@gmail.com&amp;gt; wrote:
I think I found a way.
I set the &lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.reduce.tasks.speculative.execution&quot;&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; and output
hfiles again, then successfully load hfiles into hbase.
Is it best solution? or HFileOutputFormat bug?

Shen

On Mon, Dec 21, 2009 at 8:25 AM, ChingShen &amp;lt;chingshenchen@gmail.com&amp;gt; wrote:

&amp;gt; Thanks, stack.
&amp;gt;
&amp;gt; I checked &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; file that isn&apos;t empty. But I found that as &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; as the
&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;Killed Task Attempts&quot;&lt;/span&gt; &amp;gt; 0 in reduce phase, and run the loadtable.rb script
&amp;gt; to load hfiles then failed.
&amp;gt; How to avoid &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; problem?
&amp;gt;
&amp;gt; Thanks.
&amp;gt;
&amp;gt; Shen
&amp;gt;
&amp;gt;
&amp;gt; On Sat, Dec 19, 2009 at 3:49 AM, stack &amp;lt;stack@duboce.net&amp;gt; wrote:
&amp;gt;
&amp;gt;&amp;gt; Check the
&amp;gt;&amp;gt; file
&amp;gt;&amp;gt; hdfs:&lt;span class=&quot;code-comment&quot;&gt;//domU-12-31-39-09-C5-54.compute-1.internal/osm2_hfile/Level4/197894389945760574.
&lt;/span&gt;&amp;gt;&amp;gt;  Is it empty?  Was there an error during running of your MR job?  Perhaps
&amp;gt;&amp;gt; a
&amp;gt;&amp;gt; task failed?
&amp;gt;&amp;gt;
&amp;gt;&amp;gt; St.Ack
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt;&amp;gt;
&amp;gt;&amp;gt; On Thu, Dec 17, 2009 at 9:46 PM, ChingShen &amp;lt;chingshenchen@gmail.com&amp;gt;
&amp;gt;&amp;gt; wrote:
&amp;gt;&amp;gt;
&amp;gt;&amp;gt; &amp;gt; Hi,
&amp;gt;&amp;gt; &amp;gt;  I use the script loadtable.rb to load my hfiles into hbase, but I got
&amp;gt;&amp;gt; an
&amp;gt;&amp;gt; &amp;gt; exception as below.
&amp;gt;&amp;gt; &amp;gt;  Does anyone have any suggestions?
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt; 09/12/17 23:59:33 INFO loadtable: 18 read firstkey of -3.9290_52.5534
&amp;gt;&amp;gt; from
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; hdfs:&lt;span class=&quot;code-comment&quot;&gt;//domU-12-31-39-09-C5-54.compute-1.internal/osm2_hfile/Level4/1978943899457605747
&lt;/span&gt;&amp;gt;&amp;gt; &amp;gt; org/apache/hadoop/hbase/io/hfile/HFile.java:1335:in `deserialize&apos;:
&amp;gt;&amp;gt; &amp;gt; java.io.IOException: Trailer &apos;header&apos; is wrong; does the trailer size
&amp;gt;&amp;gt; match
&amp;gt;&amp;gt; &amp;gt; content? (NativeException)
&amp;gt;&amp;gt; &amp;gt;    from org/apache/hadoop/hbase/io/hfile/HFile.java:813:in `readTrailer&apos;
&amp;gt;&amp;gt; &amp;gt;    from org/apache/hadoop/hbase/io/hfile/HFile.java:758:in
&amp;gt;&amp;gt; `loadFileInfo&apos;
&amp;gt;&amp;gt; &amp;gt;    from sun.reflect.GeneratedMethodAccessor7:-1:in `invoke&apos;
&amp;gt;&amp;gt; &amp;gt;    from sun/reflect/DelegatingMethodAccessorImpl.java:25:in `invoke&apos;
&amp;gt;&amp;gt; &amp;gt;    from java/lang/reflect/Method.java:597:in `invoke&apos;
&amp;gt;&amp;gt; &amp;gt;    from org/jruby/javasupport/JavaMethod.java:298:in
&amp;gt;&amp;gt; &amp;gt; `invokeWithExceptionHandling&apos;
&amp;gt;&amp;gt; &amp;gt;    from org/jruby/javasupport/JavaMethod.java:259:in `invoke&apos;
&amp;gt;&amp;gt; &amp;gt;    from org/jruby/java/invokers/InstanceMethodInvoker.java:36:in `call&apos;
&amp;gt;&amp;gt; &amp;gt;     ... 18 levels...
&amp;gt;&amp;gt; &amp;gt;    from org/jruby/Main.java:94:in `main&apos;
&amp;gt;&amp;gt; &amp;gt;    from loadtable.rb:83:in `each&apos;
&amp;gt;&amp;gt; &amp;gt;    from loadtable.rb:83
&amp;gt;&amp;gt; &amp;gt; Complete Java stackTrace
&amp;gt;&amp;gt; &amp;gt; java.io.IOException: Trailer &apos;header&apos; is wrong; does the trailer size
&amp;gt;&amp;gt; match
&amp;gt;&amp;gt; &amp;gt; content?
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.apache.hadoop.hbase.io.hfile.HFile$FixedFileTrailer.deserialize(HFile.java:1335)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.apache.hadoop.hbase.io.hfile.HFile$Reader.readTrailer(HFile.java:813)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.apache.hadoop.hbase.io.hfile.HFile$Reader.loadFileInfo(HFile.java:758)
&amp;gt;&amp;gt; &amp;gt;    at sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
&amp;gt;&amp;gt; &amp;gt;    at java.lang.reflect.Method.invoke(Method.java:597)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.jruby.javasupport.JavaMethod.invokeWithExceptionHandling(JavaMethod.java:298)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.javasupport.JavaMethod.invoke(JavaMethod.java:259)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.jruby.java.invokers.InstanceMethodInvoker.call(InstanceMethodInvoker.java:36)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt; org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:70)
&amp;gt;&amp;gt; &amp;gt;    at loadtable.ensure_1$RUBY$__ensure___2(loadtable.rb:86)
&amp;gt;&amp;gt; &amp;gt;    at loadtable.block_0$RUBY$__for__(loadtable.rb:85)
&amp;gt;&amp;gt; &amp;gt;    at loadtableBlockCallback$block_0$RUBY$__for__xx1.call(Unknown
&amp;gt;&amp;gt; Source)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.runtime.CompiledBlock.yield(CompiledBlock.java:102)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.runtime.Block.yield(Block.java:100)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; org.jruby.java.proxies.ArrayJavaProxy.each(ArrayJavaProxy.java:112)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.jruby.java.proxies.ArrayJavaProxy$i_method_0_0$RUBYINVOKER$each.call(org/jruby/java/proxies/ArrayJavaProxy$i_method_0_0$RUBYINVOKER$each.gen)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:263)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.jruby.runtime.callsite.CachingCallSite.callBlock(CachingCallSite.java:81)
&amp;gt;&amp;gt; &amp;gt;    at
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt; org.jruby.runtime.callsite.CachingCallSite.callIter(CachingCallSite.java:96)
&amp;gt;&amp;gt; &amp;gt;    at loadtable.__file__(loadtable.rb:83)
&amp;gt;&amp;gt; &amp;gt;    at loadtable.load(loadtable.rb)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.Ruby.runScript(Ruby.java:577)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.Ruby.runNormally(Ruby.java:480)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.Ruby.runFromMain(Ruby.java:354)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.Main.run(Main.java:229)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.Main.run(Main.java:110)
&amp;gt;&amp;gt; &amp;gt;    at org.jruby.Main.main(Main.java:94)
&amp;gt;&amp;gt; &amp;gt;
&amp;gt;&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt;
&amp;gt;


--
*****************************************************
Ching-Shen Chen
Advanced Technology Center,
Information &amp;amp; Communications Research Lab.
E-mail: chenchingshen@itri.org.tw
Tel:+886-3-5915542
*****************************************************

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12443925">HBASE-2063</key>
            <summary>For hfileoutputformat, on timeout/failure/kill clean up half-written hfile</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Dec 2009 16:35:49 +0000</created>
                <updated>Fri, 12 Oct 2012 06:14:59 +0000</updated>
                            <resolved>Thu, 4 Mar 2010 16:39:55 +0000</resolved>
                                    <version>0.20.3</version>
                                    <fixVersion>0.20.4</fixVersion>
                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12840337" author="lansa" created="Tue, 2 Mar 2010 21:40:52 +0000"  >&lt;p&gt;attached is the patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2063&quot; title=&quot;For hfileoutputformat, on timeout/failure/kill clean up half-written hfile&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2063&quot;&gt;&lt;del&gt;HBASE-2063&lt;/del&gt;&lt;/a&gt;-v1.patch) for HFileOutputFormat:&lt;br/&gt;
to avoid such kind of problems need to use working path instead of output path in HFileOutputFormat.RecordWriter.&lt;br/&gt;
so, temporary data of failed attempts will be removed and corrupted HFiles will not appear in output folder and loadtable.rb script will go without exceptions.&lt;/p&gt;</comment>
                            <comment id="12840387" author="stack" created="Tue, 2 Mar 2010 23:42:41 +0000"  >&lt;p&gt;Moving into 0.20.4.&lt;/p&gt;</comment>
                            <comment id="12840388" author="stack" created="Tue, 2 Mar 2010 23:43:41 +0000"  >&lt;p&gt;Ruslan: Patch looks great.  Thanks for fixing this.  Will apply soon.&lt;/p&gt;</comment>
                            <comment id="12840390" author="stack" created="Tue, 2 Mar 2010 23:49:54 +0000"  >&lt;p&gt;Marking patch available&lt;/p&gt;</comment>
                            <comment id="12840411" author="chingshen" created="Wed, 3 Mar 2010 00:56:36 +0000"  >&lt;p&gt;I just patched this issue, but the problem still exists.&lt;/p&gt;</comment>
                            <comment id="12840644" author="lansa" created="Wed, 3 Mar 2010 13:05:19 +0000"  >&lt;p&gt;Ching-Shen: Let&apos;s double check, can you see _temporary folder in your output path during MR execution (after MR execution you will have the folder with the same name as a column of your table and _temporary folder will be removed)? if not then probably patch was not applied.&lt;/p&gt;</comment>
                            <comment id="12841097" author="chingshen" created="Thu, 4 Mar 2010 07:12:12 +0000"  >&lt;p&gt;Thanks Ruslan, It works well. (I think I forgot to distribute the hbase.jar to slaves, It&apos;s my fault.)&lt;/p&gt;</comment>
                            <comment id="12841373" author="stack" created="Thu, 4 Mar 2010 16:39:55 +0000"  >&lt;p&gt;Commmitted branch and trunk.  Thanks for the nice patch Ruslan Salyakhov.   Thanks for verifying fix Ching-Shen Chen .&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12457965">HBASE-2280</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12437647" name="HBASE-2063-v1.patch" size="1116" author="lansa" created="Tue, 2 Mar 2010 21:40:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 2 Mar 2010 21:40:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26126</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08stj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>49269</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>