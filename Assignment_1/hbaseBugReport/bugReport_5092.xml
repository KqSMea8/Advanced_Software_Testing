<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:24:41 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5092/HBASE-5092.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5092] Two adjacent assignments lead region is in PENDING_OPEN state and block table disable and enable actions.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5092</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>
&lt;p&gt;Region is in PENDING_OPEN state and disable and enable are blocked.&lt;/p&gt;

&lt;p&gt;We occasionally find if two assignments which have a short interval time will lead to a PENDING_OPEN state staying in the regionInTransition map and blocking the disable and enable table actions.&lt;/p&gt;

&lt;p&gt;We found that the second assignment will set the zknode of this region to M_ZK_REGION_OFFLINE then set the state in assignmentMananger&apos;s regionInTransition map to PENDING_OPEN and abort its further operation because of finding the the region is already in the regionserver by a RegionAlreadyInTransitionException.&lt;br/&gt;
At the same time the first assignment is tickleOpening and find the version of the zknode is messed up by the  second assignment, so the OpenRegionHandler print out the following two lines:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
2011-12-23 22:12:15,197 WARN  [RS_OPEN_REGION-data16,59892,1324649528415-0] zookeeper.ZKAssign(788): regionserver:59892-0x1346b43b91e0002 Attempt to transition the unassigned node for 15237599c632752b8cfd3d5a86349768 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENING failed, the node existed but was version 2 not the expected version 1
2011-12-23 22:12:15,197 WARN  [RS_OPEN_REGION-data16,59892,1324649528415-0] handler.OpenRegionHandler(403): Failed refreshing OPENING; region=15237599c632752b8cfd3d5a86349768, context=post_region_open
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;After that it tries to turn the state to FAILED_OPEN, but also failed due to wrong version,&lt;/p&gt;

&lt;p&gt;this is the output:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
2011-12-23 22:12:15,199 WARN  [RS_OPEN_REGION-data16,59892,1324649528415-0] zookeeper.ZKAssign(812): regionserver:59892-0x1346b43b91e0002 Attempt to transition the unassigned node for 15237599c632752b8cfd3d5a86349768 from RS_ZK_REGION_OPENING to RS_ZK_REGION_FAILED_OPEN failed, the node existed but was in the state M_ZK_REGION_OFFLINE set by the server data16,59892,1324649528415
2011-12-23 22:12:15,199 WARN  [RS_OPEN_REGION-data16,59892,1324649528415-0] handler.OpenRegionHandler(307): Unable to mark region {NAME =&amp;gt; &apos;table1,,1324649533045.15237599c632752b8cfd3d5a86349768.&apos;, STARTKEY =&amp;gt; &apos;&apos;, ENDKEY =&amp;gt; &apos;&apos;, ENCODED =&amp;gt; 15237599c632752b8cfd3d5a86349768,} as FAILED_OPEN. It&apos;s likely that the master already timed out this open attempt, and thus another RS already has the region.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;So after all that, the PENDING_OPEN state is left in the assignmentMananger&apos;s regionInTransition map and none will deal with it further,&lt;br/&gt;
This kind of situation will wait until the master find the state out of time.&lt;/p&gt;


&lt;p&gt;The following is the test code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;test.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testDisableTables() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 20; i++) {
      HTableDescriptor des = admin.getTableDescriptor(Bytes.toBytes(table1));
      List&amp;lt;HRegionInfo&amp;gt; hris = TEST_UTIL.getHBaseCluster().getMaster()
          .getAssignmentManager().getRegionsOfTable(Bytes.toBytes(table1));
      TEST_UTIL.getHBaseCluster().getMaster()
          .assign(hris.get(0).getRegionName());
  
      TEST_UTIL.getHBaseCluster().getMaster()
          .assign(hris.get(0).getRegionName());
  
      admin.disableTable(Bytes.toBytes(table1));
      admin.modifyTable(Bytes.toBytes(table1), des);
      admin.enableTable(Bytes.toBytes(table1));
    }
  }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To fix this,we add a line to &lt;/p&gt;

&lt;p&gt;public static int ZKAssign.transitionNode() to make endState.RS_ZK_REGION_FAILED_OPEN transition pass.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;ZKAssign.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;((!existingData.getEventType().equals(beginState))
      &lt;span class=&quot;code-comment&quot;&gt;//add the following line to make endState.RS_ZK_REGION_FAILED_OPEN transition pass.
&lt;/span&gt;      &amp;amp;&amp;amp;(!endState.equals(endState.RS_ZK_REGION_FAILED_OPEN))) {
      LOG.warn(zkw.prefix(&lt;span class=&quot;code-quote&quot;&gt;&quot;Attempt to transition the &quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;unassigned node &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; + encoded +
        &lt;span class=&quot;code-quote&quot;&gt;&quot; from &quot;&lt;/span&gt; + beginState + &lt;span class=&quot;code-quote&quot;&gt;&quot; to &quot;&lt;/span&gt; + endState + &lt;span class=&quot;code-quote&quot;&gt;&quot; failed, &quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;the node existed but was in the state &quot;&lt;/span&gt; + existingData.getEventType() +
        &lt;span class=&quot;code-quote&quot;&gt;&quot; set by the server &quot;&lt;/span&gt; + serverName));
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Run the test case again we found that before the first assignment trans the state from offline to opening, the second assignment could set the state to offline again and messed up the version of zknode.&lt;/p&gt;


&lt;p&gt;In OpenRegionHandler.process() the following part failed and make the process() return.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;OpenRegionHandler.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!transitionZookeeperOfflineToOpening(encodedName,
          versionOfOfflineNode)) {
        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Region was hijacked? It no longer exists, encodedName=&quot;&lt;/span&gt; +
          encodedName);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;      }&lt;/p&gt;

&lt;p&gt;//So we add the following code to the part to make this open region process to FAILED_OPEN.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;OpenRegionHandler.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!transitionZookeeperOfflineToOpening(encodedName,
          versionOfOfflineNode)) {
        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Region was hijacked? It no longer exists, encodedName=&quot;&lt;/span&gt; +
          encodedName);
        tryTransitionToFailedOpen(regionInfo);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After the two amendments, two adjacent assignments will not lead to an unhandled PENDING_OPEN state.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12536253">HBASE-5092</key>
            <summary>Two adjacent assignments lead region is in PENDING_OPEN state and block table disable and enable actions.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="liujia_ict">Liu Jia</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Dec 2011 08:02:26 +0000</created>
                <updated>Sat, 11 Apr 2015 01:02:44 +0000</updated>
                            <resolved>Sat, 11 Apr 2015 01:02:44 +0000</resolved>
                                    <version>0.92.0</version>
                                                    <component>master</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13175330" author="ram_krish" created="Fri, 23 Dec 2011 08:44:12 +0000"  >&lt;p&gt;@Liu&lt;br/&gt;
Thanks for your analysis Liu and for the patch.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!transitionZookeeperOfflineToOpening(encodedName,
          versionOfOfflineNode)) {
        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Region was hijacked? It no longer exists, encodedName=&quot;&lt;/span&gt; +
          encodedName);
        tryTransitionToFailedOpen(regionInfo);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This fix may solve the problem in one case where the RIT exception is thrown as the second assign request goes to the same RS.  But this fix may not be correct when the second assign is going to the other RS.&lt;/p&gt;

&lt;p&gt;The first RS request will try to change the node from OFFLINE to FAILED_OPEN.  The second RS open request will expect the node state to be in OFFLINE but it will fail.  So once again the the assign retry should assign the region to another RS.&lt;/p&gt;

&lt;p&gt;As part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4153&quot; title=&quot;Handle RegionAlreadyInTransitionException in AssignmentManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4153&quot;&gt;&lt;del&gt;HBASE-4153&lt;/del&gt;&lt;/a&gt; it was fixed like RIT exception we will not retry specifically for the case when assign() is triggered externally. Lets wait for others suggestion also.&lt;/p&gt;



</comment>
                            <comment id="14490664" author="apurtell" created="Sat, 11 Apr 2015 01:02:44 +0000"  >&lt;p&gt;Reopen if still an issue with current code&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12508499" name="unhandled_PENDING_OPEN_lead_by_two_assignment.patch" size="1773" author="liujia_ict" created="Fri, 23 Dec 2011 08:11:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 23 Dec 2011 08:44:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>221936</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02bxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11534</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>