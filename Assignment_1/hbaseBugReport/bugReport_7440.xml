<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:45:47 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7440/HBASE-7440.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7440] ReplicationZookeeper#addPeer is racy</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7440</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;While adding a peer, ReplicationZK does the znodes creation in three transactions. Create :&lt;br/&gt;
a) peers znode&lt;br/&gt;
b) peerId specific znode, and&lt;br/&gt;
c) peerState znode&lt;/p&gt;

&lt;p&gt;There is a PeerWatcher which invokes getPeer() (after steps b) and c)). If it happens that while adding a peer, the control flows to getPeer() and step c) has not been processed, it may results in a state where the peer will not be added. This happens while running TestMasterReplication#testCyclicReplication().&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-12-26 07:36:35,187 INFO  [RegionServer:0;p0120.XXXXX,38423,1356536179470-EventThread] zookeeper.RecoverableZooKeeper(447): Node /2/replication/peers/1/peer-state already exists and &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is not a retry
2012-12-26 07:36:35,188 ERROR [RegionServer:0;p0120.XXXXX,38423,1356536179470-EventThread] regionserver.ReplicationSourceManager$PeersWatcher(527): Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; adding a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; peer
org.apache.zookeeper.KeeperException$NodeExistsException: KeeperErrorCode = NodeExists &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /2/replication/peers/1/peer-state
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:119)
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
	at org.apache.zookeeper.ZooKeeper.create(ZooKeeper.java:783)
	at org.apache.hadoop.hbase.zookeeper.RecoverableZooKeeper.createNonSequential(RecoverableZooKeeper.java:428)
	at org.apache.hadoop.hbase.zookeeper.RecoverableZooKeeper.create(RecoverableZooKeeper.java:410)
	at org.apache.hadoop.hbase.zookeeper.ZKUtil.createAndWatch(ZKUtil.java:1044)
	at org.apache.hadoop.hbase.replication.ReplicationPeer.startStateTracker(ReplicationPeer.java:82)
	at org.apache.hadoop.hbase.replication.ReplicationZookeeper.getPeer(ReplicationZookeeper.java:344)
	at org.apache.hadoop.hbase.replication.ReplicationZookeeper.connectToPeer(ReplicationZookeeper.java:307)
	at org.apache.hadoop.hbase.replication.regionserver.ReplicationSourceManager$PeersWatcher.nodeChildrenChanged(ReplicationSourceManager.java:519)
	at org.apache.hadoop.hbase.zookeeper.ZooKeeperWatcher.process(ZooKeeperWatcher.java:315)
	at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:519)
	at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:495)
2012-12-26 07:36:35,188 DEBUG [RegionServer:0;p0120.XXXXX,55742,1356536171947-EventThread] zookeeper.ZKUtil(1545): regionserver:55742-0x13bd7db39580004 Retrieved 36 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;(s) of data from znode /1/hbaseid; data=9ce66123-d3e8-4ae9-a249-afe03...

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12625299">HBASE-7440</key>
            <summary>ReplicationZookeeper#addPeer is racy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="v.himanshu">Himanshu Vashishtha</assignee>
                                    <reporter username="v.himanshu">Himanshu Vashishtha</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Dec 2012 00:07:56 +0000</created>
                <updated>Tue, 26 Feb 2013 16:21:58 +0000</updated>
                            <resolved>Sat, 29 Dec 2012 04:16:23 +0000</resolved>
                                    <version>0.94.3</version>
                                    <fixVersion>0.94.4</fixVersion>
                    <fixVersion>0.95.0</fixVersion>
                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13539777" author="v.himanshu" created="Thu, 27 Dec 2012 00:51:41 +0000"  >&lt;p&gt;0.94.x patch; it adds a guard while creating the peer-state znode.&lt;br/&gt;
TestMasterReplication passes.&lt;/p&gt;</comment>
                            <comment id="13539824" author="yuzhihong@gmail.com" created="Thu, 27 Dec 2012 04:32:18 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-comment&quot;&gt;// There is a race b/w PeerWatcher and ReplicationZookeeper#add method to create the peer-state znode. &lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Wrap long line above.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException.NodeExistsException nee) {
+        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;StateNode &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; + peerStateNode
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Shall we verify that the node carries data of PeerState.ENABLED ?&lt;br/&gt;
For the change in ReplicationZookeeper.java, similar comment applies in case of KeeperException.NodeExistsException.&lt;/p&gt;</comment>
                            <comment id="13539846" author="v.himanshu" created="Thu, 27 Dec 2012 06:40:03 +0000"  >&lt;p&gt;Wrapping the comment line. &lt;/p&gt;

&lt;p&gt;Since it is creating the peer-state znode and it has default value &quot;ENABLED&quot;, adding a check looks to be redundant. I can add that if you think otherwise.&lt;/p&gt;</comment>
                            <comment id="13539847" author="lhofhansl" created="Thu, 27 Dec 2012 06:40:45 +0000"  >&lt;p&gt;Could we use ZKUtil.createNodeIfNotExistsAndWatch for this?&lt;/p&gt;</comment>
                            <comment id="13539912" author="mbertozzi" created="Thu, 27 Dec 2012 11:12:13 +0000"  >&lt;p&gt;If you use createAndWatch() the node is not watched if it already exists,&lt;br/&gt;
instead if you use createNodeIfNotExistsAndWatch(), as suggested by Lars, you get the watcher on the newly created one or on the old one.&lt;br/&gt;
I think that you want the second behaviour, right?&lt;/p&gt;

&lt;p&gt;What do you expect if the node already exists, and is set to DISABLED?&lt;br/&gt;
I think is fine in that state, right? so, you don&apos;t need to check it or force it to ENABLED.&lt;/p&gt;</comment>
                            <comment id="13540077" author="v.himanshu" created="Thu, 27 Dec 2012 17:56:32 +0000"  >&lt;p&gt;Using ZKUtil.createNodeIfNotExistsAndWatch as suggested by Lars. Didn&apos;t notice this API earlier!&lt;br/&gt;
Yes Matteo, the default value of znode is ENABLED, and this code is called while creating one. So, no check needed or such.&lt;/p&gt;</comment>
                            <comment id="13540359" author="lhofhansl" created="Fri, 28 Dec 2012 06:30:19 +0000"  >&lt;p&gt;+1 on patch. This is a 0.94 patch. I assume the 0.96 patch would be close to identical.&lt;/p&gt;</comment>
                            <comment id="13540368" author="lhofhansl" created="Fri, 28 Dec 2012 06:41:24 +0000"  >&lt;p&gt;Logic in 0.96 is different (of course). Mind having a look, Himanshu?&lt;/p&gt;</comment>
                            <comment id="13540708" author="v.himanshu" created="Sat, 29 Dec 2012 01:20:57 +0000"  >&lt;p&gt;Patch for trunk; TestMasterReplication passes.&lt;/p&gt;</comment>
                            <comment id="13540712" author="yuzhihong@gmail.com" created="Sat, 29 Dec 2012 01:28:35 +0000"  >&lt;p&gt;I got the following for trunk patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] COMPILATION ERROR : 
[INFO] -------------------------------------------------------------
[ERROR] /Users/tyu/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java:[418,31] &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; PeerState does not exist
[INFO] 1 error
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13540717" author="lhofhansl" created="Sat, 29 Dec 2012 01:46:02 +0000"  >&lt;p&gt;Can we use ReplicationZookeeper.ENABLED_ZNODE_BYTES?&lt;/p&gt;</comment>
                            <comment id="13540737" author="v.himanshu" created="Sat, 29 Dec 2012 02:56:30 +0000"  >&lt;p&gt;Sorry, attached the wrong patch in the last attempt. This should correct the error Ted.&lt;br/&gt;
Thanks for taking a look.&lt;/p&gt;</comment>
                            <comment id="13540754" author="lhofhansl" created="Sat, 29 Dec 2012 04:08:42 +0000"  >&lt;p&gt;+1 0.94 jenkins just ran into this I think.&lt;/p&gt;</comment>
                            <comment id="13540755" author="lhofhansl" created="Sat, 29 Dec 2012 04:09:00 +0000"  >&lt;p&gt;Let me pull this into 0.94.4&lt;/p&gt;</comment>
                            <comment id="13540756" author="lhofhansl" created="Sat, 29 Dec 2012 04:12:59 +0000"  >&lt;p&gt;trunk-v1 still does not apply to trunk. Please take patches from svn, git might be behind.&lt;/p&gt;</comment>
                            <comment id="13540757" author="lhofhansl" created="Sat, 29 Dec 2012 04:14:00 +0000"  >&lt;p&gt;Never mind, was my fault &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13540770" author="hudson" created="Sat, 29 Dec 2012 05:06:41 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #680 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/680/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/680/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7440&quot; title=&quot;ReplicationZookeeper#addPeer is racy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7440&quot;&gt;&lt;del&gt;HBASE-7440&lt;/del&gt;&lt;/a&gt; ReplicationZookeeper#addPeer is racy (Himanshu) (Revision 1426704)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/replication/ReplicationPeer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13540782" author="hudson" created="Sat, 29 Dec 2012 06:05:27 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #3671 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/3671/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/3671/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7440&quot; title=&quot;ReplicationZookeeper#addPeer is racy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7440&quot;&gt;&lt;del&gt;HBASE-7440&lt;/del&gt;&lt;/a&gt; ReplicationZookeeper#addPeer is racy (Himanshu) (Revision 1426702)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13540812" author="hudson" created="Sat, 29 Dec 2012 08:44:56 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #90 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/90/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/90/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7440&quot; title=&quot;ReplicationZookeeper#addPeer is racy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7440&quot;&gt;&lt;del&gt;HBASE-7440&lt;/del&gt;&lt;/a&gt; ReplicationZookeeper#addPeer is racy (Himanshu) (Revision 1426704)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/replication/ReplicationPeer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13540875" author="hudson" created="Sat, 29 Dec 2012 11:53:50 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #318 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/318/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/318/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7440&quot; title=&quot;ReplicationZookeeper#addPeer is racy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7440&quot;&gt;&lt;del&gt;HBASE-7440&lt;/del&gt;&lt;/a&gt; ReplicationZookeeper#addPeer is racy (Himanshu) (Revision 1426702)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13544440" author="hudson" created="Sat, 5 Jan 2013 00:42:33 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security-on-Hadoop-23 #10 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/10/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/10/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7440&quot; title=&quot;ReplicationZookeeper#addPeer is racy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7440&quot;&gt;&lt;del&gt;HBASE-7440&lt;/del&gt;&lt;/a&gt; ReplicationZookeeper#addPeer is racy (Himanshu) (Revision 1426704)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/replication/ReplicationPeer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeper.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12562632" name="HBASE-7440-trunk-v0.patch" size="1929" author="v.himanshu" created="Sat, 29 Dec 2012 01:20:57 +0000"/>
                            <attachment id="12562640" name="HBASE-7440-trunk-v1.patch" size="1909" author="v.himanshu" created="Sat, 29 Dec 2012 02:56:30 +0000"/>
                            <attachment id="12562426" name="HBASE-7440-v0.patch" size="2798" author="v.himanshu" created="Thu, 27 Dec 2012 00:51:41 +0000"/>
                            <attachment id="12562443" name="HBASE-7440-v1.patch" size="2796" author="v.himanshu" created="Thu, 27 Dec 2012 06:40:03 +0000"/>
                            <attachment id="12562497" name="HBASE-7440-v2.patch" size="2539" author="v.himanshu" created="Thu, 27 Dec 2012 17:56:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 27 Dec 2012 04:32:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>301841</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16wwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248462</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>