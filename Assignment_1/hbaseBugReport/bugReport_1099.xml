<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:50:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1099/HBASE-1099.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1099] Regions assigned while master is splitting logs of recently crashed server; regionserver tries to execute incomplete log</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1099</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In master log, I see master trying to process split of a crashed server.  Its split two of three logs.  The server that just crashed comes back on line.  Balancing cuts in and master starts assigning the new server regions.  New regionserver starts opening regions and messing with the log file that master is trying to write.  It makes for a mess.  Here is how the events playout with a focus on a region that gets opened while master is processing split:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-12-29 16:16:38,456 INFO org.apache.hadoop.hbase.master.ServerManager: XX.XX.XX.53:60020 lease expired
...
2008-12-29 16:16:39,494 DEBUG org.apache.hadoop.hbase.regionserver.HLog: Creating &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; log file writer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; path hdfs:&lt;span class=&quot;code-comment&quot;&gt;//XX.XX.XX.XX:50000/data/hbase/content/1526904420/oldlogfile.log and region content,36946541ed9a62f419cf7238d32a6a38,1230448587552
&lt;/span&gt;...
2008-12-29 16:17:19,686 INFO org.apache.hadoop.hbase.master.ServerManager: Received start message from: XX.XX.XX.53:60020
....
2008-12-29 16:17:22,480 DEBUG org.apache.hadoop.hbase.master.BaseScanner: Current assignment of content,36946541ed9a62f419cf7238d32a6a38,1230448587552 is not valid. serverInfo: address: XX.XX.XX.53:60020, startcode: 1230585439593, load: (requests=3, regions=0, usedHeap=28, maxHeap=1777), passed startCode: 1230577089035, storedInfo.startCode: 1230585439593 Region is not unassigned, assigned or pending
...
2008-12-29 16:17:23,622 INFO org.apache.hadoop.hbase.master.RegionManager: assigning region content,36946541ed9a62f419cf7238d32a6a38,1230448587552 to server XX.XX.XX.53:60020
...
2008-12-29 16:17:26,632 INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_PROCESS_OPEN: content,36946541ed9a62f419cf7238d32a6a38,1230448587552 from XX.XX.XX.53:60020
...
2008-12-29 16:17:29,666 INFO org.apache.hadoop.hbase.master.ServerManager: Received MSG_REPORT_OPEN: content,36946541ed9a62f419cf7238d32a6a38,1230448587552 from XX.XX.XX.53:60020
....
2008-12-29 16:17:31,933 DEBUG org.apache.hadoop.hbase.regionserver.HLog: Applied 100001 total edits from hdfs:&lt;span class=&quot;code-comment&quot;&gt;//XX.XX.XX.XX:50000/data/hbase/log_XX.XX.XX.53_1230577089035_60020/hlog.dat.1230582612406
&lt;/span&gt;2008-12-29 16:17:31,941 DEBUG org.apache.hadoop.hbase.regionserver.HLog: Splitting 3 of 3: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//XX.XX.XX.XX:50000/data/hbase/log_XX.XX.XX.53_1230577089035_60020/hlog.dat.1230584516314
&lt;/span&gt;....
2008-12-29 16:17:34,522 INFO org.apache.hadoop.dfs.DFSClient: org.apache.hadoop.ipc.RemoteException: org.apache.hadoop.dfs.LeaseExpiredException: No lease on /data/hbase/content/1526904420/oldlogfile.log File does not exist. [Lease.  Hold
er: DFSClient_-1506530059, pendingcreates: 45]
        at org.apache.hadoop.dfs.FSNamesystem.checkLease(FSNamesystem.java:1172)
        at org.apache.hadoop.dfs.FSNamesystem.getAdditionalBlock(FSNamesystem.java:1103)
        at org.apache.hadoop.dfs.NameNode.addBlock(NameNode.java:330)
        at sun.reflect.GeneratedMethodAccessor15.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:481)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:888)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Regionserver side I see this when it tries to open above region:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-12-29 21:17:28,811 WARN org.apache.hadoop.hbase.regionserver.HStore: Exception processing reconstruction log hdfs:&lt;span class=&quot;code-comment&quot;&gt;//XX.XX.XX.XX:50000/data/hbase/content/1526904420/oldlogfile.log opening [B@12183272 -- continuing
&lt;/span&gt;.  Probably lack-of-HADOOP-1700 causing DATA LOSS!
java.io.EOFException
        at java.io.DataInputStream.readFully(DataInputStream.java:180)
        at org.apache.hadoop.io.DataOutputBuffer$Buffer.write(DataOutputBuffer.java:64)
        at org.apache.hadoop.io.DataOutputBuffer.write(DataOutputBuffer.java:102)
        at org.apache.hadoop.io.SequenceFile$Reader.next(SequenceFile.java:1933)
        at org.apache.hadoop.io.SequenceFile$Reader.next(SequenceFile.java:1833)
        at org.apache.hadoop.io.SequenceFile$Reader.next(SequenceFile.java:1879)
        at org.apache.hadoop.hbase.regionserver.HStore.doReconstructionLog(HStore.java:351)
        at org.apache.hadoop.hbase.regionserver.HStore.runReconstructionLog(HStore.java:296)
        at org.apache.hadoop.hbase.regionserver.HStore.&amp;lt;init&amp;gt;(HStore.java:236)
        at org.apache.hadoop.hbase.regionserver.HRegion.instantiateHStore(HRegion.java:1624)
        at org.apache.hadoop.hbase.regionserver.HRegion.initialize(HRegion.java:270)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.instantiateRegion(HRegionServer.java:1364)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.openRegion(HRegionServer.java:1335)
        at org.apache.hadoop.hbase.regionserver.HRegionServer$Worker.run(HRegionServer.java:1251)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;apurtell 25 node cluster&lt;/p&gt;</environment>
        <key id="12411448">HBASE-1099</key>
            <summary>Regions assigned while master is splitting logs of recently crashed server; regionserver tries to execute incomplete log</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Dec 2008 00:26:16 +0000</created>
                <updated>Sun, 13 Sep 2009 22:26:36 +0000</updated>
                            <resolved>Wed, 7 Jan 2009 21:03:35 +0000</resolved>
                                                    <fixVersion>0.19.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12659712" author="apurtell" created="Tue, 30 Dec 2008 00:34:20 +0000"  >&lt;p&gt;We have a service recovery framework that will restart a crashed regionserver after approximately 90 seconds.&lt;/p&gt;</comment>
                            <comment id="12661052" author="stack" created="Tue, 6 Jan 2009 05:55:29 +0000"  >&lt;p&gt;Jim, if you want me to work on this or on hbase-1096, just hand it over (you have all outstanding 0.19.0 issues bar hbase-856)&lt;/p&gt;</comment>
                            <comment id="12661369" author="stack" created="Tue, 6 Jan 2009 23:03:44 +0000"  >&lt;p&gt;First cut.&lt;/p&gt;

&lt;p&gt;Changed Set of dead servers to a Map.  Value is whether or not logs have been split.  Changed BaseScanner so it doesn&apos;t give out regions if region was on dead server, not unless logs have been split.   Also, if regionserver comes in and we still have ghost references in master &amp;#8211; i.e. lease not expired or regionserver is on the deadservers list &amp;#8211; we now put the regionserver into a holding pattern until the references are cleared.&lt;/p&gt;

&lt;p&gt;Testing now.&lt;/p&gt;</comment>
                            <comment id="12661388" author="stack" created="Wed, 7 Jan 2009 00:31:49 +0000"  >&lt;p&gt;Here is tested version.  Seems to work.&lt;/p&gt;

&lt;p&gt;See things like this in log if I startup a regionserver before its lease has expired:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-01-07 00:20:20,076 [IPC Server handler 6 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: Lease still held on XX.XX.XX.139:60020... waiting on it
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then....&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-01-07 00:20:30,267 [ServerManager.leaseChecker] INFO org.apache.hadoop.hbase.master.ServerManager: XX.XX.XX.139:60020 lease expired
2009-01-07 00:20:30,355 [HMaster] INFO org.apache.hadoop.hbase.regionserver.HLog: Splitting 9 log(s) in hdfs:&lt;span class=&quot;code-comment&quot;&gt;//XX.XX.XX.u.powerset.com:9000/hbasetrunk2/log_208.76.44.139_1231286896346_60020
&lt;/span&gt;2009-01-07 00:20:30,357 [HMaster] DEBUG org.apache.hadoop.hbase.regionserver.HLog: Splitting 1 of 9: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//XX.XX.XX.u.powerset.com:9000/hbasetrunk2/log_208.76.44.139_1231286896346_60020/hlog.dat.1231287184359
&lt;/span&gt;....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Though the lease has expired, the reporting regionserver is still parked during split processing.. you&apos;ll see these messages:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-01-07 00:20:50,097 [IPC Server handler 6 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: On list of dead servers: address: XX.XX.XX.139:60020, startcode: 1231287559888, load: (requests=0, regions=0, usedHeap=25, maxHeap=1244) .... waiting on removal
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assignments continue &amp;#8211; if splits (see below) &amp;#8211; but regions from dead server are not assigned:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
tTable,0000696213,1231287650867 from XX.XX.XX.141:60020
2009-01-07 00:20:58,553 [IPC Server handler 2 on 60000] INFO org.apache.hadoop.hbase.master.RegionManager: assigning region TestTable,0000632029,1231287650867 to server XX.XX.XX.141:60020
2009-01-07 00:20:58,568 [IPC Server handler 2 on 60000] INFO org.apache.hadoop.hbase.master.RegionManager: assigning region TestTable,0000696213,1231287650867 to server XX.XX.XX.141:60020
2009-01-07 00:21:00,107 [IPC Server handler 6 on 60000] DEBUG org.apache.hadoop.hbase.master.ServerManager: On list of dead servers: address: XX.XX.XX.139:60020, startcode: 1231287559888, load: (requests=0, regions=0, usedHeap=25, maxHeap=1244)....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;... but still not right.   I see that we&apos;ll still give out regions from dead server if on dead server.  Need to add more checks.&lt;/p&gt;</comment>
                            <comment id="12661705" author="stack" created="Wed, 7 Jan 2009 21:01:59 +0000"  >&lt;p&gt;Did a bunch of testing mostly killing half of my little cluster and seeing how it recovered.  In new patch, do things like hold incoming new regionservers until old lease expires and its logs have been split before going ahead and registering it.  Added shutdown of assigning regions if were on dead server by meta scanners.  Testing turned up interesting issues like needing to tickle lease renewal between lease expiration and while waiting on log split to complete but complete testing not possible at this stage because resultant cluster churn with new servers coming on line and loads being rebalanced provokes the outstanding issues in 0.19.0.  I&apos;m going to commit what I have.  Then test when the last 0.19.0 issues are committed.  Will open new issues for anything found.&lt;/p&gt;</comment>
                            <comment id="12661718" author="apurtell" created="Wed, 7 Jan 2009 21:36:51 +0000"  >&lt;p&gt;Thanks stack. I&apos;m going to try this out now. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12397240" name="1099.patch" size="15891" author="stack" created="Tue, 6 Jan 2009 23:03:44 +0000"/>
                            <attachment id="12397248" name="1099v2.patch" size="16180" author="stack" created="Wed, 7 Jan 2009 00:31:49 +0000"/>
                            <attachment id="12397329" name="1099v8.patch" size="18896" author="stack" created="Wed, 7 Jan 2009 21:01:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 30 Dec 2008 00:34:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25571</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hbbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99097</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>