<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:12:50 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-10338/HBASE-10338.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-10338] Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost</title>
                <link>https://issues.apache.org/jira/browse/HBASE-10338</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Runtime exception is being thrown when AccessController CP is used with region server. This is happening as region server co processor host is created before zookeeper is initialized in region server.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12688835">HBASE-10338</key>
            <summary>Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="avandana">Vandana Ayyalasomayajula</assignee>
                                    <reporter username="avandana">Vandana Ayyalasomayajula</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jan 2014 20:20:51 +0000</created>
                <updated>Thu, 11 Aug 2016 23:59:18 +0000</updated>
                            <resolved>Wed, 15 Jan 2014 01:25:14 +0000</resolved>
                                    <version>0.98.0</version>
                                    <fixVersion>0.98.0</fixVersion>
                    <fixVersion>0.96.2</fixVersion>
                    <fixVersion>0.99.0</fixVersion>
                                    <component>Coprocessors</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13871277" author="apurtell" created="Tue, 14 Jan 2014 22:17:44 +0000"  >&lt;p&gt;Good catch, we&apos;ve missed thus far hooking the AC into the RS level with RegionServerCoprocessorHost. &lt;/p&gt;</comment>
                            <comment id="13871279" author="apurtell" created="Tue, 14 Jan 2014 22:19:10 +0000"  >&lt;p&gt;Let me check this locally and then will commit after.&lt;/p&gt;</comment>
                            <comment id="13871290" author="apurtell" created="Tue, 14 Jan 2014 22:25:41 +0000"  >&lt;p&gt;If you don&apos;t mind &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avandana&quot; class=&quot;user-hover&quot; rel=&quot;avandana&quot;&gt;Vandana Ayyalasomayajula&lt;/a&gt;, I would also like to add a unit test to catch this on top of your patch.&lt;br/&gt;
Edit: Maybe changes to TestAccessController will be enough, it didn&apos;t catch it but should have.&lt;/p&gt;</comment>
                            <comment id="13871304" author="stack" created="Tue, 14 Jan 2014 22:39:01 +0000"  >&lt;p&gt;+1 on patch.  Test would be good too.  (+1 for 0.96 if we have this issue there too)&lt;/p&gt;</comment>
                            <comment id="13871305" author="avandana" created="Tue, 14 Jan 2014 22:40:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; This happens only when the coprocessor uses zookeeper in its start method. I made changes to security util class, so that this particular case is caught. Do you think we need  separate unit test for this case ?&lt;/p&gt;</comment>
                            <comment id="13871308" author="avandana" created="Tue, 14 Jan 2014 22:41:09 +0000"  >&lt;p&gt;This issue is seen on 0.96 too.&lt;/p&gt;</comment>
                            <comment id="13871311" author="apurtell" created="Tue, 14 Jan 2014 22:47:15 +0000"  >&lt;p&gt;I&apos;m thinking just this to address how this slipped through. TestAccessController should insure that the AC is added to all system coprocessor lists, which are set up elsewhere.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/Te
index 9b8dd6e..ef56384 100644
--- hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAcces
+++ hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAcces
@@ -59,6 +59,7 @@ import org.apache.hadoop.hbase.client.Put;
 import org.apache.hadoop.hbase.client.Result;
 import org.apache.hadoop.hbase.client.ResultScanner;
 import org.apache.hadoop.hbase.client.Scan;
+import org.apache.hadoop.hbase.coprocessor.CoprocessorHost;
 import org.apache.hadoop.hbase.coprocessor.CoprocessorService;
 import org.apache.hadoop.hbase.coprocessor.MasterCoprocessorEnvironment;
 import org.apache.hadoop.hbase.coprocessor.ObserverContext;
@@ -157,6 +158,17 @@ public class TestAccessController extends SecureTestUtil {
   private static RegionServerCoprocessorEnvironment RSCP_ENV;
   private RegionCoprocessorEnvironment RCP_ENV;
 
+  static void verifyConfiguration(Configuration conf) {
+    if (!conf.get(CoprocessorHost.MASTER_COPROCESSOR_CONF_KEY)
+            .contains(AccessController.class.getName())
+        &amp;amp;&amp;amp; conf.get(CoprocessorHost.REGION_COPROCESSOR_CONF_KEY)
+            .contains(AccessController.class.getName())
+        &amp;amp;&amp;amp; conf.get(CoprocessorHost.REGIONSERVER_COPROCESSOR_CONF_KEY)
+            .contains(AccessController.class.getName())) {
+      throw new RuntimeException(&quot;AccessController is missing from a system cop
+    }
+  }
+
   @BeforeClass
   public static void setupBeforeClass() throws Exception {
     // setup configuration
@@ -168,6 +180,9 @@ public class TestAccessController extends SecureTestUtil {
       &quot;org.apache.hadoop.hbase.master.snapshot.SnapshotLogCleaner&quot;);
     // Enable security
     SecureTestUtil.enableSecurity(conf);
+    // Verify enableSecurity sets up what we require
+    verifyConfiguration(conf);
+
     // Enable EXEC permission checking
     conf.setBoolean(AccessController.EXEC_PERMISSION_CHECKS_KEY, true);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13871315" author="apurtell" created="Tue, 14 Jan 2014 22:49:00 +0000"  >&lt;p&gt;... with one more set of parens to enclose the negation for style reasons but you get the idea.&lt;/p&gt;</comment>
                            <comment id="13871318" author="stack" created="Tue, 14 Jan 2014 22:50:09 +0000"  >&lt;p&gt;Good by me.&lt;/p&gt;</comment>
                            <comment id="13871321" author="avandana" created="Tue, 14 Jan 2014 22:53:19 +0000"  >&lt;p&gt;I think if we need a verify method, then it should be in the SecureTestUtil class, so that it can be used by other security related test classes. &lt;/p&gt;</comment>
                            <comment id="13871324" author="stack" created="Tue, 14 Jan 2014 22:54:32 +0000"  >&lt;p&gt;/me I like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avandana&quot; class=&quot;user-hover&quot; rel=&quot;avandana&quot;&gt;Vandana Ayyalasomayajula&lt;/a&gt;&apos;s suggestion&lt;/p&gt;</comment>
                            <comment id="13871326" author="apurtell" created="Tue, 14 Jan 2014 22:54:45 +0000"  >&lt;p&gt;Also, TestAccessController has coverage for the RegionServerObserver interface methods, but does so by calling them directly, not via the RegionServer, so it didn&apos;t catch the AC was not installed into the RegionServerCoprocessorHost previously. Not needed now but could be a reasonable follow up.&lt;/p&gt;</comment>
                            <comment id="13871330" author="apurtell" created="Tue, 14 Jan 2014 22:58:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think if we need a verify method, then it should be in the SecureTestUtil class, so that it can be used by other security related test classes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t feel that is appropriate.  TestAccessController specifically needs to test that the AC is installed. Also, putting this check into SecureTestUtil is redundant, it would serve no purpose but for documentation, could just put in a comment then. &lt;/p&gt;</comment>
                            <comment id="13871335" author="apurtell" created="Tue, 14 Jan 2014 23:02:15 +0000"  >&lt;p&gt;For your consideration&lt;/p&gt;</comment>
                            <comment id="13871341" author="avandana" created="Tue, 14 Jan 2014 23:07:05 +0000"  >&lt;p&gt;Seems like the other test classes do not quite require the AccessController class in the region server. So we can have the method which is verifying the AccessController being present in the master, region server and region to be in the TestAccessController class itself.&lt;/p&gt;</comment>
                            <comment id="13871349" author="apurtell" created="Tue, 14 Jan 2014 23:13:35 +0000"  >&lt;p&gt;Ok I will commit the .1 patch with credit to Vandana shortly to trunk, 0.98, and 0.96 unless objection.&lt;/p&gt;</comment>
                            <comment id="13871352" author="avandana" created="Tue, 14 Jan 2014 23:16:02 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="13871381" author="apurtell" created="Tue, 14 Jan 2014 23:43:35 +0000"  >&lt;p&gt;I needed to backport the trunk changes to both 0.96 and 0.98 in slightly different ways. Attaching the result. TestAccessController passes locally on all branches. I will run the full test suite locally before committing.&lt;/p&gt;</comment>
                            <comment id="13871486" author="apurtell" created="Wed, 15 Jan 2014 01:25:15 +0000"  >&lt;p&gt;Committed to trunk, 0.98, and 0.96 branches. Huge thanks for reporting this and providing a patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avandana&quot; class=&quot;user-hover&quot; rel=&quot;avandana&quot;&gt;Vandana Ayyalasomayajula&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13871597" author="hudson" created="Wed, 15 Jan 2014 03:35:57 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98 #81 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/81/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/81/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt;. Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost (Vandana Ayyalasomayajula) (apurtell: rev 1558261)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/SecureTestUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13871617" author="hudson" created="Wed, 15 Jan 2014 04:01:48 +0000"  >&lt;p&gt;FAILURE: Integrated in hbase-0.96 #258 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96/258/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96/258/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt;. Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost (Vandana Ayyalasomayajula) (apurtell: rev 1558262)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/SecureTestUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13871631" author="hudson" created="Wed, 15 Jan 2014 04:36:44 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK #4820 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/4820/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/4820/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt;. Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost (Vandana Ayyalasomayajula) (apurtell: rev 1558260)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/SecureTestUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13871646" author="hudson" created="Wed, 15 Jan 2014 04:53:43 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98-on-Hadoop-1.1 #75 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/75/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/75/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt;. Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost (Vandana Ayyalasomayajula) (apurtell: rev 1558261)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/SecureTestUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.98/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13872014" author="hudson" created="Wed, 15 Jan 2014 12:45:45 +0000"  >&lt;p&gt;FAILURE: Integrated in hbase-0.96-hadoop2 #176 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96-hadoop2/176/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96-hadoop2/176/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt;. Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost (Vandana Ayyalasomayajula) (apurtell: rev 1558262)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/SecureTestUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13872926" author="hudson" created="Thu, 16 Jan 2014 01:35:18 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK-on-Hadoop-1.1 #54 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-1.1/54/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-1.1/54/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt;. Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost (Vandana Ayyalasomayajula) (apurtell: rev 1558260)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/SecureTestUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/security/access/TestAccessController.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13878077" author="stack" created="Wed, 22 Jan 2014 00:45:51 +0000"  >&lt;p&gt;This patch destabilized the 0.96 builds.  Any chance of taking a look Vandana.  See here: &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96/&lt;/a&gt;  See how since this patch went in org.apache.hadoop.hbase.regionserver.TestRSKilledWhenInitializing.testRSTermnationAfterRegisteringToMasterBeforeCreatingEphemeralNod has started failing.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13878081" author="apurtell" created="Wed, 22 Jan 2014 00:50:13 +0000"  >&lt;p&gt;I didn&apos;t see that test failure when running the 0.96 suite before commit, so it&apos;s likely a timing issue / race.&lt;/p&gt;</comment>
                            <comment id="13878086" author="apurtell" created="Wed, 22 Jan 2014 00:53:59 +0000"  >&lt;p&gt;No, I stand corrected.&lt;/p&gt;

&lt;p&gt;Here is the core change to 0.96:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
===================================================================
--- hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java	(revision 1558241)
+++ hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java	(working copy)
@@ -574,7 +574,6 @@
         abort(&quot;Uncaught exception in service thread &quot; + t.getName(), e);
       }
     };
-    this.rsHost = new RegionServerCoprocessorHost(this, this.conf);
 
     this.distributedLogReplay = this.conf.getBoolean(HConstants.DISTRIBUTED_LOG_REPLAY_KEY,
       HConstants.DEFAULT_DISTRIBUTED_LOG_REPLAY_CONFIG);
@@ -791,6 +790,11 @@
         }
       }
 
+      // Initialize the RegionServerCoprocessorHost now that our ephemeral
+      // node was created by reportForDuty, in case any coprocessors want
+      // to use ZooKeeper
+      this.rsHost = new RegionServerCoprocessorHost(this, this.conf);
+
       if (!this.stopped &amp;amp;&amp;amp; isHealthy()){
         // start the snapshot handler, since the server is ready to run
         this.snapshotManager.start();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks like moving the initialization has left something uninitialized during the test because when the abort happens there is what looks like an unexpected NPE:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-01-21 23:16:22,279 FATAL [RS:0;vesta:49655] regionserver.HRegionServer(1733): ABORTING region server vesta.apache.org,49655,1390346181063: Unhandled: null
java.lang.NullPointerException
	at org.apache.hadoop.hbase.regionserver.HRegionServer.stop(HRegionServer.java:1665)
	at org.apache.hadoop.hbase.regionserver.HRegionServer.abort(HRegionServer.java:1761)
	at org.apache.hadoop.hbase.MiniHBaseCluster$MiniHBaseClusterRegionServer.abortRegionServer(MiniHBaseCluster.java:173)
	at org.apache.hadoop.hbase.MiniHBaseCluster$MiniHBaseClusterRegionServer.access$100(MiniHBaseCluster.java:107)
	at org.apache.hadoop.hbase.MiniHBaseCluster$MiniHBaseClusterRegionServer$2.run(MiniHBaseCluster.java:166)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13878087" author="apurtell" created="Wed, 22 Jan 2014 00:55:31 +0000"  >&lt;p&gt;Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avandana&quot; class=&quot;user-hover&quot; rel=&quot;avandana&quot;&gt;Vandana Ayyalasomayajula&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13878180" author="avandana" created="Wed, 22 Jan 2014 02:47:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; Taking a look at the NPE. Sorry for the delay, I was traveling.&lt;/p&gt;</comment>
                            <comment id="13878904" author="avandana" created="Wed, 22 Jan 2014 17:55:13 +0000"  >&lt;p&gt;This patch should fix the NPE as the region server coprocessor host is not initialized in the constructor. &lt;/p&gt;</comment>
                            <comment id="13878961" author="apurtell" created="Wed, 22 Jan 2014 18:27:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;This patch should fix the NPE as the region server coprocessor host is not initialized in the constructor.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;lgtm, applying addendum to trunk and 0.98. &lt;/p&gt;</comment>
                            <comment id="13878982" author="stack" created="Wed, 22 Jan 2014 18:39:16 +0000"  >&lt;p&gt;I need it in 0.96 too boss &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; Thanks.  (Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avandana&quot; class=&quot;user-hover&quot; rel=&quot;avandana&quot;&gt;Vandana Ayyalasomayajula&lt;/a&gt; for fixing while traveling).&lt;/p&gt;</comment>
                            <comment id="13878986" author="apurtell" created="Wed, 22 Jan 2014 18:40:13 +0000"  >&lt;p&gt;... and will commit fix to 0.96 also, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13879131" author="apurtell" created="Wed, 22 Jan 2014 20:18:50 +0000"  >&lt;p&gt;Committed addendum to trunk, 0.98, and 0.96. Patch applied everywhere with minor fuzz only, failing test completes successfully with no NPE reported in the log.&lt;/p&gt;</comment>
                            <comment id="13879344" author="hudson" created="Wed, 22 Jan 2014 23:26:13 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK #4850 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/4850/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/4850/&lt;/a&gt;)&lt;br/&gt;
Amend &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt; Fix NPE if the server is terminated before the RegionServerCoprocessorHost is initialized (Vandana Ayyalasomayajula) (apurtell: rev 1560494)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13879345" author="hudson" created="Wed, 22 Jan 2014 23:26:51 +0000"  >&lt;p&gt;FAILURE: Integrated in hbase-0.96 #268 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96/268/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96/268/&lt;/a&gt;)&lt;br/&gt;
Amend &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt; Fix NPE if the server is terminated before the RegionServerCoprocessorHost is initialized (Vandana Ayyalasomayajula) (apurtell: rev 1560496)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13879364" author="hudson" created="Thu, 23 Jan 2014 00:53:56 +0000"  >&lt;p&gt;FAILURE: Integrated in hbase-0.96-hadoop2 #184 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96-hadoop2/184/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96-hadoop2/184/&lt;/a&gt;)&lt;br/&gt;
Amend &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10338&quot; title=&quot;Region server fails to start with AccessController coprocessor if installed into RegionServerCoprocessorHost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10338&quot;&gt;&lt;del&gt;HBASE-10338&lt;/del&gt;&lt;/a&gt; Fix NPE if the server is terminated before the RegionServerCoprocessorHost is initialized (Vandana Ayyalasomayajula) (apurtell: rev 1560496)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14331117" author="enis" created="Sat, 21 Feb 2015 23:33:36 +0000"  >&lt;p&gt;Closing this issue after 0.99.0 release. &lt;/p&gt;</comment>
                            <comment id="15414626" author="zghaobac" created="Wed, 10 Aug 2016 02:57:21 +0000"  >&lt;p&gt;We found NPE in our 0.98 production cluster because RegionServerCoprocessorHost is not initialized before RpcServer start service.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-comment&quot;&gt;// Try and register with the Master; tell it we are here.  Break &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// server is stopped or the clusterup flag is down or hdfs went wacky.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (keepLooping()) {
        RegionServerStartupResponse w = reportForDuty();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (w == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;reportForDuty failed; sleeping and then retrying.&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sleeper.sleep();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          handleReportForDutyResponse(w);
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
      }

      &lt;span class=&quot;code-comment&quot;&gt;// Initialize the RegionServerCoprocessorHost now that our ephemeral
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// node was created by reportForDuty, in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; any coprocessors want
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// to use ZooKeeper
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.rsHost = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RegionServerCoprocessorHost(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.conf);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;RpcServer start service in handleReportForDutyResponse(), then it can serve rpc call replicateWALEntry(). But the RegionServerCoprocessorHost is not initialized and it is used in replicateWALEntry, so it will throw a NPE.&lt;/p&gt;</comment>
                            <comment id="15414627" author="zghaobac" created="Wed, 10 Aug 2016 02:58:07 +0000"  >&lt;p&gt;Attach a addendum for 0.98 branch.&lt;/p&gt;</comment>
                            <comment id="15418154" author="apurtell" created="Thu, 11 Aug 2016 23:59:18 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zghaobac&quot; class=&quot;user-hover&quot; rel=&quot;zghaobac&quot;&gt;Guanghao Zhang&lt;/a&gt;. Let&apos;s move this to new issue &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-16402&quot; title=&quot;RegionServerCoprocessorHost should be initialized before RpcServer starts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-16402&quot;&gt;&lt;del&gt;HBASE-16402&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12623013" name="10338.1-0.96.patch" size="5086" author="apurtell" created="Tue, 14 Jan 2014 23:43:35 +0000"/>
                            <attachment id="12623014" name="10338.1-0.98.patch" size="4982" author="apurtell" created="Tue, 14 Jan 2014 23:43:35 +0000"/>
                            <attachment id="12623018" name="10338.1.patch" size="5067" author="apurtell" created="Tue, 14 Jan 2014 23:54:50 +0000"/>
                            <attachment id="12623008" name="10338.1.patch" size="5835" author="apurtell" created="Tue, 14 Jan 2014 23:02:15 +0000"/>
                            <attachment id="12822942" name="HBASE-10338-0.98-addendum.patch" size="1492" author="zghaobac" created="Wed, 10 Aug 2016 02:58:07 +0000"/>
                            <attachment id="12622995" name="HBASE-10338.0.patch" size="2787" author="avandana" created="Tue, 14 Jan 2014 22:00:14 +0000"/>
                            <attachment id="12624379" name="HBASE-10338_addendum.patch" size="759" author="avandana" created="Wed, 22 Jan 2014 17:55:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 14 Jan 2014 22:17:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367802</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1reaf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>368109</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>