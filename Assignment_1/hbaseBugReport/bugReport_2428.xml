<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:01:50 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2428/HBASE-2428.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2428] NPE in ProcessRegionClose because meta is offline kills master and thus the cluster</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2428</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;This issue was born of study done in hbase-2413.  The meta went offline and we were processing a region close at the same time.  The close processing fell into a NPE loop and wouldn&apos;t get out of it killing master and effectivly killing the cluster:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-03-31 17:50:57,004 INFO org.apache.hadoop.hbase.master.ServerManager: hbasetest020.X.X.X,60020,1270077892989 znode expired
2010-03-31 17:50:57,004 INFO org.apache.hadoop.hbase.master.RegionManager: META region removed from onlineMetaRegions
2010-03-31 17:51:15,385 INFO org.apache.hadoop.hbase.master.ServerManager: Received start message from: hbasetest020.X.X.X,60020,1270083075377
2010-03-31 17:51:15,399 DEBUG org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper: Updated ZNode /hbase/rs/1270083075377 with data 10.18.35.215:60020
2010-03-31 17:51:15,870 DEBUG org.apache.hadoop.hbase.master.RegionManager: Server is overloaded: load=5, avg=3.0, slop=0.3
2010-03-31 17:51:15,870 DEBUG org.apache.hadoop.hbase.master.RegionManager: Choosing to reassign 2 regions. mostLoadedRegions has 5 regions in it.
2010-03-31 17:51:15,870 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region test1,3147000000,1270081876965
2010-03-31 17:51:15,870 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region test1,9352000000,1270080893514
2010-03-31 17:51:15,870 INFO org.apache.hadoop.hbase.master.RegionManager: Skipped 0 region(s) that are in transition states
2010-03-31 17:51:15,878 INFO org.apache.hadoop.hbase.master.ServerManager: Processing MSG_REPORT_CLOSE: test1,3147000000,1270081876965 from hbasetest019.X.X.X,60020,1270082983630; 1 of 2
2010-03-31 17:51:15,879 INFO org.apache.hadoop.hbase.master.ServerManager: Processing MSG_REPORT_CLOSE: test1,9352000000,1270080893514 from hbasetest019.X.X.X,60020,1270082983630; 2 of 2
2010-03-31 17:51:44,897 DEBUG org.apache.hadoop.hbase.master.ProcessRegionClose$1: Trying to contact region server &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; regionName &apos;.META.,,1&apos;, but failed after 10 attempts.
Exception 1:
java.io.IOException: Call to /10.18.35.215:60020 failed on local exception: java.io.EOFExceptionException 1:
java.net.ConnectException: Connection refusedException 1:
java.net.ConnectException: Connection refusedException 1:
java.net.ConnectException: Connection refusedException 1:
java.net.ConnectException: Connection refusedException 1:
java.net.ConnectException: Connection refusedException 1:
java.net.ConnectException: Connection refusedException 1:
org.apache.hadoop.hbase.NotServingRegionException: org.apache.hadoop.hbase.NotServingRegionException: .META.,,1
        at org.apache.hadoop.hbase.regionserver.HRegionServer.getRegion(HRegionServer.java:2282)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.delete(HRegionServer.java:1989)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:577)
        at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:915)
Exception 1:
org.apache.hadoop.hbase.NotServingRegionException: org.apache.hadoop.hbase.NotServingRegionException: .META.,,1
        at org.apache.hadoop.hbase.regionserver.HRegionServer.getRegion(HRegionServer.java:2282)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.delete(HRegionServer.java:1989)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:577)
        at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:915)

org.apache.hadoop.hbase.NotServingRegionException: org.apache.hadoop.hbase.NotServingRegionException: .META.,,1
        at org.apache.hadoop.hbase.regionserver.HRegionServer.getRegion(HRegionServer.java:2282)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.delete(HRegionServer.java:1989)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:577)
        at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:915)

        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:39)
        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:27)
        at java.lang.reflect.Constructor.newInstance(Constructor.java:513)
        at org.apache.hadoop.hbase.RemoteExceptionHandler.decodeRemoteException(RemoteExceptionHandler.java:94)
        at org.apache.hadoop.hbase.master.RetryableMetaOperation.doWithRetries(RetryableMetaOperation.java:74)
        at org.apache.hadoop.hbase.master.ProcessRegionClose.process(ProcessRegionClose.java:63)
        at org.apache.hadoop.hbase.master.HMaster.processToDoQueue(HMaster.java:494)
        at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:429)
2010-03-31 17:51:44,899 DEBUG org.apache.hadoop.hbase.master.HMaster: Processing todo: ProcessRegionClose of test1,1230000000,1270081673808, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, reassign: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
2010-03-31 17:51:44,899 DEBUG org.apache.hadoop.hbase.master.ProcessRegionClose$1: Exception in RetryableMetaOperation:
java.lang.NullPointerException
        at org.apache.hadoop.hbase.master.RetryableMetaOperation.doWithRetries(RetryableMetaOperation.java:64)
        at org.apache.hadoop.hbase.master.ProcessRegionClose.process(ProcessRegionClose.java:63)
        at org.apache.hadoop.hbase.master.HMaster.processToDoQueue(HMaster.java:494)
        at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:429)
2010-03-31 17:51:44,900 WARN org.apache.hadoop.hbase.master.HMaster: Processing pending operations: ProcessRegionClose of test1,1230000000,1270081673808, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, reassign: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
java.lang.RuntimeException: java.lang.NullPointerException
        at org.apache.hadoop.hbase.master.RetryableMetaOperation.doWithRetries(RetryableMetaOperation.java:96)
        at org.apache.hadoop.hbase.master.ProcessRegionClose.process(ProcessRegionClose.java:63)
        at org.apache.hadoop.hbase.master.HMaster.processToDoQueue(HMaster.java:494)
        at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:429)
Caused by: java.lang.NullPointerException
        at org.apache.hadoop.hbase.master.RetryableMetaOperation.doWithRetries(RetryableMetaOperation.java:64)
        ... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... and so on.&lt;/p&gt;

&lt;p&gt;Marking a blocker for 0.20.5.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12461564">HBASE-2428</key>
            <summary>NPE in ProcessRegionClose because meta is offline kills master and thus the cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Apr 2010 18:37:41 +0000</created>
                <updated>Fri, 12 Oct 2012 06:15:38 +0000</updated>
                            <resolved>Fri, 30 Apr 2010 07:02:29 +0000</resolved>
                                                    <fixVersion>0.20.5</fixVersion>
                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12859959" author="tlipcon" created="Thu, 22 Apr 2010 19:05:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2479&quot; title=&quot;NPE in master when meta is unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2479&quot;&gt;&lt;del&gt;HBASE-2479&lt;/del&gt;&lt;/a&gt; looks like the same thing, ish.&lt;/p&gt;</comment>
                            <comment id="12861695" author="stack" created="Wed, 28 Apr 2010 06:42:01 +0000"  >&lt;p&gt;The unit test over in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2414&quot; title=&quot;Enhance test suite to be able to specify distributed scenarios&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2414&quot;&gt;&lt;del&gt;HBASE-2414&lt;/del&gt;&lt;/a&gt; has turned up root cause.  If a RegionServerOperation is unable to complete &amp;#8211; ProcessRegionClose, ProcessServerShutdown are all RegionServerOperations, the events processed by the HMaster &amp;#8211; say because meta is offlined, its put on a DelayQueue.  On construction of the RegionServerOperation the &apos;delay&apos; is set.  The DelayQueue is processed before new events when the master is going about its business.  Whats happening above is that the ProcessRegionClose failed to complete because meta was offline.  It was put on the DelayQueue.  The first put on the DelayQueue was probably fine... we waited some time and then retried but the meta still hadn&apos;t come online.  We were put on the DelayQueue again only now our delay had turned negative.  Since delayqueue is processed first, all we did was try to process the close even though in the other more live todo queue, we might have the process of the regionserver shutdown waiting, the process of the regionserver that was carrying .meta.  We&apos;d never recover.&lt;/p&gt;

&lt;p&gt;Will make a patch in morning.&lt;/p&gt;</comment>
                            <comment id="12862566" author="stack" created="Fri, 30 Apr 2010 07:02:29 +0000"  >&lt;p&gt;The patch ocmmitted over in hbase-2414 had fixes for this issue and a unit test.  The patch there is big.  Here are the two pieces of the patch that in particular fixed this issue:&lt;/p&gt;

&lt;p&gt;In HMaster process todo queue, when op.process failed... we&apos;d fall into this block:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {
+      &lt;span class=&quot;code-comment&quot;&gt;// There was an exception performing the operation.
&lt;/span&gt;+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ex &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RemoteException) {
+        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+          ex = RemoteExceptionHandler.decodeRemoteException(
+            (RemoteException)ex);
+        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
+          ex = e;
+          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;main processing loop: &quot;&lt;/span&gt; + op.toString(), e);
+        }
+      }
+      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed processing: &quot;&lt;/span&gt; + op.toString() +
+        &lt;span class=&quot;code-quote&quot;&gt;&quot;; putting onto delayed todo queue&quot;&lt;/span&gt;, ex);
+      putOnDelayQueue(op);
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The fix is new method putOnDelayQueue(op).  Before we used to just add it direct to the delay queue.   This method first resets the RegionServerOperation expiration to some time in the future.  Previous it wasn&apos;t being reset so it just didn&apos;t stay in the delay queue.  It came straight out.&lt;/p&gt;

&lt;p&gt;Here is part of fix that got rid of the NPEs.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: src/java/org/apache/hadoop/hbase/master/ProcessRegionClose.java
===================================================================
--- src/java/org/apache/hadoop/hbase/master/ProcessRegionClose.java	(revision 939172)
+++ src/java/org/apache/hadoop/hbase/master/ProcessRegionClose.java	(working copy)
@@ -58,6 +58,13 @@
 
   @Override
   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; process() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!metaRegionAvailable()) {
+      &lt;span class=&quot;code-comment&quot;&gt;// We can&apos;t proceed unless the meta region we are going to update
&lt;/span&gt;+      &lt;span class=&quot;code-comment&quot;&gt;// is online. metaRegionAvailable() has put &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; operation on the
&lt;/span&gt;+      &lt;span class=&quot;code-comment&quot;&gt;// delayedToDoQueue, so &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; so the operation is not put
&lt;/span&gt;+      &lt;span class=&quot;code-comment&quot;&gt;// back on the toDoQueue
&lt;/span&gt;+      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+    }
     &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; result = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (offlineRegion || reassignRegion) {
       result =
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12866881" author="stack" created="Wed, 12 May 2010 23:52:58 +0000"  >&lt;p&gt;Marking these as fixed against 0.21.0 rather than against 0.20.5.&lt;/p&gt;</comment>
                            <comment id="12868281" author="stack" created="Mon, 17 May 2010 17:06:39 +0000"  >&lt;p&gt;This patch distills from 2414 the fix for this issue.  I want to apply to 0.20.  Please review.&lt;/p&gt;</comment>
                            <comment id="12868285" author="streamy" created="Mon, 17 May 2010 17:12:11 +0000"  >&lt;p&gt;This looks good to me, thanks for explanation stack.  +1 for commit to branch&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12462806">HBASE-2479</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12462806">HBASE-2479</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12444706" name="2428-for0.20.txt" size="1276" author="stack" created="Mon, 17 May 2010 17:06:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 22 Apr 2010 19:05:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26301</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 31 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08sdb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>49196</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>