<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:13:11 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3792/HBASE-3792.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3792] TableInputFormat leaks ZK connections</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3792</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The TableInputFormat creates an HTable using a new Configuration object, and it never cleans it up. When running a Mapper, the TableInputFormat is instantiated and the ZK connection is created. While this connection is not explicitly cleaned up, the Mapper process eventually exits and thus the connection is closed. Ideally the TableRecordReader would close the connection in its close() method rather than relying on the process to die for connection cleanup. This is fairly easy to implement by overriding TableRecordReader, and also overriding TableInputFormat to specify the new record reader.&lt;/p&gt;

&lt;p&gt;The leak occurs when the JobClient is initializing and needs to retrieves the splits. To get the splits, it instantiates a TableInputFormat. Doing so creates a ZK connection that is never cleaned up. Unlike the mapper, however, my job client process does not die. Thus the ZK connections accumulate.&lt;/p&gt;

&lt;p&gt;I was able to fix the problem by writing my own TableInputFormat that does not initialize the HTable in the getConf() method and does not have an HTable member variable. Rather, it has a variable for the table name. The HTable is instantiated where needed and then cleaned up. For example, in the getSplits() method, I create the HTable, then close the connection once the splits are retrieved. I also create the HTable when creating the record reader, and I have a record reader that closes the connection when done.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 1.6.0_24, Mac OS X 10.6.7&lt;/p&gt;</environment>
        <key id="12504444">HBASE-3792</key>
            <summary>TableInputFormat leaks ZK connections</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="bryanck">Bryan Keller</reporter>
                        <labels>
                    </labels>
                <created>Sat, 16 Apr 2011 12:08:13 +0000</created>
                <updated>Wed, 16 Nov 2016 21:16:41 +0000</updated>
                            <resolved>Wed, 16 Nov 2016 21:16:40 +0000</resolved>
                                    <version>0.90.1</version>
                                                    <component>mapreduce</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>13</watches>
                                                                <comments>
                            <comment id="13020620" author="jdcryans" created="Sat, 16 Apr 2011 15:18:19 +0000"  >&lt;p&gt;The main issue with not using a new connection is that it breaks CopyTable or any other job that wants to use one cluster then another. I think you&apos;re workaround is the way to go until we fix the real source of the problem (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; being one solution to it).&lt;/p&gt;</comment>
                            <comment id="13029142" author="stack" created="Thu, 5 May 2011 05:47:52 +0000"  >&lt;p&gt;So, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; was committed to trunk.  Can we close this issue now as fixed in TRUNK?&lt;/p&gt;</comment>
                            <comment id="13029185" author="bryanck" created="Thu, 5 May 2011 06:49:32 +0000"  >&lt;p&gt;I think the change should still be made. The &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; change adds reference counters to connection, so closing the connection here explicitly where needed will decrement the reference counter and allow for connection cleanup.&lt;/p&gt;</comment>
                            <comment id="13141296" author="bryanck" created="Tue, 1 Nov 2011 16:27:41 +0000"  >&lt;p&gt;I was planning on uploading a patch later today in case it would be useful.&lt;/p&gt;</comment>
                            <comment id="13145190" author="bryanck" created="Mon, 7 Nov 2011 03:06:11 +0000"  >&lt;p&gt;Here&apos;s a patch demonstrating the changes I have implemented in my system, as described above. The patch is for trunk, so the changes are slightly different than what I am using for 0.90.4.&lt;/p&gt;</comment>
                            <comment id="13145191" author="bryanck" created="Mon, 7 Nov 2011 03:08:10 +0000"  >&lt;p&gt;BTW, I am having trouble running the tests on trunk so I wasn&apos;t able to verify this patch, I&apos;ll work on getting my dev environment more functional.&lt;/p&gt;</comment>
                            <comment id="13155973" author="terry.siu" created="Wed, 23 Nov 2011 17:20:33 +0000"  >&lt;p&gt;Bryan, would be able to post a patch of the changes you are using for 0.90.4? I applied the trunk patch to 0.90.4 and aside from one minor flub, the patch was very clean. I left my mapreduce jobs to run overnight and am seeing ZK connections accummulating again, but at a slower rate, so now I&apos;m wondering what differences exist between the changes you made for 0.90.4 versus the one you posted. Thanks!&lt;/p&gt;</comment>
                            <comment id="13155997" author="bryanck" created="Wed, 23 Nov 2011 17:52:37 +0000"  >&lt;p&gt;Sure, I&apos;ll post a patch for 0.90.4 in a bit. There have been quite a few changes to ZK connection handling in trunk (deep compare of configs, reference counting), so it is possible the patch might need to be tweaked or the leak is somewhere else.&lt;/p&gt;</comment>
                            <comment id="13156289" author="terry.siu" created="Wed, 23 Nov 2011 21:20:29 +0000"  >&lt;p&gt;Thanks, Bryan, looking forward to getting the 0.90.4 patch.&lt;/p&gt;</comment>
                            <comment id="13190658" author="bryanck" created="Sun, 22 Jan 2012 12:41:15 +0000"  >&lt;p&gt;Here is the patch I&apos;m using in my production system for 0.90.4. (Sorry it took me so long.)&lt;/p&gt;</comment>
                            <comment id="13199325" author="terry.siu" created="Thu, 2 Feb 2012 22:54:25 +0000"  >&lt;p&gt;No worries, Bryan. I managed to patch it myself a while back using the tableinput.patch as a guideline. Thanks again!&lt;/p&gt;</comment>
                            <comment id="13199488" author="bryanck" created="Fri, 3 Feb 2012 02:51:07 +0000"  >&lt;p&gt;The latest Cloudera code introduced the new reference counting connection management. There is a reference counter leak it appears in the HTable constructor, thus you&apos;ll see connection leaks again and my patch doesn&apos;t fix it. As a hack for now I force the connection to close by using reflection, setting the ref counter to 1, and calling close() on the connection. I do this after calling table.close() in TableInputFormat, TableRecordReader, and TableOutputFormat. I think I should log another bug, as the leak is not in the map reduce classes.&lt;/p&gt;</comment>
                            <comment id="13199528" author="stack" created="Fri, 3 Feb 2012 05:26:55 +0000"  >&lt;p&gt;@Bryan Yes please.  Thats crazy acrobatics you are at just to close a connection.  Thanks.&lt;/p&gt;</comment>
                            <comment id="13258696" author="patrickyu" created="Sat, 21 Apr 2012 00:36:49 +0000"  >&lt;p&gt;One possible workaround for this issue is to reuse the connection for all jobs. However, hbase.connection.per.config must be set to false for connection sharing to work. This flag defaults to true up until &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt;, though.&lt;/p&gt;</comment>
                            <comment id="13258739" author="lhofhansl" created="Sat, 21 Apr 2012 02:01:11 +0000"  >&lt;p&gt;@Patrik: In 0.92+ you can create a standalone HConnection (HConnectionManager.createConnection(...)) and then create HTables using that HConnection. See &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4805&quot; title=&quot;Allow better control of resource consumption in HTable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4805&quot;&gt;&lt;del&gt;HBASE-4805&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13455358" author="lhofhansl" created="Thu, 13 Sep 2012 22:08:12 +0000"  >&lt;p&gt;What should we do with this?&lt;/p&gt;</comment>
                            <comment id="15671663" author="esteban" created="Wed, 16 Nov 2016 21:16:30 +0000"  >&lt;p&gt;The ZK connection leaks have been addressed multiple times over the last few years, see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14485&quot; title=&quot;ConnectionImplementation leaks on construction failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14485&quot;&gt;&lt;del&gt;HBASE-14485&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15803&quot; title=&quot;ZooKeeperWatcher&amp;#39;s constructor can leak a ZooKeeper instance with throwing ZooKeeperConnectionException when canCreateBaseZNode is true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15803&quot;&gt;&lt;del&gt;HBASE-15803&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-16117&quot; title=&quot;Fix Connection leak in mapred.TableOutputFormat &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-16117&quot;&gt;&lt;del&gt;HBASE-16117&lt;/del&gt;&lt;/a&gt;. Also, most of the connection manager code has been refactored.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12504210">HBASE-3777</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12511426" name="patch0.90.4" size="10868" author="bryanck" created="Sun, 22 Jan 2012 12:41:15 +0000"/>
                            <attachment id="12502711" name="tableinput.patch" size="8935" author="bryanck" created="Mon, 7 Nov 2011 03:06:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 16 Apr 2011 15:18:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27023</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02bsv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11513</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>