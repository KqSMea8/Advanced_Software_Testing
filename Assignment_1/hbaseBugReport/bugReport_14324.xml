<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:51:56 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-14324/HBASE-14324.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-14324] MetricSampleQuantiles maintains quantiles summary in a wrong way</title>
                <link>https://issues.apache.org/jira/browse/HBASE-14324</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The MetricSampleQuantiles computes quantiles estimations for data stream according to a paper published by CKMS in 2005. However the implementation is incorrect compared to the paper. In particular, the insert and compact methods use the rank of an item in the summary whereas the rank should be the estimated rank in the stream. Due to this bug the resulting summary is much larger than required: according to my experiments it is more than 10 times larger. Furthermore, the summary size continues to grow with stream size while the distribution doesn&apos;t change. When the number of items is in the tens of millions the summary size is about 200K while it should be in the range of few thousands. This has significant effect on performance. I didn&apos;t see significant effect on accuracy.&lt;/p&gt;

&lt;p&gt;The insert batch and compress methods call allowableError() passing the rank of the item in the summary. It actually should pass the estimated rank in the stream. In the CKMS paper this rank is denoted by r_i, which more precisely is the estimated rank of item i-1. allowableError now considers the size of the summary where it should consider the number of items that has been observed.&lt;/p&gt;

&lt;p&gt;In addition, the class currently uses a static sized buffer of size 500. This yields poor runtime performance. Increasing this buffer to size 10000 or more yields much better performance (I&apos;m using it with buffer size of 100K). The buffer size can be dynamic and grow with number of items in the stream.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12859558">HBASE-14324</key>
            <summary>MetricSampleQuantiles maintains quantiles summary in a wrong way</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rafis">Rafi Shachar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Aug 2015 09:38:25 +0000</created>
                <updated>Wed, 2 Sep 2015 02:27:01 +0000</updated>
                                                                            <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14716398" author="rafis" created="Thu, 27 Aug 2015 09:48:29 +0000"  >&lt;p&gt;Here&apos;s how roughly insert batch should be implemented (code is based on the original code form github). The compress method should be corrected in a similar manner.&lt;/p&gt;

&lt;p&gt;		ListIterator&amp;lt;Item&amp;gt; it = sample.listIterator();&lt;br/&gt;
		Item item = it.next();&lt;br/&gt;
		currMinRank += item.g;&lt;br/&gt;
		for (int i = start; i &amp;lt; bufferCount; i++) {&lt;br/&gt;
			long v = buffer&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;;&lt;br/&gt;
			while (it.nextIndex() &amp;lt; sample.size() &amp;amp;&amp;amp; item.value &amp;lt; v) &lt;/p&gt;
{
				item = it.next();
				currMinRank += item.g;
			}
&lt;p&gt;			// If we found that bigger item, back up so we insert ourselves&lt;br/&gt;
			// before it&lt;br/&gt;
			if (item.value &amp;gt; v) &lt;/p&gt;
{
				currMinRank -= item.g;
				item = it.previous();
			}

&lt;p&gt;			int delta;&lt;br/&gt;
			if (it.previousIndex() == 0 || it.nextIndex() == sample.size()) &lt;/p&gt;
{
				delta = 0;
			}
&lt;p&gt; else &lt;/p&gt;
{
				int ri = currMinRank;  
				delta = ((int) Math.floor(allowableError_fixed(ri))) - 1;
			}

&lt;p&gt;			Item newItem = new Item(v, 1, delta);&lt;br/&gt;
			it.add(newItem);&lt;br/&gt;
			count++;&lt;br/&gt;
			item = newItem;&lt;br/&gt;
			currMinRank += item.g;&lt;br/&gt;
			printList();&lt;br/&gt;
		}&lt;/p&gt;</comment>
                            <comment id="14716423" author="rafis" created="Thu, 27 Aug 2015 10:17:24 +0000"  >&lt;p&gt;In allowaleError method replace&lt;br/&gt;
int size = sample.size();&lt;br/&gt;
with&lt;br/&gt;
int size = count;&lt;/p&gt;</comment>
                            <comment id="14721202" author="gliptak" created="Sat, 29 Aug 2015 18:28:55 +0000"  >&lt;p&gt;The current code&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hbase/blob/master/hbase-hadoop2-compat/src/main/java/org/apache/hadoop/metrics2/util/MetricSampleQuantiles.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/hbase/blob/master/hbase-hadoop2-compat/src/main/java/org/apache/hadoop/metrics2/util/MetricSampleQuantiles.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;is very similar to&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/umbrant/QuantileEstimation/blob/master/src/main/java/com/umbrant/quantile/QuantileEstimationCKMS.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/umbrant/QuantileEstimation/blob/master/src/main/java/com/umbrant/quantile/QuantileEstimationCKMS.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Maybe that project could be pulled in as a dependency?&lt;/p&gt;</comment>
                            <comment id="14726622" author="apurtell" created="Wed, 2 Sep 2015 02:27:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe that project could be pulled in as a dependency?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We shouldn&apos;t add more dependencies on random github projects. If it were something from a community maintained artifact I&apos;d feel differently. Best to fix the code we have on hand IMHO&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 29 Aug 2015 18:28:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 15 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jfvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>