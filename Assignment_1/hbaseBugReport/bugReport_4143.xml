<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:16:16 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4143/HBASE-4143.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4143] HTable.doPut(List) should check the writebuffer length every so often</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4143</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;This came up on a dist-list conversation between Andy P., Ted Yu, and myself.  Andy noted that extremely large lists passed into put(List) can cause issues.  Ted suggested that having doPut check the write-buffer length every so often (5-10 records?) so the flush doesn&apos;t happen only at the end, and I think that&apos;s good idea.&lt;/p&gt;

&lt;p&gt; public void put(final List&amp;lt;Put&amp;gt; puts) throws IOException &lt;/p&gt;
{
    doPut(puts);
  }
&lt;p&gt;  private void doPut(final List&amp;lt;Put&amp;gt; puts) throws IOException {&lt;br/&gt;
    for (Put put : puts) &lt;/p&gt;
{
      validatePut(put);
      writeBuffer.add(put);
      currentWriteBufferSize += put.heapSize();
    }
&lt;p&gt;    if (autoFlush || currentWriteBufferSize &amp;gt; writeBufferSize) &lt;/p&gt;
{
      flushCommits();
    }
&lt;p&gt;  }&lt;/p&gt;

&lt;p&gt;Once this change is made, remove the comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4142&quot; title=&quot;Advise against large batches in javadoc for HTable#put(List&amp;lt;Put&amp;gt;)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4142&quot;&gt;&lt;del&gt;HBASE-4142&lt;/del&gt;&lt;/a&gt; about large lists being a performance problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12515520">HBASE-4143</key>
            <summary>HTable.doPut(List) should check the writebuffer length every so often</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dmeil">Doug Meil</assignee>
                                    <reporter username="dmeil">Doug Meil</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Jul 2011 12:10:53 +0000</created>
                <updated>Wed, 3 Aug 2011 20:40:56 +0000</updated>
                            <resolved>Wed, 3 Aug 2011 20:40:56 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13071982" author="dmeil" created="Wed, 27 Jul 2011 20:34:33 +0000"  >&lt;p&gt;Changed HTable.doPut for periodic check of in-loop writebuffer length, and javadoc comment in HTableIterface.&lt;/p&gt;

&lt;p&gt;I ran TestHTableUtil locally because that uses the put(List) method, and the tests passed.&lt;/p&gt;</comment>
                            <comment id="13071994" author="yuzhihong@gmail.com" created="Wed, 27 Jul 2011 20:43:59 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; doPutWbCheck = 10;    &lt;span class=&quot;code-comment&quot;&gt;// i.e., doPut checks the writebuffer every X Puts.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The above should be declared static final and spelled in upper-case.&lt;/p&gt;</comment>
                            <comment id="13072003" author="dmeil" created="Wed, 27 Jul 2011 20:58:20 +0000"  >&lt;p&gt;I had this vision of people at some point wanting this check to be configurable per HTable, but I think it&apos;s better to start with a constant.&lt;/p&gt;

&lt;p&gt;Changed.&lt;/p&gt;</comment>
                            <comment id="13072008" author="yuzhihong@gmail.com" created="Wed, 27 Jul 2011 21:04:45 +0000"  >&lt;p&gt;+1 on second patch.&lt;/p&gt;</comment>
                            <comment id="13072048" author="apurtell" created="Wed, 27 Jul 2011 21:59:29 +0000"  >&lt;p&gt;+1 on second patch.&lt;/p&gt;

&lt;p&gt;I made just a documentation change because I wasn&apos;t convinced that really large RPCs didn&apos;t have a place, but if the consensus is to change put(List&amp;lt;Put&amp;gt;) that makes sense to me. &lt;/p&gt;</comment>
                            <comment id="13072065" author="dmeil" created="Wed, 27 Jul 2011 22:28:08 +0000"  >&lt;p&gt;Andy, I&apos;m glad you made that doc-change because it exposed an edge-case for that method! Thanks.&lt;/p&gt;</comment>
                            <comment id="13072119" author="yuzhihong@gmail.com" created="Thu, 28 Jul 2011 00:24:52 +0000"  >&lt;p&gt;Integrated to branch and TRUNK.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Doug.&lt;br/&gt;
Thanks for the review Andrew.&lt;/p&gt;</comment>
                            <comment id="13072605" author="ghelmling" created="Thu, 28 Jul 2011 23:49:09 +0000"  >&lt;p&gt;The fix committed for this issue unfortunately causes a new performance problem when autoflush==true.&lt;/p&gt;

&lt;p&gt;In this case, the effect is to call flushCommits() every 10 items in the List&amp;lt;Put&amp;gt;.  This effectively disables the ability to do batching.&lt;/p&gt;

&lt;p&gt;For the check internal to the for loop over List&amp;lt;Put&amp;gt;, we should only be checking if currentWriteBufferSize &amp;gt; writeBufferSize.  The check on autoflush should only come after the for loop.&lt;/p&gt;</comment>
                            <comment id="13072613" author="yuzhihong@gmail.com" created="Fri, 29 Jul 2011 00:01:03 +0000"  >&lt;p&gt;Looking at javadoc for flushCommits():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   * This method gets called once automatically &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; every {@link Put} or batch
   * of {@link Put}s (when &amp;lt;code&amp;gt;put(List&amp;lt;Put&amp;gt;)&amp;lt;/code&amp;gt; is used) when
   * {@link #isAutoFlush} is {@code &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;}.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If single Put isn&apos;t batched, I wonder why the user would want to batch list of &lt;/p&gt;
{@link Put}
&lt;p&gt;s.&lt;/p&gt;</comment>
                            <comment id="13072617" author="ghelmling" created="Fri, 29 Jul 2011 00:10:17 +0000"  >&lt;p&gt;Update to internal check so that we&apos;re only checking against the write buffer and so we continue checking if the first check is false (previously &quot;n&quot; would not get reset and subsequent checks would fail if the first write buffer check was negative).&lt;/p&gt;</comment>
                            <comment id="13072618" author="apurtell" created="Fri, 29 Jul 2011 00:13:54 +0000"  >&lt;p&gt;+1 on the update patch. Thanks for spotting the actual bug. Originally I just wanted a documentation update so the batching behavior (and large RPCs if the user wishes) could be preserved, so I&apos;m happy with that change as well.&lt;/p&gt;</comment>
                            <comment id="13072622" author="ghelmling" created="Fri, 29 Jul 2011 00:33:38 +0000"  >&lt;blockquote&gt;
&lt;p&gt;If single Put isn&apos;t batched, I wonder why the user would want to batch list of &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {@link Put}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;s.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The current semantics are: if autoflush is enabled, writes are automatically flushed for you at the end of put(List&amp;lt;Put&amp;gt;); if disabled, then writes are buffered until the write buffer is full.&lt;/p&gt;

&lt;p&gt;I don&apos;t really want to change that as part of this issue.  As I see it the intent here is just to respect the write buffer sizing when batching.  I just want to fix an anti-pattern we introduced from an implementation detail of the original fix.&lt;/p&gt;</comment>
                            <comment id="13072623" author="yuzhihong@gmail.com" created="Fri, 29 Jul 2011 00:34:45 +0000"  >&lt;p&gt;I applied Gary&apos;s patch to branch and TRUNK.&lt;br/&gt;
Looking at the check:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (n % DOPUT_WB_CHECK == 0 &amp;amp;&amp;amp; currentWriteBufferSize &amp;gt; writeBufferSize) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the effect is that if write buffer size is reached at Put #11, we would wait till Put #20 (suppose there&apos;re at least 20 Put&apos;s) to flush.&lt;br/&gt;
I guess it is Okay since we may have closen 20 as DOPUT_WB_CHECK in the beginning.&lt;/p&gt;

&lt;p&gt;I will wait for a day before resolving this JIRA.&lt;/p&gt;

&lt;p&gt;Thanks for Gary&apos;s sharp eyes and sharp mind.&lt;/p&gt;</comment>
                            <comment id="13072652" author="hudson" created="Fri, 29 Jul 2011 02:19:03 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2061 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2061/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2061/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4143&quot; title=&quot;HTable.doPut(List) should check the writebuffer length every so often&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4143&quot;&gt;&lt;del&gt;HBASE-4143&lt;/del&gt;&lt;/a&gt; HTable.doPut(List) should check the writebuffer length every so often&lt;br/&gt;
           addendum by Gary H&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13072771" author="dmeil" created="Fri, 29 Jul 2011 10:46:34 +0000"  >&lt;p&gt;re:  &quot;This effectively disables the ability to do batching.&quot;&lt;/p&gt;

&lt;p&gt;There is already a client method called &apos;batch&apos;.  I think that should be encouraged to be the preferred batch method if callers want a &quot;do exactly what I say&quot; approach.  Otherwise, put(Put) and put(List) should obey the writeBuffer rules.  I&apos;m cool with the patch though.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12488156" name="HBASE-4143_update.patch" size="844" author="ghelmling" created="Fri, 29 Jul 2011 00:10:17 +0000"/>
                            <attachment id="12488027" name="client_HBASE_4143.patch" size="2237" author="dmeil" created="Wed, 27 Jul 2011 20:56:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 27 Jul 2011 20:43:59 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33392</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hpkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101406</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>