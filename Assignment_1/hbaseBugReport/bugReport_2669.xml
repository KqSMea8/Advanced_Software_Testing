<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:03:47 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2669/HBASE-2669.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2669] HCM.shutdownHook causes data loss with hbase.client.write.buffer != 0</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2669</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In my application I set &lt;tt&gt;hbase.client.write.buffer&lt;/tt&gt; to a reasonably small value (roughly 64 edits) in order to try to batch a few &lt;tt&gt;Put&lt;/tt&gt; together before talking to HBase.  When my application does a graceful shutdown, I call &lt;tt&gt;HTable#flushCommits&lt;/tt&gt; in order to flush any pending change to HBase.  I want to do the same thing when I get a &lt;tt&gt;SIGTERM&lt;/tt&gt; by using &lt;tt&gt;Runtime#addShutdownHook&lt;/tt&gt; but this is impossible since &lt;tt&gt;HConnectionManager&lt;/tt&gt; already registers a shutdown hook that invokes &lt;tt&gt;HConnectionManager#deleteAllConnections&lt;/tt&gt;.  This static method closes all the connections to HBase and then all connections to ZooKeeper.  Because all shutdown hooks run in parallel, my hook will attempt to flush edits while connections are getting closed.&lt;/p&gt;

&lt;p&gt;There is no way to guarantee the order in which the hooks will execute, so I propose that we remove the hook in the HCM altogether and provide some user-visible API they call in their own hook after they&apos;re done flushing their stuff, if they really want to do a graceful shutdown.  I expect that a lot of users won&apos;t use a hook though, otherwise this issue would have cropped up already.  For those users, connections won&apos;t get &quot;gracefully&quot; terminated, but I don&apos;t think that would be a problem since the underlying TCP socket will get closed by the OS anyway, so things like ZooKeeper and such should realize that the connection has been terminated and assume the client is gone, and do the necessary clean-up on their side.&lt;/p&gt;

&lt;p&gt;An alternate fix would be to leave the hook in place by default but keep a reference to it and add a user-visible API to be able to un-register the hook.  I find this ugly.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12466236">HBASE-2669</key>
            <summary>HCM.shutdownHook causes data loss with hbase.client.write.buffer != 0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="tsuna">Benoit Sigoure</reporter>
                        <labels>
                    </labels>
                <created>Sat, 5 Jun 2010 02:21:02 +0000</created>
                <updated>Fri, 20 Nov 2015 12:44:05 +0000</updated>
                            <resolved>Mon, 18 Oct 2010 23:58:18 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12875915" author="stack" created="Sat, 5 Jun 2010 16:18:46 +0000"  >&lt;p&gt;In old days, we had similar prob w/ hdfs.  We wanted to run a shutdown cleanup of hbase  hook but hdfs would be running its clean up at same time and we couldn&apos;t guarantee order.&lt;/p&gt;

&lt;p&gt;Using reflection, we looked for hdsf hook, if present, unregistered it but kept a reference and then in our shutdown hook, after was done, we&apos;d call the hdfs one.  Lets fix this benoit.  Mind if I move it out of 0.20.5 though?  Its a prob. but not end of world and I&apos;d like to get a 0.20.5 rolled today.  Thanks.&lt;/p&gt;</comment>
                            <comment id="12875916" author="stack" created="Sat, 5 Jun 2010 16:19:27 +0000"  >&lt;p&gt;hmm... well yeah, its pretty critical prob.  want to work on this today then?&lt;/p&gt;</comment>
                            <comment id="12875934" author="stack" created="Sat, 5 Jun 2010 20:33:45 +0000"  >&lt;p&gt;Moving out of 0.20.5.  There is a workaround for now.  See suppressHdfsShutdownHook in HRegionServer for how to remove the installed HCM shutdown hook and install your own instead... running the HCM one after yours.   Its ugly but it works.  While the implication is dataloss if you SIGTERM the hosting application, this is sort of a new request/feature, or putting it another way, its a problem we&apos;ve had for a long time, not particular to 0.20.5.  I don&apos;t thnk it a blocker.  Sink the coming RC if you think otherwise Benoit by voting against it but for now, I&apos;d like to show there is movement around 0.20.5 release by posting a new RC. &lt;/p&gt;</comment>
                            <comment id="12875937" author="stack" created="Sat, 5 Jun 2010 20:58:48 +0000"  >&lt;p&gt;This shutdown hook registration is buried way deap.  Its way down in HCM and its registered on static initialization.  You can&apos;t really get an HCM legitimately, not w/o doing some instanceof and casting of an HConnection returned when you do a getConnection.   What would you suggest Benoit?  The HRS#suppressHdfsShutdownHook looks pretty good to me compared to exposing HCM and letting user get at the shutdown hook that way?&lt;/p&gt;</comment>
                            <comment id="12875963" author="tsuna" created="Sat, 5 Jun 2010 23:07:56 +0000"  >&lt;p&gt;As you wrote Stack, there&apos;s no easy way to get to the HCM&apos;s hook.  First of all, the HCM itself doesn&apos;t retain a reference to it, so right now it&apos;s just impossible to reach.  Even if a reference was retained, the &lt;tt&gt;suppressHdfsShutdownHook&lt;/tt&gt; hack in &lt;tt&gt;HRegionServer&lt;/tt&gt; seems too ugly and fragile to me.  We don&apos;t need to expose this internal implementation detail of the HCM to user.  Instead we can just have a static method in &lt;tt&gt;HTable&lt;/tt&gt; that the user can call to perform a graceful shutdown.&lt;/p&gt;

&lt;p&gt;But I also doubt this hook is useful at all.  As I said, I&apos;m not sure we need to properly close the connections ourselves.  The OS will take care of them anyway, and whatever the client was talking to will be notified that the socket was closed on the other side.  Maybe we can just remove the hook altogether and get away with it.&lt;/p&gt;

&lt;p&gt;BTW, sorry I didn&apos;t mean to close 0.20.5 with this issue, I&apos;m working with &lt;tt&gt;trunk&lt;/tt&gt; so this has nothing to do with 0.20.5 anyway.  I also noticed that &lt;tt&gt;suppressHdfsShutdownHook&lt;/tt&gt; has gone away in trunk.  Not sure why, but that&apos;s a good thing.&lt;/p&gt;</comment>
                            <comment id="12893201" author="hector.izquierdo" created="Wed, 28 Jul 2010 15:14:37 +0000"  >&lt;p&gt;An ugly workaround:&lt;/p&gt;

&lt;p&gt;private Thread getEvilHTableShutdownHook() throws Exception {&lt;/p&gt;

&lt;p&gt;        Class clazz = Class.forName(&quot;java.lang.ApplicationShutdownHooks&quot;);&lt;/p&gt;

&lt;p&gt;        Field[] fields = clazz.getDeclaredFields();&lt;/p&gt;

&lt;p&gt;        for (Field field : fields) {&lt;/p&gt;

&lt;p&gt;            if (field.getType() == IdentityHashMap.class) {&lt;br/&gt;
                field.setAccessible(true);&lt;br/&gt;
                IdentityHashMap&amp;lt;Thread, Thread&amp;gt; hooks = (IdentityHashMap&amp;lt;Thread, Thread&amp;gt;) field.get(null);&lt;/p&gt;

&lt;p&gt;                for (Map.Entry&amp;lt;Thread, Thread&amp;gt; entries : hooks.entrySet()) {&lt;br/&gt;
                    System.out.println(entries.getKey().getName());&lt;br/&gt;
                    if (entries.getValue().getName().equals(&quot;HCM.shutdownHook&quot;)) &lt;/p&gt;
{
                        return entries.getValue();
                    }
&lt;p&gt;                }&lt;/p&gt;

&lt;p&gt;            }&lt;br/&gt;
        }&lt;/p&gt;

&lt;p&gt;        return null;&lt;br/&gt;
    }&lt;/p&gt;</comment>
                            <comment id="12893244" author="stack" created="Wed, 28 Jul 2010 16:54:51 +0000"  >&lt;p&gt;Nice trick H&#233;ctor (/me puts it in backpocket)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1999&quot; title=&quot;When HTable goes away, close zk session in shutdown hook or something...&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1999&quot;&gt;&lt;del&gt;HBASE-1999&lt;/del&gt;&lt;/a&gt; added the shutdown hook to get around noise in zk logs about expired sessions during the running of big MR jobs.  I thought it was needed for unit tests but I see that tests explicitly call HCM#deleteAllConnections when shutting down minicluster.  Running patch with the shutdown hook removed seems fine.&lt;/p&gt;</comment>
                            <comment id="12893250" author="stack" created="Wed, 28 Jul 2010 17:01:52 +0000"  >&lt;p&gt;How about this Beni&#244;t?  It removes the shutdown hook and then instead inside in TOF, on close, it does explicit HConnectionManager.deleteAllConnections(true);  I haven&apos;t tried it yet.  If you think it way to go, I&apos;ll try it doing MR to see if it beaks anything.&lt;/p&gt;</comment>
                            <comment id="12894723" author="tsuna" created="Mon, 2 Aug 2010 21:44:58 +0000"  >&lt;p&gt;I&apos;m OK with your patch stack, thanks for putting it together.&lt;/p&gt;

&lt;p&gt;Minor stylistic nit: it&apos;s not clear to me why the import of &lt;tt&gt;MetaScanner.MetaScannerVisitor&lt;/tt&gt; has moved around in &lt;tt&gt;HMaster.java&lt;/tt&gt;, lines are now out of order.  Plus, I don&apos;t think &lt;tt&gt;HMaster.java&lt;/tt&gt; should be changed as part of this issue, as this issue has nothing to do with the master.&lt;/p&gt;</comment>
                            <comment id="12902202" author="jdcryans" created="Wed, 25 Aug 2010 00:29:02 +0000"  >&lt;p&gt;You want to commit this Stack?&lt;/p&gt;</comment>
                            <comment id="12921789" author="stack" created="Sun, 17 Oct 2010 04:46:30 +0000"  >&lt;p&gt;Let me fix up this patch and make it apply to trunk.  I think its general drift is fine.  Whats missing now is a bunch of explaination of how Connections work and are shared &amp;#8211; of how the sharing is keyed by Configuration and of how if you want a clean shutdown of your tables, then you will need to do the ugly HConnectionManager.deleteConnection stuff for now, in 0.90, at least.&lt;/p&gt;

&lt;p&gt;Running tests.&lt;/p&gt;</comment>
                            <comment id="12922326" author="stack" created="Mon, 18 Oct 2010 22:23:28 +0000"  >&lt;p&gt;Version 2.  In this version, we add more explicit closeups of HConnection and then add a bunch of javadoc explaining how HConnection works and how its cleanup is done.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
A set of changes that allow doing away with shutdown hook in client.

M src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperWatcher.java
  Removed unused &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; and changed message from info to debug
  -- when info it shows in shell whenever we run a command.
M src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
  Changed message from info to debug -- when info it shows in shell
  whenever we run a command.
M src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
  Changed order; online region before we tell everyone where the
  region is (I changed &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; order recently but reviewing comments
  and issues I can&apos;t figure why I did it -- I think there was a
  reason but can&apos;t recall so just put &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; back until we trip
  over the issue again.  My change made it so that we had
  strange issue where we&apos;d get a NSRE though the region was coming
  up here on &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; server... rather than &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; retries of NSREs,
  put it into online servers before updating zk... again).
M src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java
  Removed noisy message
M src/main/java/org/apache/hadoop/hbase/master/LogCleanerDelegate.java
  Have &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; implement Stoppable... Some implemenations
  need their Stop called.
M src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
  Startup wont work w/o &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; change.
M src/main/java/org/apache/hadoop/hbase/master/LogCleaner.java
  Wrap the chore run so we can call the stop on all log cleaners.
M src/main/java/org/apache/hadoop/hbase/master/TimeToLiveLogCleaner.java
M src/main/java/org/apache/hadoop/hbase/replication/master/ReplicationLogCleaner.java
  Implement Stoppable
M src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  Cleanup all connections on way out.
M src/main/java/org/apache/hadoop/hbase/util/HMerge.java
  Cleanup proxies.... was &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;.
M src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java
M src/main/java/org/apache/hadoop/hbase/client/HConnection.java
  Javadoc explaining how HConnections work.
M src/main/java/org/apache/hadoop/hbase/client/HTablePool.java
  Make it so we make a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration and that we then
  &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; our own cleanup when pool is shutdown.
M src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java
  Use alternate method now the one that takes a Connection removed.
M src/main/java/org/apache/hadoop/hbase/client/HTable.java
  More javadoc on how HConnection works.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12922368" author="stack" created="Mon, 18 Oct 2010 23:58:18 +0000"  >&lt;p&gt;Committed.  Thanks for the review Jon.  Did all you suggested on commit (Did not add back your RIT logging &amp;#8211; you can do taht if you need it).&lt;/p&gt;</comment>
                            <comment id="15017703" author="lars_francke" created="Fri, 20 Nov 2015 12:44:05 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12473071">HBASE-2952</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12457494" name="2669-v2.txt" size="25079" author="stack" created="Mon, 18 Oct 2010 22:23:28 +0000"/>
                            <attachment id="12450726" name="2669.txt" size="3968" author="stack" created="Wed, 28 Jul 2010 17:01:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 5 Jun 2010 16:18:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26414</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hip3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100291</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>data loss</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>