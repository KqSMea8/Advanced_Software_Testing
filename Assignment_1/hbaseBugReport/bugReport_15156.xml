<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:00:18 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-15156/HBASE-15156.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-15156] Support first assignment of split daughters to non-parent RS</title>
                <link>https://issues.apache.org/jira/browse/HBASE-15156</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;On region split, the region&apos;s daughter is always opened by the same region server hosting the parent region. In some cases this is not ideal:&lt;/p&gt;

&lt;p&gt;This feature was mainly needed for favored nodes to allow for more freedom when selecting favored nodes for daughter regions. ie The daughter doesn&apos;t have to always select the regionserver hosting the split as a favored node which should allow for better favored node distribution.&lt;/p&gt;

&lt;p&gt;Though this feature is actually useful in cases where region splits occur much more often than the balancer is run. It also is a bit more efficient as the major compaction that occurs after daughter assignment does not go to waste (ie cancelled half-way, loss of locality due to move, etc). We actually run it this way in some of our clusters even without favored nodes enabled. Hence I am supplying a patch which is independent of favored nodes.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12933207">HBASE-15156</key>
            <summary>Support first assignment of split daughters to non-parent RS</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12953625">HBASE-15531</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="toffer">Francis Liu</assignee>
                                    <reporter username="toffer">Francis Liu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Jan 2016 23:30:03 +0000</created>
                <updated>Fri, 6 May 2016 15:39:24 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                <comments>
                            <comment id="15111612" author="toffer" created="Thu, 21 Jan 2016 23:36:21 +0000"  >&lt;p&gt;review board:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/42622/diff/1#index_header&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/42622/diff/1#index_header&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15126392" author="devaraj" created="Mon, 1 Feb 2016 15:31:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; mind taking a look at this please&lt;/p&gt;</comment>
                            <comment id="15126900" author="stack" created="Mon, 1 Feb 2016 19:50:07 +0000"  >&lt;p&gt;We assign daughters to the same node as parent because this way we can get the data back on line more promptly.&lt;/p&gt;

&lt;p&gt;On patch, seems fine for branch-1. Should update doc on method to say sna and snb are optional on splitRegion.&lt;/p&gt;

&lt;p&gt;This is odd:&lt;/p&gt;

&lt;p&gt;public static final String ASSIGN_DAUGHTERS_AFTER_SPLIT =&lt;br/&gt;
      &quot;hbase.split.unassign&quot;;&lt;/p&gt;

&lt;p&gt;Varname talks about ASSIGN but config String says unassign.&lt;/p&gt;

&lt;p&gt;Why not swap order on this if/else rather than negate the if condition... makes it harder to read:&lt;/p&gt;

&lt;p&gt;      if (!shouldAssignAfterSplit) {&lt;/p&gt;

&lt;p&gt;Could you group the two clausees that get invoked when shouldAssignAfterSplit == true ?&lt;/p&gt;

&lt;p&gt;What region is being offlined here: regionOffline(hri, State.SPLIT); .. the parent?&lt;/p&gt;

&lt;p&gt;Why not have this assign happen in the call to onRegionSplit?&lt;/p&gt;

&lt;p&gt;We do this check in two places....&lt;/p&gt;

&lt;p&gt;        !services.getConfiguration().getBoolean(HConstants.ASSIGN_DAUGHTERS_AFTER_SPLIT, false)) {&lt;/p&gt;

&lt;p&gt;Seems like should be one place where we do it.&lt;/p&gt;

&lt;p&gt;The patch changes APIs to add optional new daughter assign servers and then does  checks in a bunch of places taking different forks dependent on whether daughters are to be assigned elsewhere or not. Its not pretty. Could this feature be better contained? For instance, could the assign happen inside in the onRegionSplit?  Could the assign be done inside in the SplitRegionTransaction rather than up in AM so it aligned better with how our current split works?&lt;/p&gt;

&lt;p&gt;If not, patch will work, for branch-1 at least.&lt;/p&gt;
</comment>
                            <comment id="15127799" author="devaraj" created="Tue, 2 Feb 2016 07:04:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;If not, patch will work, for branch-1 at least.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; quick question - mind telling me why branch-1 and not both master and branch-1? &lt;/p&gt;</comment>
                            <comment id="15128623" author="stack" created="Tue, 2 Feb 2016 17:32:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;stack quick question - mind telling me why branch-1 and not both master and branch-1?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;nvm. AM is changing in master is what I meant. Hopefully the need for this sort of interpolation at multiple points changing an AM process that no one really understands adding new failure modes that will be found six months down the line when we&apos;ve all forgotten what was done here will happen less. Master does AM in AMv2. A config that says assign to servers other than that of the parents will be an easier insert.&lt;/p&gt;</comment>
                            <comment id="15129708" author="toffer" created="Wed, 3 Feb 2016 03:20:05 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; some responses:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;We assign daughters to the same node as parent because this way we can get the data back on line more promptly.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What was the reason it was faster? In terms of assigment overhead I don&apos;t think there&apos;s much difference in zkless land since everything has to go through the master now before becoming visible.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;On patch, seems fine for branch-1. Should update doc on method to say sna and snb are optional on splitRegion.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Will do.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;On patch, seems fine for branch-1. Should update doc on method to say sna and snb are optional on splitRegion.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What would need to be done to get it into trunk?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;public static final String ASSIGN_DAUGHTERS_AFTER_SPLIT =&lt;br/&gt;
&quot;hbase.split.unassign&quot;;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;will fix.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Could you group the two clausees that get invoked when shouldAssignAfterSplit == true ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;will do.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;What region is being offlined here: regionOffline(hri, State.SPLIT); .. the parent?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yup parent. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Why not have this assign happen in the call to onRegionSplit?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Because it&apos;s just a waste of RPC. We already do something similar if the RS performing the split dies, so this is not unprecendent. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;!services.getConfiguration().getBoolean(HConstants.ASSIGN_DAUGHTERS_AFTER_SPLIT, false)) {&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Will consolidate. we can actually take this a step further and embed in the response to reportRegionInTransition() call to master wether the RS should online the daughter regions. This way we need only the config set on the master minimizes config errors?&lt;/p&gt;


</comment>
                            <comment id="15129710" author="toffer" created="Wed, 3 Feb 2016 03:22:33 +0000"  >&lt;blockquote&gt;
&lt;p&gt;For instance, could the assign happen inside in the onRegionSplit? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Another approach is to remove onRegionSplit altogether and have invokeAssign() assign the daughters to the RS that initiated the split. This way the forked code between the two behaviors becomes insignificant. This is also more efficient it seems. Thoughts?&lt;/p&gt;</comment>
                            <comment id="15129839" author="stack" created="Wed, 3 Feb 2016 05:46:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;What was the reason it was faster?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No trip to the master to have it do assigment rpc&apos;ing other servers; all was done local on the splitting regionserver.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I don&apos;t think there&apos;s much difference in zkless land since everything has to go through the master now before becoming visible.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What would need to be done to get it into trunk?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We can commit to trunk. It will be refactored later as part of the AM redo that is ongoing (Matteo and Stephen).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;; .. the parent?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Comment then please.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Because it&apos;s just a waste of RPC. We already do something similar if the RS performing the split dies, so this is not unprecendent.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;HBase is like the Bible; you can find a precedent for any argument you might like to make in it (smile). onRegionSplit is where I&apos;d expect to find the assign. Its ok.&lt;/p&gt;

</comment>
                            <comment id="15129843" author="stack" created="Wed, 3 Feb 2016 05:48:16 +0000"  >&lt;p&gt;I like the idea of difference being insignificant but the AM is such a fragile bit of code and state machine, I&apos;d be wary messing with it. If it won&apos;t take much work, give it a go... if it looks good, I can try it on little rig here to see if it destabilizes.&lt;/p&gt;</comment>
                            <comment id="15131496" author="toffer" created="Thu, 4 Feb 2016 01:16:41 +0000"  >&lt;p&gt;Draft patch streamlining the split code to no longer use SPLIT transition. This is a draft since I haven&apos;t totally streamlined the changes (ie we no longer need the new splitRegion() related apis). Also had to update some tests...it seems some of them were buggy to begin with (ie some expect zk style assignment but we no longer have that option in trunk). I addressed some of the comments but not all since they&apos;ll go away if we go with this approach.&lt;/p&gt;</comment>
                            <comment id="15131515" author="toffer" created="Thu, 4 Feb 2016 01:30:18 +0000"  >&lt;p&gt;Yup it&apos;s a small change from the current patch I have. If you see there&apos;s only one branch for the shouldAssign flag and the code is insignificant. I know all too well how fragile the AM is. This approach simplifies the state machine. For one thing it simplifies the state handling between splits and SSH (AKA CRP), since it removes that not so nice nuance of having to pretend that the region server is holding the daughters during PONR, while the other metadata in regionstates says otherwise.&lt;/p&gt;</comment>
                            <comment id="15131517" author="toffer" created="Thu, 4 Feb 2016 01:31:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; I&apos;ve uploaded a draft patch you can try out. I&apos;ll clean things up if you&apos;re fine with this approach.&lt;/p&gt;</comment>
                            <comment id="15274228" author="syuanjiang" created="Fri, 6 May 2016 15:39:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toffer&quot; class=&quot;user-hover&quot; rel=&quot;toffer&quot;&gt;Francis Liu&lt;/a&gt;, look at your patch.  Overall, it looks good.  If you can add a UT that assign daughter regions to different RS, this would be even better.  I have a question on the new config you added, it looks like only be checked in unit test.  &lt;/p&gt;

&lt;p&gt;When &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt; and I discussed on AM rewrite, we talked about the same idea to assign one daughter region to a non-parent RS.  I think the logic you put here would also be benefit in master branch for the new AM.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12647583">HBASE-8549</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12783705" name="HBASE-15156.patch" size="22795" author="toffer" created="Thu, 21 Jan 2016 23:32:45 +0000"/>
                            <attachment id="12786158" name="HBASE-15156_1.patch" size="28898" author="toffer" created="Thu, 4 Feb 2016 01:16:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 1 Feb 2016 15:31:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2rtlb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>