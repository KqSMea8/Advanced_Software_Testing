<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:20:33 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11142/HBASE-11142.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11142] Taking snapshots can leave sockets on the master stuck in CLOSE_WAIT state</title>
                <link>https://issues.apache.org/jira/browse/HBASE-11142</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;As reported by Hansi Klose on user@. &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;we use a script to take on a regular basis snapshot&apos;s and delete old one&apos;s.&lt;br/&gt;
We recognizes that the web interface of the hbase master was not working any more because of too many open files.&lt;br/&gt;
The master reaches his number of open file limit of 32768&lt;br/&gt;
When I run lsof I saw that there where a lot of TCP CLOSE_WAIT handles open with the regionserver as target.&lt;br/&gt;
On the regionserver there is just one connection to the hbase master.&lt;br/&gt;
I can see that the count of the CLOSE_WAIT handles grow each time&lt;br/&gt;
i take a snapshot. When i delete on nothing changes.&lt;br/&gt;
Each time i take a snapshot  there are 20 - 30 new CLOSE_WAIT handles.&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="12713216">HBASE-11142</key>
            <summary>Taking snapshots can leave sockets on the master stuck in CLOSE_WAIT state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 May 2014 23:47:55 +0000</created>
                <updated>Fri, 9 May 2014 00:02:30 +0000</updated>
                                            <version>0.94.2</version>
                    <version>0.99.0</version>
                    <version>0.96.1.1</version>
                    <version>0.98.2</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13993256" author="apurtell" created="Thu, 8 May 2014 23:48:17 +0000"  >&lt;p&gt;For example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ lsof | grep TCP | grep CLOSE_WAIT
java       793   hbase  286u     IPv4         2296149216      0t0        TCP hmaster.domain.local:54849-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  292u     IPv4         2296149231      0t0        TCP hmaster.domain.local:54850-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  297u     IPv4         2296149243      0t0        TCP hmaster.domain.local:54851-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  298u     IPv4         2296149250      0t0        TCP hmaster.domain.local:54852-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  299u     IPv4         2296149260      0t0        TCP hmaster.domain.local:45214-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  311u     IPv4         2296149268      0t0        TCP hmaster.domain.local:54413-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  312r     IPv4         2296149276      0t0        TCP hmaster.domain.local:54414-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  313u     IPv4         2296149284      0t0        TCP hmaster.domain.local:54856-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  314u     IPv4         2296149294      0t0        TCP hmaster.domain.local:54857-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  315u     IPv4         2296149304      0t0        TCP hmaster.domain.local:45219-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  316u     IPv4         2296159910      0t0        TCP hmaster.domain.local:54958-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  317r     IPv4         2296159918      0t0        TCP hmaster.domain.local:45320-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  318u     IPv4         2296159934      0t0        TCP hmaster.domain.local:54961-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  319u     IPv4         2296159954      0t0        TCP hmaster.domain.local:54521-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  320u     IPv4         2296160007      0t0        TCP hmaster.domain.local:54522-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  321u     IPv4         2296160024      0t0        TCP hmaster.domain.local:54523-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  322u     IPv4         2296160043      0t0        TCP hmaster.domain.local:54965-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  323u     IPv4         2296160051      0t0        TCP hmaster.domain.local:54525-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  324u     IPv4         2296160059      0t0        TCP hmaster.domain.local:45328-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  325u     IPv4         2296160067      0t0        TCP hmaster.domain.local:54527-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  326u     IPv4         2296167761      0t0        TCP hmaster.domain.local:55061-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  327r     IPv4         2296167767      0t0        TCP hmaster.domain.local:55062-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  328u     IPv4         2296167772      0t0        TCP hmaster.domain.local:45424-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  329u     IPv4         2296167775      0t0        TCP hmaster.domain.local:55064-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  330u     IPv4         2296167778      0t0        TCP hmaster.domain.local:45426-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  331u     IPv4         2296167782      0t0        TCP hmaster.domain.local:45427-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  332u     IPv4         2296167786      0t0        TCP hmaster.domain.local:54626-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  333u     IPv4         2296167789      0t0        TCP hmaster.domain.local:45429-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  334u     IPv4         2296167791      0t0        TCP hmaster.domain.local:55069-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  335u     IPv4         2296167795      0t0        TCP hmaster.domain.local:45431-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  336u     IPv4         2296198829      0t0        TCP hmaster.domain.local:54964-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  337r     IPv4         2296198838      0t0        TCP hmaster.domain.local:45767-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  338u     IPv4         2296198847      0t0        TCP hmaster.domain.local:55407-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  339u     IPv4         2296198858      0t0        TCP hmaster.domain.local:55408-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  340u     IPv4         2296198867      0t0        TCP hmaster.domain.local:55409-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  341u     IPv4         2296198880      0t0        TCP hmaster.domain.local:55410-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  342u     IPv4         2296198896      0t0        TCP hmaster.domain.local:45772-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  343u     IPv4         2296198956      0t0        TCP hmaster.domain.local:54971-&amp;gt;regionserver-5.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  344u     IPv4         2296198979      0t0        TCP hmaster.domain.local:55413-&amp;gt;regionserver-4.domain.local:50010 (CLOSE_WAIT)
java       793   hbase  345u     IPv4         2296198999      0t0        TCP hmaster.domain.local:45775-&amp;gt;regionserver-6.domain.local:50010 (CLOSE_WAIT)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13993260" author="apurtell" created="Thu, 8 May 2014 23:52:59 +0000"  >&lt;p&gt;CLOSE_WAIT state is entered when the remote has closed the socket (a FIN packet has been sent) but the local socket has not yet been closed. Port 50010 is the default HDFS DataNode data transfer socket (dfs.datanode.address). Perhaps the master&apos;s DFS client is caching sockets for reuse but somehow not expiring the entries / closing the socket. &lt;/p&gt;</comment>
                            <comment id="13993262" author="apurtell" created="Thu, 8 May 2014 23:55:22 +0000"  >&lt;p&gt;Apparently these settings were added to the HBase site configuration by the reporting user without apparent effect:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   &amp;lt;property&amp;gt;
     &amp;lt;name&amp;gt;dfs.client.socketcache.capacity&amp;lt;/name&amp;gt;
     &amp;lt;value&amp;gt;0&amp;lt;/value&amp;gt;
   &amp;lt;/property&amp;gt;
   &amp;lt;property&amp;gt;
     &amp;lt;name&amp;gt;dfs.datanode.socket.reuse.keepalive&amp;lt;/name&amp;gt;
     &amp;lt;value&amp;gt;0&amp;lt;/value&amp;gt;
   &amp;lt;/property&amp;gt;
  &amp;lt;property&amp;gt;
    &amp;lt;name&amp;gt;dfs.client.socketcache.expiryMsec&amp;lt;/name&amp;gt;
    &amp;lt;value&amp;gt;900&amp;lt;/value&amp;gt;
  &amp;lt;/property&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13993264" author="apurtell" created="Thu, 8 May 2014 23:57:03 +0000"  >&lt;p&gt;Assuming all active branches potentially affected.&lt;/p&gt;</comment>
                            <comment id="13993265" author="mbertozzi" created="Fri, 9 May 2014 00:02:30 +0000"  >&lt;p&gt;for snapshot in trunk the problem should be reduced since there are no longer all the file creation per hfile in the table.&lt;br/&gt;
but this is not a snapshot problem, it also happen on the normal read path when we are using pread() see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9393&quot; title=&quot;Hbase does not closing a closed socket resulting in many CLOSE_WAIT &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9393&quot;&gt;HBASE-9393&lt;/a&gt;.&lt;br/&gt;
Also this seems only a problem with hadoop 2.0, which is mitigate by &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4911&quot; title=&quot;Reduce PeerCache timeout to be commensurate with dfs.datanode.socket.reuse.keepalive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4911&quot;&gt;&lt;del&gt;HDFS-4911&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 9 May 2014 00:02:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391532</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vfkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391744</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>