<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:01:01 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2337/HBASE-2337.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2337] log recovery: splitLog deletes old logs prematurely</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2337</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;splitLog()&apos;s purpose is to take a bunch of commit logs of a crashed RS and create per-region logs. splitLog() runs in the master.  There are two cases where splitLog() might end up deleting an old log before actually creating (sync/closing) the newly created logs. If the master crashes in between deletion of the old log and creation of the new log, then edits could be lost irrecoverably.&lt;/p&gt;

&lt;p&gt;More specifically here are the two issues we (Nicolas, Aravind and I) noticed:&lt;/p&gt;

&lt;p&gt;Issue #1: The old logs are read one at a time. An in memory structure, logEntries (a map from region name to edits for the region), is populated. And the old logs are closed. Then the in-memory map is written out to per region files. Fix: We should move the file deletion to later.&lt;/p&gt;

&lt;p&gt;Issue #2: There is another little case. The per-region log file is written under the region directory (named oldlogfile.log or the constant HREGION_OLDLOGFILE_NAME). Before the master creates the file, it checks to see if there is already a file with that name, and if so, it renames it to oldlogfile.log.old, and then creates file oldlogfile.log again, and copies over the contents of oldlogfile.log.old to oldlogfile.log. It then proceeds to delete &quot;oldlogfile.log.old&quot;, even though it hasn&apos;t closed/sync&apos;ed &quot;oldlogfile.log&quot; yet. &lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;I think we should be able to restructure the code such that all deletion of old logs happens &lt;b&gt;after&lt;/b&gt; the new logs have been created (i.e. written to &amp;amp; closed).&lt;/p&gt;





</description>
                <environment></environment>
        <key id="12459405">HBASE-2337</key>
            <summary>log recovery: splitLog deletes old logs prematurely</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nspiegelberg">Nicolas Spiegelberg</assignee>
                                    <reporter username="kannanm">Kannan Muthukkaruppan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Mar 2010 17:25:06 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:25 +0000</updated>
                            <resolved>Tue, 5 Oct 2010 21:11:20 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="12846503" author="stack" created="Wed, 17 Mar 2010 18:07:04 +0000"  >&lt;p&gt;Making it a blocker on 0.20.4.  If ye don&apos;t take it, I will.  As part of this issue perhaps we could get rid of the naming convention used for per-region files: i.e oldlogfile.log and oldlogfile.log.old.  Its the most brain-dead naming that ever I&apos;ve come across.&lt;/p&gt;</comment>
                            <comment id="12849821" author="nspiegelberg" created="Thu, 25 Mar 2010 18:29:55 +0000"  >&lt;p&gt;Important changes&lt;/p&gt;

&lt;p&gt;1. Workflow is now for(steps in logs) &lt;/p&gt;
{ read[n]; write[n]; }
&lt;p&gt; delete(logs);&lt;br/&gt;
2. Don&apos;t worry about oldlogfile recovery, just delete and start over, since logs are deleted last&lt;br/&gt;
3. corrupt logs are (configurably) moved into a special directory for post-mortem analysis&lt;br/&gt;
3. super-paranoid error handling (probably should tune this). in our case, better to stop HMaster than ignore a critical filesystem error.&lt;/p&gt;</comment>
                            <comment id="12849825" author="tlipcon" created="Thu, 25 Mar 2010 18:33:29 +0000"  >&lt;p&gt;Marking related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2363&quot; title=&quot;Add configuration for tunable dataloss sensitivity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2363&quot;&gt;&lt;del&gt;HBASE-2363&lt;/del&gt;&lt;/a&gt; - the &quot;give up or keep going&quot; behavior should be tunable as part of that JIRA (I don&apos;t think you have to make that change now, just adding the link so that when we do that jira we remember to come back to this one)&lt;/p&gt;</comment>
                            <comment id="12849842" author="jdcryans" created="Thu, 25 Mar 2010 18:59:53 +0000"  >&lt;p&gt;Minor nits, some lines you added are over the 80 chars limit (like line 1273) and some statements don&apos;t have a blank before conditions, like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(Path p : finishedFiles) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also I don&apos;t think this comment makes sense since you pass a default value:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-comment&quot;&gt;// store corrupt logs &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; post-mortem analysis (empty string = discard)
&lt;/span&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; corruptDir = 
+      conf.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.regionserver.hlog.splitlog.corrupt.dir&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;.corrupt&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;I&apos;ll try this patch later this afternoon.&lt;/p&gt;</comment>
                            <comment id="12849877" author="nspiegelberg" created="Thu, 25 Mar 2010 20:06:44 +0000"  >&lt;p&gt;@jd I&apos;ll do syntactic cleanups.  I should clarify the comment, however it&apos;s logically accurate.  I wanted to give users the ability to not store corruptions and just delete them.  To that end, if you explicitly set &apos;hbase.regionserver.hlog.splitlog.corrupt.dir&apos; in your configuration to &apos;&apos;, or empty string, it should delete instead of move corruptFiles.  I need to write some unit tests to verify functionality.  Alternate suggestions on handling this?  &lt;/p&gt;</comment>
                            <comment id="12849883" author="jdcryans" created="Thu, 25 Mar 2010 20:19:37 +0000"  >&lt;p&gt;Ah ok I see... seems counter-intuitive tho. Maybe something like hbase.regionserver.hlog.splitlog.archivecorruptedfiles.enabled in addition to the current configuration would help?&lt;/p&gt;</comment>
                            <comment id="12849937" author="jdcryans" created="Thu, 25 Mar 2010 22:40:49 +0000"  >&lt;p&gt;Tested it on a local setup, first did normal kill -9 of a region servers and everything went well. Next run I also killed the master while it was splitting the logs and then restarted the whole thing and Nicolas&apos; patch did its magic. &lt;/p&gt;</comment>
                            <comment id="12849940" author="kannanm" created="Thu, 25 Mar 2010 22:50:30 +0000"  >&lt;p&gt;nice! thanks for the additional testing JD (killing the master while splitting... evil &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="12851292" author="stack" created="Tue, 30 Mar 2010 07:08:35 +0000"  >&lt;p&gt;I applied patch to branch.  Thanks for the nice patch Nicolas (and to J-D for review and test).&lt;/p&gt;

&lt;p&gt;Forward-porting is not easy.  Too much has changed.  I spent some time on it but will put it aside till we are doing 0.21.&lt;/p&gt;</comment>
                            <comment id="12875331" author="stack" created="Thu, 3 Jun 2010 22:33:28 +0000"  >&lt;p&gt;@Nicolas Would you mind taking a look at this?  TRUNK is very different now but looking over your patch the spirit is there in that we&apos;ll not remove files at all now, not immediately at least; instead they are archived.  Does trunk do enough?  (IMO it seems so but would appreciate your opinion boss &amp;#8211; thanks).&lt;/p&gt;</comment>
                            <comment id="12881792" author="clehene" created="Wed, 23 Jun 2010 17:55:45 +0000"  >&lt;p&gt;2437 should fix this for 0.21. Is this patch in 0.20 branch? If so should this issue still be open?&lt;/p&gt;</comment>
                            <comment id="12881794" author="stack" created="Wed, 23 Jun 2010 17:59:30 +0000"  >&lt;p&gt;@Cosmin Yeah, I think this is fixed.  Was just waiting on Nicolas&apos;s OK (He said he&apos;d get to it...).&lt;/p&gt;</comment>
                            <comment id="12881846" author="nspiegelberg" created="Wed, 23 Jun 2010 19:55:27 +0000"  >&lt;p&gt;sorry, I was off on HDFS tasks.  reviewed 1025 yesterday and should get to 2437 soon&lt;/p&gt;</comment>
                            <comment id="12902169" author="jdcryans" created="Tue, 24 Aug 2010 23:54:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2437&quot; title=&quot;Refactor HLog splitLog&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2437&quot;&gt;&lt;del&gt;HBASE-2437&lt;/del&gt;&lt;/a&gt; was committed, can we close this Nicolas?&lt;/p&gt;</comment>
                            <comment id="12902265" author="nspiegelberg" created="Wed, 25 Aug 2010 01:32:35 +0000"  >&lt;p&gt;there are still outstanding issues from the &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2437&quot; title=&quot;Refactor HLog splitLog&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2437&quot;&gt;&lt;del&gt;HBASE-2437&lt;/del&gt;&lt;/a&gt; peer review.  I think this JIRA served as an open placeholder until they were resolved.  Maybe we should just file separate JIRAs?&lt;/p&gt;</comment>
                            <comment id="12918192" author="stack" created="Tue, 5 Oct 2010 21:11:19 +0000"  >&lt;p&gt;Resolving as done.  Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3084&quot; title=&quot;HLog splitLog : Properly Handle User Interrupts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3084&quot;&gt;&lt;del&gt;HBASE-3084&lt;/del&gt;&lt;/a&gt; to take care of Nicolas comments made against hbase-2437 post-commit.&lt;/p&gt;</comment>
                            <comment id="15017245" author="lars_francke" created="Fri, 20 Nov 2015 12:42:25 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12461944">HBASE-2437</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12459921">HBASE-2363</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12472139">HBASE-2933</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12439805" name="HBASE-2337-20.4.patch" size="16004" author="nspiegelberg" created="Thu, 25 Mar 2010 18:29:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 17 Mar 2010 18:07:04 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26264</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hhb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100066</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>