<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:40:15 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6831/HBASE-6831.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6831] [WINDOWS] HBaseTestingUtility.expireSession() does not expire zookeeper session</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6831</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;TestReplicationPeer fails because it forces the zookeeper session expiration by calling HBaseTestingUtilty.expireSesssion(), but that function fails to do so.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12608175">HBASE-6831</key>
            <summary>[WINDOWS] HBaseTestingUtility.expireSession() does not expire zookeeper session</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enis">Enis Soztutar</assignee>
                                    <reporter username="enis">Enis Soztutar</reporter>
                        <labels>
                            <label>windows</label>
                    </labels>
                <created>Wed, 19 Sep 2012 00:29:18 +0000</created>
                <updated>Mon, 23 Sep 2013 18:30:52 +0000</updated>
                            <resolved>Thu, 8 Nov 2012 22:26:41 +0000</resolved>
                                    <version>0.94.3</version>
                    <version>0.95.2</version>
                                    <fixVersion>0.95.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13458329" author="enis" created="Wed, 19 Sep 2012 00:30:46 +0000"  >&lt;p&gt;Upon further inspection the root cause boils down to the following sequence of events.&lt;/p&gt;

&lt;p&gt;HBaseTestingUtility.expireSession() works by getting an already existing Zookeeper object, and obtains sessionId from that. &lt;br/&gt;
Then it constructs another Zookeeper() object with the same sessionId and passwd, and closes that Zookeeper, which in turn triggers server to mark the sessionId as expired. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    ZooKeeper zk = nodeZK.getRecoverableZooKeeper().getZooKeeper();
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] password = zk.getSessionPasswd();
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sessionID = zk.getSessionId();

    ZooKeeper newZK = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeper(quorumServers,
        sessionTimeout, EmptyWatcher.instance, sessionID, password);
    newZK.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The race condition occurs, because Zookeeper() constructor starts the ClientCnxn.SendThread, but does not wait for connection establishment. SendThread.run() does connect to the server if it is not on CLOSING state, and changes the state to be CONNECTING. However, Zookeeper.close() sets the state as CLOSING, sends a closeSession event to server. Thus if we construct Zookeeper() and immediately close it as above, then SendThread.run() and ClientCnxn.close() races, and if close() is run first, then we abort the connection, and do not even try to establish a connection. &lt;/p&gt;

&lt;p&gt;On Windows, the new thread&apos;s execution does not seem to start as fast as linux, so we did not run into this previously.&lt;/p&gt;</comment>
                            <comment id="13458377" author="stack" created="Wed, 19 Sep 2012 03:21:41 +0000"  >&lt;p&gt;This is a good one.  You are uncovering why some tests are sometimes flakey.  So, add in a noop that goes against the server after the construction and before close?&lt;/p&gt;</comment>
                            <comment id="13460904" author="enis" created="Fri, 21 Sep 2012 22:46:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6406&quot; title=&quot;TestReplicationPeer.testResetZooKeeperSession and TestZooKeeper.testClientSessionExpired fail frequently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6406&quot;&gt;&lt;del&gt;HBASE-6406&lt;/del&gt;&lt;/a&gt; removed TestReplicationPeer, but on trunk, TestZooKeeper seems to be flaky because of this on windows. &lt;/p&gt;</comment>
                            <comment id="13460935" author="enis" created="Fri, 21 Sep 2012 23:23:43 +0000"  >&lt;p&gt;Attaching patches for trunk and 0.94&lt;/p&gt;</comment>
                            <comment id="13465023" author="stack" created="Thu, 27 Sep 2012 19:52:40 +0000"  >&lt;p&gt;+1 on commit.  Running by hadoopqa just in case.&lt;/p&gt;</comment>
                            <comment id="13465133" author="hadoopqa" created="Thu, 27 Sep 2012 21:38:29 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12546117/hbase-6831_v1-trunk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12546117/hbase-6831_v1-trunk.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated 140 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 6 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.client.TestFromClientSide&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestSplitLogManager&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2948//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13493561" author="enis" created="Thu, 8 Nov 2012 22:26:41 +0000"  >&lt;p&gt;I&apos;ve committed this. Thanks Stack for review. &lt;/p&gt;</comment>
                            <comment id="13493607" author="hudson" created="Thu, 8 Nov 2012 23:33:01 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #3522 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/3522/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/3522/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6831&quot; title=&quot;[WINDOWS] HBaseTestingUtility.expireSession() does not expire zookeeper session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6831&quot;&gt;&lt;del&gt;HBASE-6831&lt;/del&gt;&lt;/a&gt;. &lt;span class=&quot;error&quot;&gt;&amp;#91;WINDOWS&amp;#93;&lt;/span&gt; HBaseTestingUtility.expireSession() does not expire zookeeper session (Revision 1407300)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
enis : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13493625" author="hudson" created="Fri, 9 Nov 2012 00:01:52 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #253 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/253/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/253/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6831&quot; title=&quot;[WINDOWS] HBaseTestingUtility.expireSession() does not expire zookeeper session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6831&quot;&gt;&lt;del&gt;HBASE-6831&lt;/del&gt;&lt;/a&gt;. &lt;span class=&quot;error&quot;&gt;&amp;#91;WINDOWS&amp;#93;&lt;/span&gt; HBaseTestingUtility.expireSession() does not expire zookeeper session (Revision 1407300)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
enis : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13775163" author="stack" created="Mon, 23 Sep 2013 18:30:52 +0000"  >&lt;p&gt;Marking closed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12608157">HBASE-6817</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12599175">HBASE-6406</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12546116" name="hbase-6831_v1-0.94.patch" size="1714" author="enis" created="Fri, 21 Sep 2012 23:23:43 +0000"/>
                            <attachment id="12546117" name="hbase-6831_v1-trunk.patch" size="1306" author="enis" created="Fri, 21 Sep 2012 23:23:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 19 Sep 2012 03:21:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>239596</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00rin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2390</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>