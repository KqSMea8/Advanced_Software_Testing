<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:26:47 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5330/HBASE-5330.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5330] TestCompactSelection - adding 2 test cases to testCompactionRatio</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5330</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;There were three existing assertions in TestCompactSelection testCompactionRatio that did &quot;max # of files&quot; assertions...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    assertEquals(maxFiles,
        store.compactSelection(sfCreate(7,6,5,4,3,2,1)).getFilesToCompact().size());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... and for references ...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  assertEquals(maxFiles,
        store.compactSelection(sfCreate(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, 7,6,5,4,3,2,1)).getFilesToCompact().size());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... but they didn&apos;t assert against which StoreFiles got selected.  While the number of StoreFiles is the same, the files selected are actually different, and I thought that there should be explicit assertions showing that.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12541120">HBASE-5330</key>
            <summary>TestCompactSelection - adding 2 test cases to testCompactionRatio</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dmeil">Doug Meil</assignee>
                                    <reporter username="dmeil">Doug Meil</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Feb 2012 18:56:10 +0000</created>
                <updated>Fri, 10 Feb 2012 10:26:37 +0000</updated>
                            <resolved>Thu, 9 Feb 2012 18:14:12 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="13199977" author="hadoopqa" created="Fri, 3 Feb 2012 19:43:29 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12513160/TestCompactSelection_hbase_5330.java.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12513160/TestCompactSelection_hbase_5330.java.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -136 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 154 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.io.hfile.TestHFileBlock&lt;br/&gt;
                  org.apache.hadoop.hbase.TestInfoServers&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestZKBasedOpenCloseRegion&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/899//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/899//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/899//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/899//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/899//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/899//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13200311" author="nspiegelberg" created="Sat, 4 Feb 2012 03:12:33 +0000"  >&lt;p&gt;There&apos;s actually more subtle shortcomings that these tests expose.  &lt;/p&gt;

&lt;p&gt;1) The major compaction is treated differently than the reference use case because a major compaction does not require all the files.  A major compaction just requires a contiguous range of the oldest files.  We need to change compactSelection to return whether the operation is a major compaction or not.&lt;/p&gt;

&lt;p&gt;2) The reference use case should not look all all the StoreFiles.  Instead, it should compact range(oldest_reference, newest_reference).&lt;/p&gt;

&lt;p&gt;3) I don&apos;t understand why reference files are &lt;span class=&quot;error&quot;&gt;&amp;#91;5:1&amp;#93;&lt;/span&gt;.  It should be &lt;span class=&quot;error&quot;&gt;&amp;#91;7:3&amp;#93;&lt;/span&gt; like the others.&lt;/p&gt;</comment>
                            <comment id="13200459" author="dmeil" created="Sat, 4 Feb 2012 14:54:18 +0000"  >&lt;p&gt;Thanks Nicholas.  &lt;/p&gt;

&lt;p&gt;I&apos;ll give #1 and #2 a shot.&lt;/p&gt;

&lt;p&gt;Especially for #3, the reason I was adding to the tests in the first place was to describe &quot;what is happening&quot; as opposed to &quot;what should be happening.&quot;  Basically, I want to get a better description of compaction in the book, so I figured that the unit tests were the best place to start.&lt;/p&gt;</comment>
                            <comment id="13200578" author="dmeil" created="Sat, 4 Feb 2012 22:40:57 +0000"  >&lt;p&gt;Hey Nicholas, I initially mis-read this comment &quot;We need to change compactSelection to return whether the operation is a major compaction or not&quot; and now I see what you&apos;re talking about:  there is no &quot;isMajorCompaction&quot; in CompactSelection.&lt;/p&gt;
</comment>
                            <comment id="13201362" author="nspiegelberg" created="Mon, 6 Feb 2012 16:09:14 +0000"  >&lt;p&gt;I spent a little time on this yesterday.  This is correct behavior as written.  Some detail:&lt;br/&gt;
&lt;b&gt;#1&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Change
&lt;/span&gt;compactEquals(store.compactSelection(sfCreate(7,6,5,4,3,2,1)).getFilesToCompact(), 7,6,5,4,3);
&lt;span class=&quot;code-comment&quot;&gt;// TO:
&lt;/span&gt;compactEquals(sfCreate(7, 6, 5, 4, 3, 2, 1), 7, 6, 5, 4, 3);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The original code is doing a compaction, taking the output files, then doing a second compaction on them.  Obviously, this is an identity operation, but is not technically correct since we&apos;re &quot;double compacting&quot;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;#2&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
store.forceMajor = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
compactEquals(sfCreate(7, 6, 5, 4, 3, 2, 1), 7, 6, 5, 4, 3);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Should return &lt;span class=&quot;error&quot;&gt;&amp;#91;3:7&amp;#93;&lt;/span&gt; because it&apos;s NOT actually doing a major compaction.  Currently, the algorithm states that Majors with too many files are downgraded.  This is not really the behavoir we want.  Instead, for a major compaction, we should try to compact storefiles&lt;span class=&quot;error&quot;&gt;&amp;#91;0:N&amp;#93;&lt;/span&gt; where N &amp;gt;= min(minFiles, sizeof(storefiles)).  This will be a little tricky, because the candidate files don&apos;t always contain storefile&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, which is necessary for compaction.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;#3&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Reference compaction
&lt;/span&gt;compactEquals(sfCreate(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, 7, 6, 5, 4, 3, 2, 1), 5, 4, 3, 2, 1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is correct as written, but still needs some improvement.  As I recall, the original reasoning was that we&apos;d only hit this case when we had a bug where we kept flushing storefiles.  We weren&apos;t sure how to handle it at the time (we had prod pressure).  The problem is that we didn&apos;t have the state of previous compactions &amp;amp; we thought we&apos;d have to get the whole candidate set.  The idea was that, if we&apos;re going to recompact the same files multiple times, it should be the smaller files at the end rather than the last file.  Since we only need a shard of the files for major compaction and reference files keep inherent state, we can improve this.&lt;/p&gt;</comment>
                            <comment id="13203754" author="dmeil" created="Wed, 8 Feb 2012 17:15:22 +0000"  >&lt;p&gt;Thanks Nicholas.  Mind if I commit the test after I update with these changes?  &lt;/p&gt;

&lt;p&gt;Regarding, #2 &quot;Should return &lt;span class=&quot;error&quot;&gt;&amp;#91;3:7&amp;#93;&lt;/span&gt; because it&apos;s NOT actually doing a major compaction&quot; this sounds like it should be a separate Jira (bug/improvement), correct? &lt;/p&gt;</comment>
                            <comment id="13204706" author="dmeil" created="Thu, 9 Feb 2012 18:14:13 +0000"  >&lt;p&gt;Committing this update to the unit test&lt;/p&gt;</comment>
                            <comment id="13204902" author="hudson" created="Thu, 9 Feb 2012 21:36:19 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-security #103 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-security/103/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-security/103/&lt;/a&gt;)&lt;br/&gt;
    hbase-5330.  Update to TestCompactSelection unit test for selection SF assertions.&lt;/p&gt;</comment>
                            <comment id="13205337" author="hudson" created="Fri, 10 Feb 2012 10:26:37 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2656 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2656/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2656/&lt;/a&gt;)&lt;br/&gt;
    hbase-5330.  Update to TestCompactSelection unit test for selection SF assertions.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12541160">HBASE-5334</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12513160" name="TestCompactSelection_hbase_5330.java.patch" size="1602" author="dmeil" created="Fri, 3 Feb 2012 18:58:54 +0000"/>
                            <attachment id="12513981" name="TestCompactSelection_hbase_5330_v2.java.patch" size="1738" author="dmeil" created="Thu, 9 Feb 2012 18:12:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 3 Feb 2012 19:43:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>226472</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ht6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101990</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>