<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:16:41 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4191/HBASE-4191.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4191] hbase load balancer needs locality awareness</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4191</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Previously, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4114&quot; title=&quot;Metrics for HFile HDFS block locality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4114&quot;&gt;&lt;del&gt;HBASE-4114&lt;/del&gt;&lt;/a&gt; implements the metrics for HFile HDFS block locality, which provides the HFile level locality information.&lt;br/&gt;
But in order to work with load balancer and region assignment, we need the region level locality information.&lt;/p&gt;

&lt;p&gt;Let&apos;s define the region locality information first, which is almost the same as HFile locality index.&lt;/p&gt;

&lt;p&gt;HRegion locality index (HRegion A, RegionServer B) = &lt;br/&gt;
(Total number of HDFS blocks that can be retrieved locally by the RegionServer B for the HRegion A) / ( Total number of the HDFS blocks for the Region A)&lt;br/&gt;
So the HRegion locality index tells us that how much locality we can get if the HMaster assign the HRegion A to the RegionServer B.&lt;/p&gt;

&lt;p&gt;So there will be 2 steps involved to assign regions based on the locality.&lt;br/&gt;
1) During the cluster start up time, the master will scan the hdfs to calculate the &quot;HRegion locality index&quot; for each pair of HRegion and Region Server. It is pretty expensive to scan the dfs. So we only needs to do this once during the start up time.&lt;/p&gt;

&lt;p&gt;2) During the cluster run time, each region server will update the &quot;HRegion locality index&quot; as metrics periodically as &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4114&quot; title=&quot;Metrics for HFile HDFS block locality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4114&quot;&gt;&lt;del&gt;HBASE-4114&lt;/del&gt;&lt;/a&gt; did. The Region Server can expose them to the Master through ZK, meta table, or just RPC messages. &lt;/p&gt;

&lt;p&gt;Based on the &quot;HRegion locality index&quot;, the assignment manager in the master would have a global knowledge about the region locality distribution and can run the MIN COST MAXIMUM FLOW solver to reach the global optimization.&lt;/p&gt;

&lt;p&gt;Let&apos;s construct the graph first:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;Graph&amp;#93;&lt;/span&gt;&lt;br/&gt;
Imaging there is a bipartite graph and the left side is the set of regions and the right side is the set of region servers.&lt;br/&gt;
There is a source node which links itself to each node in the region set. &lt;br/&gt;
There is a sink node which is linked from each node in the region server set.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Capacity&amp;#93;&lt;/span&gt;&lt;br/&gt;
The capacity between the source node and region nodes is 1.&lt;br/&gt;
And the capacity between the region nodes and region server nodes is also 1.&lt;br/&gt;
(The purpose is each region can ONLY be assigned to one region server at one time)&lt;/p&gt;

&lt;p&gt;The capacity between the region server nodes and sink node are the avg number of regions which should be assigned each region server.&lt;br/&gt;
(The purpose is balance the load for each region server)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Cost&amp;#93;&lt;/span&gt;&lt;br/&gt;
The cost between each region and region server is the opposite of locality index, which means the higher locality is, if region A is assigned to region server B, the lower cost it is.&lt;br/&gt;
The cost function could be more sophisticated when we put more metrics into account.&lt;/p&gt;


&lt;p&gt;So after running the min-cost max flow solver, the master could assign the regions based on the global locality optimization.&lt;/p&gt;

&lt;p&gt;Also the master should share this global view to secondary master in case the master fail over happens.&lt;br/&gt;
In addition, the &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4491&quot; title=&quot;HBase Locality Checker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4491&quot;&gt;&lt;del&gt;HBASE-4491&lt;/del&gt;&lt;/a&gt; (Locality Checker) is the tool, which is based on the same metrics, to proactively to scan dfs to calculate the global locality information in the cluster. It will help us to verify data locality information during the run time.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12518532">HBASE-4191</key>
            <summary>hbase load balancer needs locality awareness</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="liyin">Liyin Tang</assignee>
                                    <reporter username="yuzhihong@gmail.com">Ted Yu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Aug 2011 23:14:48 +0000</created>
                <updated>Fri, 21 Sep 2012 03:16:41 +0000</updated>
                                                                            <component>Balancer</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>22</watches>
                                                                                                            <comments>
                            <comment id="13132200" author="liyin" created="Thu, 20 Oct 2011 23:33:18 +0000"  >&lt;p&gt;Hi Ted, do you have started working on this.&lt;br/&gt;
I have a similar feature to do &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13132206" author="yuzhihong@gmail.com" created="Thu, 20 Oct 2011 23:36:46 +0000"  >&lt;p&gt;@Liyin:&lt;br/&gt;
Go ahead with your implementation.&lt;/p&gt;</comment>
                            <comment id="13134308" author="karthik.ranga" created="Mon, 24 Oct 2011 18:05:58 +0000"  >&lt;p&gt;I think we should also go one step further and store the preferred assignments in a column-family in META. That way, upon restarts the locality is automatically preserved.&lt;/p&gt;</comment>
                            <comment id="13134457" author="yuzhihong@gmail.com" created="Mon, 24 Oct 2011 20:32:40 +0000"  >&lt;p&gt;Currently assignAllUserRegions() reads &quot;hbase.master.startup.retainassign&quot; and if the value is true, balancer.retainAssignment() is called.&lt;br/&gt;
Looks like new config parameter should be introduce, e.g. &quot;hbase.master.startup.policy&quot;, to accommodate the above and future enhancements.&lt;/p&gt;</comment>
                            <comment id="13134497" author="liyin" created="Mon, 24 Oct 2011 21:17:09 +0000"  >&lt;p&gt;I have updated the description of the task for open discussion.&lt;br/&gt;
Any comments are so welcome &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13134516" author="yuzhihong@gmail.com" created="Mon, 24 Oct 2011 21:32:41 +0000"  >&lt;p&gt;I am not sure about the scanning in proposal #1. Master startup should be quick.&lt;/p&gt;

&lt;p&gt;The MAXIMUM FLOW solver is a good fit for HBase Locality Checker. For dynamic load balancing, we may not want to reassign large number of regions which would be disruptive to scanner performance.&lt;/p&gt;

&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4491&quot; title=&quot;HBase Locality Checker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4491&quot;&gt;&lt;del&gt;HBASE-4491&lt;/del&gt;&lt;/a&gt; can be implemented first. Its output can be readily used by master startup.&lt;/p&gt;</comment>
                            <comment id="13134803" author="mikhail" created="Tue, 25 Oct 2011 07:18:20 +0000"  >&lt;p&gt;@Ted: could you please elaborate on how you express the region assignment problem as a Max Flow problem? If we define the &quot;cost&quot; of assigning a region to a server based on locality, and define a constraint of &quot;load balancedness&quot; to be such that each regionserver is assigned no more than approximately ceil(numRegions / numServers) + C regions for some small value of C, then I can see how the problem becomes a min-cost max flow (&lt;a href=&quot;http://en.wikipedia.org/wiki/Minimum_cost_flow_problem&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://en.wikipedia.org/wiki/Minimum_cost_flow_problem&lt;/a&gt;). However, I don&apos;t see how we could reduce the assignment problem to the max-flow problem directly (&lt;a href=&quot;http://en.wikipedia.org/wiki/Maximum_flow_problem&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://en.wikipedia.org/wiki/Maximum_flow_problem&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13135066" author="yuzhihong@gmail.com" created="Tue, 25 Oct 2011 13:53:00 +0000"  >&lt;p&gt;Liyin modified JIRA description and put down max-flow problem.&lt;br/&gt;
Original description didn&apos;t mention it.&lt;/p&gt;</comment>
                            <comment id="13135389" author="liyin" created="Tue, 25 Oct 2011 20:18:27 +0000"  >&lt;p&gt;As Mikhail corrects, the problem should be min cost flow problem instead of max flow problem. I have updated the description to provides more details.&lt;/p&gt;</comment>
                            <comment id="13135395" author="karthik.ranga" created="Tue, 25 Oct 2011 20:22:52 +0000"  >&lt;p&gt;A couple of initial thoughts on things we would need to consider:&lt;/p&gt;

&lt;p&gt;1. I think there should be a weight for node-locality, rack-locality and cross-rack reads while computing the flow.&lt;br/&gt;
2. Also, I think we need one more constraint - we want the final state to have roughly the same number of regions per regionserver (within the slop). So we would need a decision tree or some such.&lt;/p&gt;
</comment>
                            <comment id="13135404" author="yuzhihong@gmail.com" created="Tue, 25 Oct 2011 20:33:00 +0000"  >&lt;p&gt;@Liyin:&lt;br/&gt;
Thanks for formulating the requirement.&lt;br/&gt;
I think the description should be modified after consensus is reached. In the meantime, feel free to make comments in this JIRA.&lt;br/&gt;
I think the following goals may not be achieved at the same time:&lt;br/&gt;
1. maximum (node/rack) locality&lt;br/&gt;
2. the same number of regions on each live region server&lt;br/&gt;
As Karthik said, slop is an important factor in decision making.&lt;/p&gt;</comment>
                            <comment id="13186941" author="sunnygao" created="Mon, 16 Jan 2012 14:28:33 +0000"  >&lt;p&gt;@Liyin&lt;br/&gt;
This is a good feature, How do you process now?&lt;/p&gt;</comment>
                            <comment id="13460131" author="eclark" created="Fri, 21 Sep 2012 02:18:39 +0000"  >&lt;p&gt;It seems like the stochastic load balancer gives HBase the locality awareness when balancing.  &lt;/p&gt;</comment>
                            <comment id="13460158" author="stack" created="Fri, 21 Sep 2012 03:16:41 +0000"  >&lt;p&gt;What you think of Liyin&apos;s costing vs what you have in the Stochastic balancer Elliott (Do you think the HRegion#computeHDFSBlocksDistribution call will happen often?  Seems like its value is cached for a period of time).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12524756">HBASE-4491</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12524346">HBASE-4464</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12503142">HBASE-3724</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="12537086">HBASE-5117</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 20 Oct 2011 23:33:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33415</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hptj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101445</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>