<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:35:08 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6254/HBASE-6254.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6254] deletes w/ many column qualifiers overwhelm Region Server</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6254</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Execution of Deletes constructed with thousands of calls to Delete.deleteColumn(family, qualifier) are very expensive and slow.&lt;/p&gt;

&lt;p&gt;On our (quiet) cluster, a Delete w/ 20k qualifiers took about 13s to complete (as measured by client).&lt;/p&gt;

&lt;p&gt;When 10 such Deletes were sent to the cluster via HTable.delete(List&amp;lt;Delete&amp;gt;), one of RegionServers ended up w/ 5 of the requests and became 100% CPU utilized for about 1 hour.&lt;/p&gt;

&lt;p&gt;This lead to the client timing out after 20min (2min x 10 retries).  In one case, the client was able to fill the RPC callqueue and received the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  Failed all from region=&amp;lt;region&amp;gt;,hostname=&amp;lt;host&amp;gt;, port=&amp;lt;port&amp;gt; java.util.concurrent.ExecutionException: java.io.IOException: Call queue is full, is ipc.server.max.callqueue.size too small?
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Based on feedback (&lt;a href=&quot;http://search-hadoop.com/m/yITsc1WcDWP&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://search-hadoop.com/m/yITsc1WcDWP&lt;/a&gt;), I switched to Delete.deleteColumn(family, qual, timestamp) where timestamp came from KeyValue retrieved from scan based on domain objects.  This version of the delete ran in about 500ms.&lt;/p&gt;

&lt;p&gt;User group thread titled &quot;RS unresponsive after series of deletes&quot; has related logs and stacktraces.  &lt;/p&gt;

&lt;p&gt;Link to thread: &lt;a href=&quot;http://search-hadoop.com/m/RmIyr1WcDWP&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://search-hadoop.com/m/RmIyr1WcDWP&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here is the stack dump of region server: &lt;a href=&quot;http://pastebin.com/8y5x4xU7&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://pastebin.com/8y5x4xU7&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;5 node Cent OS + 1 master, v0.94 on cdh3u3&lt;/p&gt;</environment>
        <key id="12595464">HBASE-6254</key>
            <summary>deletes w/ many column qualifiers overwhelm Region Server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="tstuttle">Ted Tuttle</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Jun 2012 18:11:57 +0000</created>
                <updated>Thu, 21 Jun 2012 18:47:20 +0000</updated>
                                            <version>0.94.0</version>
                                                    <component>Performance</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13398719" author="zhihyu@ebaysf.com" created="Thu, 21 Jun 2012 18:36:42 +0000"  >&lt;p&gt;From HRegion, prepareDeleteTimestamps() performs one get operation per column qualifier:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (KeyValue kv: kvs) {
        &lt;span class=&quot;code-comment&quot;&gt;//  Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; time is LATEST, change to time of most recent addition &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; so
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//  This is expensive.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (kv.isLatestTimestamp() &amp;amp;&amp;amp; kv.isDeleteType()) {
...
          List&amp;lt;KeyValue&amp;gt; result = get(get, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We perform get() for each kv whose time is LATEST.&lt;br/&gt;
This explains the unresponsiveness.&lt;/p&gt;

&lt;p&gt;I think we can group some configurable number of qualifiers in each get and perform classification on result.&lt;br/&gt;
This way we can reduce the number of times HRegion$RegionScannerImpl.next() is called.&lt;/p&gt;</comment>
                            <comment id="13398735" author="zhihyu@ebaysf.com" created="Thu, 21 Jun 2012 18:47:20 +0000"  >&lt;p&gt;Since KeyValue implements HeapSize, we can keep adding column qualifiers until we reach configurable threshold.&lt;br/&gt;
After get(get, false) returns, we can parse out the column qualifiers from result.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 21 Jun 2012 18:36:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241752</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 26 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02can:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11593</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>