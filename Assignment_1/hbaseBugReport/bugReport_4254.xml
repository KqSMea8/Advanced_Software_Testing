<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:17:17 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4254/HBASE-4254.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4254] Get tests passing on Hadoop 23</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4254</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Currently some 30 or so tests are failing on the &quot;HBase-trunk-on-hadoop-23&quot; build. It looks like most are reflection-based issues.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12520133">HBASE-4254</key>
            <summary>Get tests passing on Hadoop 23</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="tlipcon">Todd Lipcon</assignee>
                                    <reporter username="tlipcon">Todd Lipcon</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Aug 2011 18:04:51 +0000</created>
                <updated>Tue, 30 Oct 2012 22:01:52 +0000</updated>
                            <resolved>Tue, 30 Oct 2012 22:01:52 +0000</resolved>
                                    <version>0.92.0</version>
                                    <fixVersion>0.92.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13091260" author="tlipcon" created="Thu, 25 Aug 2011 19:48:28 +0000"  >&lt;p&gt;TestLogRolling.testLogRollOnPipelineRestart is failing due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-2288&quot; title=&quot;Replicas awaiting recovery should return a full visible length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-2288&quot;&gt;&lt;del&gt;HDFS-2288&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13129161" author="yuzhihong@gmail.com" created="Mon, 17 Oct 2011 20:41:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4510&quot; title=&quot;Check and workaround usage of internal HDFS APIs in HBase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4510&quot;&gt;&lt;del&gt;HBASE-4510&lt;/del&gt;&lt;/a&gt; is marked for 0.94&lt;br/&gt;
Moving this issue to 0.94 as well.&lt;/p&gt;</comment>
                            <comment id="13129168" author="tlipcon" created="Mon, 17 Oct 2011 20:47:48 +0000"  >&lt;p&gt;Why move to 0.94? This isn&apos;t marked a blocker, and we should be targeting the 92 branch, even if it doesn&apos;t make it for 0.92.0.&lt;/p&gt;</comment>
                            <comment id="13129178" author="yuzhihong@gmail.com" created="Mon, 17 Oct 2011 20:50:53 +0000"  >&lt;p&gt;Feel free to bring this and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4510&quot; title=&quot;Check and workaround usage of internal HDFS APIs in HBase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4510&quot;&gt;&lt;del&gt;HBASE-4510&lt;/del&gt;&lt;/a&gt; to 0.92, knowing they&apos;re not blockers.&lt;/p&gt;</comment>
                            <comment id="13134623" author="stack" created="Mon, 24 Oct 2011 23:18:41 +0000"  >&lt;p&gt;Knocking this down to major from critical.&lt;/p&gt;</comment>
                            <comment id="13242122" author="gchanan" created="Fri, 30 Mar 2012 07:09:57 +0000"  >&lt;p&gt;I did some playing around with TestLogRolling.testLogRollOnPipelineRestart against 0.23.  It looks like calling recoverLease on the HLog path and waiting awhile before trying to create the reader works.  If you don&apos;t call recoverLease the reader will never succeed.&lt;/p&gt;

&lt;p&gt;Let&apos;s assume, for the sake of argument, that replicas waiting recovery will not return a full visible length.&lt;/p&gt;

&lt;p&gt;1) Are we supposed to have to call recoverLease? (I&apos;m guessing the recovery design doc covers this, I&apos;ll check it out)&lt;br/&gt;
2) Where should we call recoverLease?  Just in the test?  In HLog.createWriter? (it would block for awhile if we actually waited for the recovery)?&lt;/p&gt;</comment>
                            <comment id="13242921" author="gchanan" created="Sat, 31 Mar 2012 01:15:04 +0000"  >&lt;ul&gt;
	&lt;li&gt;Attached &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4254&quot; title=&quot;Get tests passing on Hadoop 23&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4254&quot;&gt;&lt;del&gt;HBASE-4254&lt;/del&gt;&lt;/a&gt;-92.patch*&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;NOTE: I&apos;m not sure if we should commit this, this is just a brainstorm.&lt;/p&gt;

&lt;p&gt;This is a patch for hbase-0.92 that fixes TestLogRolling.testLogRollOnPipelineRestart against hadoop-0.23 while not breaking it against hadoop-1.0.0.  If we want to commit this, I can create patches for trunk/94.&lt;/p&gt;

&lt;p&gt;From my comment:&lt;br/&gt;
1) It sounds like under the current design, we need to call recoverLease to read from the HLog:&lt;/p&gt;

&lt;p&gt;From the recovery design doc (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-2288&quot; title=&quot;Replicas awaiting recovery should return a full visible length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-2288&quot;&gt;&lt;del&gt;HDFS-2288&lt;/del&gt;&lt;/a&gt;):&lt;br/&gt;
&quot;&#8226; Any&#8233; WaitingToBeRecovered&#8233; replica &#8233;does &#8233;not &#8233;serve &#8233;any &#8233;read and&#8233; does &#8233;not participate&#8233; in &#8233;a &#8233;pipeline &#8233;recovery.&lt;br/&gt;
&#8226; A&#8233; WaitingToBeRecovered &#8233;replica &#8233;will&#8233; either &#8233;become &#8233;out dated&#8233; and &#8233;be deleted&#8233; by &#8233;NN &#8233;if &#8233;the &#8233;client &#8233;is &#8233;still &#8233;alive &#8233;or &#8233;be &#8233;changed&#8233; to&#8233; be &#8233;finalized &#8233;as &#8233;a result&#8233; of &#8233;lease&#8233; recovery&#8233; if&#8233; the &#8233;client&#8233; dies&quot;&lt;/p&gt;

&lt;p&gt;This is basically what I&apos;ve done: if we cannot get a reader for the HLog b/c replicas-awaiting-recovery do not return a visible length, recover the lease, wait for it to finish, then retry getting the HLog reader.  (Aside: It would be nice if the exception HDFS returned in this state was clearer than IOException).&lt;/p&gt;

&lt;p&gt;Is this is correct place for this code?  Do we need it everywhere we call HLog.getReader?  Any thoughts?&lt;/p&gt;</comment>
                            <comment id="13242945" author="zhihyu@ebaysf.com" created="Sat, 31 Mar 2012 01:55:45 +0000"  >&lt;p&gt;Interesting idea.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        waitUntilNotUnderConstruction(dfsCluster,p.toUri().getPath());
+        readRowsFromHLog(p,loggedRows);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;How do we know that the second call to readRowsFromHLog() wouldn&apos;t result in IOE ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
+      &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100);
+      blocks = (LocatedBlocks) getBlockLocations.invoke(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,cluster.getNameNode(),testPath,0,1);
+    } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (blocks.isUnderConstruction());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do we need some timeout for the above wait ?&lt;/p&gt;

&lt;p&gt;Once the logic in the patch gets confirmation from various experts (including Todd), we can consider moving it to a better place.&lt;/p&gt;

&lt;p&gt;I would also like to refer to &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-2991&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HDFS-2991&lt;/a&gt; which we encountered in staging environment.&lt;br/&gt;
For 0.23.2-SNAPSHOT, we should have the fix.&lt;/p&gt;</comment>
                            <comment id="13244848" author="stack" created="Mon, 2 Apr 2012 23:46:52 +0000"  >&lt;p&gt;@Gregory&lt;/p&gt;

&lt;p&gt;I see over in FSHDFSUTils that we call recoverLease via reflection currently.  If this fix is for 0.96 where we depend on 1.0.0, we can do as you do and call w/o going via reflection.&lt;/p&gt;

&lt;p&gt;In current code too, it throws AlreadyBeingCreatedException if lease not available.  I suppose new code just doesn&apos;t do that.  In old code, we used just hang around:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; AlreadyBeingCreatedException) {
          &lt;span class=&quot;code-comment&quot;&gt;// We expect that we&apos;ll get &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; message &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; the lease is still
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// within its soft limit, but &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we get it past that, it means
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// that the RS is holding onto the file even though it lost its
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// znode. We could potentially abort after some time here.
&lt;/span&gt;          &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; waitedFor = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() - startWaiting;
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (waitedFor &amp;gt; LEASE_SOFTLIMIT_PERIOD) {
            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Waited &quot;&lt;/span&gt; + waitedFor + &lt;span class=&quot;code-quote&quot;&gt;&quot;ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; lease recovery on &quot;&lt;/span&gt; + p +
              &lt;span class=&quot;code-quote&quot;&gt;&quot;:&quot;&lt;/span&gt; + e.getMessage());
          }

... we&apos;d sleep a second and retry.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The fancy-dancing asking the namenode if blocks are under construction will work for 0.23 only? If the method is not available, we just return immediately w/o pause.  Maybe we should pause some time before going around the loop again.&lt;/p&gt;

&lt;p&gt;On 1., &apos;It sounds like under the current design, we need to call recoverLease to read from the HLog:&apos;  OK.  Seems fair enough given we just restarted the datanodes.&lt;/p&gt;

&lt;p&gt;As to where the code belongs, looks like we have to add it everywhere a getReader on WAL is called (not too many places I&apos;d say) but its weird that the fs semantic changes so much (with previous you could crash out the datanodes and it&apos;d just &apos;work&apos; when you got a new reader but now you have to recover outstanding leases... the old behavior was probably the &apos;wrong&apos; one)&lt;/p&gt;


</comment>
                            <comment id="13244856" author="tlipcon" created="Mon, 2 Apr 2012 23:56:55 +0000"  >&lt;p&gt;I haven&apos;t had time to really dig into this yet &amp;#8211; lots of details to sift through. But I think the idea of calling recoverLease anywhere we read from a WAL isn&apos;t quite right, since it will probably break replication. We read from open WALs in that circumstance, and calling recoverLease under an open file will kill the writer.&lt;/p&gt;</comment>
                            <comment id="13244866" author="stack" created="Tue, 3 Apr 2012 00:07:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;We read from open WALs in that circumstance, and calling recoverLease under an open file will kill the writer.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point.&lt;/p&gt;</comment>
                            <comment id="13487250" author="tlipcon" created="Tue, 30 Oct 2012 21:19:19 +0000"  >&lt;p&gt;This has been subsumed by other JIRAs, right?&lt;/p&gt;</comment>
                            <comment id="13487288" author="stack" created="Tue, 30 Oct 2012 22:01:52 +0000"  >&lt;p&gt;Resolving won&apos;t fix.  We&apos;re more about hadoop2 these times.  We don&apos;t explicitly support 0.23.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12520148">HDFS-2288</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12520188">MAPREDUCE-2884</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12526152">HBASE-4551</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12525138">HBASE-4510</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12554716">HBASE-5984</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12520707" name="HBASE-4254-92.patch" size="3948" author="gchanan" created="Sat, 31 Mar 2012 01:15:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 17 Oct 2011 20:41:32 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27234</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 7 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02dsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11836</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>