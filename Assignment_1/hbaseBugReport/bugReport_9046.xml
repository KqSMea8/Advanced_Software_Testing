<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:00:54 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-9046/HBASE-9046.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-9046] Coprocessors can&apos;t be upgraded in service reliably</title>
                <link>https://issues.apache.org/jira/browse/HBASE-9046</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;My team and another user from the mailing list have run into an issue where replacing the coprocessor jar in HDFS and reloading the table does not load the latest jar. It may load the latest version on some percentage of RS but not all of them.&lt;/p&gt;

&lt;p&gt;This may be a config oversight or a lack of understanding of a caching mechanism that has a purge capability, but I thought I would log it here for confirmation.&lt;/p&gt;

&lt;p&gt;Workaround is to name the coprocessor JAR uniquely, place in HDFS, and re-enable the table using the new jar&apos;s name.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;FreeBSD 8.2-RELEASE FreeBSD 8.2-RELEASE #0 r220198: Thu Mar 31 21:46:45 PDT 2011 amd64&lt;/p&gt;

&lt;p&gt;java version &quot;1.6.0_07&quot;&lt;br/&gt;
Diablo Java(TM) SE Runtime Environment (build 1.6.0_07-b02)&lt;br/&gt;
Diablo Java HotSpot(TM) 64-Bit Server VM (build 10.0-b23, mixed mode)&lt;/p&gt;

&lt;p&gt;hbase: 0.94.8, r1485407&lt;br/&gt;
hadoop: 1.0.4, r1393290&lt;/p&gt;</environment>
        <key id="12660115">HBASE-9046</key>
            <summary>Coprocessors can&apos;t be upgraded in service reliably</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="iainlbc">iain wright</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Jul 2013 18:54:40 +0000</created>
                <updated>Thu, 16 Jan 2014 18:42:41 +0000</updated>
                                            <version>0.94.8</version>
                    <version>0.96.0</version>
                                                    <component>Coprocessors</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13818526" author="tsuna" created="Sun, 10 Nov 2013 19:32:47 +0000"  >&lt;p&gt;I think the problem is that &lt;tt&gt;CoprocessorClassLoader.classLoadersCache&lt;/tt&gt; retains the previous cache loader in its cache.  This is a cache that maps the path of the .jar file to its corresponding &lt;tt&gt;CoprocessorClassLoader&lt;/tt&gt;.  The values in the cache are weak references, but that doesn&apos;t guarantee that they will go away in a timely fashion.  Therefore if you edit the schema of your table to unset the coprocessor and re-set it, most of the time you will get the same &lt;tt&gt;CoprocessorClassLoader&lt;/tt&gt; as before and the new jar won&apos;t be loaded.  I can reproduce this trivially and consistently on a single-node non-distributed HBase instance.&lt;/p&gt;</comment>
                            <comment id="13818530" author="tsuna" created="Sun, 10 Nov 2013 19:52:53 +0000"  >&lt;p&gt;I can further confirm this because in my current environment I use a single coprocessor, so I devised a workaround for this bug: my coprocessor class has a &lt;tt&gt;static int&lt;/tt&gt; I use as a reference count: every time my coprocessor&apos;s &lt;tt&gt;start&lt;/tt&gt; is called, I increment it, and in &lt;tt&gt;stop&lt;/tt&gt; I decrement it.  In &lt;tt&gt;stop&lt;/tt&gt;, when the count drops down to 0, I call &lt;tt&gt;CoprocessorClassLoader.clearCache()&lt;/tt&gt;.  This fixes the problem for me.  This trick doesn&apos;t work for multiple co-processors, because &lt;tt&gt;clearCache()&lt;/tt&gt; would clear everything.&lt;/p&gt;

&lt;p&gt;Also note that &lt;tt&gt;clearCache()&lt;/tt&gt; is only exposed for testing purposes so it&apos;s technically not part of the public API.&lt;/p&gt;

&lt;p&gt;Another workaround I can think of (but haven&apos;t tried) would be to use reflection to access the underlying map and clear out the entry.&lt;/p&gt;

&lt;p&gt;I think the right way to fix this bug is to maintain the reference count manually by doing the increment/decrement from the &lt;tt&gt;startup()&lt;/tt&gt; and &lt;tt&gt;shutdown()&lt;/tt&gt; methods of &lt;tt&gt;CoprocessorHost$Environment&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13833252" author="apurtell" created="Wed, 27 Nov 2013 00:06:26 +0000"  >&lt;p&gt;Unlikely this will make it into 0.98 as there is not a patch available.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12683807">HBASE-10119</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 10 Nov 2013 19:32:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340307</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mozr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340625</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>