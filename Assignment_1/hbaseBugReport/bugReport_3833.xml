<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:13:32 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3833/HBASE-3833.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3833] ability to support includes/excludes list in Hbase</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3833</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;An HBase cluster currently does not have the ability to specify that the master should accept regionservers only from a specified list. This helps preventing administrative errors where the same machine could be included in two clusters. It also allows the administrator to easily remove un-ssh-able machines from the cluster.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12505835">HBASE-3833</key>
            <summary>ability to support includes/excludes list in Hbase</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="dhruba">dhruba borthakur</assignee>
                                    <reporter username="dhruba">dhruba borthakur</reporter>
                        <labels>
                    </labels>
                <created>Sat, 30 Apr 2011 05:53:05 +0000</created>
                <updated>Sat, 21 Jun 2014 03:05:23 +0000</updated>
                                            <version>0.90.2</version>
                                                    <component>Client</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13027529" author="vishal.k" created="Mon, 2 May 2011 02:35:33 +0000"  >&lt;p&gt;Copying comment history from facebook internal task:&lt;/p&gt;


&lt;p&gt;Dhruba Borthakur - at 3:09pm on April 21st&lt;br/&gt;
andrew/matthew: do we need a discussion on how this feature needs to be designed?&lt;/p&gt;

&lt;p&gt;1. There would be two files includes and excludes.&lt;br/&gt;
2. If a  machine is listed in excludes file, it shuts down the regionserver on that machine.&lt;br/&gt;
3. Region servers should start only on machines that are listed in the includes file.&lt;br/&gt;
4. a command line utility to modify/update the excludes/includes file.&lt;/p&gt;


&lt;p&gt;Andrew Ryan - at 3:15pm on April 21st&lt;br/&gt;
We&apos;ve wanted parity from the beginning. So yes, online decommissioning should be supported. I don&apos;t see any reason to do otherwise.&lt;/p&gt;

&lt;p&gt;To Vishal&apos;s question, we wouldn&apos;t allow the node to join and migrate the regions. We just wouldn&apos;t allow it to join. Just shut the regionserver down. But, if a regionserver has active regions when it gets the decommission request, then it should gracefully reassign its regions and then shut down.&lt;/p&gt;


&lt;p&gt;Nicolas Spiegelberg - at 3:20pm on April 21st I think we just want to deny requests and force a regionserver already online to close.  HBase just has a logical association with regions that is given upon onlining, stored in an HDFS file called META.  We save the state across a graceful restart, but will assign out those regions after a small startup period has passed without onlining.  Therefore, we don&apos;t benefit from trying to grab any state from the physical server itself.&lt;/p&gt;


&lt;p&gt;Vishal Kathuria - at 3:28pm on April 21st Thanks guys.&lt;/p&gt;

&lt;p&gt;One question is: &lt;br/&gt;
if I move a server from includes to excludes, should that trigger online decommissioning and shut the machine down when decomissioning is done? or should we kick it out right away?&lt;/p&gt;

&lt;p&gt;I think the former is better. Looks like we are all agreeing on that?&lt;/p&gt;

&lt;p&gt;thanks&lt;/p&gt;






&lt;p&gt;Adrian Potra - at 3:35pm on April 21st&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;changed the subscribers. Removed: Adrian Potra.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Vishal Kathuria - at 3:35pm on April 21st Sorry, I wrote my comment before I read Nicolas&apos;&lt;/p&gt;

&lt;p&gt;I see his point - since the Region Servers don&apos;t have persisted data (which is in HDFS), we don&apos;t loose much by kicking them out.&lt;/p&gt;

&lt;p&gt;sounds reasonable to me.&lt;/p&gt;


&lt;p&gt;Dhruba Borthakur - at 4:37pm on April 21st&lt;br/&gt;
@Nicolas: &quot;but will assign out those regions after a small startup period has passed without onlining&quot;  &amp;#8211; is it possible to avoid the small startup period mentioned above if the RS is decommissioned?&lt;/p&gt;


&lt;p&gt;Nicolas Spiegelberg - at 5:43pm on April 21st&lt;br/&gt;
@Dhruba: agreed.  We should just see what &apos;bin/hbase-daemon.sh stop regionserver&quot; does.  By my comment, I just meant to say that, if need be, we can actually just kick out the connection and do all the work on the master.  As a safeguard either way, we should rename that RS&apos;s log directory (if it exists).  This will forcibly cause the RS to die if something went awry.&lt;/p&gt;
</comment>
                            <comment id="13027530" author="vishal.k" created="Mon, 2 May 2011 02:39:37 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
I have started implementing this and below is a mini-spec. Could you pls look through it and let me know if you have any comments.&lt;/p&gt;

&lt;p&gt;Functionality&lt;br/&gt;
1. The semantics of the include and exclude lists would be identical to Hadoop. If the include list is empty, then universal include set is assumed. exclude list takes precedence over include list.&lt;br/&gt;
2. Adding a node to exclude list + issuing a refresh using the command line utility will trigger ServerManager::expireServer for an already online server. This is the same code path that happens when the node goes down.&lt;br/&gt;
3. Nodes in excludeList (or the nodes which are not in include list) will not be allowed to join. &lt;br/&gt;
4. The list will support hostname:port type of entries, where port is optional. Even though in production we wouldn&apos;t have multiple regionservers per node, I am doing this to make testing easier on dev servers.&lt;/p&gt;

&lt;p&gt;Tools&lt;br/&gt;
For the command line utility, there will be a new command to refresh server list that will be implemented in HBaseAdmin.&lt;br/&gt;
HBaseAdmin will call into a method that will be added to HMaster and HMasterInterface. As mentioned above, if a node is added to excludeList or is removed from include list, it will be expired. If a node is added to the includeList, no action will be taken.&lt;/p&gt;

&lt;p&gt;The command to refresh server list will be exposed in the hbase shell as well.&lt;/p&gt;


&lt;p&gt;Nicolas: &apos;bin/hbase-daemon.sh stop regionserver&apos; kills the region server process. I am proposing that we don&apos;t try to do that. In the scenario that Dhruba mentioned to me, the regionserver node might be sick and we may not be able to kill it.&lt;/p&gt;

&lt;p&gt;Dhruba: Other than the command line utility to refresh the server list, are there any other tools that we need to provide?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13027563" author="dhruba" created="Mon, 2 May 2011 06:34:46 +0000"  >&lt;p&gt;another option would be to maintain the includes-list and excludes-list in zk itself. Instead of local files on the master, they could be zk nodes that contain a list of machine-names. what do people think about that?&lt;/p&gt;</comment>
                            <comment id="13027726" author="jdcryans" created="Mon, 2 May 2011 17:08:36 +0000"  >&lt;p&gt;@Vishal, currently doing stop regionserver is probably not what you want to do in a cluster serving live requests (it closes all connections then closes the regions, meaning regions unavailable for a while). You&apos;d want something more like bin/graceful_stop.sh&lt;/p&gt;

&lt;p&gt;@Dhruba, I think it would be cool to have that in ZK, but I also like having the same semantics as Hadoop. So I&apos;m 0.&lt;/p&gt;</comment>
                            <comment id="13027784" author="tlipcon" created="Mon, 2 May 2011 19:15:25 +0000"  >&lt;p&gt;If going for &quot;same semantics as Hadoop&quot;, we should try to match the semantics of &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-1547&quot; title=&quot;Improve decommission mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-1547&quot;&gt;&lt;del&gt;HDFS-1547&lt;/del&gt;&lt;/a&gt; which adds a new &quot;decom&quot; file, rather than include/exclude. Most ops people I&apos;ve talked to find the include/exclude files super confusing (what does it mean to be both included and excluded, for example?)&lt;/p&gt;</comment>
                            <comment id="13027828" author="dhruba" created="Mon, 2 May 2011 20:37:20 +0000"  >&lt;p&gt;+1 to Todd&apos;s idea of similarity with &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-1547&quot; title=&quot;Improve decommission mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-1547&quot;&gt;&lt;del&gt;HDFS-1547&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13028025" author="vishal.k" created="Tue, 3 May 2011 05:21:04 +0000"  >&lt;p&gt;Patch for the fix.&lt;/p&gt;</comment>
                            <comment id="13028026" author="vishal.k" created="Tue, 3 May 2011 05:27:14 +0000"  >&lt;p&gt;This change also includes the unit tests, which tests the key scenario of adding an online region server to the excludes file and then refreshing the excludes file.&lt;/p&gt;</comment>
                            <comment id="13028053" author="tlipcon" created="Tue, 3 May 2011 06:00:16 +0000"  >&lt;p&gt;I find these include/exclude files just as confusing here in HBase as they&apos;ve always been in Hadoop. Some users are less polite and call them &quot;insane&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Could you please do a favor and fill in the following table?&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Include present &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Exclude present &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; In include &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; In exclude &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Result at startup &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Result after refresh &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; o &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; x &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ? &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ?&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Rather than this very complicated structure, how about a simpler format, something like:&lt;/p&gt;

&lt;p&gt;host.rules:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;regex&amp;gt; (allow|deny)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where we ship a default config that looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.* allow
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13028332" author="stack" created="Tue, 3 May 2011 17:33:32 +0000"  >&lt;p&gt;Vishal:  What Todd says.  Here&apos;s some comments on the patch itself.  Licenses should be 2011 FYI.  Tabs are two spaces in hbase/hadoop (You seem to have more).  It looks like you are crashing out the regionserver and on master running the expireServer.  That means that the ShutdownServer handler runs.  It&apos;ll take care of assigning out the regions that were on the crashed server but because this is a crash-out, we&apos;ll also be playing the regionserver&apos;s logs.  Do you want to add facility for having a regionserver shed its regions and then close clean so there are no regionserver WAL logs to replay?  (Its ok if you don&apos;t, just suggesting).&lt;/p&gt;

&lt;p&gt;This is intentional?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-        $command $startStop &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt; &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;$logout&quot;&lt;/span&gt; 2&amp;gt;&amp;amp;1 &amp;lt; /dev/&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;
+        $command &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt; $startStop &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;$logout&quot;&lt;/span&gt; 2&amp;gt;&amp;amp;1 &amp;lt; /dev/&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Otherwise patch looks good Vishal. &lt;/p&gt;</comment>
                            <comment id="13028643" author="dhruba" created="Wed, 4 May 2011 06:56:36 +0000"  >&lt;p&gt;Patch looks good at first sight. I would like the regions to close elegantly, so that log replay is not required when those regions are instantiated on other regionservers. If you can do that enhancement, that will be great.&lt;/p&gt;

&lt;p&gt;I am fine with the includes/excludes/decommission list (instead of Todd&apos;s regex solution), especially because HBase administrators are usually the same as the hdfs administrators; unless Todd feels strongly about it.  &lt;/p&gt;</comment>
                            <comment id="13028652" author="tlipcon" created="Wed, 4 May 2011 07:28:02 +0000"  >&lt;p&gt;I&apos;m OK with the separate files approach as long as we have clear documentation about what the different combinations mean. In the table above there are a few obvious cells and a lot that are unclear.&lt;/p&gt;</comment>
                            <comment id="13028655" author="dhruba" created="Wed, 4 May 2011 07:32:39 +0000"  >&lt;p&gt;Thanks Todd. I agree that Vishal can help in filling up the table. Is there a hbase admin guide that needs to be updated too?&lt;/p&gt;</comment>
                            <comment id="13028782" author="stack" created="Wed, 4 May 2011 15:03:10 +0000"  >&lt;p&gt;There is a &apos;Configuration&apos; section in the book: &lt;a href=&quot;http://hbase.apache.org/book/configuration.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hbase.apache.org/book/configuration.html&lt;/a&gt;  Vishal, you can add doc. there or just dump a paragraph or two in here and on commit we&apos;ll port it over.  Thanks.&lt;/p&gt;</comment>
                            <comment id="13028900" author="vishal.k" created="Wed, 4 May 2011 19:15:05 +0000"  >&lt;p&gt;Thank you for the comments folks. I wasn&apos;t aware of &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-1547&quot; title=&quot;Improve decommission mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-1547&quot;&gt;&lt;del&gt;HDFS-1547&lt;/del&gt;&lt;/a&gt; - I just looked through it.&lt;/p&gt;

&lt;p&gt;Here are my thoughts&lt;br/&gt;
1. Agree with doing a graceful shutdown of the region server that is being excluded.&lt;br/&gt;
2. I would like to hear from folks regarding what they think of storing these files in zk. Heck, why shouldn&apos;t we store the entire config in zk and the only config you need is the address of the zk cluster?&lt;br/&gt;
3. Regarding the name, I will change the file to decom instead of exclude for consistency with HDFS. One difference with 1547 is that 1547 leaves those nodes up and I am shutting them down. I don&apos;t see the value of keeping those nodes up so I will stay with that unless you folks think otherwise.&lt;br/&gt;
4. Re Todd&apos;s suggestion on the truth table, is it okay if I publish the boolean expression in the documentation. I have an easier time inferring the intuition from a boolean expression than a truth table.&lt;br/&gt;
5. stack: I will update the licenses to 2011 and look at the spaces again. My intent was to use 2 but I may have missed some places.&lt;br/&gt;
6. The change in .sh file is intentional, otherwise the script for starting the local region server was not working. I need to make sure the change doesn&apos;t break any of the other scripts. I will verify that.&lt;/p&gt;

&lt;p&gt;Thanks again folks.&lt;br/&gt;
Vishal &lt;/p&gt;</comment>
                            <comment id="13028911" author="stack" created="Wed, 4 May 2011 19:34:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;2. I would like to hear from folks regarding what they think of storing these files in zk. Heck, why shouldn&apos;t we store the entire config in zk and the only config you need is the address of the zk cluster?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, long time plan is to put all config. up in zk.  Would suggest though that that is out of scope for this issue and that if your aim is to have this feature work like hadoop&apos;s, you not move the includes/excludes there, at least, not as part of this issue.&lt;/p&gt;

&lt;p&gt;Otherwise all else is good.  Good on you Vishal.&lt;/p&gt;</comment>
                            <comment id="13028984" author="dhruba" created="Wed, 4 May 2011 21:36:51 +0000"  >&lt;p&gt;agree with stack. let&apos;s nove any of these configs to zk (as part of this jira).&lt;/p&gt;</comment>
                            <comment id="13028985" author="dhruba" created="Wed, 4 May 2011 21:37:23 +0000"  >&lt;p&gt;I meant &quot;let&apos;s not move any of these configs to zk&quot;.&lt;/p&gt;</comment>
                            <comment id="13028993" author="vishal.k" created="Wed, 4 May 2011 21:52:12 +0000"  >&lt;p&gt;stack: A quick question. I looked at region_mover.rb and I was wondering why this was implemented in ruby as a script and not in the master. Since I do the parsing of the decom file in the master, I would need to call out from master to the ruby script, which doesn&apos;t sound like such a good idea. Secondly, if we improve the load balancing policy from just random to something like load based, the ruby script would not be able to take advantage of it since random is hard coded in it. &lt;/p&gt;

&lt;p&gt;Here is what I think we should ideally do:&lt;br/&gt;
1. Refactor the code in AssignmentManager/ServerShutdown handler to expose a function that takes all the regions off a node.&lt;br/&gt;
2. Use the above function for decommissioning, failure handling and the unload admin commands so we get similar behavior and single implementation across the three.&lt;/p&gt;

&lt;p&gt;What do you guys think?&lt;/p&gt;

&lt;p&gt;dhruba:&lt;br/&gt;
Agreed: I will leave the configs as is for this jira. I assume the config files need to live on some NFS share so they are available when the master fails over - is that so?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13029048" author="stack" created="Wed, 4 May 2011 23:35:23 +0000"  >&lt;p&gt;It was done in ruby because I wanted a graceful_restart that worked with the shipping version of hbase, I did not want to require users update to get a working decommission.  The ruby script will be discarded when hbase can do what it does natively.  Its a stop gap.&lt;/p&gt;

&lt;p&gt;Don&apos;t call out to the ruby script (smile).  On the other hand, it has had some exercise and has had some experience frozen into it so is worth a little bit of study if reimplementing up in the master.&lt;/p&gt;

&lt;p&gt;+1 on your 1. and 2.  I would encourage you to add bits of general functionality that can be exploited by master or others in future silly ruby scripts.&lt;/p&gt;

&lt;p&gt;Good on you Vishal&lt;/p&gt;</comment>
                            <comment id="13035000" author="vishal.k" created="Tue, 17 May 2011 19:43:39 +0000"  >&lt;p&gt;Sorry for the radio silence on this issue folks. I have updated the patch with the comments. The biggest change is that now we wait for the region servers to be reassigned before adding the node to expire server list (which will trigger node shutdown).&lt;/p&gt;

&lt;p&gt;Please let me know if you have any further comments. &lt;/p&gt;

&lt;p&gt;Also, let me know if we need to have some sort of timeout and if the region servers aren&apos;t migrated within that timeout, then we kill the region server anyway. I got this suggestion from Karthik, but wanted to see what other folks think before implementing it.&lt;/p&gt;
</comment>
                            <comment id="13035565" author="stack" created="Wed, 18 May 2011 18:37:24 +0000"  >&lt;p&gt;On timeout and then kill, if Karthik suggested it, then it must be a good idea (smile).&lt;/p&gt;

&lt;p&gt;No biggie but FYI and for next time, style is to put spaces around operators; not &quot;(int i=0;i&amp;lt;3;i+&lt;ins&gt;)&quot; but &quot;(int i = 0; i &amp;lt; 3; i&lt;/ins&gt;+)&quot;&lt;/p&gt;

&lt;p&gt;This is bad, no?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+      BufferedWriter out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedWriter(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileWriter(exFilePath));
+      out.write(info.getHostnamePort());
+      out.close();
+    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you fail to write the excludes file, the test will fail anyways?  Just let out the IOE?&lt;/p&gt;

&lt;p&gt;Here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i&amp;lt;3;i++) {
+    	&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(2000);
+    	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!cluster.getMaster().getServerManager().getOnlineServersList().contains(info));
+    	&lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You already have a three minute timeout on the test so this wait of six seconds is probably not needed... just loop till it happens OR until junit intercedes and kills the thing because its going on too long.&lt;/p&gt;

&lt;p&gt;Again, none of the above are that important... more for the next time.&lt;/p&gt;

&lt;p&gt;Just to note that NodeDecommissionedException is very close to the YouAreDeadException.  Even so, I think it a good idea to add it.&lt;/p&gt;

&lt;p&gt;This patch is for TRUNK?  HServerInfo is deprecated.  Do you want to use that?&lt;/p&gt;

&lt;p&gt;Nice. You added refreshNodes to the shell.&lt;/p&gt;

&lt;p&gt;I&apos;m not clear on how a decommissioned node, once added to the excludes, is cleared of its regions.  Did I miss it?&lt;/p&gt;

&lt;p&gt;Thanks Vishal.&lt;/p&gt;

</comment>
                            <comment id="13035655" author="vishal.k" created="Wed, 18 May 2011 20:41:12 +0000"  >&lt;p&gt;Thanks for the review and the suggestions stack. &lt;/p&gt;

&lt;p&gt;I didn&apos;t know about the JUNit test timeout - you are right, I don&apos;t need to do limit the loop.&lt;/p&gt;

&lt;p&gt;Regarding destination for the patch - I&apos;ll follow up with dhruba to figure out the desired destination and make appropriate changes to remove the deprecated stuff. &lt;/p&gt;

&lt;p&gt;&quot;I&apos;m not clear on how a decommissioned node, once added to the excludes, is cleared of its regions. Did I miss it?&quot;&lt;br/&gt;
When the node list is refreshed and a node shows up in the decommissioned list, ServerManager::refreshNodes() calls ServerManager::decommissionServer(serverInfo) to start the decomissioning process.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Vishal&lt;/p&gt;
</comment>
                            <comment id="13035670" author="stack" created="Wed, 18 May 2011 21:05:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Regarding destination for the patch - I&apos;ll follow up with dhruba to figure out the desired destination and make appropriate changes to remove the deprecated stuff.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;NP.  Looks like this patch is for branch.  Thats fine.  I can hack it into TRUNK for you if needs be.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;...ServerManager::refreshNodes() calls ServerManager::decommissionServer(serverInfo)...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I see.  So we just crash the server down and let the shutdown process do the reassign of regions.  I was looking for gentle offload of regions.  Thats not here.  Thats fine.  I just thought it was.&lt;/p&gt;

&lt;p&gt;Let me know if you are going to update patch.  If you are, I&apos;ll wait, else will try hack this in (if its working for you!)&lt;/p&gt;</comment>
                            <comment id="13035840" author="vishal.k" created="Wed, 18 May 2011 23:09:21 +0000"  >&lt;p&gt;Hi stack,&lt;/p&gt;

&lt;p&gt;Here is some more info on the design &lt;br/&gt;
ServerManager::decommissionServer(serverInfo) f&lt;br/&gt;
1. first puts the node in decommissioned list so no new regions get placed on this node. decommissioned list prevents a node with that name from joining in but doesn&apos;t kick the node out if it is already joined in.&lt;br/&gt;
2. enqueues a shutdownhandler to move all the regions off this node&lt;br/&gt;
3. once the shutdown handler is done doing that, then it marks the node dead. It is only at this point that the region server gets a YouAreDeadException and shuts itself down. &lt;/p&gt;

&lt;p&gt;So this is supposed to do gentle offload of regions. That&apos;s why I had to put a wait in my test because the gentle offload can take some time. &lt;br/&gt;
I did check in the debug logs that the regions are offloaded before the server gets shut down - so its working for me.  Please go ahead and hack this in &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Re Karthik&apos;s suggestion of timeout, I&apos;ll open a separate task for it. Off the top of my head, I can&apos;t think of a simple way of implementing it&lt;/p&gt;

&lt;p&gt;Thanks a lot for reviewing and committing this change!&lt;br/&gt;
Vishal&lt;/p&gt;</comment>
                            <comment id="13035859" author="stack" created="Wed, 18 May 2011 23:45:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;2. enqueues a shutdownhandler to move all the regions off this node&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ServerShutdownHandler splits logs and reassigns regions that were (or &lt;b&gt;are&lt;/b&gt; in the decommissioning case) up on the shutdown server.  It does not unload them off the hosting regionserver.  So, it looks to me as though regions can be in two places at once... still on the server that has been marked decommissioned and up in the new locations that ServerShutdownHandler has assigned them too.  This looks a little dangerous (if I am reading this right).&lt;/p&gt;

&lt;p&gt;If decommissioning, it looks like you expire the server only at the end of the server shutdown processing (your call to markServerExpiry will be noticed by the hosting regionserver and it&apos;ll shut itself down closing out the regions it was hosting).&lt;/p&gt;

&lt;p&gt;New JIRA for Karthiks suggestion sounds good.&lt;/p&gt;</comment>
                            <comment id="13035883" author="yuzhihong@gmail.com" created="Thu, 19 May 2011 00:18:34 +0000"  >&lt;p&gt;Looking through ServerShutdownHandler, I found this code in process():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// Assign root and meta &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we were carrying them.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isCarryingRoot()) { &lt;span class=&quot;code-comment&quot;&gt;// -ROOT-&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isCarryingRoot() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Same with &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isCarryingMeta()) &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.services.getAssignmentManager().assignMeta();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13037791" author="dhruba" created="Mon, 23 May 2011 08:18:40 +0000"  >&lt;p&gt;There are actually two use-cases that triggered this JIRA.&lt;/p&gt;

&lt;p&gt;1. There are times when the adminstrator wants to shut down a few region servers, usually to upgrade hardware or some such reason. In this case, the administrator can put these machines in the excludes list, wait for those region servers to gracefully shutdown.&lt;/p&gt;

&lt;p&gt;2. The other use-case is when certain region servers become unresponsive. Twice it so happened that a regionserver is heartbeating with ZK, but its capability to process hbase workload suddenly fell to almost zero. We could not ssh into the machine to debug what is wrong. (The suspicion is that the machine started swapping). In this case, it would be nice if the administrator had an option to put a machine in the excludes list, wait for a few minutes for it to gracefully exit, but if it still does not exit, then forcefully declare the regionserver as &quot;dead&quot;.&lt;/p&gt;

&lt;p&gt;In short, maybe we need a &quot;force&quot; option in decommissioning, which if used, does not wait for a graceful shutdown of the specified regionserver, instead declares it dead immediately and then follows the normal course of action (lease recovery, reassign regions, etc)&lt;/p&gt;
</comment>
                            <comment id="13038067" author="stack" created="Mon, 23 May 2011 17:20:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;In short, maybe we need a &quot;force&quot; option in decommissioning, which if used, does not wait for a graceful shutdown of the specified regionserver, instead declares it dead immediately and then follows the normal course of action (lease recovery, reassign regions, etc)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.  Seems like this patch does the &apos;forced&apos; option.  Missing from this patch (though available as a script) is the graceful decommission.  Vishal, were you going for the &apos;forced&apos; option only?  If so, should we commit this patch as is (though I think it dangerous if misunderstood and user is not clear that excludes means &apos;forced&apos; decommission).&lt;/p&gt;</comment>
                            <comment id="13038342" author="dhruba" created="Tue, 24 May 2011 01:04:12 +0000"  >&lt;p&gt;It will be nice to get both &quot;forced&quot; and &quot;graceful&quot; decommissioning to this jira, is Vishal agrees.&lt;/p&gt;</comment>
                            <comment id="13038364" author="vishal.k" created="Tue, 24 May 2011 03:04:32 +0000"  >&lt;p&gt;Stack:&lt;br/&gt;
My intention was build a graceful shutdown (that is the reason I assign the regions first and then expire the server). I assumed that assign* API unloads them off the source region server when assigning them to the new region server, but I guess I was wrong in that assumption. Let me take a look at the code again to see how I can change it to make the shutdown graceful and not have the situation you mentioned of two servers owning the region - that is clearly not desirable.&lt;/p&gt;

&lt;p&gt;Yuzhi:&lt;br/&gt;
In case any of the meta regions are involved, then the MetaServerShutdownHandler is dispatched. That class has both  isCarryingRoot() and isCarryingMeta() defined.&lt;/p&gt;

&lt;p&gt;I will publish another patch in a couple of days. Stack, please hold on to hacking this in. &lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Vishal&lt;/p&gt;</comment>
                            <comment id="13107191" author="stack" created="Sat, 17 Sep 2011 18:08:11 +0000"  >&lt;p&gt;@Vishal Any luck w/ hacking up another patch?&lt;/p&gt;</comment>
                            <comment id="13108236" author="vishal.k" created="Mon, 19 Sep 2011 23:35:40 +0000"  >&lt;p&gt;@Stack: I started on another project, so didn&apos;t get a chance to put the patch together. I have been meaning to get back to it. Will try to shoot for it this week.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13113062" author="dhruba" created="Fri, 23 Sep 2011 00:32:38 +0000"  >&lt;p&gt;Not ready yet.&lt;/p&gt;</comment>
                            <comment id="13120541" author="vishal.k" created="Tue, 4 Oct 2011 22:37:32 +0000"  >&lt;p&gt;I fell sick last week and then got busy with a conference. I should be getting back to this soon.&lt;/p&gt;</comment>
                            <comment id="14039663" author="mnikhil" created="Sat, 21 Jun 2014 03:05:23 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I was wondering if there is any activity/interest on this jira since the last update. I faced a situation in my cluster where in the existing regionserver machine had to be reip&apos;d, and due to which the master started behaving after the machine was added back with a new ip.The hase master had to be restarted to come out of the weird situation (not sure about it but the regions could not move or assign onto the slave with a new ip). I wondered if I could just have avoided the master restart with an exclude file pointing to the old ip of the regionserver.&lt;/p&gt;

&lt;p&gt;Nikhil&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12520723">HBASE-4298</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12479496" name="ASF.LICENSE.NOT.GRANTED--excl-patch.txt" size="28706" author="vishal.k" created="Tue, 17 May 2011 19:43:38 +0000"/>
                            <attachment id="12478028" name="excl-patch.txt" size="18760" author="vishal.k" created="Tue, 3 May 2011 05:21:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 2 May 2011 02:35:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3512</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02ehz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11950</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>This change adds support for includes and excludes list in HBase. To use it, specify the following properties in the hbase configuration file:&lt;br/&gt;
hbase.hosts - for the includes file&lt;br/&gt;
hbase.hosts.exclude - for the excludes file&lt;br/&gt;
&lt;br/&gt;
Both the files are optional. If the includes file is missing, any node is allowed (except the ones in the exclude file)&lt;br/&gt;
&lt;br/&gt;
If the includes file is present, then a node has to be present in the includes file and absent from the excludes file, to be able to successfully join.&lt;br/&gt;
&lt;br/&gt;
These files can be changed when the server is running. After changing these files, you can use the hbase console to issue &amp;#39;refresh_nodes&amp;#39; command for the master to pick up the new config.&lt;br/&gt;
&lt;br/&gt;
If an online region server is added to the excludes file, &amp;#39;refresh_nodes&amp;#39; will kick it out, with a specific exception. When the region server gets that exception, it shuts itself down.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>