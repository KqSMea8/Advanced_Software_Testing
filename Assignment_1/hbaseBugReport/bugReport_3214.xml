<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:08:19 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3214/HBASE-3214.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3214] TestMasterFailover.testMasterFailoverWithMockedRITOnDeadRS is failing</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3214</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Failing on hudson and locally&lt;/p&gt;</description>
                <environment></environment>
        <key id="12479551">HBASE-3214</key>
            <summary>TestMasterFailover.testMasterFailoverWithMockedRITOnDeadRS is failing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ghelmling">Gary Helmling</assignee>
                                    <reporter username="streamy">Jonathan Gray</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Nov 2010 02:05:38 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:30 +0000</updated>
                            <resolved>Thu, 11 Nov 2010 02:07:07 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                    <component>test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12930441" author="streamy" created="Wed, 10 Nov 2010 02:11:23 +0000"  >&lt;p&gt;This is what I see locally as the failure:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-11-09 18:07:17,291 FATAL [Master:0;172.24.154.154:56721] master.HMaster(888): Unhandled exception. Starting shutdown.
java.lang.RuntimeException: Failed exists test on hdfs://localhost:56643/user/jgray/.logs
	at org.apache.hadoop.hbase.master.MasterFileSystem.splitLogAfterStartup(MasterFileSystem.java:162)
	at org.apache.hadoop.hbase.master.HMaster.finishInitialization(HMaster.java:374)
	at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:272)
	at java.lang.Thread.run(Thread.java:680)
Caused by: java.io.IOException: Filesystem closed
	at org.apache.hadoop.hdfs.DFSClient.checkOpen(DFSClient.java:232)
	at org.apache.hadoop.hdfs.DFSClient.getFileInfo(DFSClient.java:623)
	at org.apache.hadoop.hdfs.DistributedFileSystem.getFileStatus(DistributedFileSystem.java:453)
	at org.apache.hadoop.fs.FileSystem.exists(FileSystem.java:648)
	at org.apache.hadoop.hbase.master.MasterFileSystem.splitLogAfterStartup(MasterFileSystem.java:158)
	... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Somehow DFS is being closed.  No idea why this is happening now but wasn&apos;t before.&lt;/p&gt;

&lt;p&gt;Shortly before this exception, I see this log line:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-11-09 18:07:12,413 INFO  [Shutdown of DFS[DFSClient[clientName=DFSClient_hb_rs_172.24.154.154,56663,1289354815892_1289354817252, ugi=jgray.hfs.1,supergroup]]] hbase.MiniHBaseCluster$SingleFileSystemShutdownThread(248): Hook closing fs=DFS[DFSClient[clientName=DFSClient_hb_rs_172.24.154.154,56663,1289354815892_1289354817252, ugi=jgray.hfs.1,supergroup]]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks like an RS exiting is now triggering a complete shutdown of DFS.&lt;/p&gt;

&lt;p&gt;If I comment out the below line in MiniHBaseCluster line 189, the test passes.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      this.shutdownThread = new SingleFileSystemShutdownThread(getFileSystem());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What has changed?  In unit tests, if RS is being shut down, should not take the entire FS with it?&lt;/p&gt;</comment>
                            <comment id="12930445" author="streamy" created="Wed, 10 Nov 2010 02:19:00 +0000"  >&lt;p&gt;Looks like this was broken with commit of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3194&quot; title=&quot;HBase should run on both secure and vanilla versions of Hadoop 0.20&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3194&quot;&gt;&lt;del&gt;HBASE-3194&lt;/del&gt;&lt;/a&gt; (hbase should run on secure + vanilla hadoop)&lt;/p&gt;</comment>
                            <comment id="12930446" author="streamy" created="Wed, 10 Nov 2010 02:20:38 +0000"  >&lt;p&gt;Also, TestRollingRestart is timing out on hudson but passes locally.  If it times out seems like we can&apos;t access the output logs on hudson?&lt;/p&gt;</comment>
                            <comment id="12930447" author="streamy" created="Wed, 10 Nov 2010 02:22:09 +0000"  >&lt;p&gt;And I&apos;m seeing loads of this &quot;Shutdown of DFS&quot; in my passing TestRollingRestart, so doesn&apos;t seem like it always breaks tests but for some reason it&apos;s now causing breakage in TestMasterFailover?&lt;/p&gt;</comment>
                            <comment id="12930450" author="streamy" created="Wed, 10 Nov 2010 02:31:48 +0000"  >&lt;p&gt;Well, I kind of lied.  Looks like I&apos;m still getting loads of &quot;Filesystem closed&quot; exceptions in TestRollingRestart even when it passes but they are doing shutdown handling of RSs and we don&apos;t abort anything we just can&apos;t do log replay (which is not necessary in this test).&lt;/p&gt;

&lt;p&gt;So definitely something fishy with commit of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3194&quot; title=&quot;HBase should run on both secure and vanilla versions of Hadoop 0.20&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3194&quot;&gt;&lt;del&gt;HBASE-3194&lt;/del&gt;&lt;/a&gt; and unit tests / aborting RS bringing down DFS underneath running unit test cluster / master.&lt;/p&gt;</comment>
                            <comment id="12930455" author="ghelmling" created="Wed, 10 Nov 2010 02:53:08 +0000"  >&lt;p&gt;Looking into it.  Possibly something not accounted for in the changes to MiniHBaseCluster.&lt;/p&gt;</comment>
                            <comment id="12930482" author="ghelmling" created="Wed, 10 Nov 2010 05:07:47 +0000"  >&lt;p&gt;Okay, this is the result of an interaction between instance caching in FileSystem.get() based on Configuration contents, and the change to MiniHBaseCluster.MiniHBaseClusterRegionServer to not call HBaseTestingUtility.setDifferentUser() in the constructor.  As a result, the MiniHBaseCluster.conf instance is being modified with the new hadoop.job.ugi entry when each RS is started, and it is this configuration which is picked up when a new master is started at TestMasterFailover, line 801.  Since the contents of the configuration are the same, it picks up the FileSystem instance that was closed by the shutdown hook in the &quot;dead&quot; RS.&lt;/p&gt;

&lt;p&gt;I&apos;ll post a fix as soon as I&apos;ve run it through the full test suite locally.&lt;/p&gt;</comment>
                            <comment id="12930624" author="ghelmling" created="Wed, 10 Nov 2010 15:28:40 +0000"  >&lt;p&gt;Here&apos;s a patch that fixes TestMasterFailover for me.  This may also explain the  &quot;FileSystem closed&quot; errors showing up in TestRollingRestart, but that&apos;s hard to confirm if it&apos;s just failing up in hudson.  It does fix the &quot;FileSystem closed&quot; error that was aborting the master restart in TestMasterFailover.&lt;/p&gt;

&lt;p&gt;With this fix, all tests pass locally for me.  But while testing, I did see intermittent failures of &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hbase.replication.TestReplication.queueFailover()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s not clear to me that this is the same issue though, and the failures weren&apos;t consistent.  So I don&apos;t think we should hold up this fix for it.&lt;/p&gt;
</comment>
                            <comment id="12930625" author="ghelmling" created="Wed, 10 Nov 2010 15:31:29 +0000"  >&lt;p&gt;Same attachment as previously, but selecting the correct &quot;Attachment license&quot; option this time.  Sorry for the noise.&lt;/p&gt;</comment>
                            <comment id="12930678" author="streamy" created="Wed, 10 Nov 2010 17:56:42 +0000"  >&lt;p&gt;Thanks for the patch, Gary.  I just committed to trunk.  Let&apos;s make sure Hudson passes before closing this out.&lt;/p&gt;</comment>
                            <comment id="12930682" author="streamy" created="Wed, 10 Nov 2010 18:02:45 +0000"  >&lt;p&gt;btw, tests are passing locally w/ this patch.&lt;/p&gt;</comment>
                            <comment id="12930796" author="ghelmling" created="Wed, 10 Nov 2010 21:38:58 +0000"  >&lt;p&gt;Looks like TestMasterFailover.testMasterFailoverWithMockedRITOnDeadRS is still failing up on hudson with this patch.  But now at least it&apos;s an assertion failure instead of a timeout:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: 
	at org.junit.Assert.fail(Assert.java:91)
	at org.junit.Assert.assertTrue(Assert.java:43)
	at org.junit.Assert.assertFalse(Assert.java:68)
	at org.junit.Assert.assertFalse(Assert.java:79)
	at org.apache.hadoop.hbase.master.TestMasterFailover.testMasterFailoverWithMockedRITOnDeadRS(TestMasterFailover.java:855)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.internal.runners.statements.FailOnTimeout$1.run(FailOnTimeout.java:28)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is down in the check that regions are offline:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// Everything that should be offline should not be online
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (HRegionInfo hri : regionsThatShouldBeOffline) {
      assertFalse(onlineRegions.contains(hri));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The strange thing is that not only does this pass for me locally, it also passes in our internal hudson build of trunk.&lt;/p&gt;</comment>
                            <comment id="12930895" author="streamy" created="Thu, 11 Nov 2010 02:07:07 +0000"  >&lt;p&gt;Passed on latest hudson build.  Will open new jiras if anything new crops up.&lt;/p&gt;</comment>
                            <comment id="15016732" author="lars_francke" created="Fri, 20 Nov 2015 12:40:30 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12459248" name="HBASE-3214.patch" size="6192" author="ghelmling" created="Wed, 10 Nov 2010 15:31:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 10 Nov 2010 02:53:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26716</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hl8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100702</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>