<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:46:02 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7468/HBASE-7468.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7468] TestSplitTransactionOnCluster hangs frequently</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7468</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;This what I saw once in a local build.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
        at org.apache.hadoop.hbase.client.HBaseAdmin.disableTable(HBaseAdmin.java:831)
        at org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster.testShouldClearRITWhenNodeFoundInSplittingState(TestSplitTransactionOnCluster.java:650)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12625548">HBASE-7468</key>
            <summary>TestSplitTransactionOnCluster hangs frequently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ram_krish">ramkrishna.s.vasudevan</assignee>
                                    <reporter username="lhofhansl">Lars Hofhansl</reporter>
                        <labels>
                    </labels>
                <created>Mon, 31 Dec 2012 03:23:33 +0000</created>
                <updated>Sat, 16 Feb 2013 04:14:23 +0000</updated>
                            <resolved>Mon, 14 Jan 2013 19:05:33 +0000</resolved>
                                    <version>0.94.3</version>
                                    <fixVersion>0.94.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13541244" author="lhofhansl" created="Mon, 31 Dec 2012 03:39:49 +0000"  >&lt;p&gt;With the defaults HBaseAdmin.disableTable can close to an hour.&lt;/p&gt;</comment>
                            <comment id="13541248" author="ram_krish" created="Mon, 31 Dec 2012 03:55:52 +0000"  >&lt;p&gt;Lars may be i can check this out.  But am currently out of station. Can i check this out on wednesday if the time permits?&lt;br/&gt;
I see you have spent good amount of your time on this. So thought i can help you out on this.&lt;/p&gt;</comment>
                            <comment id="13541251" author="lhofhansl" created="Mon, 31 Dec 2012 04:00:39 +0000"  >&lt;p&gt;Thanks Ram, that would be awesome!&lt;br/&gt;
Interestingly the code where it hangs is here.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (admin.isTableAvailable(tableName) &amp;amp;&amp;amp; admin.isTableEnabled(tableName)) {
--&amp;gt;     admin.disableTable(tableName);
        admin.deleteTable(tableName);
        admin.close();
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the table is available and enabled.&lt;/p&gt;</comment>
                            <comment id="13541259" author="apurtell" created="Mon, 31 Dec 2012 04:23:57 +0000"  >&lt;p&gt;I&apos;ve seen this in jstacks too recently, hanging in disableTable. There appear to be both active open and close handlers in the master going on at the same time. Like Ram I&apos;m not in a position to dig in until next week.&lt;/p&gt;</comment>
                            <comment id="13541261" author="apurtell" created="Mon, 31 Dec 2012 04:27:02 +0000"  >&lt;p&gt;With a 0.94 branch updated this morning, this is the result of running TestSplitTransactionOnCluster locally:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Tests run: 11, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 110.065 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
testShouldClearRITWhenNodeFoundInSplittingState(org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster)  Time elapsed: 3.722 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError
	at org.junit.Assert.fail(Assert.java:92)
	at org.junit.Assert.assertTrue(Assert.java:43)
	at org.junit.Assert.assertFalse(Assert.java:68)
	at org.junit.Assert.assertFalse(Assert.java:79)
	at org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster.testShouldClearRITWhenNodeFoundInSplittingState(TestSplitTransactionOnCluster.java:627)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:616)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:45)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:42)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:47)
	at org.junit.rules.RunRules.evaluate(RunRules.java:18)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:263)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:68)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:47)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:231)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:60)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:229)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:50)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:222)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:30)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:300)
	at org.apache.maven.surefire.junit4.JUnit4TestSet.execute(JUnit4TestSet.java:53)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:123)
	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:104)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:616)
	at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:164)
	at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:110)
	at org.apache.maven.surefire.booter.SurefireStarter.invokeProvider(SurefireStarter.java:175)
	at org.apache.maven.surefire.booter.SurefireStarter.runSuitesInProcessWhenForked(SurefireStarter.java:81)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:68)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13541274" author="yuzhihong@gmail.com" created="Mon, 31 Dec 2012 05:00:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;There appear to be both active open and close handlers in the master going on at the same time&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Let me guess: open handler for daughter region, close handler for parent ?&lt;/p&gt;</comment>
                            <comment id="13541282" author="lhofhansl" created="Mon, 31 Dec 2012 05:17:56 +0000"  >&lt;p&gt;I&apos;ve seen this in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7432&quot; title=&quot;TestHBaseFsck prevents testsuite from finishing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7432&quot;&gt;&lt;del&gt;HBASE-7432&lt;/del&gt;&lt;/a&gt;. It turned out the the new MasterObserver code (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7331&quot; title=&quot;Add access control for region open and close, row locking, and stopping the regionserver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7331&quot;&gt;&lt;del&gt;HBASE-7331&lt;/del&gt;&lt;/a&gt;) was missing a null check. But that is since fixed (and it happened 100% of the time).&lt;/p&gt;

&lt;p&gt;I also only observed the hang above once.&lt;/p&gt;</comment>
                            <comment id="13541292" author="lhofhansl" created="Mon, 31 Dec 2012 06:09:47 +0000"  >&lt;p&gt;Just ran it in a loop and after 10 attempts (or so) it happened again:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; prio=10 tid=0x00007ff480008000 nid=0x69ee waiting on condition [0x00007ff
487e9b000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
        at org.apache.hadoop.hbase.client.HBaseAdmin.disableTable(HBaseAdmin.jav
a:831)
        at org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster.te
stShouldClearRITWhenNodeFoundInSplittingState(TestSplitTransactionOnCluster.java
:650)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Will attach the fill jstack.&lt;/p&gt;</comment>
                            <comment id="13541297" author="lhofhansl" created="Mon, 31 Dec 2012 06:28:58 +0000"  >&lt;p&gt;This is the other interesting part:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;MASTER_TABLE_OPERATIONS-bunnypig,53142,1356935902274-0&quot;&lt;/span&gt; prio=10 tid=0x00007ff44403c800 nid=0x7004 waiting on condition [0x00007ff46be6d000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
	at org.apache.hadoop.hbase.master.handler.DisableTableHandler$BulkDisabler.waitUntilDone(DisableTableHandler.java:171)
	at org.apache.hadoop.hbase.master.BulkAssigner.bulkAssign(BulkAssigner.java:105)
	at org.apache.hadoop.hbase.master.BulkAssigner.bulkAssign(BulkAssigner.java:79)
	at org.apache.hadoop.hbase.master.handler.DisableTableHandler.handleDisableTable(DisableTableHandler.java:124)
	at org.apache.hadoop.hbase.master.handler.DisableTableHandler.process(DisableTableHandler.java:98)
	at org.apache.hadoop.hbase.executor.EventHandler.run(EventHandler.java:169)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13541299" author="yuzhihong@gmail.com" created="Mon, 31 Dec 2012 06:31:43 +0000"  >&lt;p&gt;I checked open region handler threads. They were all waiting with stack similar to the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
  at sun.misc.Unsafe.park(Native Method)
  - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000007ec7f14a0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
  at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
  at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)
  at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13542244" author="ram_krish" created="Wed, 2 Jan 2013 17:24:09 +0000"  >&lt;p&gt;Any logs possible when this happened.  I am not able to reproduce this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13542326" author="lhofhansl" created="Wed, 2 Jan 2013 19:30:33 +0000"  >&lt;p&gt;It happens when I run TestSplitTransactionOnCluster in a loop, after a dozen times or so.&lt;br/&gt;
I&apos;ll try to reproduce later today.&lt;/p&gt;</comment>
                            <comment id="13545268" author="lhofhansl" created="Sun, 6 Jan 2013 01:46:45 +0000"  >&lt;p&gt;another case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1301&quot;&lt;/span&gt; prio=10 tid=0x00007f19f0b41000 nid=0x1794 waiting on condition [0x
00007f19d8e3d000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
        at org.apache.hadoop.hbase.client.HBaseAdmin.createTable(HBaseAdmin.java
:446)
        at org.apache.hadoop.hbase.client.HBaseAdmin.createTable(HBaseAdmin.java
:335)
        at org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster.testShouldFailSplitIfZNodeDoesNotExistDueToPrevRollBack(TestSplitTransactionOnCluster.java:666)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13545269" author="lhofhansl" created="Sun, 6 Jan 2013 01:47:44 +0000"  >&lt;p&gt;To reproduce a failing scenario I just run the test in a loop like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; mvn test -PlocalTests -Dtest=TestSplitTransactionOnCluster | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;BUILD SUCCESS&quot;&lt;/span&gt;; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; echo &lt;span class=&quot;code-quote&quot;&gt;&quot;OK&quot;&lt;/span&gt;; done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13545643" author="lhofhansl" created="Mon, 7 Jan 2013 05:24:58 +0000"  >&lt;p&gt;Just produced this again. jstack and the test-output.&lt;/p&gt;</comment>
                            <comment id="13546084" author="ram_krish" created="Mon, 7 Jan 2013 17:40:53 +0000"  >&lt;p&gt;Thanks Lars.  I will look into this tomorrow and see if i can find something.  Good on you.&lt;/p&gt;</comment>
                            <comment id="13548752" author="ram_krish" created="Wed, 9 Jan 2013 18:00:18 +0000"  >&lt;p&gt;Started with this.  What i  could see is that the testShouldClearRITWhenNodeFoundInSplittingState() has failed to delete the znode on rollback of SPLIT. So this has made the disable not to happen due to this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-01-06 21:49:33,509 DEBUG [bunnypig,36944,1357537761566-org.apache.hadoop.hbase.master.handler.DisableTableHandler$BulkDisabler-0] master.AssignmentManager(2063): /hbase/unassigned/5f308eaff51750dae5c8327ad015a20a is SPLIT or SPLITTING; skipping unassign because region no longer exists -- its split 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Also some of the other testcases need some clean up.  Will investigate further and keep posted.  But that is for tomorrow.  Hope to close this off sooner and make it run fine.&lt;/p&gt;</comment>
                            <comment id="13549789" author="ram_krish" created="Thu, 10 Jan 2013 16:57:11 +0000"  >&lt;p&gt;So found the reason.  As stated in the above comment after rollback we need to delete the znode.  Only after the znode deletion happens it is possible to remove from RIT.  Only then the disable will be successful. &lt;br/&gt;
In the previous commit, the infinite loops were removed and changed to finite loops.  So basically here the &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
       assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;region is still in transition&quot;&lt;/span&gt;,
            am.getRegionsInTransition().containsKey(regions.get(0).getRegionInfo().getEncodedName()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;assertion has failed and it has tried to disable the table which did not happen.  &lt;br/&gt;
But in the output file attached by Lars the thing is the node deleted event never happened at all and i doubt it is because of the session expiry error that has come just after the rollback&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-01-06 21:49:35,500 WARN  [Master:0;bunnypig,51009,1357537755267-EventThread] zookeeper.ZKUtil(423): hconnection-0x13c138da85b0019 Unable to set watcher on znode /hbase/master
org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /hbase/master
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:127)
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
	at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1041)
	at org.apache.hadoop.hbase.zookeeper.RecoverableZooKeeper.exists(RecoverableZooKeeper.java:172)
	at org.apache.hadoop.hbase.zookeeper.ZKUtil.watchAndCheckExists(ZKUtil.java:414)
	at org.apache.hadoop.hbase.zookeeper.ZooKeeperNodeTracker.nodeDeleted(ZooKeeperNodeTracker.java:188)
	at org.apache.hadoop.hbase.zookeeper.ZooKeeperWatcher.process(ZooKeeperWatcher.java:301)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So my suggestion would be we need to wait till the RIT is removed for the SPLITTING znode that happens thro AM.nodeDeleted().  And we should introdue a timeout for the test which is missing.  The same testcase does not exist in Trunk.&lt;br/&gt;
@Lars&lt;br/&gt;
Pls provide your thoughts.&lt;/p&gt;</comment>
                            <comment id="13549831" author="stack" created="Thu, 10 Jan 2013 17:43:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;...we need to wait till the RIT is removed for the SPLITTING znode...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Or can we just block until it is removed (with a timeout on the test) rather than have a timer?  Will it get removed if we wait long enough?  Why is it taking a while?&lt;/p&gt;

&lt;p&gt;Why is this test not in trunk, do you know Ram?&lt;/p&gt;

&lt;p&gt;Thanks for taking a looksee.&lt;/p&gt;</comment>
                            <comment id="13549835" author="ram_krish" created="Thu, 10 Jan 2013 17:50:06 +0000"  >&lt;p&gt;The way RIT is populated for SPLITTING in 0.94 is not there in trunk after the AM related changes.  &lt;br/&gt;
The logs does not clearly tell the reason why is it taking a while but currently the testcase waits for 2 sec for it to happen.&lt;/p&gt;

&lt;p&gt;Waiting should remove the znode i feel.  Need to run the tests repeatedly to see if there is any other reason for it.&lt;/p&gt;</comment>
                            <comment id="13550925" author="lhofhansl" created="Fri, 11 Jan 2013 07:31:42 +0000"  >&lt;p&gt;Are you saying we should put the infinite timeouts back? These hangs did happens before I removed them (in an attempt to pinpoint where it actually hangs).&lt;/p&gt;

&lt;p&gt;Is this a split racing with a disable of the table?&lt;br/&gt;
It seems like the main problem is disabling the table in a finally clause, which would try to disable it even when some of the assertions fail.&lt;br/&gt;
We could just remove the try/finally and cleanup the table only after successful test execution... At least that would not hide the problem as it does now.&lt;/p&gt;</comment>
                            <comment id="13551653" author="lhofhansl" created="Fri, 11 Jan 2013 23:46:25 +0000"  >&lt;p&gt;I think the first step should be to remove the try/finally blocks for disabling the tables. In most cases that just hides the problem.&lt;/p&gt;</comment>
                            <comment id="13551820" author="lhofhansl" created="Sat, 12 Jan 2013 05:56:46 +0000"  >&lt;p&gt;Here&apos;s a 0.94 patch that exactly that.&lt;/p&gt;</comment>
                            <comment id="13551824" author="ram_krish" created="Sat, 12 Jan 2013 06:18:53 +0000"  >&lt;p&gt;Ok Lars.  This is fine.  +1.  &lt;br/&gt;
We will see if this helps us out.  &lt;/p&gt;</comment>
                            <comment id="13551826" author="lhofhansl" created="Sat, 12 Jan 2013 06:29:04 +0000"  >&lt;p&gt;Do you think we should also wait longer to for the split to happen?&lt;/p&gt;</comment>
                            <comment id="13551829" author="lhofhansl" created="Sat, 12 Jan 2013 06:30:58 +0000"  >&lt;p&gt;Right now it wait for 2s for the SPLITTING znode to be removed. Could wait up to 20s instead.&lt;/p&gt;</comment>
                            <comment id="13551834" author="lhofhansl" created="Sat, 12 Jan 2013 06:44:17 +0000"  >&lt;p&gt;Indeed when I run the test in a loop now, I see the assertion fail that Ram mentioned.&lt;br/&gt;
I increased the timeout and am running the test in a loop again.&lt;/p&gt;</comment>
                            <comment id="13551843" author="lhofhansl" created="Sat, 12 Jan 2013 07:15:37 +0000"  >&lt;p&gt;Increased the timeout to 20s.&lt;br/&gt;
Have been running the test in a loop now for 40min, did not fail once - before this was easily reproducible after a few minutes.&lt;br/&gt;
I am going to commit this (with the timeout for a SPLIT increased to 20s).&lt;/p&gt;</comment>
                            <comment id="13551847" author="lhofhansl" created="Sat, 12 Jan 2013 07:26:46 +0000"  >&lt;p&gt;Sorry for the span, after 50mins or so I saw another failure. This time it failed here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;region is not in transition&quot;&lt;/span&gt;,
          am.getRegionsInTransition().containsKey(regions.get(0).getRegionInfo().getEncodedName()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The wait here was also only 2s, I increased that to 20s. Let&apos;s see what happens.&lt;/p&gt;</comment>
                            <comment id="13551856" author="lhofhansl" created="Sat, 12 Jan 2013 07:55:41 +0000"  >&lt;p&gt;The 2nd increase did not help. Times out after 20s now.&lt;/p&gt;</comment>
                            <comment id="13551860" author="lhofhansl" created="Sat, 12 Jan 2013 08:38:19 +0000"  >&lt;p&gt;Same patch with timeout increased.&lt;/p&gt;</comment>
                            <comment id="13551861" author="ram_krish" created="Sat, 12 Jan 2013 08:47:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;&lt;br/&gt;
If the test fails once again with timeout increased, pls attach the logs.  Am not able to run the testcases as i don have an env with me.&lt;br/&gt;
I will debug and fix the issue. Lets see if there is a problem with the split and disable scenario also.  Thanks Lars.  Appreciate your time.&lt;/p&gt;</comment>
                            <comment id="13552086" author="lhofhansl" created="Sat, 12 Jan 2013 22:45:08 +0000"  >&lt;p&gt;Here&apos;s the log of the failing test, which failed here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
testShouldClearRITWhenNodeFoundInSplittingState(org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster)  Time elapsed: 3.19 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError: region is not in transition
        at org.junit.Assert.fail(Assert.java:93)
        at org.junit.Assert.assertTrue(Assert.java:43)
        at org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster.testShouldClearRITWhenNodeFoundInSplittingState(TestSplitTransactionOnCluster.java:630)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13552165" author="ram_krish" created="Sun, 13 Jan 2013 10:55:09 +0000"  >&lt;p&gt;Increased the timeout before &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;region is not in transition&quot;&lt;/span&gt;,
          am.getRegionsInTransition().containsKey(regions.get(0).getRegionInfo().getEncodedName()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here too we should have sufficient timeout.  Because only after transitioning the znode to SPLITTING we will get the callback.  That may take some time.&lt;/p&gt;</comment>
                            <comment id="13552304" author="lhofhansl" created="Sun, 13 Jan 2013 20:39:28 +0000"  >&lt;p&gt;As per my comment above I tried that. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;br/&gt;
Did not help unfortunately. I set that timeout to 20s, and it would still happen.&lt;/p&gt;</comment>
                            <comment id="13552318" author="lhofhansl" created="Sun, 13 Jan 2013 21:22:13 +0000"  >&lt;p&gt;In one test run I actually got a session expired from the Master&apos;s ZK watcher.&lt;/p&gt;</comment>
                            <comment id="13552327" author="lhofhansl" created="Sun, 13 Jan 2013 21:55:09 +0000"  >&lt;p&gt;Here&apos;s a failed run with the timeout increased to 20s.&lt;br/&gt;
Something it seems is preventing the node from being set.&lt;br/&gt;
(I tried with 40s timeout as well, as saw the same problem as well).&lt;/p&gt;</comment>
                            <comment id="13552328" author="lhofhansl" created="Sun, 13 Jan 2013 21:56:23 +0000"  >&lt;p&gt;Slightly improved patch that also fixes another problem where we did not give the ZK watcher enough time to learn of the change.&lt;/p&gt;</comment>
                            <comment id="13552451" author="lhofhansl" created="Mon, 14 Jan 2013 05:58:12 +0000"  >&lt;p&gt;This test is quite a bit different in trunk (why is that?)&lt;br/&gt;
Removing the 0.96 target.&lt;/p&gt;</comment>
                            <comment id="13552452" author="lhofhansl" created="Mon, 14 Jan 2013 06:02:55 +0000"  >&lt;p&gt;One more log, this time with the ZK expired exception I was mentioning.&lt;br/&gt;
Interestingly, if I loop testShouldClearRITWhenNodeFoundInSplittingState by itself, I can run it forever and it won&apos;t fail (well after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7550&quot; title=&quot;Synchronization problem in AssignmentManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7550&quot;&gt;&lt;del&gt;HBASE-7550&lt;/del&gt;&lt;/a&gt; that is).&lt;br/&gt;
So this failure has some relation to the other tests running either previously or concurrently.&lt;/p&gt;</comment>
                            <comment id="13552453" author="lhofhansl" created="Mon, 14 Jan 2013 06:04:30 +0000"  >&lt;p&gt;In any case, the attached patch will turn hanging tests into proper assertion failures, and also make failures less likely. So I am going to commit this to 0.94.&lt;br/&gt;
Then we can investigate further why the assert mentioned above fails sometimes.&lt;/p&gt;</comment>
                            <comment id="13552454" author="ram_krish" created="Mon, 14 Jan 2013 06:08:52 +0000"  >&lt;p&gt;The output log file that you have attached on 7th Jan is the full log i suppose.  There you can see a ZK expiry log coming.  &lt;br/&gt;
Will look into it once again.  &lt;/p&gt;</comment>
                            <comment id="13552465" author="lhofhansl" created="Mon, 14 Jan 2013 07:01:18 +0000"  >&lt;p&gt;Thanks Ram.&lt;/p&gt;

&lt;p&gt;Should we close this issue (since the hangs are now gone) and continue with the specific failures in another jira?&lt;/p&gt;</comment>
                            <comment id="13552479" author="hudson" created="Mon, 14 Jan 2013 07:43:57 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #729 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/729/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/729/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7468&quot; title=&quot;TestSplitTransactionOnCluster hangs frequently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7468&quot;&gt;&lt;del&gt;HBASE-7468&lt;/del&gt;&lt;/a&gt; TestSplitTransactionOnCluster hangs frequently (Revision 1432808)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransactionOnCluster.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13552539" author="ram_krish" created="Mon, 14 Jan 2013 09:54:33 +0000"  >&lt;p&gt;I got the issue.  I am able to reproduce this&lt;br/&gt;
See the logs&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-01-14 14:37:21,760 INFO  [main] regionserver.SplitTransaction(216): Starting split of region testShouldClearRITWhenNodeFoundInSplittingState,,1358154439514.a9e57d09c58b3ef3b949d602232fb2c2.

2013-01-14 14:37:21,760 DEBUG [main] regionserver.SplitTransaction(871): regionserver:61665-0x13c384e4e4f0002 Creating ephemeral node &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a9e57d09c58b3ef3b949d602232fb2c2 in SPLITTING state

2013-01-14 14:37:21,844 DEBUG [main] zookeeper.ZKAssign(757): regionserver:61665-0x13c384e4e4f0002 Attempting to transition node a9e57d09c58b3ef3b949d602232fb2c2 from RS_ZK_REGION_SPLITTING to RS_ZK_REGION_SPLITTING

2013-01-14 14:37:21,849 DEBUG [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-873-EventThread] zookeeper.ZooKeeperWatcher(277): master:62334-0x13c384e4e4f001b Received ZooKeeper Event, type=NodeChildrenChanged, state=SyncConnected, path=/hbase/unassigned

2013-01-14 14:37:21,853 DEBUG [main] zookeeper.ZKUtil(1565): regionserver:61665-0x13c384e4e4f0002 Retrieved 140 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;(s) of data from znode /hbase/unassigned/a9e57d09c58b3ef3b949d602232fb2c2; data=region=testShouldClearRITWhenNodeFoundInSplittingState,,1358154439514.a9e57d09c58b3ef3b949d602232fb2c2., origin=Ram.Home,61665,1358154325430, state=RS_ZK_REGION_SPLITTING

2013-01-14 14:37:21,918 DEBUG [main] zookeeper.ZKAssign(820): regionserver:61665-0x13c384e4e4f0002 Successfully transitioned node a9e57d09c58b3ef3b949d602232fb2c2 from RS_ZK_REGION_SPLITTING to RS_ZK_REGION_SPLITTING

2013-01-14 14:37:21,919 DEBUG [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-873-EventThread] zookeeper.ZKUtil(417): master:62334-0x13c384e4e4f001b Set watcher on existing znode /hbase/unassigned/a9e57d09c58b3ef3b949d602232fb2c2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here we can observe that the SPLITTING node was first created.  Then we transit it to SPLITTING to SPLITTING so that AM can have the nodeDataChange event. But for the nodeDataChange event to happen first nodeChildrenChange event should happen so that the master can set a watcher on the node.&lt;/p&gt;

&lt;p&gt;Now when this hang happens, we can see that after the transition happens only then the watcher is set by nodeChildrenChange event and so the SPLITTING to SPLITTING event itself is missed or skipped.  &lt;/p&gt;</comment>
                            <comment id="13552542" author="ram_krish" created="Mon, 14 Jan 2013 09:58:15 +0000"  >&lt;p&gt;Ideally the nodeChildrenChange event iterates thro the list of new znodes on the /hbase/assignment nodes.  And then creates a watcher on that.  One reason could be there are more than one znode and so the watch setting operation takes time.  The order of execution is different when we try running from eclipse and when we run mvn tests.  &lt;br/&gt;
My conclusion is that the testcase actually reveals the problem but the same can happen in any case where the SPLITTING event can get missed out.  May be some of the SPLIT related bugs that were raised is due to this? Need to analyse.&lt;/p&gt;

&lt;p&gt;Any suggestions welcome.  We should ensure that the transition from SPLITTING to SPLITTING should happen only after the master has set the watch on the znode and we should be sure of that.&lt;/p&gt;</comment>
                            <comment id="13552546" author="ram_krish" created="Mon, 14 Jan 2013 10:02:18 +0000"  >&lt;p&gt;Raised &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7551&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-7551&lt;/a&gt;.&lt;br/&gt;
We can close this and work on the new one Lars.  Thanks.&lt;/p&gt;</comment>
                            <comment id="13554235" author="hudson" created="Tue, 15 Jan 2013 19:40:20 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #95 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/95/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/95/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7468&quot; title=&quot;TestSplitTransactionOnCluster hangs frequently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7468&quot;&gt;&lt;del&gt;HBASE-7468&lt;/del&gt;&lt;/a&gt; TestSplitTransactionOnCluster hangs frequently (Revision 1432808)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransactionOnCluster.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13570986" author="hudson" created="Tue, 5 Feb 2013 03:58:27 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security-on-Hadoop-23 #11 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/11/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/11/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7468&quot; title=&quot;TestSplitTransactionOnCluster hangs frequently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7468&quot;&gt;&lt;del&gt;HBASE-7468&lt;/del&gt;&lt;/a&gt; TestSplitTransactionOnCluster hangs frequently (Revision 1432808)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransactionOnCluster.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12564563" name="7468-0.94-v2.txt" size="10888" author="lhofhansl" created="Sat, 12 Jan 2013 08:38:19 +0000"/>
                            <attachment id="12564637" name="7468-0.94-v4.txt" size="11258" author="lhofhansl" created="Sun, 13 Jan 2013 21:56:23 +0000"/>
                            <attachment id="12564556" name="7468-0.94.txt" size="10887" author="lhofhansl" created="Sat, 12 Jan 2013 05:56:46 +0000"/>
                            <attachment id="12563519" name="7468-jstack.txt" size="176892" author="lhofhansl" created="Mon, 7 Jan 2013 05:24:58 +0000"/>
                            <attachment id="12563520" name="7468-output.zip" size="104196" author="lhofhansl" created="Mon, 7 Jan 2013 05:24:58 +0000"/>
                            <attachment id="12564608" name="HBASE-7468v3.patch" size="12325" author="ram_krish" created="Sun, 13 Jan 2013 10:53:48 +0000"/>
                            <attachment id="12564664" name="TEST-org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster.xml" size="32206" author="lhofhansl" created="Mon, 14 Jan 2013 06:02:55 +0000"/>
                            <attachment id="12564636" name="TEST-org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster.xml" size="29124" author="lhofhansl" created="Sun, 13 Jan 2013 21:55:09 +0000"/>
                            <attachment id="12564597" name="TEST-org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster.xml" size="28955" author="lhofhansl" created="Sat, 12 Jan 2013 22:45:08 +0000"/>
                            <attachment id="12562760" name="TestSplitTransactionOnCluster-jstack.txt" size="175997" author="lhofhansl" created="Mon, 31 Dec 2012 06:12:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 31 Dec 2012 03:55:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>302092</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16yjz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248733</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>