<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:55:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-14729/HBASE-14729.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-14729] SplitLogManager does not clean files from WALs folder in case of master failover</title>
                <link>https://issues.apache.org/jira/browse/HBASE-14729</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;While i was testing master failover process on master branch (distributed cluster setup) i notice following:&lt;br/&gt;
1. List of dead regionservers was increasing every time active master was restarted.&lt;br/&gt;
2. Number of folders in /hbase/WALs folder was increasing every time active master was restarted&lt;/p&gt;

&lt;p&gt;Here is exception from master logs showing why this is happening:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2015-10-30 09:41:49,238 INFO  [ProcedureExecutor-3] master.SplitLogManager: finished splitting (more than or equal to) 0 bytes in 0 log files in [hdfs:&lt;span class=&quot;code-comment&quot;&gt;//P3cluster/hbase/WALs/hnode1,16000,1446043659224-splitting] in 21ms
&lt;/span&gt;2015-10-30 09:41:49,235 WARN  [ProcedureExecutor-2] master.SplitLogManager: Returning success without actually splitting and deleting all the log files in path hdfs:&lt;span class=&quot;code-comment&quot;&gt;//P3cluster/hbase/WALs/hnode1,16000,1446046595488-splitting: [FileStatus{path=hdfs://P3cluster/hbase/WALs/hnode1,16000,1446046595488-splitting/hnode1%2C16000%2C1446046595488.meta.1446046691314.meta; isDirectory=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; length=39944; replication=3; blocksize=268435456; modification_time=1446050348104; access_time=1446046691317; owner=hbase; group=supergroup; permission=rw-r--r--; isSymlink=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}]
&lt;/span&gt;org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.fs.PathIsNotEmptyDirectoryException): `/hbase/WALs/hnode1,16000,1446046595488-splitting is non empty&apos;: Directory is not empty
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.deleteInternal(FSNamesystem.java:3524)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.deleteInt(FSNamesystem.java:3479)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.delete(FSNamesystem.java:3463)
	at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.delete(NameNodeRpcServer.java:751)
	at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.delete(ClientNamenodeProtocolServerSideTranslatorPB.java:562)
	at org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java)
	at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:585)
	at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:928)
	at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2013)
	at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2009)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:415)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1614)
	at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2007)

	at org.apache.hadoop.ipc.Client.call(Client.java:1411)
	at org.apache.hadoop.ipc.Client.call(Client.java:1364)
	at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:206)
	at com.sun.proxy.$Proxy15.delete(Unknown Source)
	at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.delete(ClientNamenodeProtocolTranslatorPB.java:490)
	at sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:187)
	at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:102)
	at com.sun.proxy.$Proxy16.delete(Unknown Source)
	at sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.hadoop.hbase.fs.HFileSystem$1.invoke(HFileSystem.java:279)
	at com.sun.proxy.$Proxy17.delete(Unknown Source)
	at sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.hadoop.hbase.fs.HFileSystem$1.invoke(HFileSystem.java:279)
	at com.sun.proxy.$Proxy17.delete(Unknown Source)
	at org.apache.hadoop.hdfs.DFSClient.delete(DFSClient.java:1726)
	at org.apache.hadoop.hdfs.DistributedFileSystem$11.doCall(DistributedFileSystem.java:588)
	at org.apache.hadoop.hdfs.DistributedFileSystem$11.doCall(DistributedFileSystem.java:584)
	at org.apache.hadoop.fs.FileSystemLinkResolver.resolve(FileSystemLinkResolver.java:81)
	at org.apache.hadoop.hdfs.DistributedFileSystem.delete(DistributedFileSystem.java:584)
	at org.apache.hadoop.hbase.master.SplitLogManager.splitLogDistributed(SplitLogManager.java:297)
	at org.apache.hadoop.hbase.master.MasterFileSystem.splitLog(MasterFileSystem.java:400)
	at org.apache.hadoop.hbase.master.MasterFileSystem.splitLog(MasterFileSystem.java:373)
	at org.apache.hadoop.hbase.master.MasterFileSystem.splitLog(MasterFileSystem.java:295)
	at org.apache.hadoop.hbase.master.procedure.ServerCrashProcedure.splitLogs(ServerCrashProcedure.java:388)
	at org.apache.hadoop.hbase.master.procedure.ServerCrashProcedure.executeFromState(ServerCrashProcedure.java:228)
	at org.apache.hadoop.hbase.master.procedure.ServerCrashProcedure.executeFromState(ServerCrashProcedure.java:72)
	at org.apache.hadoop.hbase.procedure2.StateMachineProcedure.execute(StateMachineProcedure.java:119)
	at org.apache.hadoop.hbase.procedure2.Procedure.doExecute(Procedure.java:452)
	at org.apache.hadoop.hbase.procedure2.ProcedureExecutor.execProcedure(ProcedureExecutor.java:1050)
	at org.apache.hadoop.hbase.procedure2.ProcedureExecutor.execLoop(ProcedureExecutor.java:841)
	at org.apache.hadoop.hbase.procedure2.ProcedureExecutor.execLoop(ProcedureExecutor.java:794)
	at org.apache.hadoop.hbase.procedure2.ProcedureExecutor.access$400(ProcedureExecutor.java:75)
	at org.apache.hadoop.hbase.procedure2.ProcedureExecutor$2.run(ProcedureExecutor.java:479)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have tracked exception to this line in SplitLogManager#splitLogDistributed&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
297        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fs.exists(logDir) &amp;amp;&amp;amp; !fs.delete(logDir, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since  we are removing folder we need to delete recursively so this line shoud be:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 297        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fs.exists(logDir) &amp;amp;&amp;amp; !fs.delete(logDir, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;This solved issue. I will attach patch after some additional testing.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12909196">HBASE-14729</key>
            <summary>SplitLogManager does not clean files from WALs folder in case of master failover</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="asamir">Samir Ahmic</assignee>
                                    <reporter username="asamir">Samir Ahmic</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Oct 2015 12:28:31 +0000</created>
                <updated>Fri, 30 Oct 2015 20:32:21 +0000</updated>
                            <resolved>Fri, 30 Oct 2015 19:56:15 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>wal</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="14982591" author="asamir" created="Fri, 30 Oct 2015 13:58:53 +0000"  >&lt;p&gt;Here is simple patch for this issue.&lt;/p&gt;</comment>
                            <comment id="14982630" author="yuzhihong@gmail.com" created="Fri, 30 Oct 2015 14:30:07 +0000"  >&lt;p&gt;Edit: we should investigate why the &apos;-splitting&apos; dir was not empty.&lt;br/&gt;
The JIRA Enis pointed to could be one cause.&lt;/p&gt;</comment>
                            <comment id="14982847" author="hadoopqa" created="Fri, 30 Oct 2015 16:46:20 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12769781/HBASE-14729.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12769781/HBASE-14729.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit 23fa18184cb68ca05246beb2189f8801200bdd7c.&lt;br/&gt;
  ATTACHMENT ID: 12769781&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop versions&lt;/font&gt;. The patch compiles with all supported hadoop versions (2.4.0 2.4.1 2.5.0 2.5.1 2.5.2 2.6.0 2.6.1 2.7.0 2.7.1)&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 protoc&lt;/font&gt;.  The applied patch does not increase the total number of protoc compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn post-site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;/p&gt;


&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/16308//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/16308//testReport/&lt;/a&gt;&lt;br/&gt;
Release Findbugs (version 2.0.3) 	warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/16308//artifact/patchprocess/newFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/16308//artifact/patchprocess/newFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/16308//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/16308//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/16308//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/16308//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14982896" author="jinghe" created="Fri, 30 Oct 2015 17:11:02 +0000"  >&lt;p&gt;Is it good to use fs.delete recursively when the log dir is not empty? There may be logs that have not been recovered yet?&lt;br/&gt;
There was a similar JIRA I can recall.  Let me find it.&lt;/p&gt;</comment>
                            <comment id="14983036" author="enis" created="Fri, 30 Oct 2015 18:36:59 +0000"  >&lt;p&gt;We should not do this. Agreed that it is not safe to delete the WAL log directory if it is not empty. Is there a way we can see whether this is due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14223&quot; title=&quot;Meta WALs are not cleared if meta region was closed and RS aborts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14223&quot;&gt;HBASE-14223&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="14983181" author="asamir" created="Fri, 30 Oct 2015 19:54:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is there a way we can see whether this is due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14223&quot; title=&quot;Meta WALs are not cleared if meta region was closed and RS aborts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14223&quot;&gt;HBASE-14223&lt;/a&gt;?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think this issue is a same as &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14223&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-14223&lt;/a&gt;  i used similar process for reproducing it: writting data + killing active master every 30s. Since on master branch master is also regionserver hosting meta table conditions were same. Also logs are almost identical to logs in   &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14223&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-14223&lt;/a&gt;. I will close this issue as duplicate.  &lt;/p&gt;</comment>
                            <comment id="14983189" author="asamir" created="Fri, 30 Oct 2015 19:56:15 +0000"  >&lt;p&gt;Duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14223&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-14223&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="14983253" author="enis" created="Fri, 30 Oct 2015 20:32:21 +0000"  >&lt;p&gt;Thanks Samir. We should still fix &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14223&quot; title=&quot;Meta WALs are not cleared if meta region was closed and RS aborts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14223&quot;&gt;HBASE-14223&lt;/a&gt;, but I could not test the patch there yet. Feel free to pick it up if you are interested. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12769781" name="HBASE-14729.patch" size="1199" author="asamir" created="Fri, 30 Oct 2015 13:58:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 30 Oct 2015 14:30:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nqon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>