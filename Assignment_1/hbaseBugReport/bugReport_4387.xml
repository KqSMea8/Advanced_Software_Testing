<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:18:28 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4387/HBASE-4387.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4387] Error while syncing: DFSOutputStream is closed</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4387</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In a billion-row load on ~25 servers, I see &quot;error while syncing&quot; reasonable often with the error &quot;DFSOutputStream is closed&quot; around a roll. We have some race where a roll at the same time as heavy inserts causes a problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12522920">HBASE-4387</key>
            <summary>Error while syncing: DFSOutputStream is closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lhofhansl">Lars Hofhansl</assignee>
                                    <reporter username="tlipcon">Todd Lipcon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Sep 2011 16:13:51 +0000</created>
                <updated>Fri, 20 Nov 2015 11:52:06 +0000</updated>
                            <resolved>Fri, 23 Sep 2011 17:42:19 +0000</resolved>
                                    <version>0.92.0</version>
                                    <fixVersion>0.90.5</fixVersion>
                                    <component>wal</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13103728" author="tlipcon" created="Tue, 13 Sep 2011 16:18:34 +0000"  >&lt;p&gt;Here are the logs with 100 lines of context around all the ERROR lines&lt;/p&gt;</comment>
                            <comment id="13103774" author="jdcryans" created="Tue, 13 Sep 2011 17:15:14 +0000"  >&lt;p&gt;HLog.syncer() syncs outside of the updateLock and has the following comment:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;// Done in parallel for all writer threads, thanks to &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-895&quot; title=&quot;Allow hflush/sync to occur in parallel with new writes to the file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-895&quot;&gt;&lt;del&gt;HDFS-895&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So we don&apos;t need to synchronize for sync&apos;ing but we do need something when closing the file.&lt;/p&gt;</comment>
                            <comment id="13108245" author="lhofhansl" created="Mon, 19 Sep 2011 23:44:52 +0000"  >&lt;p&gt;The writer is closed with the UpdateLock held.&lt;/p&gt;

&lt;p&gt;So the failure scenario is that we sync the wrong (closed) writer and if the RS dies, we end up with WAL entries that were not sync&apos;ed.&lt;/p&gt;

&lt;p&gt;A simple fix, then, might be to redo the sync with updateLock held if it failed the first time, and only throw the exception when it failed the 2nd time.&lt;/p&gt;</comment>
                            <comment id="13108267" author="lhofhansl" created="Tue, 20 Sep 2011 00:08:47 +0000"  >&lt;p&gt;Something like this.&lt;br/&gt;
Since the writer is rolled with updateLock held the 2nd invocation will get the correct writer.&lt;/p&gt;

&lt;p&gt;We still get the benefit of sync&apos;ing without the lock held most of the time.&lt;/p&gt;

&lt;p&gt;(This is a variation of double-checked-locking, but with a 32 bit primitive, so it should work reliably).&lt;/p&gt;</comment>
                            <comment id="13108818" author="lhofhansl" created="Tue, 20 Sep 2011 16:38:39 +0000"  >&lt;p&gt;@Todd Do you think retry your test with this change?&lt;br/&gt;
(Maybe 100m rows would do too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;</comment>
                            <comment id="13109013" author="lhofhansl" created="Tue, 20 Sep 2011 21:47:13 +0000"  >&lt;p&gt;Assigned to me so this has an owner.&lt;/p&gt;</comment>
                            <comment id="13109118" author="tlipcon" created="Wed, 21 Sep 2011 00:09:33 +0000"  >&lt;p&gt;I&apos;m traveling for the next week or so, so probably won&apos;t have a chance to do so. I&apos;ll be continuing to work on 0.92 stabilization over the next couple of months, though - so I&apos;ll certainly be running this test again in the relatively near future.&lt;/p&gt;</comment>
                            <comment id="13109705" author="lhofhansl" created="Wed, 21 Sep 2011 17:50:38 +0000"  >&lt;p&gt;Until then... anybody opposed to this change?&lt;/p&gt;

&lt;p&gt;J-D diagnosed the problem correct, I think. And my change should fix it. As this is a race there is no proof of course.&lt;/p&gt;

&lt;p&gt;The only question is whether the first attempt should be logged if it failed, maybe even at info level so that we can see these cases even without debug logging.&lt;/p&gt;</comment>
                            <comment id="13113594" author="stack" created="Fri, 23 Sep 2011 17:36:40 +0000"  >&lt;p&gt;I think we should try the patch.  Seems like the incidence is low.  If so, should we continue to log its happening?  Or, I suppose, there is no need since the second call will throw an IOE if it fails?&lt;/p&gt;

&lt;p&gt;Let me commit for now ahead of testing.  We can reopen if still a prob. or has new manifestation.&lt;/p&gt;</comment>
                            <comment id="13113600" author="stack" created="Fri, 23 Sep 2011 17:42:19 +0000"  >&lt;p&gt;Applied two branches and trunk.  Thanks for the patch Lars.&lt;/p&gt;</comment>
                            <comment id="13113775" author="hudson" created="Fri, 23 Sep 2011 21:18:09 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2246 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2246/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2246/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4387&quot; title=&quot;Error while syncing: DFSOutputStream is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4387&quot;&gt;&lt;del&gt;HBASE-4387&lt;/del&gt;&lt;/a&gt; Error while syncing: DFSOutputStream is closed&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4387&quot; title=&quot;Error while syncing: DFSOutputStream is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4387&quot;&gt;&lt;del&gt;HBASE-4387&lt;/del&gt;&lt;/a&gt; Error while syncing: DFSOutputStream is closed&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLog.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13113817" author="stack" created="Fri, 23 Sep 2011 22:57:59 +0000"  >&lt;p&gt;Does this cause TestLogRolling to fail?  &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2246/testReport/org.apache.hadoop.hbase.regionserver.wal/TestLogRolling/testLogRollOnPipelineRestart/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2246/testReport/org.apache.hadoop.hbase.regionserver.wal/TestLogRolling/testLogRollOnPipelineRestart/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I need to look at it....&lt;/p&gt;
</comment>
                            <comment id="13113823" author="hudson" created="Fri, 23 Sep 2011 23:09:49 +0000"  >&lt;p&gt;Integrated in HBase-0.92 #17 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92/17/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92/17/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4387&quot; title=&quot;Error while syncing: DFSOutputStream is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4387&quot;&gt;&lt;del&gt;HBASE-4387&lt;/del&gt;&lt;/a&gt; Error while syncing: DFSOutputStream is closed&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLog.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13113829" author="lhofhansl" created="Fri, 23 Sep 2011 23:19:26 +0000"  >&lt;p&gt;Don&apos;t see how it could. I&apos;ll be on computer soon to check it out.&lt;/p&gt;

</comment>
                            <comment id="13113832" author="ghelmling" created="Fri, 23 Sep 2011 23:24:33 +0000"  >&lt;p&gt;The TestLogRolling failure is on the assertion:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    assertTrue(preLogRolledCalled.size() == 1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I would suspect it&apos;s more due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4132&quot; title=&quot;Extend the WALActionsListener API to accomodate log archival&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4132&quot;&gt;&lt;del&gt;HBASE-4132&lt;/del&gt;&lt;/a&gt;.  Unless there&apos;s some interaction between this change and that.&lt;/p&gt;</comment>
                            <comment id="15015667" author="lars_francke" created="Fri, 20 Nov 2015 11:52:06 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12495170" name="4387.txt" size="923" author="lhofhansl" created="Tue, 20 Sep 2011 00:08:47 +0000"/>
                            <attachment id="12494253" name="errors-with-context.txt" size="358866" author="tlipcon" created="Tue, 13 Sep 2011 16:18:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Sep 2011 17:15:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27282</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hqon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101585</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>