<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:35:58 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6348/HBASE-6348.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6348] Region assignments should be only allowed edit META hosted on the same cluster.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6348</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We copied hbase file data (root/meta/tables) from one hdfs cluster to another, scrubbed it, and then attempted to start the new cluster.  We noticed that META on the original cluster was being modified with server entries from the new cluster.  &lt;/p&gt;

&lt;p&gt;Its contrived but here is how it happened.&lt;/p&gt;

&lt;p&gt;First we copied all the data.  Then we &quot;scrubbed&quot; META &amp;#8211; we removed all region serverinfo cols that pointed to nodes on the original cluster.  When we started the new cluster, it picked a RS to serve ROOT.  Since we had scrubbed meta, then the new cluster&apos;s master attempted to assign regions to other region servers on the new cluster.  From the code&apos;s point of view this all succeeeded &amp;#8211; zk went through transitions, according to the master they were assigned.  However, we started seeing NotServingRegionExceptions on the original cluster.&lt;/p&gt;

&lt;p&gt;The root cause is that ROOT was not scrubbed.  The new cluster assigned the copy of ROOT to a new cluster RS.  Now, when the new cluster attempted to modify META, it would read the old ROOT&apos;s serverinfo pointer go to the &lt;b&gt;old cluster&apos;s regionserver&lt;/b&gt;.  The old cluster&apos;s regionserer just so happened to be still serving META, so the old cluster&apos;s META server gladly accepted the assignments that included the new cluster&apos;s regionserver names.&lt;/p&gt;

&lt;p&gt;At this point we brought down the new cluster (it was getting killed).  Clients on the old cluster would now go to zk,root,meta, and get pointers to the new cluster.  NSRE&apos;s happened.  Unhappyness.&lt;/p&gt;

&lt;p&gt;Long story short, we should have some mechanism to make sure that region assignments should be only allowed edit META hosted on the same cluster.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12597874">HBASE-6348</key>
            <summary>Region assignments should be only allowed edit META hosted on the same cluster.</summary>
                <type id="3" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/task.png">Task</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jmhsieh">Jonathan Hsieh</reporter>
                        <labels>
                    </labels>
                <created>Sat, 7 Jul 2012 00:46:14 +0000</created>
                <updated>Mon, 9 Jul 2012 19:11:18 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13409743" author="jdcryans" created="Mon, 9 Jul 2012 19:11:18 +0000"  >&lt;p&gt;Wouldn&apos;t it be just easier to make sure that .META. is assigned correctly? IIUC this is where the problem happened (HMaster.assignRootAndMeta):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.verifyMetaRegionLocation(timeout)) {
      ServerName currentMetaServer =
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getMetaLocationOrReadLocationFromRoot();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentMetaServer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
          &amp;amp;&amp;amp; !currentMetaServer.equals(currentRootServer)) {
        splitLogAndExpireIfOnline(currentMetaServer);
      }
      assignmentManager.assignMeta();
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.waitForMeta();
      &lt;span class=&quot;code-comment&quot;&gt;// Above check waits &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; general meta availability but &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; does not
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// guarantee that the transition has completed
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.waitForAssignment(HRegionInfo.FIRST_META_REGIONINFO);
      assigned++;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-comment&quot;&gt;// Region already assigned.  We didnt&apos; assign it.  Add to in-memory state.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.regionOnline(HRegionInfo.FIRST_META_REGIONINFO,
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getMetaLocation());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When the location was verified, it was able to read the old .META. location from ROOT and since the region was still there it was assumed that .META. was correctly assigned. Now what&apos;s interesting is this from AM.regionOnline:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isServerOnline(sn)) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions.put(regionInfo, sn);
        addToServers(sn, regionInfo);
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions.notifyAll();
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;The server is not in online servers, ServerName=&quot;&lt;/span&gt; + 
          sn.getServerName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;, region=&quot;&lt;/span&gt; + regionInfo.getEncodedName());
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I assume that if you went over the master&apos;s log you would find the log message about the server not being online? It seems to me that we should either check if the server belongs to us or backtrack when we fail to setting the region online.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 9 Jul 2012 19:11:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256590</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0huuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>102261</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>