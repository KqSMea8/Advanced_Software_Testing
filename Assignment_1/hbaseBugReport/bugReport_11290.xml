<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:21:48 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11290/HBASE-11290.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11290] Unlock RegionStates</title>
                <link>https://issues.apache.org/jira/browse/HBASE-11290</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Even though RegionStates is a highly accessed data structure in HMaster. Most of it&apos;s methods are synchronized. Which limits concurrency. Even simply making some of the getters non-synchronized by using concurrent data structures has helped with region assignments. We can go as simple as this approach or create locks per region or a bucket lock per region bucket.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12718069">HBASE-11290</key>
            <summary>Unlock RegionStates</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12714102">HBASE-11165</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="toffer">Francis Liu</assignee>
                                    <reporter username="toffer">Francis Liu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jun 2014 05:55:21 +0000</created>
                <updated>Tue, 11 Oct 2016 20:53:55 +0000</updated>
                                            <version>1.2.0</version>
                    <version>1.3.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                    <fixVersion>0.98.24</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                                <comments>
                            <comment id="14016857" author="jxiang" created="Tue, 3 Jun 2014 16:34:46 +0000"  >&lt;p&gt;FYI. I am working on some low hanging fruits in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11059&quot; title=&quot;ZK-less region assignment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11059&quot;&gt;&lt;del&gt;HBASE-11059&lt;/del&gt;&lt;/a&gt;, without data structure change.&lt;/p&gt;</comment>
                            <comment id="14127771" author="mantonov" created="Tue, 9 Sep 2014 23:25:14 +0000"  >&lt;p&gt;Some time ago in the parent jira we started discussion the concurrency around regionstates, so more like to continue this discussion and illustrate some thoughts I&apos;m humbly posting draft in here..For others to look at. This is conservative, and I didn&apos;t redo heavy and supposedly rarely called methods to use separate locks-per-invariant, but hope to reduce read contention on get*** calls.&lt;/p&gt;</comment>
                            <comment id="14127773" author="mantonov" created="Tue, 9 Sep 2014 23:28:24 +0000"  >&lt;p&gt;(I looked at the puts for the collections and seems there are no places where partially-initialized objects can escape and gets published outside the scope of locks)&lt;/p&gt;</comment>
                            <comment id="14129322" author="stack" created="Wed, 10 Sep 2014 23:11:41 +0000"  >&lt;p&gt;Why not define and declare all in the one go rather than wait on the constructor?  Then you can mark the data members final.&lt;/p&gt;

&lt;p&gt;+    processedServers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;What is idea behind erasure here &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt;?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;List&amp;lt;HRegionInfo&amp;gt; rits = new ArrayList&amp;lt;HRegionInfo&amp;gt;();&lt;br/&gt;
+    List&amp;lt;HRegionInfo&amp;gt; rits = new ArrayList&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Hmm... There is nowhere where we mod two Maps and we need to do it inside synchronize?  I don&apos;t see it.  Patch looks good if this is the case.  Might be worth making a little test harness to try many concurrent state change ops.  What you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;?  Or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14129358" author="mantonov" created="Wed, 10 Sep 2014 23:33:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;not define and declare all in the one go rather than wait on the constructor&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Right. Just didn&apos;t touch this code. Makes sense.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What is idea behind erasure&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There&apos;s no erasure, is it? Just java7 syntax, still proper type inference.. Thought it would make code little bit more compact. But yeah, not related to patch at all. I can revert it all.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There is nowhere where we mod two Maps and we need to do it inside synchronize?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There&apos;re quite a bit of such places, but those still go under global lock (i mean, monitor on &lt;em&gt;this&lt;/em&gt; object), i.e. #createRegionState() puts entries in several collection. Idea was that all methods modifying several collections still need to grab &lt;em&gt;this&lt;/em&gt; lock, but methods only reading from the collections can do so without getting the lock, but rather using internal CHM sync (so intent is to just try to reduce read lock contention on getters, assuming that we can relax consistency for callers who just do gets (as now all individual getters to get global lock).&lt;/p&gt;

&lt;p&gt;Upon further thinking, the other (possibly better) solutions seems to be:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;instead of making bunch of those collection CHM, just use RW-lock in this class, and make all getters method use R-lock from it. That would help for the case when there&apos;re just lot of readers to RegionStates class. Won&apos;t speedup stuff like bulk assignment, as exclusive writers will push the readers out, but will help to reduce read contention in more stable case (stable case is easier yeah..)&lt;/li&gt;
	&lt;li&gt;make locking more coarse-grained and do operations like bulk assignments under it.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14129366" author="octo47" created="Wed, 10 Sep 2014 23:38:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt; I&apos;d like to rephrase last &lt;br/&gt;
.bq make locking more coarse-grained and do operations like bulk assignments under it.&lt;br/&gt;
introduce Visitor to do some things under lock within RegionStates context. May be Predicate can be involved too.&lt;/p&gt;</comment>
                            <comment id="14129467" author="mantonov" created="Thu, 11 Sep 2014 01:09:52 +0000"  >&lt;p&gt;I&apos;ll make next version with RW-locks and then see how to make it with Visitor etc.&lt;/p&gt;</comment>
                            <comment id="14129487" author="virag" created="Thu, 11 Sep 2014 01:33:22 +0000"  >&lt;p&gt;I have a patch using region locks to avoid the heavy synchronized(this) in RegionStates. Also it uses region locks to avoid synchronization on region plans in AM. Will put up the patch for initial review very soon.&lt;/p&gt;</comment>
                            <comment id="14130238" author="virag" created="Thu, 11 Sep 2014 16:23:46 +0000"  >&lt;p&gt;The attached patch for 0.98 does the following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uses a concurrent cache to implement region locks&lt;/li&gt;
	&lt;li&gt;All Hashmap converted to CHM, Treemap to ConcurrentSkipListMap.&lt;/li&gt;
	&lt;li&gt;For RegionStates, setters updating multiple collections keyed by region names will acquire region locks. (ServerHoldings map is keyed by serverName, but it didn&apos;t seem necessary to obtain server locks).&lt;/li&gt;
	&lt;li&gt;Getters can directly use CHM or ConcurrentSkipListMap without additional locks.&lt;/li&gt;
	&lt;li&gt;RegionPlans TreeMap in AM also converted to ConcurrentSkipListMap&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;WIP:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Need a way to remove entries from Cache. Was looking at Guava&apos;s CacheBuilder (allows soft values) yest. Can that help?&lt;/li&gt;
	&lt;li&gt;Patch for trunk&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please review. Thanks!&lt;/p&gt;</comment>
                            <comment id="14130263" author="octo47" created="Thu, 11 Sep 2014 16:43:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt; compilation fails. applied patch to branch1 (it applies cleanly) but got compilation error&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:2.5.1:compile (default-compile) on project hbase-server: Compilation failure&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11290&quot; title=&quot;Unlock RegionStates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11290&quot;&gt;HBASE-11290&lt;/a&gt;/hbase.git/hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java:&lt;span class=&quot;error&quot;&gt;&amp;#91;771,20&amp;#93;&lt;/span&gt; error: cannot find symbol&lt;/p&gt;

&lt;p&gt;It didn&apos;t find RegionStates#setLastRegionServerOfRegion method&lt;/p&gt;</comment>
                            <comment id="14130305" author="octo47" created="Thu, 11 Sep 2014 17:08:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt; here is a couple of possible concurrent issues:&lt;/p&gt;

&lt;p&gt;#addToServerHoldings publish incomplete values to CHM.&lt;br/&gt;
#removeFromReplicaMapping do that too, but didn&apos;t see why  defaultReplicaToOtherReplicas became CHM (it doesn&apos;t accessed concurrently).&lt;/p&gt;</comment>
                            <comment id="14130345" author="virag" created="Thu, 11 Sep 2014 17:33:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;compilation fails&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=octo47&quot; class=&quot;user-hover&quot; rel=&quot;octo47&quot;&gt;Andrey Stepachev&lt;/a&gt;, the patch is for 0.98. Work on branch-1 and trunk is WIP.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;#addToServerHoldings publish incomplete values to CHM. #removeFromReplicaMapping do that too, but didn&apos;t see why defaultReplicaToOtherReplicas became CHM (it doesn&apos;t accessed concurrently).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As both this methods are in branch-1/master, will keep in mind when working on those branch.&lt;/p&gt;
</comment>
                            <comment id="14132092" author="mantonov" created="Fri, 12 Sep 2014 20:55:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt;, that&apos;s pretty good. A few thoughts / questions..(just skimmed the patch, may be missed something)&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LockFreeCache name implies that it&apos;s &quot;cache (i.e. structure from where elements could be evicted without any harm when expired or cache is overfilled) which is lock free&quot;, which isn&apos;t exactly how it&apos;s used? I mean - the class itself is suited to serve as a set of named lock objects, and it can&apos;t arbitrarily evict elements from it?&lt;/li&gt;
	&lt;li&gt;to be precise, not just setters updating multiple collections grab region lock, but readers who want to read consistently from several ones, right? Like isRegionOnline()?  Also this list could contain RW-locks, right? As further improvements. Now guys like #isRegionOnline() can&apos;t run in parallel querying about the same region from multiple threads, although they could with RW lock.&lt;/li&gt;
	&lt;li&gt;for ops like #regionOnline(), does it make sense to have the server-keyed locks, and operations involving both HRI and server (hence needed to access/update serverHoldings) would first grab lock for HRI, then lock for ServerName to work with server holdings? Seems more consistent?&lt;/li&gt;
	&lt;li&gt;#logSplit made not synchronized now, we don&apos;t need locks to iterate over lastAssignments map or to access processedServers?&lt;/li&gt;
	&lt;li&gt;in #serverOffline do we still need notifyAll call at the last lines?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14132101" author="mantonov" created="Fri, 12 Sep 2014 21:01:04 +0000"  >&lt;p&gt;Also &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in AM, #addPlan() grabs locks for region name before putting into regionPlans, but #addPlans() doesn&apos;t get any locks? It assumed the lock is already grabbed for all those regions?&lt;/li&gt;
	&lt;li&gt;in #processServerShutdown we don&apos;t need locks on regionPlans?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14132242" author="virag" created="Fri, 12 Sep 2014 22:46:50 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;LockFreeCache name implies that it&apos;s &quot;cache (i.e. structure from where elements could be evicted without any harm when expired or cache is overfilled) which is lock free&quot;, which isn&apos;t exactly how it&apos;s used? I mean - the class itself is suited to serve as a set of named lock objects, and it can&apos;t arbitrarily evict elements from it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I named it &apos;lockfree&apos; as we are retrieving elements from cache without obtaining lock. But seems that is confusing as we are serving lock objects from cache. How about the name as LockCache? . We need to evict elements otherwise the map may grow unbounded. In next version, I plan to add Guava&apos;s cachebuilder with soft values instead of the CHM. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;to be precise, not just setters updating multiple collections grab region lock, but readers who want to read consistently from several ones, right? Like isRegionOnline()? Also this list could contain RW-locks, right? As further improvements. Now guys like #isRegionOnline() can&apos;t run in parallel querying about the same region from multiple threads, although they could with RW lock.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep, for some readers reading several collections we are also grabbing region locks. Agree that RW-locks can be a future optimization. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;for ops like #regionOnline(), does it make sense to have the server-keyed locks, and operations involving both HRI and server (hence needed to access/update serverHoldings) would first grab lock for HRI, then lock for ServerName to work with server holdings? Seems more consistent?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I was planning to add server locks  initially. But for methods like regionOnline(), concurrent put and concurrent remove seems to be enough for server keyed structures like serverHoldings(). Also, we have to be more careful about deadlock type of situation when we deal with  two types of lock (region and server). So, I thought about avoiding serverlocks for now.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;#logSplit made not synchronized now, we don&apos;t need locks to iterate over lastAssignments map or to access processedServers?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The logSplit() is called by SSH and multiple SSH should not call logSplit() for the same ServerName. Even in a case they do, I dont see any issue with multiple threads overlapping for this method.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;in #serverOffline do we still need notifyAll call at the last lines?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We are doing a wait using object lock somewhere. So kept this as is.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In AM, #addPlan() grabs locks for region name before putting into regionPlans, but #addPlans() doesn&apos;t get any locks? It assumed the lock is already grabbed for all those regions?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt; I thought CHM.putAll is atomic but its not the case. Let me see whether we need locks here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;in #processServerShutdown we don&apos;t need locks on regionPlans?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The iterator over regionPlans is weakly consistent and other threads might update/access the map, but that seems to be ok here.&lt;/p&gt;

</comment>
                            <comment id="14240851" author="virag" created="Wed, 10 Dec 2014 09:28:21 +0000"  >&lt;p&gt;I have an updated patch..will put it up tomorrow&lt;/p&gt;</comment>
                            <comment id="14240854" author="mantonov" created="Wed, 10 Dec 2014 09:31:26 +0000"  >&lt;p&gt;Great! I&apos;ll take a look at it.&lt;/p&gt;</comment>
                            <comment id="14243977" author="virag" created="Fri, 12 Dec 2014 10:53:27 +0000"  >&lt;p&gt;Updated patch for review&lt;/p&gt;</comment>
                            <comment id="14249086" author="apurtell" created="Tue, 16 Dec 2014 22:37:10 +0000"  >&lt;p&gt;The new LockCache in the v2 patch is reminiscent of HFile&apos;s IdLock. Can this be refactored so those places share common code? &lt;/p&gt;

&lt;p&gt;(There&apos;s RowLock in HRegion also, but that would be significantly more work, maybe a future time.)&lt;/p&gt;</comment>
                            <comment id="14252134" author="virag" created="Thu, 18 Dec 2014 19:49:48 +0000"  >&lt;p&gt;I should be able to use IdLock. Let me try refactoring.&lt;/p&gt;</comment>
                            <comment id="14254004" author="apurtell" created="Fri, 19 Dec 2014 20:51:50 +0000"  >&lt;p&gt;Thanks Virag. Lifting a common impl to use in both places would be good if not too difficult. &lt;/p&gt;</comment>
                            <comment id="14344094" author="apurtell" created="Tue, 3 Mar 2015 00:08:09 +0000"  >&lt;p&gt;Moved out to 0.98.12&lt;/p&gt;</comment>
                            <comment id="14387530" author="mantonov" created="Mon, 30 Mar 2015 22:33:00 +0000"  >&lt;p&gt;Is that something we would like to pull in sometime soon (1.1?).&lt;/p&gt;</comment>
                            <comment id="14500671" author="mantonov" created="Fri, 17 Apr 2015 21:08:51 +0000"  >&lt;p&gt;I&apos;m thinking to resurrect this patch, as lots of time and effort seem to have been invested in that.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toffer&quot; class=&quot;user-hover&quot; rel=&quot;toffer&quot;&gt;Francis Liu&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; - what do you guys think? Switching to IdLock could be easier improvement here, or probably be done in subsequent patch?&lt;/p&gt;

&lt;p&gt;What I&apos;m thinking need to be clarified in latest version of patch is what&apos;s the eviction policy of LockCache? &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We need to evict elements otherwise the map may grow unbounded. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;But we can&apos;t evict element if it&apos;s being used as a lock key, right? Perhaps we should have upper bound on number of  locks held at any time and reject new acquire() call if this limit is reached?&lt;/p&gt;</comment>
                            <comment id="14500751" author="virag" created="Fri, 17 Apr 2015 21:50:19 +0000"  >&lt;p&gt;Idlock() takes care of releasing locks so its better than the LockCache which relies on guava&apos;s lazy eviction. &lt;br/&gt;
I had taken a look before and will put up an updated patch on weekend. Sorry for delay, its been long time since this jira is open.&lt;/p&gt;</comment>
                            <comment id="14500761" author="mantonov" created="Fri, 17 Apr 2015 21:56:04 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="14504339" author="virag" created="Tue, 21 Apr 2015 05:08:41 +0000"  >&lt;p&gt;IdLock is not reentrant. So, wont be able to use that&lt;br/&gt;
So probably we have to go with LockCache impl as in patch. For eviction, currently values are wrapped using soft references so garbage collection will be triggered on it on demand. Its not a great eviction policy and will create memory pressure for large no of regions. As LockCache uses guava&apos;s cache builder, it can support quite a few eviction schemes (&lt;a href=&quot;https://code.google.com/p/guava-libraries/wiki/CachesExplained&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://code.google.com/p/guava-libraries/wiki/CachesExplained&lt;/a&gt;) I think they can be investigated and added later on in a new jira. Thoughts?&lt;/p&gt;</comment>
                            <comment id="14504392" author="mantonov" created="Tue, 21 Apr 2015 05:54:00 +0000"  >&lt;p&gt;Yeah, I think that would just work. After all, the lock names are encoded region names..so even for cluster with 1M regions with edge case of bulk re-assignment the cache shouldn&apos;t take more than few hundred mb of RAM, HMaster should be able to handle it.&lt;/p&gt;

&lt;p&gt;Alternatively, I guess we could just have wrapper class around CHM&amp;lt;name, lock&amp;gt; with lock(), unlock() methods, but current patch would work, too (maybe as further improvement we can limit the size of the cache and make getLock() block if the cache is waiting for GC?)&lt;/p&gt;

&lt;p&gt;What&apos;s funny, the length of this thread (&lt;a href=&quot;http://stackoverflow.com/questions/5639870/simple-java-name-based-locks/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://stackoverflow.com/questions/5639870/simple-java-name-based-locks/&lt;/a&gt;) suggests that simple named locks aren&apos;t that simple &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14504432" author="mantonov" created="Tue, 21 Apr 2015 06:25:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt; Curious if you had a chance to take the latest patch for a spin on the real cluster? Any numbers to think over?&lt;/p&gt;</comment>
                            <comment id="14507911" author="apurtell" created="Wed, 22 Apr 2015 21:14:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;IdLock is not reentrant. So, wont be able to use that. So probably we have to go with LockCache impl as in patch&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok by me&lt;/p&gt;</comment>
                            <comment id="14587750" author="mantonov" created="Tue, 16 Jun 2015 09:32:23 +0000"  >&lt;p&gt;Pinging &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toffer&quot; class=&quot;user-hover&quot; rel=&quot;toffer&quot;&gt;Francis Liu&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt; -sounds like there&apos;s some consensus here that LockCache impl backed by Guava cache builder is just reasonable thing to go with? So presumably latest version of patch posted could be rebased to current master (not sure about 1.2.0) with some adjustments/review if needed?&lt;/p&gt;

&lt;p&gt;Let me know if I could help.&lt;/p&gt;</comment>
                            <comment id="14939133" author="toffer" created="Thu, 1 Oct 2015 01:04:17 +0000"  >&lt;p&gt;Spoke with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=virag&quot; class=&quot;user-hover&quot; rel=&quot;virag&quot;&gt;Virag Kothari&lt;/a&gt;. I&apos;ll be taking over this jira.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt; I&apos;ll rebase. Hopefully you still have some time to review.&lt;/p&gt;</comment>
                            <comment id="14942591" author="mantonov" created="Sun, 4 Oct 2015 08:08:52 +0000"  >&lt;p&gt;Sure!&lt;/p&gt;</comment>
                            <comment id="14942901" author="stack" created="Mon, 5 Oct 2015 04:08:36 +0000"  >&lt;p&gt;Would be good to get this one in. I can run some tests w/ an updated patch.&lt;/p&gt;</comment>
                            <comment id="15064991" author="mantonov" created="Fri, 18 Dec 2015 23:47:28 +0000"  >&lt;p&gt;Sorry, that slided off my plate &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; but we do need to get this in. Let me rebase/update patch and I&apos;ll try to test it too.&lt;/p&gt;</comment>
                            <comment id="15065435" author="toffer" created="Sat, 19 Dec 2015 17:16:00 +0000"  >&lt;p&gt;Sorry for the delay guys. i&apos;ve actually been working on a trunk rebase and just need to run the unit tests. If its alright can I upload the patch and reassign this jira?&lt;/p&gt;</comment>
                            <comment id="15065492" author="mantonov" created="Sat, 19 Dec 2015 19:20:22 +0000"  >&lt;p&gt;Sure! (it&apos;s assigned to you know). I&apos;ll stop my rebasing-in-progress then. Will help to review once you upload.&lt;/p&gt;</comment>
                            <comment id="15068163" author="toffer" created="Tue, 22 Dec 2015 14:12:51 +0000"  >&lt;p&gt;Thanks Mikhail. I&apos;ve attached a patch for review. Review board is here: &lt;a href=&quot;https://reviews.apache.org/r/41644/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/41644/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15259758" author="mantonov" created="Wed, 27 Apr 2016 08:19:15 +0000"  >&lt;p&gt;Unfortunately, I don&apos;t think I have any bandwidth to review it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and this change would require thorough review/testing..&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toffer&quot; class=&quot;user-hover&quot; rel=&quot;toffer&quot;&gt;Francis Liu&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eclark&quot; class=&quot;user-hover&quot; rel=&quot;eclark&quot;&gt;Elliott Clark&lt;/a&gt; - what do you guys think? I&apos;m going to bump to 1.4 if we can&apos;t get it in.&lt;/p&gt;</comment>
                            <comment id="15261555" author="mantonov" created="Thu, 28 Apr 2016 05:16:15 +0000"  >&lt;p&gt;Kicking out of 1.3 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; feel free to pull it back if you feel like&lt;/p&gt;</comment>
                            <comment id="15262565" author="toffer" created="Thu, 28 Apr 2016 17:21:50 +0000"  >&lt;p&gt;No worries Mikhail. &lt;/p&gt;

&lt;p&gt;If anyone has time to help review this. I&apos;ll make sure turnarounds are quick. FWIW, we&apos;ve been running a 0.98 version this on all our clusters roughly since this jira was opened.&lt;/p&gt;

</comment>
                            <comment id="15262628" author="mantonov" created="Thu, 28 Apr 2016 18:00:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toffer&quot; class=&quot;user-hover&quot; rel=&quot;toffer&quot;&gt;Francis Liu&lt;/a&gt; I&apos;m not sure we can pull it in 1.3 now, but we totally should look to get it in branch-1. If you could please rebase current branch-1 version, I&apos;ll try to get a review on the weekend.  Do you happen to have any numbers on performance improvement here?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; what do you think about it in branch-1 / branch-1.3? would be good to get several reviewers on this code..&lt;/p&gt;
</comment>
                            <comment id="15262635" author="mantonov" created="Thu, 28 Apr 2016 18:03:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toffer&quot; class=&quot;user-hover&quot; rel=&quot;toffer&quot;&gt;Francis Liu&lt;/a&gt; btw, in the WIP patch to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15648&quot; title=&quot;Reduce number of concurrent region location lookups when MetaCache entry is cleared&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15648&quot;&gt;HBASE-15648&lt;/a&gt; I had an implementation of multi-lock similar to IdLock, but re-entrant and allowing to synchronize on any objects, not just longs. Would it be useful? &lt;/p&gt;</comment>
                            <comment id="15262660" author="toffer" created="Thu, 28 Apr 2016 18:14:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt; At the moment we just need it to get into branch-1 no worries about not getting it into 1.3. With that I&apos;d be happy to update this patch if you&apos;re still up for reviewing it this weekend (tho you don&apos;t have to)? BTW the current patch I have is for trunk are you asking me to rebase onto trunk? Or create patches for both trunk and 1.x?&lt;/p&gt;

&lt;p&gt;What&apos;s the name of the lock? I can take a look. Tho if it&apos;s usable maybe we can just replace Idlock once &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15648&quot; title=&quot;Reduce number of concurrent region location lookups when MetaCache entry is cleared&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15648&quot;&gt;HBASE-15648&lt;/a&gt; goes in? &lt;/p&gt;</comment>
                            <comment id="15262668" author="mantonov" created="Thu, 28 Apr 2016 18:20:11 +0000"  >&lt;p&gt;That&apos;s the MultiLock class in the patch to the jira I mentioned.  The approach I used there trying to optimize concurrent meta lookups doesn&apos;t look feasible, but the implementation of the lock might be useful to someone.&lt;/p&gt;

&lt;p&gt;If we could have up-to-date patches for both trunk and branch-1 that would be great! It seems a useful change where a lot of effort went in (both in writing the code and in reviewing different versions of the patch), pity if that keeps sitting around...&lt;/p&gt;</comment>
                            <comment id="15262682" author="toffer" created="Thu, 28 Apr 2016 18:27:18 +0000"  >&lt;blockquote&gt;
&lt;p&gt;If we could have up-to-date patches for both trunk and branch-1 that would be great! It seems a useful change where a lot of effort went in (both in writing the code and in reviewing different versions of the patch), pity if that keeps sitting around...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I see great, let me rebase then.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Do you happen to have any numbers on performance improvement here?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We did do perf testing and if I remember correctly it went from not being able to assign 1M regions (took hours and still not done) to being able to assign them in 10s of minutes. Because of lock thrashing which resulted in high cpu, even refreshing master page was blocked. That was sometime ago, I&apos;ll see if I can dig it up. &lt;/p&gt;</comment>
                            <comment id="15264778" author="toffer" created="Fri, 29 Apr 2016 21:28:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt; trunk patch. branch-1 to come in a bit.&lt;/p&gt;</comment>
                            <comment id="15264796" author="toffer" created="Fri, 29 Apr 2016 21:34:25 +0000"  >&lt;p&gt;Some draft code I forgot to cleanup. There wasn&apos;t much change needed for the rebase.&lt;/p&gt;</comment>
                            <comment id="15265065" author="toffer" created="Sat, 30 Apr 2016 01:48:55 +0000"  >&lt;p&gt;branch-1 patch, too longer than expected as branch-1 has zk and zkless support in AM.&lt;/p&gt;</comment>
                            <comment id="15265068" author="toffer" created="Sat, 30 Apr 2016 01:54:10 +0000"  >&lt;p&gt;branch-1 RB: &lt;a href=&quot;https://reviews.apache.org/r/46862/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/46862/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15566571" author="toffer" created="Tue, 11 Oct 2016 20:53:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt; still swamped? do you have time to look at this? &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12760676">HBASE-12667</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12735603">HBASE-11793</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12668102" name="HBASE-11290-0.98.patch" size="36740" author="virag" created="Thu, 11 Sep 2014 16:23:46 +0000"/>
                            <attachment id="12686824" name="HBASE-11290-0.98_v2.patch" size="50125" author="virag" created="Fri, 12 Dec 2014 10:53:27 +0000"/>
                            <attachment id="12801573" name="HBASE-11290.01.branch-1.patch" size="53330" author="toffer" created="Sat, 30 Apr 2016 01:48:55 +0000"/>
                            <attachment id="12801530" name="HBASE-11290.02.patch" size="53231" author="toffer" created="Fri, 29 Apr 2016 21:28:44 +0000"/>
                            <attachment id="12801533" name="HBASE-11290.03.patch" size="53255" author="toffer" created="Fri, 29 Apr 2016 21:34:25 +0000"/>
                            <attachment id="12667536" name="HBASE-11290.draft.patch" size="13422" author="mantonov" created="Tue, 9 Sep 2014 23:25:14 +0000"/>
                            <attachment id="12779058" name="HBASE-11290_trunk.patch" size="53301" author="toffer" created="Tue, 22 Dec 2015 14:12:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 3 Jun 2014 16:34:46 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396271</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1w83j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396393</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>