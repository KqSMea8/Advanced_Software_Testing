<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:23:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4988/HBASE-4988.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4988] MetaServer crash cause all splitting regionserver abort</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4988</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;If metaserver crash now,&lt;br/&gt;
All the splitting regionserver will abort theirself.&lt;br/&gt;
Becasue the code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.journal.add(JournalEntry.PONR);
MetaEditor.offlineParentInMeta(server.getCatalogTracker(),
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.parent.getRegionInfo(), a.getRegionInfo(), b.getRegionInfo());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the JournalEntry is PONR, split&apos;s roll back will abort itselef.&lt;/p&gt;

&lt;p&gt;It is terrible in huge putting environment when metaserver crash&lt;/p&gt;</description>
                <environment></environment>
        <key id="12534424">HBASE-4988</key>
            <summary>MetaServer crash cause all splitting regionserver abort</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="zjushch">chunhui shen</assignee>
                                    <reporter username="zjushch">chunhui shen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Dec 2011 03:08:17 +0000</created>
                <updated>Wed, 16 Nov 2016 21:07:28 +0000</updated>
                            <resolved>Wed, 16 Nov 2016 21:07:26 +0000</resolved>
                                    <version>0.90.6</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13165805" author="zjushch" created="Fri, 9 Dec 2011 03:08:57 +0000"  >&lt;p&gt;logs&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-12-07 17:49:17,737 INFO org.apache.hadoop.hbase.regionserver.HRegion: Onlined writetest,28TPVACCO3EI47TH472E1997TX1ZDFQ7XUCMBA2LUKOD7G0U3NQ2L2FG0ILRGZ5ETHFESE5QIMFN8ONUDUXB80G7MEK58G7YM4EG,1323251351741.6399c204b8d45568a782fd0157d6700d.; next sequenceid=3483318538 
2011-12-07 17:49:17,737 DEBUG org.apache.hadoop.hbase.regionserver.CompactSplitThread: Compaction requested &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; writetest,2FB\xC0EE\xC2LDFG\xC8\xB6GV\xCE\xC6F4&amp;lt;\xBBE\xC87BM\xC0\xCD\xC3\xC8A\xB3\xCE\xD5G\xCBI\xBA\xBB\xCB\xD7R\xD2=\xC5&amp;gt;2U;P\xD2D\xCD\xBA\xC6\xC6A\xC1KI\xCDND\xC8\xCEKG\xC3\xCC\xCD\xB4\xC1=\xD0\xC4\xD2FSSPE\xD0V\xCE5@\xBCCN\xC4\xCB\xBE7L\xC8E\xC1\xBD\xCFH,1323251351741.a639e2eda8b2de9ca368c1a13ebbcb44. because Region has references on open; priority=16, compaction queue size=1 
2011-12-07 17:49:17,737 INFO org.apache.hadoop.hbase.catalog.CatalogTracker: Failed verification of .META.,,1 at address=dw83.kgb.sqa.cm4:60020; java.io.EOFException 
2011-12-07 17:49:17,737 INFO org.apache.hadoop.hbase.catalog.CatalogTracker: Current cached META location is not valid, resetting 
2011-12-07 17:49:17,740 INFO org.apache.hadoop.hbase.catalog.CatalogTracker: Failed verification of .META.,,1 at address=dw83.kgb.sqa.cm4:60020; java.net.ConnectException: Connection refused 
2011-12-07 17:49:17,740 WARN org.apache.hadoop.hbase.regionserver.CompactSplitThread: Running rollback of failed split of writetest,28TPVACCO3EI47TH472E1997TX1ZDFQ7XUCMBA2LUKOD7G0U3NQ2L2FG0ILRGZ5ETHFESE5QIMFN8ONUDUXB80G7MEK58G7YM4EG,1323240352298.c7bde4437e5b12bc7226485dcbc2700b.; Timed out (2147483647ms) 
2011-12-07 17:49:17,740 FATAL org.apache.hadoop.hbase.regionserver.HRegionServer: ABORTING region server serverName=dw87.kgb.sqa.cm4,60020,1323244700069, load=(requests=393, regions=12, usedHeap=742, maxHeap=15872): Abort; we got an error after point-of-no-&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13165811" author="zjushch" created="Fri, 9 Dec 2011 03:12:10 +0000"  >&lt;p&gt;In patchv1,&lt;br/&gt;
when doing MetaEditor.offlineParentInMeta, if metaserver is not ok now , doesn&apos;t add JournalEntry.PONR.&lt;br/&gt;
Therefore, rollback won&apos;t abort itself&lt;/p&gt;</comment>
                            <comment id="13165869" author="stack" created="Fri, 9 Dec 2011 05:58:07 +0000"  >&lt;p&gt;Which hbase version Chunhui?  In 0.92 we should be retrying (the putToMetaTable should be retrying and will give up only if .META. really gond)?  This change has no retry facility and would seem to be a regression?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    metaServer.put(CatalogTracker.META_REGION_NAME, put);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The .meta. server could die between verification and your doing above.&lt;/p&gt;

&lt;p&gt;Maybe have putToMetaTable return true/false?&lt;/p&gt;

&lt;p&gt;Also, I don&apos;t think this will work:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        toPONR = MetaEditor.offlineParentInMeta(server.getCatalogTracker(),
+            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.parent.getRegionInfo(), a.getRegionInfo(), b.getRegionInfo());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the past, I&apos;ve seen weird case where the offlineParentInMeta looked like it failed but all that happened was that the client timeout trying to do the .META. put &amp;#8211; the edit actually went in anyways.  Aborting the regionserver is pretty radical but having the PONR before we do the meta edit would at least make it so if the edit went in, we&apos;d likely find out during server recovery.&lt;/p&gt;

&lt;p&gt;We used to have PONR after the above but this patch changed it: &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4562&quot; title=&quot;When split doing offlineParentInMeta encounters error, it&amp;#39;ll cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4562&quot;&gt;&lt;del&gt;HBASE-4562&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You have a point though that currently if .META. goes away long enough, we could abort all servers (this is 0.92?).  This is pretty serious issue.&lt;/p&gt;</comment>
                            <comment id="13165898" author="zjushch" created="Fri, 9 Dec 2011 06:59:38 +0000"  >&lt;p&gt;@stack&lt;/p&gt;

&lt;p&gt;The case happens in our test environment which use 0.90 version.&lt;/p&gt;

&lt;p&gt;If .META. Server is killed and not started immediately.&lt;br/&gt;
the step MetaEditor.offlineParentInMeta will fail and throw exception,&lt;br/&gt;
and the JournalEntry.PONR causes server abort when rolling back.&lt;/p&gt;

&lt;p&gt;In Trunk version, MetaEditor.offlineParentInMeta will retry, but the parent region can&apos;t on service for a long time, I think it is unacceptable. Also the retry would be failed, and cause server abort finally.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;metaServer.put(CatalogTracker.META_REGION_NAME, put);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the .meta. server die between verification and doing put above, it will abort because we can&apos;t ensure whether update .meta. successfully. However, if we can find that .meta. server is not ok now first, we needn&apos;t abort server which is doing split&lt;/p&gt;</comment>
                            <comment id="13167008" author="stack" created="Sat, 10 Dec 2011 23:33:27 +0000"  >&lt;p&gt;@Chunhui Let me try in 0.92.  I don&apos;t think we have this issue there, or at least, the scenario you paint should be harder to produce.  If .META. server is killed, we&apos;ll retry a good few times.  The .META. should get redeployed meantime.  If it does not, the cluster is sort of hosed anyways?  All regionservers shouldn&apos;t go down though.&lt;/p&gt;

&lt;p&gt;What you think of the rationale in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4562&quot; title=&quot;When split doing offlineParentInMeta encounters error, it&amp;#39;ll cause data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4562&quot;&gt;&lt;del&gt;HBASE-4562&lt;/del&gt;&lt;/a&gt; that moves the PONR before the meta parent offline edit?&lt;/p&gt;

&lt;p&gt;You have tried your patch in 0.90?  It makes things better for you?  Maybe we should apply for 0.90.6?&lt;/p&gt;</comment>
                            <comment id="13167018" author="zjushch" created="Sun, 11 Dec 2011 00:45:33 +0000"  >&lt;p&gt;@stack&lt;br/&gt;
you could try the scenario in the following:&lt;br/&gt;
1.kill meta server, and don&apos;t start it&lt;br/&gt;
2.do manual split on all other regionservers&lt;/p&gt;

&lt;p&gt;In step1, the .meta. is redeployed after 3 minutes in default&#65292;&lt;br/&gt;
so in step2, the retry time at least 3 minutes&#65292;otherwise server will abort.&lt;/p&gt;

&lt;p&gt;Howerver, in 0.90, because of no retry, server must abort itself.&lt;/p&gt;

&lt;p&gt;The PONR is used to prevent data loss when failed updating meta. But if we are sure the .meta. is not updated, the PONR is not needed in fact. It is what the patch doing.&lt;/p&gt;

&lt;p&gt;we have tried in 0.90 for the patch&#65292; if meta server crash before doing OfflineParentInMeta, the server will not abort when rolling back.&lt;/p&gt;</comment>
                            <comment id="13182547" author="sunnygao" created="Mon, 9 Jan 2012 15:16:50 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Good job!  &lt;/p&gt;</comment>
                            <comment id="13182548" author="ram_krish" created="Mon, 9 Jan 2012 15:17:54 +0000"  >&lt;p&gt;+1.  Myself and Gao had a review on this. &lt;/p&gt;</comment>
                            <comment id="13185965" author="stack" created="Fri, 13 Jan 2012 23:07:25 +0000"  >&lt;p&gt;@Ram should this go into 0.90.6?  I&apos;m fine w/ this in 0.90 branch.&lt;/p&gt;</comment>
                            <comment id="15671637" author="stack" created="Wed, 16 Nov 2016 21:07:28 +0000"  >&lt;p&gt;Patch for 0.90.&lt;br/&gt;
Won&apos;t have this issue in 2.0.&lt;br/&gt;
Reopen if issue in more modern hbase.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12506700" name="hbase-4988v1.patch" size="6133" author="zjushch" created="Fri, 9 Dec 2011 03:10:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 9 Dec 2011 05:58:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>220146</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02dx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11856</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>