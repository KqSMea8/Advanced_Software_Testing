<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:09:25 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3343/HBASE-3343.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3343] Server not shutting down after losing log lease</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3343</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Ran into this bug testing 0.90rc2. I kill -STOPed a server, and then -CONT it after its logs had been split. It correctly decided it should abort, but got stuck during the shutdown process.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12493114">HBASE-3343</key>
            <summary>Server not shutting down after losing log lease</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="tlipcon">Todd Lipcon</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Dec 2010 19:48:56 +0000</created>
                <updated>Fri, 20 Nov 2015 12:41:09 +0000</updated>
                            <resolved>Tue, 21 Dec 2010 05:32:50 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12970998" author="tlipcon" created="Mon, 13 Dec 2010 19:51:57 +0000"  >&lt;p&gt;Attaching logs and jstack&lt;/p&gt;</comment>
                            <comment id="12971982" author="stack" created="Thu, 16 Dec 2010 06:58:05 +0000"  >&lt;p&gt;Bringing into 0.90.  Looking at stacktrace, we&apos;re waiting on all our regions to be closed before we&apos;ll go down.  I&apos;ve seen this before where a split would come in mid-close down messing up our shutdown process.  This looks like a spin on that theme.  Hopefully the logs will have what was missed.  Will take a look.&lt;/p&gt;</comment>
                            <comment id="12973438" author="jdcryans" created="Tue, 21 Dec 2010 01:12:29 +0000"  >&lt;p&gt;The issue with TestMetaReaderEditor and what I hope is the same here is that we interrupt the OpenRegionHandler but don&apos;t really handle it inside that thread. Here&apos;s an example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-12-20 16:41:53,327 DEBUG [RS_OPEN_REGION-h38.sfo.stumble.net,63068,1292892076786-2]
 handler.OpenRegionHandler(160): Interrupting thread Thread[PostOpenDeployTasks:3d9e86152e5e75258c19d64d4ddb1a4a,5,main]

2010-12-20 16:41:53,327 DEBUG [RS_OPEN_REGION-h38.sfo.stumble.net,63068,1292892076786-2]
 zookeeper.ZKAssign(660): regionserver:63068-0x12d065f78360002 Attempting to transition node 3d9e86152e5e75258c19d64d4ddb1a4a
 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENED

2010-12-20 16:41:53,328 WARN  [PostOpenDeployTasks:3d9e86152e5e75258c19d64d4ddb1a4a]
 handler.OpenRegionHandler$PostOpenDeployTasksThread(195):
 Exception running postOpenDeployTasks; region=3d9e86152e5e75258c19d64d4ddb1a4a
java.nio.channels.ClosedByInterruptException
        at java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:184)
...
        at org.apache.hadoop.hbase.ipc.HBaseRPC$Invoker.invoke(HBaseRPC.java:257)
        at $Proxy12.get(Unknown Source)
        at org.apache.hadoop.hbase.catalog.MetaReader.readLocation(MetaReader.java:286)
        at org.apache.hadoop.hbase.catalog.MetaReader.readMetaLocation(MetaReader.java:262)
        at org.apache.hadoop.hbase.catalog.CatalogTracker.getMetaServerConnection(CatalogTracker.java:279)
        at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMeta(CatalogTracker.java:322)
        at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMetaServerConnectionDefault(CatalogTracker.java:362)
        at org.apache.hadoop.hbase.catalog.MetaEditor.updateRegionLocation(MetaEditor.java:146)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.postOpenDeployTasks(HRegionServer.java:1331)
        at org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler$PostOpenDeployTasksThread.run(OpenRegionHandler.java:192)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the region stays opened and the region server will wait on it forever.&lt;/p&gt;</comment>
                            <comment id="12973449" author="jdcryans" created="Tue, 21 Dec 2010 02:04:15 +0000"  >&lt;p&gt;Testing more I saw also a different error:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-12-20 18:01:54,211 ERROR [RS_OPEN_REGION-h38.sfo.stumble.net,50228,1292896899873-0]
 executor.EventHandler(154): Caught throwable while processing event M_RS_OPEN_REGION
java.lang.NullPointerException        at org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler.updateMeta(OpenRegionHandler.java:166)
        at org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler.process(OpenRegionHandler.java:98)
        at org.apache.hadoop.hbase.executor.EventHandler.run(EventHandler.java:151)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.Thread.run(Thread.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12973451" author="jdcryans" created="Tue, 21 Dec 2010 02:06:22 +0000"  >&lt;p&gt;/me dumb, it&apos;s my own debug that NPEs. Move along.&lt;/p&gt;</comment>
                            <comment id="12973462" author="jdcryans" created="Tue, 21 Dec 2010 03:22:05 +0000"  >&lt;p&gt;This patch closes 2 holes and fixes one NPE. We were racing between the main OpenRegionHandler thread and PostOpenDeployTasksThread after interrupting it. It now works reliably for me.&lt;/p&gt;</comment>
                            <comment id="12973471" author="stack" created="Tue, 21 Dec 2010 05:20:26 +0000"  >&lt;p&gt;@jdcryans +1 on your patch though its addressing other than whats in this log; log is about an aborted server not going down.  Code looks like this in the abort processing:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
....
 629     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.killed) {
 630       &lt;span class=&quot;code-comment&quot;&gt;// Just skip out w/o closing regions.
&lt;/span&gt; 631     } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (abortRequested) {
 632       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fsOk) {
 633         closeAllRegions(abortRequested); &lt;span class=&quot;code-comment&quot;&gt;// Don&apos;t leave any open file handles
&lt;/span&gt; 634         closeWAL(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
 635       }
 636       LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;aborting server at: &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverInfo.getServerName());
 637     } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
 638       closeAllRegions(abortRequested);
 639       closeWAL(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
 640       closeAllScanners();
 641       LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;stopping server at: &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverInfo.getServerName());
 642     }
 643     &lt;span class=&quot;code-comment&quot;&gt;// Interrupt catalog tracker here in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; any regions being opened out in
&lt;/span&gt; 644     &lt;span class=&quot;code-comment&quot;&gt;// handlers are stuck waiting on meta or root.
&lt;/span&gt; 645     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.stop();
 646     waitOnAllRegionsToClose();
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... so if an abort is requested AND the fs is NOT OK, then we won&apos;t close regions... we just skip out.  ONLY, we then fall into waitOnAllRegionsToClose on line #646 above which will never complete because we didn&apos;t do close on regions.&lt;/p&gt;

&lt;p&gt;I think simplest fix is adding this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 646     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fsOK) waitOnAllRegionsToClose();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Let me commit your patch and mine together.&lt;/p&gt;




</comment>
                            <comment id="12973473" author="stack" created="Tue, 21 Dec 2010 05:27:03 +0000"  >&lt;p&gt;Oh, I forgot, here are the snippets from Todd&apos;s log that show fsok being set to false followed by the abort processing:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
12596 2010-12-13 11:43:46,460 FATAL org.apache.hadoop.hbase.regionserver.HRegionServer: ABORTING region server serverName=haus03.sf.cloudera.com,60020,1292269332749, load=(requests=894, regions=6, usedHeap=2039, maxHeap=8185): File &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt; not available
12597 java.io.IOException: File system is not available
....
17936 2010-12-13 11:43:46,535 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: aborting server at: haus03.sf.cloudera.com,60020,1292269332749
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12973474" author="stack" created="Tue, 21 Dec 2010 05:32:13 +0000"  >&lt;p&gt;Here&apos;s what I applied to trunk and branch (applied it so it would build up on hudson over night.... we&apos;ll see how it is morning).&lt;/p&gt;</comment>
                            <comment id="12973475" author="stack" created="Tue, 21 Dec 2010 05:32:50 +0000"  >&lt;p&gt;Committed to branch and trunk. &lt;/p&gt;</comment>
                            <comment id="12974507" author="hudson" created="Thu, 23 Dec 2010 04:31:46 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1697 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/HBase-TRUNK/1697/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/HBase-TRUNK/1697/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="15016895" author="lars_francke" created="Fri, 20 Nov 2015 12:41:09 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12466681" name="3343-v2.patch" size="2788" author="stack" created="Tue, 21 Dec 2010 05:32:13 +0000"/>
                            <attachment id="12466678" name="HBASE-3343.patch" size="1727" author="jdcryans" created="Tue, 21 Dec 2010 03:22:05 +0000"/>
                            <attachment id="12466164" name="shutdown-logs.txt.bz2" size="20875" author="tlipcon" created="Mon, 13 Dec 2010 19:51:57 +0000"/>
                            <attachment id="12466165" name="stuck-server.txt" size="8848" author="tlipcon" created="Mon, 13 Dec 2010 19:51:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 16 Dec 2010 06:58:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26792</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hluf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100801</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>