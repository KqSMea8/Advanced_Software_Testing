<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:05:32 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2881/HBASE-2881.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2881] TestAdmin intermittent failures: Race condition during createTable can result in region double assignment</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2881</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The TestAdmin test fails on trunk intermittently because it is unable to &quot;enable&quot; a &quot;disabled&quot; table. However, the root cause seems to be that much earlier, at &quot;createTable&quot; time the table&apos;s region got assigned to 2 region servers. And this later confuses the &quot;disable&quot;/&quot;enable&quot; code.&lt;/p&gt;

&lt;p&gt;createTable goes down to RegionManager.java:createRegion:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void createRegion(HRegionInfo newRegion, HRegionInterface server,
      &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] metaRegionName)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-comment&quot;&gt;// 2. Create the HRegion
&lt;/span&gt;    HRegion region = HRegion.createHRegion(newRegion, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.getRootDir(),
      master.getConfiguration());

    &lt;span class=&quot;code-comment&quot;&gt;// 3. Insert into meta
&lt;/span&gt;    HRegionInfo info = region.getRegionInfo();
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] regionName = region.getRegionName();

    Put put = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Put(regionName);
    put.add(HConstants.CATALOG_FAMILY, HConstants.REGIONINFO_QUALIFIER,
        Writables.getBytes(info));
    server.put(metaRegionName, put);

    &lt;span class=&quot;code-comment&quot;&gt;// 4. Close the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; region to flush it to disk.  Close its log file too.
&lt;/span&gt;    region.close();
    region.getLog().closeAndDelete();

    &lt;span class=&quot;code-comment&quot;&gt;// 5. Get it assigned to a server
&lt;/span&gt;    setUnassigned(info, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Between, after #3, but before #5, if the MetaScanner runs, it&apos;ll find this region in unassigned state and also assign it out.&lt;/p&gt;

&lt;p&gt;And then #5 comes along at again &quot;force&quot; sets this region to be unassigned... causing it to get assigned again to a different region server (as part of the RegionManager&apos;s job of assigning out regions waiting to be assigned along with region server heart beats).&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;The test in question that diffs is TestAdmin:testHundredsOfTable(). I tried repro&apos;ing this more reliable by modifying the test to have the metascanner run more frequently:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  TEST_UTIL.getConfiguration().setInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.master.meta.thread.rescanfrequency&quot;&lt;/span&gt;, 1000);&lt;span class=&quot;code-comment&quot;&gt;// 1 seconds&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(instead of the default 60seconds); but it didn&apos;t help improve the reproducibility.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12470225">HBASE-2881</key>
            <summary>TestAdmin intermittent failures: Race condition during createTable can result in region double assignment</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="streamy">Jonathan Gray</assignee>
                                    <reporter username="kannanm">Kannan Muthukkaruppan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Jul 2010 03:01:39 +0000</created>
                <updated>Mon, 6 Dec 2010 21:05:13 +0000</updated>
                            <resolved>Mon, 6 Dec 2010 21:05:13 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12892626" author="kannanm" created="Tue, 27 Jul 2010 03:10:14 +0000"  >&lt;p&gt;While this is somewhat similar to other double-assignment JIRA (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2755&quot; title=&quot;Duplicate assignment of a region after region server recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2755&quot;&gt;&lt;del&gt;HBASE-2755&lt;/del&gt;&lt;/a&gt;),  filing this as a separate issue since the race conditions in the two cases are in different parts of the code. &lt;/p&gt;

&lt;p&gt;(If Jonathan&apos;s rewrite is in place, the single fix, of eliminating meta scanner based region assignments, would address both issues. But in case, for some reason, that runs into complications, we&apos;ll need point fixes for each of the issues. So better to track this as a separate issue).&lt;/p&gt;</comment>
                            <comment id="12922179" author="kannanm" created="Mon, 18 Oct 2010 17:59:37 +0000"  >&lt;p&gt;Note: This doesn&apos;t apply to new master as it doesn&apos;t rely on the base scannner. &lt;/p&gt;

&lt;p&gt;Confirmed in a reproducible manner that the race condition genuinely existed by putting a sleep of 2 mins prior to (step #5) setting the region unassigned in master&apos;s in-memory state. By this time, the base scanner assigns out the new region; and then, setting the region unassigned in master&apos;s state (step 5) after the sleep causes it to get &quot;unassigned&quot; once again, and hence assigned out a second time to a new region server.&lt;/p&gt;

&lt;p&gt;The fix basically no longer sets the newly created region unassigned in the master&apos;s in-memory state. Instead, after updating META (with region marked offline) for all the newly created regions, it simply schedules the meta scanner to be run immediately. So the regions get assigned without delay as before, but without the race condition.&lt;/p&gt;</comment>
                            <comment id="12968410" author="streamy" created="Mon, 6 Dec 2010 21:05:13 +0000"  >&lt;p&gt;Only an issue in 0.20 and 0.89 releases.  Will not be fixed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12457464" name="HBASE-2881_0.89.txt" size="1343" author="kannanm" created="Mon, 18 Oct 2010 17:59:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 6 Dec 2010 21:05:13 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26514</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hjof:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100450</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>