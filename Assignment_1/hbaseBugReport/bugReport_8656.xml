<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:57:17 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8656/HBASE-8656.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8656] Rpc call may not be notified in SecureClient</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8656</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In SecureClient.java, rpc responses will be processed by receiveResponse() which looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; id = in.readInt();                    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to read an id
&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled())
          LOG.debug(getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; got value #&quot;&lt;/span&gt; + id);

        Call call = calls.remove(id);

        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; state = in.readInt();     &lt;span class=&quot;code-comment&quot;&gt;// read call status
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
          LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;call #&quot;&lt;/span&gt;+id+&lt;span class=&quot;code-quote&quot;&gt;&quot; state is &quot;&lt;/span&gt; + state);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == Status.SUCCESS.state) {
          Writable value = ReflectionUtils.newInstance(valueClass, conf);
          value.readFields(in);                 &lt;span class=&quot;code-comment&quot;&gt;// read value
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;call #&quot;&lt;/span&gt;+id+&lt;span class=&quot;code-quote&quot;&gt;&quot;, response is:\n&quot;&lt;/span&gt;+value.toString());
          }
          &lt;span class=&quot;code-comment&quot;&gt;// it&apos;s possible that &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; call may have been cleaned up due to a RPC
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// timeout, so check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it still exists before setting the value.
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (call != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            call.setValue(value);
          }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == Status.ERROR.state) {
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (call != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            call.setException(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RemoteException(WritableUtils.readString(in), WritableUtils
                .readString(in)));
          }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == Status.FATAL.state) {
          &lt;span class=&quot;code-comment&quot;&gt;// Close the connection
&lt;/span&gt;          markClosed(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RemoteException(WritableUtils.readString(in),
                                         WritableUtils.readString(in)));
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SocketTimeoutException &amp;amp;&amp;amp; remoteId.rpcTimeout &amp;gt; 0) {
          &lt;span class=&quot;code-comment&quot;&gt;// Clean up open calls but don&apos;t treat &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; as a fatal condition,
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// since we expect certain responses to not make it by the specified
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// {@link ConnectionId#rpcTimeout}.
&lt;/span&gt;          closeException = e;
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          &lt;span class=&quot;code-comment&quot;&gt;// Since the server did not respond within the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; ping interval
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// time, treat &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; as a fatal condition and close &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; connection
&lt;/span&gt;          markClosed(e);
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (remoteId.rpcTimeout &amp;gt; 0) {
          cleanupCalls(remoteId.rpcTimeout);
        }
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In above code, in the try block, the call will be firstly removed from call map by:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        Call call = calls.remove(id);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;There may be two cases leading the call couldn&apos;t be notified and the invoking thread will wait forever. &lt;br/&gt;
Firstly, if the returned status is Status.FATAL.state by:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; state = in.readInt();     &lt;span class=&quot;code-comment&quot;&gt;// read call status&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The code will come into:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == Status.FATAL.state) {
          &lt;span class=&quot;code-comment&quot;&gt;// Close the connection
&lt;/span&gt;          markClosed(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RemoteException(WritableUtils.readString(in),
                                         WritableUtils.readString(in)));
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here, the SecureConnection is marked as closed and all rpc calls in call map of this connection will be notified to receive an exception. However, the current rpc call has been removed from the call map, it won&apos;t be notified.&lt;br/&gt;
Secondly, after the call has been removed by:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        Call call = calls.remove(id);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If we encounter any exception before the &apos;try&apos; block finished, the code will come into &apos;catch&apos; and &apos;finally&apos; block, neither &apos;catch&apos; block nor &apos;finally&apos; block will notify the rpc call because it has been removed from call map.&lt;br/&gt;
Compared with receiveResponse() in HBaseClient.java, it may be better to get the rpc call from call map and remove it at the end of the &apos;try&apos; block.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12650116">HBASE-8656</key>
            <summary>Rpc call may not be notified in SecureClient</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cuijianwei">Jianwei Cui</assignee>
                                    <reporter username="cuijianwei">Jianwei Cui</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 May 2013 10:04:51 +0000</created>
                <updated>Thu, 4 Jul 2013 22:10:03 +0000</updated>
                            <resolved>Mon, 24 Jun 2013 20:52:24 +0000</resolved>
                                    <version>0.94.7</version>
                                    <fixVersion>0.94.9</fixVersion>
                                    <component>Client</component>
                    <component>IPC/RPC</component>
                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                <comments>
                            <comment id="13672066" author="apurtell" created="Sat, 1 Jun 2013 11:46:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cuijianwei&quot; class=&quot;user-hover&quot; rel=&quot;cuijianwei&quot;&gt;Jianwei Cui&lt;/a&gt; are you testing a patch for this? Do you plan on posting it? Or would you like a patch/change provided here?&lt;/p&gt;</comment>
                            <comment id="13672323" author="cuijianwei" created="Sun, 2 Jun 2013 05:58:14 +0000"  >&lt;p&gt;Firstly get call, remove it after being processed.&lt;/p&gt;</comment>
                            <comment id="13672324" author="cuijianwei" created="Sun, 2 Jun 2013 06:03:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.purtell%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;andrew.purtell@gmail.com&quot;&gt;Andrew Purtell&lt;/a&gt;, Thanks for your comment. I make a patch and test it for the following two cases. &lt;br/&gt;
Firstly, we modify the region server code to return Status.FATAL to SecureClient; Secondly, we only return call id in the response to make SecureClient receive a SocketTimeout exception after removing call. In both cases, the SecureClient won&apos;t notify the waiting call before apply the patch. After applying the patch, it seems ok for the two cases.&lt;/p&gt;</comment>
                            <comment id="13672794" author="stack" created="Mon, 3 Jun 2013 03:45:58 +0000"  >&lt;p&gt;We do not have this issue in trunk/0.95?&lt;/p&gt;</comment>
                            <comment id="13672800" author="cuijianwei" created="Mon, 3 Jun 2013 03:57:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=saint.ack%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;saint.ack@gmail.com&quot;&gt;Stack&lt;/a&gt;, in trunk/0.95, SecureClient may be replaced by HBaseSaslRpcClient. The code changes a lot, I&apos;am not sure whether HBaseSaslRpcClient has the same problem.&lt;/p&gt;</comment>
                            <comment id="13673080" author="apurtell" created="Mon, 3 Jun 2013 12:51:44 +0000"  >&lt;p&gt;0.94 patch lgtm, trying it out.&lt;/p&gt;</comment>
                            <comment id="13678921" author="cuijianwei" created="Sun, 9 Jun 2013 03:14:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.purtell%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;andrew.purtell@gmail.com&quot;&gt;Andrew Purtell&lt;/a&gt;, sorry for replying late, I run unit tests for this 0.94 patch, it seems ok. Can we run this patch for 0.94?&lt;/p&gt;</comment>
                            <comment id="13678956" author="apurtell" created="Sun, 9 Jun 2013 07:01:45 +0000"  >&lt;p&gt;Unit tests passed for me also, but for the most part they don&apos;t cover secure RPC. The patch looks good. Have not had a chance yet to test on a cluster in a secure configuration. &lt;/p&gt;</comment>
                            <comment id="13678960" author="aoxiang" created="Sun, 9 Jun 2013 07:09:42 +0000"  >&lt;p&gt;+1, LGTM.&lt;/p&gt;</comment>
                            <comment id="13690724" author="lhofhansl" created="Fri, 21 Jun 2013 21:12:31 +0000"  >&lt;p&gt;+1 on patch. Makes sense and brings it (more) in line with HBaseClient.&lt;/p&gt;</comment>
                            <comment id="13690726" author="lhofhansl" created="Fri, 21 Jun 2013 21:12:52 +0000"  >&lt;p&gt;Not critical, though.&lt;/p&gt;</comment>
                            <comment id="13691785" author="lhofhansl" created="Mon, 24 Jun 2013 08:26:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; Did you get a chance to test this? Patch looks good, in line with the non-secure client.&lt;br/&gt;
If not, I&apos;ll just push to 0.94.10.&lt;/p&gt;</comment>
                            <comment id="13692229" author="lhofhansl" created="Mon, 24 Jun 2013 18:37:57 +0000"  >&lt;p&gt;Let&apos;s push to 0.94.10.&lt;br/&gt;
As the 0.94 release are starting to get smaller I&apos;ll try to have a release every 4 weeks.&lt;/p&gt;</comment>
                            <comment id="13692342" author="apurtell" created="Mon, 24 Jun 2013 20:27:40 +0000"  >&lt;p&gt;Sorry, yes I was able to do some light cluster testing and didn&apos;t see any problems.&lt;/p&gt;</comment>
                            <comment id="13692470" author="hudson" created="Mon, 24 Jun 2013 22:27:50 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #1024 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/1024/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/1024/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8656&quot; title=&quot;Rpc call may not be notified in SecureClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8656&quot;&gt;&lt;del&gt;HBASE-8656&lt;/del&gt;&lt;/a&gt; Rpc call may not be notified in SecureClient (cuijianwei) (Revision 1496216)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureClient.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12597031">HBASE-6313</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12585747" name="HBASE-8656-0.94-v1.txt" size="1858" author="cuijianwei" created="Sun, 2 Jun 2013 05:58:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 1 Jun 2013 11:46:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>330443</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 25 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1l0br:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>330777</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>