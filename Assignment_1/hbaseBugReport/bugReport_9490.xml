<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:04:56 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-9490/HBASE-9490.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-9490] Provide independent execution environment for small tests</title>
                <link>https://issues.apache.org/jira/browse/HBASE-9490</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Some of the state related to schema metrics is stored in static variables and since the small test cases are run in a single jvm, it is causing random behavior in the output of the tests.&lt;/p&gt;

&lt;p&gt;An example scenario is the test case failures in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8930&quot; title=&quot;Filter evaluates KVs outside requested columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8930&quot;&gt;&lt;del&gt;HBASE-8930&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SchemaMetrics cfm : tableAndFamilyToMetrics.values()) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (metricName.startsWith(CF_PREFIX + CF_PREFIX)) {
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AssertionError(&lt;span class=&quot;code-quote&quot;&gt;&quot;Column family prefix used twice: &quot;&lt;/span&gt; +
              metricName);
        }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above code throws an error when the metric name starts with &quot;cf.cf.&quot;. It would be helpful if any one sheds some light on the reason behind checking for &quot;cf.cf.&quot;&lt;/p&gt;

&lt;p&gt;The scenarios in which we would have a metric name start with &quot;cf.cf.&quot; are as follows (See generateSchemaMetricsPrefix method of SchemaMetrics)&lt;/p&gt;

&lt;p&gt;a) The column family name should be &quot;cf&quot;&lt;/p&gt;

&lt;p&gt;AND&lt;/p&gt;

&lt;p&gt;b) The table name is either &quot;&quot; or use table name globally should be false (useTableNameGlobally variable of SchemaMetrics).&lt;br/&gt;
Table name is empty only in the case of ALL_SCHEMA_METRICS which has the column family as &quot;&quot;. So we could rule out the&lt;br/&gt;
possibility of the table name being empty.&lt;/p&gt;

&lt;p&gt;Also to note, the variables &quot;useTableNameGlobally&quot; and &quot;tableAndFamilyToMetrics&quot; of SchemaMetrics are static and are shared across all the tests that run in a single jvm. In our case, the profile runAllTests has the below configuration&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &amp;lt;surefire.firstPartForkMode&amp;gt;once&amp;lt;/surefire.firstPartForkMode&amp;gt;
        &amp;lt;surefire.firstPartParallel&amp;gt;none&amp;lt;/surefire.firstPartParallel&amp;gt;
        &amp;lt;surefire.firstPartThreadCount&amp;gt;1&amp;lt;/surefire.firstPartThreadCount&amp;gt;
      &amp;lt;surefire.firstPartGroups&amp;gt;org.apache.hadoop.hbase.SmallTests&amp;lt;/surefire.firstPartGroups&amp;gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Hence all of our small tests run in a single jvm and share the above variables &quot;useTableNameGlobally&quot; and &quot;tableAndFamilyToMetrics&quot;.&lt;/p&gt;

&lt;p&gt;The reasons why the order of execution of the tests caused this failure are as follows&lt;/p&gt;

&lt;p&gt;a) A bunch of small tests like TestMemStore, TestSchemaConfiguredset set the useTableNameGlobally to false. But these tests don&apos;t create tables that have the column family name as &quot;cf&quot;.&lt;/p&gt;

&lt;p&gt;b) If the tests in step (a) run before the tests which create table/regions with column family &apos;cf&apos;, metric names would start with &quot;cf.cf.&quot;&lt;/p&gt;

&lt;p&gt;c) If any of other tests, like the failed tests(TestScannerSelectionUsingTTL, TestHFileReaderV1, TestScannerSelectionUsingKeyRange), validate schema metrics, they would fail as the metric names start with &quot;cf.cf.&quot;&lt;/p&gt;

&lt;p&gt;On my local machine, I have tried to re-create the failure scenario by changing the sure fire test configuration and creating a simple (TestSimple) which just creates a region for the table &apos;testtable&apos; and column family &apos;cf&apos;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
TestSimple.java
------------------------------------------------------------------
  @Before
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setUp() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    HTableDescriptor htd = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTableDescriptor(TABLE_NAME_BYTES);
    htd.addFamily(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HColumnDescriptor(FAMILY_NAME_BYTES));
    HRegionInfo info = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HRegionInfo(TABLE_NAME_BYTES, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.region = HRegion.createHRegion(info, TEST_UTIL.getDataTestDir(),
        TEST_UTIL.getConfiguration(), htd);

    Put put = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Put(ROW_BYTES);
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 10; i += 2) {
      &lt;span class=&quot;code-comment&quot;&gt;// puts 0, 2, 4, 6 and 8
&lt;/span&gt;      put.add(FAMILY_NAME_BYTES, Bytes.toBytes(QUALIFIER_PREFIX + i), i,
          Bytes.toBytes(VALUE_PREFIX + i));
    }
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.region.put(put);
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.region.flushcache();
  }

  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testFilterInvocation() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;testing&quot;&lt;/span&gt;);
  }

  @After
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void tearDown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    HLog hlog = region.getLog();
    region.close();
    hlog.closeAndDelete();
  }

Successful run:

-------------------------------------------------------
 T E S T S
-------------------------------------------------------
2013-09-09 15:38:03.478 java[46562:db03] Unable to load realm mapping info from SCDynamicStore
Running org.apache.hadoop.hbase.filter.TestSimple
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.342 sec
Running org.apache.hadoop.hbase.io.hfile.TestHFileReaderV1
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.085 sec
Running org.apache.hadoop.hbase.io.hfile.TestScannerSelectionUsingKeyRange
Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.217 sec
Running org.apache.hadoop.hbase.io.hfile.TestScannerSelectionUsingTTL
Tests run: 6, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 12.618 sec
Running org.apache.hadoop.hbase.regionserver.TestMemStore
Tests run: 24, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 26.542 sec

Results :

Tests run: 35, Failures: 0, Errors: 0, Skipped: 0
------------------------------------------------------------------

Failed run order:

-------------------------------------------------------
 T E S T S
-------------------------------------------------------
2013-09-09 15:43:21.466 java[46890:db03] Unable to load realm mapping info from SCDynamicStore
Running org.apache.hadoop.hbase.regionserver.TestMemStore
Tests run: 24, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 11.967 sec
Running org.apache.hadoop.hbase.io.hfile.TestScannerSelectionUsingTTL
Tests run: 6, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 12.659 sec
Running org.apache.hadoop.hbase.io.hfile.TestScannerSelectionUsingKeyRange
Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.15 sec
Running org.apache.hadoop.hbase.filter.TestSimple
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.031 sec
Running org.apache.hadoop.hbase.io.hfile.TestHFileReaderV1
Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 24.883 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!

Results :

Failed tests:   testReadingExistingVersion1HFile(org.apache.hadoop.hbase.io.hfile.TestHFileReaderV1): Column family prefix used twice: cf.cf.bt.Data.fsReadnumops

Tests run: 35, Failures: 1, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the failed scenario, the below has happened&lt;/p&gt;

&lt;p&gt;a) TestMemStore sets the useTableNameGlobally to false&lt;/p&gt;

&lt;p&gt;b) TestScannerSelectionUsingKeyRange, TestScannerSelectionUsingKeyRange are successful as they don&apos;t create table with column family name &quot;cf&quot;&lt;/p&gt;

&lt;p&gt;c) TestSimple creates a region for table &apos;testtable&apos; and column family &apos;cf&apos;. Since useTableNameGlobally is set to false, it would create metric names that start with &quot;cf.cf.&quot;&lt;/p&gt;

&lt;p&gt;d) TestHFileReaderV1 while validating metrics would fail as the metric names start with &quot;cf.cf.&quot;&lt;/p&gt;

&lt;p&gt;The reason why this has been exposed due to this patch is because TestSimple is TestInvocationRecordFilter. The executions of the build 1136, 1137 and 1138 which have been executed after this patch have a different order of executions when compared to the failed builds 1139 &amp;amp; 1140.&lt;/p&gt;

&lt;p&gt;One simple fix to address the issue would have been to change the column family name from &quot;cf&quot; to &quot;mycf&quot; in the TestInvocationRecordFilter. But to avoid future occurrences of these issues, I would suggest setting the &quot;surefire.firstPartForkMode&quot; to &quot;always&quot; similar to the settings we use while running localTests, medium &amp;amp; large tests.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12667739">HBASE-9490</key>
            <summary>Provide independent execution environment for small tests</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="vmariyala">Vasu Mariyala</assignee>
                                    <reporter username="vmariyala">Vasu Mariyala</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Sep 2013 05:19:06 +0000</created>
                <updated>Tue, 10 Sep 2013 07:53:28 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13762742" author="vmariyala" created="Tue, 10 Sep 2013 05:21:08 +0000"  >&lt;p&gt;The following are the solutions&lt;/p&gt;

&lt;p&gt;a) Change the category of the tests which change the static variables to medium category (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; suggestion)&lt;/p&gt;

&lt;p&gt;b) Change the tests to run in different jvm&apos;s. (3:05.855s vs 5:09.840s on my local machine). Currently with -PlocalTests, it always runs the small tests in a different jvm. So the time increase would mostly be in the build machine.&lt;/p&gt;</comment>
                            <comment id="13762753" author="lhofhansl" created="Tue, 10 Sep 2013 05:32:24 +0000"  >&lt;p&gt;Sharing the small tests was by design. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkeywal&quot; class=&quot;user-hover&quot; rel=&quot;nkeywal&quot;&gt;Nicolas Liochon&lt;/a&gt; made it so for performance. Let&apos;s not undo that.&lt;br/&gt;
If some of the tests cannot share a JVM they should be fixed or changed to medium tests.&lt;/p&gt;</comment>
                            <comment id="13762830" author="nkeywal" created="Tue, 10 Sep 2013 07:53:28 +0000"  >&lt;p&gt;Yes. We should try to have as much &quot;real unit tests&quot; as possible. A real unit tests being something that can work in parallel with the other tests. That&apos;s a continuous effort, difficult to do, but necessary if we want to limit our test time. Agreed, there is not much individual &amp;amp; short term incentive &lt;/p&gt;

&lt;p&gt;Surefire now supports reuse fork, this would allow to parallelize the small tests at no cost. Surefire 2.15 was not working with HBase, but the 2.16 is now available. If you can give it a try it would be great (see the old patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4955&quot; title=&quot;Use the official versions of surefire &amp;amp; junit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4955&quot;&gt;&lt;del&gt;HBASE-4955&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;-PlocalTests should be used only to run a subset of tests. Even on your local machine, you should run the tests in parallel (and usually your dev machine will be more powerful than the apache build machine). This is explained in the hbase book, 16.7.3.5. Running tests faster).&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12602291" name="0.94-Independent-Test-Execution.patch" size="971" author="vmariyala" created="Tue, 10 Sep 2013 05:31:54 +0000"/>
                            <attachment id="12602292" name="0.96-trunk-Independent-Test-Execution.patch" size="1033" author="vmariyala" created="Tue, 10 Sep 2013 05:31:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 10 Sep 2013 05:32:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347676</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 14 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ny9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347975</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>