<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:15:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4081/HBASE-4081.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4081] Issues with HRegion.compactStores methods</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4081</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;HRegion.java,&lt;/p&gt;

&lt;p&gt;  byte [] compactStores(final boolean majorCompaction)&lt;br/&gt;
  throws IOException {&lt;br/&gt;
    if (majorCompaction) &lt;/p&gt;
{
      this.triggerMajorCompaction();
    }
&lt;p&gt;    return compactStores();&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;  /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Compact all the stores and return the split key of the first store that needs&lt;/li&gt;
	&lt;li&gt;to be split.&lt;br/&gt;
   */&lt;br/&gt;
  public byte[] compactStores() throws IOException {&lt;br/&gt;
    for(Store s : getStores().values()) {&lt;br/&gt;
      CompactionRequest cr = s.requestCompaction();&lt;br/&gt;
      if(cr != null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {        try {
          compact(cr);
        } finally {
          s.finishRequest(cr);
        }      }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;      byte[] splitRow = s.checkSplit();&lt;br/&gt;
      if (splitRow != null) &lt;/p&gt;
{
        return splitRow;
      }
&lt;p&gt;    }&lt;br/&gt;
    return null;&lt;br/&gt;
  }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1. It seems the second method&apos;s intention is to compact all the stores. However, if a store requires split, the process will stop.&lt;br/&gt;
2. Only MetaUtils, HRegion.merge, HRegion.processTable use these two methods. No caller uses the return value.&lt;br/&gt;
3. HRegion.merge expects major compaction for each store after the call and has code like below to check error condition.&lt;/p&gt;

&lt;p&gt;      // Because we compacted the source regions we should have no more than two&lt;br/&gt;
      // HStoreFiles per family and there will be no reference store&lt;br/&gt;
      if (srcFiles.size() == 2)&lt;/p&gt;


&lt;p&gt;So it seems like the fixes are: a) take out s.CheckSplit() call inside compactStores. b) make the return type &quot;void&quot; for these two compactStores functions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12513315">HBASE-4081</key>
            <summary>Issues with HRegion.compactStores methods</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mingma">Ming Ma</assignee>
                                    <reporter username="mingma">Ming Ma</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Jul 2011 23:35:45 +0000</created>
                <updated>Fri, 20 Nov 2015 11:55:18 +0000</updated>
                            <resolved>Mon, 15 Aug 2011 22:40:14 +0000</resolved>
                                                    <fixVersion>0.92.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13062255" author="yuzhihong@gmail.com" created="Fri, 8 Jul 2011 23:47:50 +0000"  >&lt;p&gt;It doesn&apos;t hurt to keep the return value.&lt;/p&gt;

&lt;p&gt;According to javadoc:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the split key of the first store that needs to be split
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think call to s.CheckSplit() should be kept. Instead of returning immediately, we can continue iterating Store&apos;s. If we want to honor the above contract, splitRow should be declared outside for loop and used to remember the split key of the first store.&lt;br/&gt;
Since no one is using the return value, we can return the split key of the last store and modify javadoc accordingly.&lt;/p&gt;</comment>
                            <comment id="13062312" author="stack" created="Sat, 9 Jul 2011 04:16:21 +0000"  >&lt;p&gt;@Ming Ma I see Ted&apos;s point (as long as the javadoc is updated) but I could also go your way.  As is the method is &apos;messy&apos; and its method name misleads &amp;#8211; and if no one is using the split return anyways, then, it would make sense to clean it up (This code smells of an incomplete refactoring).&lt;/p&gt;</comment>
                            <comment id="13066152" author="mingma" created="Fri, 15 Jul 2011 19:36:05 +0000"  >&lt;p&gt;Thanks, Stack, Ted.&lt;/p&gt;

&lt;p&gt;1. It looks like there was some code rewrite for compaction and split if we compare trunk and 0.90.2.&lt;br/&gt;
2. compactStores method used to the main method for compaction in 0.90.2. It returns split key to so that split can happen if necessary.&lt;br/&gt;
3. In trunk, it has been rewritten to use thread pool to do compaction and split. There is no need to return split key in normal compaction process. compactStores are there still to support synchronous compaction need by utilities and testing.&lt;/p&gt;

&lt;p&gt;Given these, I basically go with the original proposals and fix it so that test code can get split key with a separate method. Separating compaction and split on method level seems to be cleaner.&lt;/p&gt;</comment>
                            <comment id="13066308" author="stack" created="Fri, 15 Jul 2011 23:42:59 +0000"  >&lt;p&gt;Your breakdown of the evolution of that section of cod sounds right to me Ming Ma.  Go for it.&lt;/p&gt;</comment>
                            <comment id="13066354" author="hudson" created="Sat, 16 Jul 2011 03:07:11 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2035 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2035/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2035/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4081&quot; title=&quot;Issues with HRegion.compactStores methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4081&quot;&gt;&lt;del&gt;HBASE-4081&lt;/del&gt;&lt;/a&gt; Issues with HRegion.compactStores methods&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/coprocessor/TestCoprocessorInterface.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15016444" author="lars_francke" created="Fri, 20 Nov 2015 11:55:18 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12486667" name="HBASE-4081-trunk.patch" size="4467" author="mingma" created="Fri, 15 Jul 2011 19:36:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 8 Jul 2011 23:47:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27162</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hp9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101357</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The fix has been checked in.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>