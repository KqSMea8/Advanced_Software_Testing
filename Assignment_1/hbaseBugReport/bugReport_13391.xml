<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:42:50 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13391/HBASE-13391.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13391] TestRegionObserverInterface frequently failing on branch-1 </title>
                <link>https://issues.apache.org/jira/browse/HBASE-13391</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;TestRegionObserverInterface is frequently failing on branch-1 .&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: Result of org.apache.hadoop.hbase.coprocessor.SimpleRegionObserver$Legacy.getCtPreWALRestore is expected to be 1, while we get 0
	at org.junit.Assert.fail(Assert.java:88)
	at org.junit.Assert.assertTrue(Assert.java:41)
	at org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.verifyMethodResult(TestRegionObserverInterface.java:751)
	at org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.testLegacyRecovery(TestRegionObserverInterface.java:685)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12787860">HBASE-13391</key>
            <summary>TestRegionObserverInterface frequently failing on branch-1 </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Apr 2015 00:35:59 +0000</created>
                <updated>Wed, 12 Aug 2015 23:03:45 +0000</updated>
                            <resolved>Wed, 12 Aug 2015 23:03:45 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14393814" author="apurtell" created="Fri, 3 Apr 2015 00:36:19 +0000"  >&lt;p&gt;Doing a bisect now&lt;/p&gt;</comment>
                            <comment id="14393943" author="apurtell" created="Fri, 3 Apr 2015 02:06:22 +0000"  >&lt;p&gt;Looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12975&quot; title=&quot;Supportable SplitTransaction and RegionMergeTransaction interfaces&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12975&quot;&gt;&lt;del&gt;HBASE-12975&lt;/del&gt;&lt;/a&gt;. I did most testing on master and didn&apos;t see any failures on branch-1 when I ran the suite, however if you run TestRegionObserverInterface often enough it will eventually fail, usually before 10 reps. &lt;/p&gt;

&lt;p&gt;Determined by git bisect with 10 runs of TestRegionObserverInterface per step.&lt;/p&gt;

&lt;p&gt;Let me look into a fix tomorrow.&lt;/p&gt;</comment>
                            <comment id="14395842" author="apurtell" created="Sat, 4 Apr 2015 17:52:44 +0000"  >&lt;p&gt;This appears to be some kind of timing issue, probably with the test. I was able to reproduce this on a Linux box at home but brought the macbook with me on the road. I&apos;ve tried to trigger this ~100 times from the command line with Maven or in the IDE with no success. &lt;/p&gt;</comment>
                            <comment id="14395898" author="apurtell" created="Sat, 4 Apr 2015 19:36:46 +0000"  >&lt;p&gt;I was finally able to reproduce a failure once by introducing some external IO and CPU activity. Attached are logs of TestRegionObserverInterface#testLegacyRecovery for a passing case and a failing case. &lt;/p&gt;

&lt;p&gt;One thing I see is when on line 683 of TestRegionObserverInterface we say &quot;All regions assigned&quot;, in the failing case there is still WAL replay activity ongoing. They haven&apos;t finished yet when we check for WAL related CP method invocations? I thought I&apos;d see if disabling distributed replay would change the behavior of the test:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/hbase-server/src/test/java/org/apache/hadoop/hbase/coprocessor/Test
RegionObserverInterface.java b/hbase-server/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionObserverInterface.java
index 5bd8b19..ba028dc 100644
--- a/hbase-server/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionObserverInterface.java
+++ b/hbase-server/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionObserverInterface.java
@@ -39,6 +39,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.CellUtil;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.Coprocessor;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HBaseTestingUtility;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HColumnDescriptor;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HConstants;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HRegionInfo;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HTableDescriptor;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.KeyValue;
@@ -101,6 +102,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class TestRegionObserverInterface {
     conf.setStrings(CoprocessorHost.REGION_COPROCESSOR_CONF_KEY,
         &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.hadoop.hbase.coprocessor.SimpleRegionObserver&quot;&lt;/span&gt;,
         &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.hadoop.hbase.coprocessor.SimpleRegionObserver$Legacy&quot;&lt;/span&gt;);
+    conf.setBoolean(HConstants.DISTRIBUTED_LOG_REPLAY_KEY, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
 
     util.startMiniCluster();
     cluster = util.getMiniHBaseCluster();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but that causes a different sort of failure:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: Result of org.apache.hadoop.hbase.coprocessor.SimpleRegionObserver$Legacy.getCtPreWALRestore is expected to be 1, while we get 3
	at org.junit.Assert.fail(Assert.java:88)
	at org.junit.Assert.assertTrue(Assert.java:41)
	at org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.verifyMethodResult(TestRegionObserverInterface.java:753)
	at org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.testLegacyRecovery(TestRegionObserverInterface.java:687)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Any thoughts on what might be going on here &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=busbey&quot; class=&quot;user-hover&quot; rel=&quot;busbey&quot;&gt;Sean Busbey&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="14481492" author="busbey" created="Mon, 6 Apr 2015 17:49:49 +0000"  >&lt;p&gt;If there&apos;s still recovery happening then that would explain the &quot;saw 0&quot; failure.Does the test actually attempt to verify that replay is done?&lt;/p&gt;

&lt;p&gt;Is the failure log with distributed log replay off? I&apos;ll have to dig in some to figure out what would lead to seeing 3x the recovery. nothing obvious comes to mind. The part I don&apos;t understand is why we&apos;d get different numbers for the non-legacy and the legacy version, given that they get called in the same loop.&lt;/p&gt;</comment>
                            <comment id="14481502" author="apurtell" created="Mon, 6 Apr 2015 17:57:58 +0000"  >&lt;p&gt;Just to clarify, there are two test failure cases I&apos;ve discussed above:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;An intermittent failure where the timing of a bunch of asynchronous activity is slightly different, so recovery is still happening, and so we see &quot;got 0 expected 1&quot;.&lt;/li&gt;
	&lt;li&gt;If distributed replay is turned off, then we see &quot;got 3 expected 1&quot;&lt;/li&gt;
&lt;/ol&gt;


&lt;blockquote&gt;&lt;p&gt;If there&apos;s still recovery happening then that would explain the &quot;saw 0&quot; failure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is my take.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Does the test actually attempt to verify that replay is done?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It does not appear to, and I think this would fix the problem as reported on this issue&apos;s description.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is the failure log with distributed log replay off? I&apos;ll have to dig in some to figure out what would lead to seeing 3x the recovery.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was thinking that we could turn off distributed replay, to achieve the same aim as adding code to the test to wait for replay to finish. However then the test fails with &quot;got 3 expected 1&quot;. &lt;/p&gt;</comment>
                            <comment id="14481543" author="busbey" created="Mon, 6 Apr 2015 18:17:56 +0000"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Is the failure log with distributed log replay off? I&apos;ll have to dig in some to figure out what would lead to seeing 3x the recovery.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was thinking that we could turn off distributed replay, to achieve the same aim as adding code to the test to wait for replay to finish. However then the test fails with &quot;got 3 expected 1&quot;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think with DLR off it would just expand the window of the race condition, unless the test tries to scan to check that the region is available or something like that. Does the &quot;got 3 expect 1&quot; thing happen on master as well? Sounds like we should break it off into a different jira. If the failure isn&apos;t pressing I&apos;ll take that new jira (barring a shift in severity, I don&apos;t expect to be able to look at it until next week).&lt;/p&gt;</comment>
                            <comment id="14481636" author="apurtell" created="Mon, 6 Apr 2015 18:58:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does the &quot;got 3 expect 1&quot; thing happen on master as well? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Haven&apos;t tried it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Sounds like we should break it off into a different jira.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s fine.&lt;/p&gt;

&lt;p&gt;For this issue, the test is only sleeping, according to comment above the sleep in order to &quot;let the kill soak in&quot;, and then waiting for all regions to be reassigned, but not waiting for replay to finish. We should add a helper to HBaseTestingUtility for that if there isn&apos;t one already and use it in the test. &lt;/p&gt;</comment>
                            <comment id="14481662" author="apurtell" created="Mon, 6 Apr 2015 19:21:50 +0000"  >&lt;p&gt;Also although a bisect implicated &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12975&quot; title=&quot;Supportable SplitTransaction and RegionMergeTransaction interfaces&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12975&quot;&gt;&lt;del&gt;HBASE-12975&lt;/del&gt;&lt;/a&gt; this could also be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12972&quot; title=&quot;Region, a supportable public/evolving subset of HRegion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12972&quot;&gt;&lt;del&gt;HBASE-12972&lt;/del&gt;&lt;/a&gt;. I will audit both diffs for branch-1 and master for any changes that touch replay or recovery state.&lt;/p&gt;</comment>
                            <comment id="14484432" author="apurtell" created="Wed, 8 Apr 2015 00:29:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;will audit both diffs for branch-1 and master for any changes that touch replay or recovery state.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No issues found.&lt;/p&gt;</comment>
                            <comment id="14553452" author="syuanjiang" created="Thu, 21 May 2015 00:59:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;, when testing 1.1 release in Windows environment, both org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.testRecovery and org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.testLegacyRecovery failed frequently.  testLegacyRecovery fails more frequently.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: Result of org.apache.hadoop.hbase.coprocessor.SimpleRegionObserver.getCtPreWALRestore is expected to be 1, while we get 0
	at org.junit.Assert.fail(Assert.java:88)
	at org.junit.Assert.assertTrue(Assert.java:41)
	at org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.verifyMethodResult(TestRegionObserverInterface.java:746)
	at org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.testRecovery(TestRegionObserverInterface.java:630)


java.lang.AssertionError: Result of org.apache.hadoop.hbase.coprocessor.SimpleRegionObserver$Legacy.getCtPreWALRestore is expected to be 1, while we get 0
	at org.junit.Assert.fail(Assert.java:88)
	at org.junit.Assert.assertTrue(Assert.java:41)
	at org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.verifyMethodResult(TestRegionObserverInterface.java:746)
	at org.apache.hadoop.hbase.coprocessor.TestRegionObserverInterface.testLegacyRecovery(TestRegionObserverInterface.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14553500" author="apurtell" created="Thu, 21 May 2015 01:49:54 +0000"  >&lt;p&gt;Yep, we&apos;re not waiting for recovery to complete, just hoping we race behind it so the test passes. These test cases need a redo (or a rip out)&lt;/p&gt;</comment>
                            <comment id="14553654" author="syuanjiang" created="Thu, 21 May 2015 05:34:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; Do you want me to provide a patch to @Ignore these two tests?  Or you will fix them soon.  I can only disable them in branch-1.1.&lt;/p&gt;</comment>
                            <comment id="14554531" author="busbey" created="Thu, 21 May 2015 15:35:50 +0000"  >&lt;p&gt;thanks for the patch! If we&apos;re going to @Ignore the tests, we should do it everywhere. Unless this isn&apos;t flakey on master (I&apos;m guessing we just aren&apos;t looking there yet).&lt;/p&gt;

&lt;p&gt;please file an issue for fixing the tests and then refer to it in the TODO (the issue is fine to be unassigned).&lt;/p&gt;</comment>
                            <comment id="14554739" author="syuanjiang" created="Thu, 21 May 2015 17:57:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13741&quot; title=&quot;Disable TestRegionObserverInterface#testRecovery and testLegacyRecovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13741&quot;&gt;&lt;del&gt;HBASE-13741&lt;/del&gt;&lt;/a&gt; is created and patch attached&lt;/p&gt;</comment>
                            <comment id="14554741" author="syuanjiang" created="Thu, 21 May 2015 17:57:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13741&quot; title=&quot;Disable TestRegionObserverInterface#testRecovery and testLegacyRecovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13741&quot;&gt;&lt;del&gt;HBASE-13741&lt;/del&gt;&lt;/a&gt; is used to disable test - we can use this JIRA to fix the issue.&lt;/p&gt;</comment>
                            <comment id="14589029" author="ndimiduk" created="Tue, 16 Jun 2015 23:47:01 +0000"  >&lt;p&gt;For what it&apos;s worth I haven&apos;t seen this flake recently.&lt;/p&gt;</comment>
                            <comment id="14694375" author="apurtell" created="Wed, 12 Aug 2015 23:03:45 +0000"  >&lt;p&gt;Haven&apos;t seen this for a while&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12831886">HBASE-13741</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12772592">HBASE-12975</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12734343" name="HBASE-13391-ignore2Tests.v1-branch-1.1.patch" size="1254" author="syuanjiang" created="Thu, 21 May 2015 06:33:07 +0000"/>
                            <attachment id="12709435" name="test.log.fail.txt" size="643172" author="apurtell" created="Sat, 4 Apr 2015 19:37:05 +0000"/>
                            <attachment id="12709434" name="test.log.pass.txt" size="678646" author="apurtell" created="Sat, 4 Apr 2015 19:37:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 6 Apr 2015 17:49:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27qev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>