<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:21:27 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4721/HBASE-4721.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4721] Retain Delete Markers after Major Compaction</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4721</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;There is a need to provide long TTLs for delete markers. This is useful when replicating hbase logs from one cluster to another. The receiving cluster shouldn&apos;t compact away the delete markers because the affected key-values might still be on the way.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12529775">HBASE-4721</key>
            <summary>Retain Delete Markers after Major Compaction</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="khemani">Prakash Khemani</assignee>
                                    <reporter username="khemani">Prakash Khemani</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Nov 2011 23:00:33 +0000</created>
                <updated>Sat, 14 Jan 2012 04:49:31 +0000</updated>
                            <resolved>Tue, 29 Nov 2011 20:32:56 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13145629" author="khemani" created="Mon, 7 Nov 2011 17:20:07 +0000"  >&lt;p&gt;I think all we need to do is to retain delete markers even after a major compaction.&lt;/p&gt;

&lt;p&gt;Retaining delete markers beyond the ttl of regular KVs doesn&apos;t make sense to me. Say the regular KV TTL is 1 day. If we keep a delete marker alive for 2 days then the only KVs that it is going to affect are the ones that are older than 2 days and are already expired.&lt;/p&gt;

&lt;p&gt;If we just retain delete markers after every major compaction then the processing becomes exactly the same as in a minor compaction. Hopefully, will reduce some code complexity.&lt;/p&gt;</comment>
                            <comment id="13145688" author="lhofhansl" created="Mon, 7 Nov 2011 18:43:30 +0000"  >&lt;p&gt;Is this not covered with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4536&quot; title=&quot;Allow CF to retain deleted rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4536&quot;&gt;&lt;del&gt;HBASE-4536&lt;/del&gt;&lt;/a&gt;? I.e. just keeping the delete markers will not get you very far, you also have to keep the &quot;deleted&quot; rows (KVs affected by the delete markers).&lt;/p&gt;</comment>
                            <comment id="13145785" author="khemani" created="Mon, 7 Nov 2011 20:46:18 +0000"  >&lt;p&gt;I had started at a point where I thought I will independently assign ttls to delete markers. But now I have realized that it doesn&apos;t make any sense to give a different ttl to the delete-markers. (giving the delete-markers a smaller ttl than the puts will be incorrect. giving them a larger ttl than the puts will be pointless because then the delete-markers will be deleting already expired puts)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4536&quot; title=&quot;Allow CF to retain deleted rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4536&quot;&gt;&lt;del&gt;HBASE-4536&lt;/del&gt;&lt;/a&gt; will work but only if keep-deleted-kvs flag is set on the column family (or is it table?). Do you think it makes sense to make it the default behavior that regardless of whether point-in-time queries are being supported or not, major compaction will not remove the delete-markers? A delete-marker will only be removed when it expires or when enough put versions accumulate before it.&lt;/p&gt;

&lt;p&gt;Concerns that people have raised if we stopped removing all delete markers in a major compaction&lt;br/&gt;
(1) Space wastage. I am not sure if this is a big concern.&lt;br/&gt;
(2) The bigger issue is that the user will never be able to insert a Put beyond the delete marker. Today, if the user makes a mistake then the admin can go in, delete the puts, do a major compaction, and then the user can reinsert the correct Puts. This workflow will be nullified if we keep delete-markers even after major compaction.&lt;br/&gt;
(3) Today the user doesn&apos;t even know that there are delete markers. But that will have to change if we start keeping delete-markers beyond major compactions.&lt;/p&gt;

&lt;p&gt;===&lt;br/&gt;
I don&apos;t get the reasoning behind why we need to keep deleted puts when syncing logs from one cluster to another. The problem that I am concerned about is the following&lt;/p&gt;

&lt;p&gt;(1) Delete marker arrives from the source cluster&lt;br/&gt;
(2) major compaction happens on the target cluster which gets rid of the delete marker&lt;br/&gt;
(3) The deleted put arrives from the source cluster. Now that the delete marker is not there, this put will become visible on the target cluster.&lt;/p&gt;

</comment>
                            <comment id="13145918" author="lhofhansl" created="Mon, 7 Nov 2011 22:59:51 +0000"  >&lt;p&gt;Log based replication won&apos;t have any issues with deleted puts, correct.&lt;br/&gt;
I&apos;d be worried about tour concerns (2) and (3) above. In &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4536&quot; title=&quot;Allow CF to retain deleted rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4536&quot;&gt;&lt;del&gt;HBASE-4536&lt;/del&gt;&lt;/a&gt; I spent a great deal of effort to be able to remove delete markers as soon as possible.&lt;/p&gt;

&lt;p&gt;Interestingly &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4536&quot; title=&quot;Allow CF to retain deleted rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4536&quot;&gt;&lt;del&gt;HBASE-4536&lt;/del&gt;&lt;/a&gt; would not help with the problem you outline. Column and Version delete markers are version counted (they inherit the version of the last puts that sorts before them), and eventually removed just like normal puts.&lt;br/&gt;
Family delete markers, however, are not sorted in line with puts and are instead removed during a major compaction if (and only if) there are no puts that they affect in the file, which leads to the same problem if puts arrive later during replication, or if the user makes a mistake and places delete markers in the future.&lt;/p&gt;

&lt;p&gt;Do we need to invent a way to undo delete markers?&lt;/p&gt;</comment>
                            <comment id="13148720" author="tlipcon" created="Fri, 11 Nov 2011 20:40:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Log based replication won&apos;t have any issues with deleted puts, correct.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;With the log-based replication as it&apos;s currently implemented, we don&apos;t have any guarantees that actions arrive in the same order on the target cluster as they were initiated on the source cluster, do we? We might have the following sequence:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;region is hosted on server A on source cluster&lt;/li&gt;
	&lt;li&gt;A row is put (goes in A&apos;s HLog)&lt;/li&gt;
	&lt;li&gt;region closes on A, moves to server B&lt;/li&gt;
	&lt;li&gt;A now enters a long GC pause, or goes down (before the log shipping got the newest records)&lt;/li&gt;
	&lt;li&gt;the row is deleted (goes in B&apos;s HLog)&lt;/li&gt;
	&lt;li&gt;replication receives the delete from B&apos;s HLog before the put from A&apos;s HLog&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To prevent this, the log-based replication needs to do something to achieve better transactional ordering when re-applying the edits on the target cluster. Or, we need something like we&apos;re discussing which allows the delete to be retained for some period of time.&lt;/p&gt;</comment>
                            <comment id="13148728" author="lhofhansl" created="Fri, 11 Nov 2011 20:55:18 +0000"  >&lt;p&gt;I think the point Prakash was making is that we only have keep the deletes in the store files (the delete markers), but not the deleted KVs (the puts that would be affected by the deletes), since the replication would be using the logs anyway.&lt;/p&gt;

&lt;p&gt;In your scenario above... As long as we keep the deletes at the target for a while, it won&apos;t be a problem if the puts arrive later (both will retain the time stamp from the source).&lt;br/&gt;
That is what Prakash wants to achieve with this.&lt;/p&gt;</comment>
                            <comment id="13159669" author="hudson" created="Tue, 29 Nov 2011 23:50:51 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2500 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2500/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2500/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4721&quot; title=&quot;Retain Delete Markers after Major Compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4721&quot;&gt;&lt;del&gt;HBASE-4721&lt;/del&gt;&lt;/a&gt; Retain Delete Markers after Major Compaction&lt;/p&gt;

&lt;p&gt;Summary: major compactions &lt;b&gt;try&lt;/b&gt; to retain delete markers for the configured&lt;br/&gt;
time interval&lt;/p&gt;

&lt;p&gt;Test Plan:&lt;br/&gt;
added a new test testDeleteMarkerLongevity() in TestStoreScanner&lt;/p&gt;

&lt;p&gt;following tests passed&lt;br/&gt;
TestMemStore&lt;br/&gt;
TestStoreScanner&lt;br/&gt;
TestQueryMatcher&lt;br/&gt;
TestCompaction&lt;/p&gt;

&lt;p&gt;Reviewers: jgray, dhruba, lhofhansl, Karthik, nspiegelberg&lt;/p&gt;

&lt;p&gt;Reviewed By: nspiegelberg&lt;/p&gt;

&lt;p&gt;CC: HBase Diffs Facebook Group, lhofhansl, khemani, nspiegelberg&lt;/p&gt;

&lt;p&gt;Differential Revision: 321&lt;/p&gt;

&lt;p&gt;karthik : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/ScanQueryMatcher.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/ScanWildcardColumnTracker.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestMemStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestQueryMatcher.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestStoreScanner.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13159746" author="hudson" created="Wed, 30 Nov 2011 02:05:31 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-security #15 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-security/15/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-security/15/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4721&quot; title=&quot;Retain Delete Markers after Major Compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4721&quot;&gt;&lt;del&gt;HBASE-4721&lt;/del&gt;&lt;/a&gt; Retain Delete Markers after Major Compaction&lt;/p&gt;

&lt;p&gt;Summary: major compactions &lt;b&gt;try&lt;/b&gt; to retain delete markers for the configured&lt;br/&gt;
time interval&lt;/p&gt;

&lt;p&gt;Test Plan:&lt;br/&gt;
added a new test testDeleteMarkerLongevity() in TestStoreScanner&lt;/p&gt;

&lt;p&gt;following tests passed&lt;br/&gt;
TestMemStore&lt;br/&gt;
TestStoreScanner&lt;br/&gt;
TestQueryMatcher&lt;br/&gt;
TestCompaction&lt;/p&gt;

&lt;p&gt;Reviewers: jgray, dhruba, lhofhansl, Karthik, nspiegelberg&lt;/p&gt;

&lt;p&gt;Reviewed By: nspiegelberg&lt;/p&gt;

&lt;p&gt;CC: HBase Diffs Facebook Group, lhofhansl, khemani, nspiegelberg&lt;/p&gt;

&lt;p&gt;Differential Revision: 321&lt;/p&gt;

&lt;p&gt;karthik : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/ScanQueryMatcher.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/ScanWildcardColumnTracker.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestMemStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestQueryMatcher.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestStoreScanner.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12525597">HBASE-4536</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 7 Nov 2011 18:43:30 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>215634</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 3 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0161z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4750</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>