<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:18:32 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4395/HBASE-4395.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4395] EnableTableHandler races with itself</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4395</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Very often when we try to enable a big table we get something like:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;2011-09-02 12:21:56,619 FATAL org.apache.hadoop.hbase.master.HMaster: Unexpected state trying to OFFLINE; huge_ass_region_name state=PENDING_OPEN, ts=1314991316616&lt;br/&gt;
java.lang.IllegalStateException&lt;br/&gt;
        at org.apache.hadoop.hbase.master.AssignmentManager.setOfflineInZooKeeper(AssignmentManager.java:1074)&lt;br/&gt;
        at org.apache.hadoop.hbase.master.AssignmentManager.assign(AssignmentManager.java:1030)&lt;br/&gt;
        at org.apache.hadoop.hbase.master.AssignmentManager.assign(AssignmentManager.java:858)&lt;br/&gt;
        at org.apache.hadoop.hbase.master.AssignmentManager.assign(AssignmentManager.java:838)&lt;br/&gt;
        at org.apache.hadoop.hbase.master.handler.EnableTableHandler$BulkEnabler$1.run(EnableTableHandler.java:154)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2011-09-02 12:21:56,620 INFO org.apache.hadoop.hbase.master.HMaster: Aborting&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The issue is that EnableTableHandler calls multiple BulkEnabler and it&apos;s possible that by the time it calls it a second time, using a stale list of still-not-enabled regions, that it tries to set one region offline in ZK but just after its state changed. Case in point:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;2011-09-02 12:21:56,616 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Assigning region huge_ass_region_name to sv4r23s16,60020,1314880035029&lt;br/&gt;
2011-09-02 12:21:56,619 FATAL org.apache.hadoop.hbase.master.HMaster: Unexpected state trying to OFFLINE; huge_ass_region_name state=PENDING_OPEN, ts=1314991316616&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Here the first line is the first assign done in the first thread, and the second line is the second thread that got to process the same region around the same time. 3ms difference in time. After that, the master dies, and it&apos;s pretty sad when it restarts because it failovers an enabling table and it&apos;s ungodly slow.&lt;/p&gt;

&lt;p&gt;I&apos;m pretty sure there&apos;s a window where double assignment are possible.&lt;/p&gt;

&lt;p&gt;Talking with Stack, it doesn&apos;t really make sense to call multiple enables since the list of regions is static (the table is disabled!). We should just call it and wait. Also there&apos;s a lot of cleanup to do in EnableTableHandler since it refers to disabling the table (copy pasta I guess).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12522962">HBASE-4395</key>
            <summary>EnableTableHandler races with itself</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Sep 2011 21:47:10 +0000</created>
                <updated>Fri, 20 Nov 2015 11:56:01 +0000</updated>
                            <resolved>Thu, 15 Sep 2011 23:52:01 +0000</resolved>
                                    <version>0.90.4</version>
                                    <fixVersion>0.90.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13104056" author="jdcryans" created="Tue, 13 Sep 2011 22:46:32 +0000"  >&lt;p&gt;Looking more into this, deep in the BulkEnabler it waitUntilDone and it has a timeout of 5 minutes. I guess the loop is the way we use to take action when we timeout. I don&apos;t think it&apos;s a good idea in hindsight.&lt;/p&gt;

&lt;p&gt;Since we already have access to both the number of regions in the table and the number of online regions, I think we could do a trick where we count the latter number in a loop and as long we make progress we don&apos;t timeout. If we do timeout, the best we can do is logging an angry message in the master log... I don&apos;t think looping forever is better, same for calling BulkEnabler multiple times.&lt;/p&gt;</comment>
                            <comment id="13104077" author="stack" created="Tue, 13 Sep 2011 23:31:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking more into this, deep in the BulkEnabler it waitUntilDone and it has a timeout of 5 minutes. I guess the loop is the way we use to take action when we timeout. I don&apos;t think it&apos;s a good idea in hindsight.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah.  Notion was you&apos;d turn off timeout while we got the regions out.  After this configurable amount of time &amp;#8211; 5 minutes being default &amp;#8211; we&apos;d then let the timeout monitor cut in to take care of any stragglers.&lt;/p&gt;

&lt;p&gt;That was original thinking.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Since we already have access to both the number of regions in the table and the number of online regions, I think we could do a trick where we count the latter number in a loop and as long we make progress we don&apos;t timeout.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is a better idea.&lt;/p&gt;</comment>
                            <comment id="13104102" author="jdcryans" created="Wed, 14 Sep 2011 00:27:16 +0000"  >&lt;p&gt;Removes the loop and adds the timeout bumping. Tried it on a largish table (1k regions) and it worked fine. Also passes TestAdmin.&lt;/p&gt;</comment>
                            <comment id="13104197" author="yuzhihong@gmail.com" created="Wed, 14 Sep 2011 03:04:14 +0000"  >&lt;p&gt;In the loop of waitUntilDone():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-comment&quot;&gt;// Punt on the timeout as &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; we make progress
&lt;/span&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (regions.size() &amp;lt; lastNumberOfRegions) {
+          lastNumberOfRegions = regions.size();
+          remaining += waitingTimeForEvents;
+        }
         remaining = timeout - (&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() - startTime);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think regions.size() should increase in the above loop. So I don&apos;t understand the condition for if above.&lt;br/&gt;
Also, remaining is calculated lastly. I don&apos;t know why remaining is updated in the if block.&lt;/p&gt;</comment>
                            <comment id="13104735" author="jdcryans" created="Wed, 14 Sep 2011 18:07:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think regions.size() should increase in the above loop. So I don&apos;t understand the condition for if above.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah that was a last minute change, I actually tested with &quot;regions.size() &amp;gt; lastNumberOfRegions&quot; and then thought that that number was going down, I was confused with regionsToAssign().&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, remaining is calculated lastly. I don&apos;t know why remaining is updated in the if block.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Derp sorry it should be the timeout that&apos;s incremented.&lt;/p&gt;</comment>
                            <comment id="13104798" author="jdcryans" created="Wed, 14 Sep 2011 19:15:29 +0000"  >&lt;p&gt;Patch fixed.&lt;/p&gt;</comment>
                            <comment id="13104842" author="yuzhihong@gmail.com" created="Wed, 14 Sep 2011 20:05:09 +0000"  >&lt;p&gt;+1 on patch version 2.&lt;/p&gt;</comment>
                            <comment id="13105041" author="stack" created="Thu, 15 Sep 2011 00:54:58 +0000"  >&lt;p&gt;regions.isEmpty is cheaper than +    if (regions.size() == 0) {&lt;/p&gt;

&lt;p&gt;You get size of region list to do logging... a few lines later.  Might as well cache it?&lt;/p&gt;

&lt;p&gt;You can address on commit.&lt;/p&gt;

&lt;p&gt;+1 on patch.&lt;/p&gt;
</comment>
                            <comment id="13105775" author="jdcryans" created="Thu, 15 Sep 2011 23:49:46 +0000"  >&lt;p&gt;Patch for trunk, contains fixes for what Stack wrote.&lt;/p&gt;</comment>
                            <comment id="13105777" author="jdcryans" created="Thu, 15 Sep 2011 23:52:01 +0000"  >&lt;p&gt;Committed to branch and trunk.&lt;/p&gt;</comment>
                            <comment id="13105819" author="hudson" created="Fri, 16 Sep 2011 02:34:12 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2217 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2217/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2217/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4395&quot; title=&quot;EnableTableHandler races with itself&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4395&quot;&gt;&lt;del&gt;HBASE-4395&lt;/del&gt;&lt;/a&gt;  EnableTableHandler races with itself&lt;/p&gt;

&lt;p&gt;jdcryans : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/handler/EnableTableHandler.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15016639" author="lars_francke" created="Fri, 20 Nov 2015 11:56:01 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12494489" name="HBASE-4395-0.90-v2.patch" size="3191" author="jdcryans" created="Wed, 14 Sep 2011 19:15:29 +0000"/>
                            <attachment id="12494353" name="HBASE-4395-0.90.patch" size="3193" author="jdcryans" created="Wed, 14 Sep 2011 00:27:16 +0000"/>
                            <attachment id="12494728" name="HBASE-4395-trunk.patch" size="3122" author="jdcryans" created="Thu, 15 Sep 2011 23:49:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Sep 2011 23:31:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3517</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hqpj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101589</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>EnableTableHandler used to call many enables on the table, now it calls it once and eventually times out if not all the regions are assigned and none is moving.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>