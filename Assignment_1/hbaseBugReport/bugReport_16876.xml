<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:18:42 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-16876/HBASE-16876.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-16876] RatioBasedCompactionPolicy ignores mayBeStuck</title>
                <link>https://issues.apache.org/jira/browse/HBASE-16876</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I&apos;m a newbie so may not be reporting this bug correctly.  The bug currently shows in lines 181 - 190 here : &lt;a href=&quot;http://hbase.apache.org/xref/org/apache/hadoop/hbase/regionserver/compactions/RatioBasedCompactionPolicy.html#181&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hbase.apache.org/xref/org/apache/hadoop/hbase/regionserver/compactions/RatioBasedCompactionPolicy.html#181&lt;/a&gt; .&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Bar.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
176     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (countOfFiles - start &amp;gt;= comConf.getMinFilesToCompact() &amp;amp;&amp;amp;
177       fileSizes[start] &amp;gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(comConf.getMinCompactSize(),
178           (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) (sumSize[start + 1] * ratio))) {
179       ++start;
180     }
181     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (start &amp;lt; countOfFiles) {
182       LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Default compaction algorithm has selected &quot;&lt;/span&gt; + (countOfFiles - start)
183         + &lt;span class=&quot;code-quote&quot;&gt;&quot; files from &quot;&lt;/span&gt; + countOfFiles + &lt;span class=&quot;code-quote&quot;&gt;&quot; candidates&quot;&lt;/span&gt;);
184     } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (mayBeStuck) {
185       &lt;span class=&quot;code-comment&quot;&gt;// We may be stuck. Compact the latest files &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we can.
&lt;/span&gt;186       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; filesToLeave = candidates.size() - comConf.getMinFilesToCompact();
187       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filesToLeave &amp;gt;= 0) {
188         start = filesToLeave;
189       }
190     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On reaching line 176, start = 0.  When comConf.getMinFilesToCompact() is at least 2 (as occurs in the default), the while loop is guaranteed to terminate with start &amp;lt; countOfFiles.  Hence, the else clause starting at line 184 never executes, regardless of the value of mayBeStuck.&lt;/p&gt;

&lt;p&gt;Perhaps the following code would be better, but I&apos;m not sure:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Bar.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (start &amp;lt; countOfFiles
           &amp;amp;&amp;amp; fileSizes[start] &amp;gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(comConf.getMinCompactSize(),
                                          (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) (sumSize[start + 1] * ratio))) {
        ++start;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (countOfFiles - start &amp;lt; comConf.getMinFilesToCompact()) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (mayBeStuck &amp;amp;&amp;amp; countOfFiles &amp;gt;= comConf.getMinFilesToCompact()) {
            start = countOfFiles - comConf.getMinFilesToCompact();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            start = countOfFiles;
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (countOfFiles - start &amp;gt; 0) {
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Default compaction algorithm has selected &quot;&lt;/span&gt; + (countOfFiles - start)
                 + &lt;span class=&quot;code-quote&quot;&gt;&quot; files from &quot;&lt;/span&gt; + countOfFiles + &lt;span class=&quot;code-quote&quot;&gt;&quot; candidates&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13013334">HBASE-16876</key>
            <summary>RatioBasedCompactionPolicy ignores mayBeStuck</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="nealeyoung">Neal Young</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Tue, 18 Oct 2016 22:16:12 +0000</created>
                <updated>Mon, 24 Oct 2016 16:02:33 +0000</updated>
                                                                            <component>Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15587347" author="allan163" created="Wed, 19 Oct 2016 01:44:48 +0000"  >&lt;p&gt;It seems like you are right. But we use the derived class &lt;tt&gt;ExploringCompactionPolicy&lt;/tt&gt; for default, so no one has found out that.&lt;/p&gt;</comment>
                            <comment id="15602180" author="apurtell" created="Mon, 24 Oct 2016 14:39:06 +0000"  >&lt;p&gt;Would you like to submit your proposed change as a patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nealeyoung&quot; class=&quot;user-hover&quot; rel=&quot;nealeyoung&quot;&gt;Neal Young&lt;/a&gt;? See &lt;a href=&quot;http://hbase.apache.org/book.html#submitting.patches&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hbase.apache.org/book.html#submitting.patches&lt;/a&gt; for guidance.&lt;/p&gt;</comment>
                            <comment id="15602200" author="nealeyoung" created="Mon, 24 Oct 2016 14:44:49 +0000"  >&lt;p&gt;I&apos;d be more comfortable if the patch were vetted first by someone who is more familiar with the specification of the ratio-based compaction policy, and the code that calls it, that sets mayBeStuck.  Or if I were to submit the patch, would it be so vetted then?&lt;/p&gt;</comment>
                            <comment id="15602217" author="apurtell" created="Mon, 24 Oct 2016 14:50:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;Or if I were to submit the patch, would it be so vetted then?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nealeyoung&quot; class=&quot;user-hover&quot; rel=&quot;nealeyoung&quot;&gt;Neal Young&lt;/a&gt;: Yes, after attaching a patch please hit the &apos;Submit Patch&apos; button to flag it properly, and certainly before commit it will be reviewed by a committer capable of vetting the change.&lt;/p&gt;
</comment>
                            <comment id="15602315" author="nealeyoung" created="Mon, 24 Oct 2016 15:28:45 +0000"  >&lt;p&gt;I took a look at the docs, got stuck at step 4 (under the contributors section) of &lt;a href=&quot;http://accumulo.apache.org/git.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://accumulo.apache.org/git.html&lt;/a&gt; &amp;#8211; not sure what the &apos;lowest fixVersion&apos; is.  Also, didn&apos;t know where to find &apos;dev-support/submit-patch.py&apos; referenced at &lt;a href=&quot;http://hbase.apache.org/book.html#submitting.patches&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hbase.apache.org/book.html#submitting.patches&lt;/a&gt;, etc.  I think this is above my pay grade.  (I&apos;ve not checked out the repository or worked on the source at all before.)  Can someone more familiar with how to submit the patch do it?&lt;/p&gt;
</comment>
                            <comment id="15602391" author="apurtell" created="Mon, 24 Oct 2016 15:51:25 +0000"  >&lt;p&gt;Thanks for the feedback on the docs &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nealeyoung&quot; class=&quot;user-hover&quot; rel=&quot;nealeyoung&quot;&gt;Neal Young&lt;/a&gt; . &apos;git diff &amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-16876&quot; title=&quot;RatioBasedCompactionPolicy ignores mayBeStuck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-16876&quot;&gt;HBASE-16876&lt;/a&gt;.patch&apos; and attachment of that file here is all you need to do, FWIW. We can take it from there. &lt;/p&gt;</comment>
                            <comment id="15602416" author="nealeyoung" created="Mon, 24 Oct 2016 16:02:33 +0000"  >&lt;p&gt;The only step I was able to do was &apos;git clone &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf/accumulo.git&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://git-wip-us.apache.org/repos/asf/accumulo.git&lt;/a&gt; accumulo&apos;.  This populated the subdirectory &apos;accumulo&apos;, but I don&apos;t think the source for the ratio-based compaction policy is in any of the files.  E.g. &apos;grep -r RatioBasedCompactionPolicy&apos; returns nothing.  So I can&apos;t even edit the patch for a git diff.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 19 Oct 2016 01:44:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3528v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>