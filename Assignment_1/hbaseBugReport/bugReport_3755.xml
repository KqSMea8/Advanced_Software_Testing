<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:12:51 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3755/HBASE-3755.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3755] Catch zk&apos;s ConnectionLossException and augment error message with more help</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3755</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;0.90 has a different behavior regarding ZK connections, it tends to create too many of them and it&apos;s not obvious to users what they should do to fix. I think I&apos;ve helped at least 5 different users this week with this error.&lt;/p&gt;

&lt;p&gt;By catching ConnectionLossException and augmenting its message, we could say something like &quot;it&apos;s possible that the ZooKeeper server has too many connections from this IP, see doc at blah&quot; since the ZK server isn&apos;t nice enough to let us know what&apos;s going on.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12503668">HBASE-3755</key>
            <summary>Catch zk&apos;s ConnectionLossException and augment error message with more help</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Apr 2011 19:23:57 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:41 +0000</updated>
                            <resolved>Wed, 13 Apr 2011 00:02:25 +0000</resolved>
                                    <version>0.90.1</version>
                                    <fixVersion>0.90.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13017128" author="tlipcon" created="Thu, 7 Apr 2011 20:27:29 +0000"  >&lt;p&gt;Nice idea&lt;/p&gt;</comment>
                            <comment id="13017699" author="jdcryans" created="Fri, 8 Apr 2011 22:20:15 +0000"  >&lt;p&gt;So I did a bunch of testing on my laptop to see how we failed when too many connections. It&apos;s ugly. Really ugly. In this patch I improve three things while not breaking any behavior:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add a more meaningful message for connection loss.&lt;/li&gt;
	&lt;li&gt;Close the ZK handle on that error, what I saw is that since we didn&apos;t close it the client connection managers were staying alive trying to shutdown (could this be a ZK bug?) such that it was spewing errors like crazy and it never stops.&lt;/li&gt;
	&lt;li&gt;We were passing the exception to ZooKeeperConnectionException as if it was the message, I corrected that by changing the constructor to require a message plus the original exception. Then in HCM instead of creating yet another ZooKeeperConnectionException, we throw the one that we get since we have it already.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13017749" author="ghelmling" created="Fri, 8 Apr 2011 23:40:42 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Patch looks good to me.&lt;/p&gt;

&lt;p&gt;I get the feeling we need to clean up the error handling in a number of other places too.  Immediately below your changes in ZooKeeperWatcher constructor, there is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      ZKUtil.createAndFailSilent(this, assignmentZNode);
      ZKUtil.createAndFailSilent(this, rsZNode);
      ZKUtil.createAndFailSilent(this, tableZNode);
    } catch (KeeperException e) {
      LOG.error(prefix(&quot;Unexpected KeeperException creating base node&quot;), e);
      throw new IOException(e);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So if the connection gets setup but then fails we&apos;re still (in HConnectionManager case) wrapping the KeeperException in an IOException and then wrapping that in a ZooKeeperConnectionException.&lt;/p&gt;

&lt;p&gt;Seems like ultimately we should be letting out the KeeperException and handling it, or wrapping it directly without the intervening IOException.  I&apos;m sure there are other cases out there as well.  &lt;/p&gt;

&lt;p&gt;Outside the scope of this change though.  Given the lower client connection limit in the ZK distribution (which would show up in CDH packaging I believe with ZK installed separately), a clear error message in this case specifically is a big win.&lt;/p&gt;</comment>
                            <comment id="13018505" author="jdcryans" created="Mon, 11 Apr 2011 18:53:09 +0000"  >&lt;p&gt;From the mailing list:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;11/04/08 12:20:06 WARN zookeeper.ClientCnxn: Session 0x0 for server null, unexpected error, closing socket connection and attempting reconnect&lt;br/&gt;
java.net.ConnectException: Connection refused&lt;br/&gt;
       at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)&lt;br/&gt;
       at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:567)&lt;br/&gt;
       at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1078)&lt;br/&gt;
11/04/08 12:20:06 WARN zookeeper.ZooKeeperWrapper: Problem getting stats for /hbase/rs&lt;br/&gt;
org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /hbase/rs&lt;br/&gt;
       at org.apache.zookeeper.KeeperException.create(KeeperException.java:90)&lt;br/&gt;
       at org.apache.zookeeper.KeeperException.create(KeeperException.java:42)&lt;br/&gt;
       at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:809)&lt;br/&gt;
       at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:837)&lt;br/&gt;
       at org.apache.hadoop.hbase.zookeeper.ZooKeeperWrapper.getRSDirectoryCount(ZooKeeperWrapper.java:754)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HTable.getCurrentNrHRS(HTable.java:173)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HTable.&amp;lt;init&amp;gt;(HTable.java:147)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.MetaScanner.metaScan(MetaScanner.java:102)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.prefetchRegionCache(HConnectionManager.java:732)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.locateRegionInMeta(HConnectionManager.java:783)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.locateRegion(HConnectionManager.java:677)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.relocateRegion(HConnectionManager.java:650)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.getRegionLocation(HConnectionManager.java:470)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.ServerCallable.instantiateServer(ServerCallable.java:57)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.getRegionServerWithRetries(HConnectionManager.java:1145)&lt;br/&gt;
       at org.apache.hadoop.hbase.client.HTable.get(HTable.java:503)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is really ugly, I think this is what you were pointing out Gary?&lt;/p&gt;</comment>
                            <comment id="13018647" author="jdcryans" created="Tue, 12 Apr 2011 00:35:02 +0000"  >&lt;p&gt;Thinking more about it, I think I will punt on fixing anything in that last stack... at least not in the scope of this jira.&lt;/p&gt;</comment>
                            <comment id="13018658" author="jdcryans" created="Tue, 12 Apr 2011 01:04:40 +0000"  >&lt;p&gt;Did a bit more cleanup following what Gary said.&lt;/p&gt;</comment>
                            <comment id="13019061" author="ghelmling" created="Tue, 12 Apr 2011 21:25:14 +0000"  >&lt;p&gt;Do you think we need an additional check for KeeperException.ConnectionLossException at the bottom of ZooKeeperWatcher&amp;lt;init&amp;gt;?  This way we could perform the same cleanup as above.&lt;/p&gt;

&lt;p&gt;So instead of:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException e) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperConnectionException(
          prefix(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected KeeperException creating base node&quot;&lt;/span&gt;), e);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;do something like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException e) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; KeeperException.ConnectionLossException) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zooKeeper.close();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) {
          &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; closing&quot;&lt;/span&gt;, ie);
        }
      }
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperConnectionException(
          prefix(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected KeeperException creating base node&quot;&lt;/span&gt;), e);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13019065" author="ghelmling" created="Tue, 12 Apr 2011 21:30:28 +0000"  >&lt;p&gt;My last comment really should be handled more comprehensively as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3065&quot; title=&quot;Retry all &amp;#39;retryable&amp;#39; zk operations; e.g. connection loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3065&quot;&gt;&lt;del&gt;HBASE-3065&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Thanks for the update J-D.&lt;/p&gt;

&lt;p&gt;+1 on patch.&lt;/p&gt;</comment>
                            <comment id="13019124" author="jdcryans" created="Wed, 13 Apr 2011 00:02:25 +0000"  >&lt;p&gt;Committed to branch and trunk, many thanks to Gary for the thorough review.&lt;/p&gt;</comment>
                            <comment id="13163160" author="jmhsieh" created="Mon, 5 Dec 2011 23:20:37 +0000"  >&lt;p&gt;Note: This was also committed in the 0.92/trunk branch but doesn&apos;t show up because its commit log has HBASE=3755.&lt;/p&gt;</comment>
                            <comment id="15016774" author="lars_francke" created="Fri, 20 Nov 2015 12:40:41 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12476072" name="HBASE-3755-v2.patch" size="3216" author="jdcryans" created="Tue, 12 Apr 2011 01:04:40 +0000"/>
                            <attachment id="12475851" name="HBASE-3755.patch" size="2936" author="jdcryans" created="Fri, 8 Apr 2011 22:20:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 7 Apr 2011 20:27:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27009</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hnqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101107</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>