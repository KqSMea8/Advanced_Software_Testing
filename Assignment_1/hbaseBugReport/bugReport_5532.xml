<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:28:36 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5532/HBASE-5532.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5532] get NPE during MajorCompactionChecker </title>
                <link>https://issues.apache.org/jira/browse/HBASE-5532</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We found error log (NullPointerException) below on our online cluster:&lt;/p&gt;

&lt;p&gt;2012-03-05 00:17:09,592 ERROR org.apache.hadoop.hbase.regionserver.HRegionServer$MajorCompactionChecker: Caught exception&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.Store.isMajorCompaction(Store.java:878)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.Store.isMajorCompaction(Store.java:857)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.HRegion.isMajorCompaction(HRegion.java:3017)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.HRegionServer$MajorCompactionChecker.chore(HRegionServer.java:1172)&lt;br/&gt;
        at org.apache.hadoop.hbase.Chore.run(Chore.java:66)&lt;/p&gt;

&lt;p&gt;After Check the code we found although it already check whether store files has null reader at the begin of the function(isMajorCompaction), but it still has some possibility the reader is closed before it return(eg mini compaction). So we need to check store file reader before we use it to avoid this NPE&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12545300">HBASE-5532</key>
            <summary>get NPE during MajorCompactionChecker </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="terry_zhang">terry zhang</reporter>
                        <labels>
                            <label>delete</label>
                    </labels>
                <created>Tue, 6 Mar 2012 08:57:09 +0000</created>
                <updated>Sat, 10 Jan 2015 01:49:45 +0000</updated>
                            <resolved>Sat, 10 Jan 2015 01:49:45 +0000</resolved>
                                                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13223291" author="zhihyu@ebaysf.com" created="Tue, 6 Mar 2012 14:48:15 +0000"  >&lt;p&gt;Which version of HBase were you using ?&lt;/p&gt;</comment>
                            <comment id="13223909" author="terry_zhang" created="Wed, 7 Mar 2012 01:59:04 +0000"  >&lt;p&gt;Hi, Ted. Our is base on 0.90.2 (including many patches from 90.3 till 90.5).&lt;/p&gt;</comment>
                            <comment id="13224761" author="nspiegelberg" created="Wed, 7 Mar 2012 22:01:22 +0000"  >&lt;p&gt;Sounds like this is a race condition, so this patch wouldn&apos;t be sufficient.  We need some way to lock the reader during this query.&lt;/p&gt;</comment>
                            <comment id="13224955" author="terry_zhang" created="Thu, 8 Mar 2012 02:44:49 +0000"  >&lt;p&gt;yes,Nicolas. This is a race condition and we can use lock to avoid this issue. And now in the function toDetermines if Store should be split also didn&apos;t use lock to protect.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Store.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  /**
   * Determines &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; Store should be split
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; store should be split, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; otherwise.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] getSplitPoint() {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.lock.readLock().lock();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-comment&quot;&gt;// sanity checks
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.storefiles.isEmpty()) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
      }
 

 

        StoreFile.Reader r = sf.getReader(); * &amp;lt;= check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the reader is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;*
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (r == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Storefile &quot;&lt;/span&gt; + sf + &lt;span class=&quot;code-quote&quot;&gt;&quot; Reader is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
        }

        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; size = r.length();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (size &amp;gt; maxSize) {
          &lt;span class=&quot;code-comment&quot;&gt;// This is the largest one so far
&lt;/span&gt;          maxSize = size;
          largestSf = sf;
        }
      }

      StoreFile.Reader r = largestSf.getReader(); *&amp;lt;= check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the reader is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;*
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (r == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Storefile &quot;&lt;/span&gt; + largestSf + &lt;span class=&quot;code-quote&quot;&gt;&quot; Reader is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
      }
      &lt;span class=&quot;code-comment&quot;&gt;// Get first, last, and mid keys.  Midkey is the key that starts block
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// in middle of hfile.  Has column and timestamp.  Need to &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; just
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// the row we want to split on as midkey.
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] midkey = r.midkey();
     .....
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 


</comment>
                            <comment id="13224974" author="terry_zhang" created="Thu, 8 Mar 2012 03:40:20 +0000"  >&lt;p&gt;add a read lock during isMajorCompaction() to avoid race condition.&lt;/p&gt;</comment>
                            <comment id="13226622" author="stack" created="Sat, 10 Mar 2012 00:13:38 +0000"  >&lt;p&gt;This looks like patch for 0.90 only?&lt;/p&gt;</comment>
                            <comment id="14267612" author="clehene" created="Wed, 7 Jan 2015 13:17:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=terry_zhang&quot; class=&quot;user-hover&quot; rel=&quot;terry_zhang&quot;&gt;terry zhang&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; this may not apply anymore. &lt;br/&gt;
The code has changed a bit, and it seems we check for null readers. I&apos;m not sure about the locking semantics.&lt;/p&gt;

&lt;p&gt;The logic has moved to StoreFile.java and there&apos;s related logic in StripeStoreFileManager &lt;br/&gt;
isMajorCompaction() is in HStore.java&lt;/p&gt;</comment>
                            <comment id="14272230" author="apurtell" created="Sat, 10 Jan 2015 01:49:45 +0000"  >&lt;p&gt;Thanks for looking at this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clehene&quot; class=&quot;user-hover&quot; rel=&quot;clehene&quot;&gt;Cosmin Lehene&lt;/a&gt;. As this was reported against 0.90 and we don&apos;t support that version now I&apos;m closing as Wont Fix&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517521" name="HBASE-5532-v2.patch" size="1035" author="terry_zhang" created="Thu, 8 Mar 2012 03:40:19 +0000"/>
                            <attachment id="12517211" name="HBASE-5532.patch" size="691" author="terry_zhang" created="Tue, 6 Mar 2012 09:03:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 6 Mar 2012 14:48:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230486</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02ca7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11591</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>