<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:02:18 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2485/HBASE-2485.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2485] Persist Master in-memory state so on restart or failover, new instance can pick up where the old left off</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2485</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Today there was some good stuff up on IRC on how transitions won&apos;t always make it across Master failovers in multi-master deploy because transitions are kept in in-memory structure up in the Master and so on master crash, the new master will be missing state  on startup (Todd was main promulgator of this observation and of the opinion that while  master rewrite is scheduled for 0.21, some part needs to be done for 0.20.5).  A few suggestions were made: transitions should be file-backed somehow, etc.  Let this issue be about the subset we want to do for 0.20.5.&lt;/p&gt;

&lt;p&gt;Of the in-memory state queues, there is at least the master tasks queue &amp;#8211; process region opens, closes, regionserver crashes, etc. &amp;#8211; where tasks must be done in order and IIRC, tasks are fairly idempotent (at least in the server crash case, its multi-step and we&apos;ll put the crash event back on the queue if we cannot do all steps in the one go).  Perhaps this queue could be done using the new queue facility in zk 3.3.0 (I haven&apos;t looked to check if possible, just suggesting).  Another suggestion was a file to which we&apos;d append queue items, requeueing, and marking the file with task complete, etc.  On Master restart or fail-over, we&apos;d replay the queue log.&lt;/p&gt;

&lt;p&gt;There is also the Map of regions-in-transition.  Yesterday we learned that there is a bug where server shutdown processing does not iterate the Map of regions-in-transition.  This Map may hold regions that are in &quot;opening&quot; or &quot;opened&quot; state but haven&apos;t yet had the fact added to .META. by master.  Meantime the hosting server can crash.  Regions that were opening will stay in the regions-in-transition and those in opened-but-not-yet-added-to-meta will go ahead and add a crashed server to .META. (Currently regions-in-transition does not record server the region opening/open is happening on so it doesn&apos;t have enough info to be processed as part of server shutdown).&lt;/p&gt;

&lt;p&gt;Regions-in-transition also needs to be persistant.  On startup, regions-in-transition can get kinda hectic on a big cluster.  Ordering is not so important here I believe.  A directory in zk might work (For 1M regions in a big cluster, that&apos;d be about 2M creates and 2M deletes during startup &amp;#8211; thats too much?).  Or we could write a WAL-like log again of region  transitions (We&apos;d have to develop a little vocabulary) that got reread by a new master.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12462917">HBASE-2485</key>
            <summary>Persist Master in-memory state so on restart or failover, new instance can pick up where the old left off</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="streamy">Jonathan Gray</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                            <label>moved_from_0_20_5</label>
                    </labels>
                <created>Sat, 24 Apr 2010 04:03:24 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:46 +0000</updated>
                            <resolved>Tue, 19 Oct 2010 00:09:42 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="12864927" author="karthik.ranga" created="Thu, 6 May 2010 21:01:05 +0000"  >&lt;p&gt;Adding an initial design of how to handle region transitions.&lt;/p&gt;</comment>
                            <comment id="12865273" author="stack" created="Fri, 7 May 2010 19:12:56 +0000"  >&lt;p&gt;Doc is great.  Here&apos;s a few comments.&lt;/p&gt;

&lt;p&gt;+ I think you should start your proposal w/ some high-level intents: e.g. Only messages from Master to RS over RPC are of import, are &quot;commands&quot;; messages from RS to Master are just informational (load, split) OR, intent is moving the intransitions out of Master to zk so intransiitions weathers a master restart.&lt;br/&gt;
+ Startup could be tricky.  Here we are hoisting all regions in .META. up into the unassigned in zk.  I was wondering about the case where the copy from .META. to zk/UNASSIGNED is only partially done say because master crashes.  What happens?  Maybe it&apos;ll be OK?  If the  meta startcode does not match that of a running regionserver, then the region has not yet been assigned so add it to zk/UNASSIGNED.&lt;br/&gt;
+ In Close Region RS Flow, did we agree closing is of no use?   There is nothing master can do really if closing is taking for ever?&lt;br/&gt;
+ Up in zk, unfortunately, znodes will have to be named using the regions encoded name.  Will make it a little tough following region flow.  Perhaps the fix is to make encoded name of a region more prevalent in logs.&lt;br/&gt;
+ We said opening was nice to have rather than necessary?&lt;br/&gt;
+ I wonder if you need a new message from Master to RS where you can ask the RS what regions it has deployed? Be best if we didn&apos;t need it.  We shouldn&apos;t need it I suppose.&lt;/p&gt;</comment>
                            <comment id="12866402" author="karthik.ranga" created="Wed, 12 May 2010 00:27:57 +0000"  >&lt;p&gt;Hey Stack,&lt;/p&gt;

&lt;p&gt;Excellent feedback, thanks!&lt;/p&gt;

&lt;p&gt;1. Will add a modified doc soon, absolutely agree with you comment:&lt;br/&gt;
&quot;intent is moving the intransitions out of Master to zk so intransiitions weathers a master restart.&quot;&lt;br/&gt;
2. wrt Master restarts: jgray and I were discussing, it will be a scheme similar to zk/UNASSIGNED, but in a different location. And a RS will be handed a bunch of regions using one zk node update, and will have to ack the bulk open in one zk node update. Will fill in once the details are clearer, but it will not follow the exact same scheme.&lt;br/&gt;
3. Yes, closing is of no use.&lt;br/&gt;
4. Agreed&lt;br/&gt;
5. Yes, opening is a nice to have. I am taking the following approach: let the RS report opening progress, but master will ignore them for the first cut.&lt;br/&gt;
6. No, I don&apos;t think that would be needed in the current scheme. The RS would just update the state of the region to &quot;OPENED&quot; and master can infer from there.&lt;/p&gt;

&lt;p&gt;We have already started coding some parts, will update once there is more progress...&lt;/p&gt;</comment>
                            <comment id="12866822" author="stack" created="Wed, 12 May 2010 23:48:38 +0000"  >&lt;p&gt;Bulk move of 0.20.5 issues into 0.21.0 after vote that we merge branch into TRUNK up on list.&lt;/p&gt;</comment>
                            <comment id="12904930" author="streamy" created="Wed, 1 Sep 2010 05:46:36 +0000"  >&lt;p&gt;Implementation of this moved into &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2692&quot; title=&quot;Master rewrite and cleanup for 0.90&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2692&quot;&gt;&lt;del&gt;HBASE-2692&lt;/del&gt;&lt;/a&gt;.  We should add some tests before closing this perhaps.&lt;/p&gt;</comment>
                            <comment id="12905074" author="stack" created="Wed, 1 Sep 2010 16:16:55 +0000"  >&lt;p&gt;Yes.  This needs a test and we need to add Karthik&apos;s document to the hbase book before we can close this issue I&apos;d say.&lt;/p&gt;</comment>
                            <comment id="12905138" author="stack" created="Wed, 1 Sep 2010 18:32:50 +0000"  >&lt;p&gt;When we write unit test to demonstrate this issue fixed, be sure to include coverage for the case described over inHBASE-1742 where an open comes in during master down and it causes loss of region onlining.&lt;/p&gt;</comment>
                            <comment id="12918209" author="streamy" created="Tue, 5 Oct 2010 21:24:21 +0000"  >&lt;p&gt;Working on unit tests for this over the course of this week.&lt;/p&gt;</comment>
                            <comment id="12922374" author="streamy" created="Tue, 19 Oct 2010 00:09:42 +0000"  >&lt;p&gt;Newly committed master failover unit tests all passing on hudson.  Resolving!&lt;/p&gt;</comment>
                            <comment id="12922436" author="stack" created="Tue, 19 Oct 2010 04:51:39 +0000"  >&lt;p&gt;Just to say that the attached is good on how things used to work.  It also puts up a few simple axioms on how things are to be in the new master with listings of general transition flows.  The hbase &apos;book&apos; has the committed versions of these flows.  I also took from the doc. description of how splits are now in new master.&lt;/p&gt;</comment>
                            <comment id="15017338" author="lars_francke" created="Fri, 20 Nov 2015 12:42:46 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12432118">HBASE-1742</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12406696">HBASE-934</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12466475">HBASE-2692</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12432326">HBASE-1750</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12461053">HBASE-2405</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12443907" name="HBase-State-Transitions.docx" size="25228" author="karthik.ranga" created="Thu, 6 May 2010 21:01:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 6 May 2010 21:01:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26328</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hhxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100166</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>