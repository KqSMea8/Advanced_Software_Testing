<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:48:55 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7774/HBASE-7774.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7774] RegionObserver.prePut() cannot rely on the Put&apos;s timestamps, can even cause data loss</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7774</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We had a user that had code that looked like this in a coprocessor&apos;s prePut():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (put.has(expectedKv))
  put.add(kvSayingIFoundIt);
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
  put.add(kvSayingNotFound);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you have MSLAB turned &lt;b&gt;off&lt;/b&gt;, and you have the &lt;tt&gt;expectedKv&lt;/tt&gt; in your &lt;tt&gt;Put&lt;/tt&gt;, doing a &lt;tt&gt;Get&lt;/tt&gt; following your insert will only return &lt;tt&gt;kvSayingIFoundIt&lt;/tt&gt; and not the KV you were actually inserting.&lt;/p&gt;

&lt;p&gt;More so, if you only do &lt;tt&gt;put.has(expectedKv)&lt;/tt&gt;, you will not get anything back. Your data seems to be gone.&lt;/p&gt;

&lt;p&gt;The reason is that in &lt;tt&gt;prePut()&lt;/tt&gt; the timestamp hasn&apos;t been set yet, so calling &lt;tt&gt;kv.getTimestamp()&lt;/tt&gt; during the comparisons in &lt;tt&gt;put.has()&lt;/tt&gt; will populate &lt;tt&gt;kv.timestampCache&lt;/tt&gt; with &lt;tt&gt;Long.MAX_VALUE&lt;/tt&gt;. Then it will stay in the &lt;tt&gt;MemStore&lt;/tt&gt; with that big timestamp and be filtered out because &lt;tt&gt;TimeRange&lt;/tt&gt; will compare &lt;tt&gt;Long.MAX_VALUE&lt;/tt&gt; &amp;gt;= &lt;tt&gt;Long.MAX_VALUE&lt;/tt&gt; and return &lt;tt&gt;SKIP&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;And the reason it works correctly with MSLAB &lt;b&gt;on&lt;/b&gt; is that the KV is cloned in &lt;tt&gt;maybeCloneWithAllocator()&lt;/tt&gt; and the cache is reset.&lt;/p&gt;

&lt;p&gt;Now, I think this has bigger implications. Basically, you can&apos;t rely on the timestamp at all in &lt;tt&gt;prePut()&lt;/tt&gt;. I&apos;m sure this can screw someone else in a creative way later.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12630939">HBASE-7774</key>
            <summary>RegionObserver.prePut() cannot rely on the Put&apos;s timestamps, can even cause data loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Feb 2013 19:55:47 +0000</created>
                <updated>Fri, 7 Feb 2014 23:12:53 +0000</updated>
                            <resolved>Wed, 6 Feb 2013 05:27:07 +0000</resolved>
                                    <version>0.92.2</version>
                    <version>0.94.4</version>
                    <version>0.95.2</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13571688" author="jdcryans" created="Tue, 5 Feb 2013 20:15:29 +0000"  >&lt;p&gt;One fix that comes to mind is when you &lt;tt&gt;setTimestamp&lt;/tt&gt; you could refresh the cache.&lt;/p&gt;

&lt;p&gt;And I&apos;m just remembered one thing that screwed me when debugging, &lt;tt&gt;kv.toString&lt;/tt&gt; shows the real timestamp which can be different from the cached one!&lt;/p&gt;</comment>
                            <comment id="13571780" author="jdcryans" created="Tue, 5 Feb 2013 22:01:58 +0000"  >&lt;p&gt;Shell example for those more visual like me:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
hbase(main):001:0&amp;gt; scan &apos;t&apos;
ROW                                           COLUMN+CELL                             
0 row(s) in 0.5100 seconds

hbase(main):002:0&amp;gt; put &apos;t&apos;, &apos;1&apos;, &apos;cf:u&apos;, &apos;the row we are checking in the coproc&apos;
0 row(s) in 0.0530 seconds

hbase(main):003:0&amp;gt; scan &apos;t&apos;
ROW                                           COLUMN+CELL                                                                                                                         
 1                                            column=cf:txt, timestamp=1360092298333, value=cell found                                                                         
1 row(s) in 0.0190 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The cell we inserted is missing from the scan.&lt;/p&gt;</comment>
                            <comment id="13571886" author="jdcryans" created="Tue, 5 Feb 2013 23:18:42 +0000"  >&lt;p&gt;Another interesting tidbit, while flushing we also rely on the default &lt;tt&gt;TimeRange&lt;/tt&gt; which skips the values that have a timestamp (or cached one) set to &lt;tt&gt;Long.MAX_VALUE&lt;/tt&gt; so the data once flushed is really lost.&lt;/p&gt;</comment>
                            <comment id="13572046" author="anoopsamjohn" created="Wed, 6 Feb 2013 01:42:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;so calling kv.getTimestamp() during the comparisons in put.has() will populate kv.timestampCache with Long.MAX_VALUE&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think this is fixed in some other Jira. &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Now, I think this has bigger implications. Basically, you can&apos;t rely on the timestamp at all in prePut()&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. we faced this issue while working with the secondary index implementation. We wanted to populate the index Puts in a pre hook but the TS which will be used by the original put is generated after this hook call in HRegion. That is also one of the reason why we introduced new hooks. Pls have a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4210&quot; title=&quot;Allow coprocessor to interact with batches per region sent from a client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4210&quot;&gt;&lt;del&gt;HBASE-4210&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13572141" author="ram_krish" created="Wed, 6 Feb 2013 04:30:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think this is fixed in some other Jira.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. This is fixed.  I remember it was an issue raised by Lars George.&lt;/p&gt;
</comment>
                            <comment id="13572166" author="anoopsamjohn" created="Wed, 6 Feb 2013 04:48:37 +0000"  >&lt;p&gt;That was fixed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6265&quot; title=&quot;Calling getTimestamp() on a KV in cp.prePut() causes KV not to be flushed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6265&quot;&gt;&lt;del&gt;HBASE-6265&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Later &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7279&quot; title=&quot;Avoid copying the rowkey in RegionScanner, StoreScanner, and ScanQueryMatcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7279&quot;&gt;&lt;del&gt;HBASE-7279&lt;/del&gt;&lt;/a&gt; removed this timestamp, rowkey caches itself from the KeyValue.&lt;/p&gt;</comment>
                            <comment id="13572178" author="anoopsamjohn" created="Wed, 6 Feb 2013 04:59:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;Now, I think this has bigger implications. Basically, you can&apos;t rely on the timestamp at all in prePut(). I&apos;m sure this can screw someone else in a creative way later.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think this is the only point open now. All other issues mentioned in the description and comments are already addressed by the above issues. Am I correct &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdcryans&quot; class=&quot;user-hover&quot; rel=&quot;jdcryans&quot;&gt;Jean-Daniel Cryans&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13572192" author="jdcryans" created="Wed, 6 Feb 2013 05:27:07 +0000"  >&lt;p&gt;Yes I think we can resolve that as a duplicate, thanks for chiming in guys!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12595773">HBASE-6265</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12618823">HBASE-7279</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12519068">HBASE-4210</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 6 Feb 2013 01:42:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311435</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 45 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hqvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311781</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>