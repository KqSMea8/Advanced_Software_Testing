<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:55:30 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1682/HBASE-1682.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1682] IndexedRegion does not properly handle deletes</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1682</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I&apos;ve been using the IndexedTable stuff from contrib and come across a bit of an issue.&lt;/p&gt;

&lt;p&gt;When I delete a column my indexes are removed for that column. I&apos;ve run through the code in IndexedRegion and used very similar code in my own classes to recreate the index after I&apos;ve run the delete.&lt;/p&gt;

&lt;p&gt;I&apos;ve also noticed that if I run a Put after the Delete then the index will be re-created.&lt;/p&gt;

&lt;p&gt;Neither the Delete or the subsequent Put in the second example uses any of the columns that are part of the index (either indexed or additional columns).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;org.apache.hadoop.hbase.regionserver.tableindexed.IndexedRegion.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

@Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void delete(Delete delete, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; lockid, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; writeToWAL)
     &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {

   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!getIndexes().isEmpty()) {
     &lt;span class=&quot;code-comment&quot;&gt;// Need all columns
&lt;/span&gt;     NavigableSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; neededColumns = getColumnsForIndexes(getIndexes());

     Get get = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Get(delete.getRow());
     &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] col : neededColumns) {
      get.addColumn(col);
     }

     Result oldRow = &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.get(get, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
     SortedMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; oldColumnValues = convertToValueMap(oldRow);


     &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (IndexSpecification indexSpec : getIndexes()) {
       removeOldIndexEntry(indexSpec, delete.getRow(), oldColumnValues);
     }

     &lt;span class=&quot;code-comment&quot;&gt;// Handle &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there is still a version visible.
&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (delete.getTimeStamp() != HConstants.LATEST_TIMESTAMP) {
       get.setTimeRange(1, delete.getTimeStamp());
       oldRow = &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.get(get, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
       SortedMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; currentColumnValues = convertToValueMap(oldRow);
       LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;There are &quot;&lt;/span&gt; + currentColumnValues + &lt;span class=&quot;code-quote&quot;&gt;&quot; entries to re-index&quot;&lt;/span&gt;);

       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (IndexSpecification indexSpec : getIndexes()) {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (IndexMaintenanceUtils.doesApplyToIndex(indexSpec, currentColumnValues)) {
           updateIndex(indexSpec, delete.getRow(), currentColumnValues);
         }
       }
     }
   }
   &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.delete(delete, lockid, writeToWAL);
 }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems that any delete will remove the indexes, but they will only be rebuilt if the delete is of a previous version for the row, and then the index will then be built using data from the version prior to that which you&apos;ve just deleted - which seems to mean it would, more often than not, always be out of date.&lt;/p&gt;

&lt;p&gt;More broadly it also occurs to me that it may make sense not to delete the indexes at all unless the Delete would otherwise affect them. In my case there isn&apos;t really any reason to remove the indexes, the column I&apos;m deleting is completely unrelated.&lt;/p&gt;

&lt;p&gt;Will follow with a patch shortly to resolve at least the first part of the issue. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12431116">HBASE-1682</key>
            <summary>IndexedRegion does not properly handle deletes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="clint.morgan">Clint Morgan</assignee>
                                    <reporter username="andrew.mccall">Andrew McCall</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Jul 2009 08:54:53 +0000</created>
                <updated>Fri, 12 Oct 2012 06:13:23 +0000</updated>
                            <resolved>Fri, 30 Oct 2009 22:24:37 +0000</resolved>
                                                    <fixVersion>0.20.2</fixVersion>
                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12734053" author="andrew.mccall" created="Wed, 22 Jul 2009 09:56:02 +0000"  >&lt;p&gt;First stab at it. &lt;/p&gt;

&lt;p&gt;I haven&apos;t tried to determine if the delete affects the underlying index at all, I&apos;m simply removing any indexes for the row, performing the underlying delete and then recreating all the indexes for the row. &lt;/p&gt;

&lt;p&gt;Seems to work for me, my code works fine now with or without the Put after the delete. &lt;/p&gt;</comment>
                            <comment id="12771290" author="stack" created="Thu, 29 Oct 2009 04:48:10 +0000"  >&lt;p&gt;@Clint Please review.&lt;/p&gt;</comment>
                            <comment id="12772097" author="clint.morgan" created="Fri, 30 Oct 2009 21:25:25 +0000"  >&lt;p&gt;Old patch would not apply, here is one that does. &lt;/p&gt;</comment>
                            <comment id="12772116" author="clint.morgan" created="Fri, 30 Oct 2009 22:01:51 +0000"  >&lt;p&gt;Need to pass the proper lockId to the get. This does it.&lt;/p&gt;</comment>
                            <comment id="12772117" author="clint.morgan" created="Fri, 30 Oct 2009 22:03:33 +0000"  >&lt;p&gt;+1 reviewed, looks good: its a simpler/correct way to fallback on the old versions.&lt;/p&gt;

&lt;p&gt;TestIndexTable passes, and my indexing tests on top of hbase pass.&lt;/p&gt;</comment>
                            <comment id="12772127" author="stack" created="Fri, 30 Oct 2009 22:24:37 +0000"  >&lt;p&gt;Committed branch and trunk.  Thanks Andrew (and Clint)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12414205" name="HBASE-1682-1.patch" size="2438" author="andrew.mccall" created="Wed, 22 Jul 2009 10:38:20 +0000"/>
                            <attachment id="12423720" name="hbase-1682-2.patch" size="2017" author="clint.morgan" created="Fri, 30 Oct 2009 21:25:25 +0000"/>
                            <attachment id="12423723" name="hbase-1682-3.patch" size="2019" author="clint.morgan" created="Fri, 30 Oct 2009 22:01:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 29 Oct 2009 04:48:10 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25914</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08s7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>49171</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>