<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:32:46 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5986/HBASE-5986.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5986] Clients can see holes in the META table when regions are being split</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5986</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet. &lt;/p&gt;

&lt;p&gt;This is also related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4335&quot; title=&quot;Splits can create temporary holes in .META. that confuse clients and regionservers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4335&quot;&gt;&lt;del&gt;HBASE-4335&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12554839">HBASE-5986</key>
            <summary>Clients can see holes in the META table when regions are being split</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enis">Enis Soztutar</assignee>
                                    <reporter username="enis">Enis Soztutar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 May 2012 23:47:40 +0000</created>
                <updated>Tue, 26 Feb 2013 08:15:47 +0000</updated>
                            <resolved>Sat, 26 May 2012 15:24:23 +0000</resolved>
                                    <version>0.92.1</version>
                    <version>0.94.1</version>
                    <version>0.95.2</version>
                                    <fixVersion>0.94.1</fixVersion>
                    <fixVersion>0.95.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                <comments>
                            <comment id="13272910" author="enis" created="Thu, 10 May 2012 23:51:56 +0000"  >&lt;p&gt;Attaching a unit test to illustrate the problem. The test fails for me when splitting the first region, the client sees 0 regions for some time. &lt;/p&gt;</comment>
                            <comment id="13272918" author="enis" created="Fri, 11 May 2012 00:03:18 +0000"  >&lt;p&gt;Possible fixes I can think of: &lt;br/&gt;
1. Keep MetaScanner/MetaReader as non-consistent (as it is), but allow for a consistent view for getting table regions. Since single row puts are atomic, when the parent region is mutated to be offline, the HRI for daughters are added to the row. So on MetaScanner.allTableRegions and similar calls, we can keep track of daughter regions from split parents and return them to the client. &lt;br/&gt;
2. Make MetaScanner consistent, in that, whenever it sees a split parent, it blocks until the daughters are available. &lt;br/&gt;
3. We have region-local transactions now, so if we ensure that the rows for parent and daughters will be served from the same META region, then we can update all three rows atomically. Maybe we can come up with a META-specific split policy to ensure split-regions go to the same META region. &lt;br/&gt;
Thoughts? &lt;/p&gt;</comment>
                            <comment id="13272948" author="lhofhansl" created="Fri, 11 May 2012 00:36:03 +0000"  >&lt;p&gt;I think we are assuming in many other places that META only has a single region.&lt;/p&gt;

&lt;p&gt;Is there another alternative, such as adding the daughter regions first, and then have HTable disentangle conflicts?&lt;/p&gt;</comment>
                            <comment id="13272952" author="enis" created="Fri, 11 May 2012 00:45:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we are assuming in many other places that META only has a single region.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The ROOT is &lt;del&gt;by-design&lt;/del&gt; one region, but META is not, right?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is there another alternative, such as adding the daughter regions first, and then have HTable disentangle conflicts?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I have thought about this as well, but then there is a time window in which you have both the parent and daughter regions online, and parent not marked as split. So the client again has to resolve that the returned regions are overlapping. &lt;/p&gt;</comment>
                            <comment id="13272966" author="lhofhansl" created="Fri, 11 May 2012 01:11:48 +0000"  >&lt;p&gt;True, META is not single region by design, but effectively it is (not really suggesting that we add more code that relies on this). I think you&apos;re right we could add a split policy that ensures that parent and daughters are always in the same region.&lt;/p&gt;

&lt;p&gt;As for the alternative:&lt;br/&gt;
If the client has to recheck in these (rare) cases that seems OK, as long as the client can reliably tell that it does have to recheck.&lt;/p&gt;</comment>
                            <comment id="13272974" author="zhihyu@ebaysf.com" created="Fri, 11 May 2012 01:40:25 +0000"  >&lt;p&gt;Can MetaScanner.allTableRegions() return special exception so that client knows it needs to check back ?&lt;/p&gt;</comment>
                            <comment id="13272987" author="enis" created="Fri, 11 May 2012 02:13:59 +0000"  >&lt;p&gt;I have implemented approach 1 by adding split daughters to the returned map from MetaScanner.allTableRegions(). But then the problem is that, we are returning regions which does not yet exists in the META table, so any subsequent getRegion call will fail. &lt;/p&gt;

&lt;p&gt;Thinking a bit more about 3, I think we already guarantee that the region split parent, and daughters fall into the same META region. Let&apos;s say we have two regions region1 and region2, with start keys start_key*, and timestamps ts* respectively. &lt;/p&gt;

&lt;p&gt;Before split:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
&amp;lt;table&amp;gt; &amp;lt;start_key1&amp;gt; &amp;lt;ts1&amp;gt; &amp;lt;encoded_name1&amp;gt;
&amp;lt;table&amp;gt; &amp;lt;start_key2&amp;gt; &amp;lt;ts2&amp;gt; &amp;lt;encoded_name2&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Now, if we split region1, daughters will be sorted after region1, and before region2:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
&amp;lt;table&amp;gt; &amp;lt;start_key1&amp;gt; &amp;lt;ts1&amp;gt; &amp;lt;encoded_name1&amp;gt; &amp;lt;offline&amp;gt; &amp;lt;split&amp;gt;
&amp;lt;table&amp;gt; &amp;lt;start_key1&amp;gt; &amp;lt;ts3&amp;gt; &amp;lt;encoded_name1&amp;gt;
&amp;lt;table&amp;gt; &amp;lt;mid_key1&amp;gt; &amp;lt;ts3&amp;gt; &amp;lt;encoded_name1&amp;gt;
&amp;lt;table&amp;gt; &amp;lt;start_key2&amp;gt; &amp;lt;ts2&amp;gt; &amp;lt;encoded_name2&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;we know this since we have the invariants ts3 &amp;gt; ts1 (SplitTransaction.getDaughterRegionIdTimestamp()) and start_key1 &amp;lt; mid_key1 &amp;lt; start_key2. Even if we have a region boundary between start_key1 and start_key2 in the META table, the daughters will be co-located with the parent. The only exception is that while the user table is split, we have a concurrent split for the META table, and the new region boundary is chosen to be between the parent and daughters. With some effort, we can prevent this, but it seems to be very highly unlikely. &lt;/p&gt;

&lt;p&gt;So, if my analysis is correct, that means option 3 seems like the best choice, since this will not complicate the meta scan code. The problem is that, there is no internal API to do multi-row transcations other than using the coprocessor. Should we think of allowing that w/o coprocessors?&lt;/p&gt;

&lt;p&gt;@Lars, does HRegion.mutateRowsWithLock() guarantee that a concurrent scanner won&apos;t see partial changes? &lt;/p&gt;</comment>
                            <comment id="13273045" author="lhofhansl" created="Fri, 11 May 2012 05:08:14 +0000"  >&lt;p&gt;@Enis: yes HRegion.mutateRowsWithLock() has correct MVCC semantics even across multi row scans. &lt;/p&gt;

&lt;p&gt;The region boundary could be between start_key1 and mid_key1 if there rows inserted and deleted before... Still unlikely. To be safe we could just have a splitKeyPolicy that never splits the table prefix (i.e. all keys for the same table are guaranteed to be in the region).&lt;/p&gt;</comment>
                            <comment id="13276385" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 01:48:02 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;enis&lt;/p&gt;
</comment>
                            <comment id="13276386" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 01:54:05 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-05-16 01:53:09.861265)&lt;/p&gt;


&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Summary (updated)&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;

&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;

&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;enis&lt;/p&gt;
</comment>
                            <comment id="13276399" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 02:54:03 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/#review7925&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#review7925&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17245&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17245&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Remove white space.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17246&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17246&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Can we add a config param for blockingTimeout ?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17247&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17247&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Do we have to instantiate HTable every time ?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17250&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17250&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    null is always returned by getRegionResultBlocking() in case of time out.&lt;br/&gt;
    How do we deal with that ?&lt;/p&gt;




&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17249&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17249&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    We shouldn&apos;t be passing blockingTimeout here.&lt;br/&gt;
    We need to consider the amount of time spent in the call @ line 388.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17248&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17248&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Please restore interrupted state of the thread.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-05-16 01:53:09, enis wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-05-16 01:53:09)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;enis&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13276477" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 05:22:09 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/#review7928&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#review7928&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17254&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17254&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Blocking time out is one factor on which we will be waiting.  So this blockingtimeout should be in lieu with &apos;fileSplitTimeout&apos;?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ramkrishna&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-05-16 01:53:09, enis wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-05-16 01:53:09)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;enis&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13277024" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 19:11:03 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 02:52:04, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 391&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line391&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line391&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     null is always returned by getRegionResultBlocking() in case of time out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     How do we deal with that ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;we are checking for null return value for resultA, and resultB. But I&apos;ll also add a LOG warning. &lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 02:52:04, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 390&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line390&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line390&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Do we have to instantiate HTable every time ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is a bit tricky. Ideally we should not. But there is no close() on MetaScannerVisitor, so we cannot close the HTable properly if we reuse the HTable across calls to processRow(). We can add a close() method and call it, or obtain the HTable from the context, but that would imply changing the class signature for MetaScannerVisitor. I assumed since we are reusing HConnection&apos;s HTable creation is cheap, is that not the case, wdyt? &lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 02:52:04, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 360&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line360&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line360&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Can we add a config param for blockingTimeout ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;please see below&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 02:52:04, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 398&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line398&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line398&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     We shouldn&apos;t be passing blockingTimeout here.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     We need to consider the amount of time spent in the call @ line 388.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;agreed&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 02:52:04, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 430&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line430&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line430&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Please restore interrupted state of the thread.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;agreed&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enis&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/#review7925&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#review7925&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-05-16 01:53:09, enis wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-05-16 01:53:09)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;enis&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13277025" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 19:11:09 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 05:20:29, ramkrishna vasudevan wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 402&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line402&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line402&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Blocking time out is one factor on which we will be waiting.  So this blockingtimeout should be in lieu with &apos;fileSplitTimeout&apos;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;From my understanding, fileSplitTimeout is a regionserver property, while the timeout parameter in this patch is a client side property, since the blocking will happen on the client. I think &quot;hbase.client.operation.timeout&quot; can serve us well. HConstants state that it is &quot;Default HBase client operation timeout, which is tantamount to a blocking call&quot;.&lt;/p&gt;&lt;/blockquote&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enis&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/#review7928&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#review7928&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-05-16 01:53:09, enis wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-05-16 01:53:09)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;enis&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13277031" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 19:21:03 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/#review7938&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#review7938&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17261&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17261&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I was asking how do we convey the fact that MetaScanner has timed out to client.&lt;/p&gt;

&lt;p&gt;    I don&apos;t see exception being thrown which contains timeout information.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-05-16 01:53:09, enis wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-05-16 01:53:09)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;enis&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13277035" author="stack" created="Wed, 16 May 2012 19:23:55 +0000"  >&lt;p&gt;Regards 1. and 2., what guarantees do we have that the daughter will not have split by the time we go into our wait on the daughters to come online?&lt;/p&gt;</comment>
                            <comment id="13277161" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 21:33:07 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/#review7939&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#review7939&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Looks great Enis.  Thanks for having a go at this.  Loads of white space introduced which you might fix in v2.  Otherwise a few little items below....&lt;/p&gt;


&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17262&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17262&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Bit of javadoc to say this is best-effort.&lt;/p&gt;

&lt;p&gt;    Also, does this belong in MetaReader (Won&apos;t hold you to it... these two classes, a MetaReader vs MetaEditor are kinda silly... this whole catalog package needs killing).&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17264&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17264&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Why you remove this?  We don&apos;t return these any more?  Offline I think is &apos;dead&apos;, unused now.  Split not.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17265&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17265&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    This seems like a good refactoring.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17266&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17266&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Good&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17267&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17267&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Should this be public?  Should it remain internal to the HTable hidden?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17268&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17268&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Yeah, it could be a long time before a region comes on line if its in a GC or some such.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17269&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17269&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Yeah, what Ted says... Can you close when done?  See MetaEditor/MetaReader.  They do this a bunch.  Closing means for sure the zk and connection resources will be cleaned up afterward.  Its reference counting so keepign around an HTable could mess it up.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17270&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17270&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Yeah, so, what happens if daughter has split by the time I get here?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17271&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17271&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    So if interrupted or we don&apos;t find it by the time the blocking time has passed, we just return null?   What you reckon?  We should at least complain?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17272&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17272&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Does the scan of meta start at first table region?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Michael&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-05-16 01:53:09, enis wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-05-16 01:53:09)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;enis&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13277214" author="lhofhansl" created="Wed, 16 May 2012 22:38:36 +0000"  >&lt;p&gt;As a general comment I think it would be better if instead of blocking on the server, HTable.getStartEndKeys() could detect the inconsistency and try again.&lt;/p&gt;</comment>
                            <comment id="13277236" author="jiraposter@reviews.apache.org" created="Wed, 16 May 2012 23:01:04 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 21:32:56, Michael Stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/HTable.java, line 473&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109116#file109116line473&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109116#file109116line473&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Why you remove this?  We don&apos;t return these any more?  Offline I think is &apos;dead&apos;, unused now.  Split not.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If we discover that a region has been split in META, than, it is past point-of-no-return and the region cannot be seen un-split anymore, even though concurrent rs failures.  for getStartEndKeys() we are returning whatever the getRegionLocation() provides. getRegionLocations() ignores offline regions, but returns daughter regions for split-parents (which are offline as well).&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 21:32:56, Michael Stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 351&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line351&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line351&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Should this be public?  Should it remain internal to the HTable hidden?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;MetaScanner is confusing in its visibility. It&apos;s javadoc states &quot;Although public visibility, this is not a public-facing API and may evolve in minor releases.&quot;, but it is annotated with @InterfaceAudience.Public @InterfaceStability.Evolving. I think for BlockingMetaScannerVisitor, we should set the visibility the same as MetaScannerVisitor. I think, MetaScannerVisitor itself is of little use without the BlockingMetaScannerVisitor functionality due to this issue. &lt;br/&gt;
Shall we change MetaScanner, MSV and BMSV to be @InterfaceAudience.Private, wdyt? &lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 21:32:56, Michael Stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java, line 310&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109115#file109115line310&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109115#file109115line310&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Bit of javadoc to say this is best-effort.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Also, does this belong in MetaReader (Won&apos;t hold you to it... these two classes, a MetaReader vs MetaEditor are kinda silly... this whole catalog package needs killing).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;agreed&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 21:32:56, Michael Stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 395&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line395&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line395&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Yeah, so, what happens if daughter has split by the time I get here?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The scanner provides the regions results in sorted order, and since the daughters are sorted after the parent, we always process parent first. When we process the daughter regions manually (processRow(resultA)), we also add them to the daughterRegions set. If the scanner also sees them, they are just skipped (line 373)&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 21:32:56, Michael Stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 434&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line434&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line434&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     So if interrupted or we don&apos;t find it by the time the blocking time has passed, we just return null?   What you reckon?  We should at least complain?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yeah, I think we can throw RegionOfflineException upon timeout and interrupt. The operation can be retried by the client upon timeout.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 21:32:56, Michael Stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 465&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line465&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line465&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Does the scan of meta start at first table region?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;MetaScanner.metaScan() ensures that the scan starts at the first table region. &lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2012-05-16 21:32:56, Michael Stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java, line 390&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line390&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff/1/?file=109117#file109117line390&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Yeah, what Ted says... Can you close when done?  See MetaEditor/MetaReader.  They do this a bunch.  Closing means for sure the zk and connection resources will be cleaned up afterward.  Its reference counting so keepign around an HTable could mess it up.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We are already closing the HTable&apos;s. But let me see how we can best reuse Htable instances. &lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enis&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/#review7939&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#review7939&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-05-16 01:53:09, enis wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-05-16 01:53:09)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;enis&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13277306" author="jiraposter@reviews.apache.org" created="Thu, 17 May 2012 01:00:10 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-05-17 00:58:21.965488)&lt;/p&gt;


&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;v2: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;addressed review comments&lt;/li&gt;
	&lt;li&gt;when timeout and interrupt throws RegionOfflineException.&lt;/li&gt;
	&lt;li&gt;reuse HTable instances in BMSV.&lt;/li&gt;
	&lt;li&gt;adds close() to MSV assuming it is indeed not public, evolving but private. we should decide the visibility.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;

&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;

&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java 5d4be3f &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java 5cac9af &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java 0ad9b18 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 7b4f4a2 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;enis&lt;/p&gt;
</comment>
                            <comment id="13277492" author="zhihyu@ebaysf.com" created="Thu, 17 May 2012 02:14:57 +0000"  >&lt;p&gt;v2 from Enis&lt;/p&gt;</comment>
                            <comment id="13277494" author="jiraposter@reviews.apache.org" created="Thu, 17 May 2012 02:16:03 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/5133/#review7948&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#review7948&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;v2 looks much better.&lt;/p&gt;


&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17287&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17287&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    We may need to mark this JIRA an incompatible change.&lt;/p&gt;



&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17283&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17283&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    &apos;with&apos; -&amp;gt; &apos;by&apos;&lt;/p&gt;



&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17284&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17284&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    This class can be private.&lt;/p&gt;



&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17285&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17285&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    The interval can be made shorter.&lt;/p&gt;



&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/5133/#comment17286&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/#comment17286&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Name this method verifyRegionsOfHTable ?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-05-17 00:58:21, enis wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/5133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-05-17 00:58:21)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We found this issue when running large scale ingestion tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5754&quot; title=&quot;data lost with gora continuous ingest test (goraci)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5754&quot;&gt;&lt;del&gt;HBASE-5754&lt;/del&gt;&lt;/a&gt;. The problem is that the .META. table updates are not atomic while splitting a region. In SplitTransaction, there is a time lap between the marking the parent offline, and adding of daughters to the META table. This can result in clients using MetaScanner, of HTable.getStartEndKeys (used by the TableInputFormat) missing regions which are made just offline, but the daughters are not added yet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch is the approach 2 mentioned in the issue comments, mainly during META scan, if we detect that the region is split, we block until the information for the child regions are available in META and manually feed those rows to the MetaScanner. Although approach 3 (using local region transactions) seems cleaner, they are not available under branch 0.92, which I think should also incorporate this fix. I&apos;ll provide ports once we are clear for trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Also this patch does not fix MetaReader (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3475&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-3475&lt;/a&gt;). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5986&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java 8873512 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java 5d4be3f &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java 5cac9af &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/HTable.java b8290e4 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java f404999 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/HMaster.java 0ad9b18 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 7b4f4a2 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java a8091e6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/5133/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/5133/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;added extensive tests under TestEndToEndSplitTranscation, and ran existing unit tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;enis&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13277516" author="hadoopqa" created="Thu, 17 May 2012 03:06:37 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527760/5986-v2.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527760/5986-v2.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop23.  The patch compiles against the hadoop 0.23.x profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 32 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1903//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1903//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1903//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1903//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1903//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1903//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13278142" author="zhihyu@ebaysf.com" created="Thu, 17 May 2012 19:32:56 +0000"  >&lt;p&gt;@Stack:&lt;br/&gt;
What do you think of patch v2 ?&lt;/p&gt;</comment>
                            <comment id="13281999" author="zhihyu@ebaysf.com" created="Wed, 23 May 2012 22:39:15 +0000"  >&lt;p&gt;Patch v3 from Enis.&lt;/p&gt;</comment>
                            <comment id="13282036" author="hadoopqa" created="Wed, 23 May 2012 23:26:09 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12528806/HBASE-5986_v3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12528806/HBASE-5986_v3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop23.  The patch compiles against the hadoop 0.23.x profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 34 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.replication.TestReplication&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestAssignmentManager&lt;br/&gt;
                  org.apache.hadoop.hbase.replication.TestMultiSlaveReplication&lt;br/&gt;
                  org.apache.hadoop.hbase.replication.TestMasterReplication&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1972//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1972//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1972//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1972//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1972//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1972//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13282039" author="zhihyu@ebaysf.com" created="Wed, 23 May 2012 23:32:53 +0000"  >&lt;p&gt;I ran TestAssignmentManager with patch v3 and it passed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Running org.apache.hadoop.hbase.master.TestAssignmentManager
Tests run: 10, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 5.703 sec
...
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 17.004s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13282069" author="stack" created="Thu, 24 May 2012 00:20:40 +0000"  >&lt;p&gt;Committed to trunk.  Thanks for the patch Enis.&lt;/p&gt;</comment>
                            <comment id="13282079" author="stack" created="Thu, 24 May 2012 00:53:08 +0000"  >&lt;p&gt;Thanks for running tests Ted.&lt;/p&gt;</comment>
                            <comment id="13282117" author="hudson" created="Thu, 24 May 2012 02:05:25 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2919 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2919/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2919/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt; Clients can see holes in the META table when regions are being split (Revision 1342099)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/metrics/RegionServerDynamicStatistics.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13282138" author="zhihyu@ebaysf.com" created="Thu, 24 May 2012 02:31:07 +0000"  >&lt;p&gt;This JIRA is marked as bug.&lt;br/&gt;
The reason behind not choosing approach #3 is to facilitate backporting to 0.92 and 0.94&lt;/p&gt;

&lt;p&gt;I think 0.92.2 and 0.94.1 should carry this fix.&lt;/p&gt;</comment>
                            <comment id="13282144" author="lhofhansl" created="Thu, 24 May 2012 02:48:57 +0000"  >&lt;p&gt;+1 for 0.94, can&apos;t speak for 0.92.&lt;/p&gt;</comment>
                            <comment id="13282146" author="zhihyu@ebaysf.com" created="Thu, 24 May 2012 02:57:57 +0000"  >&lt;p&gt;@Enis:&lt;br/&gt;
There&apos;re 5 files which have conflicts with 0.94 branch.&lt;br/&gt;
Can you prepare patch for 0.94 ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13283649" author="enis" created="Fri, 25 May 2012 18:09:11 +0000"  >&lt;p&gt;Attaching patches for 0.92 and 0.94 branches. They are direct ports of the v3 patch, but 0.92 patch also includes HRegionServer.getOnlineRegions(byte[] tableName) function directly copied from 0.94, since we need it. I have discovered this when testing with 0.92, so I would like it to make into it. &lt;/p&gt;


&lt;p&gt;One minor mishap from my part is that the v3 patch which went into trunk includes an unrelated change in RegionServerDynamicStatistics. Related issue is &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6025&quot; title=&quot;Expose Hadoop Dynamic Metrics through JSON Rest interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6025&quot;&gt;&lt;del&gt;HBASE-6025&lt;/del&gt;&lt;/a&gt;. Although the change is trivial ,changing RegionServerDynamicStatistics to extend hbase-specific MetricsMBeanBase rather than hadoop-specific MetricsDynamicMBeanBase, we may want to note this, or revert that part. Backport patches does not include this change. &lt;br/&gt;
Sorry for the trouble guys. &lt;/p&gt;</comment>
                            <comment id="13283708" author="zhihyu@ebaysf.com" created="Fri, 25 May 2012 19:44:41 +0000"  >&lt;p&gt;@Enis:&lt;br/&gt;
Did you have a chance to run the backports through respective test suite ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13283735" author="enis" created="Fri, 25 May 2012 20:28:17 +0000"  >&lt;p&gt;@Ted, I did run TestEndToEndSplitTransaction, but not the whole suite. Let me do that. &lt;/p&gt;</comment>
                            <comment id="13283831" author="hudson" created="Sat, 26 May 2012 00:06:50 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #16 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/16/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/16/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt; Clients can see holes in the META table when regions are being split (Revision 1342099)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/metrics/RegionServerDynamicStatistics.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13283881" author="enis" created="Sat, 26 May 2012 02:06:37 +0000"  >&lt;p&gt;Here are the test results for 0.94: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Tests run: 551, Failures: 0, Errors: 0, Skipped: 0
...
Tests run: 932, Failures: 1, Errors: 2, Skipped: 9

Failed tests:   testShutdownSimpleFixup(org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster): expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;

Tests in error: 
  testDelayedRpcImmediateReturnValue(org.apache.hadoop.hbase.ipc.TestDelayedRpc): Call to /127.0.0.1:53586 failed on socket timeout exception: java.net.SocketTimeoutException: 1000 millis timeout &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; channel to be ready &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; read. ch : java.nio.channels.SocketChannel[connected local=/127.0.0.1:53623 remote=/127.0.0.1:53586]
  testLocalHBaseCluster(org.apache.hadoop.hbase.TestLocalHBaseCluster): Master not initialized after 200 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I rerun the tests locally with success, except TestLocalHBaseCluster. But it fails on 0.94 HEAD as well for me. &lt;/p&gt;

&lt;p&gt;For 0.92:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

Results :

Failed tests:   testMultipleResubmits(org.apache.hadoop.hbase.master.TestSplitLogManager)
  testcomputeHDFSBlocksDistribution(org.apache.hadoop.hbase.util.TestFSUtils)

Tests in error:
  testClusterRestart(org.apache.hadoop.hbase.master.TestRestartCluster): org.apache.hadoop.hbase.PleaseHoldException: Master is initializing
  testWholesomeSplit(org.apache.hadoop.hbase.regionserver.TestSplitTransaction): Failed delete of /homes/hortonde/enis/code/hbase-0.92/target/test-data/af023188-0b23-4f9d-a9bc-a074e94e57f8/org.apache.hadoop.hbase.regionserver.TestSplitTransaction/table/7c59b6677ad46bf3f652a83de1e62bcb
  testRollback(org.apache.hadoop.hbase.regionserver.TestSplitTransaction): Target HLog directory already exists: /homes/hortonde/enis/code/hbase-0.92/target/test-data/af023188-0b23-4f9d-a9bc-a074e94e57f8/org.apache.hadoop.hbase.regionserver.TestSplitTransaction/logs
  testRollback(org.apache.hadoop.hbase.regionserver.TestSplitTransaction)
  loadTest[0](org.apache.hadoop.hbase.util.TestMiniClusterLoadSequential): test timed out after 120000 milliseconds
  loadTest[0](org.apache.hadoop.hbase.util.TestMiniClusterLoadParallel): test timed out after 120000 milliseconds

Tests run: 1135, Failures: 2, Errors: 6, Skipped: 8
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Also run those failed tests locally with success. It seems we can go ahead with 0.92 and 0.94 if you don&apos;t have any concerns. &lt;/p&gt;</comment>
                            <comment id="13283936" author="zhihyu@ebaysf.com" created="Sat, 26 May 2012 08:55:15 +0000"  >&lt;p&gt;I verified that the 3 failed tests for 0.94 passed.&lt;/p&gt;

&lt;p&gt;Integrated patch for 0.94 to 0.94 branch.&lt;/p&gt;</comment>
                            <comment id="13283942" author="zhihyu@ebaysf.com" created="Sat, 26 May 2012 09:19:48 +0000"  >&lt;p&gt;I verified the failed tests for 0.92 passed locally.&lt;/p&gt;

&lt;p&gt;Integrated to 0.92 branch.&lt;/p&gt;

&lt;p&gt;Thanks for the patches, Enis.&lt;/p&gt;</comment>
                            <comment id="13283947" author="hudson" created="Sat, 26 May 2012 09:57:15 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #218 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/218/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/218/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt; Clients can see holes in the META table when regions are being split (Enis) (Revision 1342865)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13283968" author="hudson" created="Sat, 26 May 2012 12:12:54 +0000"  >&lt;p&gt;Integrated in HBase-0.92 #422 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92/422/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92/422/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt; Clients can see holes in the META table when regions are being split (Enis) (Revision 1342866)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13283990" author="hudson" created="Sat, 26 May 2012 14:49:29 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #32 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/32/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/32/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt; Clients can see holes in the META table when regions are being split (Enis) (Revision 1342865)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13287236" author="hudson" created="Fri, 1 Jun 2012 08:08:18 +0000"  >&lt;p&gt;Integrated in HBase-0.92-security #109 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92-security/109/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92-security/109/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5986&quot; title=&quot;Clients can see holes in the META table when regions are being split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5986&quot;&gt;&lt;del&gt;HBASE-5986&lt;/del&gt;&lt;/a&gt; Clients can see holes in the META table when regions are being split (Enis) (Revision 1342866)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/catalog/MetaEditor.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/client/HTable.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/client/MetaScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/regionserver/TestEndToEndSplitTransaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12550283">HBASE-5754</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12527760" name="5986-v2.txt" size="37767" author="zhihyu@ebaysf.com" created="Thu, 17 May 2012 02:14:57 +0000"/>
                            <attachment id="12529758" name="HBASE-5986-0.92.patch" size="39219" author="enis" created="Fri, 25 May 2012 18:09:11 +0000"/>
                            <attachment id="12529759" name="HBASE-5986-0.94.patch" size="37756" author="enis" created="Fri, 25 May 2012 18:09:11 +0000"/>
                            <attachment id="12526454" name="HBASE-5986-test_v1.patch" size="11572" author="enis" created="Thu, 10 May 2012 23:51:56 +0000"/>
                            <attachment id="12528806" name="HBASE-5986_v3.patch" size="39449" author="zhihyu@ebaysf.com" created="Wed, 23 May 2012 22:39:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 11 May 2012 00:36:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>239092</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 29 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i068j3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34313</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>