<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:25:28 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5179/HBASE-5179.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5179] Concurrent processing of processFaileOver and ServerShutdownHandler may cause region to be assigned before log splitting is completed, causing data loss</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5179</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;If master&apos;s processing its failover and ServerShutdownHandler&apos;s processing happen concurrently, it may appear following  case.&lt;br/&gt;
1.master completed splitLogAfterStartup()&lt;br/&gt;
2.RegionserverA restarts, and ServerShutdownHandler is processing.&lt;br/&gt;
3.master starts to rebuildUserRegions, and RegionserverA is considered as dead server.&lt;br/&gt;
4.master starts to assign regions of RegionserverA because it is a dead server by step3.&lt;/p&gt;

&lt;p&gt;However, when doing step4(assigning region), ServerShutdownHandler may be doing split log, Therefore, it may cause data loss.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12538023">HBASE-5179</key>
            <summary>Concurrent processing of processFaileOver and ServerShutdownHandler may cause region to be assigned before log splitting is completed, causing data loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zjushch">chunhui shen</assignee>
                                    <reporter username="zjushch">chunhui shen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jan 2012 06:53:21 +0000</created>
                <updated>Thu, 25 Oct 2012 16:46:52 +0000</updated>
                            <resolved>Thu, 25 Oct 2012 16:46:52 +0000</resolved>
                                    <version>0.90.2</version>
                                    <fixVersion>0.92.3</fixVersion>
                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                            <comments>
                            <comment id="13183915" author="zjushch" created="Wed, 11 Jan 2012 06:54:35 +0000"  >&lt;p&gt;Master logs, Let&apos;s see the region a04d0ac0a360e8cf5edf74af4ce64b16.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-12-30 02:20:05,285 INFO org.apache.hadoop.hbase.master.HMaster: Master startup proceeding: master failover 
2011-12-30 02:20:06,779 INFO org.apache.hadoop.hbase.master.ServerManager: Server start rejected; we already have dw83.kgb.sqa.cm4:60020 registered; existingServer=serverName=dw83.kgb.sqa.cm4,60020,1325180976942, load=(requests=0, regions=7, usedHeap=10831, maxHeap=15872), newServer=serverName=dw83.kgb.sqa.cm4,60020,1325182806080, load=(requests=0, regions=0, usedHeap=230, maxHeap=15872) 
2011-12-30 02:20:06,779 INFO org.apache.hadoop.hbase.master.ServerManager: Triggering server recovery; existingServer dw83.kgb.sqa.cm4,60020,1325180976942 looks stale 
2011-12-30 02:20:06,780 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: based on AM, current region=-ROOT-,,0.70236052 is on server=serverName=dw80.kgb.sqa.cm4,60020,1325180470774, load=(requests=0, regions=0, usedHeap=0, maxHeap=0) server being checked: dw83.kgb.sqa.cm4,60020,1325180976942 
2011-12-30 02:20:06,780 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: based on AM, current region=.META.,,1.1028785192 is on server=serverName=dw80.kgb.sqa.cm4,60020,1325180470774, load=(requests=0, regions=0, usedHeap=0, maxHeap=0) server being checked: dw83.kgb.sqa.cm4,60020,1325180976942 
2011-12-30 02:20:06,781 DEBUG org.apache.hadoop.hbase.master.ServerManager: Added=dw83.kgb.sqa.cm4,60020,1325180976942 to dead servers, submitted shutdown handler to be executed, root=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, meta=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; 
2011-12-30 02:20:07,839 DEBUG org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Creating writer path=hdfs:&lt;span class=&quot;code-comment&quot;&gt;//dw74.kgb.sqa.cm4:9000/hbase-common/writetest/a04d0ac0a360e8cf5edf74af4ce64b16/recovered.edits/0000000000965355783.temp region=a04d0ac0a360e8cf5edf74af4ce64b16 
&lt;/span&gt;2011-12-30 02:20:08,965 DEBUG org.apache.hadoop.hbase.zookeeper.ZKAssign: master:60000-0x134784f727b0543 Creating (or updating) unassigned node &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a04d0ac0a360e8cf5edf74af4ce64b16 with OFFLINE state 
2011-12-30 02:20:08,988 INFO org.apache.hadoop.hbase.master.AssignmentManager: Failed-over master needs to process 14 regions in transition 
2011-12-30 02:20:09,017 INFO org.apache.hadoop.hbase.master.AssignmentManager: Processing region writetest,B8VCH6I7EP0SLJA6KU8VTE75RCCZMZ14GTBRSTC7QOW9L2Q818R1O4PLA9ZX64JD5ZZTSAK021NUYUUHJ0BS9NTTCQ09PBRZMZPL,1325179237366.a04d0ac0a360e8cf5edf74af4ce64b16. in state M_ZK_REGION_OFFLINE 
2011-12-30 02:20:09,017 DEBUG org.apache.hadoop.hbase.master.handler.ClosedRegionHandler: Handling CLOSED event &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a04d0ac0a360e8cf5edf74af4ce64b16 
2011-12-30 02:20:09,017 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Forcing OFFLINE; was=writetest,B8VCH6I7EP0SLJA6KU8VTE75RCCZMZ14GTBRSTC7QOW9L2Q818R1O4PLA9ZX64JD5ZZTSAK021NUYUUHJ0BS9NTTCQ09PBRZMZPL,1325179237366.a04d0ac0a360e8cf5edf74af4ce64b16. state=OFFLINE, ts=1325182808966 
2011-12-30 02:20:09,020 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Assigning region writetest,B8VCH6I7EP0SLJA6KU8VTE75RCCZMZ14GTBRSTC7QOW9L2Q818R1O4PLA9ZX64JD5ZZTSAK021NUYUUHJ0BS9NTTCQ09PBRZMZPL,1325179237366.a04d0ac0a360e8cf5edf74af4ce64b16. to dw81.kgb.sqa.cm4,60020,1325181205124 
2011-12-30 02:20:09,365 DEBUG org.apache.hadoop.hbase.master.handler.OpenedRegionHandler: Opened region writetest,B8VCH6I7EP0SLJA6KU8VTE75RCCZMZ14GTBRSTC7QOW9L2Q818R1O4PLA9ZX64JD5ZZTSAK021NUYUUHJ0BS9NTTCQ09PBRZMZPL,1325179237366.a04d0ac0a360e8cf5edf74af4ce64b16. on dw81.kgb.sqa.cm4,60020,1325181205124 
2011-12-30 02:20:20,144 INFO org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Closed path hdfs:&lt;span class=&quot;code-comment&quot;&gt;//dw74.kgb.sqa.cm4:9000/hbase-common/writetest/a04d0ac0a360e8cf5edf74af4ce64b16/recovered.edits/0000000000965355783.temp (wrote 146434 edits in 1761ms) &lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13183920" author="zjushch" created="Wed, 11 Jan 2012 06:59:47 +0000"  >&lt;p&gt;In the patch,&lt;br/&gt;
we ensure ProcessingDeadServers not be processed in master&apos;s processing of failover &lt;/p&gt;</comment>
                            <comment id="13184120" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 15:11:43 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;ServerName&amp;gt; processingDeadServers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;ServerName&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The field name above sounds like method name. How about naming it deadServersUnderProcessing ? Related method names should be changed as well.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+   * Called on startup. Figures whether a fresh cluster start of we are joining
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;should read &apos;start or we are&apos;.&lt;/p&gt;

&lt;p&gt;For ServerManager.java and DeadServer.java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Set&amp;lt;ServerName&amp;gt; getProcessingDeadServers() {
+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.deadservers.cloneProcessingDeadServers();
+  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The method should be called cloneDeadServersUnderProcessing().&lt;/p&gt;</comment>
                            <comment id="13184170" author="ram_krish" created="Wed, 11 Jan 2012 16:11:54 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
Is this issue applicable for 0.90.6? If so can you prepare a patch for 0.90 also?&lt;/p&gt;</comment>
                            <comment id="13184181" author="ram_krish" created="Wed, 11 Jan 2012 16:40:28 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
Can you take a look at HBAE-4748.  It is similar to this but there the data loss was w.r.t META leading to more critical data loss.  But it is quite rare but still possible.  Do you have any suggestions for that?&lt;/p&gt;</comment>
                            <comment id="13184202" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 17:11:18 +0000"  >&lt;p&gt;Chunhui&apos;s patch for TRUNK with minor renaming.&lt;/p&gt;</comment>
                            <comment id="13184227" author="ram_krish" created="Wed, 11 Jan 2012 17:47:35 +0000"  >&lt;p&gt;Patch looks good to me.. Tomorrow will try out in the cluster.&lt;/p&gt;</comment>
                            <comment id="13184237" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 17:59:23 +0000"  >&lt;p&gt;Chunhui&apos;s patch rebased for 0.90&lt;/p&gt;</comment>
                            <comment id="13184244" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 18:10:53 +0000"  >&lt;p&gt;I ran the following on MacBook and they passed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 1143  mt -Dtest=TestSplitLogManager
 1145  mt -Dtest=TestAdmin#testShouldCloseTheRegionBasedOnTheEncodedRegionName
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13184286" author="stack" created="Wed, 11 Jan 2012 19:01:51 +0000"  >&lt;p&gt;I agree with the spirit of this class.  Good stuff Chunhui.&lt;/p&gt;

&lt;p&gt;This is awkward name for a method, getDeadServersUnderProcessing.  Should it be getDeadServers?  Does it need to be a public method?  Seems fine that it be package private.&lt;/p&gt;

&lt;p&gt;Is serversWithoutSplitLog a good name for a local variable?  Should it be deadServers with a comment saying that deadServers are processed by servershutdownhandler and it will be taking care of the log splitting?&lt;/p&gt;

&lt;p&gt;Is this right &amp;#8211; for trunk?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!serverManager.isServerOnline(regionLocation.getServerName())) {
+      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!onlineServers.contains(regionLocation.getHostname())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Online servers is keyed by a ServerName, not a hostname.&lt;/p&gt;

&lt;p&gt;What is a deadServersUnderProcessing?  Does DeadServers keep list of all servers that ever died?  Is that a good idea?  Shouldn&apos;t finish remove item from deadservers rather than just from deadServersUnderProcessing&lt;/p&gt;

&lt;p&gt;Change  name of this method, cloneProcessingDeadServers.  Just call it getDeadServers?  That its a clone is an internal implementation detail?&lt;/p&gt;



</comment>
                            <comment id="13184287" author="stack" created="Wed, 11 Jan 2012 19:02:04 +0000"  >&lt;p&gt;Its hard to do a test for this?&lt;/p&gt;</comment>
                            <comment id="13184296" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 19:16:01 +0000"  >&lt;p&gt;@Stack:&lt;br/&gt;
The following code is for 0.90 branch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!serverManager.isServerOnline(regionLocation.getServerName())) {
+      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!onlineServers.contains(regionLocation.getHostname())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I agree that serversWithoutSplitLog isn&apos;t a very good name. It holds both online servers and dead servers. How about naming it knownServers ?&lt;/p&gt;

&lt;p&gt;ServerManager.java already has:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Set&amp;lt;ServerName&amp;gt; getDeadServers() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.deadservers.clone();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13184443" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 22:11:05 +0000"  >&lt;p&gt;New patch for 0.90&lt;br/&gt;
Now TestRollingRestart passes.&lt;/p&gt;</comment>
                            <comment id="13184448" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 22:17:41 +0000"  >&lt;p&gt;I think the reason Chunhui introduced a new Set for the dead servers being processed is that DeadServer is supposed to remember dead servers:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   * Set of known dead servers.  On znode expiration, servers are added here.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;DeadServer.cleanPreviousInstance() is called by ServerManager.checkIsDead() when the server becomes live again.&lt;/p&gt;</comment>
                            <comment id="13184467" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 22:43:43 +0000"  >&lt;p&gt;Patch v3 addresses Stack&apos;s comments&lt;/p&gt;

&lt;p&gt;Some names are open to suggestion.&lt;/p&gt;</comment>
                            <comment id="13184533" author="stack" created="Wed, 11 Jan 2012 23:26:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think the reason Chunhui introduced a new Set for the dead servers being processed is that DeadServer is supposed to remember dead servers&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I seem to remember such a need but I&apos;d think we should doc&apos; it up some more in DeadServer so next person in here looking at code has a chance figuring whats up.&lt;/p&gt;

&lt;p&gt;On v3:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
getDeadServersUnderProcessing
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;is still public and I think it should be named getDeadServersBeingProcessed ... or BeingHandled... or better so it matches areDeadServersInProgress, getDeadServersInProgress.. they are in the process of being made into DeadServers!!! (and there is missing javadoc explaining what this method is at least relative to getDeadServers &amp;#8211; that its servers that are going through ServerShutdownHandler processing).&lt;/p&gt;

&lt;p&gt;Does this method need to be in the Interface for ServerManager (The less in the Interface the better)?&lt;/p&gt;

&lt;p&gt;knownServers should be onlineServers which makes me think that this check for DeadServersInProgress should be made inside in ServerManager so that what comes out of getOnlineServers has already had the InProgress servers stripped?&lt;/p&gt;

&lt;p&gt;Do you think we need that the new Collection deadServersUnderProcessing should instead be called inProgress... and a server is in either inProgress or its in the deadServers list?  On remove, it gets moved (under synchronize) from one list to the other.&lt;/p&gt;


</comment>
                            <comment id="13184556" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 23:53:21 +0000"  >&lt;p&gt;Adopted getDeadServersBeingProcessed() method name.&lt;br/&gt;
Also made it package private.&lt;/p&gt;

&lt;p&gt;Waiting for Chunhui&apos;s feedback about Stack&apos;s comments.&lt;/p&gt;</comment>
                            <comment id="13184668" author="zjushch" created="Thu, 12 Jan 2012 02:08:48 +0000"  >&lt;p&gt;I agree with the renaming in patchV4.&lt;/p&gt;</comment>
                            <comment id="13184686" author="zjushch" created="Thu, 12 Jan 2012 03:02:47 +0000"  >&lt;p&gt;In patch v5, I add javadoc to explain getDeadServersBeingProcessed() and getDeadServers.&lt;br/&gt;
And also add some more in DeadServer about deadServersBeingProcessed.&lt;/p&gt;

&lt;p&gt;About Stack&apos;s comment that a server is in either inProgress or its in the deadServers list?&lt;br/&gt;
I think a server could both in processingDeadServers  list and deadServers list.&lt;br/&gt;
DeadServers list only store one instance for one regionserver, but processingDeadServers  list may store multi instances for one regionserver with several startcode&lt;/p&gt;</comment>
                            <comment id="13184697" author="zhihyu@ebaysf.com" created="Thu, 12 Jan 2012 03:29:48 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ * &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; to hold dead servers list, utility querying dead server list and being
+ * processed dead servers by the ServerShutdownHandler.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The above should read &apos;querying dead server list and the dead servers being processed by ...&apos;.&lt;/p&gt;</comment>
                            <comment id="13184754" author="stack" created="Thu, 12 Jan 2012 06:26:31 +0000"  >&lt;p&gt;I think getDeadServersInProgress is better than getDeadServersBeingProcessed since it relates to areDeadServersInProgress (I can fix this on commit &amp;#8211; would also change name of the Collection in DeadServers so its inProgress).&lt;/p&gt;

&lt;p&gt;Yeah, would be interested in notion that we do this server checking inside in ServerManager so when you ask for onlineServers, this stuff has been done for you already... or is thought that ServerManager need not know about &apos;handlers&apos;.... that HMaster only should have to know whats running under it (A ServerManager and handlers such as ServerShutdownHandler).&lt;/p&gt;</comment>
                            <comment id="13184755" author="ram_krish" created="Thu, 12 Jan 2012 06:29:01 +0000"  >&lt;p&gt;@Ted, @Stack @Chunhui&lt;/p&gt;

&lt;p&gt;I think we may have to combine the change in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4748&quot; title=&quot;Race between creating recovered edits for META and master assigning ROOT and META.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4748&quot;&gt;&lt;del&gt;HBASE-4748&lt;/del&gt;&lt;/a&gt; as Chunhui suggested&lt;br/&gt;
12/Jan/12 03:23. Is it ok to combine it? Because only then the processFailOver  and SSH problem can be solved totally.  Pls suggest.&lt;/p&gt;

&lt;p&gt;Sorry for the typo&lt;/p&gt;</comment>
                            <comment id="13184760" author="zhihyu@ebaysf.com" created="Thu, 12 Jan 2012 06:41:57 +0000"  >&lt;p&gt;You mean hbase-4748, right ?&lt;br/&gt;
I think we should combine the two. &lt;/p&gt;</comment>
                            <comment id="13184764" author="zjushch" created="Thu, 12 Jan 2012 06:47:29 +0000"  >&lt;p&gt;I think so too&lt;/p&gt;</comment>
                            <comment id="13184772" author="stack" created="Thu, 12 Jan 2012 07:00:02 +0000"  >&lt;p&gt;Sure.  Do what you fellas think best. &lt;/p&gt;</comment>
                            <comment id="13185017" author="sunnygao" created="Thu, 12 Jan 2012 15:31:08 +0000"  >&lt;p&gt;Please review it first. I will verify tomorrow&lt;/p&gt;</comment>
                            <comment id="13185075" author="zhihyu@ebaysf.com" created="Thu, 12 Jan 2012 17:10:44 +0000"  >&lt;p&gt;For Jinchao&apos;s patch v3:&lt;br/&gt;
I think it makes sense. Let us know the result of verification.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isProcessingServer(HServerAddress address) {
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (serverManager.getDeadServersBeingProcessed() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A better name for the method would be isDeadServerBeingProcessed().&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-    rit = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.
-      processRegionInTransitionAndBlockUntilAssigned(HRegionInfo.FIRST_META_REGIONINFO);
+    rit = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager
+        .processRegionInTransitionAndBlockUntilAssigned(HRegionInfo.FIRST_META_REGIONINFO);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;There is no material change above. We&apos;d better remove it.&lt;/p&gt;</comment>
                            <comment id="13185111" author="zhihyu@ebaysf.com" created="Thu, 12 Jan 2012 17:57:18 +0000"  >&lt;p&gt;Raising priority now that the fix covers &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4748&quot; title=&quot;Race between creating recovered edits for META and master assigning ROOT and META.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4748&quot;&gt;&lt;del&gt;HBASE-4748&lt;/del&gt;&lt;/a&gt; as well.&lt;/p&gt;</comment>
                            <comment id="13185411" author="zjushch" created="Fri, 13 Jan 2012 03:25:17 +0000"  >&lt;p&gt;For Jinchao&apos;s patch v3, I think it&apos;s fine.&lt;br/&gt;
Maybe RootLocationEditor.deleteRootLocation(this.master.getZooKeeper()) when assigning root is a possible problem.&lt;br/&gt;
But it&apos;s very very rare or impossible where SSH delete RootLocation in assigning root before adding ROOT region to RIT and master getRootLocation() returns null causing assigning root again.&lt;/p&gt;</comment>
                            <comment id="13186099" author="sunnygao" created="Sat, 14 Jan 2012 05:38:03 +0000"  >&lt;p&gt;When master starts, As current flow, RS has three part:&lt;br/&gt;
1.Some has registered in Hmaster by heatbeat report&lt;br/&gt;
2.Some is dead server being processed by ssh&lt;br/&gt;
3.Some is waiting zk is expired(default session timeout is 3 minutes)&lt;/p&gt;

&lt;p&gt;1,2 is easy.&lt;br/&gt;
3 is little diffult.&lt;/p&gt;</comment>
                            <comment id="13186100" author="sunnygao" created="Sat, 14 Jan 2012 05:40:23 +0000"  >&lt;p&gt;Other problem is shutdownhandler flow can&apos;t get the meta flag when master starts.&lt;/p&gt;

&lt;p&gt;See below comment in expired function.&lt;/p&gt;

&lt;p&gt; // Was this server carrying meta?  Can&apos;t ask CatalogTracker because it&lt;br/&gt;
    // may have reset the meta location as null already (it may have already&lt;br/&gt;
    // run into fact that meta is dead).  I can ask assignment manager. It&lt;br/&gt;
    // has an inmemory list of who has what.  This list will be cleared as we&lt;br/&gt;
    // process the dead server but should be  find asking it now.&lt;br/&gt;
    HServerAddress address = ct.getMetaLocation();&lt;br/&gt;
    boolean carryingMeta =&lt;/p&gt;</comment>
                            <comment id="13186108" author="zhihyu@ebaysf.com" created="Sat, 14 Jan 2012 05:49:30 +0000"  >&lt;p&gt;Should we decouple &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4748&quot; title=&quot;Race between creating recovered edits for META and master assigning ROOT and META.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4748&quot;&gt;&lt;del&gt;HBASE-4748&lt;/del&gt;&lt;/a&gt; from this issue ?&lt;/p&gt;</comment>
                            <comment id="13186116" author="sunnygao" created="Sat, 14 Jan 2012 06:01:27 +0000"  >&lt;p&gt;I suggest that we don&apos;t. I need some time to a more detailed verification.&lt;/p&gt;</comment>
                            <comment id="13186142" author="sunnygao" created="Sat, 14 Jan 2012 09:07:51 +0000"  >&lt;p&gt;Please resolve this issue firstly. Maybe HBase-4748 need a long time.&lt;/p&gt;</comment>
                            <comment id="13186155" author="sunnygao" created="Sat, 14 Jan 2012 10:57:22 +0000"  >&lt;p&gt;@zhihong&lt;br/&gt;
Regarding to 5179-90v2.patch, &lt;br/&gt;
when dead servers are processing, their logs would be split by ServerShutdownHandler.&lt;br/&gt;
Maybe this change is result in meta data loss. &lt;br/&gt;
for example:&lt;br/&gt;
without patch:&lt;br/&gt;
1.split the Hlog with regionsever don&apos;t report itself(eg My comments@14/Jan/12 05:38 &lt;br/&gt;
  1,2 case will don&apos;t report).&lt;/p&gt;

&lt;p&gt;2. assign the Meta/Root region(If meta region server has some exceptions, because we have split the Hlog, so there is no meta data loss)&lt;/p&gt;

</comment>
                            <comment id="13186157" author="sunnygao" created="Sat, 14 Jan 2012 11:01:14 +0000"  >&lt;p&gt;@zhihong&lt;br/&gt;
I am sorry to submit my comments lately. I am testing patch v2. &lt;/p&gt;</comment>
                            <comment id="13186159" author="zhihyu@ebaysf.com" created="Sat, 14 Jan 2012 11:04:29 +0000"  >&lt;p&gt;@Jinchao:&lt;br/&gt;
Do you have master log that would support your comment about .META. data loss ?&lt;br/&gt;
Did you observe missing region with patch v2 ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13186161" author="sunnygao" created="Sat, 14 Jan 2012 11:11:08 +0000"  >&lt;p&gt;Current,This is my guess.&lt;br/&gt;
I am developing some code to produce this scenario. If I have further information , I will inform you&lt;/p&gt;</comment>
                            <comment id="13186208" author="sunnygao" created="Sat, 14 Jan 2012 13:35:51 +0000"  >&lt;p&gt;I had produced this case:&lt;br/&gt;
In order to simulate some dead server is being prcoessed:&lt;br/&gt;
1.create some table&lt;/p&gt;

&lt;p&gt;2.restart hmaster, after geting region server , wait 60s(I added some code in hmaster)&lt;br/&gt;
  int regionCount = this.serverManager.waitForRegionServers();&lt;br/&gt;
    LOG.info(&quot;+++&lt;ins&gt;sleep 60&lt;/ins&gt;+++ &quot;);&lt;br/&gt;
    Thread.sleep(60000);&lt;br/&gt;
3.kill the meta region server&lt;/p&gt;

&lt;p&gt;4.Master gets the envents of Meta region server is down.&lt;/p&gt;

&lt;p&gt;5.assign the meta table.&lt;/p&gt;

&lt;p&gt;6. SSH start to split the Hlog(some meta will lose)&lt;/p&gt;</comment>
                            <comment id="13186655" author="zjushch" created="Mon, 16 Jan 2012 02:22:04 +0000"  >&lt;p&gt;I aggree with the meta-data-loss issue.&lt;/p&gt;

&lt;p&gt;In the gaojinchao&apos;s comment&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
When master starts, As current flow, RS has three part:
1.Some has registered in Hmaster by heatbeat report
2.Some is dead server being processed by ssh
3.Some is waiting zk is expired(&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; session timeout is 3 minutes)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the 3, I think we can do as the following:&lt;br/&gt;
1.master first fail verifying metaLocation.&lt;br/&gt;
2.judge whether RS is processing by SSH&lt;br/&gt;
3.if 2 not, expire this RS&lt;/p&gt;

&lt;p&gt;3 is done in Trunk, but not in 0.90&lt;/p&gt;</comment>
                            <comment id="13186664" author="zjushch" created="Mon, 16 Jan 2012 02:44:38 +0000"  >&lt;p&gt;In v6patch, I add isDeadServerBeingProcessed  logic for Trunk and place it in ServerManger.&lt;/p&gt;</comment>
                            <comment id="13186669" author="zjushch" created="Mon, 16 Jan 2012 02:58:18 +0000"  >&lt;p&gt;In 90-branch, the logic of carrying root and crarrying meta are not accurate as the trunk when expiring server. and root server&apos;s startcode is not recorded in ZK node, So I think it is a little disordered for solving the meta-data-loss issue.&lt;/p&gt;</comment>
                            <comment id="13186671" author="zjushch" created="Mon, 16 Jan 2012 03:04:13 +0000"  >&lt;p&gt;v6 has a collision for the trunk&lt;/p&gt;</comment>
                            <comment id="13186675" author="sunnygao" created="Mon, 16 Jan 2012 03:45:39 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
I agree with you. In branch 90, I want to add a flag that marks SSH finish split Hlog. &lt;br/&gt;
If all of Dead servers had split Hlog, Loss data should be quite rare.&lt;/p&gt;</comment>
                            <comment id="13186676" author="hadoopqa" created="Mon, 16 Jan 2012 03:46:31 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12510663/hbase-5179v7.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12510663/hbase-5179v7.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -145 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 82 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.mapreduce.TestImportTsv&lt;br/&gt;
                  org.apache.hadoop.hbase.mapred.TestTableMapReduce&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestHFileOutputFormat&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestSplitLogManager&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/768//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/768//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/768//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/768//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/768//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/768//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13186687" author="zjushch" created="Mon, 16 Jan 2012 04:47:12 +0000"  >&lt;p&gt;@Zhihong @Jinchao @Ram&lt;br/&gt;
In patch v5 for 90-branch,&lt;br/&gt;
Before assigning rootAndMeta, I add a checking whether meta or root server is being processed as dead.&lt;br/&gt;
And only assign rootAndMeta if not.&lt;/p&gt;

&lt;p&gt;what do you think about its availability?&lt;/p&gt;</comment>
                            <comment id="13186689" author="sunnygao" created="Mon, 16 Jan 2012 04:51:54 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
Root is fine. &lt;br/&gt;
But in the initialization phase, Meta flag is always false.&lt;br/&gt;
so &quot;this.serverManager.isDeadMetaServerInProgress&quot; is invalid.&lt;/p&gt;
</comment>
                            <comment id="13186693" author="zjushch" created="Mon, 16 Jan 2012 05:04:02 +0000"  >&lt;p&gt;@Jinchao&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
But in the initialization phase, Meta flag is always &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;.
so &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.isDeadMetaServerInProgress&quot;&lt;/span&gt; is invalid.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;m not very clear,could you give an example.&lt;br/&gt;
Ps:you mean ServerManager#expireServer ?&lt;/p&gt;</comment>
                            <comment id="13186694" author="zhihyu@ebaysf.com" created="Mon, 16 Jan 2012 05:04:29 +0000"  >&lt;p&gt;@Jinchao:&lt;br/&gt;
So the following code in expireServer() always evaluates to false ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; carryingMeta =
      address != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; hsi.getServerAddress().equals(address);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13186695" author="sunnygao" created="Mon, 16 Jan 2012 05:08:47 +0000"  >&lt;p&gt;Yes, it always false in the inializtion phase.&lt;/p&gt;</comment>
                            <comment id="13186697" author="zjushch" created="Mon, 16 Jan 2012 05:11:49 +0000"  >&lt;p&gt;@Jinchao @Zhihong&lt;br/&gt;
So, we need change the following code in expiring server first?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
HServerAddress address = ct.getMetaLocation();
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; carryingMeta =
      address != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; hsi.getServerAddress().equals(address);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13186698" author="zjushch" created="Mon, 16 Jan 2012 05:13:04 +0000"  >&lt;p&gt;What about introduing trunk&apos;s logic for carryingRoot carryingMeta?&lt;/p&gt;</comment>
                            <comment id="13186699" author="zhihyu@ebaysf.com" created="Mon, 16 Jan 2012 05:13:09 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  /**
+   * Set of dead root servers under processing by the ServerShutdownHander.
+   */
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; deadRootServersUnderProcessing = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;();
+  /**
+   * Set of dead meta servers under processing by the ServerShutdownHander.
+   */
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; deadMetaServersUnderProcessing = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do we need to use Set&amp;lt;&amp;gt; for the above two fields ? Currently ROOT and .META. is served by one server, respectively.&lt;/p&gt;</comment>
                            <comment id="13186700" author="zhihyu@ebaysf.com" created="Mon, 16 Jan 2012 05:15:08 +0000"  >&lt;p&gt;@Chunhui:&lt;br/&gt;
+1 on introduing trunk&apos;s logic for carryingRoot carryingMeta.&lt;/p&gt;</comment>
                            <comment id="13186701" author="sunnygao" created="Mon, 16 Jan 2012 05:18:59 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
I thought that you have said, I want to get from root table , thare is also some problem. for example:&lt;br/&gt;
1. root and meta is same machine.&lt;br/&gt;
2. root is down and so on.&lt;/p&gt;

&lt;p&gt;I don&apos;t find a good way to do this.&lt;/p&gt;</comment>
                            <comment id="13186703" author="zjushch" created="Mon, 16 Jan 2012 05:22:16 +0000"  >&lt;p&gt;Also we need introduing HMaster#expireIfOnline from trunk.&lt;br/&gt;
If not,  the case that a rootOrMeta RS has been dead and but master is waiting zk to be expired, causing issue again.&lt;/p&gt;</comment>
                            <comment id="13186704" author="sunnygao" created="Mon, 16 Jan 2012 05:25:48 +0000"  >&lt;p&gt;+1 on introduceing Trunk&apos;s logic&lt;/p&gt;</comment>
                            <comment id="13186705" author="zjushch" created="Mon, 16 Jan 2012 05:28:19 +0000"  >&lt;p&gt;@Jinchao&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
I thought that you have said, I want to get from root table , thare is also some problem. &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; example:
1. root and meta is same machine.
2. root is down and so on.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m clear now.&lt;br/&gt;
The lastest two patches(90 and trunk) has the above problem submit by me&lt;/p&gt;</comment>
                            <comment id="13186706" author="zjushch" created="Mon, 16 Jan 2012 05:31:33 +0000"  >&lt;p&gt;@Jinchao&lt;br/&gt;
I find trunk&apos;s logic of carryingMeta and carryingRoot have also the problem you mentioned above.&lt;/p&gt;

&lt;p&gt;In trunk&apos;s logic of carryingMeta and carryingRoot, before master finishing Initialization, carryingMeta must be false because of empty AssignmentManager.regions&lt;/p&gt;</comment>
                            <comment id="13186708" author="sunnygao" created="Mon, 16 Jan 2012 05:40:14 +0000"  >&lt;p&gt;This logic is very complex. I thought a few days and did not find a good way to slove all problems.&lt;/p&gt;</comment>
                            <comment id="13186712" author="zjushch" created="Mon, 16 Jan 2012 05:56:53 +0000"  >&lt;p&gt;@Jinchao&lt;/p&gt;

&lt;p&gt;I thought it again, you mentioned above may not happen with  5179-90v5.patch&lt;br/&gt;
because carryingMeta is false, this.serverManager.isDeadMetaServerInProgress() return false, so it will assgin meta by master&apos;s Initialization. However, root is ok now, so split log is must be completed.&lt;/p&gt;

&lt;p&gt;The trunk patch should consider this point again.&lt;/p&gt;</comment>
                            <comment id="13186714" author="zjushch" created="Mon, 16 Jan 2012 05:59:33 +0000"  >&lt;p&gt;before this.assignmentManager.assignMeta(), we will do this.catalogTracker.waitForRoot(), So if root and meta server are the same one, log must has been splitted before assigning Meta,&lt;/p&gt;</comment>
                            <comment id="13186720" author="sunnygao" created="Mon, 16 Jan 2012 06:09:37 +0000"  >&lt;p&gt;You can test this case:&lt;/p&gt;

&lt;p&gt;1.create some table&lt;/p&gt;

&lt;p&gt;2.restart hmaster. after geting knownServers wait 60s(added some code in hmaster)&lt;/p&gt;

&lt;p&gt;LOG.info(&quot;++&lt;ins&gt;sleep 60&lt;/ins&gt;++ &quot;);&lt;br/&gt;
Thread.sleep(60000);&lt;/p&gt;

&lt;p&gt;3.kill(kill -9) the meta region server when Hmaster log print &quot;++&lt;ins&gt;sleep 60&lt;/ins&gt;++ &quot;&lt;/p&gt;

&lt;p&gt;4.Master gets the event of Meta region server is down. Before split Hlog, sleep 90s&lt;/p&gt;

&lt;p&gt;5. check the table after master finish init&lt;/p&gt;</comment>
                            <comment id="13186722" author="zjushch" created="Mon, 16 Jan 2012 06:11:27 +0000"  >&lt;p&gt;@Zhihong&lt;br/&gt;
&quot;for the above two fields ? Currently ROOT and .META. is served by one server, respectively.&quot;&lt;br/&gt;
It is prevent from more than one servers are processed as carryingRoot or carryingMeta. In 90, it easily happen if we kill a meta server continually.&lt;/p&gt;</comment>
                            <comment id="13186724" author="zjushch" created="Mon, 16 Jan 2012 06:15:32 +0000"  >&lt;p&gt;@Jinchao&lt;br/&gt;
The above case will fail because we don&apos;t do HMaster#expireIfOnline which is done in Trunk.&lt;/p&gt;

&lt;p&gt;I am tring to make a new patch for 0.90 introducing trunk&apos;s expireIfOnline logic when initializing&lt;/p&gt;</comment>
                            <comment id="13186725" author="sunnygao" created="Mon, 16 Jan 2012 06:15:45 +0000"  >&lt;p&gt;I configure the zk.session is 40s. So I design this case uses sleeping 60s&lt;/p&gt;</comment>
                            <comment id="13186726" author="sunnygao" created="Mon, 16 Jan 2012 06:18:06 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
It is fine. after you finhish, I will also test in our cluster.&lt;/p&gt;</comment>
                            <comment id="13186746" author="zjushch" created="Mon, 16 Jan 2012 07:20:41 +0000"  >&lt;p&gt;@Zhihong @Jinchao&lt;br/&gt;
In 90v6 patch,&lt;br/&gt;
I add the logic of expiring server when  master is initializing which is done in Trunk&#12290;&lt;/p&gt;

&lt;p&gt;Also I add a guarantee that splitlog is completed when assigning META in case mentioned by Jinchao&lt;/p&gt;

&lt;p&gt;What do you think&#65311; Please do check&lt;/p&gt;</comment>
                            <comment id="13186751" author="zjushch" created="Mon, 16 Jan 2012 07:31:44 +0000"  >&lt;p&gt;Change a little on 90v6, please see the 90v7&lt;/p&gt;</comment>
                            <comment id="13186770" author="sunnygao" created="Mon, 16 Jan 2012 08:35:20 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
Maybe it has a problem. the number of shutdownhandler thread pool is 3(default), If there are more than 3 deadserver is processing. we will wait forever.&lt;/p&gt;
</comment>
                            <comment id="13186781" author="zjushch" created="Mon, 16 Jan 2012 08:49:43 +0000"  >&lt;p&gt;@Jinchao&lt;br/&gt;
I think it is another problem.&lt;br/&gt;
If we restart general three RS, and then kill META server,&lt;br/&gt;
The first three ServerShutdownHandler will wait meta region, however METAServerShutdownHandler will not be processed because shutdownhandler thread pool is full until one ServerShutdownHandler is finished. So it exists a forever wait.&lt;/p&gt;</comment>
                            <comment id="13186786" author="sunnygao" created="Mon, 16 Jan 2012 09:00:52 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
Regarding to a normal flow. METAServerShutdownHandler use different thread pool. only init flow, scome cases we can&apos;t distinguish meta region server.&lt;/p&gt;</comment>
                            <comment id="13186804" author="zjushch" created="Mon, 16 Jan 2012 09:21:40 +0000"  >&lt;p&gt;@Jinchao&lt;br/&gt;
So, we need ensure dead meta server &#65288;which is consider as a general server&#65289; is processed by SSH when master initializing? &lt;br/&gt;
Otherwise, one of meta-data loss or waiting forever must happen?&lt;/p&gt;</comment>
                            <comment id="13186928" author="sunnygao" created="Mon, 16 Jan 2012 14:05:00 +0000"  >&lt;p&gt;In patch v7, Can we replace &quot;process expired server&quot; to &quot;public void splitLog(final String serverName)&quot;?&lt;/p&gt;</comment>
                            <comment id="13187378" author="zjushch" created="Tue, 17 Jan 2012 01:48:43 +0000"  >&lt;p&gt;@Jinchao&lt;br/&gt;
&quot;process expired server&quot;  is introduced from trunk, if we just only splitLog, the regions of RS will not be assigned because it is considerd a known server.&lt;/p&gt;

&lt;p&gt;For the possible waiting forever, what about changed as retrying and throwing exception? &lt;/p&gt;</comment>
                            <comment id="13187402" author="zjushch" created="Tue, 17 Jan 2012 03:08:57 +0000"  >&lt;p&gt;@Zhihong @Jinchao&lt;br/&gt;
Based on 90v7.patch, 90v8 changes waiting forever to waiting for a time out, and add  the guarantee with case :&lt;br/&gt;
RS is dead but zk node exists when master start, so it is not considered a known server and its region will be assigned with out splitting log.&lt;/p&gt;

&lt;p&gt;Thanks for the comment.&lt;/p&gt;</comment>
                            <comment id="13187412" author="zjushch" created="Tue, 17 Jan 2012 03:31:15 +0000"  >&lt;p&gt;hbase-5179v8.patch for trunk,&lt;br/&gt;
which used to prevent meta-data-loss&lt;/p&gt;</comment>
                            <comment id="13187415" author="sunnygao" created="Tue, 17 Jan 2012 03:42:22 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
Does this code make sense to you ?&lt;/p&gt;

&lt;p&gt;      if (!this.serverManager.isDeadMetaServerInProgress()) {&lt;br/&gt;
        if(metaServerInfo != null)&lt;/p&gt;
{
          this.fileSystemManager.splitLog(metaServerInfo.getServerName());
        }
&lt;p&gt;        this.assignmentManager.assignMeta();&lt;br/&gt;
        assigned++;&lt;br/&gt;
      }&lt;/p&gt;</comment>
                            <comment id="13187417" author="sunnygao" created="Tue, 17 Jan 2012 03:48:50 +0000"  >&lt;p&gt;+1 v8 , we need some test cases to verify in real cluster.&lt;/p&gt;</comment>
                            <comment id="13187424" author="zhihyu@ebaysf.com" created="Tue, 17 Jan 2012 03:55:16 +0000"  >&lt;p&gt;@Chunhui:&lt;br/&gt;
Thanks for your persistence.&lt;br/&gt;
For 5179-90v8.patch, three sets are introduced into DeadServer. Can we use one Map in place of the 3 sets ?&lt;br/&gt;
Map&amp;lt;String, ServerType&amp;gt; where ServerType is an enum marking NORMAL, ROOT and META servers.&lt;/p&gt;

&lt;p&gt;isDeadRootServerInProgress() would require a traversal of the Map. So this is just a suggestion.&lt;/p&gt;

&lt;p&gt;For MasterFileSystem.existLogs(), maybe logDirExists() is a better name ?&lt;/p&gt;</comment>
                            <comment id="13187433" author="zhihyu@ebaysf.com" created="Tue, 17 Jan 2012 04:18:01 +0000"  >&lt;p&gt;@Chunhui:&lt;br/&gt;
Can you publish TRUNK patch v8 on review board ?&lt;/p&gt;</comment>
                            <comment id="13187448" author="zhihyu@ebaysf.com" created="Tue, 17 Jan 2012 04:55:27 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; waitTime = conf.getInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.master.assignMeta.timeout&quot;&lt;/span&gt;,
+            60000);
+        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; metaServerInfo != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;; i++) {
+          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fileSystemManager.existLogs(metaServerInfo.getServerName())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think &quot;hbase.master.meta.assignment.timeout&quot; would be more appropriate.&lt;br/&gt;
metaServerInfo.getServerName() can be stored in a variable before entering the for loop (minor).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i &amp;gt;= waitTime / 1000) {
+            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(
+                &lt;span class=&quot;code-quote&quot;&gt;&quot;Wait META server to finish splitting log &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a time out&quot;&lt;/span&gt;);
+          }
+          sleep(1000);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think the time accounting above is inaccurate because we don&apos;t know how long the sleep() call has taken.&lt;br/&gt;
Also, &quot;Timed out waiting for .META. server to finish splitting log&quot; would be better exception message.&lt;/p&gt;</comment>
                            <comment id="13187452" author="zhihyu@ebaysf.com" created="Tue, 17 Jan 2012 05:07:08 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; getOnlineServersAsName() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; KeeperException {
+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ZKUtil.listChildrenNoWatch(watcher, watcher.rsZNode);
+  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A better method name would be getOnlineServerNames.&lt;/p&gt;

&lt;p&gt;Good job, Chunhui.&lt;/p&gt;</comment>
                            <comment id="13187468" author="zjushch" created="Tue, 17 Jan 2012 06:04:32 +0000"  >&lt;p&gt;@Jinchao&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.isDeadMetaServerInProgress()) {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(metaServerInfo != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;){ &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fileSystemManager.splitLog(metaServerInfo.getServerName()); }
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.assignMeta();
assigned++;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks for above code, I think it&apos;s fine and is used in v9patch to be simpler.&lt;/p&gt;</comment>
                            <comment id="13187469" author="zjushch" created="Tue, 17 Jan 2012 06:09:13 +0000"  >&lt;p&gt;Add Zhihong&apos;s and Jinchao&apos;s comment.&lt;/p&gt;</comment>
                            <comment id="13187472" author="zjushch" created="Tue, 17 Jan 2012 06:11:37 +0000"  >&lt;p&gt;@Zhihong&lt;br/&gt;
I don&apos;t know the review board address.&lt;/p&gt;</comment>
                            <comment id="13187476" author="zhihyu@ebaysf.com" created="Tue, 17 Jan 2012 06:18:20 +0000"  >&lt;p&gt;Jinchao&apos;s code may introduce intricacy in TRUNK where log splitting may be distributed.&lt;br/&gt;
In that case we cannot assign .META. upon return from fileSystemManager.splitLog()&lt;/p&gt;

&lt;p&gt;Review board is at &lt;a href=&quot;https://reviews.apache.org&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org&lt;/a&gt;&lt;br/&gt;
You should select hbase as Repository and / as Base Directory. The diff should be patch generated against TRUNK.&lt;/p&gt;</comment>
                            <comment id="13187515" author="hadoopqa" created="Tue, 17 Jan 2012 07:51:47 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12510813/hbase-5179v9.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12510813/hbase-5179v9.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -144 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 84 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.regionserver.TestSplitTransactionOnCluster&lt;br/&gt;
                  org.apache.hadoop.hbase.replication.TestReplication&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/790//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/790//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/790//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/790//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/790//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/790//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13187863" author="zhihyu@ebaysf.com" created="Tue, 17 Jan 2012 18:32:20 +0000"  >&lt;p&gt;For hbase-5179v9.patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentMetaServer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
+          &amp;amp;&amp;amp; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.isServerOnline(currentMetaServer)) {
+        &lt;span class=&quot;code-comment&quot;&gt;// Current meta server is dead, we first split its log and then expire&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Is the above right ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fileSystemManager.splitLog(currentMetaServer);
         expireIfOnline(currentMetaServer);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The splitLog() would end up calling:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void splitLog(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;ServerName&amp;gt; serverNames) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If distributedLogSplitting is true, log splitting would be in progress upon return from splitLog().&lt;br/&gt;
We need to either disable distributedLogSplitting or introduce synchronization mechanism for above.&lt;/p&gt;</comment>
                            <comment id="13188207" author="zjushch" created="Wed, 18 Jan 2012 02:20:58 +0000"  >&lt;p&gt;@Zhihong&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentMetaServer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
+          &amp;amp;&amp;amp; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.isServerOnline(currentMetaServer)) {
+        &lt;span class=&quot;code-comment&quot;&gt;// Current meta server is dead, we first split its log and then expire&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think it&apos;s right, could you talk about the found problem?&lt;/p&gt;

&lt;p&gt;If distributedLogSplitting is true, the following code will be called&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (distributedLogSplitting) {
      splitLogManager.handleDeadWorkers(serverNames);
      splitTime = EnvironmentEdgeManager.currentTimeMillis();
      splitLogSize = splitLogManager.splitLogDistributed(logDirs);
      splitTime = EnvironmentEdgeManager.currentTimeMillis() - splitTime;
    } 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
   * The caller will block until all the log files of the given region server
   * have been processed - successfully split or an error is encountered - by an
   * available worker region server. This method must only be called after the
   * region servers have been brought online.
   *
   * @param logDirs
   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
   *          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there was an error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; splitting any log file
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; cumulative size of the logfiles split
   */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; splitLogDistributed(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;Path&amp;gt; logDirs) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, it will block until completing splitlog&lt;/p&gt;</comment>
                            <comment id="13188231" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 03:04:07 +0000"  >&lt;p&gt;w.r.t. first question: if this.serverManager.isServerOnline() returns true, should currentMetaServer be considered dead ?&lt;/p&gt;

&lt;p&gt;For the second question, splitLogDistributed() would block. That&apos;s fine.&lt;br/&gt;
What I am thinking is that maybe we should split currentMetaServer&apos;s log in a non-distributed fashion because the splitting is of high priority.&lt;/p&gt;</comment>
                            <comment id="13188248" author="zjushch" created="Wed, 18 Jan 2012 03:21:54 +0000"  >&lt;p&gt;@Zhihong&lt;br/&gt;
For the first question: this.serverManager.isServerOnline() returns true and catalogTracker.verifyMetaRegionLocation(timeout) returns false, if the meta server is really dead and we assign meta without splitting log, causing meta data loss. &lt;/p&gt;

&lt;p&gt;Through the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!catalogTracker.verifyRootRegionLocation(timeout)) {
      ServerName currentRootServer = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getRootLocation();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (expireIfOnline(currentRootServer)) {
        &lt;span class=&quot;code-comment&quot;&gt;// We are expiring &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; server. The processing of expiration will assign
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// root so don&apos;t &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; it here.
&lt;/span&gt;        expiredServer = currentRootServer;
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-comment&quot;&gt;// Root was not on an online server when we failed verification
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.assignRoot();
      }


&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; expireIfOnline(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ServerName sn) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sn == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.isServerOnline(sn)) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Forcing expiration of &quot;&lt;/span&gt; + sn);
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.expireServer(sn);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We could find currentRootServer is considered dead, with the same condition, could we consider  currentMetaServer dead?&lt;/p&gt;

</comment>
                            <comment id="13188251" author="zjushch" created="Wed, 18 Jan 2012 03:27:18 +0000"  >&lt;p&gt;For the second question:&lt;br/&gt;
I think we could introducing a new function of forced non-distributed splitlog in MasterFileSystem&lt;/p&gt;</comment>
                            <comment id="13188260" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 03:45:30 +0000"  >&lt;p&gt;From serverManager.expireServer():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (carryingRoot || carryingMeta) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.services.getExecutorService().submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MetaServerShutdownHandler(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master,
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since expireIfOnline() is called after this.fileSystemManager.splitLog(currentMetaServer), MetaServerShutdownHandler would be queued after log splitting.&lt;br/&gt;
Would this pose potential issue ?&lt;/p&gt;</comment>
                            <comment id="13188266" author="zjushch" created="Wed, 18 Jan 2012 04:29:46 +0000"  >&lt;p&gt;@Zhihong&lt;br/&gt;
when matser is initializing, carryingMeta is always false, so expiring currentMetaServer would only call ServerShutdownHandler not MetaServerShutdownHandler&lt;/p&gt;

&lt;p&gt;However, I find another problem, carryingRoot is also always false when initializing in trunk(in 90-branch it&apos;s true), so we should also this.fileSystemManager.splitLog(currentRootServer) before expire currentRootServer&lt;/p&gt;</comment>
                            <comment id="13188269" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 04:51:50 +0000"  >&lt;p&gt;@Chunhui:&lt;br/&gt;
Thanks for the investigation. Please base your TRUNK patch on testing result using 0.92.0 RC4.&lt;/p&gt;

&lt;p&gt;I think we can add boolean parameters (for carryingRoot and carryingMeta) to serverManager.expireServer() and expireIfOnline() so that we don&apos;t need to call fileSystemManager.splitLog() separately.&lt;br/&gt;
The goal is to make the code maintainable while achieving correctness.&lt;/p&gt;

&lt;p&gt;Just a suggestion.&lt;/p&gt;</comment>
                            <comment id="13188293" author="zjushch" created="Wed, 18 Jan 2012 06:09:43 +0000"  >&lt;p&gt;@Zhihong:&lt;br/&gt;
In v10patch for trunk, I introduce the above comment, please review it.&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="13188303" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 06:33:53 +0000"  >&lt;p&gt;I like patch v10. &lt;br/&gt;
Do you have time to verify in real cluster ?&lt;br/&gt;
We can discuss names of variables later. &lt;/p&gt;</comment>
                            <comment id="13188305" author="hadoopqa" created="Wed, 18 Jan 2012 06:48:07 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12510958/hbase-5179v10.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12510958/hbase-5179v10.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -143 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 82 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.replication.TestReplicationPeer&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestImportTsv&lt;br/&gt;
                  org.apache.hadoop.hbase.mapred.TestTableMapReduce&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestHFileOutputFormat&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/804//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/804//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/804//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/804//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/804//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/804//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13188309" author="zjushch" created="Wed, 18 Jan 2012 07:08:49 +0000"  >&lt;p&gt;@Zhihong&#65306;&lt;br/&gt;
I think I could add one unit test case for this issue through setting conf, for example, ServerManager#waitForRegionServers() will wait timeout = this.master.getConfiguration().&lt;br/&gt;
      getLong(&quot;hbase.master.wait.on.regionservers.timeout&quot;, 4500);&lt;br/&gt;
So I could increment the time of timeout in test case to reappear the issue.&lt;/p&gt;</comment>
                            <comment id="13188310" author="zjushch" created="Wed, 18 Jan 2012 07:09:37 +0000"  >&lt;p&gt;I will submit the test case later.&lt;/p&gt;</comment>
                            <comment id="13188413" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 11:39:26 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+   * Dead servers under processing by the ServerShutdownHander. Map of
+   * ServerType to set of being processed dead servers
+   */
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;ServerType, Set&amp;lt;ServerName&amp;gt;&amp;gt; deadServersUnderProcessing = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;ServerType, Set&amp;lt;ServerName&amp;gt;&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The second line of javadoc should read: &apos; to set of dead servers being processed&apos;&lt;br/&gt;
Please wrap long line.&lt;/p&gt;

&lt;p&gt;I think we should pre-create HashSet&apos;s for the three ServerType&apos;s in DeadServer ctor.&lt;br/&gt;
This way we can omit runtime checks such as:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (deadNormalServersBeingProcessed == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+      deadNormalServersBeingProcessed = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;ServerName&amp;gt;();
+      deadServersUnderProcessing.put(ServerType.NORMAL,
+          deadNormalServersBeingProcessed);
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+   * @param assuredRootServer &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s dead server carrying root certainly.
+   * @param assuredMetaServer &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s dead server carrying meta certainly.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;How about naming the parameters definitiveRootServer and definitiveMetaServer ? (Change certainly to definitely).&lt;/p&gt;

&lt;p&gt;We should use low value for &quot;hbase.master.wait.on.regionservers.timeout&quot; so that the new test case doesn&apos;t take too long.&lt;/p&gt;</comment>
                            <comment id="13188566" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 17:53:10 +0000"  >&lt;p&gt;Patch v11 simplifies the logic in DeadServer.java&lt;/p&gt;</comment>
                            <comment id="13188599" author="lhofhansl" created="Wed, 18 Jan 2012 18:35:58 +0000"  >&lt;p&gt;v11 lgtm +1&lt;/p&gt;</comment>
                            <comment id="13188607" author="hadoopqa" created="Wed, 18 Jan 2012 18:45:56 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12511011/5179-v11.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12511011/5179-v11.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -143 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 82 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.mapreduce.TestHFileOutputFormat&lt;br/&gt;
                  org.apache.hadoop.hbase.mapred.TestTableMapReduce&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestImportTsv&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/805//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/805//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/805//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/805//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/805//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/805//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13188615" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 18:51:29 +0000"  >&lt;p&gt;Patch for 0.92 branch&lt;/p&gt;</comment>
                            <comment id="13188671" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 20:09:58 +0000"  >&lt;p&gt;Patch for 0.90 branch&lt;/p&gt;</comment>
                            <comment id="13188735" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 22:06:22 +0000"  >&lt;p&gt;Patch v11 for 0.90 branch.&lt;br/&gt;
Applied same simplification technique to DeadServer.java&lt;/p&gt;</comment>
                            <comment id="13188737" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 22:07:55 +0000"  >&lt;p&gt;@Stack:&lt;br/&gt;
Do you want to take a look at the v11 patches (3 of them) ?&lt;/p&gt;</comment>
                            <comment id="13188861" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 01:08:14 +0000"  >&lt;p&gt;Tests for 0.90 passed for 5179-90v11.patch&lt;/p&gt;</comment>
                            <comment id="13188938" author="sunnygao" created="Thu, 19 Jan 2012 05:49:38 +0000"  >&lt;p&gt;+1, Good job! &lt;/p&gt;</comment>
                            <comment id="13188939" author="sunnygao" created="Thu, 19 Jan 2012 05:50:50 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
Do you want me to test this patch in our cluster ?&lt;/p&gt;</comment>
                            <comment id="13188954" author="stack" created="Thu, 19 Jan 2012 06:45:17 +0000"  >&lt;p&gt;Regards v11 new splitLog method, I don&apos;t get this justification Zhihong:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;What I am thinking is that maybe we should split currentMetaServer&apos;s log in a non-distributed fashion because the splitting is of high priority.&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is the thought that local splitting will run faster?  Is this true?&lt;/p&gt;

&lt;p&gt;areDeadServersInProgress method name should match the other method names so it should be areDeadServersBeingProcessed (minor).  Ditto these methods, isDeadRootServerInProgress, etc.  Whats the difference between InProgress and BeingProcessed?  We also seem to have active voice UnderProcessing going on.  Should be consistent?&lt;/p&gt;

&lt;p&gt;Do these need to be public?  Seem like only used in same package by master.&lt;/p&gt;

&lt;p&gt;Should the zk callback be up and operating before the master comes completely on line?&lt;/p&gt;

&lt;p&gt;The knownServers in HMaster, are heartbeating servers that have come in before the master came on line?  That seems like an important fix.&lt;/p&gt;

&lt;p&gt;I&apos;m now a little confused as to the scope of this patch.  The Jinchao descriptions above on how to reproduce pathological situations I get.  It&apos;d be great to do these up as a unit tests.  I&apos;m not sure which of Jinchao descriptions apply to TRUNK as opposed to 0.90.  Any chance of getting a list of scenarios this patch is supposed to fix?  If we had that, I&apos;d be up for writing unit tests for TRUNK at least (I think it has sufficient primitives mocking up Jinchao descriptions w/o need of a cluster).&lt;/p&gt;

&lt;p&gt;That said, this patch and the discussion above in this issue is uncovering critical stuff; thanks for all the work lads.&lt;/p&gt;






</comment>
                            <comment id="13188956" author="stack" created="Thu, 19 Jan 2012 06:46:05 +0000"  >&lt;p&gt;Oh, one other thought is we could break up this issue some.  For example, servers coming before a master finishes processing failover could be an issue unto itself.&lt;/p&gt;</comment>
                            <comment id="13188979" author="zjushch" created="Thu, 19 Jan 2012 07:55:41 +0000"  >&lt;p&gt;@all&lt;br/&gt;
I think this issue we should consider following cases at least:&lt;/p&gt;

&lt;p&gt;1.RS is dead and its zk node exists when master initializing&lt;br/&gt;
2.RS is restarted when master initializing (there are two nodes for the same RS on zk)&lt;/p&gt;


&lt;p&gt;For the case 2, we need consider the following cases:&lt;/p&gt;

&lt;p&gt;2.1 RS is restarted before this.serverManager.waitForRegionServers()&lt;br/&gt;
2.2 RS is restarted between this.serverManager.waitForRegionServers() and HMaster#assignRootAndMeta&lt;/p&gt;


&lt;p&gt;We should also find carryingMeta and carringRoot is not accurate when master initializing.&lt;/p&gt;
</comment>
                            <comment id="13188983" author="zjushch" created="Thu, 19 Jan 2012 08:07:42 +0000"  >&lt;p&gt;@Jinchao&lt;/p&gt;

&lt;p&gt;I think v12 has consider the above cases, could you help to test this patch in your cluster ?&lt;/p&gt;

&lt;p&gt;I have tried to write an unit test case, but the simulated kill would delete EphemeralNode on zk when Regionserver Thread exit, so the above case is hard to appear through unit test case.&lt;/p&gt;</comment>
                            <comment id="13189028" author="hadoopqa" created="Thu, 19 Jan 2012 09:35:31 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12511103/hbase-5179v12.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12511103/hbase-5179v12.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -143 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 82 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/810//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/810//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/810//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/810//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/810//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/810//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13189039" author="hadoopqa" created="Thu, 19 Jan 2012 10:12:57 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12511103/hbase-5179v12.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12511103/hbase-5179v12.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -143 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 82 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.io.hfile.TestLruBlockCache&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/811//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/811//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/811//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/811//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/811//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/811//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13189057" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 11:42:02 +0000"  >&lt;p&gt;@Chunhui:&lt;br/&gt;
If you can upload v11 to review board, publish it then upload v12, we would be able to see the differences. &lt;/p&gt;</comment>
                            <comment id="13189066" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 12:14:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3545&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/3545&lt;/a&gt; was created with patch v11, then updated with patch v12.&lt;/p&gt;</comment>
                            <comment id="13189140" author="sunnygao" created="Thu, 19 Jan 2012 14:57:44 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
In 90v12, Maybe below code(metaServerInfo/rootServerInfo) has some nullexception?&lt;/p&gt;

&lt;p&gt;      // MetaServer is may being processed as dead server. Before assign meta,&lt;br/&gt;
      // we need to wait until its log is splitted.&lt;br/&gt;
      waitUntilNoLogDir(metaServerInfo.getServerName());&lt;br/&gt;
      if (!this.serverManager.isDeadMetaServerInProgress()) &lt;/p&gt;
{
        this.assignmentManager.assignMeta();
      }</comment>
                            <comment id="13189148" author="sunnygao" created="Thu, 19 Jan 2012 15:06:30 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
I only verify the branch90 version. I don&apos;t have the cluster for branch92(that needs a few day, we are planing to setup some test cluster.)&lt;/p&gt;</comment>
                            <comment id="13189186" author="sunnygao" created="Thu, 19 Jan 2012 16:40:48 +0000"  >&lt;p&gt;when region server checkin, I killed meta/root region. I found splitHlog is after meta was assigned. So I think may has another problem. tomorrow continue to dig .&lt;/p&gt;</comment>
                            <comment id="13189203" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 17:04:12 +0000"  >&lt;p&gt;@Jinchao:&lt;br/&gt;
So C3S31 was carrying .META., right ?&lt;br/&gt;
I need to add DEBUG log into waitUntilNoLogDir() which would give us:&lt;br/&gt;
1. serverName&lt;br/&gt;
2. log directory path&lt;br/&gt;
3. how long waitUntilNoLogDir() waited.&lt;/p&gt;</comment>
                            <comment id="13189239" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 17:55:20 +0000"  >&lt;p&gt;@Stack:&lt;br/&gt;
Thanks for your review.&lt;br/&gt;
Looks like we still have some work to really solve this issue. After that we can align naming to your liking.&lt;/p&gt;

&lt;p&gt;w.r.t. local log splitting, to my knowledge there is no priority in distributed log splitting. The rationale is to make log splitting of .META. server quick.&lt;/p&gt;</comment>
                            <comment id="13189245" author="stack" created="Thu, 19 Jan 2012 18:02:54 +0000"  >&lt;p&gt;So your thinking is that we&apos;d go local in case a distributed log splitting is already going on?  That would work for the case where say ten servers went down around same time and the tenth queued had meta on it.  But then, what if there is no distributed log splitting going on?  Master-only log splitting would be slower than distributed splitting?&lt;/p&gt;</comment>
                            <comment id="13189270" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 18:33:40 +0000"  >&lt;p&gt;Maybe you&apos;re suggesting adding functionality to distributed log splitting which allows us to know the length of queue.&lt;br/&gt;
That would be a new feature which would go in a separate JIRA.&lt;/p&gt;</comment>
                            <comment id="13189277" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 18:46:32 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-01-19 11:10:35,847 INFO org.apache.hadoop.hbase.zookeeper.RegionServerTracker: RegionServer ephemeral node deleted, processing expiration [C3S31,20020,1326987900492]
2012-01-19 11:10:35,850 DEBUG org.apache.hadoop.hbase.master.ServerManager: Added=C3S31,20020,1326987900492 to dead servers, submitted shutdown handler to be executed, root=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, meta=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
2012-01-19 11:10:35,851 INFO org.apache.hadoop.hbase.master.handler.ServerShutdownHandler: Splitting logs &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; C3S31,20020,1326987900492
...
2012-01-19 11:12:37,003 INFO org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Archived processed log hdfs:&lt;span class=&quot;code-comment&quot;&gt;//C3S31:9000/hbase/.logs/C3S31,20020,1326987900492/C3S31%3A20020.1326987901100 to hdfs://C3S31:9000/hbase/.oldlogs/C3S31%3A20020.1326987901100
&lt;/span&gt;2012-01-19 11:12:37,004 INFO org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: hlog file splitting completed in 1137 ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hdfs:&lt;span class=&quot;code-comment&quot;&gt;//C3S31:9000/hbase/.logs/C3S31,20020,1326987900492
&lt;/span&gt;2012-01-19 11:12:37,004 INFO org.apache.hadoop.hbase.master.handler.ServerShutdownHandler: Server C3S31,20020,1326987900492 was carrying ROOT. Trying to assign.
...
2012-01-19 11:12:37,382 INFO org.apache.hadoop.hbase.master.HMaster: .META. assigned=2, rit=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, location=C3S32:20020
2012-01-19 11:12:37,382 INFO org.apache.hadoop.hbase.master.HMaster: Master startup proceeding: master failover
2012-01-19 11:12:37,383 WARN org.apache.hadoop.hbase.master.AssignmentManager: Overwriting 1028785192 on serverName=C3S32,20020,1326987400439, load=(requests=0, regions=0, usedHeap=0, maxHeap=0)
2012-01-19 11:12:37,384 WARN org.apache.hadoop.hbase.master.AssignmentManager: Overwriting 70236052 on serverName=C3S32,20020,1326987400439, load=(requests=0, regions=0, usedHeap=0, maxHeap=0)
2012-01-19 11:12:37,393 INFO org.apache.hadoop.hbase.master.handler.ServerShutdownHandler: Reassigning 0 region(s) that C3S31,20020,1326987900492 was carrying (skipping 0 regions(s) that are already in transition)
2012-01-19 11:12:37,393 INFO org.apache.hadoop.hbase.master.handler.ServerShutdownHandler: Finished processing of shutdown of C3S31,20020,1326987900492
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;From above log, we can see that .META. was assigned to C3S32 and log splitting was for C3S31.&lt;/p&gt;

&lt;p&gt;So was there data loss ?&lt;/p&gt;</comment>
                            <comment id="13189326" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 19:38:13 +0000"  >&lt;p&gt;In patch v10:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fileSystemManager.splitLog(metaServerInfo.getServerName());
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.expireServer(metaServerInfo);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In latest patch, fileSystemManager.splitLog() is gone.&lt;/p&gt;

&lt;p&gt;I think what might have happened was that waitUntilNoLogDir() returned too soon because the log splitting was carried out in ShutdownHandler which barely got a chance of doing the split.&lt;/p&gt;

&lt;p&gt;Patch v13 adds DEBUG logging in waitUntilNoLogDir() so that we know whether the log dir exists upon its entry and how long waitUntilNoLogDir() takes before returning.&lt;/p&gt;</comment>
                            <comment id="13189333" author="stack" created="Thu, 19 Jan 2012 19:44:08 +0000"  >&lt;p&gt;Why would there be dataloss?  Was C3S32 carrying .META.?  Even if it was, it looks like the log split before .META. assign (and this issue is about concurrent master failover going on anyways?)&lt;/p&gt;</comment>
                            <comment id="13189338" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 19:48:34 +0000"  >&lt;p&gt;If my assumption @ 19/Jan/12 19:38 is true, we should re-introduce this.fileSystemManager.splitLog()&lt;/p&gt;</comment>
                            <comment id="13189578" author="zjushch" created="Fri, 20 Jan 2012 02:35:14 +0000"  >&lt;p&gt;@Jinchao &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
gaojinchao added a comment - 19/Jan/12 16:40 
when region server checkin, I killed meta/root region. I found splitHlog is after meta was assigned. So I think may has another problem. tomorrow &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt; to dig .
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because this test uses v11patch without waitUntilNoLogDir(), so it is the problem .&lt;/p&gt;

&lt;p&gt;Jinchao, could you test again with 90v13.patch.&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="13189582" author="zjushch" created="Fri, 20 Jan 2012 02:41:07 +0000"  >&lt;p&gt;90v13 has a mistake about waitUntilNoLogDir&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fileSystemManager.logDirExists(serverName) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
      }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;should changed as &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fileSystemManager.logDirExists(serverName) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
      }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;also prevent from NPE about it.&lt;/p&gt;</comment>
                            <comment id="13189584" author="zjushch" created="Fri, 20 Jan 2012 02:42:12 +0000"  >&lt;p&gt;@Jinchao &lt;br/&gt;
Could you test again with 90v14patch?&lt;br/&gt;
Thanks much!&lt;/p&gt;</comment>
                            <comment id="13189595" author="sunnygao" created="Fri, 20 Jan 2012 03:27:05 +0000"  >&lt;p&gt;In my test case, I kill meta/root at same time. when master start to assign root/meta region , it should finish split hlogs. &lt;/p&gt;

&lt;p&gt;Today I will give a detail test report about 90V14.&lt;/p&gt;</comment>
                            <comment id="13189598" author="zjushch" created="Fri, 20 Jan 2012 03:35:39 +0000"  >&lt;p&gt;@Jinchao&lt;br/&gt;
I find 90V14 has also a problem.&lt;br/&gt;
I&apos;m sorry.&lt;br/&gt;
Could you use v15.&lt;br/&gt;
Thanks. &lt;/p&gt;</comment>
                            <comment id="13189600" author="sunnygao" created="Fri, 20 Jan 2012 03:37:20 +0000"  >&lt;p&gt;no problem. before I start to verify the patch. I will review it.&lt;/p&gt;</comment>
                            <comment id="13189641" author="sunnygao" created="Fri, 20 Jan 2012 05:54:37 +0000"  >&lt;p&gt;@chunhui&lt;br/&gt;
The first test case failed, we start a cluster, the patch is split a new region server&apos;s Hlog.&lt;/p&gt;

&lt;p&gt;2012-01-20 00:34:39,462 INFO org.mortbay.log: Started SelectChannelConnector@0.0.0.0:20010&lt;br/&gt;
2012-01-20 00:34:39,462 DEBUG org.apache.hadoop.hbase.master.HMaster: Started service threads&lt;br/&gt;
2012-01-20 00:34:40,158 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=C3S32,20020,1327037679721, regionCount=0, userLoad=false&lt;br/&gt;
2012-01-20 00:34:40,296 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=C3S33,20020,1327037679059, regionCount=0, userLoad=false&lt;br/&gt;
2012-01-20 00:34:40,488 INFO org.apache.hadoop.hbase.master.ServerManager: Registering server=C3S31,20020,1327037679673, regionCount=0, userLoad=false&lt;br/&gt;
2012-01-20 00:34:40,962 INFO org.apache.hadoop.hbase.master.ServerManager: Waiting on regionserver(s) count to settle; currently=3&lt;br/&gt;
2012-01-20 00:34:42,462 INFO org.apache.hadoop.hbase.master.ServerManager: Finished waiting for regionserver count to settle; count=3, sleptFor=3000&lt;br/&gt;
2012-01-20 00:34:42,463 INFO org.apache.hadoop.hbase.master.ServerManager: Exiting wait on regionserver(s) to checkin; count=3, stopped=false, count of regions out on cluster=0&lt;br/&gt;
2012-01-20 00:34:42,463 INFO org.apache.hadoop.hbase.master.HMaster: -----------------&lt;del&gt;sleep 60s&lt;/del&gt;----------------&lt;br/&gt;
2012-01-20 00:35:42,469 INFO org.apache.hadoop.hbase.master.MasterFileSystem: Log folder hdfs://C3S31:9000/hbase/.logs/C3S31,20020,1327037679673 belongs to an existing region server&lt;br/&gt;
2012-01-20 00:35:42,470 INFO org.apache.hadoop.hbase.master.MasterFileSystem: Log folder hdfs://C3S31:9000/hbase/.logs/C3S32,20020,1327037679721 belongs to an existing region server&lt;br/&gt;
2012-01-20 00:35:42,470 INFO org.apache.hadoop.hbase.master.MasterFileSystem: Log folder hdfs://C3S31:9000/hbase/.logs/C3S33,20020,1327037679059 belongs to an existing region server&lt;br/&gt;
2012-01-20 00:35:42,504 INFO org.apache.hadoop.hbase.catalog.CatalogTracker: Failed verification of &lt;del&gt;ROOT&lt;/del&gt;,,0 at address=C3S32:20020; org.apache.hadoop.hbase.NotServingRegionException: org.apache.hadoop.hbase.NotServingRegionException: Region is not online: &lt;del&gt;ROOT&lt;/del&gt;,,0&lt;br/&gt;
2012-01-20 00:36:42,610 FATAL org.apache.hadoop.hbase.master.HMaster: Unhandled exception. Starting shutdown.&lt;br/&gt;
java.lang.RuntimeException: Timed out waiting to finish splitting log for C3S32,20020,1327037679721&lt;br/&gt;
	at org.apache.hadoop.hbase.master.HMaster.waitUntilNoLogDir(HMaster.java:578)&lt;br/&gt;
	at org.apache.hadoop.hbase.master.HMaster.assignRootAndMeta(HMaster.java:478)&lt;br/&gt;
	at org.apache.hadoop.hbase.master.HMaster.finishInitialization(HMaster.java:422)&lt;br/&gt;
	at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:283)&lt;br/&gt;
2012-01-20 00:36:42,613 INFO org.apache.hadoop.hbase.master.HMaster: Aborting&lt;br/&gt;
2012-01-20 00:36:42,613 DEBUG org.apache.hadoop.hbase.master.HMaster: Stopping service threads&lt;br/&gt;
2012-01-20 00:36:42,613 INFO org.apache.hadoop.ipc.HBaseServer: Stopping server on 20000&lt;/p&gt;</comment>
                            <comment id="13189774" author="zjushch" created="Fri, 20 Jan 2012 12:55:07 +0000"  >&lt;p&gt;@Zhihong&lt;br/&gt;
90-v16 add some logic about when to waitUntilNoLogDir and pass Jinchao&apos;s test&lt;br/&gt;
Please take a review&lt;br/&gt;
Thanks.&lt;/p&gt;
</comment>
                            <comment id="13189842" author="zhihyu@ebaysf.com" created="Fri, 20 Jan 2012 15:05:15 +0000"  >&lt;p&gt;Patch v16 makes sense.&lt;/p&gt;</comment>
                            <comment id="13189943" author="zhihyu@ebaysf.com" created="Fri, 20 Jan 2012 17:48:42 +0000"  >&lt;p&gt;Patch v17 makes all new methods in DeadServer package private.&lt;br/&gt;
Also aligned new method names in DeadServer with existing method names.&lt;br/&gt;
Wrapped long lines.&lt;/p&gt;

&lt;p&gt;This version should be close to Stack&apos;s standard.&lt;/p&gt;</comment>
                            <comment id="13190002" author="zhihyu@ebaysf.com" created="Fri, 20 Jan 2012 19:03:30 +0000"  >&lt;p&gt;Patch v17 for 0.90 passed unit tests.&lt;br/&gt;
Got a strange complaint about TestLruBlockCache. In org.apache.hadoop.hbase.io.hfile.TestLruBlockCache.txt:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
testBackgroundEvictionThread(org.apache.hadoop.hbase.io.hfile.TestLruBlockCache)  Time elapsed: 3.157 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
junit.framework.AssertionFailedError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
  at junit.framework.Assert.fail(Assert.java:47)
  at junit.framework.Assert.assertTrue(Assert.java:20)
  at junit.framework.Assert.assertTrue(Assert.java:27)
  at org.apache.hadoop.hbase.io.hfile.TestLruBlockCache.testBackgroundEvictionThread(TestLruBlockCache.java:58)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looks like the following assertion didn&apos;t give eviction enough time to run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
      assertTrue(n++ &amp;lt; 2);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Running TestLruBlockCache alone passed.&lt;/p&gt;</comment>
                            <comment id="13190290" author="zjushch" created="Sat, 21 Jan 2012 03:08:31 +0000"  >&lt;p&gt;hbase-5179v17.patch for trunk, changing the method names of DeadServer with the same as 90v17.txt &lt;/p&gt;</comment>
                            <comment id="13190297" author="zjushch" created="Sat, 21 Jan 2012 03:23:31 +0000"  >&lt;p&gt;v17patch for 92&lt;/p&gt;</comment>
                            <comment id="13190298" author="sunnygao" created="Sat, 21 Jan 2012 03:25:30 +0000"  >&lt;p&gt;This is V16 test result in branch90, &lt;br/&gt;
number	discribe	result&lt;br/&gt;
1	a new cluster startup	ok&lt;br/&gt;
2	restart a cluster	ok&lt;br/&gt;
3	No region serve crash	ok&lt;br/&gt;
4	After Meta region server registered, and then crashed	ok&lt;br/&gt;
5	After Meta/root region server registered, and then crashed	ok&lt;br/&gt;
6	After Hmaster crashed and Meta/root region server crashed. Hmaster and region server start at same time.	0k&lt;br/&gt;
7	After Hmaster crashed and Meta/root region server crashed. Hmaster start 	ok&lt;/p&gt;</comment>
                            <comment id="13190299" author="sunnygao" created="Sat, 21 Jan 2012 03:26:19 +0000"  >&lt;p&gt;Do you want to add any new case?&lt;/p&gt;</comment>
                            <comment id="13190314" author="zhihyu@ebaysf.com" created="Sat, 21 Jan 2012 05:46:38 +0000"  >&lt;p&gt;Due to a missing check against null, previous patch v17 would result in:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-01-20 21:00:08,370 FATAL [Master:0;192.168.0.11,52564,1327122004379] master.HMaster(1489): Unhandled exception. Starting shutdown.
java.lang.NullPointerException
  at org.apache.hadoop.hbase.master.MasterFileSystem.logDirExists(MasterFileSystem.java:533)
  at org.apache.hadoop.hbase.master.HMaster.waitUntilNoLogDir(HMaster.java:712)
  at org.apache.hadoop.hbase.master.HMaster.assignRootAndMeta(HMaster.java:598)
  at org.apache.hadoop.hbase.master.HMaster.finishInitialization(HMaster.java:530)
  at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:348)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Will attach working version.&lt;/p&gt;</comment>
                            <comment id="13190317" author="zhihyu@ebaysf.com" created="Sat, 21 Jan 2012 05:54:51 +0000"  >&lt;p&gt;Patch v17 for trunk.&lt;/p&gt;</comment>
                            <comment id="13190325" author="zhihyu@ebaysf.com" created="Sat, 21 Jan 2012 06:11:48 +0000"  >&lt;p&gt;Patch for 0.92&lt;/p&gt;</comment>
                            <comment id="13190331" author="hadoopqa" created="Sat, 21 Jan 2012 06:37:40 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12511362/hbase-5179v17.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12511362/hbase-5179v17.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -143 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 82 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.mapreduce.TestImportTsv&lt;br/&gt;
                  org.apache.hadoop.hbase.mapred.TestTableMapReduce&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestHFileOutputFormat&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/822//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/822//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/822//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/822//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/822//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/822//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13190446" author="zhihyu@ebaysf.com" created="Sat, 21 Jan 2012 15:27:16 +0000"  >&lt;p&gt;Ran test suite in 0.92 over the latest 5179-92v17.patch&lt;br/&gt;
All tests passed.&lt;/p&gt;</comment>
                            <comment id="13190672" author="ram_krish" created="Sun, 22 Jan 2012 13:21:31 +0000"  >&lt;p&gt;@Stack, if test passes can we commit this to 0.90?&lt;/p&gt;</comment>
                            <comment id="13190894" author="stack" created="Mon, 23 Jan 2012 06:25:08 +0000"  >&lt;p&gt;Here is some review of v17.&lt;/p&gt;

&lt;p&gt;logDirExists should be called getLogDir or getLogDirIfExists?&lt;/p&gt;

&lt;p&gt;Why is the below done up in ServerManager rather than down in ServerShutdownHandler?  I&apos;d think it&apos;d make more sense therein?  Perhaps even inside in the MetaServerShutdownHandler or whatever its called?   Not a biggie.  Just asking.&lt;/p&gt;

&lt;p&gt;Can we talk more about what there are: &quot;+   * @param onlineServers onlined servers when master starts&quot;&lt;/p&gt;

&lt;p&gt;Are these servers that have checked in between master start and the call to processFailover.  Could other servers come between the making of the list we pass into processFailover and the running of the processFailover code?  Should this be a &apos;live&apos; list?   Or, I see that we are actually getting rid of the &apos;live&apos; list of online servers to replace it w/ this static one in these lines:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!serverManager.isServerOnline(regionLocation.getServerName())) {
+      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!onlineServers.contains(regionLocation.getServerName())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why do we do this?&lt;/p&gt;

&lt;p&gt;Could this block of be code be done out in a nice coherent method rather than inline here in HMaster:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-comment&quot;&gt;// Check zk &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; regionservers that are up but didn&apos;t register
&lt;/span&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sn : &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionServerTracker.getOnlineServerNames()) {
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.isServerOnline(sn)) {
+        HServerInfo serverInfo = HServerInfo.getServerInfo(sn);
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (serverInfo != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+          HServerInfo existingServer = serverManager
+              .haveServerWithSameHostAndPortAlready(serverInfo
+                  .getHostnamePort());
+          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (existingServer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+            &lt;span class=&quot;code-comment&quot;&gt;// Not registered; add it.
&lt;/span&gt;+            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Registering server found up in zk but who has not yet &quot;&lt;/span&gt;
+                + &lt;span class=&quot;code-quote&quot;&gt;&quot;reported in: &quot;&lt;/span&gt; + sn);
+            &lt;span class=&quot;code-comment&quot;&gt;// We set serverLoad with one region, it could differentiate with
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// regionserver which is started just now
&lt;/span&gt;+            HServerLoad serverLoad = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HServerLoad();
+            serverLoad.setNumberOfRegions(1);
+            serverInfo.setLoad(serverLoad);
+            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.recordNewServer(serverInfo, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
+          }
+        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Server &quot;&lt;/span&gt; + sn
+              + &lt;span class=&quot;code-quote&quot;&gt;&quot; found up in zk, but is not a correct server name&quot;&lt;/span&gt;);
+        }
+      }
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can we say more about why we are doing this?  And how do we know that it did not just start?  Because if it has more than 0 regions, it must have been already running?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rootServerLoad != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; rootServerLoad.getNumberOfRegions() &amp;gt; 0) {
+          &lt;span class=&quot;code-comment&quot;&gt;// If rootServer is online &amp;amp;&amp;amp; not start just now, we expire it
&lt;/span&gt;+          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.expireServer(rootServerInfo);
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It looks like the processing of the meta server duplicates code from the processing of the root server.  Can we have instead the duplicated code out in a method? Is that possible?  Then pass in args for whether root or meta to process?&lt;/p&gt;

&lt;p&gt;Regards the hard coded wait of 1000ms when looking for dir to go away, see &apos;13.4.1.2.2. Sleeps in tests&apos; in &lt;a href=&quot;http://hbase.apache.org/book.html#hbase.tests&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hbase.apache.org/book.html#hbase.tests&lt;/a&gt;... it seems like we should wait less than 1000 going by the reference guide.&lt;/p&gt;

&lt;p&gt;DeadServer class looks much better.&lt;/p&gt;

&lt;p&gt;I can&apos;t write a test for a patch on 0.90 and this v17 won&apos;t work for trunk at all.  The trunk patch will be very different which is a problem because then I have no confidence my trunk unit test applies to this patch that is to be applied on 0.90 branch.&lt;/p&gt;</comment>
                            <comment id="13190904" author="zhihyu@ebaysf.com" created="Mon, 23 Jan 2012 07:03:37 +0000"  >&lt;p&gt;Thanks for the comments, Stack.&lt;br/&gt;
Here is what Chunhui had to say (with minor grammatical corrections):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Because 0.90 branch doesn&apos;t record the startcode of metaserver or rootserver when we call getMetaLocation or getRootLocation, the patch for 90 is more complex than the patch for trunk.
 
If there is unit test case, it would be perfect. But I didn&apos;t succeed doing that because the zk node of RS will be deleted immediately, not 3mins later in simulated RS termination.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13191625" author="zhihyu@ebaysf.com" created="Mon, 23 Jan 2012 23:36:45 +0000"  >&lt;p&gt;Patch v18 addresses Stack&apos;s comments.&lt;/p&gt;

&lt;p&gt;The sleep() isn&apos;t for unit test. I lowered wait interval to 500ms.&lt;/p&gt;

&lt;p&gt;I created waitUntilNoLogDir(HServerAddress serverAddress) so that &lt;del&gt;ROOT&lt;/del&gt; and .META. servers can reuse the logic.&lt;/p&gt;

&lt;p&gt;Renamed logDirExists() to getLogDirIfExists()&lt;/p&gt;</comment>
                            <comment id="13191672" author="stack" created="Tue, 24 Jan 2012 00:19:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;The sleep() isn&apos;t for unit test. I lowered wait interval to 500ms.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But this code is exercised in tests.&lt;/p&gt;

&lt;p&gt;My thinking on this patch is that if you fellas have confidence in it, commit it to 0.90 (but if it destabilizes 0.90 branch, I&apos;m going to come looking for you all with a hammer!).&lt;/p&gt;

&lt;p&gt;Lets open a new issue for TRUNK and work up a trunk-applicable version of this patch.  I&apos;ll help there so the trunk commit includes unit tests.&lt;/p&gt;
</comment>
                            <comment id="13191678" author="zhihyu@ebaysf.com" created="Tue, 24 Jan 2012 00:24:34 +0000"  >&lt;p&gt;What do we do with 5179-92v17.patch ?&lt;br/&gt;
Test harness may not be ready in 0.92 for the (future) trunk patch to be applied.&lt;/p&gt;</comment>
                            <comment id="13191954" author="stack" created="Tue, 24 Jan 2012 06:56:26 +0000"  >&lt;p&gt;Reviewing 0.92v17&lt;/p&gt;


&lt;p&gt;isDeadServerInProgress is a new public method in ServerManager but it does not seem to be used anywhere.&lt;/p&gt;

&lt;p&gt;Does isDeadRootServerInProgress need to be public?  Ditto for meta version.&lt;/p&gt;

&lt;p&gt;This method param names are not right &apos;definitiveRootServer&apos;; what is meant by definitive?  Do they need this qualifier?&lt;/p&gt;

&lt;p&gt;Is there anything in place to stop us expiring a server twice if its carrying root and meta?&lt;/p&gt;

&lt;p&gt;What is difference between asking assignment manager isCarryingRoot and this variable that is passed in?  Should be doc&apos;d at least.  Ditto for meta.&lt;/p&gt;

&lt;p&gt;I think I&apos;ve asked for this a few times &amp;#8211; onlineServers needs to be explained... either in javadoc or in comment. This is the param passed into joinCluster.  How does it arise?  I think I know but am unsure.  God love the poor noob that comes awandering this code trying to make sense of it all.&lt;/p&gt;

&lt;p&gt;It looks like we get the list by trawling zk for regionserver znodes that have not checked in.  Don&apos;t we do this operation earlier in master setup?  Are we doing it again here?&lt;/p&gt;

&lt;p&gt;Though distributed split log is configured, we will do in master single process splitting under some conditions with this patch.  Its not explained in code why we would do this.  Why do we think master log splitting &apos;high priority&apos; when it could very well be slower.  Should we only go this route if distributed splitting is not going on.  Do we know if concurrent distributed log splitting and master splitting works?&lt;/p&gt;

&lt;p&gt;Why would we have dead servers in progress here in master startup?  Because a servershutdownhandler fired?&lt;/p&gt;

&lt;p&gt;This patch is different to the patch for 0.90.  Should go into trunk first with tests, then 0.92.  Should it be in this issue?  This issue is really hard to follow now.  Maybe this issue is for 0.90.x and new issue for more work on this trunk patch?&lt;/p&gt;



&lt;p&gt;This patch needs to have the v18 differences applied.&lt;/p&gt;


</comment>
                            <comment id="13192208" author="zhihyu@ebaysf.com" created="Tue, 24 Jan 2012 15:18:18 +0000"  >&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5270&quot; title=&quot;Handle potential data loss due to concurrent processing of processFaileOver and ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5270&quot;&gt;&lt;del&gt;HBASE-5270&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Let&apos;s integrate patch v18 to 0.90 for this JIRA.&lt;/p&gt;</comment>
                            <comment id="13193611" author="ram_krish" created="Thu, 26 Jan 2012 07:18:21 +0000"  >&lt;p&gt;Updating the affected version to 0.90.7.  This issue will go into 0.90.7 after sufficient testing.&lt;/p&gt;</comment>
                            <comment id="13195429" author="ram_krish" created="Sat, 28 Jan 2012 05:26:07 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
Are you using 0.90.x in your cluster? If so, Can you test this patch before we commit it into 0.90?  We have done some testing and next week after Chinese spring holidays we will do some more testing.&lt;br/&gt;
If we are confident then we can commit this and will prevent Stack from searching us with hammer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13195478" author="zjushch" created="Sat, 28 Jan 2012 10:16:26 +0000"  >&lt;p&gt;@ram&lt;br/&gt;
Yes, we will test the 90patch after Chinese spring holidays.&lt;/p&gt;</comment>
                            <comment id="13206074" author="ram_krish" created="Sat, 11 Feb 2012 11:17:38 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
Any updates on this testing.  We have tried to use it in our testing cluster and till now no specific problems.  If you can provide your feedback also it would be helpful in deciding if we can put this in next 0.90 RC.  Any way for trunk we have &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5270&quot; title=&quot;Handle potential data loss due to concurrent processing of processFaileOver and ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5270&quot;&gt;&lt;del&gt;HBASE-5270&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
@Ted&lt;br/&gt;
What is your opinion on including this in next 0.90 RC?&lt;/p&gt;</comment>
                            <comment id="13206120" author="zhihyu@ebaysf.com" created="Sat, 11 Feb 2012 13:45:14 +0000"  >&lt;p&gt;I think this patch should be included in the new RC. &lt;/p&gt;</comment>
                            <comment id="13206615" author="zjushch" created="Mon, 13 Feb 2012 01:31:59 +0000"  >&lt;p&gt;@ram&lt;br/&gt;
We didn&apos;t find any problem now with the patch in 0.90 version testing,&lt;br/&gt;
but as the comment by Stack in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5270&quot; title=&quot;Handle potential data loss due to concurrent processing of processFaileOver and ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5270&quot;&gt;&lt;del&gt;HBASE-5270&lt;/del&gt;&lt;/a&gt;, maybe we could use a new method, so i&apos;m not sure whether to change the solution&lt;/p&gt;</comment>
                            <comment id="13228558" author="hudson" created="Tue, 13 Mar 2012 18:18:08 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #30 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/30/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/30/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5179&quot; title=&quot;Concurrent processing of processFaileOver and ServerShutdownHandler may cause region to be assigned before log splitting is completed, causing data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5179&quot;&gt;&lt;del&gt;HBASE-5179&lt;/del&gt;&lt;/a&gt; Handle potential data loss due to concurrent processing of processFaileOver and ServerShutdownHandler (Revision 1300222)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/MasterServices.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/handler/CreateTableHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestRSKilledWhenMasterInitializing.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13228999" author="hudson" created="Wed, 14 Mar 2012 05:56:48 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-security #137 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-security/137/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-security/137/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5179&quot; title=&quot;Concurrent processing of processFaileOver and ServerShutdownHandler may cause region to be assigned before log splitting is completed, causing data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5179&quot;&gt;&lt;del&gt;HBASE-5179&lt;/del&gt;&lt;/a&gt; Handle potential data loss due to concurrent processing of processFaileOver and ServerShutdownHandler (Revision 1300194)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/MasterServices.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/handler/CreateTableHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestRSKilledWhenMasterInitializing.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13229358" author="hudson" created="Wed, 14 Mar 2012 17:09:19 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2679 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2679/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2679/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5179&quot; title=&quot;Concurrent processing of processFaileOver and ServerShutdownHandler may cause region to be assigned before log splitting is completed, causing data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5179&quot;&gt;&lt;del&gt;HBASE-5179&lt;/del&gt;&lt;/a&gt; Handle potential data loss due to concurrent processing of processFaileOver and ServerShutdownHandler (Revision 1300194)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/MasterServices.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/handler/CreateTableHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestRSKilledWhenMasterInitializing.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12530257">HBASE-4748</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12539620">HBASE-5270</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12538447">HBASE-5202</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12510261" name="5179-90.txt" size="8328" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 22:11:05 +0000"/>
                            <attachment id="12511030" name="5179-90v10.patch" size="20563" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 20:09:57 +0000"/>
                            <attachment id="12511043" name="5179-90v11.patch" size="19565" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 22:06:22 +0000"/>
                            <attachment id="12511102" name="5179-90v12.patch" size="22422" author="zjushch" created="Thu, 19 Jan 2012 08:03:12 +0000"/>
                            <attachment id="12511158" name="5179-90v13.txt" size="22725" author="zhihyu@ebaysf.com" created="Thu, 19 Jan 2012 19:46:47 +0000"/>
                            <attachment id="12511216" name="5179-90v14.patch" size="22749" author="zjushch" created="Fri, 20 Jan 2012 02:41:06 +0000"/>
                            <attachment id="12511218" name="5179-90v15.patch" size="24265" author="zjushch" created="Fri, 20 Jan 2012 03:35:38 +0000"/>
                            <attachment id="12511256" name="5179-90v16.patch" size="24341" author="zjushch" created="Fri, 20 Jan 2012 12:55:07 +0000"/>
                            <attachment id="12511281" name="5179-90v17.txt" size="24170" author="zhihyu@ebaysf.com" created="Fri, 20 Jan 2012 17:48:42 +0000"/>
                            <attachment id="12511589" name="5179-90v18.txt" size="24511" author="zhihyu@ebaysf.com" created="Mon, 23 Jan 2012 23:36:44 +0000"/>
                            <attachment id="12510311" name="5179-90v2.patch" size="9573" author="zjushch" created="Thu, 12 Jan 2012 05:17:17 +0000"/>
                            <attachment id="12510381" name="5179-90v3.patch" size="14583" author="sunnygao" created="Thu, 12 Jan 2012 16:11:05 +0000"/>
                            <attachment id="12510577" name="5179-90v4.patch" size="9555" author="sunnygao" created="Sat, 14 Jan 2012 13:22:21 +0000"/>
                            <attachment id="12510665" name="5179-90v5.patch" size="13898" author="zjushch" created="Mon, 16 Jan 2012 04:42:23 +0000"/>
                            <attachment id="12510673" name="5179-90v6.patch" size="17380" author="zjushch" created="Mon, 16 Jan 2012 07:20:41 +0000"/>
                            <attachment id="12510674" name="5179-90v7.patch" size="17384" author="zjushch" created="Mon, 16 Jan 2012 07:31:44 +0000"/>
                            <attachment id="12510799" name="5179-90v8.patch" size="19898" author="zjushch" created="Tue, 17 Jan 2012 03:08:56 +0000"/>
                            <attachment id="12510811" name="5179-90v9.patch" size="20582" author="zjushch" created="Tue, 17 Jan 2012 06:09:13 +0000"/>
                            <attachment id="12511367" name="5179-92v17.patch" size="20617" author="zhihyu@ebaysf.com" created="Sat, 21 Jan 2012 06:11:48 +0000"/>
                            <attachment id="12511020" name="5179-v11-92.txt" size="17803" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 18:51:29 +0000"/>
                            <attachment id="12511011" name="5179-v11.txt" size="18432" author="zhihyu@ebaysf.com" created="Wed, 18 Jan 2012 17:53:10 +0000"/>
                            <attachment id="12510206" name="5179-v2.txt" size="7497" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 17:11:18 +0000"/>
                            <attachment id="12510266" name="5179-v3.txt" size="7452" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 22:43:43 +0000"/>
                            <attachment id="12510277" name="5179-v4.txt" size="7441" author="zhihyu@ebaysf.com" created="Wed, 11 Jan 2012 23:53:21 +0000"/>
                            <attachment id="12511134" name="Errorlog" size="28756" author="sunnygao" created="Thu, 19 Jan 2012 16:40:48 +0000"/>
                            <attachment id="12510164" name="hbase-5179.patch" size="7455" author="zjushch" created="Wed, 11 Jan 2012 06:59:47 +0000"/>
                            <attachment id="12510958" name="hbase-5179v10.patch" size="19338" author="zjushch" created="Wed, 18 Jan 2012 06:07:54 +0000"/>
                            <attachment id="12511103" name="hbase-5179v12.patch" size="20874" author="zjushch" created="Thu, 19 Jan 2012 08:03:58 +0000"/>
                            <attachment id="12511362" name="hbase-5179v17.patch" size="21108" author="zhihyu@ebaysf.com" created="Sat, 21 Jan 2012 05:54:50 +0000"/>
                            <attachment id="12510304" name="hbase-5179v5.patch" size="8115" author="zjushch" created="Thu, 12 Jan 2012 03:02:47 +0000"/>
                            <attachment id="12510660" name="hbase-5179v6.patch" size="9586" author="zjushch" created="Mon, 16 Jan 2012 02:44:38 +0000"/>
                            <attachment id="12510663" name="hbase-5179v7.patch" size="10047" author="zjushch" created="Mon, 16 Jan 2012 03:04:12 +0000"/>
                            <attachment id="12510802" name="hbase-5179v8.patch" size="11842" author="zjushch" created="Tue, 17 Jan 2012 03:31:14 +0000"/>
                            <attachment id="12510813" name="hbase-5179v9.patch" size="14512" author="zjushch" created="Tue, 17 Jan 2012 06:52:41 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12539620">HBASE-5270</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 11 Jan 2012 15:11:43 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>223529</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 40 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00svz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2612</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>