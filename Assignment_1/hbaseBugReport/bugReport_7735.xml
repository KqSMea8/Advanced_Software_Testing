<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:48:34 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7735/HBASE-7735.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7735] Prevent regions from moving during online snapshot.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7735</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;To increase the probability of snapshots succeeding, we should attempt to prevent splits and region moves from happening.  Currently we take region locks but this could be &quot;too late&quot; and results in an aborted snapshot.  &lt;/p&gt;

&lt;p&gt;We should probably take the table lock (0.96) when starting a snapshot and for  a 0.94 backport we should probably disable the balancer.&lt;/p&gt;

&lt;p&gt;This will probably not be tackled until after trunk merge.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12630266">HBASE-7735</key>
            <summary>Prevent regions from moving during online snapshot.</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12619005">HBASE-7290</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jmhsieh">Jonathan Hsieh</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Feb 2013 01:12:03 +0000</created>
                <updated>Fri, 22 Mar 2013 18:21:07 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13569239" author="enis" created="Fri, 1 Feb 2013 23:25:44 +0000"  >&lt;p&gt;+1 on table locks. The patches are already there in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7305&quot; title=&quot;ZK based Read/Write locks for table operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7305&quot;&gt;&lt;del&gt;HBASE-7305&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7546&quot; title=&quot;Obtain a table read lock on region split operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7546&quot;&gt;&lt;del&gt;HBASE-7546&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="13569276" author="jmhsieh" created="Fri, 1 Feb 2013 23:53:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; Lovely.  I&apos;ll take a look after I work through snapshot merge.&lt;/p&gt;</comment>
                            <comment id="13606003" author="terry_zhang" created="Tue, 19 Mar 2013 03:42:00 +0000"  >&lt;p&gt;hi Jonathan&#65292; I wonder now how we can make sure all regionserver snapshot manager can get the correct number of region when doing snapshot. Cause if some of the region is moving or spliting , getOnlineRegions will miss these region and snapshot will loss data and there will be hole in meta after we restore snapshot.&lt;/p&gt;</comment>
                            <comment id="13606149" author="terry_zhang" created="Tue, 19 Mar 2013 07:53:35 +0000"  >&lt;p&gt;hi @Jonathan Hsieh  I mean region is moving between region server before regionserver getonlineregion . This means the moving region doesn&apos;t belong to anyone of regionserver. Would this case lead data lose in snapshot and user don&apos;t know about it?&lt;/p&gt;</comment>
                            <comment id="13606352" author="jmhsieh" created="Tue, 19 Mar 2013 13:54:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=terry_zhang&quot; class=&quot;user-hover&quot; rel=&quot;terry_zhang&quot;&gt;terry zhang&lt;/a&gt;, there shouldn&apos;t be data loss &amp;#8211; there is a verification step after the snapshot attempt and if regions move (or a rs goes down) the verification will fail and cause the snapshot to explicitly fail and tell the user.  No data loss.&lt;/p&gt;</comment>
                            <comment id="13606353" author="jmhsieh" created="Tue, 19 Mar 2013 13:55:54 +0000"  >&lt;p&gt;Looks like from my read of the table locks code, we will need another mechanism to prevent regions from moving &amp;#8211; I don&apos;t think that the table granularity locks as implemented provides guards against region assignment modifications.&lt;/p&gt;</comment>
                            <comment id="13607173" author="terry_zhang" created="Wed, 20 Mar 2013 01:54:58 +0000"  >&lt;p&gt;Hi Jonathan Hsieh&#65292;  Can we use below methods to increase the probability of snapshots succeeding?&lt;/p&gt;

&lt;p&gt;1. get all the region list in master. Including moving region , online region and spliting region(parent and child)&lt;br/&gt;
2. check the region list to make sure there is no hole in it.&lt;br/&gt;
3. generate a snapshot task assign map file in the target snapshot folder. (also assign the moving regions and spliting parent regions to some region server )&lt;br/&gt;
4. when the regionserver start buildSubprocedure. it will compare online region and the assgin region list in task file which master generated . if it is a online region it will be a FlushSnapshotSubprocedure. if it is not online we can think it is a close region. we do not need to flush cache , only need to create reference file(empty file). If the region already in the snapshot folder. we can just skip .&lt;/p&gt;

&lt;p&gt;I think this would be helpful cause in large cluster moving region and spliting region is a normal stituation. So snapshot maybe always fail when do the verification. what do you think ?&lt;/p&gt;</comment>
                            <comment id="13610868" author="jmhsieh" created="Fri, 22 Mar 2013 16:41:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=terry_zhang&quot; class=&quot;user-hover&quot; rel=&quot;terry_zhang&quot;&gt;terry zhang&lt;/a&gt;, there definitely is a comment in the code about coordinating using the region name list as opposed to the region server list (legacy of the initial implementation) and is similar to what you are suggesting.  Doing that could make snapshots robust in the face of region moves  &amp;#8211; a region moves but it is till the same region.  I think with the approach you suggest splits will cause failure still.  &lt;/p&gt;

&lt;p&gt;Region splits and merges are introduce a different problem because now the region identities change.  Since those operations will likely be guarded by the table read lock (not the exclusive write lock), we&apos;d need something else to either fail-fast (current behavior could be improved to do this faster), detect-and-recover, or block the final steps of a merge or split.  &lt;/p&gt;

&lt;p&gt;Do you agree?&lt;/p&gt;</comment>
                            <comment id="13610997" author="enis" created="Fri, 22 Mar 2013 18:01:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;terry zhang, there definitely is a comment in the code about coordinating using the region name list as opposed to the region server list (legacy of the initial implementation) and is similar to what you are suggesting. Doing that could make snapshots robust in the face of region moves &#8211; a region moves but it is till the same region. I think with the approach you suggest splits will cause failure still.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If we get &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7848&quot; title=&quot;Use ZK-based read/write lock to make flush-type snapshot robust against table enable/disable/alter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7848&quot;&gt;&lt;del&gt;HBASE-7848&lt;/del&gt;&lt;/a&gt; in, then during the snapshot it would mean that the list of regions can&apos;t change (due to splits, and merges (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7977&quot; title=&quot;Online merge should acquire table lock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7977&quot;&gt;&lt;del&gt;HBASE-7977&lt;/del&gt;&lt;/a&gt;)). Then by changing the spapshot to be based on list of regions should suffice, no? &lt;/p&gt;</comment>
                            <comment id="13611029" author="jmhsieh" created="Fri, 22 Mar 2013 18:21:07 +0000"  >&lt;p&gt;Enis, yeah since &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7848&quot; title=&quot;Use ZK-based read/write lock to make flush-type snapshot robust against table enable/disable/alter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7848&quot;&gt;&lt;del&gt;HBASE-7848&lt;/del&gt;&lt;/a&gt; makes snapshots take the write aspect, it would do the blocking a split/merge (which would block when taking the read aspect of the lock).  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 1 Feb 2013 23:25:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>310762</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hmpz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311107</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>