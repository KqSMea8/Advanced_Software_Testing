<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:45:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7451/HBASE-7451.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7451] [snapshot] regionserver will deadlock when GlobalSnapshotOperation timeout happens</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7451</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Hi Matteo Bertozzi and Jesse Yates, My observation is base on code in github &#65306; &lt;a href=&quot;https://github.com/matteobertozzi/hbase/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/matteobertozzi/hbase/&lt;/a&gt;&lt;br/&gt;
If we create a snapshot and meet regionserver timeout. Rs will be lock and can not put any data. Please take a look at log below :&lt;/p&gt;

&lt;p&gt;// regionserver snapshot timeout&lt;br/&gt;
org.apache.hadoop.hbase.server.commit.distributed.DistributedCommitException: org.apache.hadoop.hbase.server.errorhandling.exception.OperationAttemptTimeoutException: Timeout elapsed! Start:1356518666984, End:1356518667584, diff:600, max:600 ms&lt;br/&gt;
at org.apache.hadoop.hbase.server.commit.distributed.DistributedThreePhaseCommitErrorDispatcher.wrap(DistributedThreePhaseCommitErrorDispatcher.java:135)&lt;br/&gt;
at org.apache.hadoop.hbase.server.commit.distributed.DistributedThreePhaseCommitErrorDispatcher.operationTimeout(DistributedThreePhaseCommitErrorDispatcher.java:71)&lt;br/&gt;
at org.apache.hadoop.hbase.server.commit.ThreePhaseCommit$1.receiveError(ThreePhaseCommit.java:92)&lt;br/&gt;
at org.apache.hadoop.hbase.server.commit.ThreePhaseCommit$1.receiveError(ThreePhaseCommit.java:89)&lt;br/&gt;
at org.apache.hadoop.hbase.server.errorhandling.OperationAttemptTimer$1.run(OperationAttemptTimer.java:71)&lt;br/&gt;
at java.util.TimerThread.mainLoop(Timer.java:512)&lt;br/&gt;
at java.util.TimerThread.run(Timer.java:462)&lt;br/&gt;
Caused by: org.apache.hadoop.hbase.server.errorhandling.exception.OperationAttemptTimeoutException: Timeout elapsed! Start:1356518666984, End:1356518667584, diff:600, max:600 ms&lt;br/&gt;
... 3 more&lt;br/&gt;
2012-12-26 18:44:57,211 DEBUG org.apache.hadoop.hbase.server.commit.TwoPhaseCommit: Running cleanup phase.&lt;br/&gt;
2012-12-26 18:44:57,211 DEBUG org.apache.hadoop.hbase.regionserver.snapshot.operation.SnapshotOperation: Cleanup snapshot - handled in sub-tasks on error&lt;br/&gt;
2012-12-26 18:44:57,212 DEBUG org.apache.hadoop.hbase.serv&lt;/p&gt;

&lt;p&gt;//Waiting for &apos;commit allowed&apos; latch and do not exist&lt;/p&gt;

&lt;p&gt;2012-12-26 18:44:57,211 DEBUG org.apache.hadoop.hbase.server.commit.TwoPhaseCommit: Running cleanup phase.&lt;br/&gt;
2012-12-26 18:44:57,211 DEBUG org.apache.hadoop.hbase.regionserver.snapshot.operation.SnapshotOperation: Cleanup snapshot - handled in sub-tasks on error&lt;br/&gt;
2012-12-26 18:44:57,212 DEBUG org.apache.hadoop.hbase.server.commit.TwoPhaseCommit: Running finish phase.&lt;br/&gt;
2012-12-26 18:44:57,212 DEBUG org.apache.hadoop.hbase.regionserver.snapshot.operation.SnapshotOperation: Finish snapshot - handling in subtasks on error&lt;br/&gt;
2012-12-26 18:44:57,212 WARN org.apache.hadoop.hbase.server.errorhandling.OperationAttemptTimer: Timer already marked completed, ignoring!&lt;br/&gt;
2012-12-26 18:45:01,990 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:06,990 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:11,991 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:16,991 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:17,002 INFO org.apache.hadoop.hbase.server.commit.distributed.zookeeper.ZKTwoPhaseCommitCohortMemberController: Received children changed event:/hbase-TERRY-73/online-snapshot/prepare&lt;br/&gt;
2012-12-26 18:45:17,002 INFO org.apache.hadoop.hbase.server.commit.distributed.zookeeper.ZKTwoPhaseCommitCohortMemberController: Recieved start event.&lt;br/&gt;
2012-12-26 18:45:17,002 DEBUG org.apache.hadoop.hbase.server.commit.distributed.zookeeper.ZKTwoPhaseCommitCohortMemberController: Looking for new operations under znode:/hbase-TERRY-73/online-snapshot/prepare&lt;br/&gt;
2012-12-26 18:45:17,003 INFO org.apache.hadoop.hbase.server.commit.distributed.zookeeper.ZKTwoPhaseCommitCohortMemberController: Received children changed event:/hbase-TERRY-73/online-snapshot/abort&lt;br/&gt;
2012-12-26 18:45:17,003 INFO org.apache.hadoop.hbase.server.commit.distributed.zookeeper.ZKTwoPhaseCommitCohortMemberController: Recieved abort event.&lt;br/&gt;
2012-12-26 18:45:17,003 DEBUG org.apache.hadoop.hbase.server.commit.distributed.zookeeper.ZKTwoPhaseCommitCohortMemberController: Checking for aborted operations on node:/hbase-TERRY-73/online-snapshot/abort&lt;br/&gt;
2012-12-26 18:45:21,991 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:26,992 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:31,992 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:36,992 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:41,992 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:43,481 DEBUG org.apache.hadoop.hbase.io.hfile.LruBlockCache: LRU Stats: total=11.77 MB, free=1.39 GB, max=1.4 GB, blocks=5, accesses=96, hits=91, hitRatio=94.79%, cachingAccesses=96, cachingHits=91, cachingHitsRatio=94.79%, evictions=0, evicted=0, evictedPerRun=NaN&lt;br/&gt;
2012-12-26 18:45:46,993 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:51,993 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:45:56,993 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:01,994 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:06,994 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:11,994 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:16,994 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:21,995 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:26,995 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:31,995 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:36,996 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;br/&gt;
2012-12-26 18:46:41,996 DEBUG org.apache.hadoop.hbase.util.Threads: Waiting for &apos;commit allowed&apos; latch. (sleep:5000 ms)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12625410">HBASE-7451</key>
            <summary>[snapshot] regionserver will deadlock when GlobalSnapshotOperation timeout happens</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="terry_zhang">terry zhang</assignee>
                                    <reporter username="terry_zhang">terry zhang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Dec 2012 09:49:07 +0000</created>
                <updated>Thu, 8 Jan 2015 09:34:31 +0000</updated>
                            <resolved>Thu, 8 Jan 2015 09:34:31 +0000</resolved>
                                                                    <component>snapshots</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13540414" author="terry_zhang" created="Fri, 28 Dec 2012 09:54:56 +0000"  >&lt;p&gt;This is because GloballyConsistentRegionLockTask is extends from TwoPhaseCommit (not ThreePhaseCommit). So it do not have OperationAttemptTimer to handle timeout exception. So when GlobalSnapshotOperation meet timeout,below code will not be executed. and AllowCommit will not released.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;GlobalSnapshotOperation.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void commit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; DistributedCommitException {
    &lt;span class=&quot;code-comment&quot;&gt;// Release all the locks taken on the involved regions
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ops == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || ops.size() == 0) {
      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;No region operations to release from the snapshot because we didn&apos;t get a chance&quot;&lt;/span&gt;
          + &lt;span class=&quot;code-quote&quot;&gt;&quot; to create them.&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Releasing commit barrier &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; globally consistent snapshot.&quot;&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (RegionSnapshotOperation op : ops) {
      ((GloballyConsistentRegionLockTask) op).getAllowCommitLatch().countDown();
    }

    &lt;span class=&quot;code-comment&quot;&gt;// wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; all the outstanding tasks
&lt;/span&gt;    waitUntilDone();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;So GloballyConsistentRegionLockTask will wait for ever.&lt;/p&gt;

</comment>
                            <comment id="13540418" author="terry_zhang" created="Fri, 28 Dec 2012 09:57:43 +0000"  >&lt;p&gt;My solution is simple, Just notify snapshotErrorListener to threw a exception to let all GloballyConsistentRegionLockTask  to quit and release the region lock.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;SnapshotOperation.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void cleanup(Exception e) {
    LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cleanup snapshot - handled in sub-tasks on error&quot;&lt;/span&gt;);
  +  snapshotErrorListener.receiveError(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cleanup snapshot&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HBaseSnapshotException(e.getMessage()));
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="13540469" author="mbertozzi" created="Fri, 28 Dec 2012 14:18:22 +0000"  >&lt;p&gt;Thanks for taking a look at the code.&lt;/p&gt;

&lt;p&gt;In the last months that code was refactored and simplified, and now the 3phase-commit doesn&apos;t exist anymore. Take a look at &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7212&quot; title=&quot;Globally Barriered Procedure mechanism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7212&quot;&gt;&lt;del&gt;HBASE-7212&lt;/del&gt;&lt;/a&gt; Globally Barriered Procedure Mechanism&quot; that is the replacement for that (review here: &lt;a href=&quot;https://reviews.apache.org/r/8240/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/8240/&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;globally consistent snapshot was also put aside, and it will not be in the first snapshot cut.&lt;/p&gt;

&lt;p&gt;You can find the full branch containing the new procedure mechanism and the new online snapshot code here: &lt;a href=&quot;https://github.com/jmhsieh/hbase/commits/snapshots-work&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/jmhsieh/hbase/commits/snapshots-work&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14269069" author="clehene" created="Thu, 8 Jan 2015 09:34:31 +0000"  >&lt;p&gt;This is old and code has been updated (see comments). Closing for now&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 28 Dec 2012 14:18:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>301952</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16xmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248580</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>