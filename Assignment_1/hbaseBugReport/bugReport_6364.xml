<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:36:06 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6364/HBASE-6364.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6364] Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6364</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When a server host with a Region Server holding the .META. table is powered down on a live cluster, while the HBase cluster itself detects and reassigns the .META. table, connected HBase Client&apos;s take an excessively long time to detect this and re-discover the reassigned .META. &lt;/p&gt;

&lt;p&gt;Workaround: Decrease the ipc.socket.timeout on HBase Client side to a low  value (default is 20s leading to 35 minute recovery time; we were able to get acceptable results with 100ms getting a 3 minute recovery) &lt;/p&gt;

&lt;p&gt;This was found during some hardware failure testing scenarios. &lt;/p&gt;

&lt;p&gt;Test Case:&lt;br/&gt;
1) Apply load via client app on HBase cluster for several minutes&lt;br/&gt;
2) Power down the region server holding the .META. server (i.e. power off ... and keep it off)&lt;br/&gt;
3) Measure how long it takes for cluster to reassign META table and for client threads to re-lookup and re-orient to the lesser cluster (minus the RS and DN on that host).&lt;/p&gt;

&lt;p&gt;Observation:&lt;br/&gt;
1) Client threads spike up to maxThreads size ... and take over 35 mins to recover (i.e. for the thread count to go back to normal) - no client calls are serviced - they just back up on a synchronized method (see #2 below)&lt;/p&gt;

&lt;p&gt;2) All the client app threads queue up behind the oahh.ipc.HBaseClient#setupIOStreams method &lt;a href=&quot;http://tinyurl.com/7js53dj&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://tinyurl.com/7js53dj&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;After taking several thread dumps we found that the thread within this synchronized method was blocked on  NetUtils.connect(this.socket, remoteId.getAddress(), getSocketTimeout(conf));&lt;/p&gt;

&lt;p&gt;The client thread that gets the synchronized lock would try to connect to the dead RS (till socket times out after 20s), retries, and then the next thread gets in and so forth in a serial manner.&lt;/p&gt;

&lt;p&gt;Workaround:&lt;br/&gt;
-------------------&lt;br/&gt;
Default ipc.socket.timeout is set to 20s. We dropped this to a low number (1000 ms,  100 ms, etc) on the client side hbase-site.xml. With this setting, the client threads recovered in a couple of minutes by failing fast and re-discovering the .META. table on a reassigned RS.&lt;/p&gt;

&lt;p&gt;Assumption: This ipc.socket.timeout is only ever used during the initial &quot;HConnection&quot; setup via the NetUtils.connect and should only ever be used when connectivity to a region server is lost and needs to be re-established. i.e it does not affect the normal &quot;RPC&quot; actiivity as this is just the connect timeout.&lt;br/&gt;
During RS GC periods, any &lt;em&gt;new&lt;/em&gt; clients trying to connect will fail and will require .META. table re-lookups.&lt;/p&gt;

&lt;p&gt;This above timeout workaround is only for the HBase client side.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12598225">HBASE-6364</key>
            <summary>Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkeywal">Nicolas Liochon</assignee>
                                    <reporter username="svarma">Suraj Varma</reporter>
                        <labels>
                            <label>client</label>
                    </labels>
                <created>Tue, 10 Jul 2012 17:06:49 +0000</created>
                <updated>Thu, 30 May 2013 09:33:42 +0000</updated>
                            <resolved>Sun, 26 Aug 2012 01:17:13 +0000</resolved>
                                    <version>0.90.6</version>
                    <version>0.92.1</version>
                    <version>0.94.0</version>
                                    <fixVersion>0.94.2</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>12</watches>
                                                                <comments>
                            <comment id="13410555" author="svarma" created="Tue, 10 Jul 2012 17:12:34 +0000"  >&lt;p&gt;Also wanted to capture NKeywal&apos;s comments on this from the mailing list: &lt;/p&gt;

&lt;p&gt;NKeywal said: &lt;br/&gt;
What you&apos;re describing &lt;del&gt;the 35 minutes recovery time&lt;/del&gt; seems to match the code. And it&apos;s a bug (still there on trunk). Could you please create a jira for it? If you have the logs it even better.&lt;/p&gt;

&lt;p&gt;Lowering the ipc.socket.timeout seems to be an acceptable partial workaround. Setting it to 10s seems ok to me. Lower than this... I don&apos;t know.&lt;/p&gt;</comment>
                            <comment id="13418397" author="nkeywal" created="Thu, 19 Jul 2012 16:07:37 +0000"  >&lt;p&gt;That&apos;s a possible cause:&lt;/p&gt;

&lt;p&gt;in HBaseClient#getConnection()&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    do {
      synchronized (connections) {
        connection = connections.get(remoteId);
        if (connection == null) {
          connection = new Connection(remoteId);
          connections.put(remoteId, connection);
        }
      }
    } while (!connection.addCall(call));
    
    connection.setupIOstreams();
    return connection;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Connection#addCall and Connection#setupIOstreams are synchronized. if #setupIOstreams fails, it marks the connection as dead, remove it from the connections list, and throws an exception. In #addCall it returns false if the connection is marked as dead. So&lt;br/&gt;
case 1 -&amp;gt; Sometimes, we may add the call to a connection that will be marked as dead:&lt;br/&gt;
 Thread 1: create the connection, add it to the connections list, call addCall&lt;br/&gt;
 Thread 2: get the connection, add it to the calls list &lt;br/&gt;
 Thread 1: get into setupIOstreams, fails, and mark the connection as dead, throws an exception, done&lt;br/&gt;
 Thread 2: get into setupIOstreams, see that the connection is dead, done. The call has been added to a dead connection&lt;/p&gt;

&lt;p&gt;case 2 -&amp;gt; If we have a lot of threads on a dying connection, we will have:&lt;br/&gt;
 Thread 1: goes until setupIOstreams&lt;br/&gt;
 All other threads: get the connection from the list, wait on the synchronized addCall &lt;br/&gt;
 Thread 1: exit from setupIOstreams with an exception after 20 seconds (socket timeout)&lt;br/&gt;
 All other threads: call addCall, as the connection is dead, reloop&lt;br/&gt;
 One of these threads will create a connection&lt;br/&gt;
 One of these thread will win the race on addCall&lt;br/&gt;
 One of them will win the race on setupIOstreams&lt;br/&gt;
 Most of them should be waiting on addCall so reloop&lt;br/&gt;
 So back to the case 1 or 2.&lt;/p&gt;


&lt;p&gt;We would have the same behavior on pure hadoop client (ipc.Client), as the implementation is similar, at least on 1.0.3.&lt;/p&gt;


&lt;p&gt;Suraj, does this match your analysis? How many region servers and regions did you have during your test? What&apos;s the client doing?&lt;/p&gt;</comment>
                            <comment id="13424288" author="svarma" created="Sat, 28 Jul 2012 06:56:32 +0000"  >&lt;p&gt;stack trace snippet from test.&lt;/p&gt;</comment>
                            <comment id="13424289" author="svarma" created="Sat, 28 Jul 2012 06:56:47 +0000"  >&lt;p&gt;nkeywal, my test cluster had 5 regionservers with an average of 35 regions per server. The client is doing Get calls from all threads - each thread creates a separate HTable but with the same HBaseConfiguration (so, sharing the same underlying HConnection.)&lt;/p&gt;

&lt;p&gt;Case 2 that you mention above is what I think I saw. Several threads blocked on #addCall with a lock owned by the setupIOStreams call (on NetUtils.connect()) which was timing out after 20s. &lt;/p&gt;

&lt;p&gt;I finally managed to locate the stack traces from the test ... I&apos;m attaching a snippet from that with some BLOCKED threads and the setupIOStreams call holding the lock. &lt;/p&gt;

&lt;p&gt;I believe the same behaviour would occur on the hadoop client as well ... but perhaps because of multiple datanodes, the problem is not as acute? In the HBaseClient case, all threads repeatedly reaches out for META to rediscover the relocated regions. &lt;br/&gt;
(Attached the thread dump snippet)&lt;/p&gt;</comment>
                            <comment id="13424308" author="nkeywal" created="Sat, 28 Jul 2012 09:40:43 +0000"  >&lt;p&gt;Thanks Suraj. So it seems that we have the root cause. You&apos;re right, on ipc.Client it&apos;s less likely to occur. Only the NN could have the issue I think, and as the hot failover is not yet deployed in production, it has not been an issue so far. I will ping Todd on this to see what he thinks.&lt;/p&gt;

&lt;p&gt;The only strange thing is that when tested on the 0.96 + minicluster, I have the issue but many threads seem to be able to &apos;escape&apos;, i.e. manage to do the &apos;addCall&apos; between two blocking calls to setupIOstreams. But it could be a pure multithreading hazard. And I haven&apos;t been able to find a better cause than this.&lt;/p&gt;

&lt;p&gt;I will propose a patch, likely end of next week. Suraj, If you have some time available to validate it on your env, it would be great.&lt;/p&gt;</comment>
                            <comment id="13428879" author="nkeywal" created="Sun, 5 Aug 2012 16:56:48 +0000"  >&lt;p&gt;v1. There are some other ways of doing this, like adding a list of dead servers and a timeout, but it does not pass the unit tests, with numerous failures. I haven&apos;t sorted out if there is a common root cause...&lt;/p&gt;</comment>
                            <comment id="13428886" author="hadoopqa" created="Sun, 5 Aug 2012 17:53:38 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12539211/6364.v1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12539211/6364.v1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    -1 javac.  The applied patch generated 5 javac compiler warnings (more than the trunk&apos;s current 4 warnings).&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 9 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.master.TestAssignmentManagerOnCluster&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestAssignmentManager&lt;br/&gt;
                  org.apache.hadoop.hbase.regionserver.TestServerCustomProtocol&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2513//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13428890" author="nkeywal" created="Sun, 5 Aug 2012 18:13:06 +0000"  >&lt;p&gt;likely to be unrelated, worked twice locally. Let&apos;s retry.&lt;/p&gt;</comment>
                            <comment id="13428920" author="zhihyu@ebaysf.com" created="Sun, 5 Aug 2012 22:26:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2514/console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2514/console&lt;/a&gt; got aborted.&lt;/p&gt;</comment>
                            <comment id="13428921" author="zhihyu@ebaysf.com" created="Sun, 5 Aug 2012 22:27:09 +0000"  >&lt;p&gt;Patch from N.&lt;/p&gt;</comment>
                            <comment id="13428975" author="lhofhansl" created="Mon, 6 Aug 2012 04:36:02 +0000"  >&lt;p&gt;Is this alleviated (at least somewhat) by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6326&quot; title=&quot;Avoid nested retry loops in HConnectionManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6326&quot;&gt;&lt;del&gt;HBASE-6326&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13428976" author="lhofhansl" created="Mon, 6 Aug 2012 04:41:37 +0000"  >&lt;p&gt;Looking at the issue, no it isn&apos;t. NM me. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13429012" author="nkeywal" created="Mon, 6 Aug 2012 07:49:13 +0000"  >&lt;p&gt;Reanalyzing the fix, there is an issue with the v1: we could have a call added to a dying connection, and this call won&apos;t get cleaned up. This is was not possible previously. Will write a v2.&lt;/p&gt;</comment>
                            <comment id="13429052" author="nkeywal" created="Mon, 6 Aug 2012 09:54:49 +0000"  >&lt;p&gt;v2, fixes the problem mentioned above, works locally.&lt;/p&gt;</comment>
                            <comment id="13429072" author="hadoopqa" created="Mon, 6 Aug 2012 10:50:36 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12539258/6364.v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12539258/6364.v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    -1 javac.  The applied patch generated 5 javac compiler warnings (more than the trunk&apos;s current 4 warnings).&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 10 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2516//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13429078" author="nkeywal" created="Mon, 6 Aug 2012 10:54:09 +0000"  >&lt;p&gt;v3 just changes a comment, not the code itself.&lt;/p&gt;</comment>
                            <comment id="13429098" author="hadoopqa" created="Mon, 6 Aug 2012 11:52:51 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12539272/6364.v3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12539272/6364.v3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    -1 javac.  The applied patch generated 5 javac compiler warnings (more than the trunk&apos;s current 4 warnings).&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 10 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.client.TestFromClientSide&lt;br/&gt;
                  org.apache.hadoop.hbase.io.hfile.TestForceCacheImportantBlocks&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestAssignmentManager&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2517//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13429139" author="nkeywal" created="Mon, 6 Aug 2012 13:30:35 +0000"  >&lt;p&gt;errors are unrelated imho. Retrying to see if the third executions says something different.&lt;/p&gt;</comment>
                            <comment id="13429233" author="stack" created="Mon, 6 Aug 2012 16:24:34 +0000"  >&lt;p&gt;Good one lads.&lt;/p&gt;

&lt;p&gt;Fix formatting before commit N.  Make it same as surrounding code... Add spacings around brackets &amp;#8211; the &apos;else&apos; &amp;#8211; and the &apos;+&apos; in String concatenations.&lt;/p&gt;

&lt;p&gt;I think I understand the notifying that is going on on the end of the addCall method.  They line up w/ waits on Call and waits on the calls data member?&lt;/p&gt;

&lt;p&gt;Would it be hard making a test of this bit of code?&lt;/p&gt;

&lt;p&gt;What speed up around recovery are you seeing N?  Should we change the default timeout too as Suraj does above?&lt;/p&gt;</comment>
                            <comment id="13429238" author="zhihyu@ebaysf.com" created="Mon, 6 Aug 2012 16:31:18 +0000"  >&lt;p&gt;In addCall():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        calls.put(call.id, call);
+        notify();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do we need a &apos;synchronized (call)&apos; block for the above notification ?&lt;/p&gt;</comment>
                            <comment id="13429295" author="nkeywal" created="Mon, 6 Aug 2012 17:51:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;Fix formatting before commit N.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ok.&lt;/p&gt;

&lt;p&gt;Before committing, I would be interested by a feedback from Suraj. There are just a few lines of code, so rebasing won&apos;t be complicated if he needs some time to test it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think I understand the notifying that is going on on the end of the addCall method. They line up w/ waits on Call and waits on the calls data member?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s mainly playing with the synchronized: Connection#addCall &amp;amp; Connection#setupIOstreams are both synchronized, so, on an exception during setupIOstreams, either:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;you were waiting just before setupIOstreams, and in this case you&apos;ve been clean up during setupIOstreams exception management&lt;/li&gt;
	&lt;li&gt;you were waiting before the addCall, and in this case you won&apos;t be added to the calls list.&lt;/li&gt;
	&lt;li&gt;in both case when you enter yourself in setupIOstreams you are filtered by the test on shouldCloseConnection&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;Would it be hard making a test of this bit of code?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s a difficult question, because there are both the behavior of this jira and both the generic behavior to be tested.&lt;br/&gt;
1) Just for this jira, when I tested it I added a sleep to simulate a connection timeout. I will provide soon a (small) set of utility functions to better simulated this, with real timeouts. This type of test (more in the category of regression tests than unit tests) could be added to the integration tests may be. I had various issues during the tests, it was more difficult than expected.&lt;br/&gt;
2) Testing the HBaseClient itself would be useful, but the interesting path is the multithreaded one.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What speed up around recovery are you seeing N? Should we change the default timeout too as Suraj does above?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For the speed up, it&apos;s arbitrary, as it depends on the number of RS. on my tests, 20% of the calls were serialized. I.e. with an operation on 20 rs, the fix makes it 3 times faster. But it seems that Suraj had a much worse serialization, on a bigger cluster, so for him we could expect much better results, likely 20 times faster or better.&lt;br/&gt;
Another point is that in this fix we don&apos;t keep a list of dead rs, so we cut the connection attempts only of they are happening while another is taking place.  So if he could try it would be great.&lt;/p&gt;

&lt;p&gt;For the default timeout, I think we can cut down the connect timeout. But I think it&apos;s safer to make it to 5 seconds, so this fix remains important. I will work on this on another jira.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Do we need a &apos;synchronized (call)&apos; block for the above notification ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s a notification on the connection itself, and addCall is synchronized, so it&apos;s ok. Then &apos;calls&apos; is a &apos;ConcurrentSkipListMap&apos; so we can access it concurrently.&lt;/p&gt;</comment>
                            <comment id="13429394" author="stack" created="Mon, 6 Aug 2012 20:26:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Before committing, I would be interested by a feedback from Suraj. There are just a few lines of code, so rebasing won&apos;t be complicated if he needs some time to test it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds good.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For the default timeout, I think we can cut down the connect timeout. But I think it&apos;s safer to make it to 5 seconds, so this fix remains important. I will work on this on another jira.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds good too.&lt;/p&gt;

&lt;p&gt;On test, even if its utility to simulate so you can prove your fix, that&apos;d be great.&lt;/p&gt;

&lt;p&gt;I like the numbers you are quoting above.&lt;/p&gt;
</comment>
                            <comment id="13429500" author="lhofhansl" created="Mon, 6 Aug 2012 22:22:10 +0000"  >&lt;p&gt;Not sure I wrapped my head around the issue completely. But from the discussion here and looking at the patch it looks right.&lt;br/&gt;
This should be in 0.94 as well.&lt;/p&gt;</comment>
                            <comment id="13431174" author="nkeywal" created="Wed, 8 Aug 2012 15:40:06 +0000"  >&lt;p&gt;New version, with the results of the test implementation on the mini cluster:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I haven&apos;t been able to simulate a connect timeout. So I need to instrument the code a way or another to add a sleep if we want the push the tests in the test suite. I can do that by subclassing HBaseClient for example. It won&apos;t be very clean. Is there another solution?&lt;/li&gt;
	&lt;li&gt;When I implemented Suraj scenario, I reproduced exactly his issue (while previously, in my tests the time lost was only a fraction of the number of threads). And my fix was not working on this specific scenario.&lt;/li&gt;
	&lt;li&gt;So I finally added a dead servers list. The expiry time is configurable (hbase.ipc.client.recheckServersTimeout). It&apos;s not totally without impact: if someone was actually relying on the time spent on retries (for example if a server comes down &amp;amp; up again), he will be disappointed... I set a small default value for this reason (2 seconds, ie. less than most retries wait time). Increasing it should be done only if there are good reasons for this.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13431774" author="nkeywal" created="Thu, 9 Aug 2012 12:32:01 +0000"  >&lt;p&gt;For the tests, I tried 2 options:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Implementing a specific SocketFactory that would return configurable sockets. Too fragile &amp;amp; too complicated&lt;/li&gt;
	&lt;li&gt;Adding a hook to get a specific HBaseClient implementation, that would add the sleep when necessary. That&apos;s in the v6.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;On the long term, I think the best place to add test hooks is NetUtils, but this class is made of static methods and is in the hadoop.net package, not HBase.&lt;/p&gt;


&lt;p&gt;I&apos;m not a big fan of adding these new tests to the main build, but it can now be done.&lt;/p&gt;</comment>
                            <comment id="13431800" author="hadoopqa" created="Thu, 9 Aug 2012 13:34:43 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12540017/6364.v6.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12540017/6364.v6.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    -1 javac.  The applied patch generated 5 javac compiler warnings (more than the trunk&apos;s current 4 warnings).&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 9 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.TestLocalHBaseCluster&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestSplitLogManager&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2538//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13431866" author="stack" created="Thu, 9 Aug 2012 14:50:51 +0000"  >&lt;p&gt;We already have a class named DeadServers here: ./hbase-server/src/main/java/org/apache/hadoop/hbase/master/DeadServer.java  Maybe name this something else?&lt;/p&gt;

&lt;p&gt;Do you think the deadservers will hold reference to the original backing Map?  If so, if we keep adding, are we adding to backing Map or to the tailMap?  I&apos;m talking about here:&lt;/p&gt;

&lt;p&gt;+        deadServers = deadServers.tailMap(now);&lt;/p&gt;

&lt;p&gt;I&apos;m afraid we will be retaining reference to backing Map and it will grow without bound?  Is that possible?&lt;/p&gt;

&lt;p&gt;So, if default timeout for items in list is two seconds and socket timeout is 20 seconds, will items timeout in the dead list before we ever make use of it?&lt;/p&gt;

&lt;p&gt;You should fix the formatting adding spaces around &apos;+&apos; etc., so it has formatting like the rest of the code in this class... or is that how its done elsewhere in this class?   If so, fine.&lt;/p&gt;

&lt;p&gt;Your addition where we can override HBaseClient looks generally useful.&lt;/p&gt;

&lt;p&gt;Use EnvironmentEdge instead of System.currentMillis...&lt;/p&gt;

&lt;p&gt;+    final long start = System.currentTimeMillis();&lt;/p&gt;

&lt;p&gt;Test looks good.&lt;/p&gt;

&lt;p&gt;Is the HBaseRecoveryTestingUtility generally useful do you think?  Maybe we don&apos;t add test but add this? (This class needs class comment explaining what goodies it has).&lt;/p&gt;

&lt;p&gt;Good stuff.&lt;/p&gt;</comment>
                            <comment id="13431893" author="nkeywal" created="Thu, 9 Aug 2012 15:18:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;We already have a class named DeadServers here: ./hbase-server/src/main/java/org/apache/hadoop/hbase/master/DeadServer.java Maybe name this something else?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You&apos;re right. Ok.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m afraid we will be retaining reference to backing Map and it will grow without bound? Is that possible?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s even probable &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I need to fix this.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;So, if default timeout for items in list is two seconds and socket timeout is 20 seconds, will items timeout in the dead list before we ever make use of it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, because it&apos;s added after the timeout. So:&lt;br/&gt;
t0: connect starts, will wait 20s&lt;br/&gt;
t &amp;lt;19: all threads get in the queue because of the synchronized&lt;br/&gt;
t20: timeout; added to the dead list, synchronized lock freed&lt;br/&gt;
t21: all threads gets in and gets out because of the dead server list&lt;br/&gt;
t22: if a new thread comes in with the wrong server it will wait again&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Use EnvironmentEdge instead of System.currentMillis...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Even in an unit test? I didn&apos;t know. Ok.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;You should fix the formatting adding spaces around &apos;+&apos; etc., so it has formatting like the rest of the code in this class... or is that how its done elsewhere in this class? If so, fine.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will recheck. There are some &apos;+&apos; like this in HBaseClient already &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. But I will add spaces to mines.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Is the HBaseRecoveryTestingUtility generally useful do you think? Maybe we don&apos;t add test but add this? (This class needs class comment explaining what goodies it has).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, I think so. It helps to write more readable failure tests. It still has rough edges, and may be bugs. Also, some functions should be in HBaseTestingUtility. It will be ready soon, but it&apos;s better to wait a little before committing...&lt;/p&gt;

&lt;p&gt;Thanks for the feedback.&lt;/p&gt;</comment>
                            <comment id="13432059" author="zhihyu@ebaysf.com" created="Thu, 9 Aug 2012 18:46:19 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      deadServers.put(expiry, address.toString());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do we need a MultiMap as the backing store for deadServers (possibly two servers having the same expiration time) ?&lt;/p&gt;

&lt;p&gt;The hbase.ipc.client.recheckServersTimeout is for dead servers. Release note is needed so that people know what to look for.&lt;/p&gt;</comment>
                            <comment id="13432071" author="nkeywal" created="Thu, 9 Aug 2012 18:58:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do we need a MultiMap as the backing store for deadServers (possibly two servers having the same expiration time) ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You&apos;re right. I will need to fix this as well.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The hbase.ipc.client.recheckServersTimeout is for dead servers. Release note is needed so that people know what to look for.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Will do. But the default should be good for most people imho. I will put a warning in the release notes (there could be an issue if a node disappears and comes back if the setting is too high: the client will have to wait for the end of the recheck before seeing the node coming back).&lt;/p&gt;</comment>
                            <comment id="13432080" author="zhihyu@ebaysf.com" created="Thu, 9 Aug 2012 19:09:57 +0000"  >&lt;p&gt;@N:&lt;br/&gt;
Thanks for the quick response. Appreciate it.&lt;br/&gt;
nit: please add javadoc for remoteId:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+   * Creates a connection. Can be overridden by a subclass &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; testing.
+   */
+  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Connection createConnection(ConnectionId remoteId) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        IOException e = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DeadServerIOException(
+            &lt;span class=&quot;code-quote&quot;&gt;&quot;This server is is the dead server list: &quot;&lt;/span&gt;+server);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&apos;is is&apos; -&amp;gt; &apos;is in&apos;&lt;br/&gt;
DeadServerIOException extends IOException, I think &apos;IO&apos; doesn&apos;t have to appear in the name of exception.&lt;/p&gt;

&lt;p&gt;Would be nice if the next patch is put up on review board.&lt;/p&gt;</comment>
                            <comment id="13432344" author="svarma" created="Fri, 10 Aug 2012 00:27:58 +0000"  >&lt;p&gt;Thanks nkeywal - this looks great. I will try to rebase it back to my version and see if I can arrange a re-test. However, please don&apos;t wait for me for your commit as it may take a few days before I can arrange to run this in my environment (perhaps end of next week ... at best). &lt;/p&gt;
</comment>
                            <comment id="13432710" author="nkeywal" created="Fri, 10 Aug 2012 11:56:12 +0000"  >&lt;p&gt;@Suraj&lt;br/&gt;
Ok, we will see how it takes to finish the review process as well. But I&apos;ve reproduced your scenario I think.&lt;/p&gt;

&lt;p&gt;@All&lt;br/&gt;
v8 with all comments taken into account&lt;br/&gt;
TestHBaseClient to be in the final commit&lt;br/&gt;
Test_HBASE_6364 / HBaseRecoveryTestingUtility not for the final commit&lt;/p&gt;

&lt;p&gt;I&apos;m going to create a rb for this as well.&lt;/p&gt;</comment>
                            <comment id="13432713" author="nkeywal" created="Fri, 10 Aug 2012 12:03:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/6521/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/6521/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13434952" author="nkeywal" created="Wed, 15 Aug 2012 10:24:08 +0000"  >&lt;p&gt;v10 with all comments taken into account. Unfortunately, TestReplication failed 3 times in a row. I need to look at this. There is no clear reason, this last patch is very similar to the previous one. Will look at that later...&lt;/p&gt;</comment>
                            <comment id="13435095" author="nkeywal" created="Wed, 15 Aug 2012 13:30:50 +0000"  >&lt;p&gt;Ok, tried 3 more times, they&apos;re all successful. So I think it&apos;s ok. If there is nothing scary in the hadoop-qa-build, I will commit v10 within 2 or 3 days.&lt;/p&gt;</comment>
                            <comment id="13435158" author="hadoopqa" created="Wed, 15 Aug 2012 14:32:02 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12541031/6364.v9.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12541031/6364.v9.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    -1 javac.  The applied patch generated 5 javac compiler warnings (more than the trunk&apos;s current 4 warnings).&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 9 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2587//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13437137" author="stack" created="Fri, 17 Aug 2012 23:24:54 +0000"  >&lt;p&gt;@nkeywal Where is v10?  I see v9 attached here.  Is it what is up in RB?&lt;/p&gt;</comment>
                            <comment id="13437294" author="nkeywal" created="Sat, 18 Aug 2012 12:13:19 +0000"  >&lt;p&gt;@stack. Sorry I missed your message. Yes, the last one is v9, and it&apos;s the one in RB as well.&lt;/p&gt;</comment>
                            <comment id="13437420" author="stack" created="Sat, 18 Aug 2012 22:03:38 +0000"  >&lt;p&gt;I added some comment up on RB but this is close to committable IMO&lt;/p&gt;</comment>
                            <comment id="13438595" author="nkeywal" created="Tue, 21 Aug 2012 10:46:11 +0000"  >&lt;p&gt;Version that will be committed if the local tests (in progress) are ok.&lt;/p&gt;</comment>
                            <comment id="13438612" author="nkeywal" created="Tue, 21 Aug 2012 11:15:14 +0000"  >&lt;p&gt;Committed revision 1375473.&lt;/p&gt;

&lt;p&gt;After another fishy and not reproduced error on org.apache.hadoop.hbase.TestMultiVersions&lt;/p&gt;</comment>
                            <comment id="13438622" author="hudson" created="Tue, 21 Aug 2012 11:45:04 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #140 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/140/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/140/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6364&quot; title=&quot;Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6364&quot;&gt;&lt;del&gt;HBASE-6364&lt;/del&gt;&lt;/a&gt; Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table (Revision 1375473)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
nkeywal : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/ClientCache.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/HBaseClient.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/util/EnvironmentEdgeManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/util/ManualEnvironmentEdge.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/ipc/TestHBaseClient.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13438684" author="hudson" created="Tue, 21 Aug 2012 12:56:46 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #3248 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/3248/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/3248/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6364&quot; title=&quot;Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6364&quot;&gt;&lt;del&gt;HBASE-6364&lt;/del&gt;&lt;/a&gt; Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table (Revision 1375473)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
nkeywal : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/ClientCache.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/ipc/HBaseClient.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/util/EnvironmentEdgeManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/util/ManualEnvironmentEdge.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/ipc/TestHBaseClient.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13438855" author="lhofhansl" created="Tue, 21 Aug 2012 17:00:19 +0000"  >&lt;p&gt;@Nicholas: What&apos;s your feeling here... Should this go into 0.94? The patch seems contained to me.&lt;/p&gt;</comment>
                            <comment id="13438874" author="nkeywal" created="Tue, 21 Aug 2012 17:17:22 +0000"  >&lt;p&gt;@lars&lt;br/&gt;
I think it&apos;s reasonably safe (well I wrote it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ). On the other hand to have the issue it solves you need to be a little bit unlucky as well. As the consequences are quite bad when you&apos;re unlucky I think it&apos;s better to do it. And if there is an issue you can deactivate it (by setting hbase.ipc.client.failed.servers.expiry to zero), or lower the expiry time to something as 100ms. If it breaks something I will fix it for both versions.&lt;/p&gt;</comment>
                            <comment id="13438931" author="stack" created="Tue, 21 Aug 2012 18:34:52 +0000"  >&lt;p&gt;+1 on backport so we get benefit of the MTTR work sooner.&lt;/p&gt;

&lt;p&gt;@Nkeywal Should we lower the default  ipc.socket.timeout too?  I don&apos;t see that in your patch?&lt;/p&gt;</comment>
                            <comment id="13438968" author="nkeywal" created="Tue, 21 Aug 2012 19:25:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;+1 on backport so we get benefit of the MTTR work sooner.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I can do it if you like.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;@Nkeywal Should we lower the default ipc.socket.timeout too? I don&apos;t see that in your patch?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Doable, there will be no side effect, it&apos;s used only in HBaseClient. How do you want it:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;safe: 10 seconds&lt;/li&gt;
	&lt;li&gt;reasonably aggressive: 5 seconds&lt;/li&gt;
	&lt;li&gt;instructive: 1 second&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;20 seconds is a common timeout value (used in the OS if I remember well). Not subject to GC effects. I don&apos;t know for large clusters under large failure conditions (with switches). Especially, in this case, it will be all the clients connecting to a single server (the one with meta), so likely going through a single network link at the end. I would vote 10s; but 5s is doable. 1s could work, who knows?&lt;/p&gt;</comment>
                            <comment id="13439080" author="stack" created="Tue, 21 Aug 2012 21:48:47 +0000"  >&lt;p&gt;20 is the current default?  If so, we can leave it.  Should we add a note to perf section of refguide on lowering connection timeout?&lt;/p&gt;

&lt;p&gt;That&apos;d be grand if you&apos;d commit to 0.94.&lt;/p&gt;</comment>
                            <comment id="13439082" author="nkeywal" created="Tue, 21 Aug 2012 21:53:36 +0000"  >&lt;p&gt;For connect timeout, yes it&apos;s 20s. We could add a note as well, I will create a jira for this. And commit in 0.94.&lt;/p&gt;</comment>
                            <comment id="13439450" author="nkeywal" created="Wed, 22 Aug 2012 12:35:00 +0000"  >&lt;p&gt;6364.94.v2.nolargetest.patch contains the patch for 0.94. My own test depends on a class that does not exist in 0.94; so I didn&apos;t test it on 0.95 &lt;/p&gt;

&lt;p&gt;Unit tests ok, except   testClientPoolRoundRobin(org.apache.hadoop.hbase.client.TestFromClientSide): The number of versions of &apos;[B@4c9cde9a:[B@4eda77c1 did not match 4 expected:&amp;lt;4&amp;gt; but was:&amp;lt;3&amp;gt;&lt;/p&gt;

&lt;p&gt;failed once, second try ok. Committed.&lt;/p&gt;</comment>
                            <comment id="13439525" author="hudson" created="Wed, 22 Aug 2012 13:48:10 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #48 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/48/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/48/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6364&quot; title=&quot;Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6364&quot;&gt;&lt;del&gt;HBASE-6364&lt;/del&gt;&lt;/a&gt; Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table (Revision 1376013)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
nkeywal : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/ipc/HBaseClient.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/util/EnvironmentEdgeManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/util/ManualEnvironmentEdge.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13439545" author="hudson" created="Wed, 22 Aug 2012 14:04:52 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #415 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/415/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/415/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6364&quot; title=&quot;Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6364&quot;&gt;&lt;del&gt;HBASE-6364&lt;/del&gt;&lt;/a&gt; Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table (Revision 1376013)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
nkeywal : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/ipc/HBaseClient.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/util/EnvironmentEdgeManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/util/ManualEnvironmentEdge.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13439655" author="zhihyu@ebaysf.com" created="Wed, 22 Aug 2012 16:35:21 +0000"  >&lt;p&gt;Addendum looks good to me.&lt;/p&gt;</comment>
                            <comment id="13439659" author="hadoopqa" created="Wed, 22 Aug 2012 16:36:51 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12541992/6364.94.v2.nolargetest.security-addendum.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12541992/6364.94.v2.nolargetest.security-addendum.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2648//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2648//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13439672" author="nkeywal" created="Wed, 22 Aug 2012 16:49:44 +0000"  >&lt;p&gt;No failure on the unit tests small &amp;amp; medium with the security profile.&lt;br/&gt;
Committed revision 1376136.&lt;/p&gt;</comment>
                            <comment id="13439718" author="hudson" created="Wed, 22 Aug 2012 17:58:10 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #416 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/416/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/416/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6364&quot; title=&quot;Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6364&quot;&gt;&lt;del&gt;HBASE-6364&lt;/del&gt;&lt;/a&gt; Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table - security addendum (Revision 1376136)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
nkeywal : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureClient.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13439725" author="stack" created="Wed, 22 Aug 2012 18:07:50 +0000"  >&lt;p&gt;+1 on addendum&lt;/p&gt;</comment>
                            <comment id="13439726" author="nkeywal" created="Wed, 22 Aug 2012 18:08:20 +0000"  >&lt;p&gt;This time it&apos;s the usual guilty so I think we&apos;re ok.&lt;/p&gt;</comment>
                            <comment id="13440025" author="lhofhansl" created="Thu, 23 Aug 2012 03:23:15 +0000"  >&lt;p&gt;@Nicholas: Thank you very much for backporting the patch!&lt;/p&gt;</comment>
                            <comment id="13440213" author="hudson" created="Thu, 23 Aug 2012 11:12:42 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #49 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/49/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/49/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6364&quot; title=&quot;Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6364&quot;&gt;&lt;del&gt;HBASE-6364&lt;/del&gt;&lt;/a&gt; Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table - security addendum (Revision 1376136)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
nkeywal : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureClient.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13441999" author="lhofhansl" created="Sun, 26 Aug 2012 01:17:13 +0000"  >&lt;p&gt;This was committed, marking fixed.&lt;/p&gt;</comment>
                            <comment id="13448311" author="hudson" created="Wed, 5 Sep 2012 00:57:15 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security-on-Hadoop-23 #7 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/7/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/7/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6364&quot; title=&quot;Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6364&quot;&gt;&lt;del&gt;HBASE-6364&lt;/del&gt;&lt;/a&gt; Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table - security addendum (Revision 1376136)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6364&quot; title=&quot;Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6364&quot;&gt;&lt;del&gt;HBASE-6364&lt;/del&gt;&lt;/a&gt; Powering down the server host holding the .META. table causes HBase Client to take excessively long to recover and connect to reassigned .META. table (Revision 1376013)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
nkeywal : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/security/src/main/java/org/apache/hadoop/hbase/ipc/SecureClient.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;nkeywal : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/ipc/HBaseClient.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/util/EnvironmentEdgeManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/util/ManualEnvironmentEdge.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13624645" author="stack" created="Sun, 7 Apr 2013 04:38:04 +0000"  >&lt;p&gt;Fix up after bulk move overwrote some 0.94.2 fix versions w/ 0.95.0 (Noticed by Lars Hofhansl)&lt;/p&gt;</comment>
                            <comment id="13670062" author="stack" created="Thu, 30 May 2013 05:01:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkeywal&quot; class=&quot;user-hover&quot; rel=&quot;nkeywal&quot;&gt;Nicolas Liochon&lt;/a&gt; What is supposed to happen when the FailedServerException is thrown?&lt;/p&gt;

&lt;p&gt;The below is hard to read &amp;#8211; it is out of our loadtesttool used alot in hbase-it.&lt;/p&gt;

&lt;p&gt;A loadtesttool thread is failing with a FailedServerException...  &quot;This server is in the failed servers list&apos;.  Reading the above, I thought we were supposed to pause and retry but if you notice, we are doing connection setup using withoutRetries... because we are inside a Process.&lt;/p&gt;

&lt;p&gt;Any input would help.  Sorry for being short.  Have to run (I&apos;m trying to figure failing hbase-it tests up on ec2 and on internal jenkins).  Thanks.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-05-27 17:08:53,193 ERROR [HBaseWriterThread_3] util.MultiThreadedWriter(191): Failed to insert: 48349; region information: cached: region=IntegrationTestDataIngestWithChaosMonkey,8cccccc4,1369699538187.6b2be2c004e633f8eed7de8aff6f7cfd., hostname=a1007.halxg.cloudera.com,53752,1369699532487, seqNum=214684; cache is up to date; errors: Error from [a1007.halxg.cloudera.com:53752] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [979402d0d20fb0f8ded281a8b8687ab9-48349]java.io.IOException: Call to a1007.halxg.cloudera.com/10.20.184.107:53752 failed on local exception: org.apache.hadoop.hbase.ipc.RpcClient$FailedServerException: This server is in the failed servers list: a1007.halxg.cloudera.com/10.20.184.107:53752
	at org.apache.hadoop.hbase.ipc.RpcClient.wrapException(RpcClient.java:1368)er$HConnectionImplementation$&lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt;$1.call(HConnectionManager.java:2463)
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:662)
Caused by: org.apache.hadoop.hbase.ipc.RpcClient$FailedServerException: This server is in the failed servers list: a1007.halxg.cloudera.com/10.20.184.107:53752
	at org.apache.hadoop.hbase.ipc.RpcClient$Connection.setupIOstreams(RpcClient.java:798)
	at org.apache.hadoop.hbase.ipc.RpcClient.getConnection(RpcClient.java:1422)
	at org.apache.hadoop.hbase.ipc.RpcClient.call(RpcClient.java:1314)
	... 15 more

2013-05-27 17:08:53,193 ERROR [HBaseWriterThread_0] util.MultiThreadedWriter(191): Failed to insert: 48366; region information: cached: region=IntegrationTestDataIngestWithChaosMonkey,8cccccc4,1369699538187.6b2be2c004e633f8eed7de8aff6f7cfd., hostname=a1007.halxg.cloudera.com,53752,1369699532487, seqNum=214684; cache is up to date; errors: Error from [a1007.halxg.cloudera.com:53752] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [92873a55c54f98db38508ba065852cc5-48366]java.io.IOException: Call to a1007.halxg.cloudera.com/10.20.184.107:53752 failed on local exception: org.apache.hadoop.hbase.ipc.RpcClient$FailedServerException: This server is in the failed servers list: a1007.halxg.cloudera.com/10.20.184.107:53752
	at org.apache.hadoop.hbase.ipc.RpcClient.wrapException(RpcClient.java:1368)
	at org.apache.hadoop.hbase.ipc.RpcClient.call(RpcClient.java:1340)
	at org.apache.hadoop.hbase.ipc.RpcClient.callBlockingMethod(RpcClient.java:1540)
	at org.apache.hadoop.hbase.ipc.RpcClient$BlockingRpcChannelImplementation.callBlockingMethod(RpcClient.java:1597)
	at org.apache.hadoop.hbase.protobuf.generated.ClientProtos$ClientService$BlockingStub.multi(ClientProtos.java:21403)
	at org.apache.hadoop.hbase.client.MultiServerCallable.call(MultiServerCallable.java:102)
	at org.apache.hadoop.hbase.client.MultiServerCallable.call(MultiServerCallable.java:43)
	at org.apache.hadoop.hbase.client.ServerCallable.withoutRetries(ServerCallable.java:250)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation$7.call(HConnectionManager.java:1993)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation$7.call(HConnectionManager.java:1988)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation$&lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt;$1.call(HConnectionManager.java:2473)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation$&lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt;$1.call(HConnectionManager.java:2463)
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:662)
Caused by: org.apache.hadoop.hbase.ipc.RpcClient$FailedServerException: This server is in the failed servers list: a1007.halxg.cloudera.com/10.20.184.107:53752
	at org.apache.hadoop.hbase.ipc.RpcClient$Connection.setupIOstreams(RpcClient.java:798)
	at org.apache.hadoop.hbase.ipc.RpcClient.getConnection(RpcClient.java:1422)
	at org.apache.hadoop.hbase.ipc.RpcClient.call(RpcClient.java:1314)
	... 15 more


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13670176" author="stack" created="Thu, 30 May 2013 09:33:42 +0000"  >&lt;p&gt;@nkeywal nevermind.  The issue I am seeing is not particular to this issue.  Please ignore.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12551766">HBASE-5843</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12539225" name="6364-host-serving-META.v1.patch" size="2263" author="zhihyu@ebaysf.com" created="Sun, 5 Aug 2012 22:27:09 +0000"/>
                            <attachment id="12541893" name="6364.94.v2.nolargetest.patch" size="13792" author="nkeywal" created="Wed, 22 Aug 2012 12:35:00 +0000"/>
                            <attachment id="12541992" name="6364.94.v2.nolargetest.security-addendum.patch" size="2218" author="nkeywal" created="Wed, 22 Aug 2012 16:26:36 +0000"/>
                            <attachment id="12539214" name="6364.v1.patch" size="2263" author="nkeywal" created="Sun, 5 Aug 2012 18:13:33 +0000"/>
                            <attachment id="12539211" name="6364.v1.patch" size="2263" author="nkeywal" created="Sun, 5 Aug 2012 16:53:51 +0000"/>
                            <attachment id="12541737" name="6364.v11.nolargetest.patch" size="34216" author="nkeywal" created="Tue, 21 Aug 2012 10:46:11 +0000"/>
                            <attachment id="12539258" name="6364.v2.patch" size="2867" author="nkeywal" created="Mon, 6 Aug 2012 09:53:35 +0000"/>
                            <attachment id="12539304" name="6364.v3.patch" size="2942" author="nkeywal" created="Mon, 6 Aug 2012 13:31:00 +0000"/>
                            <attachment id="12539272" name="6364.v3.patch" size="2942" author="nkeywal" created="Mon, 6 Aug 2012 10:53:32 +0000"/>
                            <attachment id="12539878" name="6364.v5.patch" size="7551" author="nkeywal" created="Wed, 8 Aug 2012 15:42:00 +0000"/>
                            <attachment id="12539880" name="6364.v5.withtests.patch" size="27092" author="nkeywal" created="Wed, 8 Aug 2012 15:44:08 +0000"/>
                            <attachment id="12540017" name="6364.v6.patch" size="12000" author="nkeywal" created="Thu, 9 Aug 2012 12:37:10 +0000"/>
                            <attachment id="12540016" name="6364.v6.withtests.patch" size="33693" author="nkeywal" created="Thu, 9 Aug 2012 12:33:29 +0000"/>
                            <attachment id="12540474" name="6364.v7.withtests.patch" size="39688" author="nkeywal" created="Fri, 10 Aug 2012 11:48:18 +0000"/>
                            <attachment id="12540475" name="6364.v8.withtests.patch" size="39765" author="nkeywal" created="Fri, 10 Aug 2012 11:56:40 +0000"/>
                            <attachment id="12541031" name="6364.v9.patch" size="17745" author="nkeywal" created="Wed, 15 Aug 2012 10:22:08 +0000"/>
                            <attachment id="12538231" name="stacktrace.txt" size="16234" author="svarma" created="Sat, 28 Jul 2012 06:56:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 19 Jul 2012 16:07:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245332</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i067vb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34206</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The client (ipc.HBaseClient) now keeps a list of the failed connection attempts. It does not retry to connect before 2 seconds after a failure. This can be configured by setting &amp;quot;hbase.ipc.client.failed.servers.expiry&amp;quot;: number of milliseconds before retrying the same server. Note that some clients retry multiple times to allow transient errors. If this parameter is set to a large value, these clients will fail without the server being actually retried.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>client, connection, timeout</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>