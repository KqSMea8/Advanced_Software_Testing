<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:53:38 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-14491/HBASE-14491.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-14491] ReplicationSource#countDistinctRowKeys code logic is not correct</title>
                <link>https://issues.apache.org/jira/browse/HBASE-14491</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      Cell lastCell = cells.get(0);
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; edit.size(); i++) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!CellUtil.matchingRow(cells.get(i), lastCell)) {
          distinctRowKeys++;
        }
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The above logic for finding the distinct row keys in the list needs to be corrected.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12896353">HBASE-14491</key>
            <summary>ReplicationSource#countDistinctRowKeys code logic is not correct</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ashish singhi">Ashish Singhi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Sep 2015 08:53:13 +0000</created>
                <updated>Thu, 17 Dec 2015 21:59:24 +0000</updated>
                            <resolved>Thu, 17 Dec 2015 21:59:24 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="14907874" author="chenheng" created="Fri, 25 Sep 2015 09:53:16 +0000"  >&lt;p&gt;{{lastCell = cells.get(I) }} should be append after distinctRowKeys++ ?&lt;/p&gt;</comment>
                            <comment id="14907887" author="ashish singhi" created="Fri, 25 Sep 2015 10:10:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;{{lastCell = cells.get(I) }} should be append after distinctRowKeys++ ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, that is still wrong. &lt;br/&gt;
It will fail in this case (1,2,1,2,5), it will output the count as 5.&lt;/p&gt;

&lt;p&gt;I think we should do something like this,&lt;br/&gt;
1) Create a temp list&lt;br/&gt;
2) Iterate over the original list and retrieve the element&lt;br/&gt;
3) If the temp list does not contain the element, add element to it and finally return the size of this list.&lt;/p&gt;</comment>
                            <comment id="14908059" author="chenheng" created="Fri, 25 Sep 2015 14:03:45 +0000"  >&lt;p&gt;Sorry, I has thought array was sorted&lt;/p&gt;</comment>
                            <comment id="14955419" author="enis" created="Tue, 13 Oct 2015 18:28:29 +0000"  >&lt;p&gt;The patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14501&quot; title=&quot;NPE in replication when HDFS transparent encryption is enabled.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14501&quot;&gt;&lt;del&gt;HBASE-14501&lt;/del&gt;&lt;/a&gt; contains the change: &lt;tt&gt;lastCell = cells.get&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/tt&gt;. Sorry, I did not see this issue before. &lt;/p&gt;

&lt;p&gt;As for sorting, if cells within WAL edits are not sorted, we should NOT sort them or allocate a new set to do the counting. distinctRowKeys is only used for the metric replicatedOperations and it will be expensive to allocate new objects just for this metric. &lt;/p&gt;</comment>
                            <comment id="14955439" author="apurtell" created="Tue, 13 Oct 2015 18:38:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;As for sorting, if cells within WAL edits are not sorted, we should NOT sort them or allocate a new set to do the counting. distinctRowKeys is only used for the metric replicatedOperations and it will be expensive to allocate new objects just for this metric.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, I&apos;d prefer we drop the metric.&lt;/p&gt;</comment>
                            <comment id="14955440" author="enis" created="Tue, 13 Oct 2015 18:39:38 +0000"  >&lt;p&gt;In HRegion.doMiniBatchMutation(), we are preparing the WALEdits, by appending cells to the WALEdits one by by caling &lt;tt&gt;WALEdit.add(Cell)&lt;/tt&gt;. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], List&amp;lt;Cell&amp;gt;&amp;gt;[] familyMaps = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Map[batchOp.operations.length];
...
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], List&amp;lt;Cell&amp;gt;&amp;gt; familyMap = mutation.getFamilyCellMap();
...
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void addFamilyMapToWALEdit(Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], List&amp;lt;Cell&amp;gt;&amp;gt; familyMap,
      WALEdit walEdit) {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (List&amp;lt;Cell&amp;gt; edits : familyMap.values()) {
      &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; edits &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RandomAccess;
      &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; listSize = edits.size();
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i &amp;lt; listSize; i++) {
        Cell cell = edits.get(i);
        walEdit.add(cell);
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My understanding is that the cells within a WALEdit will be grouped by Mutation which is a single row. There can be multiple mutations in the same WALEdit sharing the same row key, but they are still distinct mutations that has to be counted separately. I would say we should resolve this jira now. &lt;/p&gt;</comment>
                            <comment id="14956151" author="ashish singhi" created="Wed, 14 Oct 2015 02:24:26 +0000"  >&lt;p&gt;Thanks for the explanation, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;WALEdit sharing the same row key, but they are still distinct mutations that has to be counted separately&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I feel the better method name should have been countDistinctMutations than countDistinctRowKeys.&lt;br/&gt;
Anyways I will close this.&lt;/p&gt;</comment>
                            <comment id="14956152" author="ashish singhi" created="Wed, 14 Oct 2015 02:26:08 +0000"  >&lt;p&gt;Fixed by Enis as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14501&quot; title=&quot;NPE in replication when HDFS transparent encryption is enabled.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14501&quot;&gt;&lt;del&gt;HBASE-14501&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15062924" author="busbey" created="Thu, 17 Dec 2015 21:59:24 +0000"  >&lt;p&gt;since this was effectively subsumed by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14501&quot; title=&quot;NPE in replication when HDFS transparent encryption is enabled.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-14501&quot;&gt;&lt;del&gt;HBASE-14501&lt;/del&gt;&lt;/a&gt;, marking it dup and removing fix versions.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12901096">HBASE-14501</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 25 Sep 2015 09:53:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2lk1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>