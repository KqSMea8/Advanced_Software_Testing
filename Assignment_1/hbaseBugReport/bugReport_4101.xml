<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:15:55 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4101/HBASE-4101.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4101] Regionserver Deadlock</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4101</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We periodically see a situation where the regionserver process exists in the process list, zookeeper thread sends the keepalive so the master won&apos;t remove it from the active list, yet the regionserver will not serve data.&lt;/p&gt;

&lt;p&gt;Hadoop(cdh3u0), HBase 0.90.3 (Apache version), under load from an internal testing tool.&lt;/p&gt;


&lt;p&gt;Attached is the full JStack&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 5.5, CDH3 u0 Hadoop, HBase 0.90.3&lt;/p&gt;</environment>
        <key id="12514128">HBASE-4101</key>
            <summary>Regionserver Deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ram_krish">ramkrishna.s.vasudevan</assignee>
                                    <reporter username="mattdavies">Matt Davies</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Jul 2011 21:53:27 +0000</created>
                <updated>Fri, 20 Nov 2015 11:55:08 +0000</updated>
                            <resolved>Wed, 20 Jul 2011 10:16:27 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.92.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13065575" author="stack" created="Thu, 14 Jul 2011 22:27:15 +0000"  >&lt;p&gt;From up on list:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
We aren&apos;t profiling right now.  Here&apos;s what is in the hbase-env.sh

export TZ=&lt;span class=&quot;code-quote&quot;&gt;&quot;US/Mountain&quot;&lt;/span&gt;
export HBASE_OPTS=&quot;$HBASE_OPTS -XX:+UseConcMarkSweepGC
-XX:+CMSIncrementalMode -verbose:gc -XX:+PrintGCDetails
-XX:+PrintGCTimeStamps -Xloggc:/home/hadoop/gc-hbase.log &quot;
export HBASE_MANAGES_ZK=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
export HBASE_PID_DIR=/home/hadoop
export HBASE_HEAPSIZE=10240

Java is
java version &lt;span class=&quot;code-quote&quot;&gt;&quot;1.6.0_17&quot;&lt;/span&gt;
Java(TM) SE &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Environment (build 1.6.0_17-b04)
Java HotSpot(TM) 64-Bit Server VM (build 14.3-b01, mixed mode)

We were planning an upgrade to 1.6.0_25 before we ran into &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; issue.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13065746" author="ram_krish" created="Fri, 15 Jul 2011 07:12:16 +0000"  >&lt;p&gt;The problem here is due to the usage of Date class in the PriorityCompactionQueue.&lt;br/&gt;
The ResourceBundle is trying to get hold of the current thread. &lt;/p&gt;

&lt;p&gt;Pls find JD&apos;s comment &lt;br/&gt;
&quot;&lt;br/&gt;
I see what you are saying, and I understand the deadlock, but what escapes&lt;br/&gt;
 me is why ResourceBundle has to go touch all the classes every time to&lt;br/&gt;
find&lt;br/&gt;
 the locale as I see 2 threads doing the same. Maybe my understanding of&lt;br/&gt;
what&lt;br/&gt;
 it does is just poor, but I also see that you are using the yourkit&lt;br/&gt;
profiler&lt;br/&gt;
 so it&apos;s one more variable in the equation.&lt;/p&gt;

&lt;p&gt; In any case, using a Date strikes me as odd. Using a long representing&lt;br/&gt;
 System.currentTimeMillis is usually what we do.&quot;&lt;/p&gt;</comment>
                            <comment id="13065854" author="ram_krish" created="Fri, 15 Jul 2011 11:10:00 +0000"  >&lt;p&gt;Is it fine if we change the Date object in the PriorityCompactionQueue.CompactionRequest class to Long.&lt;br/&gt;
and get the System.nanoTime and use this value for comparison?&lt;br/&gt;
Can i submit a patch with this change.&lt;/p&gt;</comment>
                            <comment id="13065855" author="ram_krish" created="Fri, 15 Jul 2011 11:11:08 +0000"  >&lt;p&gt;This issue is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3830&quot; title=&quot;MemStoreFlusher deadlock detected by JVM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3830&quot;&gt;&lt;del&gt;HBASE-3830&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13065868" author="ram_krish" created="Fri, 15 Jul 2011 11:35:39 +0000"  >&lt;p&gt;Before submiting the patch I would like to tell my analysis why the date object is the problem.&lt;/p&gt;


&lt;p&gt;Memstoreflusher.flushOneForGlobalPressure() and MemstoreFlusher.reclaimMemStoreMemory() are the &lt;br/&gt;
two api where the problem occurs.&lt;/p&gt;

&lt;p&gt;As part of flushOneForGlobalPressure() flushRegions() gets called. Here &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;lock.lock();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is obtained.&lt;br/&gt;
Then the flow goes into server.compactSplitThread.requestCompaction().&lt;br/&gt;
Here the region is added into CompactionQueue. &lt;br/&gt;
In the PriorityCompactionQueue.addToRegionsInQueue() api we try to log the newRequest.&lt;br/&gt;
This internally invokes the toString of the date object as in the log&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public String toString() {
      return &quot;regionName=&quot; + r.getRegionNameAsString() +
        &quot;, priority=&quot; + p + &quot;, date=&quot; + date;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Internally the date object uses ResourceBundle where in the endLoading() api&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	Thread me = Thread.currentThread();
	assert (underConstruction.get(constKey) == me);
	underConstruction.remove(constKey);
	synchronized (me) {
	    me.notifyAll();
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;tries to get the current thread.(Here the MemStoreFlusher).&lt;br/&gt;
Now parallely the MemStoreFlusher.reclaimMemStoreMemory() is getting called which itself is synchronized.&lt;br/&gt;
So the other thread has obtained the MemStoreFlusher lock and waits to obtain the &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    if (isAboveHighWaterMark()) {
      lock.lock();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Whereas The ResourceBundle waits to get the MemStoreFlusher Lock.  So this is leading to a deadlock condition.&lt;/p&gt;</comment>
                            <comment id="13067596" author="yuzhihong@gmail.com" created="Tue, 19 Jul 2011 09:42:55 +0000"  >&lt;p&gt;Java is strong-typed language:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; timeInLong;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Calling the field time would suffice.&lt;/p&gt;

&lt;p&gt;Other than the above, +1 on patch.&lt;/p&gt;</comment>
                            <comment id="13067756" author="stack" created="Tue, 19 Jul 2011 14:48:47 +0000"  >&lt;p&gt;Patch looks great (as does your analysis above Ram).&lt;/p&gt;</comment>
                            <comment id="13067760" author="stack" created="Tue, 19 Jul 2011 14:53:10 +0000"  >&lt;p&gt;Committed branch and trunk.  Thank you for the patch Ram.&lt;/p&gt;</comment>
                            <comment id="13067793" author="mattdavies" created="Tue, 19 Jul 2011 15:42:57 +0000"  >&lt;p&gt;Many thanks!&lt;br/&gt;
the process list, zookeeper thread sends the keepalive so the master won&apos;t&lt;br/&gt;
remove it from the active list, yet the regionserver will not serve data.&lt;br/&gt;
testing tool.&lt;/p&gt;</comment>
                            <comment id="13067850" author="yuzhihong@gmail.com" created="Tue, 19 Jul 2011 17:13:36 +0000"  >&lt;p&gt;TestScannerTimeout hangs in 0.90 build&lt;/p&gt;</comment>
                            <comment id="13067900" author="hudson" created="Tue, 19 Jul 2011 19:24:33 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2041 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2041/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2041/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4101&quot; title=&quot;Regionserver Deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4101&quot;&gt;&lt;del&gt;HBASE-4101&lt;/del&gt;&lt;/a&gt; Regionserver Deadlock&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/CompactionRequest.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13068197" author="ram_krish" created="Wed, 20 Jul 2011 07:36:21 +0000"  >&lt;p&gt;@Ted, I tried running the TestScannerTimeOut.java locally.&lt;br/&gt;
With or without patch the test is running fine.  Some problems comes attimes in the tear down (but all assertions are passing).&lt;/p&gt;

&lt;p&gt;Also the change is pertaining to the proritycompactionqueue but the test case as far I saw it is dealing with scanning.&lt;br/&gt;
Do you find any other problem for the failure of testcase ?&lt;/p&gt;</comment>
                            <comment id="13068259" author="yuzhihong@gmail.com" created="Wed, 20 Jul 2011 10:16:27 +0000"  >&lt;p&gt;Current failed test should be caused by other change.&lt;/p&gt;</comment>
                            <comment id="13183849" author="ram_krish" created="Wed, 11 Jan 2012 04:00:20 +0000"  >&lt;p&gt;This change  has not been committed to branch. But the issue fixed version says it is present in 0.90.&lt;br/&gt;
I will update this JIRA and create a new JIRA for fixing in 0.90.&lt;/p&gt;</comment>
                            <comment id="13183857" author="ram_krish" created="Wed, 11 Jan 2012 04:40:15 +0000"  >&lt;p&gt;I find that in 0.90 the CHANGES.txt alone is updated.  Should we remove that when we commit &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5178&quot; title=&quot;Backport HBASE-4101 - Regionserver Deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5178&quot;&gt;&lt;del&gt;HBASE-5178&lt;/del&gt;&lt;/a&gt; (backport JIRA for this issue).?&lt;/p&gt;</comment>
                            <comment id="13183866" author="stack" created="Wed, 11 Jan 2012 05:19:43 +0000"  >&lt;p&gt;@Ram Yes.&lt;/p&gt;</comment>
                            <comment id="15016406" author="lars_francke" created="Fri, 20 Nov 2015 11:55:08 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12486599" name="HBASE-4101_0.90.patch" size="1621" author="ram_krish" created="Fri, 15 Jul 2011 13:17:41 +0000"/>
                            <attachment id="12486990" name="HBASE-4101_0.90_1.patch" size="1626" author="ram_krish" created="Tue, 19 Jul 2011 11:30:11 +0000"/>
                            <attachment id="12486600" name="HBASE-4101_trunk.patch" size="1390" author="ram_krish" created="Fri, 15 Jul 2011 13:18:02 +0000"/>
                            <attachment id="12486991" name="HBASE-4101_trunk_1.patch" size="1395" author="ram_krish" created="Tue, 19 Jul 2011 11:30:22 +0000"/>
                            <attachment id="12486516" name="jstack.txt" size="134827" author="mattdavies" created="Thu, 14 Jul 2011 21:54:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 14 Jul 2011 22:27:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27171</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hpdr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101374</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>