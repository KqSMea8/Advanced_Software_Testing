<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:23:17 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-17300/HBASE-17300.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-17300] Concurrently calling checkAndPut with expected value as null returns true unexpectedly</title>
                <link>https://issues.apache.org/jira/browse/HBASE-17300</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Attached is the test case. I have added some comments so hopefully the test makes sense. It actually is causing test failures on the Phoenix branches.&lt;/p&gt;

&lt;p&gt;The test fails consistently using HBase-0.98.23. It exhibits flappy behavior with the 1.2 branch (failed twice in 5 tries). &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testNullCheckAndPut() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (HBaseAdmin admin = TEST_UTIL.getHBaseAdmin()) {
                Callable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;&amp;gt; c1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CheckAndPutCallable();
                Callable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;&amp;gt; c2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CheckAndPutCallable();
                ExecutorService e = Executors.newFixedThreadPool(5);
                Future&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;&amp;gt; f1 = e.submit(c1);
                Future&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;&amp;gt; f2 = e.submit(c2);
                assertTrue(f1.get() || f2.get());
                assertFalse(f1.get() &amp;amp;&amp;amp; f2.get());
            }    
        }
    }
    
    
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; class CheckAndPutCallable &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Callable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;&amp;gt; {
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; call() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rowToLock = &lt;span class=&quot;code-quote&quot;&gt;&quot;ROW&quot;&lt;/span&gt;.getBytes();
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] colFamily = &lt;span class=&quot;code-quote&quot;&gt;&quot;COLUMN_FAMILY&quot;&lt;/span&gt;.getBytes();
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] column = &lt;span class=&quot;code-quote&quot;&gt;&quot;COLUMN&quot;&lt;/span&gt;.getBytes();
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] newValue = &lt;span class=&quot;code-quote&quot;&gt;&quot;NEW_VALUE&quot;&lt;/span&gt;.getBytes();
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] oldValue = &lt;span class=&quot;code-quote&quot;&gt;&quot;OLD_VALUE&quot;&lt;/span&gt;.getBytes();
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] tableName = &lt;span class=&quot;code-quote&quot;&gt;&quot;table&quot;&lt;/span&gt;.getBytes();
            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; acquired = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (HBaseAdmin admin = TEST_UTIL.getHBaseAdmin()) {
                    HTableDescriptor tableDesc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTableDescriptor(TableName.valueOf(tableName));
                    HColumnDescriptor columnDesc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HColumnDescriptor(colFamily);
                    columnDesc.setTimeToLive(600);
                    tableDesc.addFamily(columnDesc);
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        admin.createTable(tableDesc);
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TableExistsException e) {
                        &lt;span class=&quot;code-comment&quot;&gt;// ignore
&lt;/span&gt;                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (HTableInterface table = admin.getConnection().getTable(tableName)) {
                        Put put = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Put(rowToLock);
                        put.add(colFamily, column, oldValue); &lt;span class=&quot;code-comment&quot;&gt;// add a row with column set to oldValue
&lt;/span&gt;                        table.put(put);
                        put = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Put(rowToLock);
                        put.add(colFamily, column, newValue);
                        &lt;span class=&quot;code-comment&quot;&gt;// only one of the threads should be able to get &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value of &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the expected value of oldValue
&lt;/span&gt;                        acquired = table.checkAndPut(rowToLock, colFamily, column, oldValue, put); 
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!acquired) {
                           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a thread didn&apos;t get &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; before, then it shouldn&apos;t get &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; time either
&lt;/span&gt;                           &lt;span class=&quot;code-comment&quot;&gt;// because the column DOES exist
&lt;/span&gt;                           acquired = table.checkAndPut(rowToLock, colFamily, column, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, put);
                        }
                    }
                }
            }  
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; acquired;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jamestaylor&quot; class=&quot;user-hover&quot; rel=&quot;jamestaylor&quot;&gt;James Taylor&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13027653">HBASE-17300</key>
            <summary>Concurrently calling checkAndPut with expected value as null returns true unexpectedly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="samarthjain">Samarth Jain</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Dec 2016 02:11:21 +0000</created>
                <updated>Tue, 13 Dec 2016 22:28:48 +0000</updated>
                            <resolved>Tue, 13 Dec 2016 21:11:20 +0000</resolved>
                                    <version>0.98.23</version>
                    <version>1.2.4</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15743886" author="apurtell" created="Tue, 13 Dec 2016 02:24:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;I am using a bit of Phoenix API to get hold of HBaseAdmin. But it should be fairly straightforward to adopt it for HBase IT tests. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You&apos;re more likely to get engagement from the HBase community if the repro case just works with the HBase API. FWIW&lt;/p&gt;</comment>
                            <comment id="15744018" author="apurtell" created="Tue, 13 Dec 2016 03:28:08 +0000"  >&lt;p&gt;Set affected versions as reported. Let me see as part of 0.98.24 work if a port of this to HBase API only will repro the issue. If so, if an earlier version worked correctly (0.98.17 perhaps?). If so, what commit broke things.&lt;/p&gt;</comment>
                            <comment id="15744438" author="samarthjain" created="Tue, 13 Dec 2016 07:29:26 +0000"  >&lt;p&gt;Thanks! Updated the patch to use TEST_UTIL.getHBaseAdmin(). Hopefully this will make it easy to add it in an IT test.&lt;/p&gt;</comment>
                            <comment id="15744453" author="samarthjain" created="Tue, 13 Dec 2016 07:37:56 +0000"  >&lt;p&gt;I changed code in Phoenix land to pass null for existing value which is when I found this bug.&lt;/p&gt;

&lt;p&gt;The test fails with 0.98.17 too. I went back up to 0.98.15 and the test is failing there too. So looks like this issue has been around for a while.&lt;/p&gt;
</comment>
                            <comment id="15746180" author="apurtell" created="Tue, 13 Dec 2016 20:28:53 +0000"  >&lt;p&gt;Refactored test for master. I move the table creation out of the callables because we should be testing for concurrent checkAndPut failure not if operations are racing with table creation. Check your code otherwise &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samarthjain&quot; class=&quot;user-hover&quot; rel=&quot;samarthjain&quot;&gt;Samarth Jain&lt;/a&gt; . Test passes on master. Will come back to this soon to see if it flaps on master, and will port back to branch-1 and 0.98 to check those too. &lt;/p&gt;</comment>
                            <comment id="15746258" author="samarthjain" created="Tue, 13 Dec 2016 21:01:43 +0000"  >&lt;p&gt;Thanks for taking a look, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;. You are right the test passes consistently if I remove the table creation code from the Callable. So it does look like there is a race between table creation and and other operations on it. I can try and see if I can adjust the Phoenix upgrade code to not do the table creation. But it does sound like there is some bug lurking here since table creation is a sync operation?&lt;/p&gt;</comment>
                            <comment id="15746284" author="apurtell" created="Tue, 13 Dec 2016 21:11:14 +0000"  >&lt;p&gt;Table creation is not a synchronous operation. The client submits the admin action. The master asynchronously executes it. The client will check status via the meta table and spin and return when it sees that the table exists. When you have two threads concurrently submitting create requests, ignoring TableExistsException, and then issuing an op, this is fraught for races. I&apos;d change the code to lift the admin action out. I&apos;m going to resolve this issue as cannot reproduce. If you continue to have trouble with racy behavior with respect to table creation we can follow up on another issue targeted to that. &lt;/p&gt;</comment>
                            <comment id="15746291" author="samarthjain" created="Tue, 13 Dec 2016 21:14:09 +0000"  >&lt;p&gt;Hmm. Sounds like the documentation needs to be updated?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
   * Creates a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; table.
   * Synchronous operation.
   *
   * @param desc table descriptor &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; table
   *
   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IllegalArgumentException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the table name is reserved
   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MasterNotRunningException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; master is not running
   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; TableExistsException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; table already exists (If concurrent
   * threads, the table may have been created between test-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-existence
   * and attempt-at-creation).
   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a remote or network exception occurs
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void createTable(HTableDescriptor desc)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15746476" author="apurtell" created="Tue, 13 Dec 2016 22:28:48 +0000"  >&lt;p&gt;The client makes it appear its synchronous so this is not incorrect. I&apos;m just letting you know on the master it is not. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12843080" name="HBASE-17300.patch" size="3727" author="apurtell" created="Tue, 13 Dec 2016 20:28:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Dec 2016 02:24:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37ilb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>