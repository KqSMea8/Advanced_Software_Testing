<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:34:12 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6147/HBASE-6147.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6147] SSH and AM.joinCluster leads to region assignment inconsistency in many cases.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6147</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We are facing few issues in the master restart and SSH going in parallel.&lt;br/&gt;
Chunhui also suggested that we need to rework on this part.  This JIRA is aimed at solving all such possibilities of region assignment inconsistency&lt;/p&gt;</description>
                <environment></environment>
        <key id="12558950">HBASE-6147</key>
            <summary>SSH and AM.joinCluster leads to region assignment inconsistency in many cases.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="4">Incomplete</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ram_krish">ramkrishna.s.vasudevan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Jun 2012 13:11:51 +0000</created>
                <updated>Wed, 22 Apr 2015 00:48:18 +0000</updated>
                            <resolved>Wed, 22 Apr 2015 00:48:18 +0000</resolved>
                                    <version>0.92.1</version>
                    <version>0.94.0</version>
                                    <fixVersion>0.92.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13287410" author="ram_krish" created="Fri, 1 Jun 2012 13:55:27 +0000"  >&lt;p&gt;We got the following case&lt;br/&gt;
-&amp;gt; Initially we had 2 RS and 1 Master with few regions&lt;br/&gt;
-&amp;gt; Stopped the cluster and restarted the master and 2 RS.&lt;br/&gt;
-&amp;gt; One of the RS znode was not yet deleted but the master started coming up.&lt;br/&gt;
-&amp;gt; Here we will now see that there is a server which dead and not yet expired so we wil call expireServer which inturn calls SSH.&lt;br/&gt;
-&amp;gt; After this the master sees this as a clean cluster startup.&lt;br/&gt;
-&amp;gt; Now SSH triggers one assignment and master startup starts bulk assignment.&lt;br/&gt;
-&amp;gt; Now when the znode is present already the Bulk assignment will make the master go down.&lt;br/&gt;
So we need to handle such cases.  Solving this should help us to solve most of the double assignment cases.  There can be more such scenarios.&lt;/p&gt;</comment>
                            <comment id="13288326" author="zjushch" created="Mon, 4 Jun 2012 03:10:38 +0000"  >&lt;p&gt;@ram&lt;br/&gt;
We has already found and fix many case for SSH and AM.joinCluster, however it seems exist many other cases all the same.&lt;/p&gt;

&lt;p&gt;I first give a suggestion just mentioned in another issue:&lt;/p&gt;

&lt;p&gt;Don&apos;t assign user regions in SSH until master is initialized, just like doing the following&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
process(){
...

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isCarryingRoot() || isCarryingMeta()){...}

...

    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; waitedTimeForMasterInitialized = 0;
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!server.isStopped() &amp;amp;&amp;amp; !services.isInitialized()) {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (waitedTimeForMasterInitialized == 0) {
          LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Master is not initialized, waiting...&quot;&lt;/span&gt;);
        }
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100);
        waitedTimeForMasterInitialized += 100;
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted&quot;&lt;/span&gt;, e);
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (waitedTimeForMasterInitialized &amp;gt; 0) {
      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Recovery time calculation: waiting on master to be initialized took &quot;&lt;/span&gt;
          + waitedTimeForMasterInitialized + &lt;span class=&quot;code-quote&quot;&gt;&quot;ms&quot;&lt;/span&gt;);
    }
...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In some cases, above code will increase recovery time, if we could fix many cases caused by SSH and AM.joinCluster, I think it is valuable.&lt;/p&gt;

&lt;p&gt;Correct me if wrong, thanks.&lt;/p&gt;</comment>
                            <comment id="13288343" author="ram_krish" created="Mon, 4 Jun 2012 04:51:53 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
Definitely your suggestion is also to be done.  All related changes w.r.t to this scenario can be addressed here. Good on you Chunhui.&lt;/p&gt;</comment>
                            <comment id="13288350" author="zjushch" created="Mon, 4 Jun 2012 05:16:53 +0000"  >&lt;p&gt;Making a patch as a beginning&lt;/p&gt;</comment>
                            <comment id="13289171" author="stack" created="Tue, 5 Jun 2012 05:42:06 +0000"  >&lt;p&gt;Haven&apos;t looked at patch yet but this seems like good direction lads.&lt;/p&gt;






</comment>
                            <comment id="13289450" author="ram_krish" created="Tue, 5 Jun 2012 14:23:22 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
Pls take a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6060&quot; title=&quot;Regions&amp;#39;s in OPENING state from failed regionservers takes a long time to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6060&quot;&gt;&lt;del&gt;HBASE-6060&lt;/del&gt;&lt;/a&gt;.  With this patch that you have given and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6060&quot; title=&quot;Regions&amp;#39;s in OPENING state from failed regionservers takes a long time to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6060&quot;&gt;&lt;del&gt;HBASE-6060&lt;/del&gt;&lt;/a&gt; the problem that i mentioned in&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5916?focusedCommentId=13283349&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13283349&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5916?focusedCommentId=13283349&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13283349&lt;/a&gt; &lt;br/&gt;
will not happen in 0.94.  But for trunk as it goes with bulk assign we need to check.  Good start anyway.&lt;/p&gt;</comment>
                            <comment id="13289455" author="zhihyu@ebaysf.com" created="Tue, 5 Jun 2012 14:34:37 +0000"  >&lt;p&gt;Nice start.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100);
+          waitedTimeForMasterInitialized += 100;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We don&apos;t know how long sleep() call may actually have taken. Better maintain timing ourselves.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
+          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted&quot;&lt;/span&gt;, e);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;InterruptedIOException should be created above.&lt;/p&gt;</comment>
                            <comment id="13291073" author="ram_krish" created="Thu, 7 Jun 2012 15:26:53 +0000"  >&lt;p&gt;This patch does not update the comments.  But just to show the changes that we need to make so that this problem is solved.  But for this to happen &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6060&quot; title=&quot;Regions&amp;#39;s in OPENING state from failed regionservers takes a long time to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6060&quot;&gt;&lt;del&gt;HBASE-6060&lt;/del&gt;&lt;/a&gt; should go in and for trunk HBASe-6012 should go in.  &lt;br/&gt;
How HBASe-6060 helps and how Chunhui&apos;s suggestion of waiting for master initialization helps is explained below&lt;br/&gt;
-&amp;gt; Now all the assignments that happen during which if any RS goes down things will be handled by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6060&quot; title=&quot;Regions&amp;#39;s in OPENING state from failed regionservers takes a long time to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6060&quot;&gt;&lt;del&gt;HBASE-6060&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
-&amp;gt; Taking the case of join cluster and SSH&lt;br/&gt;
Following scenarios to be considered&lt;br/&gt;
1&amp;gt; Clean cluster start up&lt;br/&gt;
2&amp;gt; Partially clean start up&lt;/p&gt;

&lt;p&gt;In the case of clean cluster start up, we do bulk assign.  Now while doing this if any RS goes down, as per Chunhui&apos;s suggestion we will wait for the master to initialize.&lt;br/&gt;
Now by this time the region plan would be populated considering the dead server by bulk assign.  So when the master completes initialization, the SSH will see that few regions are there in regionplan with the dead server and so the new logic introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6060&quot; title=&quot;Regions&amp;#39;s in OPENING state from failed regionservers takes a long time to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6060&quot;&gt;&lt;del&gt;HBASE-6060&lt;/del&gt;&lt;/a&gt; will go ahead with assignment.  no waiting needed.&lt;/p&gt;

&lt;p&gt;For the 2nd case, if by the time the ProcessRIT decides to process the node the server would be dead, so may be previously&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      addToRITandCallClose(regionInfo, RegionState.State.OFFLINE, rt);
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }

        regionsInTransition.put(encodedRegionName,
          getRegionState(regionInfo, RegionState.State.OPENING, rt));
        failoverProcessedRegions.put(encodedRegionName, regionInfo);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;we were just populating to OPENING in the RIT map.  But there would be no one to process this.  Now as per the latest patch we just add a region plan.&lt;br/&gt;
Now even if the server goes down and SSH tries to process he will see the regionplan(with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6060&quot; title=&quot;Regions&amp;#39;s in OPENING state from failed regionservers takes a long time to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6060&quot;&gt;&lt;del&gt;HBASE-6060&lt;/del&gt;&lt;/a&gt; and Chunhui&apos;s suggestion) and immediately trigger assignment. &lt;br/&gt;
We found that even for &apos;RS_ZK_REGION_OPENED&apos; this may be needed.  &lt;br/&gt;
We will also do a cluster testing.&lt;br/&gt;
Please review and provide your comments.  Hope with these changes we need not depend on timeout monitor.&lt;br/&gt;
@Chunhui&lt;br/&gt;
Please provide your thoughts on this.  It would be nice if you can also test these patches &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6147&quot; title=&quot;SSH and AM.joinCluster leads to region assignment inconsistency in many cases.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6147&quot;&gt;&lt;del&gt;HBASE-6147&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6060&quot; title=&quot;Regions&amp;#39;s in OPENING state from failed regionservers takes a long time to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6060&quot;&gt;&lt;del&gt;HBASE-6060&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6012&quot; title=&quot;Handling RegionOpeningState for bulk assign&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6012&quot;&gt;&lt;del&gt;HBASE-6012&lt;/del&gt;&lt;/a&gt; together.&lt;/p&gt;



</comment>
                            <comment id="13291139" author="zhihyu@ebaysf.com" created="Thu, 7 Jun 2012 17:18:35 +0000"  >&lt;p&gt;In testing phase, an option may be introduced to enable the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      waitTillMasterInitialized();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so that we can compare performance difference.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12530724" name="HBASE-6147.patch" size="1970" author="zjushch" created="Mon, 4 Jun 2012 05:16:53 +0000"/>
                            <attachment id="12531268" name="HBASE-6147_trunk.patch" size="5136" author="ram_krish" created="Thu, 7 Jun 2012 15:10:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 4 Jun 2012 03:10:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241791</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02d1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11714</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>