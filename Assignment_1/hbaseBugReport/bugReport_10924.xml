<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:18:29 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-10924/HBASE-10924.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-10924] [region_mover]: Adjust region_mover script to retry unloading a server a configurable number of times in case of region splits/merges</title>
                <link>https://issues.apache.org/jira/browse/HBASE-10924</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Observed behavior:&lt;br/&gt;
In about 5% of cases, my rolling upgrade tests fail because of stuck regions during a region server unload. My theory is that this occurs when region assignment information changes between the time the region list is generated, and the time when the region is to be moved.&lt;/p&gt;

&lt;p&gt;An example of such a region information change is a split or merge.&lt;/p&gt;

&lt;p&gt;Example:&lt;br/&gt;
Regionserver A has 100 regions (#0-#99). The balancer is turned off and the regionmover script is called to unload this regionserver. The regionmover script will generate the list of 100 regions to be moved and then proceed down that list, moving the regions off in series. However, there is a region, #84, that has split into two daughter regions while regions 0-83 were moved. The script will be stuck trying to move #84, timeout, and then the failure will bubble up (attempt 1 failed).&lt;/p&gt;

&lt;p&gt;Proposed solution:&lt;br/&gt;
This specific failure mode should be caught and the region_mover script should now attempt to move off all the regions. Now, it will have 16+1 (due to split) regions to move. There is a good chance that it will be able to move all 17 off without issues. However, should it encounter this same issue (attempt 2 failed), it will retry again. This process will continue until the maximum number of unload retry attempts has been reached.&lt;/p&gt;

&lt;p&gt;This is not foolproof, but let&apos;s say for the sake of argument that 5% of unload attempts hit this issue, then with a retry count of 3, it will reduce the unload failure probability from 0.05 to 0.000125 (0.05^3).&lt;/p&gt;

&lt;p&gt;Next steps:&lt;br/&gt;
I am looking for feedback on this approach. If it seems like a sensible approach, I will create a strawman patch and test it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12707001">HBASE-10924</key>
            <summary>[region_mover]: Adjust region_mover script to retry unloading a server a configurable number of times in case of region splits/merges</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="10002" iconUrl="https://issues.apache.org/jira/images/icons/statuses/document.png" description="A patch for this issue has been uploaded to JIRA by a contributor.">Patch Available</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="aleksshulman">Aleksandr Shulman</assignee>
                                    <reporter username="aleksshulman">Aleksandr Shulman</reporter>
                        <labels>
                            <label>region_mover</label>
                            <label>rolling_upgrade</label>
                    </labels>
                <created>Mon, 7 Apr 2014 18:25:39 +0000</created>
                <updated>Mon, 27 Oct 2014 17:07:27 +0000</updated>
                                            <version>0.94.15</version>
                                                    <component>Region Assignment</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13962104" author="jmspaggi" created="Mon, 7 Apr 2014 18:28:48 +0000"  >&lt;p&gt;Should we use this oportunity to move that into a java class instead of a rd script?&lt;/p&gt;</comment>
                            <comment id="13962112" author="aleksshulman" created="Mon, 7 Apr 2014 18:32:50 +0000"  >&lt;p&gt;That seems like a good place to put that logic since it&apos;ll be easier to maintain.&lt;br/&gt;
As a bonus, we&apos;ll have implicit compatibility checks at compile time &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Only concern is that we don&apos;t break the shell api, but that shouldn&apos;t be difficult to maintain.&lt;/p&gt;</comment>
                            <comment id="13968094" author="lhofhansl" created="Mon, 14 Apr 2014 05:40:21 +0000"  >&lt;p&gt;Approach sounds good. We should also have an option to just ignore the failed region and move on (i.e. a best effort option).&lt;/p&gt;</comment>
                            <comment id="13973360" author="aleksshulman" created="Thu, 17 Apr 2014 20:30:29 +0000"  >&lt;p&gt;Attaching v1 of the patch. For 94 only.&lt;/p&gt;</comment>
                            <comment id="13973701" author="aleksshulman" created="Fri, 18 Apr 2014 02:01:07 +0000"  >&lt;p&gt;Attaching a better version of the patch here.&lt;br/&gt;
It&apos;s relatively straightforward, but if there is interest in a formal review, I can put it up on RB.&lt;/p&gt;

&lt;p&gt;Testing: I ran this patch through an in-house rolling upgrade test framework. It performs MR jobs, splits, compactions, and DML while regions are moving.&lt;/p&gt;

&lt;p&gt;I also did some explicit testing by installing this on a cluster and moving regions back and forth while doing splits.&lt;/p&gt;

&lt;p&gt;The results were fine for all the testing.&lt;/p&gt;</comment>
                            <comment id="13974566" author="aleksshulman" created="Fri, 18 Apr 2014 22:18:28 +0000"  >&lt;p&gt;Adding v3 which includes a sleep and some comments as to the rationale of the fix.&lt;/p&gt;</comment>
                            <comment id="13974751" author="hadoopqa" created="Sat, 19 Apr 2014 06:25:15 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12640899/HBASE-10924-0.94-v3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12640899/HBASE-10924-0.94-v3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12640899&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/9341//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/9341//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13996134" author="lhofhansl" created="Tue, 13 May 2014 06:31:49 +0000"  >&lt;p&gt;Is this an 0.94 issue specifically?&lt;/p&gt;</comment>
                            <comment id="13996537" author="aleksshulman" created="Tue, 13 May 2014 16:09:02 +0000"  >&lt;p&gt;This issue affects all branches. I will upload patches for the other branches as well.&lt;/p&gt;</comment>
                            <comment id="14031477" author="lhofhansl" created="Sat, 14 Jun 2014 05:40:13 +0000"  >&lt;p&gt;I still think it might be better to let the mover finish all regions it can first. It would be great if it could fail fast on the split region.&lt;/p&gt;</comment>
                            <comment id="14037844" author="lhofhansl" created="Thu, 19 Jun 2014 20:40:53 +0000"  >&lt;p&gt;Pushing one more time.&lt;/p&gt;</comment>
                            <comment id="14040236" author="aleksshulman" created="Sun, 22 Jun 2014 20:28:58 +0000"  >&lt;p&gt;Hmm - I think it&apos;s still the intention of the patch to have region_mover do a best-effort move of all the regions, as the script had done before. The main addition is that it will retry that process a configurable number of times, in case of strange transient conditions we&apos;ve seen, like the master down when the move request is sent.&lt;/p&gt;

&lt;p&gt;Overall, I&apos;ve seen the region_mover work pretty well and I see this patch as just being a minor stability improvement. If you believe there is a better way to do this region movement, such as failing fast on a split region, I&apos;d be happy to test such a patch in our frameworks.&lt;/p&gt;

&lt;p&gt;If we&apos;re happy with the logic of this patch, then I can post a version for 0.96, 0.98, trunk, etc.&lt;/p&gt;</comment>
                            <comment id="14075708" author="lhofhansl" created="Sun, 27 Jul 2014 18:56:55 +0000"  >&lt;p&gt;Looked at the patch. The comments in the code do not reflect the description of the issue here. It mentions ZK and Master failures, and then sleeps for 60s.&lt;br/&gt;
The issues we&apos;ve seen with region_mover were mostly related to it taking too long. This would make this worse, but then again our scenario may be special.&lt;/p&gt;

&lt;p&gt;What I would like is that if a region cannot be moved, it is simply ignored. HBase will eventually take of that region, region_mover should rather continue on to the next region and move as many regions as possible... Again might be special to us.&lt;/p&gt;</comment>
                            <comment id="14185413" author="lhofhansl" created="Mon, 27 Oct 2014 17:07:27 +0000"  >&lt;p&gt;Moved along for too long, seems nobody is really interested in this. Removing from 0.94. We can always bring it back.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12640760" name="HBASE-10924-0.94-v2.patch" size="9755" author="aleksshulman" created="Fri, 18 Apr 2014 02:01:07 +0000"/>
                            <attachment id="12640899" name="HBASE-10924-0.94-v3.patch" size="10137" author="aleksshulman" created="Fri, 18 Apr 2014 22:18:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 7 Apr 2014 18:28:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385324</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 7 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1udqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385591</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>