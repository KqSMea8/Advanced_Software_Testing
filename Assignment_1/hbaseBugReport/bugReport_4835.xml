<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:22:25 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4835/HBASE-4835.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4835] ConcurrentModificationException out of ZKConfig.makeZKProps</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4835</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Mikhail reported this from a five-node, three-RS cluster test:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-11-21 01:30:15,188 FATAL org.apache.hadoop.hbase.regionserver.HRegionServer: ABORTING region server &amp;lt;machine_name&amp;gt;,60020,1321867814890: Initialization of RS failed. Hence aborting RS.
java.util.ConcurrentModificationException
at java.util.Hashtable$Enumerator.next(Hashtable.java:1031)
at org.apache.hadoop.conf.Configuration.iterator(Configuration.java:1042)
at org.apache.hadoop.hbase.zookeeper.ZKConfig.makeZKProps(ZKConfig.java:75)
at org.apache.hadoop.hbase.zookeeper.ZKConfig.getZKQuorumServersString(ZKConfig.java:245)
at org.apache.hadoop.hbase.zookeeper.ZooKeeperWatcher.&amp;lt;init&amp;gt;(ZooKeeperWatcher.java:144)
at org.apache.hadoop.hbase.zookeeper.ZooKeeperWatcher.&amp;lt;init&amp;gt;(ZooKeeperWatcher.java:124)
at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getZooKeeperWatcher(HConnectionManager.java:1262)
at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.setupZookeeperTrackers(HConnectionManager.java:568)
at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.&amp;lt;init&amp;gt;(HConnectionManager.java:559)
at org.apache.hadoop.hbase.client.HConnectionManager.getConnection(HConnectionManager.java:183)
at org.apache.hadoop.hbase.catalog.CatalogTracker.&amp;lt;init&amp;gt;(CatalogTracker.java:177)
at org.apache.hadoop.hbase.regionserver.HRegionServer.initializeZooKeeper(HRegionServer.java:575)
at org.apache.hadoop.hbase.regionserver.HRegionServer.preRegistrationInitialization(HRegionServer.java:534)
at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:642)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12532169">HBASE-4835</key>
            <summary>ConcurrentModificationException out of ZKConfig.makeZKProps</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Nov 2011 16:35:28 +0000</created>
                <updated>Sat, 11 Apr 2015 01:26:18 +0000</updated>
                            <resolved>Sat, 11 Apr 2015 01:26:18 +0000</resolved>
                                    <version>0.92.0</version>
                    <version>0.94.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13154292" author="apurtell" created="Mon, 21 Nov 2011 16:54:41 +0000"  >&lt;p&gt;I think the simplest course of action is to make a shallow copy of the Configuration in the ZKW constructor.&lt;/p&gt;</comment>
                            <comment id="13154316" author="yuzhihong@gmail.com" created="Mon, 21 Nov 2011 17:48:31 +0000"  >&lt;p&gt;ZKConfig.makeZKProps() is used by ZKUtil.connect(), ZKConfig.getZKQuorumServersString(), etc&lt;br/&gt;
Would ConcurrentModificationException come out the other callers ?&lt;/p&gt;</comment>
                            <comment id="13154323" author="stack" created="Mon, 21 Nov 2011 18:01:24 +0000"  >&lt;p&gt;Would it be cleaner making the clone down in makeZKProps Andrew rather than globally per ZKW instance?  (Lets get this fix into 0.92).&lt;/p&gt;</comment>
                            <comment id="13154360" author="apurtell" created="Mon, 21 Nov 2011 18:41:37 +0000"  >&lt;p&gt;Or synchronize access to the Configuration object in makeZKProps, in addition to cloning the Configuration in the constructor. Can also consider heavy handed synchronization of every read or mutation of it in o.a.h.h.zookeeper just to be sure.&lt;/p&gt;

&lt;p&gt;The concern I have about cloning in makeZKProps is the same hashmap iteration will happen for that. &lt;/p&gt;</comment>
                            <comment id="13154366" author="mikhail" created="Mon, 21 Nov 2011 18:57:10 +0000"  >&lt;p&gt;@Andrew: thanks for the fix!&lt;br/&gt;
The simple approach with copying the configuration sounds good &amp;#8211; I presume we don&apos;t create too many unique ZooKeeperWatchers in a single JVM.&lt;/p&gt;

&lt;p&gt;Alternatively, we could somehow get an immutable snapshot of the configuration&apos;s key set and iterate that instead of the configuration itself.&lt;/p&gt;</comment>
                            <comment id="13154370" author="apurtell" created="Mon, 21 Nov 2011 19:02:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;I presume we don&apos;t create too many unique ZooKeeperWatchers in a single JVM.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is my presumption as well.&lt;/p&gt;</comment>
                            <comment id="13154790" author="stack" created="Tue, 22 Nov 2011 01:09:00 +0000"  >&lt;p&gt;There&apos;s a few per JVM:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
src/main/java/org/apache/hadoop/hbase/master/HMaster.java:    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zooKeeper = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperWatcher(conf, MASTER + &lt;span class=&quot;code-quote&quot;&gt;&quot;:&quot;&lt;/span&gt; + isa.getPort(), &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
src/main/java/org/apache/hadoop/hbase/master/HMaster.java:    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zooKeeper = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperWatcher(conf, MASTER + &lt;span class=&quot;code-quote&quot;&gt;&quot;:&quot;&lt;/span&gt;
src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java:    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zooKeeper = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperWatcher(conf, REGIONSERVER + &lt;span class=&quot;code-quote&quot;&gt;&quot;:&quot;&lt;/span&gt; +
src/main/java/org/apache/hadoop/hbase/replication/master/ReplicationLogCleaner.java:          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperWatcher(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.conf, &lt;span class=&quot;code-quote&quot;&gt;&quot;replicationLogCleaner&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
src/main/java/org/apache/hadoop/hbase/replication/ReplicationPeer.java:    zkw = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperWatcher(conf,
src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java:        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperWatcher(conf, &lt;span class=&quot;code-quote&quot;&gt;&quot;catalogtracker-on-&quot;&lt;/span&gt; + connection.toString(),
src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java:          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zooKeeper = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperWatcher(conf, &lt;span class=&quot;code-quote&quot;&gt;&quot;hconnection&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When you say:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The concern I have about cloning in makeZKProps is the same hashmap iteration will happen for that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are afraid that the clone is not a deep clone so we&apos;ll just be iterating the same map of configuration items?&lt;/p&gt;

&lt;p&gt;That seems valid enough though why won&apos;t we have same issue if we make a clone in ZKW?&lt;/p&gt;

&lt;p&gt;I&apos;m wary cloning Configuration.   I did that &apos;fixing&apos; our issues w/ tests where we were sharing an HConnection and I manufactured the issue where we had too many connections against the zk ensemble.&lt;/p&gt;

&lt;p&gt;Odd we see this now.&lt;/p&gt;</comment>
                            <comment id="13154879" author="yuzhihong@gmail.com" created="Tue, 22 Nov 2011 05:02:45 +0000"  >&lt;p&gt;How about cloning Configuration in ZKW ctor and assign it to a local variable ?&lt;br/&gt;
We pass this local variable to ZKConfig.getZKQuorumServersString().&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12504515" name="HBASE-4835.patch" size="871" author="apurtell" created="Mon, 21 Nov 2011 16:54:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 21 Nov 2011 17:48:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>217905</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 4 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02dmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11809</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>