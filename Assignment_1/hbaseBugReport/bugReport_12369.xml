<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:32:21 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-12369/HBASE-12369.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-12369] Warn if hbase.bucketcache.size too close or equal to MaxDirectMemorySize</title>
                <link>https://issues.apache.org/jira/browse/HBASE-12369</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Our ref guide currently says that its required to leave some room from the DirectMemory. However if hbase.bucketcache.size is too close or equal to MaxDirectMemorySize it can trigger OOMEs: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-10-28 16:14:41,585 INFO  [master&lt;span class=&quot;code-comment&quot;&gt;//172.16.0.101:16020] util.ByteBufferArray: Allocating buffers total=5.00 GB, sizePerBuffer=4 MB, count=1280, direct=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/span&gt;2014-10-28 16:14:41,604 INFO  [172.16.0.101:16020.activeMasterManager] master.ServerManager: Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region servers count to settle; currently checked in 1, slept &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 99 ms, expecting minimum of 2, maximum of 2147483647, timeout of 4500 ms, interval of 1500 ms.
2014-10-28 16:14:43,144 INFO  [172.16.0.101:16020.activeMasterManager] master.ServerManager: Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region servers count to settle; currently checked in 1, slept &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 1639 ms, expecting minimum of 2, maximum of 2147483647, timeout of 4500 ms, interval of 1500 ms.
2014-10-28 16:14:44,057 INFO  [master&lt;span class=&quot;code-comment&quot;&gt;//172.16.0.101:16020] regionserver.HRegionServer: STOPPED: Failed initialization
&lt;/span&gt;2014-10-28 16:14:44,058 ERROR [master&lt;span class=&quot;code-comment&quot;&gt;//172.16.0.101:16020] regionserver.HRegionServer: Failed init
&lt;/span&gt;java.lang.OutOfMemoryError: Direct buffer memory
	at java.nio.Bits.reserveMemory(Bits.java:658)
	at java.nio.DirectByteBuffer.&amp;lt;init&amp;gt;(DirectByteBuffer.java:123)
	at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:306)
	at org.apache.hadoop.hbase.util.ByteBufferArray.&amp;lt;init&amp;gt;(ByteBufferArray.java:65)
	at org.apache.hadoop.hbase.io.hfile.bucket.ByteBufferIOEngine.&amp;lt;init&amp;gt;(ByteBufferIOEngine.java:47)
	at org.apache.hadoop.hbase.io.hfile.bucket.BucketCache.getIOEngineFromName(BucketCache.java:310)
	at org.apache.hadoop.hbase.io.hfile.bucket.BucketCache.&amp;lt;init&amp;gt;(BucketCache.java:218)
	at org.apache.hadoop.hbase.io.hfile.CacheConfig.getL2(CacheConfig.java:513)
	at org.apache.hadoop.hbase.io.hfile.CacheConfig.instantiateBlockCache(CacheConfig.java:536)
	at org.apache.hadoop.hbase.io.hfile.CacheConfig.&amp;lt;init&amp;gt;(CacheConfig.java:213)
	at org.apache.hadoop.hbase.regionserver.HRegionServer.handleReportForDutyResponse(HRegionServer.java:1259)
	at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:818)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:724)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It would be helpful to print a warn message that hbase.bucketcache.size too close or equal to MaxDirectMemorySize.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12751273">HBASE-12369</key>
            <summary>Warn if hbase.bucketcache.size too close or equal to MaxDirectMemorySize</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="esteban">Esteban Gutierrez</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Oct 2014 23:55:17 +0000</created>
                <updated>Wed, 29 Oct 2014 03:42:01 +0000</updated>
                                                                            <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14187749" author="stack" created="Wed, 29 Oct 2014 00:08:16 +0000"  >&lt;p&gt;What you think we should do Esteban?  Look at the jvm settings for maxdirectmemorysize and in bucketcache, before we callocate, throw a fatal error that has more explanation in it?&lt;/p&gt;</comment>
                            <comment id="14187780" author="esteban" created="Wed, 29 Oct 2014 00:21:51 +0000"  >&lt;p&gt;That sounds reasonable. Something like: &lt;/p&gt;

&lt;p&gt;FATAL Bucket cache size (5G) cannot be equal to MaxDirectMemorySize (5GB). Reduce hbase.bucketcache.size or increase MaxDirectMemorySize in your configuration.&lt;/p&gt;

&lt;p&gt;and a warning if too close:&lt;/p&gt;

&lt;p&gt;WARN  Bucket cache size (4.75G) is 95% of MaxDirectMemorySize (5GB). Reduce hbase.bucketcache.size or increase MaxDirectMemorySize in your configuration. See bucket cache section in the reference guide for further information.&lt;/p&gt;


</comment>
                            <comment id="14187922" author="ndimiduk" created="Wed, 29 Oct 2014 02:48:41 +0000"  >&lt;p&gt;I don&apos;t like pct-based decision making because 5% means something very different when you have half a TB of ram than the usual case. Same reason I don&apos;t like the existing checker for Memstore + BlockCache = 80%. I don&apos;t know how much &quot;headroom&quot; the JVM needs in direct memory. I vaguely remember seeing the number 64m, but I don&apos;t recall where. If we can decide on what that value should be, it would be good to have a check + fatal exception as you describe. We should make it possible to disable the constraint checking though.&lt;/p&gt;</comment>
                            <comment id="14187949" author="esteban" created="Wed, 29 Oct 2014 03:38:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndimiduk&quot; class=&quot;user-hover&quot; rel=&quot;ndimiduk&quot;&gt;Nick Dimiduk&lt;/a&gt; agreed for 10s of 100s of GBs probably 5% is just too much. I ran a very simple test without any workload and for 5GBs of direct memory the overhead is close to 10MB (~0.2%) before hitting an OOME when trying to allocate a bucket cache of 5GB. Another possibility is to call DirectMemoryUtils.getDirectMemoryUsage() before attempting to allocate the direct buffer, however if something else tries to allocate direct memory we will just be shifting the OOME somewhere else if the difference is too small.&lt;/p&gt;</comment>
                            <comment id="14187951" author="anoop.hbase" created="Wed, 29 Oct 2014 03:42:01 +0000"  >&lt;p&gt;the bucket cache size, when specified as a %, we calculate the actual value of size based on the heap size. The old offheap cache impl was doing it based on DirectMaxMemory setting.  We need fix that also.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I don&apos;t like the existing checker for Memstore + BlockCache = 80%. I&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That check was basically for memstore and BC all in heap. So we reserve 20% of heap for other needs. When the BC is bucket cache and the ofheap size also getting included in this check? We need some fix then.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Oct 2014 00:08:16 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 7 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21p7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>