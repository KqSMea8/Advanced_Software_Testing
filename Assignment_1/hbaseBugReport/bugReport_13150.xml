<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:40:14 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13150/HBASE-13150.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13150] TestMasterObserver failing disable table at end of test</title>
                <link>https://issues.apache.org/jira/browse/HBASE-13150</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I see in &lt;a href=&quot;https://builds.apache.org/view/H-L/view/HBase/job/HBase-TRUNK/6202/testReport/junit/org.apache.hadoop.hbase.coprocessor/TestMasterObserver/testRegionTransitionOperations/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/view/H-L/view/HBase/job/HBase-TRUNK/6202/testReport/junit/org.apache.hadoop.hbase.coprocessor/TestMasterObserver/testRegionTransitionOperations/&lt;/a&gt;  , now we have added in timeouts, that we are failing to disable a table. It looks like table is disabled but regions are being opened on the disabled table still, like &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6537&quot; title=&quot;Race between balancer and disable table can lead to inconsistent cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6537&quot;&gt;&lt;del&gt;HBASE-6537&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let me see if can figure why this happening. Will be back.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12779246">HBASE-13150</key>
            <summary>TestMasterObserver failing disable table at end of test</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Apache9">Duo Zhang</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Mar 2015 00:16:48 +0000</created>
                <updated>Fri, 6 Mar 2015 19:31:34 +0000</updated>
                            <resolved>Fri, 6 Mar 2015 19:31:34 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                    <component>test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14346377" author="apache9" created="Wed, 4 Mar 2015 04:27:44 +0000"  >&lt;p&gt;Seems this is the last enemy.&lt;/p&gt;

&lt;p&gt;This is what I have found now. Hope it helps.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-03-03 22:17:04,776 INFO  [asf900.gq1.ygridcore.net,35522,1425421016549-org.apache.hadoop.hbase.master.handler.DisableTableHandler$BulkDisabler-4] master.RegionStateStore(207): Updating row testRegionTransitionOperations,eee,1425421019650.9d08f4e7ce46a76e88b9e5265b81ff83. with state=PENDING_CLOSE
2015-03-03 22:17:04,776 INFO  [PriorityRpcServer.handler=7,queue=1,port=45988] regionserver.RSRpcServices(1347): Open testRegionTransitionOperations,yyy,1425421019650.e2998ed5019dc219cc3c0112541c0cdf.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Grep e2998ed5019dc219cc3c0112541c0cdf, you can see that this should be the last stage when moving a region. So it means we begin to disable the table when there are region transitions that have not finished yet.&lt;/p&gt;

&lt;p&gt;So this maybe an insufficient waitForRITtoBeZero implementation. But I think disable table should deal with this situation. It is not acceptable that disable a table will fail if there are regions in transition I think.&lt;/p&gt;</comment>
                            <comment id="14346952" author="apache9" created="Wed, 4 Mar 2015 14:32:17 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-03-03 22:17:04,715 DEBUG [Thread-268] master.AssignmentManager(1295): Starting unassign of testRegionTransitionOperations,yyy,1425421019650.e2998ed5019dc219cc3c0112541c0cdf. (offlining), current state: {e2998ed5019dc219cc3c0112541c0cdf state=OPEN, ts=1425421021849, server=asf900.gq1.ygridcore.net,44226,1425421017118}

2015-03-03 22:17:04,758 INFO  [MASTER_TABLE_OPERATIONS-asf900:35522-0] handler.DisableTableHandler(123): Attempting to disable table testRegionTransitionOperations

2015-03-03 22:17:04,765 INFO  [MASTER_TABLE_OPERATIONS-asf900:35522-0] handler.DisableTableHandler(166): Offlining 26 regions.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is only one log line for unassigning e2998ed5019dc219cc3c0112541c0cdf and it is before we disabling testRegionTransitionOperations so it should be the region moving(offline and then online). The number of regions in log is right(26 regions), but seems we skip the offline process if region is in transition.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DisableTableHandler.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void populatePool(ExecutorService pool) {
      RegionStates regionStates = assignmentManager.getRegionStates();
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (HRegionInfo region: regions) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (regionStates.isRegionInTransition(region)
            &amp;amp;&amp;amp; !regionStates.isRegionInState(region, RegionState.State.FAILED_CLOSE)) {
          &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HRegionInfo hri = region;
        pool.execute(Trace.wrap(&lt;span class=&quot;code-quote&quot;&gt;&quot;DisableTableHandler.BulkDisabler&quot;&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
          &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            assignmentManager.unassign(hri);
          }
        }));
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So the problem maybe the code how we deal with the regions in transition state when disabling a table? I have not found the code yet.&lt;/p&gt;</comment>
                            <comment id="14346959" author="octo47" created="Wed, 4 Mar 2015 14:36:47 +0000"  >&lt;p&gt;That is the same situation here, I think.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13076&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-13076&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Table become ENABLED, thats leads to regions instructed to assign immediately on onRegionClosed. BulkDisabler will not know about that and will wait indefinitely, because it will not issue unassign for newly opened regions.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14347864" author="apache9" created="Thu, 5 Mar 2015 01:00:01 +0000"  >&lt;p&gt;The region moving of e2998ed5019dc219cc3c0112541c0cdf is not triggered by client, it should be the balancer.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-03-03 22:17:04,713 INFO  [Thread-268] master.HMaster(1171): balance hri=testRegionTransitionOperations,yyy,1425421019650.e2998ed5019dc219cc3c0112541c0cdf., src=asf900.gq1.ygridcore.net,44226,1425421017118, dest=asf900.gq1.ygridcore.net,45988,1425421016996
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=octo47&quot; class=&quot;user-hover&quot; rel=&quot;octo47&quot;&gt;Andrey Stepachev&lt;/a&gt;, I do not think it is caused by table enabling because this is a region moving, not just assigning.&lt;/p&gt;

&lt;p&gt;There are 7 regions moving trigger by client&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-03-03 22:17:04,011 INFO  [Thread-268] master.HMaster(1278): Client=null/null move hri=testRegionTransitionOperations,,1425421019650.f0fadadca3541ee837977b545ecabba2., src=asf900.gq1.ygridcore.net,45988,1425421016996, dest=asf900.gq1.ygridcore.net,44226,1425421017118, running balancer
2015-03-03 22:17:04,105 INFO  [Thread-268] master.HMaster(1278): Client=null/null move hri=testRegionTransitionOperations,ccc,1425421019650.00fe88fb2e6ed600a05c96283ba13055., src=asf900.gq1.ygridcore.net,45988,1425421016996, dest=asf900.gq1.ygridcore.net,44226,1425421017118, running balancer
2015-03-03 22:17:04,121 INFO  [Thread-268] master.HMaster(1278): Client=null/null move hri=testRegionTransitionOperations,ddd,1425421019650.55adc74733629e36d79051d5ca9150b1., src=asf900.gq1.ygridcore.net,45988,1425421016996, dest=asf900.gq1.ygridcore.net,44226,1425421017118, running balancer
2015-03-03 22:17:04,130 INFO  [Thread-268] master.HMaster(1278): Client=null/null move hri=testRegionTransitionOperations,fff,1425421019650.a44832b7d6de27281a976a74dfff9c7b., src=asf900.gq1.ygridcore.net,45988,1425421016996, dest=asf900.gq1.ygridcore.net,44226,1425421017118, running balancer
2015-03-03 22:17:04,140 INFO  [Thread-268] master.HMaster(1278): Client=null/null move hri=testRegionTransitionOperations,jjj,1425421019650.6012302985744f8f91e8082742d1a033., src=asf900.gq1.ygridcore.net,45988,1425421016996, dest=asf900.gq1.ygridcore.net,44226,1425421017118, running balancer
2015-03-03 22:17:04,149 INFO  [Thread-268] master.HMaster(1278): Client=null/null move hri=testRegionTransitionOperations,nnn,1425421019650.30840d6dbbfc8512a13014e60ab758b3., src=asf900.gq1.ygridcore.net,45988,1425421016996, dest=asf900.gq1.ygridcore.net,44226,1425421017118, running balancer
2015-03-03 22:17:04,160 INFO  [Thread-268] master.HMaster(1278): Client=null/null move hri=testRegionTransitionOperations,ooo,1425421019650.44abfcf09b9f08a8dbdfe9185747db34., src=asf900.gq1.ygridcore.net,45988,1425421016996, dest=asf900.gq1.ygridcore.net,44226,1425421017118, running balancer
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;No e2998ed5019dc219cc3c0112541c0cdf. We turn on balancer at the end of test and call master.balance, so it is possible that there is region in transition when we disabling the table.&lt;/p&gt;

&lt;p&gt;And I think the direct reason is we skip regions in transition when deploy tasks, but we do not ignore these regions in waitUntilDone, so only a timeout can let us deploy the new tasks for remaining regions and the default timeout is 5 minutes thus we get a test timeout.&lt;/p&gt;

&lt;p&gt;But I blamed the related code, seems there is nothing changed recently, so I do not know the root reason why it becomes flaky only recently...&lt;/p&gt;</comment>
                            <comment id="14348081" author="apache9" created="Thu, 5 Mar 2015 03:49:14 +0000"  >&lt;p&gt;I think the problem maybe &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11611&quot; title=&quot;Clean up ZK-based region assignment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11611&quot;&gt;&lt;del&gt;HBASE-11611&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11611&quot; title=&quot;Clean up ZK-based region assignment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11611&quot;&gt;&lt;del&gt;HBASE-11611&lt;/del&gt;&lt;/a&gt; cleaned up zk related codes. But in nodeDeleted method, we will check if the onlined region is belonged to a disabled table. If so, we will offline the region.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AssignmentManager.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (disabled) {
                    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; server is offline, no hurt to unassign again
&lt;/span&gt;                    LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Opened &quot;&lt;/span&gt; + regionNameStr
                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;but &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; table is disabled, triggering close of region&quot;&lt;/span&gt;);
                    unassign(regionInfo);
                  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So the unit test is only flaky on master.&lt;br/&gt;
See the full code here: &lt;a href=&quot;https://github.com/apache/hbase/blob/branch-1/hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/hbase/blob/branch-1/hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have not found codes with same function in master, so this maybe the reason? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="14348111" author="apache9" created="Thu, 5 Mar 2015 04:19:58 +0000"  >&lt;p&gt;Oh sorry, I found the code.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AssignmentManager.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; onRegionOpen(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; RegionState current, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HRegionInfo hri,
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ServerName serverName, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; RegionStateTransition transition) {
    ...
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getTableStateManager().isTableState(hri.getTable(),
            TableState.State.DISABLED, TableState.State.DISABLING)) {
      invokeUnAssign(hri);
    }
    ...
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So let me see if there is a race condition.&lt;/p&gt;</comment>
                            <comment id="14348125" author="apache9" created="Thu, 5 Mar 2015 04:49:16 +0000"  >&lt;p&gt;Yeah, same with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13076&quot; title=&quot;Table can be forcibly enabled in AssignmentManager during table disabling.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13076&quot;&gt;&lt;del&gt;HBASE-13076&lt;/del&gt;&lt;/a&gt;, it is because we reset the table state to ENABLE so the above code does not work.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-03-03 22:17:04,764 DEBUG [AM.-pool2-t13] master.AssignmentManager(1020): Setting table testRegionTransitionOperations to ENABLED state.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Let me see why we call assign during disabling...&lt;/p&gt;</comment>
                            <comment id="14348194" author="apache9" created="Thu, 5 Mar 2015 05:48:07 +0000"  >&lt;p&gt;OK, is this a possible race condition?&lt;/p&gt;

&lt;p&gt;When moving a region, we will call invokeAssign at the end of onRegionClosed. This will schedule a async assign task.&lt;/p&gt;

&lt;p&gt;There are lots of places where we check for table disable, but we can pass all the check and arrive here&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AssignmentManager.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  /**
   * Caller must hold lock on the passed &amp;lt;code&amp;gt;state&amp;lt;/code&amp;gt; object.
   * @param state
   * @param forceNewPlan
   */
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void assign(RegionState state, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; forceNewPlan) {
        ...
        &lt;span class=&quot;code-comment&quot;&gt;// In &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; of assignment from EnableTableHandler table state is ENABLING. Any how
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// EnableTableHandler will set ENABLED after assigning all the table regions. If we
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to set to ENABLED directly then client API may think table is enabled.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// When we have a &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; such as all the regions are added directly into hbase:meta and we call
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// assignRegion then we need to make the table ENABLED. Hence in such &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the table
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// will not be in ENABLING or ENABLED state.
&lt;/span&gt;        TableName tableName = region.getTable();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!tableStateManager.isTableState(tableName,
          TableState.State.ENABLED, TableState.State.ENABLING)) {
          LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Setting table &quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot; to ENABLED state.&quot;&lt;/span&gt;);
          setEnabledTable(tableName);
        }
        ...
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Notice that here we only hold the region lock, not table lock. So let&apos;s stop this thread, and start the DisableTableHandler Thread. In prepare method, it will set table state to DISABLING under the protect of table lock. And in handleDisableTable, we will set it DISABLING one more time(without any lock)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DisableTableHandler.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DisableTableHandler prepare()
      &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; TableNotFoundException, TableNotEnabledException, IOException {
      ...
      &lt;span class=&quot;code-comment&quot;&gt;// There could be multiple client requests trying to disable or enable
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// the table at the same time. Ensure only the first request is honored
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// After that, no other requests can be accepted until the table reaches
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// DISABLED or ENABLED.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;//TODO: reevaluate &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; since we have table locks now
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!skipTableStateCheck) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.getTableStateManager().setTableStateIfInStates(
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tableName, TableState.State.DISABLING,
          TableState.State.ENABLED)) {
          LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Table &quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot; isn&apos;t enabled; skipping disable&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TableNotEnabledException(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tableName);
        }
      }
      ...
  }

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void handleDisableTable() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-comment&quot;&gt;// Set table disabling flag up in zk.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.getTableStateManager().setTableState(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tableName,
      TableState.State.DISABLING);
    ..
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And after this, the DisableTableHandler will enter a &apos;while(true)&apos; loop and break until all regions are offline. Now let us stop the DisableTableHandler thread. Since there is no lock protection so the assign thread is free to wake up. So it will do the check and find that the table is not in ENABLED or ENABLING state so it will set it to ENABLED. So, the DisableTableHandler will wait forever.&lt;/p&gt;

&lt;p&gt;Here is the log&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-03-03 22:17:04,754 DEBUG [RS_CLOSE_REGION-asf900:44226-2] handler.CloseRegionHandler(122): Closed testRegionTransitionOperations,yyy,1425421019650.e2998ed5019dc219cc3c0112541c0cdf.
2015-03-03 22:17:04,758 INFO  [MASTER_TABLE_OPERATIONS-asf900:35522-0] handler.DisableTableHandler(123): Attempting to disable table testRegionTransitionOperations
2015-03-03 22:17:04,758 DEBUG [AM.-pool2-t13] master.AssignmentManager(1203): Found an existing plan for testRegionTransitionOperations,yyy,1425421019650.e2998ed5019dc219cc3c0112541c0cdf. destination server is asf900.gq1.ygridcore.net,45988,1425421016996 accepted as a dest server = true
2015-03-03 22:17:04,759 DEBUG [AM.-pool2-t13] master.AssignmentManager(1243): Using pre-existing plan for testRegionTransitionOperations,yyy,1425421019650.e2998ed5019dc219cc3c0112541c0cdf.; 
2015-03-03 22:17:04,764 DEBUG [AM.-pool2-t13] master.AssignmentManager(1020): Setting table testRegionTransitionOperations to ENABLED state.
2015-03-03 22:17:04,765 INFO  [MASTER_TABLE_OPERATIONS-asf900:35522-0] hbase.MetaTableAccessor(1430): Updated table testRegionTransitionOperations state to DISABLING in META
2015-03-03 22:17:04,765 INFO  [MASTER_TABLE_OPERATIONS-asf900:35522-0] handler.DisableTableHandler(166): Offlining 26 regions
2015-03-03 22:17:04,770 INFO  [AM.-pool2-t13] hbase.MetaTableAccessor(1430): Updated table testRegionTransitionOperations state to ENABLED in META
2015-03-03 22:17:04,770 INFO  [AM.-pool2-t13] master.AssignmentManager(1023): Assigning testRegionTransitionOperations,yyy,1425421019650.e2998ed5019dc219cc3c0112541c0cdf. to asf900.gq1.ygridcore.net,45988,1425421016996
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14348286" author="stack" created="Thu, 5 Mar 2015 07:05:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Apache9&quot; class=&quot;user-hover&quot; rel=&quot;Apache9&quot;&gt;Duo Zhang&lt;/a&gt; let me review the above in (my) morning...&lt;/p&gt;</comment>
                            <comment id="14348352" author="octo47" created="Thu, 5 Mar 2015 08:03:06 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;~zhangduo&amp;#93;&lt;/span&gt; at first I tried to make thread BulkUnassign more intelligent, it peeks regions and later rechecks that all regions not OPENED, if so it rescheduled. But later I found piece of code removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13076&quot; title=&quot;Table can be forcibly enabled in AssignmentManager during table disabling.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13076&quot;&gt;&lt;del&gt;HBASE-13076&lt;/del&gt;&lt;/a&gt; in this test never failed in my setup (2/3 times it failed before) flackery &lt;/p&gt;</comment>
                            <comment id="14348358" author="apache9" created="Thu, 5 Mar 2015 08:11:19 +0000"  >&lt;p&gt;Yes, I think remove the code above in assign method could solve the problem of this test.&lt;br/&gt;
But we need to confirm that removing it is safe?&lt;/p&gt;</comment>
                            <comment id="14349319" author="jxiang" created="Thu, 5 Mar 2015 19:23:11 +0000"  >&lt;p&gt;Good analysing. I think we are good to remove that part as Andrey did in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13076&quot; title=&quot;Table can be forcibly enabled in AssignmentManager during table disabling.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13076&quot;&gt;&lt;del&gt;HBASE-13076&lt;/del&gt;&lt;/a&gt;.  We should not change (write) a table state in assigning any region. We only need to check (read) the state instead.&lt;/p&gt;</comment>
                            <comment id="14349370" author="stack" created="Thu, 5 Mar 2015 19:49:03 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt; I committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13076&quot; title=&quot;Table can be forcibly enabled in AssignmentManager during table disabling.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13076&quot;&gt;&lt;del&gt;HBASE-13076&lt;/del&gt;&lt;/a&gt;. Lets see if it helps here. Will leave the issue open a while as we watch it.&lt;/p&gt;</comment>
                            <comment id="14350773" author="stack" created="Fri, 6 Mar 2015 19:31:34 +0000"  >&lt;p&gt;Resolving as fixed. TRUNK is blue now (mostly). Giving it to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Apache9&quot; class=&quot;user-hover&quot; rel=&quot;Apache9&quot;&gt;Duo Zhang&lt;/a&gt; since he did bunch of the footwork with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=octo47&quot; class=&quot;user-hover&quot; rel=&quot;octo47&quot;&gt;Andrey Stepachev&lt;/a&gt; help.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 4 Mar 2015 04:27:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26blz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>