<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:55:51 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8502/HBASE-8502.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8502] Eternally stuck Region after split</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8502</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;  Exact HBase version: 0.92.1-cdh4.1.2&lt;/p&gt;

&lt;p&gt;A couple of days ago I encountered a RIT problem with a single region.&lt;br/&gt;
After an hbck run it started trying to assign a region which has been &lt;br/&gt;
bouncing between OFFLINE/PENDING_OPEN/OPENING for two days afterwards.&lt;/p&gt;

&lt;p&gt;This was due to a split gone wrong in some way, which led to several &lt;br/&gt;
reference files being left in the region-directory despite the two relevant HFiles being copies successfully to the daughter.&lt;/p&gt;

&lt;p&gt;I will try to give as many details as possible, but unfortunately I was&lt;br/&gt;
unable to find any information about the split itself.&lt;/p&gt;

&lt;p&gt;Short thread about this issue on the users-ML: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/hbase-user/201305.mbox/%3C5182758B.1060306@neofonie.de%3E&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://mail-archives.apache.org/mod_mbox/hbase-user/201305.mbox/%3C5182758B.1060306@neofonie.de%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;===&lt;/p&gt;

&lt;p&gt;Parent region: 5b9c16898a371de58f31f0bdf86b1f8b&lt;br/&gt;
Daughter region in question: 79c619508659018ff3ef0887611eb8f7&lt;/p&gt;

&lt;p&gt;Rough sequence from the logs seems to be the following:&lt;/p&gt;

&lt;p&gt;===&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Received request to open region:&lt;br/&gt;
documents,7128586022887322720,1363696791400.79c619508659018ff3ef0887611eb8f7.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Setting up tabledescriptor config now ...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Opening of region 
{NAME =&amp;gt;
&apos;documents,7128586022887322720,1363696791400.79c619508659018ff3ef0887611eb8f7.&apos;,
     STARTKEY =&amp;gt; &apos;7128586022887322720&apos;,
     ENDKEY =&amp;gt; &apos;7130716361635801616&apos;,
     ENCODED =&amp;gt; 79c619508659018ff3ef0887611eb8f7,}
&lt;p&gt; failed, marking as&lt;br/&gt;
FAILED_OPEN in ZK&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;File does not exist:&lt;br/&gt;
/hbase/documents/5b9c16898a371de58f31f0bdf86b1f8b/d/0707b1ec4c6b41cf9174e0d2a1785fe9 &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
===&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What happened, was that somehow (and that&apos;s the question here) the daughters&lt;br/&gt;
region folder contained some left-over reference files were causing the &lt;br/&gt;
RegionServer to look-up the parent region, which already was deleted.&lt;/p&gt;

&lt;p&gt;original contents of /hbase/documents/79c619508659018ff3ef0887611eb8f7/d:&lt;br/&gt;
==&lt;br/&gt;
0707b1ec4c6b41cf9174e0d2a1785fe9.5b9c16898a371de58f31f0bdf86b1f8b&lt;br/&gt;
47511faae81b4452afd3ca206e28346f.5b9c16898a371de58f31f0bdf86b1f8b&lt;br/&gt;
4f01ecd052ce464d81e79a62ea227d6b&lt;br/&gt;
4f01ecd052ce464d81e79a62ea227d6b.5b9c16898a371de58f31f0bdf86b1f8b&lt;br/&gt;
eb7dbb09701d4353be24ca82481c4a7e&lt;br/&gt;
== &lt;/p&gt;

&lt;p&gt;I attached the full FileNotFound Exception.&lt;/p&gt;

&lt;p&gt;Please let me know if I can provide more information or help otherwise.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646431">HBASE-8502</key>
            <summary>Eternally stuck Region after split</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="9">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="goldin">Dimitri Goldin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 May 2013 15:51:33 +0000</created>
                <updated>Sat, 18 Jan 2014 04:02:51 +0000</updated>
                            <resolved>Tue, 6 Aug 2013 20:57:31 +0000</resolved>
                                    <version>0.92.1</version>
                                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13651150" author="jxiang" created="Tue, 7 May 2013 18:29:28 +0000"  >&lt;p&gt;Is this region already stuck in transition before you run hbck? I think it is more useful to have the region split related log (both the region server where the split happens, and the master).  Do you know what happens to the parent region after the region is split?&lt;/p&gt;</comment>
                            <comment id="13651948" author="goldin" created="Wed, 8 May 2013 14:49:50 +0000"  >&lt;p&gt;I haven&apos;t noticed the region until I ran hbck and according to the hbck run itself it just wasn&apos;t assigned anywhere anymore (I don&apos;t know why yet). &lt;/p&gt;

&lt;p&gt;It seems the actual problem happened somewhere in march during a time I was not in the office, but at least one of the daughters seems to have been stuck for a while. I think somebody restarted the cluster and ran hbck -repair back then attempting to fix the issue. And somehow it went away for a while, meaning that the regions just were not onlined.&lt;/p&gt;

&lt;p&gt;I didn&apos;t discover it until a couple of days ago, since the table in question is only updated every couple of weeks.&lt;/p&gt;

&lt;p&gt;Fortunately I was able to find some old logs in a backup from mid march mentioning failed splits and rollbacks of the parent region including a different daughter region (939c1e9d10cc4e97d7284025f20298fb), which seemed to have the same problem. I presume both were created somewhere on 2013-03-18 during the same failed split. But unfortunately they are not explicitly mentioned as daughters in the logs, since the split failed. Sadly I do not have any logs left between ~2013-03-20 and 2012-05-01, since most were rotated by now.&lt;/p&gt;

&lt;p&gt;Unfortunately I was also unable to find any mention of the 79c619508659018ff3ef0887611eb8f7 region in the master-logs from that time.&lt;/p&gt;

&lt;p&gt;As to what happened to the parent region after the region split; currently I&apos;m really not sure. It is obvious that it was removed at some point in time causing inability to online both daughters, even though the parts of the logs state, that the splits were rolled back. The last mention of the region&lt;br/&gt;
I&apos;m able to find is from 2013-03-18 19:45:00,014 (MASTER, point of no return error).&lt;/p&gt;

&lt;p&gt;There is also another &apos;new&apos; question: why have the attempts to online both daughters stopped at some&lt;br/&gt;
point in time until hbck tried to touch one of them. It&apos;s also unclear what happened to the second daughter (939...8fb).&lt;/p&gt;

&lt;p&gt;Please see attached file in which I tried to collect relevant sections of logs from hbck, master and regionserver. I hope this helps more. I will try to find even more and update.&lt;/p&gt;</comment>
                            <comment id="13652115" author="jxiang" created="Wed, 8 May 2013 17:45:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goldin&quot; class=&quot;user-hover&quot; rel=&quot;goldin&quot;&gt;Dimitri Goldin&lt;/a&gt;, thanks a lot for the log. We can tell the region was split twice.  The first time was around 2013-03-18 18:53:10,164, but it failed and rolled back at 2013-03-18 18:53:59,108. The second time was at 2013-03-18 19:44:59,963, which failed since a hfile was missing.  The same hfile was the reason that the region stuck in transition.&lt;/p&gt;

&lt;p&gt;The first split took quite some time.  My guess is that it&apos;s because it had some problem to access this hfile in question. Can you check your HDFS NN and DN log about this file?&lt;/p&gt;

&lt;p&gt;File does not exist: /hbase/documents/5b9c16898a371de58f31f0bdf86b1f8b/d/0707b1ec4c6b41cf9174e0d2a1785fe9&lt;/p&gt;

&lt;p&gt;Do we know what happened to it?&lt;/p&gt;</comment>
                            <comment id="13654504" author="goldin" created="Fri, 10 May 2013 14:22:09 +0000"  >&lt;p&gt;Yes, during that time some system were overloaded and caused some stability issues. So probably the split failed because of a timeout.&lt;/p&gt;

&lt;p&gt;I checked the DN and NN logs, but they do not contain the period in question (they start at 2013-03-19 11:56) and are pretty useless. They mostly contain the already known FileNotFoundException and some renaming issues quoted below.&lt;/p&gt;

&lt;p&gt;The content of the 79c619508659018ff3ef0887611eb8f7 daughter suggest, that some split either succeeded despite a previously failed and&lt;br/&gt;
improperly rolled back attempt or simply the failed split failed to clean up. So I do believe, that HBase deleted the parent region itself.&lt;/p&gt;

&lt;p&gt;My suspicion was that maybe either there might be some flaw in the rollback logic under strange circumstances or that re-tried splits&lt;br/&gt;
don&apos;t check for left-over reference files and such. Though it is strange, that one of the successfully copied hfiles still has it&apos;s ref-file.&lt;/p&gt;

&lt;p&gt;I&apos;m sorry, that I can not provide full logs for the period, as this has been silently lurking for quite a while.&lt;br/&gt;
Any ideas as to why the daughter region was able to stay offline for so long without any problems? I think this might almost&lt;br/&gt;
be a separate issue too.&lt;/p&gt;

&lt;p&gt;On the Mailinglist it seemed like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.odell&quot; class=&quot;user-hover&quot; rel=&quot;kevin.odell&quot;&gt;Kevin Odell&lt;/a&gt; has encountered this issue before, maybe he can help us overcome the incomplete information from logs.&lt;/p&gt;

&lt;p&gt;How can we go about this with what we have? Any ideas how to reproduce and verify the behaviour?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;hadoop-cmf-hdfs1-NAMENODE-mia-node08.miacluster.priv.log.out.2:2013-03-19 13:39:52,937 mia-node08.miacluster.priv WARN org.apache.hadoop.hdfs.StateChange: DIR* FSDirectory.unprotectedRenameTo: failed to rename /hbase/documents/e6227aaa6f6e03188372ec534bf7e150/d/0707b1ec4c6b41cf9174e0d2a1785fe9.5b9c16898a371de58f31f0bdf86b1f8b to /hbase/documents/79c619508659018ff3ef0887611eb8f7/d/0707b1ec4c6b41cf9174e0d2a1785fe9.5b9c16898a371de58f31f0bdf86b1f8b because destination exists&lt;br/&gt;
hadoop-cmf-hdfs1-NAMENODE-mia-node08.miacluster.priv.log.out.2:2013-03-19 13:39:52,938 mia-node08.miacluster.priv WARN org.apache.hadoop.hdfs.StateChange: DIR* FSDirectory.unprotectedRenameTo: failed to rename /hbase/documents/e6227aaa6f6e03188372ec534bf7e150/d/47511faae81b4452afd3ca206e28346f.5b9c16898a371de58f31f0bdf86b1f8b to /hbase/documents/79c619508659018ff3ef0887611eb8f7/d/47511faae81b4452afd3ca206e28346f.5b9c16898a371de58f31f0bdf86b1f8b because destination exists&lt;br/&gt;
hadoop-cmf-hdfs1-NAMENODE-mia-node08.miacluster.priv.log.out.2:2013-03-19 13:39:52,938 mia-node08.miacluster.priv WARN org.apache.hadoop.hdfs.StateChange: DIR* FSDirectory.unprotectedRenameTo: failed to rename /hbase/documents/e6227aaa6f6e03188372ec534bf7e150/d/4f01ecd052ce464d81e79a62ea227d6b.5b9c16898a371de58f31f0bdf86b1f8b to /hbase/documents/79c619508659018ff3ef0887611eb8f7/d/4f01ecd052ce464d81e79a62ea227d6b.5b9c16898a371de58f31f0bdf86b1f8b because destination exists&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13654602" author="jxiang" created="Fri, 10 May 2013 16:59:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;The daughter region was able to stay offline without any problems&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think it is most likely because the parent is still online so that we don&apos;t need the daughter. The parent may have gone through some compaction so the file is gone. When the parent is split again, the same daughter region happens to be created, which is not cleaned up properly during the previous split try which has a ref file leftover which refers to the file is already gone.  That&apos;s my guess.  I will take a look the code to make sure rolling back clean up the daughter regions.&lt;/p&gt;

&lt;p&gt;As to move forward, other than reviewing the rolling back code check, I think we can set up some continuous testing to do region split all the time.  We are sure to be able to reproduce it, if it is a code issue.&lt;/p&gt;</comment>
                            <comment id="13654615" author="goldin" created="Fri, 10 May 2013 17:11:31 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I think it is most likely because the parent is still online so that we don&apos;t need the daughter. The parent may have gone through some compaction so the file is gone.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Just want to add a small detail:&lt;/p&gt;

&lt;p&gt;Of course I can not be sure how the region folders looked back then, but when I noticed the issue I immediately checked for the parent regions folder and it was &lt;em&gt;completely&lt;/em&gt; gone, not just a single hfile. No mention in .META. either, no splitA/splitB columns either. That&apos;s why until now I assumed, that the whole parent was removed after one of the split attempts or regionserver cleanup code (It crashed after point of no return, as mentioned in the log).&lt;/p&gt;</comment>
                            <comment id="13654634" author="jxiang" created="Fri, 10 May 2013 17:30:18 +0000"  >&lt;p&gt;Do you have the hbck log?  If so, I&apos;d like to know if the parent region was still there at that moment.&lt;/p&gt;</comment>
                            <comment id="13654672" author="goldin" created="Fri, 10 May 2013 18:07:18 +0000"  >&lt;p&gt;Unfortunately not from march and the only interesting lines, which caught my eye during the recent runs are included in the appended log-extracts. If you&apos;d like to see the full hbck run, let me know and I&apos;ll try to get it. &lt;/p&gt;</comment>
                            <comment id="13654703" author="jdcryans" created="Fri, 10 May 2013 18:35:48 +0000"  >&lt;p&gt;This sounds like something someone else encountered that I helped fixing. In their case, they ran HBCK after a split happened (not sure why they did) and it merged the parent and daughters into a new region. The problem is that the reference files were still there and they were put alongside the files they reference to. What happens here is that since the parent also got moved, the referenced files moved too and are not there anymore. This is why in my case the region wasn&apos;t able to open getting a FNFE, and it kept getting reassigned by the master.&lt;/p&gt;

&lt;p&gt;The fix is to delete the reference files, or at least move them away, since the original file is right there.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goldin&quot; class=&quot;user-hover&quot; rel=&quot;goldin&quot;&gt;Dimitri Goldin&lt;/a&gt; can you verify that 79c619508659018ff3ef0887611eb8f7 is really a daughter of 5b9c16898a371de58f31f0bdf86b1f8b? It should tell in the RS log when it splits, or in the master log when the split is reported. If it&apos;s not a daughter, then this could definitely be the same issue, as 79c619508659018ff3ef0887611eb8f7 would be the region created by HBCK.&lt;/p&gt;</comment>
                            <comment id="13655865" author="goldin" created="Mon, 13 May 2013 09:26:15 +0000"  >&lt;p&gt;Added logs of my two recent HBCK runs (please see hbck_run.log). As to whether hbck created the &apos;daughter&apos; or not, I cant tell from the split logs, since it doesnt mention the daughters in this case.&lt;/p&gt;</comment>
                            <comment id="13656234" author="jdcryans" created="Mon, 13 May 2013 18:38:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Added logs of my two recent HBCK runs &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could it be that a HBCK was run before that? I can&apos;t find anything interesting in those logs unfortunately...&lt;/p&gt;

&lt;p&gt;To continue I would need:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In the master log grep for 5b9c16898a371de58f31f0bdf86b1f8b and get us the line where it splits and it lists the two daughters&lt;/li&gt;
	&lt;li&gt;Using that line, you can tell which region server did the split so get everything from that region server that relates to 5b9c16898a371de58f31f0bdf86b1f8b when it split&lt;/li&gt;
	&lt;li&gt;In the NN log grep for 4f01ecd052ce464d81e79a62ea227d6b.5b9c16898a371de58f31f0bdf86b1f8b&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13731256" author="jxiang" created="Tue, 6 Aug 2013 20:57:31 +0000"  >&lt;p&gt;Closed this one for now.  I think the region stuck in transition because hbck repair could have done something wrong. We can re-open it if we see the issue again, without running hbck repair.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12689418">HBASE-10370</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12582301" name="hbase_lost_parent.txt" size="50927" author="goldin" created="Wed, 8 May 2013 15:00:55 +0000"/>
                            <attachment id="12582906" name="hbase_run.log" size="12193" author="goldin" created="Mon, 13 May 2013 09:10:10 +0000"/>
                            <attachment id="12582110" name="stuck_region_exception.txt" size="9129" author="goldin" created="Tue, 7 May 2013 15:53:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 May 2013 18:29:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326789</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 19 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kdl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327134</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>