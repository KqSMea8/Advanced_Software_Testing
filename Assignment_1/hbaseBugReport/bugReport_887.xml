<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:48:27 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-887/HBASE-887.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-887] Fix a hotspot in scanners</title>
                <link>https://issues.apache.org/jira/browse/HBASE-887</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When scanning, we do a lot of RPCs and this has a huge performance hit. I propose that we add a way to fetch more rows during next() and put them in cache. This should be configurable.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12404565">HBASE-887</key>
            <summary>Fix a hotspot in scanners</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Sep 2008 19:22:39 +0000</created>
                <updated>Sun, 13 Sep 2009 22:26:26 +0000</updated>
                            <resolved>Tue, 23 Sep 2008 14:51:31 +0000</resolved>
                                                    <fixVersion>0.19.0</fixVersion>
                                    <component>Client</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                            <comments>
                            <comment id="12631891" author="jdcryans" created="Wed, 17 Sep 2008 19:27:30 +0000"  >&lt;p&gt;This patch fixes the hotspot. When running the PE with only 1 row prefetched (so the same as usual), I got these numbers:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Finished scan in 84713ms at offset 0 for 1048576 rows&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;With my patch in place and a configured 2000 rows of caching, I got:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Finished scan in 34754ms at offset 0 for 1048576 rows&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Passes the tests. Please try it and review. Maybe the default hbase.client.scanner.caching should be 1 to be sure and a bigger number for MR jobs?&lt;/p&gt;</comment>
                            <comment id="12631953" author="jdcryans" created="Wed, 17 Sep 2008 21:20:47 +0000"  >&lt;p&gt;Some tests I did with a modified PE. I ran the PE with a number from 10 to 3000 and incremented by 10. The garbage collector was called after each run. Here are the results:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;08/09/17 16:48:54 INFO hbase.ManyPerformanceEvaluation: 10 42725&lt;br/&gt;
08/09/17 16:49:31 INFO hbase.ManyPerformanceEvaluation: 20 36744&lt;br/&gt;
08/09/17 16:50:06 INFO hbase.ManyPerformanceEvaluation: 30 34928&lt;br/&gt;
08/09/17 16:50:40 INFO hbase.ManyPerformanceEvaluation: 40 34150&lt;br/&gt;
08/09/17 16:51:14 INFO hbase.ManyPerformanceEvaluation: 50 33664&lt;br/&gt;
08/09/17 16:51:47 INFO hbase.ManyPerformanceEvaluation: 60 33570&lt;br/&gt;
08/09/17 16:52:21 INFO hbase.ManyPerformanceEvaluation: 70 33142&lt;br/&gt;
08/09/17 16:52:54 INFO hbase.ManyPerformanceEvaluation: 80 32901&lt;br/&gt;
08/09/17 16:53:26 INFO hbase.ManyPerformanceEvaluation: 90 32864&lt;br/&gt;
08/09/17 16:53:59 INFO hbase.ManyPerformanceEvaluation: 100 32776&lt;br/&gt;
08/09/17 16:54:32 INFO hbase.ManyPerformanceEvaluation: 110 32725&lt;br/&gt;
08/09/17 16:55:05 INFO hbase.ManyPerformanceEvaluation: 120 32747&lt;br/&gt;
08/09/17 16:55:38 INFO hbase.ManyPerformanceEvaluation: 130 32698&lt;br/&gt;
08/09/17 16:56:10 INFO hbase.ManyPerformanceEvaluation: 140 32693&lt;br/&gt;
08/09/17 16:56:43 INFO hbase.ManyPerformanceEvaluation: 150 32643&lt;br/&gt;
08/09/17 16:57:16 INFO hbase.ManyPerformanceEvaluation: 160 32686&lt;br/&gt;
08/09/17 16:57:48 INFO hbase.ManyPerformanceEvaluation: 170 32665&lt;br/&gt;
08/09/17 16:58:21 INFO hbase.ManyPerformanceEvaluation: 180 32448&lt;br/&gt;
08/09/17 16:58:53 INFO hbase.ManyPerformanceEvaluation: 190 32004&lt;br/&gt;
08/09/17 16:59:25 INFO hbase.ManyPerformanceEvaluation: 200 31985&lt;br/&gt;
08/09/17 16:59:57 INFO hbase.ManyPerformanceEvaluation: 210 31964&lt;br/&gt;
08/09/17 17:00:29 INFO hbase.ManyPerformanceEvaluation: 220 31983&lt;br/&gt;
08/09/17 17:01:01 INFO hbase.ManyPerformanceEvaluation: 230 31778&lt;br/&gt;
08/09/17 17:01:32 INFO hbase.ManyPerformanceEvaluation: 240 31766&lt;br/&gt;
08/09/17 17:02:04 INFO hbase.ManyPerformanceEvaluation: 250 31886&lt;br/&gt;
08/09/17 17:02:36 INFO hbase.ManyPerformanceEvaluation: 260 31773&lt;br/&gt;
08/09/17 17:03:08 INFO hbase.ManyPerformanceEvaluation: 270 31709&lt;br/&gt;
08/09/17 17:03:40 INFO hbase.ManyPerformanceEvaluation: 280 31669&lt;br/&gt;
08/09/17 17:04:11 INFO hbase.ManyPerformanceEvaluation: 290 31647&lt;br/&gt;
08/09/17 17:04:43 INFO hbase.ManyPerformanceEvaluation: 300 31634&lt;br/&gt;
08/09/17 17:05:15 INFO hbase.ManyPerformanceEvaluation: 310 31674&lt;br/&gt;
08/09/17 17:05:47 INFO hbase.ManyPerformanceEvaluation: 320 31935&lt;br/&gt;
08/09/17 17:06:18 INFO hbase.ManyPerformanceEvaluation: 330 31802&lt;br/&gt;
08/09/17 17:06:50 INFO hbase.ManyPerformanceEvaluation: 340 31571&lt;br/&gt;
08/09/17 17:07:21 INFO hbase.ManyPerformanceEvaluation: 350 31484&lt;br/&gt;
08/09/17 17:07:53 INFO hbase.ManyPerformanceEvaluation: 360 31713&lt;br/&gt;
08/09/17 17:08:25 INFO hbase.ManyPerformanceEvaluation: 370 31512&lt;br/&gt;
08/09/17 17:08:56 INFO hbase.ManyPerformanceEvaluation: 380 31456&lt;br/&gt;
08/09/17 17:09:28 INFO hbase.ManyPerformanceEvaluation: 390 32055&lt;br/&gt;
08/09/17 17:10:01 INFO hbase.ManyPerformanceEvaluation: 400 32260&lt;br/&gt;
08/09/17 17:10:33 INFO hbase.ManyPerformanceEvaluation: 410 32167&lt;br/&gt;
08/09/17 17:11:05 INFO hbase.ManyPerformanceEvaluation: 420 31962&lt;br/&gt;
08/09/17 17:11:37 INFO hbase.ManyPerformanceEvaluation: 430 32003&lt;br/&gt;
08/09/17 17:12:09 INFO hbase.ManyPerformanceEvaluation: 440 32054&lt;br/&gt;
08/09/17 17:12:41 INFO hbase.ManyPerformanceEvaluation: 450 32105&lt;br/&gt;
08/09/17 17:13:13 INFO hbase.ManyPerformanceEvaluation: 460 32126&lt;br/&gt;
08/09/17 17:13:45 INFO hbase.ManyPerformanceEvaluation: 470 31961&lt;br/&gt;
08/09/17 17:14:17 INFO hbase.ManyPerformanceEvaluation: 480 31968&lt;br/&gt;
...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It seems that 2000 was an overkill. The gain is impressive between 1 and 10 then around 300 we pretty much reduced the RPC call at it&apos;s smallest value.&lt;/p&gt;</comment>
                            <comment id="12632197" author="jdcryans" created="Thu, 18 Sep 2008 12:55:33 +0000"  >&lt;p&gt;A chart I did with numbers from 1 to 30 with an increment of 1. It speaks for itself, the RPCs are killing us.&lt;/p&gt;</comment>
                            <comment id="12633543" author="stack" created="Mon, 22 Sep 2008 22:32:38 +0000"  >&lt;p&gt;Thanks for fixing the hbase-default.xml.  While you are at it, remove the triplication of hbase.regionserver.dns.interface property?&lt;/p&gt;

&lt;p&gt;Do you want to make the default &amp;gt; 2 for hbase.client.scanner.caching?  Make it 3 or 5 or 10?&lt;/p&gt;

&lt;p&gt;Minor issue: these two private data members could be made final?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; LinkedList&amp;lt;RowResult&amp;gt; cache;
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; scannerCaching;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For scannerCaching, could declare and assign in the one go rather than wait on the Constructor?&lt;/p&gt;

&lt;p&gt;Patch looks great.  After addressing what you think important from above, go commit it.&lt;/p&gt;
</comment>
                            <comment id="12633558" author="dogacan" created="Mon, 22 Sep 2008 23:20:16 +0000"  >&lt;p&gt;I obviously am not comfortable with this code as any of you, but I have a few questions:&lt;/p&gt;

&lt;p&gt;1) This patch adds a new method to HRegionInterface, shouldn&apos;t versionID be bumped?&lt;br/&gt;
2) I don&apos;t understand this part (frankly, this code is in hbase before this patch, but still&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.....
        HbaseMapWritable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [], Cell&amp;gt; values
          = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HbaseMapWritable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [], Cell&amp;gt;();
        HStoreKey key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HStoreKey();
        TreeMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [], Cell&amp;gt; results =
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [], Cell&amp;gt;(Bytes.BYTES_COMPARATOR);
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (s.next(key, results)) {
          values.putAll(results);
......
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why pass results to s.next and then put everything into values? Instance values is already a SortedMap, we can directly pass values into s.next?&lt;/p&gt;

&lt;p&gt;3) In ClientScanner#next, I think, if this.closed == true then method should not try to read any more rows and just serve what is left in its cache, no? (Because in close(), ClientScanner set closed to true and then makes callable a null)&lt;/p&gt;</comment>
                            <comment id="12633591" author="jdcryans" created="Tue, 23 Sep 2008 01:36:04 +0000"  >&lt;p&gt;@stack&lt;/p&gt;

&lt;p&gt;Regards hbase-defaults, will do. Regards default value, I think 30 would be great as the test shows. Ok for final. Regards scannerCaching, not sure of what you mean when saying &quot;in the one go&quot;.&lt;/p&gt;

&lt;p&gt;@ Dogacan&lt;/p&gt;

&lt;p&gt;1- Good question regards versionID, I&apos;m not sure myself so thanks for pointing out.&lt;/p&gt;

&lt;p&gt;2- It would seem yes.&lt;/p&gt;

&lt;p&gt;3- It will not read anymore anyways :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cache.size() == 0 &amp;amp;&amp;amp; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.closed) {
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cache.size() == 0) {
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it will empty the cache and then (cache.size() == 0 &amp;amp;&amp;amp; this.closed) will be true.&lt;/p&gt;

&lt;p&gt;Thank you both for the review, this is really appreciated!&lt;/p&gt;</comment>
                            <comment id="12633609" author="stack" created="Tue, 23 Sep 2008 03:53:49 +0000"  >&lt;p&gt;On Do&#287;acan&apos;s first two comments:&lt;/p&gt;

&lt;p&gt;1. Yes. It should.  Good one.&lt;br/&gt;
2. Yes again, if it&apos;ll work.&lt;/p&gt;

&lt;p&gt;On &apos;in the one go&apos;, declare and assign on the one line as in:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; scannerCaching = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SomethingQueue&amp;lt;Blah, Blah&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12633754" author="jdcryans" created="Tue, 23 Sep 2008 14:51:31 +0000"  >&lt;p&gt;Committed to trunk.&lt;/p&gt;

&lt;p&gt;SVN comments: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
HBASE-887 Fix a hotspot in scanners
M    conf/hbase-&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.xml
Added a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; config hbase.client.scanner.caching, fixed triplification
M    src/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
Implements &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; next(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) method &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; batching
M    src/java/org/apache/hadoop/hbase/ipc/HRegionInterface.java
Defines that &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; next(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) method
M    src/java/org/apache/hadoop/hbase/client/HTable.java
Adds &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; property that is passed to scanners. ClientScanner now handles caching of rows
M    src/java/org/apache/hadoop/hbase/client/MetaScanner.java
Small changes related to ScannerCallable
M    src/java/org/apache/hadoop/hbase/client/HConnectionManager.java
Same sort of small changes
M    src/java/org/apache/hadoop/hbase/client/ScannerCallable.java
Now modified because of &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; methods in HRS, will be able to handle caching
M    src/java/org/apache/hadoop/hbase/client/transactional/TransactionalTable.java
Passes caching to its &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; class
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12634611" author="streamy" created="Thu, 25 Sep 2008 20:47:22 +0000"  >&lt;p&gt;These tests are just done naively using the shell count and scan.&lt;/p&gt;

&lt;p&gt;Will continue with better testing next week.&lt;/p&gt;</comment>
                            <comment id="12635214" author="streamy" created="Sun, 28 Sep 2008 04:58:41 +0000"  >&lt;p&gt;In additional testing, I&apos;ve uncovered a very strange behavior running on 0.19 trunk that does not happen in 0.18 branch.&lt;/p&gt;

&lt;p&gt;This is the only issue I know of that could cause this problem.&lt;/p&gt;

&lt;p&gt;Will provide more info tomorrow and file new jira.&lt;/p&gt;</comment>
                            <comment id="12640853" author="yedingding@gmail.com" created="Sun, 19 Oct 2008 17:23:51 +0000"  >&lt;p&gt;Should we add the api to get multiple rows once depends on User&apos;s choice in HTable#ClientScanner?&lt;/p&gt;

&lt;p&gt;Now the api is public RowResult next() throws IOException;&lt;/p&gt;

&lt;p&gt;It will try to get HTable.this.scannerCaching at once.&lt;/p&gt;

&lt;p&gt;Is this meaningful to add the method&lt;/p&gt;

&lt;p&gt;public RowResult[] next(int nbRows) throws IOException;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12390372" name="877-chart.jpg" size="24578" author="jdcryans" created="Thu, 18 Sep 2008 12:55:33 +0000"/>
                            <attachment id="12390949" name="Scanning Benchmarks.pdf" size="187469" author="streamy" created="Thu, 25 Sep 2008 20:47:22 +0000"/>
                            <attachment id="12390297" name="hbase-887-v1.patch" size="39556" author="jdcryans" created="Wed, 17 Sep 2008 19:27:30 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12407235">HBASE-959</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 22 Sep 2008 22:32:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31890</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ha27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98892</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>