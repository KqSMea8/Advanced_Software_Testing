<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:01:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-9141/HBASE-9141.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-9141] Replication Znodes Backup Tool</title>
                <link>https://issues.apache.org/jira/browse/HBASE-9141</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;While migrating to 0.96, we recommend deleting old znodes so users not face issues like &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7766&quot; title=&quot;master cannot go from 94 to 96 due to zookeeper data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7766&quot;&gt;&lt;del&gt;HBASE-7766&lt;/del&gt;&lt;/a&gt;, and let HBase create them out of box.&lt;br/&gt;
Though HBase tends to store only ephemeral data in zookeeper, replication has a different approach. Almost all of its data (state, peer info, logs, etc) is present in zookeeper. We would like to preserve them in order to not do re-adding of peers, and ensuring complete replication after we have migrated to 0.96. &lt;br/&gt;
This jira adds a tool to serialize/de-serialize replication znodes to the underlying filesystem. This could be used while migrating to 0.96.0.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12662174">HBASE-9141</key>
            <summary>Replication Znodes Backup Tool</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="4">Incomplete</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="v.himanshu">Himanshu Vashishtha</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Aug 2013 17:44:09 +0000</created>
                <updated>Wed, 22 Apr 2015 00:37:44 +0000</updated>
                            <resolved>Wed, 22 Apr 2015 00:37:44 +0000</resolved>
                                    <version>0.94.10</version>
                                                    <component>migration</component>
                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13731131" author="v.himanshu" created="Tue, 6 Aug 2013 19:15:56 +0000"  >&lt;p&gt;Patch to add replication znode migration tool. Sample usage:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
bin/hbase org.apache.hadoop.hbase.replication.ReplicationZnodesBackup -h
usage: TakeReplicationZnodesBackup [-d] [-h] [-p &amp;lt;arg&amp;gt;] [-restore]
 -d,--deleteOriginalZnodes       Delete the original replication znodes
 -h,--help                       Help
 -p,--path &amp;lt;arg&amp;gt;                 path where to store the backup file under
                                 hbase.rootdir
 -restore,--restoreFromABackup   Whether to restore replication znodes
                                 from a backup file
The backup file name is replication-znodes-backup.
In &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; no parent directory is provided, it stores the replication znodes under hbase.rootdir.
Example Usage:
 Let&apos;s say the current root hbase znode is /hbase-94. We want to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; a  backup of all the znodes under /hbase-94/replication. 
 $ $HBASE_HOME/bin/hbase org.apache.hadoop.hbase.replication.ReplicationZnodesBackup -p myBackup

It will serializes all the znodes under /hbase-94/replication to a file,replication-znodes-backup under hbase.rootdir, i.e., at &amp;lt;hbase.rootdir&amp;gt;/&amp;lt;myBackup&amp;gt;/replication-znodes-backup

 To restore a backup of replication znodes from myBackup/replication-znodes-backup
 $ $HBASE_HOME/bin/hbase org.apache.hadoop.hbase.replication.ReplicationZnodesBackup -restore -p myBackup
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This could be part of a script to do the migration to 0.96.&lt;/p&gt;</comment>
                            <comment id="13731153" author="v.himanshu" created="Tue, 6 Aug 2013 19:32:59 +0000"  >&lt;p&gt;I tested this on a local filesystem and hdfs with some replication znodes. &lt;/p&gt;

&lt;p&gt;A successful Backup run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
bin/hbase org.apache.hadoop.hbase.replication.ReplicationZnodesBackup -p myBackup
Backup Znodes file is: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:41020/hbase-0.94/myBackup/replication-znodes-backup
&lt;/span&gt;SUCCESSFULLY SERIALIZED 3 replication znodes.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the zkcli console, I do a ls of replication znode:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[zk: localhost:2181(CONNECTED) 1] ls /hbase/replication
[peers, rs]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then, I delete the /hbase/replication znode&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[zk: localhost:2181(CONNECTED) 3] rmr /hbase/replication
[zk: localhost:2181(CONNECTED) 4] ls /hbase/replication
Node does not exist: /hbase/replication
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, I restore the znode using the backup script. A successful Restore run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 bin/hbase org.apache.hadoop.hbase.replication.ReplicationZnodesBackup -restore -p myBackup
Backup Znodes file is: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:41020/hbase-0.94/myBackup/replication-znodes-backup
&lt;/span&gt;SUCCESSFULLY RESTORED 3 replication znodes.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[zk: localhost:2181(CONNECTED) 5] ls /hbase/replication
[peers, rs]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Edited (eclark): formatting by request.&lt;/p&gt;</comment>
                            <comment id="13731160" author="v.himanshu" created="Tue, 6 Aug 2013 19:35:42 +0000"  >&lt;p&gt;Doh! Can some one with edit-comment control could please edit the formatting of above comment? Somehow, I missed one {code} symbol above. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="13731165" author="eclark" created="Tue, 6 Aug 2013 19:42:35 +0000"  >&lt;p&gt;Done&lt;/p&gt;</comment>
                            <comment id="13731247" author="v.himanshu" created="Tue, 6 Aug 2013 20:51:06 +0000"  >&lt;p&gt;Thanks Elliott.&lt;/p&gt;</comment>
                            <comment id="13731295" author="yuzhihong@gmail.com" created="Tue, 6 Aug 2013 21:26:19 +0000"  >&lt;p&gt;Nice tool.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ * Copyright 2009 The Apache Software Foundation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Year is not needed.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fs != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fs.close();
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zkw != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zkw.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think this.zkw.close() should be placed in finally block.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void takeBackupOfZnodes() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ZKUtil.checkExists(zkw, baseReplicationZnode) == -1) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Add a log for the above case.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Znode z : znodesToRestore) {
+      ZKUtil.createWithParents(zkw, z.getPath(), z.getData());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Maybe in a follow-on JIRA, znodesToRestore can be sorted w.r.t. their path. This would reduce the number of recursive calls to createWithParents().&lt;/p&gt;</comment>
                            <comment id="13731498" author="jdcryans" created="Wed, 7 Aug 2013 00:43:25 +0000"  >&lt;p&gt;Any reason you went with System.out.println instead of LOG?&lt;/p&gt;

&lt;p&gt;initResources doesn&apos;t throw ZooKeeperConnectionException but it&apos;s listed.&lt;/p&gt;

&lt;p&gt;Any chance of a unit test?&lt;/p&gt;

&lt;p&gt;By default the tool should print the help if nothing is specified, right now it goes straight to initiating the resources for nothing.&lt;/p&gt;

&lt;p&gt;What happens right now if when doing recreate some znodes are already there? Should we move them aside or delete them?&lt;/p&gt;</comment>
                            <comment id="13731522" author="v.himanshu" created="Wed, 7 Aug 2013 01:17:35 +0000"  >&lt;p&gt;Thanks for the review Ted and JD.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Any reason you went with System.out.println instead of LOG?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Its a tool, ought to run by an admin on a console. I thought it is appropriate to just print it on the console. (Also consistent with other tool such as HFileV1Detector, CompactionTool, SnapshotInfo, all use System.out.println.)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;initResources doesn&apos;t throw ZooKeeperConnectionException but it&apos;s listed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This throws it&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
zkw = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperWatcher(getConf(), &lt;span class=&quot;code-quote&quot;&gt;&quot;ReplicationZnodesSnapshot&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReplicationZnodesSnapshotAbortable());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;By default the tool should print the help if nothing is specified, right now it goes straight to initiating the resources for nothing.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The help option is with -h, --h, or --help. By default, it goes on to take a backup (So, it does &quot;something&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ). No strong opinion here, I could change it to just print help. Please let me know what you think.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What happens right now if when doing recreate some znodes are already there? Should we move them aside or delete them?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If znode is there, it doesn&apos;t do anything. My idea of the usage of this tool is:&lt;br/&gt;
1) A user takes a backup.&lt;br/&gt;
2) On success message (grep for &quot;SUCCESSFULLY SERIALIZED&quot; in the o/p), deletes the current znodes.&lt;br/&gt;
3) Restore the znodes from the backup.&lt;br/&gt;
4) On success message (grep for &quot;SUCCESSFULLY RESTORED&quot; in the o/p), delete the backup file.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Any chance of a unit test?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Hmm, that&apos;s a bit tricky I think. I would try to come up with one.&lt;/p&gt;</comment>
                            <comment id="13732764" author="jdcryans" created="Wed, 7 Aug 2013 21:23:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;This throws it&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ugh you&apos;re right but this is kinda dumb since ZKCE is a IOE.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If znode is there, it doesn&apos;t do anything. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I haven&apos;t tried it but I don&apos;t see the check in the code, it just tries to create the znodes in recreateZnodes(). Have you tried it?&lt;/p&gt;

&lt;p&gt;Also, where you do mention in the tool that the znodes need to be deleted by the user? Can we not rely on having the user doing it and move them aside for them?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Hmm, that&apos;s a bit tricky I think. I would try to come up with one.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t see how, you just need ZK and the local filesystem. Are you saying this because it needs to read the old format?&lt;/p&gt;</comment>
                            <comment id="13732845" author="v.himanshu" created="Wed, 7 Aug 2013 22:27:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;I haven&apos;t tried it but I don&apos;t see the check in the code, it just tries to create the znodes in recreateZnodes(). Have you tried it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I have tested it locally. It calls createWithParents, so if a znode is already there, it will not re-create it. &lt;br/&gt;
We may update the data in case there is some error while creating (&lt;a href=&quot;https://github.com/apache/hbase/blob/trunk/hbase-client/src/main/java/org/apache/hadoop/hbase/zookeeper/RecoverableZooKeeper.java#L446&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/hbase/blob/trunk/hbase-client/src/main/java/org/apache/hadoop/hbase/zookeeper/RecoverableZooKeeper.java#L446&lt;/a&gt;), but given the use case here, we would be deleting before restoring the backup so it should be safe.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Can we not rely on having the user doing it and move them aside for them?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There is no api to &quot;move&quot; znodes in ZK. A user can pass a &quot;-d&quot; (deleteOriginalZnodes) flag to delete the current znodes after taking the backup. See the help comment above.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Are you saying this because it needs to read the old format?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. Thinking more, testing with new format would be good too. Let me write one.&lt;/p&gt;

&lt;p&gt;Will also take care of nits mentioned by Ted and JD in the next version.&lt;/p&gt;</comment>
                            <comment id="13733693" author="v.himanshu" created="Thu, 8 Aug 2013 17:06:03 +0000"  >&lt;p&gt;The attached patch has the following changes:&lt;/p&gt;

&lt;p&gt;1) Include a test cases where it create-&lt;del&gt;&amp;gt;serializes&lt;/del&gt;&lt;del&gt;&amp;gt;delete existing&lt;/del&gt;-&amp;gt; restores znodes. It checks whether the data is restored or not, etc.&lt;/p&gt;

&lt;p&gt;2) The znodes are saved with relative path, starting from replication base znode (by default, from replication/). This is useful in case a user wants to &lt;br/&gt;
restore under a different hbase root znode.&lt;/p&gt;

&lt;p&gt;3) Options to delete existing znode (after taking the backup, or before restoring the znodes); option to delete the backup file after successful restoration.&lt;/p&gt;

&lt;p&gt;4) Other nits suggested by Ted. More help documentation on &quot;moving&quot; znodes.&lt;/p&gt;
</comment>
                            <comment id="13733765" author="hadoopqa" created="Thu, 8 Aug 2013 17:54:38 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12596879/HBase-9141-v1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12596879/HBase-9141-v1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop1.0&lt;/font&gt;.  The patch compiles against the hadoop 1.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop2.0&lt;/font&gt;.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 javadoc&lt;/font&gt;.  The javadoc tool appears to have generated 18 warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.TestCheckTestClasses&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/6656//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13733824" author="v.himanshu" created="Thu, 8 Aug 2013 18:44:25 +0000"  >&lt;p&gt;Added category to pass the tests.&lt;/p&gt;</comment>
                            <comment id="13733849" author="v.himanshu" created="Thu, 8 Aug 2013 19:06:55 +0000"  >&lt;p&gt;Trying it again.&lt;/p&gt;</comment>
                            <comment id="13733856" author="v.himanshu" created="Thu, 8 Aug 2013 19:11:13 +0000"  >&lt;p&gt;I am sorry for re-adding the attachment folks; I figured out lately that I didn&apos;t attach the right one earlier. Thanks.&lt;/p&gt;</comment>
                            <comment id="13733907" author="jdcryans" created="Thu, 8 Aug 2013 19:55:47 +0000"  >&lt;p&gt;Good progress here. &lt;/p&gt;

&lt;p&gt;I&apos;d be ok committing although thinking more about it might be good to not put the znodes in place right away, so create them elsewhere and then move them in place all at once? Or am I just being over-cautious?&lt;/p&gt;

&lt;p&gt;Also the unit test could cover more than the normal path. Right now if anything goes wrong you get into untested code paths.&lt;/p&gt;

&lt;p&gt;What do you think Himanshu?&lt;/p&gt;</comment>
                            <comment id="13734502" author="v.himanshu" created="Fri, 9 Aug 2013 07:13:52 +0000"  >&lt;p&gt;I think you raised some good questions. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It might be good to not put the znodes in place right away, &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The intended use of this tool is to do a backup of znodes, and restore them. IMHO, they are two separate commands (like along the lines of taking snapshot of a table, and then cloning a snapshot, etc). If we use -backup and -restore options separately, we don&apos;t have to do in place replacement. While restoring, you could define any arbitrary znode as the would-be-parent znode and the replication znodes would be restored under that znode (please refer to the move section).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;so create them elsewhere and then move them in place all at once?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The main concern is what happens when we fail in b/w restoring. We don&apos;t want to do any guessing about our last-failed-restore command (what happens if it fails in b/w? do we have incomplete znodes, etc?). One way to avoid that is pass -deleteOldZnode option to the restore command. That would ensure that we delete any previous znode before starting the restore process. I could make that a default option in restore command. Otherwise, if we truly want to be atomic while restoring, I think, we could make use of ZK multi api.&lt;br/&gt;
Let me know if that is what you were thinking about. Thanks.&lt;/p&gt;</comment>
                            <comment id="13735719" author="rajesh23" created="Sat, 10 Aug 2013 03:50:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=v.himanshu&quot; class=&quot;user-hover&quot; rel=&quot;v.himanshu&quot;&gt;Himanshu Vashishtha&lt;/a&gt;&lt;br/&gt;
Its really good tool. &lt;br/&gt;
I have some doubts here, may be silly.&lt;br/&gt;
-&amp;gt;while restoring don&apos;t we need to convert to PB after migrating to 0.96.0 ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Restoring znode: &quot;&lt;/span&gt; + z);

      ZKUtil.createWithParents(zkw, ZKUtil.joinZNode(baseZnode, z.getPath()), z.getData());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;-&amp;gt; After migration, lets suppose hlogs are splitted and recovered properly, then still they will be archived to continue replication even if we dont have replication znodes(peers,queues)? Is this scenario can happen with little delay in restoring replication znodes? I am new to replication.&lt;/p&gt;







</comment>
                            <comment id="13737159" author="stack" created="Mon, 12 Aug 2013 18:21:22 +0000"  >&lt;p&gt;Why can&apos;t this tool backup the disabled table znodes too?&lt;/p&gt;</comment>
                            <comment id="13737611" author="v.himanshu" created="Tue, 13 Aug 2013 00:22:40 +0000"  >&lt;p&gt;Thanks for the questions Rajesh.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;-&amp;gt;while restoring don&apos;t we need to convert to PB after migrating to 0.96.0 &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. Somehow, I missed that we need to call explicitly to pre-append the pb magic. I would say we should add the pb magic in RecoverableZookeeper.appendMetaData(byte[] data), which is called for every znode we create.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;second question.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not sure I follow your question correctly. The idea is to run this tool &lt;b&gt;before&lt;/b&gt; the cluster is started. It is part of the migration. So, replication znodes will be there before replaying/splitting starts. Does this answer help?&lt;/p&gt;

&lt;p&gt;Stack: Do we have the same format for enable/disable table znode (other than pb)? That is, the znode name is same b/w 0.92/0.94 vs 0.96. I am not sure about this, but I did see some extra znodes while testing this tool against 0.94 (table92, enabledisable, etc). If we want to save them, could it be done in a follow up jira? Please let me know if you think otherwise.&lt;/p&gt;

&lt;p&gt;Let me test the patch on a real 0.94, replication enabled cluster. I will upload the patch after testing.&lt;/p&gt;</comment>
                            <comment id="13738877" author="jdcryans" created="Tue, 13 Aug 2013 21:44:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;One way to avoid that is pass -deleteOldZnode option to the restore command. That would ensure that we delete any previous znode before starting the restore process. I could make that a default option in restore command.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m more concerned if the operator someone messes up and starts the cluster with like half the znodes.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Otherwise, if we truly want to be atomic while restoring, I think, we could make use of ZK multi api.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes.&lt;/p&gt;</comment>
                            <comment id="13739921" author="stack" created="Wed, 14 Aug 2013 17:36:52 +0000"  >&lt;p&gt;On multi, the zk ensemble involved may not support multi (there is a config. to set to say it does so only use it then).&lt;/p&gt;

&lt;p&gt;How does this relate to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; work on  migration script?  Is this to be integrated?  He seems to update stuff in place?  Does that mean this work redundant (I haven&apos;t looked closely)&lt;/p&gt;</comment>
                            <comment id="13740055" author="v.himanshu" created="Wed, 14 Aug 2013 19:05:36 +0000"  >&lt;p&gt;Yes, for this I avoided using multi here. And, using -deleteOldZnode option, we would not need it as it will remove any leftover znodes from the previous run. The upgrade is not considered complete if there is some error while doing it. And in case of any exception while doing it, it throws the error. So, a user would run it again unless it is successful.&lt;/p&gt;

&lt;p&gt;For the overlap, if we go the route of upgrading znodes to pb, we don&apos;t need this. If we go the route of clearing zk data and letting hbase re-create it, we do need this.&lt;/p&gt;

&lt;p&gt;I know the above statement is open as to how we want to handle old znodes (transform or re-create). I would like to let hbase re-create them (just start afresh), but let me take a closer look at the protobuffing route.&lt;/p&gt;</comment>
                            <comment id="13747253" author="stack" created="Thu, 22 Aug 2013 05:36:04 +0000"  >&lt;p&gt;Moving out.  We are not going to use this migrating, right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=himanshu%40cloudera.com&quot; class=&quot;user-hover&quot; rel=&quot;himanshu@cloudera.com&quot;&gt;Himanshu Vashishtha&lt;/a&gt; - but it might be of general use down the road.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12596906" name="HBase-9141-v1.patch" size="21585" author="v.himanshu" created="Thu, 8 Aug 2013 19:06:55 +0000"/>
                            <attachment id="12596405" name="HBase-9141.patch" size="13552" author="v.himanshu" created="Tue, 6 Aug 2013 19:14:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 6 Aug 2013 19:42:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342178</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 17 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n0g7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342483</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>