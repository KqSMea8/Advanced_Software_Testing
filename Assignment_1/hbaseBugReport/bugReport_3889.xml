<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:14:01 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3889/HBASE-3889.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3889] NPE in Distributed Log Splitting</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3889</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;There is an issue with the log splitting under the specific condition of edits belonging to a non existing region (which went away after a split for example). The HLogSplitter fails to check the condition, which is handled on a lower level, logging manifests it as &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2011-05-16 13:56:10,300 INFO org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: This region&apos;s directory doesn&apos;t exist: hdfs://localhost:8020/hbase/usertable/30c4d0a47703214845d0676d0c7b36f0. It is very likely that it was already split so it&apos;s safe to discard those edits.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The code returns a null reference which is not check in HLogSplitter.splitLogFileToTemp():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
        WriterAndPath wap = (WriterAndPath)o;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wap == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          wap = createWAP(region, entry, rootDir, tmpname, fs, conf);
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wap == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            logWriters.put(region, BAD_WRITER);
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            logWriters.put(region, wap);
          }
        }
        wap.w.append(entry);
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The createWAP does return &quot;null&quot; when the above message is logged based on the obsolete region reference in the edit.&lt;/p&gt;

&lt;p&gt;What made this difficult to detect is that the error (and others) are silently ignored in SplitLogWorker.grabTask(). I added a catch and error logging to see the NPE that was caused by the above.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
      LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;An error occurred.&quot;&lt;/span&gt;, e);
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &amp;gt; 0) {
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As a side note, there are other errors/asserts triggered that this try/finally not handles. For example&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2011-05-16 13:58:30,647 WARN org.apache.hadoop.hbase.regionserver.SplitLogWorker: BADVERSION failed to assert ownership for /hbase/splitlog/hdfs%3A%2F%2Flocalhost%2Fhbase%2F.logs%2F10.0.0.65%2C60020%2C1305406356765%2F10.0.0.65%252C60020%252C1305406356765.1305409968389
org.apache.zookeeper.KeeperException$BadVersionException: KeeperErrorCode = BadVersion for /hbase/splitlog/hdfs%3A%2F%2Flocalhost%2Fhbase%2F.logs%2F10.0.0.65%2C60020%2C1305406356765%2F10.0.0.65%252C60020%252C1305406356765.1305409968389
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:106)
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:42)
        at org.apache.zookeeper.ZooKeeper.setData(ZooKeeper.java:1038)
        at org.apache.hadoop.hbase.regionserver.SplitLogWorker.ownTask(SplitLogWorker.java:329)
        at org.apache.hadoop.hbase.regionserver.SplitLogWorker.access$100(SplitLogWorker.java:68)
        at org.apache.hadoop.hbase.regionserver.SplitLogWorker$2.progress(SplitLogWorker.java:265)
        at org.apache.hadoop.hbase.regionserver.wal.HLogSplitter.splitLogFileToTemp(HLogSplitter.java:432)
        at org.apache.hadoop.hbase.regionserver.wal.HLogSplitter.splitLogFileToTemp(HLogSplitter.java:354)
        at org.apache.hadoop.hbase.regionserver.SplitLogWorker$1.exec(SplitLogWorker.java:113)
        at org.apache.hadoop.hbase.regionserver.SplitLogWorker.grabTask(SplitLogWorker.java:260)
        at org.apache.hadoop.hbase.regionserver.SplitLogWorker.taskLoop(SplitLogWorker.java:191)
        at org.apache.hadoop.hbase.regionserver.SplitLogWorker.run(SplitLogWorker.java:164)
        at java.lang.Thread.run(Thread.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This should probably be handled - or at least documented - in another issue?&lt;/p&gt;

&lt;p&gt;The NPE made the log split end and the SplitLogManager add an endless amount of RESCAN entries as this never came to an end.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Pseudo-distributed on MacOS&lt;/p&gt;</environment>
        <key id="12507352">HBASE-3889</key>
            <summary>NPE in Distributed Log Splitting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anirudhtodi">Anirudh Todi</assignee>
                                    <reporter username="larsgeorge">Lars George</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 May 2011 12:13:06 +0000</created>
                <updated>Fri, 20 Nov 2015 12:43:08 +0000</updated>
                            <resolved>Thu, 16 Jun 2011 20:38:27 +0000</resolved>
                                    <version>0.92.0</version>
                                    <fixVersion>0.92.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13033991" author="larsgeorge" created="Mon, 16 May 2011 12:27:03 +0000"  >&lt;p&gt;Trivial patch, skips null reference, discarding the obsolete edit.&lt;/p&gt;</comment>
                            <comment id="13033994" author="larsgeorge" created="Mon, 16 May 2011 12:32:19 +0000"  >&lt;p&gt;After adding the patch I got eventually this&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
2011-05-16 14:15:31,428 DEBUG org.apache.hadoop.hbase.monitoring.MonitoredTask: markComplete: processed 50012 edits across 47 regions threw away edits for 13 regions log file = hdfs://localhost/hbase/.logs/10.0.0.65,60020,1305406356765/10.0.0.65%2C60020%2C1305406356765.1305409968389 is corrupted = false
2011-05-16 14:15:31,428 DEBUG org.apache.hadoop.hbase.regionserver.SplitLogWorker: After Exec Status: DONE
2011-05-16 14:15:31,429 INFO org.apache.hadoop.hbase.regionserver.SplitLogWorker: successfully transitioned task /hbase/splitlog/hdfs%3A%2F%2Flocalhost%2Fhbase%2F.logs%2F10.0.0.65%2C60020%2C1305406356765%2F10.0.0.65%252C60020%252C1305406356765.1305409968389 to final state done
2011-05-16 14:15:31,429 INFO org.apache.hadoop.hbase.regionserver.SplitLogWorker: worker 10.0.0.64,60020,1305546944326 done with task /hbase/splitlog/hdfs%3A%2F%2Flocalhost%2Fhbase%2F.logs%2F10.0.0.65%2C60020%2C1305406356765%2F10.0.0.65%252C60020%252C1305406356765.1305409968389 in 879381ms
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This was a 15GB edits that lingered since I had a crashed YSCB bulk load. The extra messages above are from log statements I added everywhere to see what is going on (might make sense to add a debug level output of MonitoredTaskImpl.setStatus(), was helpful here to see where it got lost).&lt;/p&gt;</comment>
                            <comment id="13034032" author="tlipcon" created="Mon, 16 May 2011 14:35:24 +0000"  >&lt;p&gt;Unit test?&lt;/p&gt;</comment>
                            <comment id="13034139" author="khemani" created="Mon, 16 May 2011 17:40:10 +0000"  >&lt;p&gt;Thanks Lars for finding and providing a fix for this issue. I have a few minor comments on the patch ...&lt;/p&gt;

&lt;p&gt;The following isn&apos;t really needed, the earlier check you put in should be good enough.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wap == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+          &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;It might be better to catch Throwable in SplitLogWorker.run() and print the Unexpected Error message there. It might not be a good thing to ignore an unexpected exception in SplitLogWorker.grabTask() and continue.&lt;/p&gt;
{nofrmat}
&lt;p&gt;+++ src/main/java/org/apache/hadoop/hbase/regionserver/SplitLogWorker.java	(working copy)&lt;br/&gt;
@@ -297,6 +297,8 @@&lt;br/&gt;
           }&lt;br/&gt;
           break;&lt;br/&gt;
       }&lt;br/&gt;
+    } catch (Exception e) &lt;/p&gt;
{
+      LOG.error(&quot;An error occurred.&quot;, e);
     }
&lt;p&gt; finally {&lt;br/&gt;
       if (t &amp;gt; 0) {&lt;br/&gt;
         LOG.info(&quot;worker &quot; + serverName + &quot; done with task &quot; + path +&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


</comment>
                            <comment id="13034222" author="larsgeorge" created="Mon, 16 May 2011 19:31:31 +0000"  >&lt;p&gt;Hi Prakash, the issue I had was a second RegionServer process running and still giving me this error. I only had the extra &quot;continue&quot;, but it wasn&apos;t picked up. I forgot to remove the second &quot;if&quot;. I agree on the error handling, I just added the log to get some info. &lt;/p&gt;

&lt;p&gt;I guess I shouldn&apos;t have made the patch available through JIRA but simply attach it for someone to pick up. I am on a tight deadline right now and won&apos;t be able to work on a unit test - although I would love to help out, once I get my current assignment completed.&lt;/p&gt;</comment>
                            <comment id="13034223" author="larsgeorge" created="Mon, 16 May 2011 19:32:06 +0000"  >&lt;p&gt;Patch is too simplistic and needs little cleanup and better error handling, plus should have a unit test.&lt;/p&gt;</comment>
                            <comment id="13034341" author="stack" created="Mon, 16 May 2011 21:36:14 +0000"  >&lt;p&gt;Marking critical.  I&apos;ll pick up where Lars left off (with some help from Prakash).  Thanks Lars.&lt;/p&gt;</comment>
                            <comment id="13046662" author="anirudhtodi" created="Thu, 9 Jun 2011 16:38:23 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I am working with Prakash on this. I hope to soon post a unit test.&lt;/p&gt;

&lt;p&gt;Anirudh&lt;/p&gt;</comment>
                            <comment id="13047797" author="anirudhtodi" created="Sat, 11 Jun 2011 00:12:53 +0000"  >&lt;p&gt;Submitting a unit test for the above issue&lt;/p&gt;</comment>
                            <comment id="13049398" author="stack" created="Tue, 14 Jun 2011 20:42:02 +0000"  >&lt;p&gt;@Anirudh Test looks good.  Do you want to include in your patch Lars fix or you want me to apply that separate?  Do you want to redo it addressing issues raised by Prakash (while considering Lars&apos; follow up?)&lt;/p&gt;</comment>
                            <comment id="13049594" author="anirudhtodi" created="Wed, 15 Jun 2011 03:36:54 +0000"  >&lt;p&gt;Submitting patch with Lars fix, including Prakash&apos;s comments and my unit test.&lt;/p&gt;</comment>
                            <comment id="13050716" author="stack" created="Thu, 16 Jun 2011 20:38:27 +0000"  >&lt;p&gt;Thank you for the patch Anirudh (I added you as contributor and assigned you this issue).  Nice test.  Committed to TRUNK.&lt;/p&gt;</comment>
                            <comment id="13050878" author="anirudhtodi" created="Fri, 17 Jun 2011 02:58:50 +0000"  >&lt;p&gt;Thanks Stack and Prakash. i look forward to contributing more in the future.&lt;/p&gt;</comment>
                            <comment id="15017439" author="lars_francke" created="Fri, 20 Nov 2015 12:43:08 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12507361">HBASE-3890</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12424367">HBASE-1364</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12479320" name="HBASE-3889.patch" size="1343" author="larsgeorge" created="Mon, 16 May 2011 12:27:03 +0000"/>
                            <attachment id="12482637" name="combined-patch.txt" size="4508" author="anirudhtodi" created="Wed, 15 Jun 2011 03:36:54 +0000"/>
                            <attachment id="12482121" name="patch.txt" size="2009" author="anirudhtodi" created="Sat, 11 Jun 2011 00:12:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 16 May 2011 14:35:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27074</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05i6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30042</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>