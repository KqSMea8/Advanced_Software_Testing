<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:18:22 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4377/HBASE-4377.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4377] [hbck] Offline rebuild .META. from fs data only.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4377</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In a worst case situation, it may be helpful to have an offline .META. rebuilder that just looks at the file system&apos;s .regioninfos and rebuilds meta from scratch.  Users could move bad regions out until there is a clean rebuild.  &lt;/p&gt;

&lt;p&gt;It would likely fill in region split holes.  Follow on work could given options to merge or select regions that overlap, or do online rebuilds.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12522826">HBASE-4377</key>
            <summary>[hbck] Offline rebuild .META. from fs data only.</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmhsieh">Jonathan Hsieh</assignee>
                                    <reporter username="jmhsieh">Jonathan Hsieh</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Sep 2011 23:35:46 +0000</created>
                <updated>Fri, 20 Nov 2015 11:52:57 +0000</updated>
                            <resolved>Tue, 22 Nov 2011 03:02:54 +0000</resolved>
                                    <version>0.92.0</version>
                                    <fixVersion>0.90.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13103332" author="stack" created="Tue, 13 Sep 2011 04:22:45 +0000"  >&lt;p&gt;+1 on punt to user if whats in fs has overlapping regions (user would rule what to omit).&lt;/p&gt;</comment>
                            <comment id="13113839" author="jmhsieh" created="Fri, 23 Sep 2011 23:43:34 +0000"  >&lt;p&gt;I have a very &lt;b&gt;hacky&lt;/b&gt; version that I&apos;ve successfully recently used to rebuild a .META. table with over 10k regions. It can be found here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jmhsieh/hbase/tree/hbase-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/jmhsieh/hbase/tree/hbase-4377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve also hacked the hack to backport it onto an 0.90.x branch.&lt;/p&gt;

&lt;p&gt;To run it build hbase and then use the following command line&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
bin/hbase org.apache.hadoop.hbase.util.hbck.OfflineMetaRepair -base ~/pathToHbase/hbase -details
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The program will fail telling the user about any problems it encounters. It only succeed if all the info gathered from .regioninfo&apos;s  is clean after going through the regionsplit calculator.  &lt;/p&gt;

&lt;p&gt;This code will take some time to clean up.  &lt;/p&gt;

&lt;p&gt;I would like to do some refactoring of the current hbck and create a o.a.h.hbase.util.hbck or o.a.h.hbase.hbck package.  Any preferences or concerns there?&lt;/p&gt;</comment>
                            <comment id="13116634" author="jmhsieh" created="Wed, 28 Sep 2011 17:50:57 +0000"  >&lt;p&gt;I think my plan is to postpone the large refactor until after this gets through. &lt;/p&gt;</comment>
                            <comment id="13116708" author="stack" created="Wed, 28 Sep 2011 19:13:30 +0000"  >&lt;p&gt;@Jon So you want me to review whats over in github and commit that?&lt;/p&gt;</comment>
                            <comment id="13116712" author="jmhsieh" created="Wed, 28 Sep 2011 19:20:04 +0000"  >&lt;p&gt;@stack: Not yet, I&apos;m still cleaning this up and adding tests right now.&lt;/p&gt;</comment>
                            <comment id="13116713" author="jmhsieh" created="Wed, 28 Sep 2011 19:24:01 +0000"  >&lt;p&gt;More detail &amp;#8211; I&apos;ve done a large refactor of hbck but found that then doing the changes would more difficult understand or review the offline rebuild code.  So, my plan is to add the offline rebuild code, and then potentially do a refactor afterwards.&lt;/p&gt;

&lt;p&gt;Regardless of whether the refactor happens, I feel that I need to add tests and docs for this before it is ready for review. &lt;/p&gt;</comment>
                            <comment id="13117095" author="jmhsieh" created="Thu, 29 Sep 2011 07:47:58 +0000"  >&lt;p&gt;I&apos;m having a hard time with tests that restart the test hbase mini cluster.  I start cluster, modify meta/hdfs regions, shutdown cluster, rebuild meta, and then get an NPE when restarting. &lt;/p&gt;

&lt;p&gt;Specifically, this method sometimes returns null which later causes an NPE when constructor calls &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
User.HadoopUser.&amp;lt;init&amp;gt;
  ugi = (UserGroupInformation) callStatic(&lt;span class=&quot;code-quote&quot;&gt;&quot;getCurrentUGI&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test were passing at one point but I can&apos;t seem to figure out a direct cause for why this would fail.  Any hints?  &lt;/p&gt;</comment>
                            <comment id="13117641" author="jmhsieh" created="Thu, 29 Sep 2011 21:45:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; is required for tests to pass consistently&lt;/p&gt;</comment>
                            <comment id="13117762" author="jiraposter@reviews.apache.org" created="Fri, 30 Sep 2011 00:03:45 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;


&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;

&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 8465724 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java fae0881 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuild.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;

&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;

&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13118468" author="jiraposter@reviews.apache.org" created="Fri, 30 Sep 2011 21:27:45 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/#review2231&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#review2231&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;How long did it take to scan the cluster with 2700 inconsistencies ?&lt;br/&gt;
I see certain places in the code where more parallelism can be achieved if practical use of this feature takes long time.&lt;/p&gt;


&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5180&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5180&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Better replace root with &lt;del&gt;ROOT&lt;/del&gt;&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5179&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5179&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    b is not needed here, same with question mark.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5181&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5181&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Please remove b and question mark.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5185&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5185&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    It would be nice to log the path for the underlying region.&lt;br/&gt;
    Otherwise what purpose does this catch/rethrow serve ?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5188&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5188&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    The .META. region is open upon return.&lt;br/&gt;
    I think we should document this.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5187&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5187&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Looking at the usage below, maybe createNewRootAndMeta would be a better name.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5189&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5189&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    This log doesn&apos;t match the check above.&lt;br/&gt;
    If we only produce Put for the first HbckInfo, we&apos;d better declare that in the log.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5190&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5190&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    This would produce exception if his.size() == 0.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5192&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5192&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Better use boolean for return value to indicate success/failure.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5191&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5191&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Do you plan to do this in the next patch or in another JIRA ?&lt;br/&gt;
    I haven&apos;t looked at the other JIRAs you mentioned, pardon me.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5193&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5193&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Is there something we can do in case we get IOE from this call ?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-09-30 00:02:16, jmhsieh wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-09-30 00:02:16)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 8465724 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java fae0881 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuild.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;jmhsieh&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13118480" author="jiraposter@reviews.apache.org" created="Fri, 30 Sep 2011 21:39:45 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/#review2236&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#review2236&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/#comment5194&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#comment5194&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    My comment above on the first rename call was inaccurate.&lt;br/&gt;
    IOE out of the second call would be fatal.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-09-30 00:02:16, jmhsieh wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-09-30 00:02:16)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 8465724 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java fae0881 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuild.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;jmhsieh&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13119451" author="jiraposter@reviews.apache.org" created="Mon, 3 Oct 2011 18:11:34 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; How long did it take to scan the cluster with 2700 inconsistencies ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; I see certain places in the code where more parallelism can be achieved if practical use of this feature takes long time.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The cluster that had 12k total regions after clenaup. It took 2m to run (this was localdisk accesses).  I didn&apos;t feel that the runtime was something to be concerned about.  And I honestly hope this code doesn&apos;t get used too often!&lt;/p&gt;

&lt;p&gt;We could use the same WorkItem trick to speed up the code but my feeling is that straightforward and correct is the right first step.  &lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java, line 374&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46564#file46564line374&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46564#file46564line374&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Better replace root with &lt;del&gt;ROOT&lt;/del&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java, line 376&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46564#file46564line376&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46564#file46564line376&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     b is not needed here, same with question mark.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;k&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java, line 391&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46564#file46564line391&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46564#file46564line391&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Please remove b and question mark.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;k&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 307&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line307&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line307&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     The .META. region is open upon return.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think we should document this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;changed &quot;live&quot; to &quot;open&quot;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 288&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line288&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line288&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     It would be nice to log the path for the underlying region.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Otherwise what purpose does this catch/rethrow serve ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;nice catch.  Updated to include table name and path.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 309&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line309&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line309&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Looking at the usage below, maybe createNewRootAndMeta would be a better name.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 352&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line352&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line352&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     This log doesn&apos;t match the check above.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     If we only produce Put for the first HbckInfo, we&apos;d better declare that in the log.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;updated error message and change behavior so that it bails out.  In this particular case, the invariant is checked before this method is called, but I&apos;ll just make it more explicit.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 356&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line356&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line356&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     This would produce exception if his.size() == 0.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;problem avoided with update.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 378&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line378&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line378&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Do you plan to do this in the next patch or in another JIRA ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I haven&apos;t looked at the other JIRAs you mentioned, pardon me.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ll file it as a follow-on jira.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 428&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line428&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line428&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Is there something we can do in case we get IOE from this call ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;added error logging and an attempt to revert.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 377&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46565#file46565line377&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Better use boolean for return value to indicate success/failure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;jmhsieh&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/#review2231&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#review2231&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-09-30 00:02:16, jmhsieh wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-09-30 00:02:16)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 8465724 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java fae0881 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuild.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;jmhsieh&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13119460" author="jiraposter@reviews.apache.org" created="Mon, 3 Oct 2011 18:17:37 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-10-03 18:16:51.000353)&lt;/p&gt;


&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Addressed review comments.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;


&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;

&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f5be448 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 154ac32 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuild.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;

&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;

&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13119461" author="jiraposter@reviews.apache.org" created="Mon, 3 Oct 2011 18:17:38 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-09-30 21:27:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java, line 376&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2126/diff/1/?file=46564#file46564line376&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff/1/?file=46564#file46564line376&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     b is not needed here, same with question mark.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;jmhsieh wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;k&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;javadoc form for @param is to list the parameter name, so it should be there.  agree that no question mark should be there.  i think the javadoc-y phrasing would be something like &quot;whether to enable in-memory caching or not&quot;&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/#review2231&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/#review2231&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-09-30 00:02:16, jmhsieh wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-09-30 00:02:16)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 8465724 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java fae0881 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuild.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;jmhsieh&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13119463" author="jmhsieh" created="Mon, 3 Oct 2011 18:18:40 +0000"  >&lt;p&gt;trunk version applies on 0.92 and trunk.&lt;/p&gt;</comment>
                            <comment id="13119466" author="jmhsieh" created="Mon, 3 Oct 2011 18:20:05 +0000"  >&lt;p&gt;Since the review for trunk had relatively minor issues, I&apos;m going to work on re-backporting this to the 0.90 branch.&lt;/p&gt;</comment>
                            <comment id="13119727" author="jmhsieh" created="Mon, 3 Oct 2011 23:18:03 +0000"  >&lt;p&gt;When backporting to 0.90, the TestOfflineMetaRebuild test case would fail out due to out of file handles exceptions.  I dug for a while and found that the static HConnections cached connections that are not flushed between tests.  Even after avoiding that there are other resources (maybe pooling on hdfs client or zk client connections?) that cause the open file handles count to increase significantly after every test case.  &lt;/p&gt;

&lt;p&gt;To avoid this problem, I&apos;m going to split out the each rebuild tests into own test case so that each can be executed in a new process and avoid the out of file handles problem.  I&apos;ll do this for trunk and for the 0.90 backport.&lt;/p&gt;</comment>
                            <comment id="13120561" author="jmhsieh" created="Tue, 4 Oct 2011 22:54:39 +0000"  >&lt;p&gt;Although I&apos;ve gotten this to work with live systems, it seems like that there are some problems with the testing on the backports.  Different versions have different expected values which does not seem to make sense.  &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; changed some of the semantics of the HBaseTestingUtility so I&apos;ll be investigating more.&lt;/p&gt;</comment>
                            <comment id="13120570" author="yuzhihong@gmail.com" created="Tue, 4 Oct 2011 23:07:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt; would backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; to 0.90&lt;br/&gt;
We should get consistent behavior from HBaseTestingUtility after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt; goes in.&lt;/p&gt;</comment>
                            <comment id="13121093" author="jmhsieh" created="Wed, 5 Oct 2011 16:14:22 +0000"  >&lt;p&gt;Need to test the 0.90 backport of this with the proposed backport.&lt;/p&gt;</comment>
                            <comment id="13122344" author="jmhsieh" created="Thu, 6 Oct 2011 22:01:51 +0000"  >&lt;p&gt;In the 0.90 branch, after deleting meta and restarting the # of tables present is 0.&lt;br/&gt;
In trunk and 0.92 branch, after deleting meta and restart the # of tables present is 1.  &lt;/p&gt;

&lt;p&gt;This actually does make sense because &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt; changed the behavior of HMaster &amp;#8211; in 0.90 (pre-&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt;) it HConnectionManager.listTables() loads table info on the client side via a meta scan.  Post &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt;, table data from  HConnectionManager.listTables() comes from the files system and is cached by the HMaster, and ignores the meta table.&lt;/p&gt;</comment>
                            <comment id="13122354" author="tlipcon" created="Thu, 6 Oct 2011 22:14:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;Post &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt;, table data from HConnectionManager.listTables() comes from the files system and is cached by the HMaster, and ignores the meta table&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This seems like a bug - clients should never have to have direct access to HDFS! I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4548&quot; title=&quot;Client should not look on HDFS to list tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4548&quot;&gt;&lt;del&gt;HBASE-4548&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13122367" author="jmhsieh" created="Thu, 6 Oct 2011 22:34:05 +0000"  >&lt;p&gt;@Todd,&lt;/p&gt;

&lt;p&gt;I think there is some confusion.  Clients do not directly access hdfs. Let me add more detail.&lt;/p&gt;

&lt;p&gt;In trunk post &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt;, the HMaster reads and caches data from the file system (not the client).  It then serves this the HTableDescriptors to the client rpc&apos;s  via HConnectionManager to talk to the HMaster which just ships the cached HTD data.  &lt;/p&gt;

&lt;p&gt;HMaster on initialization reads file system for HTD data.&lt;br/&gt;
Client calls listTables() -&amp;gt; HMaster (serve cached data from file system).&lt;/p&gt;

&lt;p&gt;Pre-&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt;, it the client HConnectionManager does a meta scan and builds HTableDescriptors.  &lt;/p&gt;

&lt;p&gt;Client calls listTables() which actually is a metascan and that builds htds.&lt;/p&gt;</comment>
                            <comment id="13123058" author="jiraposter@reviews.apache.org" created="Fri, 7 Oct 2011 18:48:29 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-10-07 18:47:01.208741)&lt;/p&gt;


&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;


&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;

&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 154ac32 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f5be448 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;

&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;

&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13123059" author="jiraposter@reviews.apache.org" created="Fri, 7 Oct 2011 18:48:30 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-10-07 18:46:54.806909)&lt;/p&gt;


&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Updates with nits and separated tests into different classes so that we can rely on new jvms to avoid OO file handle errors intermittently encountered when shutting down and restarting mini clusters.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;


&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;

&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 154ac32 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f5be448 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;

&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;

&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13123080" author="jiraposter@reviews.apache.org" created="Fri, 7 Oct 2011 19:06:29 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2287/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase and Ted Yu.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Backport to 0.90&lt;/p&gt;

&lt;p&gt;commit 89862b73c6358e27220b87b0362599d86ab0fe4a&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;



&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java ef246c3 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/Bytes.java 13ad026 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java b04aab6 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f792720 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2287/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Note, the assertion test result is different in the failure cases due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt; changes. (0.90 returns 0 tables since it does a meta scan on empty meta, trunk branch looks at hdfs dirs, and returns 1).&lt;/p&gt;

&lt;p&gt;This version passes after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt; (backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; to 0.90 branch) is applied. &lt;/p&gt;

&lt;p&gt;I believe if that patch is not applied, I could modify the test code to force some explicit HConnection deletions.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13123197" author="jiraposter@reviews.apache.org" created="Fri, 7 Oct 2011 21:02:31 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2287/#review2440&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/#review2440&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/#comment5546&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/#comment5546&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Minor suggestion: IOException may occur more than once. Would logging all such IOException&apos;s before bailing out make user experience better ?&lt;br/&gt;
    Basically we just need to track the last such IOException in a variable and bail out at line 283 if the variable isn&apos;t null.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/#comment5545&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/#comment5545&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Naming rd as rootdir would make the code more readable.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/#comment5548&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/#comment5548&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I think rebuildMeta() should check the return value from generatePuts().&lt;br/&gt;
    Otherwise we would encounter NPE at line 405 below.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/#comment5549&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/#comment5549&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Do you plan to add this logic in another JIRA ?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/#comment5550&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/#comment5550&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    false should be returned if puts is null.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/#comment5552&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/#comment5552&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I think LOG.info() should be used here.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-10-07 19:04:44, jmhsieh wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2287/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-10-07 19:04:44)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase and Ted Yu.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Backport to 0.90&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;commit 89862b73c6358e27220b87b0362599d86ab0fe4a&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java ef246c3 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/Bytes.java 13ad026 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java b04aab6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f792720 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2287/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Note, the assertion test result is different in the failure cases due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt; changes. (0.90 returns 0 tables since it does a meta scan on empty meta, trunk branch looks at hdfs dirs, and returns 1).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This version passes after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt; (backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; to 0.90 branch) is applied. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I believe if that patch is not applied, I could modify the test code to force some explicit HConnection deletions.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;jmhsieh&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13131286" author="jiraposter@reviews.apache.org" created="Thu, 20 Oct 2011 02:36:10 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-10-07 21:01:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 302&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line302&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line302&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Naming rd as rootdir would make the code more readable.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-10-07 21:01:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 446&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line446&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line446&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think LOG.info() should be used here.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it is still a problem, but we are in an ok state.  I&apos;ve changed it to &apos;warn&apos; instead.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-10-07 21:01:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 276&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line276&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line276&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Minor suggestion: IOException may occur more than once. Would logging all such IOException&apos;s before bailing out make user experience better ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Basically we just need to track the last such IOException in a variable and bail out at line 283 if the variable isn&apos;t null.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Updated to track all IOE&apos;s and throw MultipleIOException.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-10-07 21:01:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 346&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line346&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line346&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think rebuildMeta() should check the return value from generatePuts().&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Otherwise we would encounter NPE at line 405 below.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;see below&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-10-07 21:01:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 407&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line407&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line407&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     false should be returned if puts is null.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So I believe that checkHdfs and loadTableInfo and the error checking happens before and bails out after suggestFixes().  But sure, it doesn&apos;t really hurt here to be event more defensive.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-10-07 21:01:16, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java, line 378&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line378&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff/1/?file=48780#file48780line378&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Do you plan to add this logic in another JIRA ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have a patch that adds this but it is having problems on the trunk side.  I&apos;d like to get this in first and then then we&apos;ll deal with that next.  New issue filed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4632&quot; title=&quot;Offline meta rebuild should check if hbase is online before acting.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4632&quot;&gt;HBASE-4632&lt;/a&gt;.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;jmhsieh&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2287/#review2440&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/#review2440&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-10-07 19:04:44, jmhsieh wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2287/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-10-07 19:04:44)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for hbase and Ted Yu.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Backport to 0.90&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;commit 89862b73c6358e27220b87b0362599d86ab0fe4a&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java ef246c3 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/Bytes.java 13ad026 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java b04aab6 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f792720 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2287/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Note, the assertion test result is different in the failure cases due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt; changes. (0.90 returns 0 tables since it does a meta scan on empty meta, trunk branch looks at hdfs dirs, and returns 1).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This version passes after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt; (backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; to 0.90 branch) is applied. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I believe if that patch is not applied, I could modify the test code to force some explicit HConnection deletions.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;jmhsieh&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13131301" author="jiraposter@reviews.apache.org" created="Thu, 20 Oct 2011 03:22:10 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2287/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-10-20 03:21:33.922683)&lt;/p&gt;


&lt;p&gt;Review request for hbase and Ted Yu.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Addressed comments &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;added more logging and better error message&lt;/li&gt;
	&lt;li&gt;Handled exit properly.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Backport to 0.90&lt;/p&gt;

&lt;p&gt;commit 89862b73c6358e27220b87b0362599d86ab0fe4a&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;



&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f792720 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java ef246c3 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/Bytes.java 13ad026 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java b04aab6 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2287/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Note, the assertion test result is different in the failure cases due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt; changes. (0.90 returns 0 tables since it does a meta scan on empty meta, trunk branch looks at hdfs dirs, and returns 1).&lt;/p&gt;

&lt;p&gt;This version passes after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt; (backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; to 0.90 branch) is applied. &lt;/p&gt;

&lt;p&gt;I believe if that patch is not applied, I could modify the test code to force some explicit HConnection deletions.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13131302" author="jmhsieh" created="Thu, 20 Oct 2011 03:23:33 +0000"  >&lt;p&gt;0.90 version requires &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13131303" author="jiraposter@reviews.apache.org" created="Thu, 20 Oct 2011 03:24:10 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-10-20 03:22:39.708313)&lt;/p&gt;


&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Ported updates from comments from 0.90 branch to trunk/0.92 branch.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;


&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;

&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java b9c850d &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 7409c9c &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f5be448 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;

&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;

&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13131328" author="jmhsieh" created="Thu, 20 Oct 2011 03:47:55 +0000"  >&lt;p&gt;0.90 v4 works without having &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; on the 0.90 branch.&lt;/p&gt;</comment>
                            <comment id="13131330" author="jiraposter@reviews.apache.org" created="Thu, 20 Oct 2011 03:48:10 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2287/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-10-20 03:46:53.527042)&lt;/p&gt;


&lt;p&gt;Review request for hbase and Ted Yu.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;New version for 0.90 that does not require &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Backport to 0.90&lt;/p&gt;

&lt;p&gt;commit 89862b73c6358e27220b87b0362599d86ab0fe4a&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;



&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java ef246c3 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/Bytes.java 13ad026 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java b04aab6 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java f792720 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2287/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Note, the assertion test result is different in the failure cases due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt; changes. (0.90 returns 0 tables since it does a meta scan on empty meta, trunk branch looks at hdfs dirs, and returns 1).&lt;/p&gt;

&lt;p&gt;This version passes after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt; (backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; to 0.90 branch) is applied. &lt;/p&gt;

&lt;p&gt;I believe if that patch is not applied, I could modify the test code to force some explicit HConnection deletions.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13134851" author="anih" created="Tue, 25 Oct 2011 09:04:42 +0000"  >&lt;p&gt;It base from 0001-&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;&lt;del&gt;hbck-Offline-rebuild&lt;/del&gt;.META.&lt;del&gt;from-fs-data&lt;/del&gt;.trunk.v3.patch&lt;/p&gt;

&lt;p&gt;It have small enhancement in MetaEntry constructor, because i had realy broken testing env after recreating META i had empty TableName values, so this enhancement fill TableName from regionName, this need setTableName method in HRegionInfo class(now ith public, but its can be protect). After recreating META lastly i have testing env working again &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13135222" author="yuzhihong@gmail.com" created="Tue, 25 Oct 2011 16:49:35 +0000"  >&lt;p&gt;@Sebastian:&lt;br/&gt;
0.92 is close to release.&lt;/p&gt;

&lt;p&gt;I got the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:2.0.2:testCompile (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-testCompile) on project hbase: Compilation failure: Compilation failure:
[ERROR] /Users/zhihyu/92hbase/src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java:[277,21] doFsck(org.apache.hadoop.conf.Configuration,&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) in org.apache.hadoop.hbase.util.hbck.HbckTestingUtil cannot be applied to (&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
[ERROR] 
[ERROR] /Users/zhihyu/92hbase/src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java:[286,23] doFsck(org.apache.hadoop.conf.Configuration,&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) in org.apache.hadoop.hbase.util.hbck.HbckTestingUtil cannot be applied to (&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do you mind refresh patch for 0.92 ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13135253" author="yuzhihong@gmail.com" created="Tue, 25 Oct 2011 17:25:00 +0000"  >&lt;p&gt;Prepare for Jenkins patch testing.&lt;/p&gt;</comment>
                            <comment id="13135259" author="yuzhihong@gmail.com" created="Tue, 25 Oct 2011 17:28:07 +0000"  >&lt;p&gt;For 0001-&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;&lt;del&gt;hbck-Offline-rebuild&lt;/del&gt;.META.&lt;del&gt;from-fs-data&lt;/del&gt;.trunk.v3.patch, I got same compilation error when I tried to run tests.&lt;/p&gt;</comment>
                            <comment id="13135279" author="yuzhihong@gmail.com" created="Tue, 25 Oct 2011 17:45:14 +0000"  >&lt;p&gt;@Sebastian:&lt;br/&gt;
== shouldn&apos;t be used in comparing strings:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(Bytes.toString(getTableName())==&quot;&quot;){
+       &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] newTableName = HRegionInfo.getTableName(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getRegionName());
+       &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(Bytes.toString(newTableName)+&lt;span class=&quot;code-quote&quot;&gt;&quot;: .regioninfo doesn&apos;t have tableName value, but we are getting it from regionName :)&quot;&lt;/span&gt;);
+       &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.setTableName(newTableName);
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You can use:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getTableName() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || getTableName().length == 0) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;System.out.println should be replaced by LOG.debug()&lt;/p&gt;</comment>
                            <comment id="13135320" author="jmhsieh" created="Tue, 25 Oct 2011 18:37:40 +0000"  >&lt;p&gt;attached a non git style version of v3 of the patch.  applies on trunk and 0.92.&lt;/p&gt;</comment>
                            <comment id="13135324" author="jmhsieh" created="Tue, 25 Oct 2011 18:46:09 +0000"  >&lt;p&gt;Seb glad to hear that this basically worked for you. &lt;/p&gt;

&lt;p&gt;Would it make sense to add Seb&apos;s change as a separate jira after the original patch gets committed?  IMO, it feels like it needs a test case as well.&lt;/p&gt;
</comment>
                            <comment id="13135332" author="anih" created="Tue, 25 Oct 2011 18:54:14 +0000"  >&lt;p&gt;patch with Ted comments and corrected tests&lt;/p&gt;

&lt;p&gt;PS. for python programer it&apos;s still strange that i need to use equals not == for objects &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13135459" author="yuzhihong@gmail.com" created="Tue, 25 Oct 2011 21:50:51 +0000"  >&lt;p&gt;Sebastian&apos;s latest patch applies to 0.92 and hbck related tests passed.&lt;br/&gt;
I think we should include his enhancement.&lt;br/&gt;
Test for his scenario can be added later.&lt;/p&gt;

&lt;p&gt;@Jonathan:&lt;br/&gt;
What&apos;s your opinion ?&lt;/p&gt;</comment>
                            <comment id="13135478" author="jmhsieh" created="Tue, 25 Oct 2011 22:07:34 +0000"  >&lt;p&gt;@Ted I&apos;m basically ok wit it.  &lt;/p&gt;

&lt;p&gt;@Seb can you post some of the bad .regioninfo files?  I&apos;m curious about what you did to need to use a full rebuild!&lt;/p&gt;</comment>
                            <comment id="13135486" author="hadoopqa" created="Tue, 25 Oct 2011 22:13:54 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12500737/0001-HBASE-4377-hbck-Offline-rebuild-.META.-from-fs-data.0.92.v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12500737/0001-HBASE-4377-hbck-Offline-rebuild-.META.-from-fs-data.0.92.v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 18 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -167 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 3 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.coprocessor.TestMasterObserver&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestDistributedLogSplitting&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/66//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/66//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/66//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/66//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/66//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/66//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13135494" author="yuzhihong@gmail.com" created="Tue, 25 Oct 2011 22:22:34 +0000"  >&lt;p&gt;Some tests failed due to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.io.IOException: Too many open files
	at sun.nio.ch.IOUtil.initPipe(Native Method)
	at sun.nio.ch.EPollSelectorImpl.&amp;lt;init&amp;gt;(EPollSelectorImpl.java:49)
	at sun.nio.ch.EPollSelectorProvider.openSelector(EPollSelectorProvider.java:18)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One test failure is tracked by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4675&quot; title=&quot;TestMasterObserver#testRegionTransitionOperations fails intermittently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4675&quot;&gt;&lt;del&gt;HBASE-4675&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13135755" author="anih" created="Wed, 26 Oct 2011 06:53:38 +0000"  >&lt;p&gt;i think hbase-4377.trunk.v3.txt cannot comile because of removing doFsck(boolean) function and now we have doFsck(Configuration, boolean), so this patch correct this to. Apply clear to trunk and 0.92 &lt;/p&gt;</comment>
                            <comment id="13135757" author="anih" created="Wed, 26 Oct 2011 06:59:53 +0000"  >&lt;p&gt;If i remember both regioninfo cause problem with empty HRegionInfo.tableName. My test instance almost all time is running trunk, so many thinks could be broken &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13135758" author="hadoopqa" created="Wed, 26 Oct 2011 07:00:40 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12500832/EXT_ATU_05f84d32cbc0bdabf00e00bc2f3570f0.regioninfo&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12500832/EXT_ATU_05f84d32cbc0bdabf00e00bc2f3570f0.regioninfo&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/69//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/69//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13138902" author="yuzhihong@gmail.com" created="Fri, 28 Oct 2011 23:02:47 +0000"  >&lt;p&gt;Submit for PreCommit build.&lt;/p&gt;</comment>
                            <comment id="13139053" author="yuzhihong@gmail.com" created="Sat, 29 Oct 2011 01:43:39 +0000"  >&lt;p&gt;hbase-4377.trunk.v5.txt didn&apos;t produce regression.&lt;br/&gt;
The following isn&apos;t new:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Tests in error: 
  testRegionTransitionOperations(org.apache.hadoop.hbase.coprocessor.TestMasterObserver): 9faf6fe48f36206644b7fd913cf7e229
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13139109" author="hadoopqa" created="Sat, 29 Oct 2011 04:42:46 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12501403/hbase-4377.trunk.v5.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12501403/hbase-4377.trunk.v5.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 18 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -166 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 4 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.coprocessor.TestMasterObserver&lt;br/&gt;
                  org.apache.hadoop.hbase.client.TestMultiParallel&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestDefaultLoadBalancer&lt;br/&gt;
                  org.apache.hadoop.hbase.TestRegionRebalancing&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestMasterFailover&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestDistributedLogSplitting&lt;br/&gt;
                  org.apache.hadoop.hbase.coprocessor.TestRegionServerCoprocessorExceptionWithRemove&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/94//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/94//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/94//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/94//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/94//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/94//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13139111" author="yuzhihong@gmail.com" created="Sat, 29 Oct 2011 04:45:35 +0000"  >&lt;p&gt;Submit for PreCommit build.&lt;/p&gt;</comment>
                            <comment id="13139121" author="stack" created="Sat, 29 Oct 2011 05:36:01 +0000"  >&lt;p&gt;We want this?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
+      &lt;span class=&quot;code-comment&quot;&gt;// Do nothing.
&lt;/span&gt;+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why not let the test fail if we can&apos;t delete the table?&lt;/p&gt;

&lt;p&gt;I see we do this deleteTable in a few places w/ above ignore of IOE (the deleteTable method is same in two places)&lt;/p&gt;

&lt;p&gt;Nit: Belwo is a little wonky.  No biggie.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    HTableDescriptor[] htbls = &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HBaseAdmin(conf).listTables();
&lt;/span&gt;+    TEST_UTIL.getHBaseAdmin().listTables();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Nit: No biggie.  Rewrite below if new patch made:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ * This testing base class provides create a minicluster and testing table table
+ * and shutsdown the cluster afterwards. It provides methods to wipes out meta,
+ * inject errors into meta and the file system.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This define is repeated:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[][] splits = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[][] { Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;),
+      Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;), Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;C&quot;&lt;/span&gt;) };
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then there is : +    byte[] splits = &lt;/p&gt;
{ &apos;A&apos;, &apos;B&apos;, &apos;C&apos;, &apos;D&apos; }
&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;Should we be looking for the missing region in the filesystem if we find a hole in meta before we go ahead and create a region to plug the hole?  Do we do that?&lt;/p&gt;

&lt;p&gt;FYI, for future, I think there is utility in HRegion to do the below (with defines for .regioninfo) and for writing it (Maybe there is a reason you did the below manually?):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    Path p = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(rootDir + &lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt; + htd.getNameAsString(),
+        hri.getEncodedName());
+    fs.mkdirs(p);
+    Path riPath = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(p, &lt;span class=&quot;code-quote&quot;&gt;&quot;.regioninfo&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;FYI, there is utility in MetaReader to do this;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; scanMeta() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; count = 0;
+    HTable meta = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTable(conf, HTableDescriptor.META_TABLEDESC.getName());
+    ResultScanner scanner = meta.getScanner(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Scan());
+    LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Table: &quot;&lt;/span&gt; + Bytes.toString(meta.getTableName()));
+    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Result res : scanner) {
+      LOG.info(Bytes.toString(res.getRow()));
+      count++;
+    }
+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; count;
+  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do we need setTableName?  Should below be moved into HRI?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getTableName() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || getTableName().length == 0) {
+        &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] newTableName = HRegionInfo.getTableName(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getRegionName());
+        LOG.debug(Bytes.toString(newTableName)+&lt;span class=&quot;code-quote&quot;&gt;&quot;: .regioninfo doesn&apos;t have tableName value, but we are getting it from regionName :)&quot;&lt;/span&gt;);
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.setTableName(newTableName);
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will be ok?  We&apos;ll have perms to go here?  If we don&apos;t we will just fail which should be fine.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    Path backupDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(rootDir.getParent(), rootDir.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt;
+        + now);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Next time, you could have made a method out of this and used it for meta and root passing in &apos;root&apos; or &apos;meta&apos; and backupRoot &amp;#8211; its repeated code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fs.exists(root)) {
+      fs.rename(root, backupRoot);
+    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;No previous -ROOT- exists.  Continuing.&quot;&lt;/span&gt;);
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should you test the result of fs.rename?  It returns a boolean true if it succeeds and false if not?&lt;/p&gt;

&lt;p&gt;Thats enough for now.&lt;/p&gt;

</comment>
                            <comment id="13139318" author="yuzhihong@gmail.com" created="Sat, 29 Oct 2011 14:19:30 +0000"  >&lt;p&gt;The code in HRegion which creates region directory is scattered in createHRegion(), etc.&lt;br/&gt;
To reuse the code, we need to separate it into its own method.&lt;/p&gt;

&lt;p&gt;MetaReader.fullScanMetaAndPrint() doesn&apos;t return the number of rows in .META.&lt;br/&gt;
We can enhance it by returning the count.&lt;/p&gt;

&lt;p&gt;For fs.rename(), we end up calling DFSClient where the return value&apos;s javadoc says:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; successful, or &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the old name does not exist
   * or &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; name already belongs to the namespace.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We should add checking for return value from fs.rename(). But it seems catching IOException is useful defense against unexpected situation as well.&lt;/p&gt;</comment>
                            <comment id="13139332" author="stack" created="Sat, 29 Oct 2011 15:10:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;To reuse the code, we need to separate it into its own method.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would be a good thing I&apos;d think.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;MetaReader.fullScanMetaAndPrint() doesn&apos;t return the number of rows in .META.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Seems like a minor addition &amp;#8211; otherwise, it does what the method in here does.&lt;/p&gt;

&lt;p&gt;Yes, catch IOE and check the rename return value I&apos;d say (Not too long ago, a patch was added by an hdfs-er to check all boolean returns out of fs operations... we should try keep up the pattern).&lt;/p&gt;

&lt;p&gt;Good stuff.&lt;/p&gt;</comment>
                            <comment id="13139381" author="hadoopqa" created="Sat, 29 Oct 2011 17:51:36 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12501458/hbase-4377.trunk.v5.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12501458/hbase-4377.trunk.v5.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 18 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -166 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 4 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.master.TestDistributedLogSplitting&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestMasterFailover&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/98//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/98//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/98//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/98//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/98//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/98//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13139386" author="jmhsieh" created="Sat, 29 Oct 2011 18:21:39 +0000"  >&lt;p&gt;@Stack&lt;/p&gt;

&lt;p&gt;I have a patch written that optionally handles filling in holes, but haven&apos;t polished it for review yet.  I&apos;ll add it after this patch gets through.  IIRC it adds this functionality to hbck and to the offline meta rebuilder.&lt;/p&gt;</comment>
                            <comment id="13139478" author="stack" created="Sat, 29 Oct 2011 22:35:54 +0000"  >&lt;p&gt;@Jon Sounds good.&lt;/p&gt;

&lt;p&gt;Do we want to make a v6 of these patch to address the minor comments above or do we want to commit this and do them in a different issue (The test fails in patch build are not because of v5).&lt;/p&gt;</comment>
                            <comment id="13139482" author="yuzhihong@gmail.com" created="Sat, 29 Oct 2011 22:46:15 +0000"  >&lt;p&gt;The patch for 0.90 doesn&apos;t cleanly compile yet.&lt;br/&gt;
We need to produce a clean patch for 0.90 and run test suite for it so that 0.90 can have this feature.&lt;/p&gt;</comment>
                            <comment id="13139500" author="jmhsieh" created="Sun, 30 Oct 2011 00:10:33 +0000"  >&lt;p&gt;i&apos;ll do an update tomorrow or monday to&lt;br/&gt;
address the nits and get the 0.90 version caught up again.&lt;/p&gt;</comment>
                            <comment id="13140533" author="jmhsieh" created="Mon, 31 Oct 2011 20:41:42 +0000"  >&lt;p&gt;Addressed most of stack&apos;s comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Removed try-catch from deleteTable.&lt;/li&gt;
	&lt;li&gt;Updated comment related issues.&lt;/li&gt;
	&lt;li&gt;Renamed splits in populateTable to values (splits is for region splits, the latter is for creating values.)&lt;/li&gt;
	&lt;li&gt;Have separate patch for filling in holes.&lt;/li&gt;
	&lt;li&gt;Removed setTableName and added internal check code to getTableName().&lt;/li&gt;
	&lt;li&gt;Refactored the sidelining function to check rename returns.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m going to punt on these two.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;HRegion creation was done manually because the version that existed attempted to open stores and I didn&apos;t want or need that.&lt;/li&gt;
	&lt;li&gt;MetaReader was not used because at the time I was trying to figure out the different table existence semantics in 0.90 vs trunk.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13140546" author="jiraposter@reviews.apache.org" created="Mon, 31 Oct 2011 20:55:32 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2126/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-10-31 20:55:03.327832)&lt;/p&gt;


&lt;p&gt;Review request for hbase, Michael Stack and Andrew Purtell.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Addressed Stack&apos;s comments &lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;commit fbf82c17be6b3ecca5a981f5270cf93aac26e479&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;


&lt;p&gt;This patch rebuilds a new .META. table by reading all the .regioninfo files in the hbase main directory.  It depends on the yet to be committed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4515&quot; title=&quot;User.getCurrent() can fail to initialize the current user&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4515&quot;&gt;&lt;del&gt;HBASE-4515&lt;/del&gt;&lt;/a&gt; (either my verison or Gary&apos;s version), &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4509&quot; title=&quot;[hbck] Improve region map output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4509&quot;&gt;&lt;del&gt;HBASE-4509&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4506&quot; title=&quot;[hbck] Allow HBaseFsck to be instantiated without connecting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4506&quot;&gt;&lt;del&gt;HBASE-4506&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;

&lt;p&gt;Some follow on work includes backporting to 0.90, auto-patching true holes, and adding documentation.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/HRegionInfo.java ae068c7 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java 46ca765 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java 9e9e07b &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java ca6dd4b &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2126/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2126/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;An earlier version of this code (backported to 0.90) was used to diagnose and repair a cluster that had 2700 inconsistencies due to failed splits (the cluster was underprovisioned memory-wise, and on restart, the some regions would start splitting and then die due to oome&apos;s).  This was not actually used on a live cluster &amp;#8211; it was used to reconstruct a .META. from .regioninfo&apos;s laid out in hbase&apos;s directory structure.&lt;/p&gt;

&lt;p&gt;Note also that this is not an automatic fix &amp;#8211; whenever any problems are found, this bails out but dumps info on holes, suggests some fixes, and displays sets of overlapping regions.  It is up to the user to merge regions, to create .regioninfo files to plug hole, and to do any potential data loosing operations.&lt;/p&gt;

&lt;p&gt;The tests demonstrate current expected behavior &amp;#8211; rebuild meta if things line up, and fail without making modifications if holes or overlaps exist.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13140552" author="jmhsieh" created="Mon, 31 Oct 2011 21:04:27 +0000"  >&lt;p&gt;Updated patches addressing most of Stack&apos;s comments.&lt;/p&gt;</comment>
                            <comment id="13140554" author="jiraposter@reviews.apache.org" created="Mon, 31 Oct 2011 21:05:32 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2287/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-10-31 21:03:52.791775)&lt;/p&gt;


&lt;p&gt;Review request for hbase and Ted Yu.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Updated to address stacks comments.  I believe Seb&apos;s patch wasn&apos;t necessary in 0.90 since that code came in on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt; which isn&apos;t on the 0.90 branch.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Backport to 0.90&lt;/p&gt;

&lt;p&gt;commit 89862b73c6358e27220b87b0362599d86ab0fe4a&lt;br/&gt;
Author: Jonathan Hsieh &amp;lt;jon@cloudera.com&amp;gt;&lt;br/&gt;
Date:   Wed Sep 28 10:18:11 2011 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;/p&gt;



&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java ef246c3 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/Bytes.java 13ad026 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java e0bd77e &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/HBaseFsckRepair.java a981f72 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java bd3b2f3 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java PRE-CREATION &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2287/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/2287/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Note, the assertion test result is different in the failure cases due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-451&quot; title=&quot;Remove HTableDescriptor from HRegionInfo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-451&quot;&gt;&lt;del&gt;HBASE-451&lt;/del&gt;&lt;/a&gt; changes. (0.90 returns 0 tables since it does a meta scan on empty meta, trunk branch looks at hdfs dirs, and returns 1).&lt;/p&gt;

&lt;p&gt;This version passes after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4508&quot; title=&quot;Backport HBASE-3777 to 0.90 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4508&quot;&gt;&lt;del&gt;HBASE-4508&lt;/del&gt;&lt;/a&gt; (backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3777&quot; title=&quot;Redefine Identity Of HBase Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3777&quot;&gt;&lt;del&gt;HBASE-3777&lt;/del&gt;&lt;/a&gt; to 0.90 branch) is applied. &lt;/p&gt;

&lt;p&gt;I believe if that patch is not applied, I could modify the test code to force some explicit HConnection deletions.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;jmhsieh&lt;/p&gt;
</comment>
                            <comment id="13140560" author="hadoopqa" created="Mon, 31 Oct 2011 21:12:14 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12501666/hbase-4377.trunk.v6.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12501666/hbase-4377.trunk.v6.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 13 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/113//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/113//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13140566" author="jmhsieh" created="Mon, 31 Oct 2011 21:17:28 +0000"  >&lt;p&gt;Generated new patches using --no-prefix so robot can test.&lt;/p&gt;</comment>
                            <comment id="13140661" author="hadoopqa" created="Mon, 31 Oct 2011 23:11:45 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12501672/hbase-4377.trunk.v6.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12501672/hbase-4377.trunk.v6.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 13 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -166 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 4 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.master.TestDistributedLogSplitting&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestMasterFailover&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/114//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/114//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/114//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/114//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/114//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/114//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13140671" author="yuzhihong@gmail.com" created="Mon, 31 Oct 2011 23:19:27 +0000"  >&lt;p&gt;The failed tests were due to &apos;Too many open files&apos;.&lt;/p&gt;</comment>
                            <comment id="13142035" author="yuzhihong@gmail.com" created="Wed, 2 Nov 2011 09:56:51 +0000"  >&lt;p&gt;Integrated to 0.90, 0.92 and TRUNK.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Jonathan.&lt;/p&gt;</comment>
                            <comment id="13142071" author="hudson" created="Wed, 2 Nov 2011 11:55:17 +0000"  >&lt;p&gt;Integrated in HBase-0.92 #98 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92/98/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92/98/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;  &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;br/&gt;
               (Jonathan Hsieh)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4377&quot; title=&quot;[hbck] Offline rebuild .META. from fs data only.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4377&quot;&gt;&lt;del&gt;HBASE-4377&lt;/del&gt;&lt;/a&gt;  &lt;span class=&quot;error&quot;&gt;&amp;#91;hbck&amp;#93;&lt;/span&gt; Offline rebuild .META. from fs data only&lt;br/&gt;
               (Jonathan Hsieh) (detail)&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/HRegionInfo.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/util/hbck&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRepair.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/util/TestHBaseFsck.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/util/hbck&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/util/hbck/HbckTestingUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/util/hbck/OfflineMetaRebuildTestCore.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildBase.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildHole.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/util/hbck/TestOfflineMetaRebuildOverlap.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13145192" author="koven2049" created="Mon, 7 Nov 2011 03:19:07 +0000"  >&lt;p&gt;@Jonathan If a region is splitting how do we fix it without onlined parent and daughters?&lt;/p&gt;</comment>
                            <comment id="13145197" author="jmhsieh" created="Mon, 7 Nov 2011 03:37:15 +0000"  >&lt;p&gt;@mingjian &lt;/p&gt;

&lt;p&gt;If there was a split that didn&apos;t complete cleanly, a parent region with daughters should look like an overlap.  The tool will tell you where these overlaps are.&lt;/p&gt;

&lt;p&gt;One way to fix the problem is to keep the parent region and then move or remove the daughter regions from hdfs.  Since it is in the middle of a split, the parent should have all the data.  Alternately, you could copy the store files from the daughters into the dir of the parent and then run the offline rebuilder.&lt;/p&gt;

&lt;p&gt;I plan on writing a blog post and hopefully adding to the book on how to fix these problems.&lt;/p&gt;</comment>
                            <comment id="13151743" author="jmhsieh" created="Thu, 17 Nov 2011 02:24:47 +0000"  >&lt;p&gt;Todd too a quick look and mentioned that &quot;fs.defaultFS&quot; is a Hadoop 0.21+&apos;ism.  On a 0.20.x release nothing really happens.  Any concerns about this on the 0.90 backport?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;+  public static void main(String[] args) throws Exception {&lt;br/&gt;
+&lt;br/&gt;
+    // create a fsck object&lt;br/&gt;
+    Configuration conf = HBaseConfiguration.create();&lt;br/&gt;
+    conf.set(&quot;fs.defaultFS&quot;, conf.get(HConstants.HBASE_DIR));&lt;br/&gt;
+    HBaseFsck fsck = new HBaseFsck(conf);&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
{code{&lt;/p&gt;</comment>
                            <comment id="15015872" author="lars_francke" created="Fri, 20 Nov 2015 11:52:57 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12525241">HBASE-4515</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12525083">HBASE-4506</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12525132">HBASE-4509</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12525128">HBASE-4508</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12512658">HBASE-4058</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12521500">HBASE-4335</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12527861">HBASE-4632</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12499806" name="0001-HBASE-4377-hbck-Offline-rebuild-.META.-from-fs-data-.0.90-v4.patch" size="52802" author="jmhsieh" created="Thu, 20 Oct 2011 03:47:55 +0000"/>
                            <attachment id="12499804" name="0001-HBASE-4377-hbck-Offline-rebuild-.META.-from-fs-data-.0.90.v3.patch" size="52548" author="jmhsieh" created="Thu, 20 Oct 2011 03:23:00 +0000"/>
                            <attachment id="12497093" name="0001-HBASE-4377-hbck-Offline-rebuild-.META.-from-fs-data-.patch" size="41088" author="jmhsieh" created="Fri, 30 Sep 2011 00:02:27 +0000"/>
                            <attachment id="12499805" name="0001-HBASE-4377-hbck-Offline-rebuild-.META.-from-fs-data-.trunk.v3.patch" size="53780" author="jmhsieh" created="Thu, 20 Oct 2011 03:23:00 +0000"/>
                            <attachment id="12500633" name="0001-HBASE-4377-hbck-Offline-rebuild-.META.-from-fs-data.0.92.v1.patch" size="52730" author="anih" created="Tue, 25 Oct 2011 09:04:42 +0000"/>
                            <attachment id="12500737" name="0001-HBASE-4377-hbck-Offline-rebuild-.META.-from-fs-data.0.92.v2.patch" size="53725" author="anih" created="Tue, 25 Oct 2011 18:54:14 +0000"/>
                            <attachment id="12500831" name="EXT_AC.regioninfo" size="686" author="anih" created="Wed, 26 Oct 2011 06:59:52 +0000"/>
                            <attachment id="12500832" name="EXT_ATU_05f84d32cbc0bdabf00e00bc2f3570f0.regioninfo" size="2375" author="anih" created="Wed, 26 Oct 2011 06:59:52 +0000"/>
                            <attachment id="12497503" name="hbase-4377-trunk.v2.patch" size="43467" author="jmhsieh" created="Mon, 3 Oct 2011 18:18:40 +0000"/>
                            <attachment id="12501671" name="hbase-4377.0.90.v6.patch" size="52236" author="jmhsieh" created="Mon, 31 Oct 2011 21:17:27 +0000"/>
                            <attachment id="12500736" name="hbase-4377.trunk.v3.txt" size="52213" author="jmhsieh" created="Tue, 25 Oct 2011 18:37:40 +0000"/>
                            <attachment id="12500830" name="hbase-4377.trunk.v4.txt" size="53716" author="anih" created="Wed, 26 Oct 2011 06:53:38 +0000"/>
                            <attachment id="12501458" name="hbase-4377.trunk.v5.txt" size="53716" author="yuzhihong@gmail.com" created="Sat, 29 Oct 2011 15:50:33 +0000"/>
                            <attachment id="12501672" name="hbase-4377.trunk.v6.patch" size="53066" author="jmhsieh" created="Mon, 31 Oct 2011 21:17:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Sep 2011 04:22:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33523</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hqmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101577</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>