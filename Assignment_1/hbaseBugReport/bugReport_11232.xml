<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:21:20 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11232/HBASE-11232.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11232] Add MultiRowMutation tests.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-11232</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The failback code in processRowsWithLocks did not check the column family. If there is an illegal CF in the muation, it will  throw NullPointException and the update lock will not be released.  So the region can not be flushed and compacted. &lt;br/&gt;
HRegion #4946&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!mutations.isEmpty() &amp;amp;&amp;amp; !walSyncSuccessful) {
          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Wal sync failed. Roll back &quot;&lt;/span&gt; + mutations.size() +
              &lt;span class=&quot;code-quote&quot;&gt;&quot; memstore keyvalues &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row(s):&quot;&lt;/span&gt; +
              processor.getRowsToLock().iterator().next() + &lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (KeyValue kv : mutations) {
            stores.get(kv.getFamily()).rollback(kv);
          }
        }
        &lt;span class=&quot;code-comment&quot;&gt;// 11. Roll mvcc forward
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (writeEntry != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          mvcc.completeMemstoreInsert(writeEntry);
          writeEntry = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (locked) {
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.updatesLock.readLock().unlock();
          locked = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12715910">HBASE-11232</key>
            <summary>Add MultiRowMutation tests.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="liushaohui">Liu Shaohui</assignee>
                                    <reporter username="liushaohui">Liu Shaohui</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 May 2014 02:00:01 +0000</created>
                <updated>Tue, 9 Sep 2014 04:19:25 +0000</updated>
                            <resolved>Sat, 23 Aug 2014 04:43:02 +0000</resolved>
                                    <version>0.94.19</version>
                                    <fixVersion>0.94.23</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="14005590" author="liushaohui" created="Thu, 22 May 2014 04:01:31 +0000"  >&lt;p&gt;After the check of code, the trunk doesn&apos;t have this issue after  the refactor of coprocessor.&lt;br/&gt;
So only upload a 0.94 patch.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14005593" author="xieliang007" created="Thu, 22 May 2014 04:06:15 +0000"  >&lt;p&gt;How about 0.96 and 0.98 branch ?&lt;/p&gt;</comment>
                            <comment id="14009621" author="liushaohui" created="Tue, 27 May 2014 12:29:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xieliang007&quot; class=&quot;user-hover&quot; rel=&quot;xieliang007&quot;&gt;Liang Xie&lt;/a&gt;&lt;br/&gt;
0.96 and 0.98 branch don&apos;t have this issue.&lt;/p&gt;</comment>
                            <comment id="14009622" author="hadoopqa" created="Tue, 27 May 2014 12:32:57 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12646175/HBASE-11232-0.94.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12646175/HBASE-11232-0.94.diff&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12646175&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/9599//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/9599//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14009787" author="stack" created="Tue, 27 May 2014 15:23:48 +0000"  >&lt;p&gt;Patch looks good.  Did you intend to add that big test class?  It seems to test more than this issue.&lt;/p&gt;</comment>
                            <comment id="14009934" author="lhofhansl" created="Tue, 27 May 2014 17:30:35 +0000"  >&lt;p&gt;+1&lt;br/&gt;
Looks like we should also guard the unlock and the mvcc completion in another try finally block:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
   ... rollback memstore ...
} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (w != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          mvcc.completeMemstoreInsert(w);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (locked) {
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.updatesLock.readLock().unlock();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (acquiredLocks != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; lid : acquiredLocks) {
            releaseRowLock(lid);
          }
        }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14010842" author="liushaohui" created="Wed, 28 May 2014 06:35:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; Did you intend to add that big test class? It seems to test more than this issue.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. Since there is no test for MultiRowMutationProtocol, I add some basic tests.&lt;/p&gt;</comment>
                            <comment id="14010843" author="liushaohui" created="Wed, 28 May 2014 06:35:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; Did you intend to add that big test class? It seems to test more than this issue.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. Since there is no test for MultiRowMutationProtocol, I add some basic tests.&lt;/p&gt;</comment>
                            <comment id="14100891" author="apurtell" created="Mon, 18 Aug 2014 17:29:52 +0000"  >&lt;p&gt;Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;. Shall we get this in for the next 0.94 release?&lt;/p&gt;</comment>
                            <comment id="14101325" author="lhofhansl" created="Mon, 18 Aug 2014 21:19:56 +0000"  >&lt;p&gt;Yeah... Sorry that slipped through the cracks somehow.&lt;/p&gt;</comment>
                            <comment id="14101326" author="lhofhansl" created="Mon, 18 Aug 2014 21:20:19 +0000"  >&lt;p&gt;I&apos;ll take another look and then commit to 0.94.&lt;/p&gt;</comment>
                            <comment id="14107853" author="lhofhansl" created="Sat, 23 Aug 2014 04:39:02 +0000"  >&lt;p&gt;So the test passes even when I do apply the other changes, so it does not test this condition.&lt;/p&gt;

&lt;p&gt;I also looked at the current code and appears to no longer have this issue. The issue was that in the finally block we try to rollback the memstore, and then that would fail. Now I see we have a memstoreUpdated flag, which can only be set to true after we successfully checked all families.&lt;/p&gt;

&lt;p&gt;All is good.&lt;/p&gt;

&lt;p&gt;With this I will only commit the test, which is nice.&lt;/p&gt;</comment>
                            <comment id="14107856" author="lhofhansl" created="Sat, 23 Aug 2014 04:43:02 +0000"  >&lt;p&gt;Committed the test to 0.94.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12646175" name="HBASE-11232-0.94.diff" size="9444" author="liushaohui" created="Thu, 22 May 2014 04:01:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 22 May 2014 04:06:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394195</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vvfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394333</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>