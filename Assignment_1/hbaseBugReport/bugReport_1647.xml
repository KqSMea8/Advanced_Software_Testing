<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:55:13 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1647/HBASE-1647.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1647] Filter#filterRow is called too often, filters rows it shouldn&apos;t have</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1647</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Filter#filterRow is called from ScanQueryMatcher#filterEntireRow which is called from StoreScanner.next. However, if I understood the code correctly, StoreScanner processes KeyValue-s in a column-oriented order (i.e. after row1-col1 comes row2-col1, not row1-col2). Thus, when filterEntireRow is called, in reality, the filter only processed (via filterKeyValue) only one column of a row.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12430138">HBASE-1647</key>
            <summary>Filter#filterRow is called too often, filters rows it shouldn&apos;t have</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ryanobjc">ryan rawson</assignee>
                                    <reporter username="dogacan">Do&#287;acan G&#252;ney</reporter>
                        <labels>
                    </labels>
                <created>Sat, 11 Jul 2009 12:04:10 +0000</created>
                <updated>Sun, 13 Sep 2009 22:24:50 +0000</updated>
                            <resolved>Tue, 28 Jul 2009 20:29:34 +0000</resolved>
                                    <version>0.20.0</version>
                                    <fixVersion>0.20.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12729980" author="dogacan" created="Sat, 11 Jul 2009 12:07:24 +0000"  >&lt;p&gt;1) A simple class to demonstrate the problem. Not that col2:-s are all filtered even though the ValueFilter instance should only work on col1:-s. When running give -create as an argument to create the table.&lt;/p&gt;

&lt;p&gt;2) Patch for the issue. Patch delete the ScanQueryMatcher#filterEntireRow method and instead calls Filter#filterRow in HRegion.RegionScanner#next. I am not sure if this patch is complete/correct but it fixes the problem for me. Not that you also need &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1646&quot; title=&quot;Scan-s can&amp;#39;t set a Filter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1646&quot;&gt;&lt;del&gt;HBASE-1646&lt;/del&gt;&lt;/a&gt; to test this patch (or the class above).&lt;/p&gt;</comment>
                            <comment id="12730158" author="dogacan" created="Sun, 12 Jul 2009 22:46:46 +0000"  >&lt;p&gt;v2 of patch.&lt;/p&gt;

&lt;p&gt;I think all reset()s should be moved into RegionScanner#next as well. Since we merge different columns of the same row in RegionScanner, calling reset anywhere else (especiall in ScanQueryMatcher, which is called from StoreScanner#next) seems like a bug.&lt;/p&gt;</comment>
                            <comment id="12730471" author="stack" created="Mon, 13 Jul 2009 19:22:29 +0000"  >&lt;p&gt;Patch looks good.   +1.   Its a radical change in Filter processing though it looks right and all tests pass.  Can someone else look at this?  Ryan?  I&apos;d like others input before commiting.&lt;/p&gt;

&lt;p&gt;On StoreScanner running through in an column order rather than row-at-a-time, thats not how I understand it works but maybe thats how it appears in this context.&lt;/p&gt;</comment>
                            <comment id="12730472" author="stack" created="Mon, 13 Jul 2009 19:22:45 +0000"  >&lt;p&gt;Bringing into 0.20.0.&lt;/p&gt;</comment>
                            <comment id="12730491" author="ryanobjc" created="Mon, 13 Jul 2009 20:20:37 +0000"  >&lt;p&gt;I&apos;m afraid this patch is not good, the assumptions of the reporter are not correct, we in fact see things in this order:&lt;/p&gt;

&lt;p&gt;row1 / col1&lt;br/&gt;
row1 / col2&lt;br/&gt;
row2 / col1&lt;br/&gt;
row2 / col2&lt;/p&gt;

&lt;p&gt;This patch removes a key piece of functionality I built into the new API that allows us to post-facto filter a row.&lt;/p&gt;

&lt;p&gt;The API needs to be clearer perhaps.  The intent is:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;use filterRowKey() to have the earliest chance to filter an entire row based on the &lt;em&gt;KEY&lt;/em&gt; only.&lt;/li&gt;
	&lt;li&gt;for more complex processing, implement filterKeyValue() and set internal state.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;At the &quot;End&quot; of the KeyValues for a row, filterRow() will be called, and you can choose, based on that state, to filter the row.  Eg: if a column was missing (which you can&apos;t know until you hit the end of the KeyValues for a row).&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If you don&apos;t use this feature, implement filterRow() &lt;/p&gt;
{ return false; }
&lt;p&gt;.  The JIT hotspot will take care of optimizing things.&lt;/p&gt;</comment>
                            <comment id="12730499" author="dogacan" created="Mon, 13 Jul 2009 20:31:24 +0000"  >&lt;p&gt;Hey Ryan,&lt;/p&gt;

&lt;p&gt;I did not mean that with my description but I was not clear at all. From IRC:&lt;/p&gt;

&lt;p&gt;dogacan: St^Ack: &quot;On StoreScanner running through in an column order rather than row-at-a-time, thats not how I understand it works but maybe thats how it appears in this context.&quot;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;10:32pm&amp;#93;&lt;/span&gt; dogacan: you are right here. I meant (again if I understood code correctly) scanners go to next row to figure out they went too far &lt;span class=&quot;error&quot;&gt;&amp;#91;i mean we peek to the next row in StoreScanner then get DONE then call filterRow&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;10:32pm&amp;#93;&lt;/span&gt; dogacan: and when they do, they used to call filterRow&lt;/p&gt;

&lt;p&gt;(&lt;span class=&quot;error&quot;&gt;&amp;#91;.....&amp;#93;&lt;/span&gt; part was not on IRC)&lt;/p&gt;

&lt;p&gt;Anyway, did you try the ScanBug class I attached? When you set a ValueFilter, it filters out all other columns (because in current way there is almost one filterRow call for every filterKeyValue call).&lt;/p&gt;</comment>
                            <comment id="12730809" author="dogacan" created="Tue, 14 Jul 2009 12:14:20 +0000"  >&lt;p&gt;v3 of patch&lt;/p&gt;

&lt;p&gt;1) It seems stopRow pass check is only done if results.isEmpty. This patch makes stopRow pass checks at every row change.&lt;/p&gt;

&lt;p&gt;2) I moved filterRowKey into RegionScanner as well. Again, please review &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, but I think calling filterRowKey in RegionScanner once should be safe and (very) slightly faster.&lt;/p&gt;</comment>
                            <comment id="12731427" author="dogacan" created="Wed, 15 Jul 2009 13:08:06 +0000"  >&lt;p&gt;v4 of patch.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I have removed all test methods in TestStoreScanner as most of the filter methods are now called in RegionScanner. Should I also refactor the test methods to TestScanner?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I have made a small change in TestScanner. RegionScanner#next&apos;s javadoc:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

    /**
     * Get the next row of results from &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; region.
     * @param results list to append results to
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there are more rows, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; scanner is done
     */

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And in TestScanner#testStopRow:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

      InternalScanner s = r.getScanner(scan);
      &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; count = 0;
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (s.next(results)) {
        count++;
      }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In trunk count is 1. However, there is only one row to scan (&quot;abc&quot;). Since once we call next (and put KeyValue-s in results) there are no more rows so I think we must return false (thus count is 0). Please correct me if I am wrong here.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;There was a possibly serious bug in v3 in RegionScanner. It implicitly assumes that the caller cleared results list between calls to RegionScanner#next. If caller doesn&apos;t do that, we may delete results from older rows or even get stuck in an infinite loop. So I added a new field to RegionScanner. KeyValue-s are initially accumulated (or filtered) in this new field. Upon completion of next, they are added to the outResults. I am not sure if this is  necessary (no code in hbase reuses results).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12731588" author="stack" created="Wed, 15 Jul 2009 17:46:32 +0000"  >&lt;p&gt;.bq I have removed all test methods in TestStoreScanner as most of the filter methods are now called in RegionScanner. Should I also refactor the test methods to TestScanner?&lt;/p&gt;

&lt;p&gt;Tests are kinda critical for this infrequently used but critical feature.&lt;/p&gt;

&lt;p&gt;But this issue is more about how the new filter Interface works, fixing the context at which each of the filter methods are called.  Lets get that worked out first before we work on tests.&lt;/p&gt;

&lt;p&gt;.bq On TestScanner#testStopRow.... 1 vs 0&lt;/p&gt;

&lt;p&gt;That looks right.&lt;/p&gt;

&lt;p&gt;On the javadoc change, I don&apos;t see it in the patch.&lt;/p&gt;

&lt;p&gt;Otherwise, patch looks good to me.  Let me kick Ryan and get him to review it.&lt;/p&gt;



</comment>
                            <comment id="12732262" author="ryanobjc" created="Fri, 17 Jul 2009 00:26:05 +0000"  >&lt;p&gt;There are some issues that need to be addressed before this can go in:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;results is now a field for no reason. This reduces GC efficiency and performance.&lt;/li&gt;
	&lt;li&gt;RegionScanner#next is a mess now. Too many boolean flags, I don&apos;t detect a sense of clear minded purpose. Unbalanced and uncertain flags and filter.reset calls make me concerned about bugs.&lt;/li&gt;
	&lt;li&gt;The last bug one is tests were deleted, instead of migrated. We lose test coverage with this patch.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m poking at it more, but the next and test issue are show stoppers.&lt;/p&gt;</comment>
                            <comment id="12732469" author="dogacan" created="Fri, 17 Jul 2009 11:18:01 +0000"  >&lt;p&gt;&amp;gt;  # results is now a field for no reason. This reduces GC efficiency and performance.&lt;/p&gt;

&lt;p&gt;I explained why in my previous comment. Not sure if mine is a valid reason for worrying though. It seems results is always cleared in internal hbase usage so my extra safeguard there may be pointless.&lt;/p&gt;

&lt;p&gt;&amp;gt; RegionScanner#next is a mess now. Too many boolean flags, I don&apos;t detect a sense of clear minded purpose. &lt;br/&gt;
&amp;gt; Unbalanced and uncertain flags and filter.reset calls make me concerned about bugs.&lt;/p&gt;

&lt;p&gt;I see your point, yet in other ways, it is also clearer now. All the extra logic outside the while loop is moved into the loop, and stop row comparison code is now in one place.&lt;/p&gt;

&lt;p&gt;I reduced boolean flags to one (filterCurrentRow). It is an optimization flag like stickyNextRow in underlying scanners.&lt;/p&gt;

&lt;p&gt;I also refactored code a bit. Let me know if it is clearer now.&lt;/p&gt;

&lt;p&gt;&amp;gt; # The last bug one is tests were deleted, instead of migrated. We lose test coverage with this patch.&lt;/p&gt;

&lt;p&gt;I added tests to TestScanner.&lt;/p&gt;</comment>
                            <comment id="12732486" author="dogacan" created="Fri, 17 Jul 2009 11:54:07 +0000"  >&lt;p&gt;oops. Sorry minor bug in last patch, updated.....&lt;/p&gt;</comment>
                            <comment id="12732753" author="clint.morgan" created="Fri, 17 Jul 2009 22:03:34 +0000"  >&lt;p&gt;This patch fixes a few of my filter backed tests that were failing.&lt;/p&gt;</comment>
                            <comment id="12733155" author="ryanobjc" created="Mon, 20 Jul 2009 08:10:30 +0000"  >&lt;p&gt;thanks for the updated patch. The tests need to be migrated not just deleted, but I&apos;ll poke at the implementation and its consequences compared to the previous implementation tomorrow.  I&apos;ve posted it to github:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://github.com/ryanobjc/hbase/commit/3b31d0f4b0c0df2ad519f421d35cbb216da054e1&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://github.com/ryanobjc/hbase/commit/3b31d0f4b0c0df2ad519f421d35cbb216da054e1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12733321" author="dogacan" created="Mon, 20 Jul 2009 19:04:40 +0000"  >&lt;p&gt;No problem.&lt;/p&gt;

&lt;p&gt;Btw, I updated the tests in latest patch (moved them into TestScanner).&lt;/p&gt;</comment>
                            <comment id="12735296" author="stack" created="Sat, 25 Jul 2009 16:11:10 +0000"  >&lt;p&gt;Patch available, assigning Ryan for review.  Assign it to me Ryan if you want me to review it instead.&lt;/p&gt;</comment>
                            <comment id="12735995" author="ryanobjc" created="Tue, 28 Jul 2009 08:52:13 +0000"  >&lt;p&gt;stack, put it in as is, and I&apos;ll make adjustments if necessary. i want to think about the code a bit more, but i&apos;ve been busy. i&apos;ll do it tomorrow.&lt;/p&gt;</comment>
                            <comment id="12736044" author="stack" created="Tue, 28 Jul 2009 12:11:40 +0000"  >&lt;p&gt;Ok Ryan.&lt;/p&gt;

&lt;p&gt;Committed.  Thanks for patch Do&#287;acan.&lt;/p&gt;</comment>
                            <comment id="12736057" author="stack" created="Tue, 28 Jul 2009 12:52:00 +0000"  >&lt;p&gt;Reopening.  It may have broken scanning.  Not sure yet.  Looking.&lt;/p&gt;</comment>
                            <comment id="12736058" author="stack" created="Tue, 28 Jul 2009 13:27:21 +0000"  >&lt;p&gt;Its not this patch that was prob.  Will reapply in a while.&lt;/p&gt;</comment>
                            <comment id="12736268" author="stack" created="Tue, 28 Jul 2009 20:29:34 +0000"  >&lt;p&gt;Committed (again).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12413246" name="HBASE-1647-v2.patch" size="4767" author="dogacan" created="Sun, 12 Jul 2009 22:46:46 +0000"/>
                            <attachment id="12413418" name="HBASE-1647-v3.patch" size="7730" author="dogacan" created="Tue, 14 Jul 2009 12:14:20 +0000"/>
                            <attachment id="12413547" name="HBASE-1647-v4.patch" size="12549" author="dogacan" created="Wed, 15 Jul 2009 13:08:06 +0000"/>
                            <attachment id="12413801" name="HBASE-1647-v5.patch" size="25352" author="dogacan" created="Fri, 17 Jul 2009 11:18:20 +0000"/>
                            <attachment id="12413805" name="HBASE-1647-v6.patch" size="25352" author="dogacan" created="Fri, 17 Jul 2009 11:54:07 +0000"/>
                            <attachment id="12413196" name="ScanBug.java" size="2309" author="dogacan" created="Sat, 11 Jul 2009 12:07:24 +0000"/>
                            <attachment id="12413197" name="scanfilter.patch" size="3260" author="dogacan" created="Sat, 11 Jul 2009 12:07:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 13 Jul 2009 19:22:29 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25886</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 21 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0heh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99607</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>