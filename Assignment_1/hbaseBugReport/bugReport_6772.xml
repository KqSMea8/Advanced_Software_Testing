<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:39:42 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6772/HBASE-6772.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6772] Make the Distributed Split HDFS Location aware</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6772</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;During a hlog split, each log file (a single hdfs block) is allocated to a different region server. This region server reads the file and creates the recovery edit files.&lt;br/&gt;
The allocation to the region server is random. We could take into account the locations of the log file to split:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the reads would be local, hence faster. This allows short circuit as well.&lt;/li&gt;
	&lt;li&gt;less network i/o used during a failure (and this is important)&lt;/li&gt;
	&lt;li&gt;we would be sure to read from a working datanode, hence we&apos;re sure we won&apos;t have read errors. Read errors slow the split process a lot, as we often enter the &quot;timeouted world&quot;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We need to limit the calls to the namenode however.&lt;/p&gt;

&lt;p&gt;Typical algo could be:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the master gets the locations of the hlog files&lt;/li&gt;
	&lt;li&gt;it writes it into ZK, if possible in one transaction (this way all the tasks are visible alltogether, allowing some arbitrage by the region server).&lt;/li&gt;
	&lt;li&gt;when the regionserver receives the event, it checks for all logs and all locations.&lt;/li&gt;
	&lt;li&gt;if there is a match, it takes it&lt;/li&gt;
	&lt;li&gt;if not it waits something like 0.2s (to give the time to other regionserver to take it if the location matches), and take any remaining task.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Drawbacks are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a 0.2s delay added if there is no regionserver available on one of the locations. It&apos;s likely possible to remove it with some extra synchronization.&lt;/li&gt;
	&lt;li&gt;Small increase in complexity and dependency to HDFS&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Considering the advantages, it&apos;s worth it imho.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12607449">HBASE-6772</key>
            <summary>Make the Distributed Split HDFS Location aware</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="nkeywal">Nicolas Liochon</assignee>
                                    <reporter username="nkeywal">Nicolas Liochon</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Sep 2012 12:52:26 +0000</created>
                <updated>Wed, 16 Nov 2016 22:20:35 +0000</updated>
                                            <version>2.0.0</version>
                                                    <component>master</component>
                    <component>MTTR</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13567411" author="devaraj" created="Thu, 31 Jan 2013 06:58:39 +0000"  >&lt;p&gt;I think it makes sense to also account for the rack locality of the RSs. We should see significant gains by doing rack-local IO..&lt;/p&gt;</comment>
                            <comment id="13594275" author="jeffreyz" created="Wed, 6 Mar 2013 02:58:35 +0000"  >&lt;p&gt;I have slightly updated the design for this JIRA:&lt;/p&gt;

&lt;p&gt;Since master kicks off log splitting work, 1) it knows the locations of the hlog files  2) it knows current online region servers &lt;/p&gt;

&lt;p&gt;Therefore, master knows if a hlog is possibly handled by a region server which is local to the hlog file.&lt;/p&gt;

&lt;p&gt;The updated design:&lt;br/&gt;
1) master identify the set of hlog files which are potentially handled by their local region servers.&lt;br/&gt;
2) add a new attribute of ZK log entry &quot;reserveForLocalRSExpirationTime&quot;&lt;br/&gt;
3) Set its value to a future time(current time + 0.2s delay) for hlog files which are potentially handled by local region servers and 0 to hlogs can&apos;t be handled by local region servers&lt;/p&gt;

&lt;p&gt;When a RS picks a hlog from ZK, if it sees the hlog isn&apos;t local to itself but &quot;reserveForLocalRSExpirationTime&quot; expires, it will go ahead to handle the hlog immediately without waiting. &lt;/p&gt;

&lt;p&gt;So we won&apos;t have the 1st drawback mentioned in the JIRA description. The situation likely happen for a hbase cluster sitting on a large hadoop cluster.&lt;/p&gt;

&lt;p&gt;In addition, we define &quot;local&quot; if and only if a region server is within the same rack as a hlog file to simplify the implementation and get most benefits of the JIRA.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Jeffrey&lt;/p&gt;

</comment>
                            <comment id="13594328" author="yuzhihong@gmail.com" created="Wed, 6 Mar 2013 03:55:04 +0000"  >&lt;p&gt;Interesting idea, Jeff.&lt;/p&gt;

&lt;p&gt;How was the 0.2s delay determined ?&lt;br/&gt;
In SplitLogWorker:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; getTaskList() {
    List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; childrenPaths = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sleepTime = 1000;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The interval between task checking is 1 second.&lt;br/&gt;
I think the delay should be longer.&lt;/p&gt;</comment>
                            <comment id="13594938" author="jeffreyz" created="Wed, 6 Mar 2013 18:29:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tedyu@apache.org&quot;&gt;Ted Yu&lt;/a&gt; Thanks for commenting on this.&lt;/p&gt;

&lt;p&gt;The sleepTime is for retrying purpose and only used when listChildrenAndWatchForNewChildren hit errors or splitLogZNode doesn&apos;t exist. &lt;/p&gt;

&lt;p&gt;In normal case, the following line set a watch on splitLogZNode and returns. Zookeeper will notify region servers to grab a task as soon as a new split task is saved into ZK.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        childrenPaths = ZKUtil.listChildrenAndWatchForNewChildren(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.watcher,
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.watcher.splitLogZNode);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (childrenPaths != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; childrenPaths;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="13594941" author="yuzhihong@gmail.com" created="Wed, 6 Mar 2013 18:32:36 +0000"  >&lt;p&gt;Do we need to accommodate other types of delay on SplitLogWorker, such as network congestion, GC pause, etc ?&lt;/p&gt;</comment>
                            <comment id="13594962" author="jeffreyz" created="Wed, 6 Mar 2013 18:46:26 +0000"  >&lt;p&gt;Agree. The 0.2s is configurable value and we can ship the feature with a good value for most situations after we test the feature. &lt;/p&gt;</comment>
                            <comment id="13595023" author="nkeywal" created="Wed, 6 Mar 2013 19:39:27 +0000"  >&lt;p&gt;The new design is better than my original proposition. I&apos;m +1. Devaraj&apos; comment is important as well imho, so we should put this info as well in ZK.&lt;br/&gt;
Just one point: the master should provide the full list of regionservers owning a copy. This way:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if one of the regionserver is actually dead it can be picked up by another one&lt;/li&gt;
	&lt;li&gt;it&apos;s possible to optimize the choice in the regionserver: if the RS sees it&apos;s the only one for a block it can pick it instead of another one that have more potential regionserver.&lt;/li&gt;
	&lt;li&gt;+ the rack already mentioned by Devaraj.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13595290" author="jeffreyz" created="Wed, 6 Mar 2013 23:39:58 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Just one point: the master should provide the full list of regionservers owning a copy&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A good point, we can store up to 3 region severs as preferred list when available local RSs to a WAL &amp;lt;= 3 to avoid potentially storing too much information in ZK. So a RS can pick a WAL with higher priority if it&apos;s in the preferred list. &lt;/p&gt;</comment>
                            <comment id="13692920" author="nkeywal" created="Tue, 25 Jun 2013 10:42:40 +0000"  >&lt;p&gt;Are you still working on it, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffreyz&quot; class=&quot;user-hover&quot; rel=&quot;jeffreyz&quot;&gt;Jeffrey Zhong&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13693168" author="jeffreyz" created="Tue, 25 Jun 2013 17:12:54 +0000"  >&lt;p&gt;I almost forgot this JIRA. Let me un-assign myself for now and get back to it once I get a chance. Thanks.&lt;/p&gt;</comment>
                            <comment id="13731790" author="nkeywal" created="Wed, 7 Aug 2013 09:03:27 +0000"  >&lt;p&gt;I&apos;m going to try this. Something I had not though about is that it&apos;s simpler is that as the master adds a field in ZK, the regionserver must be able to read it. If it cannot make it into the 0.95.x, I will make it backward compatible.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12551766">HBASE-5843</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 31 Jan 2013 06:58:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241865</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 19 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02f4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12052</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>