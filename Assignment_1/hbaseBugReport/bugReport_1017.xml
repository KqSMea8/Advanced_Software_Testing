<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:50:01 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1017/HBASE-1017.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1017] Region balancing does not bring newly added node within acceptable range</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1017</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;With a 10 node cluster, there were only 9 online nodes.  With about 215 total regions, each of the 9 had around 24 regions (average load is 24).  Slop is 10% so 22 to 26 is the acceptable range.&lt;/p&gt;

&lt;p&gt;Starting up the 10th node, master log showed:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-11-21 15:57:51,521 INFO org.apache.hadoop.hbase.master.ServerManager: Received start message from: 72.34.249.210:60020
2008-11-21 15:57:53,351 DEBUG org.apache.hadoop.hbase.master.RegionManager: Server 72.34.249.219:60020 is overloaded. Server load: 25 avg: 22.0, slop: 0.1
2008-11-21 15:57:53,351 DEBUG org.apache.hadoop.hbase.master.RegionManager: Choosing to reassign 3 regions. mostLoadedRegions has 10 regions in it.
2008-11-21 15:57:53,351 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region streamitems,^@^@^@^@^AH&#239;&#191;&#189;;,1225411051632
2008-11-21 15:57:53,351 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region streamitems,^@^@^@^@^@&#239;&#191;&#189;&#221;,1225411056686
2008-11-21 15:57:53,351 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region groups,,1222913580957
2008-11-21 15:57:53,975 DEBUG org.apache.hadoop.hbase.master.RegionManager: Server 72.34.249.213:60020 is overloaded. Server load: 25 avg: 22.0, slop: 0.1
2008-11-21 15:57:53,975 DEBUG org.apache.hadoop.hbase.master.RegionManager: Choosing to reassign 3 regions. mostLoadedRegions has 10 regions in it.
2008-11-21 15:57:53,976 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region upgrade,,1226892014784
2008-11-21 15:57:53,976 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region streamitems,^@^@^@^@^@3^Z&#239;&#191;&#189;,1225411056701
2008-11-21 15:57:53,976 DEBUG org.apache.hadoop.hbase.master.RegionManager: Going to close region streamitems,^@^@^@^@^@         ^L,1225411049042
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The new regionserver received only 6 regions.  This happened because when the 10th came in, average load dropped to 22.  This caused two servers with 25 regions (acceptable when avg was 24 but not now) to reassign 3 of their regions each to bring them back down to the average.  Unfortunately all other regions remained within the 10% slop (20 to 24) so they were not overloaded and thus did not reassign off any regions.  It was only chance that made even 6 of the regions get reassigned as there could have been exactly 24 on each server, in which case none would have been assigned to the new node.&lt;/p&gt;

&lt;p&gt;This will behave worse on larger clusters when adding a new node has little impact on the avg load/server.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12409044">HBASE-1017</key>
            <summary>Region balancing does not bring newly added node within acceptable range</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apparition">Evgeny Ryabitskiy</assignee>
                                    <reporter username="streamy">Jonathan Gray</reporter>
                        <labels>
                    </labels>
                <created>Sat, 22 Nov 2008 03:11:54 +0000</created>
                <updated>Sun, 13 Sep 2009 22:24:16 +0000</updated>
                            <resolved>Wed, 20 May 2009 19:58:52 +0000</resolved>
                                    <version>0.19.0</version>
                                    <fixVersion>0.20.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                            <comments>
                            <comment id="12649898" author="apurtell" created="Sat, 22 Nov 2008 05:14:45 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;21:07&amp;#93;&lt;/span&gt;	&amp;lt;apurtell&amp;gt;	i was going to work on the balancer a while back but got swamped. it will take some time to get right. actually i proposed load leveling which would not help in the scenario described if no other node considers itself overloaded.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;21:09&amp;#93;&lt;/span&gt;	&amp;lt;jgray2&amp;gt;	apurtell: yes load is most important, and with a shift towards using memory more, that&apos;s going to matter as well&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;21:10&amp;#93;&lt;/span&gt;	&amp;lt;apurtell&amp;gt;	jgray2: rarely used regions should shed their indices and hstore fds anyway imho&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;21:10&amp;#93;&lt;/span&gt;	&amp;lt;jgray2&amp;gt;	i agree&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;21:11&amp;#93;&lt;/span&gt;	&amp;lt;jgray2&amp;gt;	and that all should be taken into account&lt;/p&gt;</comment>
                            <comment id="12680596" author="apparition" created="Tue, 10 Mar 2009 20:01:34 +0000"  >&lt;p&gt;First version of this logic. It&apos;s outline that can be improved.&lt;/p&gt;</comment>
                            <comment id="12681080" author="apparition" created="Wed, 11 Mar 2009 23:03:34 +0000"  >&lt;p&gt;Same algorithm + some code reorganisation + some refactoring to  ServerManager&lt;/p&gt;</comment>
                            <comment id="12682005" author="apparition" created="Sat, 14 Mar 2009 07:24:24 +0000"  >&lt;p&gt;Extract balancing to LoadBalancer class + more re-factoring + sync wit SVN&lt;/p&gt;</comment>
                            <comment id="12682607" author="apparition" created="Tue, 17 Mar 2009 09:18:38 +0000"  >&lt;p&gt;Added new assertion for TestRegionRebalancing scenario.&lt;/p&gt;</comment>
                            <comment id="12688264" author="apparition" created="Mon, 23 Mar 2009 10:34:22 +0000"  >&lt;p&gt;Last tested version. should do everything  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12699325" author="apparition" created="Wed, 15 Apr 2009 19:23:50 +0000"  >&lt;p&gt;About refactoring&lt;/p&gt;

&lt;p&gt;Server manager has mapping: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;serverName 2 serverInfo,&lt;/li&gt;
	&lt;li&gt;serverAddr 2 serverInfo,&lt;/li&gt;
	&lt;li&gt;serverName 2 load,&lt;/li&gt;
	&lt;li&gt;load 2 severName&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1) serverName 2 load - not necessary if you have  serverName 2 serverInfo&lt;br/&gt;
2) All mappings are encapsulated in ServersInfo class (inner class of ServerManager)&lt;br/&gt;
3) ServersInfo has operations for adding, updating and removing information of HRS&lt;/p&gt;


&lt;p&gt;About Load Balance Algorithm&lt;/p&gt;

&lt;p&gt;Previous check: If HRS load more then avg Load Plus Slop, the HRS is overloaded, close some regions (numToClose = currentRegions - avgLoad)&lt;/p&gt;

&lt;p&gt;Added check: If HRS is most loaded and lowest loaded HRS are loaded less then avgLoadMinusSlop then close some regions from most loaded (numToClose = min(currentRegions - avgLoad, (avgLoadMinusSlop - lowestLoad) * numLowestLoadedHRS)  )&lt;/p&gt;



&lt;p&gt;Changes to JUnit for Region Balance:&lt;/p&gt;

&lt;p&gt;Assert check if loads of all HRS are in slop range after rebalnce.&lt;/p&gt;

&lt;p&gt;Number of HRS upped to 10 from 4.&lt;/p&gt;</comment>
                            <comment id="12699327" author="apparition" created="Wed, 15 Apr 2009 19:26:21 +0000"  >&lt;p&gt;Patch is ready for revision.&lt;br/&gt;
All JUnit tests are passed.&lt;/p&gt;

&lt;p&gt;Need testing on a real cluster. If anyone can help me on it?&lt;/p&gt;</comment>
                            <comment id="12709218" author="apparition" created="Wed, 13 May 2009 23:52:52 +0000"  >&lt;p&gt;loadbalance2.0.patch is for my mega cool low-centralised load balance algorithm... &lt;br/&gt;
but it is prototype yet... just to show my new ideas &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
and it&apos;s independent from other patches here&lt;/p&gt;

&lt;p&gt;What was idea:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Region Servers knows better what what regions to unassignee ... and can make own decisions about it.&lt;/li&gt;
	&lt;li&gt;For such decisions HRS will use LoadBalancer thread&lt;/li&gt;
	&lt;li&gt;To make such decisions HRS need to know current load situation in cluster (LoadMetrics)&lt;/li&gt;
	&lt;li&gt;HRS reading LoadMetrics record from ZK&lt;/li&gt;
	&lt;li&gt;If HRS can&apos;t get LoadMetrics record, it makes LoadBalance Slip&lt;/li&gt;
	&lt;li&gt;If HRS founds out that is is overloaded it closes some Regions&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Master can update and put in ZK new LoadMetrics record with some frequency&lt;/li&gt;
	&lt;li&gt;LoadMetrics record contains: avgLoad, maxLoad, upLoadBound, lowLoadBound, uderloadinFactor&lt;/li&gt;
	&lt;li&gt;LoadMetrics is a class with that attributes and can be serialised to bytes and read from bytes&lt;/li&gt;
	&lt;li&gt;LoadMetrics record is a data of some special Ephemeral zNode in ZK, created by Master&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Master still assigning closed regions to HRS, so balance if half-centralised (unnasigne is distributed and assignee is centralised)&lt;/li&gt;
	&lt;li&gt;in future master wil use a flag in LoadMetrics to stop unassigning if there too much closed Regions&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12710244" author="apparition" created="Mon, 18 May 2009 02:18:04 +0000"  >&lt;p&gt;Without refactor to Server manager.&lt;br/&gt;
final version&lt;br/&gt;
maybe can seemed not so small change..... but don&apos;t have idea how to make it smaller&lt;/p&gt;</comment>
                            <comment id="12710503" author="stack" created="Mon, 18 May 2009 21:35:06 +0000"  >&lt;p&gt;I took a look at this patch:&lt;/p&gt;

&lt;p&gt;+ Remove the ^Ms.&lt;br/&gt;
+ getLoadToServers in ServerManager doesn&apos;t need to be public, right?&lt;br/&gt;
+ Test looks good and I like making a class to encapsulate load balancing logic.  I&apos;d suggest adding javadoc to the load balancer explaining how it works.&lt;/p&gt;

&lt;p&gt;I tried the code.  I loaded up a bunch of regions, then shut it down.  Restarted.  All came up balanced after a little while.  I then tried adding a server to the cluster which seems to be what Jon was doing above but it never got any regions:&lt;/p&gt;

&lt;p&gt;aa0-000-12.u.powerset.com:60031	1242680796620	requests=0, regions=0, usedHeap=27, maxHeap=1244&lt;br/&gt;
aa0-000-13.u.powerset.com:60031	1242680136542	requests=0, regions=21, usedHeap=158, maxHeap=1244&lt;br/&gt;
aa0-000-14.u.powerset.com:60031	1242680136673	requests=0, regions=20, usedHeap=71, maxHeap=1244&lt;br/&gt;
aa0-000-15.u.powerset.com:60031	1242680136162	requests=0, regions=19, usedHeap=106, maxHeap=1244&lt;/p&gt;

&lt;p&gt;It stayed at zero.  Wasn&apos;t this patch supposed to address that?&lt;/p&gt;
</comment>
                            <comment id="12711199" author="apparition" created="Wed, 20 May 2009 15:53:14 +0000"  >&lt;p&gt;thx for revising my patch!&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;patch regenerated, ^Ms. removed&lt;/li&gt;
	&lt;li&gt;yes, getLoadToServers changed from public to default visibility&lt;/li&gt;
	&lt;li&gt;added more detailed doc for Load balancer&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;yes, my fault..... sory &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;br/&gt;
While removing ServerManager refactor I forgot about several necessary changes there (that is why I started that refactor)&lt;/p&gt;

&lt;p&gt;ServerManager changes:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;getAverageLoad returns accurate avg load (without round as it was before)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;clean up garbage in loadToServers mapping (if there no servers with such load, then there no record with such load key). before there was record for every old load with empty (size ==0) servers value.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;First one need for more accurate balancing, second is because new LoadBalance maintains on  loadToServers mapping and garbage from old loads making this logic to do wrong decisions&lt;/p&gt;

&lt;p&gt;now it should work in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1017&quot; title=&quot;Region balancing does not bring newly added node within acceptable range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1017&quot;&gt;&lt;del&gt;HBASE-1017&lt;/del&gt;&lt;/a&gt;_v12_FINAL.patch&lt;/p&gt;</comment>
                            <comment id="12711308" author="stack" created="Wed, 20 May 2009 19:58:52 +0000"  >&lt;p&gt;Tested latest version of patch.  Had to do it on quiesced cluster because under load region count is all over place.  Also, killing servers, didn&apos;t kill regionserver hosting meta because that makes a mess of counts too.&lt;/p&gt;

&lt;p&gt;But, killing non-catalog hosting regionserver, balance came back promptly.  Adding in a new node after, balance again came back quickly.   Did this a few times.  Had enough regions that I should have had Jon&apos;s original issue if it had not been fixed.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Evgeny.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12425403">HBASE-1422</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12403560">HBASE-862</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12401856" name="HBASE-1017_v1.patch" size="4098" author="apparition" created="Tue, 10 Mar 2009 20:01:34 +0000"/>
                            <attachment id="12405562" name="HBASE-1017_v10.patch" size="38131" author="apparition" created="Wed, 15 Apr 2009 20:14:02 +0000"/>
                            <attachment id="12408348" name="HBASE-1017_v11_FINAL.patch" size="10614" author="apparition" created="Mon, 18 May 2009 02:18:04 +0000"/>
                            <attachment id="12408591" name="HBASE-1017_v12_FINAL.patch" size="12135" author="apparition" created="Wed, 20 May 2009 15:33:58 +0000"/>
                            <attachment id="12401982" name="HBASE-1017_v2.patch" size="26584" author="apparition" created="Wed, 11 Mar 2009 23:03:33 +0000"/>
                            <attachment id="12402193" name="HBASE-1017_v4.patch" size="35035" author="apparition" created="Sat, 14 Mar 2009 09:13:33 +0000"/>
                            <attachment id="12402369" name="HBASE-1017_v5.patch" size="37433" author="apparition" created="Tue, 17 Mar 2009 09:18:38 +0000"/>
                            <attachment id="12402857" name="HBASE-1017_v6.patch" size="36036" author="apparition" created="Fri, 20 Mar 2009 23:13:21 +0000"/>
                            <attachment id="12403421" name="HBASE-1017_v7.patch" size="35517" author="apparition" created="Mon, 23 Mar 2009 10:34:22 +0000"/>
                            <attachment id="12403504" name="HBASE-1017_v8.patch" size="35775" author="apparition" created="Tue, 24 Mar 2009 09:45:01 +0000"/>
                            <attachment id="12403718" name="HBASE-1017_v9.patch" size="38001" author="apparition" created="Thu, 26 Mar 2009 14:40:14 +0000"/>
                            <attachment id="12408071" name="loadbalance2.0.patch" size="23044" author="apparition" created="Wed, 13 May 2009 23:52:52 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12425403">HBASE-1422</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 22 Nov 2008 05:14:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31951</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 31 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hau7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>