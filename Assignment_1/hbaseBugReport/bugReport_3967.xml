<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:14:40 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3967/HBASE-3967.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3967] Support deletes in HFileOutputFormat based bulk import mechanism</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3967</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;During bulk imports, it&apos;ll be useful to be able to do delete mutations (either to delete data that already exists in HBase or was inserted earlier during this run of the import). &lt;/p&gt;

&lt;p&gt;For example, we have a use case, where we are processing a log of data which may have both inserts and deletes in the mix and we want to upload that into HBase using the bulk import mechanism.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12509658">HBASE-3967</key>
            <summary>Support deletes in HFileOutputFormat based bulk import mechanism</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12533357">HBASE-4907</parent>
                                    <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="ndimiduk">Nick Dimiduk</assignee>
                                    <reporter username="kannanm">Kannan Muthukkaruppan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Jun 2011 00:54:47 +0000</created>
                <updated>Mon, 23 Sep 2013 19:07:22 +0000</updated>
                            <resolved>Tue, 9 Apr 2013 06:29:46 +0000</resolved>
                                                                    <component>mapreduce</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13049511" author="mati" created="Tue, 14 Jun 2011 23:29:01 +0000"  >&lt;p&gt;Ok, so I think I&apos;ve managed to make this work. However, I couldn&apos;t simply abstract up and use Row directly as the mapper output due to the following set of lines in &quot;org.apache.hadoop.mapred.MapTask&quot;&lt;/p&gt;

&lt;p&gt;844       if (key.getClass() != keyClass) &lt;/p&gt;
{
845         throw new IOException(&quot;Type mismatch in key from map: expected &quot;
846                               + keyClass.getName() + &quot;, recieved &quot;
847                               + key.getClass().getName());
848       }

&lt;p&gt;and the corresponding for value. &lt;/p&gt;

&lt;p&gt;This meant that even if I tried to pass a Put or a Delete as Rows when writing to the map context, it would fail at this check. As such, I just created an abstraction that acts as a union for &lt;em&gt;either&lt;/em&gt; a Put or a Delete and can be built off of either.&lt;/p&gt;</comment>
                            <comment id="13049565" author="nspiegelberg" created="Wed, 15 Jun 2011 01:32:52 +0000"  >&lt;p&gt;Assigning to Bogdan, one of our interns here.&lt;/p&gt;</comment>
                            <comment id="13049573" author="stack" created="Wed, 15 Jun 2011 02:15:31 +0000"  >&lt;p&gt;Hey Bogdan (welcome!)&lt;/p&gt;


&lt;p&gt;If you removed the check for KV, would that make your life easier (&lt;a href=&quot;http://en.wikipedia.org/wiki/Jon_Postel#Postel.27s_Law&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://en.wikipedia.org/wiki/Jon_Postel#Postel.27s_Law&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13049645" author="mati" created="Wed, 15 Jun 2011 06:22:18 +0000"  >&lt;p&gt;Hello and thank you!&lt;/p&gt;

&lt;p&gt;From what I gathered by looking through the hadoop code, the MapTask class will try to get serializers for the respective classes, based on their actual .class field, which basically means that even if they will fail the check (so if we take it out), the serialization process should be ok afterwards.&lt;/p&gt;

&lt;p&gt;I back-traced it through the code:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;SerializationFactory gets configuration from job&lt;br/&gt;
&lt;a href=&quot;http://grepcode.com/file/repository.cloudera.com/content/repositories/releases/com.cloudera.hadoop/hadoop-core/0.20.2-320/org/apache/hadoop/mapred/MapTask.java#794&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://grepcode.com/file/repository.cloudera.com/content/repositories/releases/com.cloudera.hadoop/hadoop-core/0.20.2-320/org/apache/hadoop/mapred/MapTask.java#794&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;SerializationFactory gathers the proper Serialization from the conf (currently only for the WritableSerialization)&lt;br/&gt;
&lt;a href=&quot;http://grepcode.com/file/repository.cloudera.com/content/repositories/releases/com.cloudera.hadoop/hadoop-core/0.20.2-320/org/apache/hadoop/io/serializer/SerializationFactory.java#50&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://grepcode.com/file/repository.cloudera.com/content/repositories/releases/com.cloudera.hadoop/hadoop-core/0.20.2-320/org/apache/hadoop/io/serializer/SerializationFactory.java#50&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;WritableSerialization delivers proper Serializer and Deserializer that will work well on the underlying objects as it calls readFields and write on the respective Writable object that they hold&lt;br/&gt;
&lt;a href=&quot;http://grepcode.com/file/repository.cloudera.com/content/repositories/releases/com.cloudera.hadoop/hadoop-core/0.20.2-320/org/apache/hadoop/io/serializer/WritableSerialization.java#89&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://grepcode.com/file/repository.cloudera.com/content/repositories/releases/com.cloudera.hadoop/hadoop-core/0.20.2-320/org/apache/hadoop/io/serializer/WritableSerialization.java#89&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I am posting this to make sure I have it right, as I haven&apos;t tested by actually modifying the hadoop code myself and trying it. (I should probably checkout, modify and build for testing it...) &lt;/p&gt;

&lt;p&gt;This will also ensure backwards compatibility, as anything previously written cannot possibly break. Also, as with your note of Postel&apos;s Law, this will increase the amount of use-cases that get accepted, while not causing any potential problems.&lt;/p&gt;

&lt;p&gt;Currently, for this respective Put+Delete case, I finished the initial implementation with the union thing and it works, but if this works and removing those two checks would make the MR code more effective in general, then probably that should change too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13050014" author="kannanm" created="Wed, 15 Jun 2011 20:42:04 +0000"  >&lt;p&gt;Stack: &amp;lt;&amp;lt;If you removed the check for KV&amp;gt;&amp;gt; &amp;#8211; just making sure did you mean remove the separate checks for Key class and Value class? It might still be a good idea to check that it is at least a subclass of the expected class, no? Or does that check already happen down the stream?&lt;/p&gt;</comment>
                            <comment id="13050036" author="mati" created="Wed, 15 Jun 2011 21:15:38 +0000"  >&lt;p&gt;The Row modifications are made for our internal branch since we didn&apos;t have the lastest ones...&lt;/p&gt;</comment>
                            <comment id="13050050" author="stack" created="Wed, 15 Jun 2011 21:35:20 +0000"  >&lt;p&gt;@Bogdan and @Kannan, pardon me, I misread Bogdan&apos;s pasting of code to be a check on KV over in hbase; I missed that he was talking about a frameowork check of the passed Key class.  Scratch my suggested remove of the class check.&lt;/p&gt;

&lt;p&gt;@Bogdan, shouldn&apos;t you be working in mapreduce package, rather than mapred package?&lt;/p&gt;</comment>
                            <comment id="13148636" author="nspiegelberg" created="Fri, 11 Nov 2011 18:15:12 +0000"  >&lt;p&gt;This jira seems to have been stalled with a working patch in tow.  Any reason?  We&apos;re currently using this for our Messaging migrations at scale.  &lt;/p&gt;

&lt;p&gt;@stack: Any problems with a rebase, then commit?&lt;/p&gt;</comment>
                            <comment id="13149350" author="stack" created="Sun, 13 Nov 2011 20:23:20 +0000"  >&lt;p&gt;@Nicolas None&lt;/p&gt;</comment>
                            <comment id="13149384" author="kannanm" created="Sun, 13 Nov 2011 22:48:15 +0000"  >&lt;p&gt;Nicolas:&lt;br/&gt;
We need to make sure if Bogdan updated the patch with the latest fixes. On the internal branch, I recall it needed one followup commit to fix some issue with resolving tiebreaks if multiple entries had the same &quot;rowkey&quot;/&quot;columnkey&quot;/&quot;ts&quot;.&lt;/p&gt;</comment>
                            <comment id="13149386" author="mati" created="Sun, 13 Nov 2011 23:08:31 +0000"  >&lt;p&gt;@Kannan:&lt;br/&gt;
You are right, this diff does not include the follow-up fix for tie-breaking - I just checked through it.&lt;/p&gt;</comment>
                            <comment id="13160417" author="nspiegelberg" created="Wed, 30 Nov 2011 22:44:26 +0000"  >&lt;p&gt;Patch available in 89-fb, need to port to trunk (SVN: 15334 &amp;amp; 16195)&lt;/p&gt;</comment>
                            <comment id="13217957" author="lhofhansl" created="Tue, 28 Feb 2012 06:44:37 +0000"  >&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5440&quot; title=&quot;Allow Import to optionally use HFileOutputFormat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5440&quot;&gt;&lt;del&gt;HBASE-5440&lt;/del&gt;&lt;/a&gt; I solved this by having the mapper output KVs and using KeyValueSortReducer.&lt;/p&gt;</comment>
                            <comment id="13218522" author="stack" created="Tue, 28 Feb 2012 19:33:15 +0000"  >&lt;p&gt;Making blocker on 0.96 at Nicolas&apos;s suggestion&lt;/p&gt;</comment>
                            <comment id="13218525" author="stack" created="Tue, 28 Feb 2012 19:34:44 +0000"  >&lt;p&gt;Misread.  N said 0.94 blocker.&lt;/p&gt;</comment>
                            <comment id="13234504" author="lhofhansl" created="Wed, 21 Mar 2012 17:02:24 +0000"  >&lt;p&gt;Is anybody working on this. I don&apos;t think this should hold up the 0.94 release.&lt;/p&gt;</comment>
                            <comment id="13235648" author="lhofhansl" created="Thu, 22 Mar 2012 15:35:40 +0000"  >&lt;p&gt;Please comment today on why this is a blocker for 0.94. Otherwise I&apos;ll move this out of 0.94.&lt;/p&gt;</comment>
                            <comment id="13236915" author="lhofhansl" created="Fri, 23 Mar 2012 18:45:07 +0000"  >&lt;p&gt;Moving out of 0.94. Pull back if you disagree.&lt;/p&gt;</comment>
                            <comment id="13258369" author="nicktelford" created="Fri, 20 Apr 2012 16:52:20 +0000"  >&lt;p&gt;Anyone know what the status of this issue is? It looks to have been completed in the latest patch (or perhaps even in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5440&quot; title=&quot;Allow Import to optionally use HFileOutputFormat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5440&quot;&gt;&lt;del&gt;HBASE-5440&lt;/del&gt;&lt;/a&gt;, not sure what Lars meant there) but not reviewed/accepted?&lt;/p&gt;</comment>
                            <comment id="13258599" author="lhofhansl" created="Fri, 20 Apr 2012 21:29:52 +0000"  >&lt;p&gt;HFileOutputFormat just stores KeyValues so it already handles Deletes. The question is: How do you get Deletes output from a Mapper?&lt;/p&gt;

&lt;p&gt;One solution (the one I took in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5440&quot; title=&quot;Allow Import to optionally use HFileOutputFormat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5440&quot;&gt;&lt;del&gt;HBASE-5440&lt;/del&gt;&lt;/a&gt;) is to have Mapper emit KeyValues and then use KeyValueSortReducer in the reduce phase.&lt;br/&gt;
Another approach is this jira, which is what Facebook has internally (as far as I know).&lt;/p&gt;

&lt;p&gt;Yet another approach could be use Mutation (which is new in 0.92), and write a new SortReducer.&lt;/p&gt;

&lt;p&gt;I think the point of this jira is to get the Facebook approach into 0.94/trunk in order to make upgrading more palatable for Facebook.&lt;br/&gt;
Kannan, correct me if I am wrong.&lt;/p&gt;</comment>
                            <comment id="13264252" author="kannanm" created="Sat, 28 Apr 2012 08:10:34 +0000"  >&lt;p&gt;The point of the JIRA was to really just provide a way to be able to bulk import delete mutations in addition to put mutations. We solved this on 89-fb branch by introducing a RowMutation (which extends Row) and its constructor can take a &quot;Put&quot; or &quot;Delete&quot;. And by using a RowMutationSortReducer (that is variant of PutSortReducer, except that it handles Deletes &amp;amp; Puts). I will dig up the commit revs on 89-fb branch and try to post the links shortly for you to take a look. Unless there are any technical objections, we should just port the same approach to trunk.&lt;/p&gt;</comment>
                            <comment id="13264254" author="kannanm" created="Sat, 28 Apr 2012 08:16:21 +0000"  >&lt;p&gt;Here are the relevant patches:&lt;/p&gt;

&lt;p&gt;1) Original fix:&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1181568&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1181568&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2) Followup fix for tie-breaking when duplicate mutations with same RowKey/ColKey/TS are put or deleted.. we want to make sure the &quot;later&quot; one deterministically wins:&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1181589&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1181589&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Any volunteers to port this to trunk?&lt;/p&gt;
</comment>
                            <comment id="13264447" author="lhofhansl" created="Sun, 29 Apr 2012 02:11:48 +0000"  >&lt;p&gt;In that case I am a bit confusing about the point of this jira.&lt;br/&gt;
A mapper can already produce KeyValues and there already is KeyValueSortReducer.&lt;/p&gt;

&lt;p&gt;Also 0.92+ has Mutation (as parent to both Put and Delete), which could be used for the same (with a new reducer of course).&lt;/p&gt;</comment>
                            <comment id="13270572" author="kannanm" created="Tue, 8 May 2012 16:12:19 +0000"  >&lt;p&gt;@Lars: Good point. Not sure if KeyValueSortReducer is new. I&apos;ll look more into this, and see if there are any differences between the two approaches.&lt;/p&gt;
</comment>
                            <comment id="13444274" author="lhofhansl" created="Wed, 29 Aug 2012 18:11:58 +0000"  >&lt;p&gt;@Kannan: Are you still working on this? Maybe we can close it.&lt;/p&gt;</comment>
                            <comment id="13600523" author="ndimiduk" created="Tue, 12 Mar 2013 21:50:11 +0000"  >&lt;p&gt;I think this is a non-issue. I hacked up TestHFileOutputFormat to generate deletes and it looks like Delete markers are respected. Patch attached.&lt;/p&gt;

&lt;p&gt;We could also extend &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7938&quot; title=&quot;Add integration test for ImportTsv/LoadIncrementalHFiles workflow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7938&quot;&gt;&lt;del&gt;HBASE-7938&lt;/del&gt;&lt;/a&gt; to test more explicitly for these conditions.&lt;/p&gt;</comment>
                            <comment id="13619292" author="sershe" created="Mon, 1 Apr 2013 23:05:21 +0000"  >&lt;p&gt;Should this be closed as invalid then?&lt;/p&gt;</comment>
                            <comment id="13619320" author="yuzhihong@gmail.com" created="Mon, 1 Apr 2013 23:29:42 +0000"  >&lt;p&gt;The diff.patch was for 0.89-fb branch.&lt;br/&gt;
I don&apos;t think this should be closed as being invalid.&lt;/p&gt;</comment>
                            <comment id="13626089" author="sershe" created="Tue, 9 Apr 2013 01:39:18 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndimiduk&quot; class=&quot;user-hover&quot; rel=&quot;ndimiduk&quot;&gt;Nick Dimiduk&lt;/a&gt; comment above&lt;/p&gt;</comment>
                            <comment id="13626293" author="stack" created="Tue, 9 Apr 2013 06:29:46 +0000"  >&lt;p&gt;Assigning Nick &amp;#8211; since he did the work to verify what we suspected, that this was already being covered in post 0.89 patches (Thanks Nick).  Resolving as &apos;Not a Problem&apos; at Sergey&apos;s prompting.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12573423" name="3967-janky-verify.patch" size="2028" author="ndimiduk" created="Tue, 12 Mar 2013 21:50:11 +0000"/>
                            <attachment id="12482718" name="diff.patch" size="15727" author="mati" created="Wed, 15 Jun 2011 21:15:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 14 Jun 2011 23:29:01 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33299</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 36 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hor3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101272</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>