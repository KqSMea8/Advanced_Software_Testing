<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:03:21 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2614/HBASE-2614.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2614] killing server in TestMasterTransitions causes NPEs and test deadlock</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2614</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description></description>
                <environment></environment>
        <key id="12465425">HBASE-2614</key>
            <summary>killing server in TestMasterTransitions causes NPEs and test deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 May 2010 03:01:31 +0000</created>
                <updated>Fri, 20 Nov 2015 12:43:30 +0000</updated>
                            <resolved>Sat, 5 Jun 2010 05:23:18 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12871495" author="tlipcon" created="Wed, 26 May 2010 03:59:51 +0000"  >&lt;p&gt;I&apos;ve been seeing this test deadlock as well on my hudson.&lt;/p&gt;</comment>
                            <comment id="12875269" author="stack" created="Thu, 3 Jun 2010 19:52:33 +0000"  >&lt;p&gt;I see  (Too many open files) in this log.&lt;/p&gt;

&lt;p&gt;A few other things of interest are that the Master won&apos;t go down because it thinks there is still a regionserver alive.  Its stuck here.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 144 (RegionManager.rootScanner):
  State: TIMED_WAITING
  Blocked count: 63
  Waited count: 333
  Stack:
    java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
    org.apache.hadoop.hbase.master.RegionManager.waitForRootRegionLocation(RegionManager.java:1161)
    org.apache.hadoop.hbase.master.RootScanner.scanRoot(RootScanner.java:45)
    org.apache.hadoop.hbase.master.RootScanner.maintenanceScan(RootScanner.java:79)
    org.apache.hadoop.hbase.master.BaseScanner.chore(BaseScanner.java:154)
    org.apache.hadoop.hbase.Chore.run(Chore.java:68)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Other issue is that in our minihbasecluster, when we are asked to start a new server, we&apos;ll wait till its online only here, the new regionserver crashed on startup.  Need to insert isAlive check into loop waiting on new server to come online.   Patch coming.&lt;/p&gt;</comment>
                            <comment id="12875452" author="apurtell" created="Fri, 4 Jun 2010 03:39:47 +0000"  >&lt;p&gt;I didn&apos;t think to raise the fh handle limits on our Hudson&apos;s user account. Will do so now, but it is a surprise the tests are so greedy. Glad this revealed a problem anyway.&lt;/p&gt;

</comment>
                            <comment id="12875453" author="stack" created="Fri, 4 Jun 2010 03:43:46 +0000"  >&lt;p&gt;I&apos;d say leave it.&lt;/p&gt;

&lt;p&gt;Its actually exposed two problems that I see.&lt;/p&gt;

&lt;p&gt;1. We are processing a server shutdown.  We don&apos;t remove the server from list of servers until the processing has completed so as far as master is concerned, there is still a RS out there and he won&apos;t go down till it does.   The server shutdown can&apos;t complete because dfs is gone.&lt;br/&gt;
2. In our test framework, a RS may fail to start properly but we&apos;ll just wait till it does anyways.&lt;/p&gt;

&lt;p&gt;I&apos;d say leave it.  Next time it might reveal more interesting stuff.&lt;/p&gt;</comment>
                            <comment id="12875512" author="stack" created="Fri, 4 Jun 2010 06:47:57 +0000"  >&lt;p&gt;This test just hung up apache hudson with this over and over:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-06-04 05:34:59,307 INFO  [RegionServer:4.worker] regionserver.HRegionServer$Worker(1361): Regionserver blocked by TESTING_MSG_BLOCK_RS; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
2010-06-04 05:34:59,474 INFO  [RegionServer:2] regionserver.HRegionServer(488): MSG_REGIONSERVER_QUIESCE
2010-06-04 05:34:59,499 INFO  [RegionServer:4] regionserver.HRegionServer(488): MSG_REGIONSERVER_QUIESCE
2010-06-04 05:35:00,070 DEBUG [master] master.RegionManager(596): telling root scanner to stop
2010-06-04 05:35:00,070 DEBUG [master] master.RegionManager(600): telling meta scanner to stop
2010-06-04 05:35:00,070 DEBUG [master] master.RegionManager(604): meta and root scanners notified
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Something went wonky.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/view/HBase/job/HBase-TRUNK/1291/artifact/trunk/target/surefire-reports/org.apache.hadoop.hbase.master.TestMasterTransitions-output.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/view/HBase/job/HBase-TRUNK/1291/artifact/trunk/target/surefire-reports/org.apache.hadoop.hbase.master.TestMasterTransitions-output.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12875850" author="stack" created="Sat, 5 Jun 2010 04:50:38 +0000"  >&lt;p&gt;This patch addresses issues seen in the log attached.&lt;/p&gt;

&lt;p&gt;In the main, the issue is that a regionserver failed to init completely because of:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException
    at org.apache.hadoop.ipc.Client$Connection.handleConnectionFailure(Client.java:351)
    at org.apache.hadoop.ipc.Client$Connection.setupIOstreams(Client.java:313)
    at org.apache.hadoop.ipc.Client$Connection.access$1700(Client.java:176)
    at org.apache.hadoop.ipc.Client.getConnection(Client.java:860)
    at org.apache.hadoop.ipc.Client.call(Client.java:720)
    at org.apache.hadoop.ipc.RPC$Invoker.invoke(RPC.java:220)
    at $Proxy7.getProtocolVersion(Unknown Source)
    at org.apache.hadoop.ipc.RPC.getProxy(RPC.java:359)
    at org.apache.hadoop.hdfs.DFSClient.createRPCNamenode(DFSClient.java:106)
    at org.apache.hadoop.hdfs.DFSClient.&amp;lt;init&amp;gt;(DFSClient.java:207)
    at org.apache.hadoop.hdfs.DFSClient.&amp;lt;init&amp;gt;(DFSClient.java:170)
    at org.apache.hadoop.hdfs.DistributedFileSystem.initialize(DistributedFileSystem.java:82)
    at org.apache.hadoop.fs.FileSystem.createFileSystem(FileSystem.java:1378)
    at org.apache.hadoop.fs.FileSystem.access$200(FileSystem.java:66)
    at org.apache.hadoop.fs.FileSystem$Cache.get(FileSystem.java:1390)
    at org.apache.hadoop.fs.FileSystem.get(FileSystem.java:196)
    at org.apache.hadoop.fs.FileSystem.get(FileSystem.java:95)
    at org.apache.hadoop.hbase.regionserver.HRegionServer.init(HRegionServer.java:746)
    at org.apache.hadoop.hbase.MiniHBaseCluster$MiniHBaseClusterRegionServer.init(MiniHBaseCluster.java:161)
    at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:427)
    at org.apache.hadoop.hbase.MiniHBaseCluster$MiniHBaseClusterRegionServer.run(MiniHBaseCluster.java:169)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The was inside its run method trying to get filesystem instance AFTER it had registered itself with zk.&lt;/p&gt;

&lt;p&gt;Our test utils wait on the regionserver to set its online flag before letting things proceed.  There was on provision for failed startup so test harness was waiting for ever on an online flag that would never be set.   The thread dumps were showing this for the testing harness:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 770 (&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-692):
  State: TIMED_WAITING
  Blocked count: 134
  Waited count: 1362
  Stack:
    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
    org.apache.hadoop.hbase.util.JVMClusterUtil$RegionServerThread.waitForServerOnline(JVMClusterUtil.java:60)
    org.apache.hadoop.hbase.MiniHBaseCluster.startRegionServer(MiniHBaseCluster.java:227)
    org.apache.hadoop.hbase.master.TestMasterTransitions.testAddingServerBeforeOldIsDead2413(TestMasterTransitions.java:281)
    sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
    sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
    java.lang.reflect.Method.invoke(Method.java:597)
    org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
    org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
    org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
    org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
    org.junit.internal.runners.statements.FailOnTimeout$1.run(FailOnTimeout.java:28)
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 539 (org.apache.hadoop.hdfs.server.datanode.DataXceiver@19789a96):
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, the RS crashes after its registered w/ zk so it goes to abort, ONLY, in the abort, we throw a NPE because presumption is that metrics have been initialized, only we haven&apos;t got that far in init, so the abort is aborted; i.e. we don&apos;t call the stop method.  So, the RS is sort of still alive, alive enough to keep on hosting the zk client polling master as though the RS were still alive.&lt;/p&gt;

&lt;p&gt;Meanwhile over on the master, we want to go out because test says time for shutdown only we won&apos;t shutdown till all regionservers have closed and deregistered themselves from the master.   The above RS failed after it repoted to the master for duty so master knows about it and the RS is in a zombie state that keeps up its zk lease, so master thinks a RS out these is still alive.&lt;/p&gt;

&lt;p&gt;Patch makes it so test framework won&apos;t wait if RS has shutdownRequested set (which it will when aborting), it fixes abort so no presumptions about metrics being initialized, and over on master, we&apos;ll print out servers we&apos;re waiting on up in main loop too to make this kind of thing easier debugging going forward.  &lt;/p&gt;</comment>
                            <comment id="12875851" author="tlipcon" created="Sat, 5 Jun 2010 04:54:09 +0000"  >&lt;p&gt;Is this related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2441&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-2441&lt;/a&gt; ?&lt;br/&gt;
Also, the NPE in handleConnectionFailure sounds interesting. Can you file a JIRA for that one? I think I fixed a similar bug in Hadoop IPC but maybe I missed the &quot;side port&quot; over to HBase IPC?&lt;/p&gt;</comment>
                            <comment id="12875863" author="stack" created="Sat, 5 Jun 2010 05:21:08 +0000"  >&lt;p&gt;This version adds a config that stops us dumping out all regions in the one go.  Be less lumpy.  Get a few cycles in there rather than do all in one go.  This hopefully addresses the latter hang we saw because we missed a barrier (We needed an extra cycle  for close to go across before we did server abort).  If still too brittle, I&apos;ll dig more.&lt;/p&gt;</comment>
                            <comment id="12875864" author="stack" created="Sat, 5 Jun 2010 05:23:18 +0000"  >&lt;p&gt;Committed small(ish) patch that should help w/ builds.  Will open new issue if this set not good enough.&lt;/p&gt;</comment>
                            <comment id="12875865" author="tlipcon" created="Sat, 5 Jun 2010 05:26:45 +0000"  >&lt;p&gt;patch looks good to me. we&apos;ll see if my Hudson barfs less &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12875866" author="stack" created="Sat, 5 Jun 2010 05:33:59 +0000"  >&lt;p&gt;Just saw your message now Todd.  Yeah, first part of 2441 is duplicated in this patch.  Why not just commit the rest of 2441.  Let me go +1 it.  Its no brainer whereas the unit test would be a pain to cast.  Let me file a new issue for the original NPE.  We should probably try and just bring over original RPC from hadoop anyways wholesale.  It&apos;ll make Gary Helmling&apos;s life bring over hadoop security.&lt;/p&gt;</comment>
                            <comment id="15017541" author="lars_francke" created="Fri, 20 Nov 2015 12:43:30 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12446398" name="2614.txt" size="4457" author="stack" created="Sat, 5 Jun 2010 04:50:38 +0000"/>
                            <attachment id="12446402" name="2615-v2.txt" size="5430" author="stack" created="Sat, 5 Jun 2010 05:21:08 +0000"/>
                            <attachment id="12445523" name="org.apache.hadoop.hbase.master.TestMasterTransitions-output.txt.gz" size="116170" author="apurtell" created="Wed, 26 May 2010 03:02:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 26 May 2010 03:59:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26385</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hihj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100257</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>