<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:07:40 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-9797/HBASE-9797.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-9797] Multi row transactions are not atomic for scanners</title>
                <link>https://issues.apache.org/jira/browse/HBASE-9797</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Multi row atomic puts, as implemented by the coprocessor API is atomic for gets and multi gets, but not so much for scanners. &lt;/p&gt;

&lt;p&gt;mvcc read point, as of today, is only kept in RS memory. When a client starts the scan, we create a new scanner object and save the mvcc read point of the scan there. Since the scan API is row-based, the scan results are only made visible to clients row-per-row, and the client scanner keep track of the last row seen. &lt;/p&gt;

&lt;p&gt;So, for a multi-row atomic update, the scanner might get an mvcc number which is less than the commit point of the multi-row update, so it will skip some rows in the scan (will not see the rows). However, in case of RS failover, a new scanner will be created which will have a mvcc read number larger than the multi-row update commit number. So the scanner will see the remaining rows from the transaction. &lt;/p&gt;

&lt;p&gt;Example: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
multi put : { {row1, c1, v1}, {row100, c1, v100} } mvcc write number = 2
scan : scan from row1 to row100  mvcc read number = 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;scanner will not see row1. If RS fails before scanner reaches row100, the new scanner will get mvcc read number &amp;gt; 2, so it will see row100. &lt;/p&gt;


&lt;p&gt;There might be a couple of ways to fix this. First approach (as suggested by Sergey) is that we can wrap the Scanner into an atomic scanner implementation, which will restart the scan in case of a socket timeout or server failure, etc. This will batch up the results so that the rows are not visible. For small scans (like meta) this might be viable. &lt;/p&gt;


&lt;p&gt;The second way to properly fix this is, first finish up the patch at &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8763&quot; title=&quot;Combine MVCC and SeqId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8763&quot;&gt;&lt;del&gt;HBASE-8763&lt;/del&gt;&lt;/a&gt;, then change the scanner to obtain an mvcc number from the RS in scanner open, and save the mvcc number in the client side. Upon failure, the scanner will continue the scan where it is left. We have to keep the low watermark (the smallest mvcc read number of the scanners currently open) differently. Currently that number is already tracked, but not across RS failover. We can do timeouts to manage the low watermark I think. &lt;br/&gt;
This approach also enables us to implement cell-based streaming scan instead of row-based approach we have today. &lt;/p&gt;

&lt;p&gt;Opened the issue, so that it is tracked. Feel free to pick it up if you like. &lt;/p&gt;






</description>
                <environment></environment>
        <key id="12674423">HBASE-9797</key>
            <summary>Multi row transactions are not atomic for scanners</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="enis">Enis Soztutar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Oct 2013 23:20:00 +0000</created>
                <updated>Thu, 24 Nov 2016 01:43:27 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13798587" author="sershe" created="Thu, 17 Oct 2013 23:21:21 +0000"  >&lt;p&gt;The first approach will only work for small scans, period...&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13022737">HBASE-17167</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12686447">HBASE-10241</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 17 Oct 2013 23:21:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354045</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1p1fb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354337</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>