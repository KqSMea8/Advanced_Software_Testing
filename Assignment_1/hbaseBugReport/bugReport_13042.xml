<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:39:04 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13042/HBASE-13042.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13042] MR Job to export HFiles directly from an online cluster</title>
                <link>https://issues.apache.org/jira/browse/HBASE-13042</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We&apos;re looking at the best way to bootstrap a new remote cluster.  The source cluster has a a large table of compressed data using more than 50% of the HDFS capacity and we have a WAN link to the remote cluster.  Ideally we would set up replication to a new table remotely, snapshot the source table, copy the snapshot across, then bulk load it into the new table.  However the amount of time to copy the data remotely is greater than the major compaction interval so the source cluster would run out of storage.&lt;/p&gt;

&lt;p&gt;One approach is &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13031&quot; title=&quot;Ability to snapshot based on a key range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13031&quot;&gt;&lt;del&gt;HBASE-13031&lt;/del&gt;&lt;/a&gt; to allow the operators to snapshot and copy one key range at a time.  Here&apos;s another idea:&lt;/p&gt;

&lt;p&gt;Create a MR job that tries to do a robust remote HFile copy directly:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Each split is responsible for a key range.&lt;/li&gt;
	&lt;li&gt;Map task lookups up that key range and maps it to a set of HDFS store directories (one for each region/family)&lt;/li&gt;
	&lt;li&gt;For each store:
	&lt;ul&gt;
		&lt;li&gt;List HFiles in store (needs to be less than 1000 files to guarantee atomic listing)&lt;/li&gt;
		&lt;li&gt;Attempt to copy store files (copy in increasing size order to minimize likelihood of compaction removing a file during copy)&lt;/li&gt;
		&lt;li&gt;If some of the files disappear (compaction), retry directory list / copy&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;If any of the stores disappear (region split / merge) then retry map task (and remap key range to stores)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Or maybe there are some HBase locking mechanisms for a region or store that would be better.  Otherwise the question is how often would compactions or region splits force retries.&lt;/p&gt;

&lt;p&gt;Is this crazy? &lt;/p&gt;</description>
                <environment></environment>
        <key id="12774991">HBASE-13042</key>
            <summary>MR Job to export HFiles directly from an online cluster</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="davelatham">Dave Latham</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Feb 2015 18:53:55 +0000</created>
                <updated>Thu, 23 Apr 2015 19:51:12 +0000</updated>
                            <resolved>Thu, 23 Apr 2015 19:51:12 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                <comments>
                            <comment id="14320564" author="ianfriedman" created="Fri, 13 Feb 2015 18:58:03 +0000"  >&lt;p&gt;it&apos;s crazy. We&apos;re crazy. :O&lt;/p&gt;</comment>
                            <comment id="14320618" author="enis" created="Fri, 13 Feb 2015 19:29:35 +0000"  >&lt;p&gt;Here is an idea. Not sure it will help you or not. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;TableSnapshotInputFormat&lt;/tt&gt; allows you to run any MR job directly over the snapshot. It also accepts key ranges, and eliminates regions out of the range. &lt;/p&gt;

&lt;p&gt;Without &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13031&quot; title=&quot;Ability to snapshot based on a key range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13031&quot;&gt;&lt;del&gt;HBASE-13031&lt;/del&gt;&lt;/a&gt; a snapshot is still a full table snapshot, but what you can do is: &lt;/p&gt;

&lt;p&gt;Decide on table ranges (lets say N ranges)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i  in 0..N
   (1) take snapshot 
   (2) use custom MR job to export the data (create hfiles &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; bulk load) over the snapshot &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Range[i]
   (3) delete the snapshot 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You will only hold onto the single snapshot during (2), which you can control for how long it will take depending on the size of Range&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.&lt;/p&gt;</comment>
                            <comment id="14323252" author="jmhsieh" created="Mon, 16 Feb 2015 20:38:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davelatham&quot; class=&quot;user-hover&quot; rel=&quot;davelatham&quot;&gt;Dave Latham&lt;/a&gt;, Have you considered and are you aware of how the ExportSnapshot utility &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;?  It  basically is a hbase snapshot aware distcp that can copy to the target cluster and is aware of the of file move/changes if a compaction happens to the files that are being distcp&apos;ed.  It also is clever in that it doesn&apos;t attempt to recopy a file if it is already on the target cluster and has the same size.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt; can fill you in with more details.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://hbase.apache.org/book.html#ops.snapshots&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hbase.apache.org/book.html#ops.snapshots&lt;/a&gt; (section 124.8)&lt;/p&gt;</comment>
                            <comment id="14323310" author="davelatham" created="Mon, 16 Feb 2015 21:19:08 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmhsieh&quot; class=&quot;user-hover&quot; rel=&quot;jmhsieh&quot;&gt;Jonathan Hsieh&lt;/a&gt;.  We are aware of ExportSnapshot, which has a bit of an easier task since its operating on a snapshot so if a file is compacted it will still be found in the archive.  The problem in this case is that keeping an entire snapshot archived for that amount of time would run out of storage space on this cluster.&lt;/p&gt;

&lt;p&gt;It&apos;s looking more like we&apos;ll go with Andrew&apos;s suggestion of an Export (compressed), DistCp, Import (to HFile), then bulk load, for half the table each time.  It unfortunately requires some extra data copies, but the extra compression will get it to so that we can do it in only two passes (half the table each time) and cut down on the data transfer time.&lt;/p&gt;</comment>
                            <comment id="14509672" author="churromorales" created="Thu, 23 Apr 2015 19:50:23 +0000"  >&lt;p&gt;So just as an update.  We decided to go with Partial Snapshot (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13031&quot; title=&quot;Ability to snapshot based on a key range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13031&quot;&gt;&lt;del&gt;HBASE-13031&lt;/del&gt;&lt;/a&gt;) -&amp;gt; ExportSnapshot -&amp;gt; Load Incremental (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11409&quot; title=&quot;Add more flexibility for input directory structure to LoadIncrementalHFiles&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11409&quot;&gt;HBASE-11409&lt;/a&gt;).  The reason we didn&apos;t go with the aforementioned Export / Import option was due to the large shuffle as a result of the Import.  For our table that would have been a 1.2PB shuffle.  This method worked out really well for us.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 13 Feb 2015 18:58:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25m67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>