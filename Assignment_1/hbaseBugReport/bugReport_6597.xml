<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:38:10 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6597/HBASE-6597.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6597] Block Encoding Size Estimation</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6597</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Blocks boundaries as created by current writers are determined by the size of the unencoded data. However, blocks in memory are kept encoded. By using an estimate for the encoded size of the block, we can get greater consistency in size.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12603766">HBASE-6597</key>
            <summary>Block Encoding Size Estimation</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="3" iconUrl="https://issues.apache.org/jira/images/icons/statuses/inprogress.png" description="This issue is being actively worked on at the moment by the assignee.">In Progress</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="mikhail">Mikhail Bautin</assignee>
                                    <reporter username="nixon">Brian Nixon</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Aug 2012 18:18:58 +0000</created>
                <updated>Mon, 29 Oct 2012 00:01:21 +0000</updated>
                                            <version>0.89-fb</version>
                                                    <component>io</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13469931" author="phabricator@reviews.facebook.net" created="Fri, 5 Oct 2012 00:53:47 +0000"  >&lt;p&gt;mbautin requested code review of &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;br/&gt;
Reviewers: Kannan, Karthik, Liyin, aaiyer, avf, JIRA&lt;/p&gt;

&lt;p&gt;  Instead of accumulating a block of key-values of predetermined size and then delta-encoding it, we encode key-value pairs as we add them and start a new block when the *&lt;b&gt;encoded&lt;/b&gt;* size exceeds the configured block size. This work was done by Brian Nixon. I did necessary testing and bug fixes.&lt;/p&gt;

&lt;p&gt;TEST PLAN&lt;br/&gt;
  Run unit tests&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoding.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncodedDataBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoderImpl.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileReaderV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileWriterV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/NoOpDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ByteBufferUtils.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/TestDataBlockEncoders.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestCacheOnWrite.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFile.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlockIndex.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestIncrementalEncoding.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestByteBufferUtils.java&lt;/p&gt;

&lt;p&gt;MANAGE HERALD DIFFERENTIAL RULES&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/herald/view/differential/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/herald/view/differential/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;WHY DID I GET THIS EMAIL?&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/herald/transcript/13989/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/herald/transcript/13989/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;/p&gt;</comment>
                            <comment id="13469933" author="phabricator@reviews.facebook.net" created="Fri, 5 Oct 2012 00:55:47 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  The original review (Facebook-internal, just for the record): &lt;a href=&quot;https://phabricator.fb.com/D554523&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://phabricator.fb.com/D554523&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;/p&gt;</comment>
                            <comment id="13470475" author="phabricator@reviews.facebook.net" created="Fri, 5 Oct 2012 17:14:02 +0000"  >&lt;p&gt;tedyu has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:38 Length of prefix is returned.&lt;br/&gt;
  Name this method getCommonPrefixLength ?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java:93 Do we need to consider memstoreTS ?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:340 Check / assert that skipLastBytes is not negative ?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:422 prevKey stores the previous key, right ?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:497 Name this variable negativeDiffTimestamp ?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java:411 This class can be private, right ?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:420 This class can be private, right ?&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471181" author="phabricator@reviews.facebook.net" created="Sun, 7 Oct 2012 09:40:02 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;br/&gt;
Reviewers: Kannan, Karthik, Liyin, aaiyer, avf, JIRA&lt;/p&gt;

&lt;p&gt;  Removing code duplication on the encoding codepath. Addressing some of Ted&apos;s comments (I will double-check that I have not missed any of them later).&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CompressionState.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoding.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncodedDataBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoderImpl.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileReaderV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileWriterV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/NoOpDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ByteBufferUtils.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/TestDataBlockEncoders.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestCacheOnWrite.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFile.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlockIndex.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestIncrementalEncoding.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestByteBufferUtils.java&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471330" author="phabricator@reviews.facebook.net" created="Sun, 7 Oct 2012 21:44:02 +0000"  >&lt;p&gt;tedyu has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  Code is cleaner in patch v2.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java:173 This class can be private.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java:186 Javadoc and code mismatch.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:76 Would memstoreTS always be part of in ?&lt;br/&gt;
  If so, do you need to advance the position inside in when includesMemstoreTS is false ?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:119 Consider adding an assertion.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:447 Do you want to include more information in String representation ?&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java:96 Why skipping the case of includesMemstoreTS being true ?&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471355" author="phabricator@reviews.facebook.net" created="Sun, 7 Oct 2012 23:38:02 +0000"  >&lt;p&gt;tedyu has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  My previous comments for PrefixKeyDeltaEncoder.java were for patch v1.&lt;br/&gt;
  Phabricator remembered my unfinished comments and sent them out.&lt;/p&gt;

&lt;p&gt;  FYI&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471358" author="phabricator@reviews.facebook.net" created="Sun, 7 Oct 2012 23:52:02 +0000"  >&lt;p&gt;tedyu has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  I got some test failures in TestCacheOnWrite:&lt;/p&gt;

&lt;p&gt;    testStoreFileCacheOnWrite&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;(org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite): expected:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;65, LEAF_INDEX=121&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt; but was:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;91, LEAF_INDEX=124&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt;&lt;br/&gt;
    testStoreFileCacheOnWrite&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;(org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite): expected:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;65, LEAF_INDEX=121&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt; but was:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;91, LEAF_INDEX=124&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt;&lt;br/&gt;
    testStoreFileCacheOnWrite&lt;span class=&quot;error&quot;&gt;&amp;#91;8&amp;#93;&lt;/span&gt;(org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite): expected:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;65, LEAF_INDEX=121&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt; but was:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;91, LEAF_INDEX=124&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt;&lt;br/&gt;
    testStoreFileCacheOnWrite&lt;span class=&quot;error&quot;&gt;&amp;#91;11&amp;#93;&lt;/span&gt;(org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite): expected:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;65, LEAF_INDEX=121&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt; but was:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;91, LEAF_INDEX=124&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt;&lt;br/&gt;
    testStoreFileCacheOnWrite&lt;span class=&quot;error&quot;&gt;&amp;#91;14&amp;#93;&lt;/span&gt;(org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite): expected:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;65, LEAF_INDEX=121&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt; but was:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;91, LEAF_INDEX=124&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt;&lt;br/&gt;
    testStoreFileCacheOnWrite&lt;span class=&quot;error&quot;&gt;&amp;#91;17&amp;#93;&lt;/span&gt;(org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite): expected:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;65, LEAF_INDEX=121&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt; but was:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;91, LEAF_INDEX=124&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt;&lt;/p&gt;

&lt;p&gt;  Here is one of the above:&lt;/p&gt;

&lt;p&gt;  testStoreFileCacheOnWrite&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;(org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite)  Time elapsed: 0.295 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
  org.junit.ComparisonFailure: expected:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;65, LEAF_INDEX=121&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt; but was:&amp;lt;{ENCODED_DATA=9&lt;span class=&quot;error&quot;&gt;&amp;#91;91, LEAF_INDEX=124&amp;#93;&lt;/span&gt;, BLOOM_CHUNK=9, INT...&amp;gt;&lt;br/&gt;
    at org.junit.Assert.assertEquals(Assert.java:123)&lt;br/&gt;
    at org.junit.Assert.assertEquals(Assert.java:145)&lt;br/&gt;
    at org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite.readStoreFile(TestCacheOnWrite.java:259)&lt;br/&gt;
    at org.apache.hadoop.hbase.io.hfile.TestCacheOnWrite.testStoreFileCacheOnWrite(TestCacheOnWrite.java:203)&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471440" author="phabricator@reviews.facebook.net" created="Mon, 8 Oct 2012 08:00:02 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;br/&gt;
Reviewers: Kannan, Karthik, Liyin, aaiyer, avf, JIRA&lt;/p&gt;

&lt;p&gt;  Critical bugfixes in updating encoder state.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CompressionState.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoding.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncodedDataBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoderImpl.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileReaderV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileWriterV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/NoOpDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ByteBufferUtils.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/TestDataBlockEncoders.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestCacheOnWrite.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFile.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlockIndex.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestIncrementalEncoding.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestByteBufferUtils.java&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471766" author="phabricator@reviews.facebook.net" created="Mon, 8 Oct 2012 19:00:02 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:38 Done.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java:93 Yes, that&apos;s a good catch.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:340 Done.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:420 Done (here and in other encoded writers).&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:422 Yes, the comment was incorrect. Moved this field to the encoder state.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:497 Done.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java:411 Done.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java:173 Done.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java:186 Yes, this javadoc was incorrect. Moved this to encoder state.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471784" author="phabricator@reviews.facebook.net" created="Mon, 8 Oct 2012 19:16:02 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:76 includesMemstoreTS means that we are memstore timestamp is part of both input and output. We don&apos;t change that aspect of the data format on data block encoding/decoding.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:119 Added an assertion to BufferedEncodedWriter. The code below won&apos;t make currentState null if it is not null initially.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:447 As you can see, the DataBlockEncoder class does not have a lot of state (unlike the EncodedWriter) so I don&apos;t know what else I could include here.&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java:96 Oops. That was for debugging. Good catch!&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471799" author="phabricator@reviews.facebook.net" created="Mon, 8 Oct 2012 19:34:02 +0000"  >&lt;p&gt;tedyu has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java:447 Got you.&lt;/p&gt;

&lt;p&gt;  Then this implementation is fine.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13471804" author="phabricator@reviews.facebook.net" created="Mon, 8 Oct 2012 19:42:02 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;br/&gt;
Reviewers: Kannan, Karthik, Liyin, aaiyer, avf, JIRA&lt;/p&gt;

&lt;p&gt;  Addressing Ted&apos;s comments.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoding.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncodedDataBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncodingState.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CompressionState.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoderImpl.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileReaderV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileWriterV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/NoOpDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ByteBufferUtils.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/TestDataBlockEncoders.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestCacheOnWrite.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFile.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlockIndex.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestIncrementalEncoding.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestByteBufferUtils.java&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13480431" author="phabricator@reviews.facebook.net" created="Fri, 19 Oct 2012 22:02:11 +0000"  >&lt;p&gt;Kannan has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  comments thus far...&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java:445 mismath -&amp;gt; mismatch&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java:446 don&apos;t you need two more %s&apos;s.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ByteBufferUtils.java:132 shouldn&apos;t this be:&lt;/p&gt;

&lt;p&gt;  if (length - offset &amp;lt; Bytes.SIZEOF_INT)&lt;/p&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java:29 I think this comment is no longer valid.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;It gets used for ENCODING =&amp;gt; &apos;NONE&apos; case now correct?&lt;/li&gt;
	&lt;li&gt;Wondering now, if that was a correct choice... because we seem to be having to jump through some hoops to handle this encoder as a separate case (such as to not write the headers, etc.).&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13481530" author="phabricator@reviews.facebook.net" created="Mon, 22 Oct 2012 17:28:11 +0000"  >&lt;p&gt;Kannan has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java:29 Regarding the second bullet (in my comment), I suppose it is ok to leave this as is... as it does simplify the calling logic a little bit. We should just add here in comments that&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;this is used for non-encoded blocks.&lt;/li&gt;
	&lt;li&gt;and, keeps blocks in old format (without the DBE specific headers).&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java:35 use integer compression for key, value and prefix (7-bit encoding)&lt;br/&gt;
  --&amp;gt;&lt;br/&gt;
  use integer compression for key, value and prefix lengths (7-bit encoding)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:34 ditto (as other comment)&lt;/p&gt;

&lt;p&gt;  s/prefix/prefix lengths&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13481531" author="phabricator@reviews.facebook.net" created="Mon, 22 Oct 2012 17:28:11 +0000"  >&lt;p&gt;Kannan has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  Mikhail - looks great. Pending comments are very trivial.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13482543" author="phabricator@reviews.facebook.net" created="Tue, 23 Oct 2012 18:25:11 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  Replying to comments inline.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java:29 Updated the comment.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java:34 Done.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java:35 Done.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ByteBufferUtils.java:132 Updated the comment. length &amp;lt; Bytes.SIZEOF_INT is correct (this is the length of the part of the array we are allowed to write into).&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java:445 Done.&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java:446 No. The two last parameters are for assertEquals.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13482549" author="phabricator@reviews.facebook.net" created="Tue, 23 Oct 2012 18:29:11 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;br/&gt;
Reviewers: Kannan, Karthik, Liyin, aaiyer, avf, JIRA&lt;/p&gt;

&lt;p&gt;  Addressing Kannan&apos;s comments and rebasing.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/BufferedDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CopyKeyDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DataBlockEncoding.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/DiffKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncodedDataBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/EncodingState.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/CompressionState.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/FastDiffDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/encoding/PrefixKeyDeltaEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileBlock.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileDataBlockEncoderImpl.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileReaderV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/HFileWriterV2.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/io/hfile/NoOpDataBlockEncoder.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ByteBufferUtils.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/encoding/TestDataBlockEncoders.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestCacheOnWrite.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFile.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlock.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestHFileBlockIndex.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/io/hfile/TestIncrementalEncoding.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestByteBufferUtils.java&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13482737" author="phabricator@reviews.facebook.net" created="Tue, 23 Oct 2012 21:56:11 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  Verified that the effective in-cache block size for encoded blocks is close enough to the configured size during a load test. Committing.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13482818" author="phabricator@reviews.facebook.net" created="Tue, 23 Oct 2012 23:24:11 +0000"  >&lt;p&gt;mbautin has abandoned the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6597&quot; title=&quot;Block Encoding Size Estimation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6597&quot;&gt;HBASE-6597&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Incremental data block encoding&quot;.&lt;/p&gt;

&lt;p&gt;  Committed as rHBASEEIGHTNINEFBBRANCH1401499.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D5895&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D5895&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To: Kannan, Karthik, Liyin, aaiyer, avf, JIRA, mbautin&lt;br/&gt;
Cc: tedyu&lt;/p&gt;</comment>
                            <comment id="13484422" author="yuzhihong@gmail.com" created="Thu, 25 Oct 2012 19:44:12 +0000"  >&lt;p&gt;Patch for trunk.&lt;br/&gt;
There are some compilation errors in tests.&lt;/p&gt;</comment>
                            <comment id="13484436" author="apurtell" created="Thu, 25 Oct 2012 19:57:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ted_yu&quot; class=&quot;user-hover&quot; rel=&quot;ted_yu&quot;&gt;Ted Yu&lt;/a&gt; Are you planning to fix the compilation errors?&lt;/p&gt;</comment>
                            <comment id="13484441" author="yuzhihong@gmail.com" created="Thu, 25 Oct 2012 20:03:37 +0000"  >&lt;p&gt;I am planning to continue the work.&lt;/p&gt;</comment>
                            <comment id="13484505" author="yuzhihong@gmail.com" created="Thu, 25 Oct 2012 21:41:50 +0000"  >&lt;p&gt;Patch that compiles against trunk.&lt;/p&gt;

&lt;p&gt;There&apos;re test failures.&lt;/p&gt;</comment>
                            <comment id="13485756" author="zhihyu@ebaysf.com" created="Mon, 29 Oct 2012 00:01:21 +0000"  >&lt;p&gt;Update on my recent fidings.&lt;br/&gt;
I came up with patch for 0.94 branch.&lt;br/&gt;
Most data block encoding related tests pass.&lt;br/&gt;
TestHFileBlockCompatibility poses a little challenge. There is no embedded checksum feature in 0.89-fb branch. So this test is unique to 0.94 / trunk.&lt;br/&gt;
In the test, there is a copy of Writer class which I assume shouldn&apos;t be modified, at least not for a point release.&lt;br/&gt;
The test reuses some code from TestHFileBlock.java where there is some change related to usage of Writer:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
- &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; writeTestKeyValues(OutputStream dos, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; seed, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; includesMemstoreTS)
+ &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void writeTestKeyValues(OutputStream dos, Writer hbw, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; seed, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; includesMemstoreTS)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is the test failure I am observing now:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
testDataBlockEncoding[0](org.apache.hadoop.hbase.io.hfile.TestHFileBlockCompatibility)  Time elapsed: 0.129 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
org.junit.ComparisonFailure: Content mismath &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; compression NONE, encoding PREFIX, pread &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, commonPrefix 2, expected length 1859, actual length 1859 expected:&amp;lt;\x00\x00\x0[B\xB8]*\x0A\x00\x00\x0A\x0...&amp;gt; but was:&amp;lt;\x00\x00\x0[0\x00]*\x0A\x00\x00\x0A\x0...&amp;gt;
  at org.junit.Assert.assertEquals(Assert.java:125)
  at org.apache.hadoop.hbase.io.hfile.TestHFileBlock.assertBuffersEqual(TestHFileBlock.java:463)
  at org.apache.hadoop.hbase.io.hfile.TestHFileBlockCompatibility.testDataBlockEncoding(TestHFileBlockCompatibility.java:337)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12550873" name="6597-trunk.txt" size="95111" author="yuzhihong@gmail.com" created="Thu, 25 Oct 2012 21:41:50 +0000"/>
                            <attachment id="12547860" name="D5895.1.patch" size="68448" author="phabricator@reviews.facebook.net" created="Fri, 5 Oct 2012 00:53:47 +0000"/>
                            <attachment id="12548155" name="D5895.2.patch" size="91839" author="phabricator@reviews.facebook.net" created="Sun, 7 Oct 2012 09:40:02 +0000"/>
                            <attachment id="12548210" name="D5895.3.patch" size="91748" author="phabricator@reviews.facebook.net" created="Mon, 8 Oct 2012 08:00:02 +0000"/>
                            <attachment id="12548289" name="D5895.4.patch" size="95324" author="phabricator@reviews.facebook.net" created="Mon, 8 Oct 2012 19:42:02 +0000"/>
                            <attachment id="12550510" name="D5895.5.patch" size="97004" author="phabricator@reviews.facebook.net" created="Tue, 23 Oct 2012 18:29:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 5 Oct 2012 00:53:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241859</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 7 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02ez3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12027</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>