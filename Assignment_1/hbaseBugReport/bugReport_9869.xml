<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:08:20 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-9869/HBASE-9869.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-9869] Optimize HConnectionManager#getCachedLocation</title>
                <link>https://issues.apache.org/jira/browse/HBASE-9869</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;It javadoc says: &quot;TODO: This method during writing consumes 15% of CPU doing lookup&quot;. This is still true, says Yourkit. With 0.96, we also spend more time in these methods. We retry more, and the AsyncProcess calls it in parallel.&lt;/p&gt;

&lt;p&gt;I don&apos;t have the patch for this yet, but I will spend some time on it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12676893">HBASE-9869</key>
            <summary>Optimize HConnectionManager#getCachedLocation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkeywal">Nicolas Liochon</assignee>
                                    <reporter username="nkeywal">Nicolas Liochon</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Oct 2013 16:56:13 +0000</created>
                <updated>Mon, 16 Dec 2013 18:46:43 +0000</updated>
                            <resolved>Sun, 17 Nov 2013 10:33:34 +0000</resolved>
                                    <version>0.98.0</version>
                    <version>0.96.0</version>
                                    <fixVersion>0.98.0</fixVersion>
                    <fixVersion>0.96.1</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13810439" author="stack" created="Thu, 31 Oct 2013 17:08:15 +0000"  >&lt;p&gt;Yeah, I have been seeing around 10-12%.&lt;/p&gt;</comment>
                            <comment id="13810576" author="stack" created="Thu, 31 Oct 2013 19:16:54 +0000"  >&lt;p&gt;(/me ....channelling &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tlipcon&quot; class=&quot;user-hover&quot; rel=&quot;tlipcon&quot;&gt;Todd Lipcon&lt;/a&gt;) ... caveat the fact that we are profiling using java profilers so actual cpu could be wildly different&lt;/p&gt;</comment>
                            <comment id="13810628" author="nkeywal" created="Thu, 31 Oct 2013 19:55:29 +0000"  >&lt;p&gt;Yeah, I agree. There is always a risk. Still the logic seems strange to me. I&apos;m not sure the soft reference is still useful in 2013 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. And removing the synchronized seems better. I&apos;m looking for a quick hack to see if there is a difference.&lt;/p&gt;</comment>
                            <comment id="13811483" author="ndimiduk" created="Fri, 1 Nov 2013 17:30:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;caveat the fact that we are profiling using java profilers&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I plan to try out an OpenJDK install + the &lt;a href=&quot;https://code.google.com/p/lightweight-java-profiler/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;lightweight-profiler&lt;/a&gt; this weekend, see if I can get it working with perfeval or similar.&lt;/p&gt;</comment>
                            <comment id="13815227" author="nkeywal" created="Wed, 6 Nov 2013 20:03:23 +0000"  >&lt;p&gt;On this one, from what I saw the measure was real, but it was also because we were creating too many objects. Now that we&apos;re in better shape, it should be less visible.&lt;/p&gt;

&lt;p&gt;This said, I feel that using a simple implementation without any weak/soft reference would be more efficient. That&apos;s what AsyncHBase is doing for example...&lt;/p&gt;</comment>
                            <comment id="13821378" author="stack" created="Wed, 13 Nov 2013 14:34:53 +0000"  >&lt;p&gt;See any difference?  Whats the math like?  How large is the Map if 1M regions in it?  We remove when region is bad but ones we don&apos;t access could stick around for ever. I suppose that serves us right if we don&apos;t access them.  Folks like Lars are sensitive about clients being well-behaved especially when embedded in an apps server.  I looked around for a simple LRU &amp;#8211; the guava one &amp;#8211; but we need SortedMap.&lt;/p&gt;</comment>
                            <comment id="13821382" author="hadoopqa" created="Wed, 13 Nov 2013 14:40:50 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12613359/9869.v1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12613359/9869.v1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop1.0&lt;/font&gt;.  The patch compiles against the hadoop 1.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop2.0&lt;/font&gt;.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 javadoc&lt;/font&gt;.  The javadoc tool appears to have generated 1 warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 site&lt;/font&gt;.  The patch appears to cause mvn site goal to fail.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.client.TestMultiParallel&lt;br/&gt;
                  org.apache.hadoop.hbase.io.encoding.TestChangingEncoding&lt;br/&gt;
                  org.apache.hadoop.hbase.coprocessor.TestRegionServerCoprocessorExceptionWithAbort&lt;br/&gt;
                  org.apache.hadoop.hbase.regionserver.TestEndToEndSplitTransaction&lt;br/&gt;
                  org.apache.hadoop.hbase.client.TestAdmin&lt;br/&gt;
                  org.apache.hadoop.hbase.client.TestHCM&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestDistributedLogSplitting&lt;br/&gt;
                  org.apache.hadoop.hbase.regionserver.TestServerCustomProtocol&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7842//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13821859" author="hadoopqa" created="Wed, 13 Nov 2013 21:25:52 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12613615/9869.v1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12613615/9869.v1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop1.0&lt;/font&gt;.  The patch compiles against the hadoop 1.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop2.0&lt;/font&gt;.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 javadoc&lt;/font&gt;.  The javadoc tool appears to have generated 1 warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 site&lt;/font&gt;.  The patch appears to cause mvn site goal to fail.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.client.TestMultiParallel&lt;br/&gt;
                  org.apache.hadoop.hbase.io.encoding.TestChangingEncoding&lt;br/&gt;
                  org.apache.hadoop.hbase.TestFullLogReconstruction&lt;br/&gt;
                  org.apache.hadoop.hbase.replication.TestReplicationKillMasterRS&lt;br/&gt;
                  org.apache.hadoop.hbase.coprocessor.TestRegionServerCoprocessorExceptionWithAbort&lt;br/&gt;
                  org.apache.hadoop.hbase.replication.TestReplicationKillSlaveRS&lt;br/&gt;
                  org.apache.hadoop.hbase.regionserver.TestEndToEndSplitTransaction&lt;br/&gt;
                  org.apache.hadoop.hbase.client.TestAdmin&lt;br/&gt;
                  org.apache.hadoop.hbase.client.TestHCM&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestSecureLoadIncrementalHFilesSplitRecovery&lt;br/&gt;
                  org.apache.hadoop.hbase.regionserver.TestServerCustomProtocol&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7845//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13822357" author="hadoopqa" created="Thu, 14 Nov 2013 12:08:55 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12613812/9869.v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12613812/9869.v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop1.0&lt;/font&gt;.  The patch compiles against the hadoop 1.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop2.0&lt;/font&gt;.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 javadoc&lt;/font&gt;.  The javadoc tool appears to have generated 2 warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 site&lt;/font&gt;.  The patch appears to cause mvn site goal to fail.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7861//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13822368" author="nkeywal" created="Thu, 14 Nov 2013 12:22:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;See any difference? Whats the math like? How large is the Map if 1M regions in it? We remove when region is bad but ones we don&apos;t access could stick around for ever. I suppose that serves us right if we don&apos;t access them. Folks like Lars are sensitive about clients being well-behaved especially when embedded in an apps server. I looked around for a simple LRU &#8211; the guava one &#8211; but we need SortedMap.&lt;/p&gt;&lt;/blockquote&gt;


&lt;p&gt;My feeling is that if you have a table with 1 million regions  you need to pay the price for this: i.e. have enough memory on the client.&lt;br/&gt;
Let me do the math &amp;amp; test it however.&lt;br/&gt;
We can as well do something in the middle: do a LRU on the first map, the one on the tableName.&lt;/p&gt;</comment>
                            <comment id="13822692" author="nkeywal" created="Thu, 14 Nov 2013 18:06:02 +0000"  >&lt;p&gt;I&apos;ve done some tests with TestClientNoCluster with 10000 regions&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;#clients&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;#puts&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;time without the patch&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;time with the patch&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;1 client&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 100 million&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 94 seconds&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;65 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2 clients&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 50 million each&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 82 seconds&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;56 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;5 clients&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 20 million each&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 105 seconds&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;66 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;With 5 clients, we have 10 threads trying to insert as much as possible, so more clients means more context switches on more memory pressure (it&apos;s different if they have to wait for an answer from a server of course).&lt;br/&gt;
I need to do more tests with more regions. But so far so good I would say.&lt;/p&gt;</comment>
                            <comment id="13823044" author="stack" created="Thu, 14 Nov 2013 22:36:40 +0000"  >&lt;p&gt;Patch should remove softsortedvaluemap too while you are at it.&lt;/p&gt;

&lt;p&gt;Numbers look good.&lt;/p&gt;

&lt;p&gt;On the middle approach, we&apos;d drop unused tables.  That could help.&lt;/p&gt;

&lt;p&gt;Anyway to get deepsize of the Map?  If it were &amp;gt; some %age of the heap, we could just run a clean or purge of it as a precaution against leaks or OOME&apos;ing on big cluster.  Would that be hard to do?&lt;/p&gt;</comment>
                            <comment id="13823509" author="nkeywal" created="Fri, 15 Nov 2013 09:22:27 +0000"  >&lt;p&gt;Yourkit calculates the retained size, i.e. &lt;cite&gt;Retained size of an object is its shallow size plus the shallow sizes of the objects that are accessible, directly or indirectly, only from this object. In other words, the retained size represents the amount of memory that will be freed by the garbage collector when this object is collected.&lt;/cite&gt;&lt;br/&gt;
With 10 thousand regions, the retained size of the two ConcurrentSkipListMap is 7 mega bytes.&lt;br/&gt;
With 100 thousands regions, the retained size is 75 mega bytes. 19 megs are TableName objects, and this leads to an obvious optimization (I had it in mind already, to save on &apos;equals&apos; but the final size is crazy). On the same range, we have 3.3 mb of ServerName.&lt;/p&gt;

&lt;p&gt;Lastly, I don&apos;t think that a Map is the best algorithm, a Trie would be much better. I will have a look at this as well.&lt;/p&gt;

&lt;p&gt;With 100k regions, time is:&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;#clients&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;#puts&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;time without the patch&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;time with the patch&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2 clients&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 50 million each&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 83 seconds&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;58 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;With these results my opinion is that we should commit this patch as it is, because:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;60 Mb is acceptable for a client connected to a cluster with 100K regions.&lt;/li&gt;
	&lt;li&gt;In most cases, the weak reference will just make the performance unpredictable. The remaining cases (regions not used often so we can remove them under memory pressure) does not justify the noise for the other cases.&lt;/li&gt;
	&lt;li&gt;We can lower the memory foot print further if necessary, and it&apos;s likely a better solution than playing with the GC.&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="13824618" author="nkeywal" created="Sat, 16 Nov 2013 20:38:00 +0000"  >&lt;p&gt;I&apos;ve tested v4 with 100K regions, on a scenario with random writes (and a different computer than the previous tests: the results are not directly comparable).&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;#clients&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;#puts&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;time without the patch&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;time with the patch&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2 clients&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 50 million each&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 114 seconds&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;72 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;So there is a 65% gap between the two versions.&lt;/p&gt;</comment>
                            <comment id="13824655" author="hadoopqa" created="Sat, 16 Nov 2013 22:13:00 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12614243/6869.v4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12614243/6869.v4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop1.0&lt;/font&gt;.  The patch compiles against the hadoop 1.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop2.0&lt;/font&gt;.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 javadoc&lt;/font&gt;.  The javadoc tool appears to have generated 10 warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 site&lt;/font&gt;.  The patch appears to cause mvn site goal to fail.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/7898//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13824669" author="yuzhihong@gmail.com" created="Sat, 16 Nov 2013 23:22:20 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13824755" author="stack" created="Sun, 17 Nov 2013 06:05:21 +0000"  >&lt;p&gt;Ok.  Sounds like it would take a good while for the client to fill up if there was a leak.  Yeah, trie would be better but this is good for now.  You opened an issue on interning TableNames. That patch looks good.  We should open another for ServerName?  Makes sense.&lt;/p&gt;</comment>
                            <comment id="13824800" author="nkeywal" created="Sun, 17 Nov 2013 10:39:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;You opened an issue on interning TableNames. That patch looks good. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m still on this one, to understand why the performances varied, and looking for the best solution. For example, the tableName is already in the regionName of the HRegionInfo. May be HRegionInfo should not have a reference to the TableName object, we don&apos;t need it that often. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We should open another for ServerName? Makes sense.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I still on this one as well &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. It&apos;s more complex, because the number of serverName is theoretically unbounded, as it includes a startCode.&lt;/p&gt;

&lt;p&gt;I&apos;ve just committed the v4. I&apos;m quite happy to have this part done...&lt;/p&gt;</comment>
                            <comment id="13824866" author="hudson" created="Sun, 17 Nov 2013 15:18:59 +0000"  >&lt;p&gt;FAILURE: Integrated in hbase-0.96-hadoop2 #121 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96-hadoop2/121/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96-hadoop2/121/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9869&quot; title=&quot;Optimize HConnectionManager#getCachedLocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9869&quot;&gt;&lt;del&gt;HBASE-9869&lt;/del&gt;&lt;/a&gt; Optimize HConnectionManager#getCachedLocation - remove SoftValueSortedMap (nkeywal: rev 1542698)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-common/src/main/java/org/apache/hadoop/hbase/util/SoftValueSortedMap.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9869&quot; title=&quot;Optimize HConnectionManager#getCachedLocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9869&quot;&gt;&lt;del&gt;HBASE-9869&lt;/del&gt;&lt;/a&gt; Optimize HConnectionManager#getCachedLocation (nkeywal: rev 1542690)&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13824868" author="hudson" created="Sun, 17 Nov 2013 15:28:49 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK #4683 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/4683/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/4683/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9869&quot; title=&quot;Optimize HConnectionManager#getCachedLocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9869&quot;&gt;&lt;del&gt;HBASE-9869&lt;/del&gt;&lt;/a&gt; Optimize HConnectionManager#getCachedLocation - remove SoftValueSortedMap (nkeywal: rev 1542699)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-common/src/main/java/org/apache/hadoop/hbase/util/SoftValueSortedMap.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9869&quot; title=&quot;Optimize HConnectionManager#getCachedLocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9869&quot;&gt;&lt;del&gt;HBASE-9869&lt;/del&gt;&lt;/a&gt; Optimize HConnectionManager#getCachedLocation (nkeywal: rev 1542688)&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13824870" author="hudson" created="Sun, 17 Nov 2013 15:28:52 +0000"  >&lt;p&gt;SUCCESS: Integrated in hbase-0.96 #192 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.96/192/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.96/192/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9869&quot; title=&quot;Optimize HConnectionManager#getCachedLocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9869&quot;&gt;&lt;del&gt;HBASE-9869&lt;/del&gt;&lt;/a&gt; Optimize HConnectionManager#getCachedLocation - remove SoftValueSortedMap (nkeywal: rev 1542698)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-common/src/main/java/org/apache/hadoop/hbase/util/SoftValueSortedMap.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9869&quot; title=&quot;Optimize HConnectionManager#getCachedLocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9869&quot;&gt;&lt;del&gt;HBASE-9869&lt;/del&gt;&lt;/a&gt; Optimize HConnectionManager#getCachedLocation (nkeywal: rev 1542690)&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.96/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13824884" author="hudson" created="Sun, 17 Nov 2013 15:33:51 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #840 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/840/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/840/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9869&quot; title=&quot;Optimize HConnectionManager#getCachedLocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9869&quot;&gt;&lt;del&gt;HBASE-9869&lt;/del&gt;&lt;/a&gt; Optimize HConnectionManager#getCachedLocation - remove SoftValueSortedMap (nkeywal: rev 1542699)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-common/src/main/java/org/apache/hadoop/hbase/util/SoftValueSortedMap.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9869&quot; title=&quot;Optimize HConnectionManager#getCachedLocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9869&quot;&gt;&lt;del&gt;HBASE-9869&lt;/del&gt;&lt;/a&gt; Optimize HConnectionManager#getCachedLocation (nkeywal: rev 1542688)&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13824989" author="stack" created="Sun, 17 Nov 2013 23:07:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;For example, the tableName is already in the regionName of the HRegionInfo. May be HRegionInfo should not have a reference to the TableName object, we don&apos;t need it that often.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought HRI only had a table name, not a TableName?  We did a load of work to make it so HRI didn&apos;t have a HTD; would be a shame to go back there.  Good on you N.&lt;/p&gt;</comment>
                            <comment id="13825038" author="lhofhansl" created="Mon, 18 Nov 2013 02:09:36 +0000"  >&lt;p&gt;I have suggested changing this in the past, but the consensus used to be that we do not want to remove the soft value reference map (which would allow the GC to clean out entries from the map when memory is tight).&lt;/p&gt;

&lt;p&gt;I think soft references for caching are an anti-pattern (we&apos;re short of memory so we clear the cache in order to do more work if we need the cached data again)... But I wonder whether something has changed in the past year that makes that OK now.&lt;/p&gt;

&lt;p&gt;Anyway, +1 from my side.&lt;/p&gt;</comment>
                            <comment id="13825115" author="stack" created="Mon, 18 Nov 2013 05:17:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;But I wonder whether something has changed in the past year that makes that OK now.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We are wiser and see the wisdom of your ways now &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;! (smile).  There is reluctance in evidence above still.  I think the @nkeywal numbers that show how little memory is needed and then the work to make it smaller still helped the argument.&lt;/p&gt;</comment>
                            <comment id="13825178" author="nkeywal" created="Mon, 18 Nov 2013 08:32:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;we&apos;re short of memory so we clear the cache in order to do more work if we need the cached data again&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s exactly that was happening, and that&apos;s why we went from 114s to 72s with the patch. I guess that protobuf added a lot of pressure on the GC, hence this behavior (but I&apos;ve done the test with the latest trunk, it includes a lot of cleanup already).&lt;/p&gt;

&lt;p&gt;I think that the right pattern is to have the structure as small as possible,  to make it fit into the processor cache. With all these references all over the place it&apos;s difficult to know exactly how it&apos;s going to behave.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I thought HRI only had a table name, not a TableName? We did a load of work to make it so HRI didn&apos;t have a HTD; would be a shame to go back there&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There is an attribute &quot;TableName&quot; in HRI, and createRegionName copy the &quot;table name&quot; in another attribute &quot;regionName&quot;: so we store it twice... I will see if I can remove it.&lt;/p&gt;

</comment>
                            <comment id="13849486" author="stack" created="Mon, 16 Dec 2013 18:46:43 +0000"  >&lt;p&gt;Released in 0.96.1.  Issue closed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12674011">HBASE-9775</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12614243" name="6869.v4.patch" size="15378" author="nkeywal" created="Sat, 16 Nov 2013 20:34:11 +0000"/>
                            <attachment id="12613615" name="9869.v1.patch" size="3555" author="nkeywal" created="Wed, 13 Nov 2013 14:55:49 +0000"/>
                            <attachment id="12613359" name="9869.v1.patch" size="3555" author="nkeywal" created="Tue, 12 Nov 2013 11:01:37 +0000"/>
                            <attachment id="12613812" name="9869.v2.patch" size="4435" author="nkeywal" created="Thu, 14 Nov 2013 10:12:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 31 Oct 2013 17:08:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356269</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pf2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356557</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>