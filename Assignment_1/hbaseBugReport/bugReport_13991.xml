<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:48:40 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13991/HBASE-13991.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13991] Hierarchical Layout for Humongous Tables</title>
                <link>https://issues.apache.org/jira/browse/HBASE-13991</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Add support for humongous tables via a hierarchical layout for regions on filesystem.  &lt;/p&gt;

&lt;p&gt;Credit for most of this code goes to Huaiyu Zhu.  &lt;/p&gt;

&lt;p&gt;Latest version of the patch is available on the review board: &lt;a href=&quot;https://reviews.apache.org/r/36029/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/36029/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Known limitation of this patch: It does not deal with HFileLinks, which means that humongous tables, as implemented in this patch, would not support snapshots or timeline consistent region replicas feature in their current form.  This could be addressed later but we had decided not to implement HFileLink support for the first version.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12841405">HBASE-13991</key>
            <summary>Hierarchical Layout for Humongous Tables</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12714102">HBASE-11165</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="10002" iconUrl="https://issues.apache.org/jira/images/icons/statuses/document.png" description="A patch for this issue has been uploaded to JIRA by a contributor.">Patch Available</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="benlau">Ben Lau</assignee>
                                    <reporter username="benlau">Ben Lau</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Jun 2015 18:07:47 +0000</created>
                <updated>Tue, 28 Jul 2015 23:31:19 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>20</watches>
                                                                <comments>
                            <comment id="14606381" author="yuzhihong@gmail.com" created="Mon, 29 Jun 2015 20:55:35 +0000"  >&lt;p&gt;Interesting initiative.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;and 2x 500 GB hard drives&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Please clarify: the master machine has more memory compared to region server machines. I expected the machine to have bigger disk, not smaller one.&lt;/p&gt;

&lt;p&gt;In the patch, I don&apos;t see AssignmentManager being modified.&lt;br/&gt;
So this change is limited to filesystem layout mostly ?&lt;/p&gt;</comment>
                            <comment id="14606521" author="benlau" created="Mon, 29 Jun 2015 22:09:48 +0000"  >&lt;p&gt;The HBase master doesn&apos;t write much to disk compared to region servers/data nodes.  Yes, this change is mostly to the filesystem layout.  We may use the &apos;humongous&apos; flag for other things in the future but currently it is only used to determine the layout.&lt;/p&gt;</comment>
                            <comment id="14606783" author="yuzhihong@gmail.com" created="Tue, 30 Jun 2015 01:15:07 +0000"  >&lt;p&gt;Can you put the patch on reviewboard ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14606793" author="benlau" created="Tue, 30 Jun 2015 01:20:08 +0000"  >&lt;p&gt;Sure.  Created a reviewboard request here: &lt;a href=&quot;https://reviews.apache.org/r/36029/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/36029/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14606802" author="hadoopqa" created="Tue, 30 Jun 2015 01:29:16 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12742556/HBASE-13991-master.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12742556/HBASE-13991-master.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit f8bd578b80b4e656d799c82ca1b6191e35bb0ae4.&lt;br/&gt;
  ATTACHMENT ID: 12742556&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 94 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/14610//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/14610//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14606824" author="yuzhihong@gmail.com" created="Tue, 30 Jun 2015 01:49:42 +0000"  >&lt;p&gt;Would there be a tool that converts current region layout to the hierarchical one ?&lt;/p&gt;</comment>
                            <comment id="14606940" author="benlau" created="Tue, 30 Jun 2015 03:43:28 +0000"  >&lt;p&gt;I don&apos;t think we had one planned but if there were enough parties interested in a tool we could probably make one.  It would probably not be too hard (unless I&apos;m missing something) for a table that can be taken offline for a short period of time.  &lt;/p&gt;

&lt;p&gt;On a side note there were some new conflicts in master since I created the patch so I have fixed them and re-uploaded a new patch in the reviewboard.  I&apos;ll treat the reviewboard as the holder of the current version of the patch and leave the attachment in this ticket as the 1st draft submission.&lt;/p&gt;</comment>
                            <comment id="14607544" author="stack" created="Tue, 30 Jun 2015 05:45:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benlau&quot; class=&quot;user-hover&quot; rel=&quot;benlau&quot;&gt;Ben Lau&lt;/a&gt; Thank you for writing up design and for the helpful experiments. &lt;/p&gt;

&lt;p&gt;&quot;Simply put, HDFS was not designed to handle the existence of millions of files/directories in a single directory. &quot;&lt;/p&gt;

&lt;p&gt;Yes.&lt;/p&gt;

&lt;p&gt;How about just making a four level bucket of all HFiles. From  &lt;a href=&quot;http://static.googleusercontent.com/media/research.google.com/en/us/archive/bigtable-osdi06.pdf&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://static.googleusercontent.com/media/research.google.com/en/us/archive/bigtable-osdi06.pdf&lt;/a&gt;, &quot;Each tablet&#8217;s SSTables are registered in the METADATA table.&quot; (Our &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt; has been going on about going this route for ever &amp;#8211; see his design attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7806&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-7806&lt;/a&gt;... It has some in common w/ yours).&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benlau&quot; class=&quot;user-hover&quot; rel=&quot;benlau&quot;&gt;Ben Lau&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="14608540" author="mbertozzi" created="Tue, 30 Jun 2015 15:40:11 +0000"  >&lt;p&gt;instead of doing an incompatible change to workaround just this problem, &lt;br/&gt;
we should look into what else can we solve by changing the fs layout.&lt;/p&gt;

&lt;p&gt;some of the point of my list are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;avoid moving files around, tmp -&amp;gt; table region -&amp;gt; archive
	&lt;ul&gt;
		&lt;li&gt;Avoid the hack &#8220;if file is not here, try there&#8221; of HFileLink&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;avoid rename() calls to simulate &quot;transactions&quot; (e.g. compaction, split, creation, deletion, ...)
	&lt;ul&gt;
		&lt;li&gt;rename calls in some environment (e.g. s3) are full copies instead of just a metadata operation&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;File sharing between different table without links &#8220;Clone Table&#8221;
	&lt;ul&gt;
		&lt;li&gt;Simplify snapshot/restore reference code and avoid all the calls to fs.listStatus(), fs.createNew()&lt;/li&gt;
		&lt;li&gt;avoid write permission required in MR over snapshots (for backlinks creation)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;we should have a single /data dir where we place data, and then each table will point to that.&lt;br/&gt;
you&apos;ll avoid moving the file around (for tmp-creation/commit and archiving) and your data is not tight together with a table, allowing things like snapshots, clones and read-replicas to work without hack. and you&apos;ll also gain some future ability to do some kind of deduplication and better compaction logic.&lt;/p&gt;

&lt;p&gt;if you look at the last slide of: &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12568749/HBASE-7806.pdf&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12568749/HBASE-7806.pdf&lt;/a&gt;&lt;br/&gt;
there was a proposed layout, where you have this kind of separation.&lt;br/&gt;
you can store the list of files in meta as Stack mentioned, or you can have some manifest file containing the current state of the table (something like the SnapshotManifest &lt;a href=&quot;https://github.com/apache/hbase/blob/master/hbase-protocol/src/main/protobuf/Snapshot.proto#L41&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/apache/hbase/blob/master/hbase-protocol/src/main/protobuf/Snapshot.proto#L41&lt;/a&gt;). the point is, do not tight together the data with the logical placement of  table/regions and have an atomic operation for when you add/remove files. think about features like snapshot and replicas where the files are not owned only by one region.&lt;/p&gt;</comment>
                            <comment id="14609376" author="enis" created="Wed, 1 Jul 2015 00:51:12 +0000"  >&lt;p&gt;I don&apos;t like introducing a concept of &quot;humongous tables&quot;. I can definitely understand that you wanted to get the layout changes without affecting other users, but adding another switch is not the way to go for operational concerns. If we are doing a layout change, we should do it for all the tables, and find a way to handle migrations automatically, etc. &lt;/p&gt;

&lt;p&gt;What other areas that a &quot;humongous table&quot; differ from a regular table? What happens if a table starts as a regular table, then becomes humongous? &lt;/p&gt;

&lt;p&gt;I like where this is going. Sorry, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benlau&quot; class=&quot;user-hover&quot; rel=&quot;benlau&quot;&gt;Ben Lau&lt;/a&gt; this might again turn into a bigger re-architect some parts kind of jira instead of a simpler patch. But I agreed with Stack and Matteo that we should take a holistic view. &lt;/p&gt;

&lt;p&gt;See: &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7806?focusedCommentId=13594284&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13594284&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-7806?focusedCommentId=13594284&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13594284&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13159&quot; title=&quot;Consider RangeReferenceFiles with transformations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13159&quot;&gt;HBASE-13159&lt;/a&gt; also talks about unifying reference files / file links and snapshot files so that the soft links is much easier to maintain.  &lt;/p&gt;</comment>
                            <comment id="14609389" author="lhofhansl" created="Wed, 1 Jul 2015 01:04:03 +0000"  >&lt;p&gt;Let&apos;s solve the problem at hand first &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Can we simply use the new layout, always? That means everything (including snapshots) needs to be supported.&lt;br/&gt;
Code would have to be able to detect old and new layout and support both, possibly forever (or we use an implicit table flag only set on new tables).&lt;/p&gt;</comment>
                            <comment id="14609514" author="benlau" created="Wed, 1 Jul 2015 03:33:22 +0000"  >&lt;p&gt;Hi guys, thanks for all the feedback.  I think we agree that it may make sense to switchover entirely to the new layout instead of making it optional.  Let me get back to you guys, I need to talk with Francis some more about the other suggestions.  Thanks guys.&lt;/p&gt;</comment>
                            <comment id="14613446" author="apurtell" created="Fri, 3 Jul 2015 20:42:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we agree that it may make sense to switchover entirely to the new layout instead of making it optional.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Agree there&apos;s broad agreement on that. &lt;/p&gt;

&lt;p&gt;Looks like also we should be able to split the need to haves from the nice to haves to scope work into increments and make it possible for some changes to go further back than master. &lt;/p&gt;</comment>
                            <comment id="14615813" author="benlau" created="Mon, 6 Jul 2015 22:52:26 +0000"  >&lt;p&gt;Hi guys, hope you had a happy 4th of July.  &lt;/p&gt;

&lt;p&gt;We would like to do something akin to Lars&#8217; last idea.  That is, we will have code to support both the old layout and the new layout, but it will be on a per HBase cluster basis.  You will be able to migrate a cluster entirely to the hierarchical layout or leave it on the old layout.  &lt;/p&gt;

&lt;p&gt;This approach has the following pros:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If HBase users do not need/want the new layout, they will not have to do an offline upgrade in order to use new HBase code.  The alternative is to make an online upgrade for the hierarchical layout, but this would require some very messy changes to the codebase and also be tricky to test fully.&lt;/li&gt;
	&lt;li&gt;HBase code will not have to &#8216;detect&#8217; whether tables/paths/regions are hierarchical or not.  The master or region server can simply look at the root table at startup and use that to determine if the cluster has migrated to the hierarchical layout.  This single source of truth would make code less ugly since you don&#8217;t need to do in-context per-region/path checks in different parts of the codebase.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you guys think about this approach?  &lt;/p&gt;</comment>
                            <comment id="14619553" author="stack" created="Wed, 8 Jul 2015 23:11:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;What do you guys think about this approach?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We&apos;d have to keep up two ways of accessing files (One of the lads used to try hard to keep all filesystem access encapsulated inside a class but was frustrated because not all of us played along... )&lt;/p&gt;

&lt;p&gt;Tell us more how you think it would work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benlau&quot; class=&quot;user-hover&quot; rel=&quot;benlau&quot;&gt;Ben Lau&lt;/a&gt;?  You still want to insert that tier of &apos;buckets&apos; under a table as per your attached doc?&lt;/p&gt;

&lt;p&gt;Have you considered being able to do an online migration from the old format to the new?&lt;/p&gt;</comment>
                            <comment id="14621502" author="benlau" created="Fri, 10 Jul 2015 00:18:27 +0000"  >&lt;p&gt;Hi stack, we did consider doing an online migration from the old format to the new one, but it would require messy changes to the codebase and be tricky to test fully. That&apos;s because whenever you access a region&apos;s contents you would have to test for both the humongous and non-humongous path contents instead of just using what you know it to be. Also there&apos;s a lot more going on during an online migration, regions can be moving, splitting, recovering from normal cluster operation and testing that an online migration works in all cases would be tricky. This can be ameliorated to some extent by making the migration &apos;mostly online&apos;, i.e. offlining regions, migrating them, then re-opening them.  For Yahoo&#8217;s use case, an online migration is not necessary but if the community really needs it we could look into it.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toffer&quot; class=&quot;user-hover&quot; rel=&quot;toffer&quot;&gt;Francis Liu&lt;/a&gt; can comment more, but I believe we would prefer to insert the buckets under the table directory for now and gradually transition later to reworking meta to be the source of table/region association information, creating a uniform/non-table oriented data directory, etc.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12845303">HBASE-14090</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12742556" name="HBASE-13991-master.patch" size="141614" author="benlau" created="Mon, 29 Jun 2015 18:27:29 +0000"/>
                            <attachment id="12742541" name="HumongousTableDoc.pdf" size="275773" author="benlau" created="Mon, 29 Jun 2015 18:08:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 29 Jun 2015 20:55:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gmyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>