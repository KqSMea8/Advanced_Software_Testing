<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:49:58 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7885/HBASE-7885.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7885] bloom filter compaction is too aggressive for Hfile which only contains small count of records</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7885</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;For HFile V2, the bloom filter will take a initial size, 128KB. &lt;br/&gt;
When there are not that much records inserted into the bloom filter, the bloom fitler will start to shrink itself to do compaction. &lt;br/&gt;
For example, for 128K, it will compact to 64K &lt;del&gt;&amp;gt;32K&lt;/del&gt;&amp;gt;16K-&amp;gt;8K-&amp;gt;4K-&amp;gt;2K-&amp;gt;1K-&amp;gt;512-&amp;gt;256-&amp;gt;128-&amp;gt;64-&amp;gt;32, as long as it think that it can be bounded by the estimate error rate. &lt;/p&gt;

&lt;p&gt;If we puts only a few records in the HFile, the bloom filter will be compacted to too small, then it will break the assumption that shrinking will still be bounded by the estimated error rate. The False positive rate will becomes un-acceptable high. &lt;br/&gt;
For example, if we set the expected error rate is 0.00001, for 10 records, after compaction, The size of the bloom filter will be 64 bytes. The real effective false positive rate will be 50%.&lt;/p&gt;

&lt;p&gt;The use case is like this, if we are using HBase to store big record like images, and binaries, each record will take megabytes. Then for a 128M file, it will only contains dozens of records.&lt;/p&gt;

&lt;p&gt;The suggested fix is to set a lower limit for the bloom filter compaction process. I suggest to use 1000 bytes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12633122">HBASE-7885</key>
            <summary>bloom filter compaction is too aggressive for Hfile which only contains small count of records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="clockfly">Sean Zhong</assignee>
                                    <reporter username="clockfly">Sean Zhong</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Feb 2013 02:24:39 +0000</created>
                <updated>Thu, 4 Apr 2013 03:33:21 +0000</updated>
                                            <version>0.94.5</version>
                                                    <component>Performance</component>
                    <component>Scanners</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13582365" author="yuzhihong@gmail.com" created="Wed, 20 Feb 2013 17:43:47 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          &amp;amp;&amp;amp; newByteSize &amp;gt;= MIN_BLOOMFILTER_SIZE * 2) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Why multiply the constant by two ?&lt;/p&gt;</comment>
                            <comment id="13586785" author="clockfly" created="Tue, 26 Feb 2013 05:21:30 +0000"  >&lt;p&gt;Hi Ted,&lt;/p&gt;

&lt;p&gt;+      while ( (newByteSize &amp;amp; 1) == 0 &amp;amp;&amp;amp; newMaxKeys &amp;gt; (this.keyCount&amp;lt;&amp;lt;1) &lt;br/&gt;
+          &amp;amp;&amp;amp; newByteSize &amp;gt;= MIN_BLOOMFILTER_SIZE * 2) &lt;/p&gt;
{
         pieces &amp;lt;&amp;lt;= 1;
         newByteSize &amp;gt;&amp;gt;= 1;
         newMaxKeys &amp;gt;&amp;gt;= 1;
   }

&lt;p&gt;In the while loop, we will cut the size by half. After compaction, newByteSize  will be reduced to newByteSize /2. newByteSize &amp;gt;= MIN_BLOOMFILTER_SIZE * 2 is to make sure after compaction, the bloom filter&apos;s size is still &amp;gt;= MIN_BLOOMFILTER_SIZE.&lt;/p&gt;

&lt;p&gt;There are UT affected, I will attach the UT fix soon.&lt;/p&gt;</comment>
                            <comment id="13586803" author="clockfly" created="Tue, 26 Feb 2013 05:41:13 +0000"  >&lt;p&gt;attach patch and UT fix for hbase0.94&lt;/p&gt;</comment>
                            <comment id="13586818" author="lhofhansl" created="Tue, 26 Feb 2013 05:54:20 +0000"  >&lt;p&gt;Where does the 1000 come from? Could we calculate a dynamic size from the filesize to # of record ratio?&lt;/p&gt;</comment>
                            <comment id="13586854" author="clockfly" created="Tue, 26 Feb 2013 06:37:26 +0000"  >&lt;p&gt;Hi Lars,&lt;/p&gt;

&lt;p&gt;This is more a mathematic process about Limit of a sequence.&lt;/p&gt;

&lt;p&gt;The assumption of the bloom filter compaction is: &lt;br/&gt;
The expected false positive rate is the same, as long as (The byte length of bloom filter)/(max keys to contains) stays the same.&lt;/p&gt;

&lt;p&gt;This assumption is based on (1+1/m)&lt;sup&gt;n == e&lt;/sup&gt;(n/m) (when m -&amp;gt; infinite) (m stands for bytes length, n stands for expected max record count).&lt;/p&gt;

&lt;p&gt;Here I use 1000 as a estimate of infinite.&lt;/p&gt;

&lt;p&gt;Please check: &lt;br/&gt;
&lt;a href=&quot;http://en.wikipedia.org/wiki/Bloom_filter&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://en.wikipedia.org/wiki/Bloom_filter&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://en.wikipedia.org/wiki/E_(mathematical_constant&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://en.wikipedia.org/wiki/E_(mathematical_constant&lt;/a&gt;)&lt;/p&gt;

</comment>
                            <comment id="13586857" author="clockfly" created="Tue, 26 Feb 2013 06:39:57 +0000"  >&lt;p&gt;The equation should be:&lt;/p&gt;

&lt;p&gt; (1+1/m) ^ n = e ^ (n/m) (when m -&amp;gt; infinite) (m stands for bytes length, n stands for expected max record count).&lt;/p&gt;</comment>
                            <comment id="13587631" author="yuzhihong@gmail.com" created="Tue, 26 Feb 2013 22:06:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nspiegelberg&quot; class=&quot;user-hover&quot; rel=&quot;nspiegelberg&quot;&gt;Nicolas Spiegelberg&lt;/a&gt;:&lt;br/&gt;
Mind taking a look ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13591962" author="lhofhansl" created="Mon, 4 Mar 2013 03:29:49 +0000"  >&lt;p&gt;Moving into 0.94.7 (just a few weeks out, really)&lt;br/&gt;
Personally I do not know much about bloom filters, would like to know why the estimated error rate is incorrect.&lt;/p&gt;</comment>
                            <comment id="13618239" author="lhofhansl" created="Sun, 31 Mar 2013 04:28:30 +0000"  >&lt;p&gt;Maybe we should only do this in 0.95 and trunk.&lt;/p&gt;</comment>
                            <comment id="13621700" author="lhofhansl" created="Thu, 4 Apr 2013 03:13:02 +0000"  >&lt;p&gt;Removing from 0.94. We can pull it back in, and of course still do this in 0.95/0.98.&lt;/p&gt;</comment>
                            <comment id="13621712" author="stack" created="Thu, 4 Apr 2013 03:33:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clockfly&quot; class=&quot;user-hover&quot; rel=&quot;clockfly&quot;&gt;Sean Zhong&lt;/a&gt; We need this in trunk/0.95?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12570929" name="hbase-7885.patch" size="2164" author="clockfly" created="Tue, 26 Feb 2013 05:41:13 +0000"/>
                            <attachment id="12570058" name="hbase_bloom_shrink_fix.patch" size="1042" author="clockfly" created="Wed, 20 Feb 2013 02:26:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 20 Feb 2013 17:43:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313618</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1i4cf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313963</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>