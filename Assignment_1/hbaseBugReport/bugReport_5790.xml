<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:30:59 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5790/HBASE-5790.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5790] ZKUtil deleteRecursively should be a recoverable operation</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5790</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;As of 3.4.3 Zookeeper now has full, multi-operation transaction. This means we can wholesale delete chunks of the zk tree and ensure that we don&apos;t have any pesky recursive delete issues where we delete the children of a node, but then a child joins before deletion of the parent. Even without transactions, this should be the behavior, but it is possible to make it much cleaner now that we have this new feature in zk.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12550923">HBASE-5790</key>
            <summary>ZKUtil deleteRecursively should be a recoverable operation</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jesse_yates">Jesse Yates</reporter>
                        <labels>
                            <label>zookeeper</label>
                    </labels>
                <created>Sat, 14 Apr 2012 02:55:16 +0000</created>
                <updated>Wed, 28 Oct 2015 17:48:54 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13253956" author="jesse_yates" created="Sat, 14 Apr 2012 02:55:28 +0000"  >&lt;p&gt;patch coming momentarily.&lt;/p&gt;</comment>
                            <comment id="13253962" author="jesse_yates" created="Sat, 14 Apr 2012 03:14:07 +0000"  >&lt;p&gt;Attaching patch and simple test case for recoverableZK. No need to update ZKUtil test since deleteRecurisive already covered. &lt;/p&gt;

&lt;p&gt;Wish there was a better way to test this out...tried doing a better version via Mockito, but seems to not be able to catch the actual method invocations and let me do extra work (though doAnswer should support it). &lt;/p&gt;

&lt;p&gt;Either way, did a hacked version where it dumps a node in middle while collecting children (setting a callable in the test that is called periodically in the delete), and seemed to work fine. Not recommending that we pursue the same course for general testing, but just putting this up here for peace of mind for all.&lt;/p&gt;</comment>
                            <comment id="13253984" author="zhihyu@ebaysf.com" created="Sat, 14 Apr 2012 04:19:35 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+   * Recursively delete the path all children on that path.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&apos;the path all&apos; -&amp;gt; &apos;all the&apos;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          retryOrThrow(retryCounter, e, &lt;span class=&quot;code-quote&quot;&gt;&quot;delete&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&quot;delete&quot; should be &quot;deleteRecursively&quot;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void addAllChildrenToDeleteTransaction(Transaction trans, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; version)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I don&apos;t see how version is used to filter child nodes in the above method.&lt;/p&gt;</comment>
                            <comment id="13253986" author="lhofhansl" created="Sat, 14 Apr 2012 04:34:11 +0000"  >&lt;p&gt;Patch looks good.&lt;br/&gt;
Will there be any request size problem if the subtree to delete is large?&lt;br/&gt;
Super minor nit: Should point out in Javadoc that deleteRecursively and an idempotent operation.&lt;/p&gt;</comment>
                            <comment id="13253997" author="jesse_yates" created="Sat, 14 Apr 2012 05:50:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t see how version is used to filter child nodes in the above method.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It works because of the line:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
trans.delete(path, version);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in addAllChildrenToDeleteTransaction - only children with the same version will be deleted. Generally, we are just going to want to delete all versions (version == -1), so don&apos;t often expect funky cases, but this way also ensures that you just delete children with the same version as the parent (and fail if those versions don&apos;t match up). I didn&apos;t want to go with any assumptions on versions of children vs. parent since there was not need for it yet AFAIK.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Will there be any request size problem if the subtree to delete is large?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not unless you are going to blow out the stack or memory. However, that seems incredibly unlikely. Seems a little excessive at this point to do the tail recursion optimization, but can switch to that if it seems a big issue.&lt;/p&gt;</comment>
                            <comment id="13254004" author="jesse_yates" created="Sat, 14 Apr 2012 06:07:46 +0000"  >&lt;p&gt;Attaching new version addressing comments and now with more testing!&lt;/p&gt;</comment>
                            <comment id="13254207" author="lhofhansl" created="Sat, 14 Apr 2012 21:36:25 +0000"  >&lt;p&gt;@Jesse: Was more referring to the request size that is shipped to ZK. Probably not a problem.&lt;/p&gt;</comment>
                            <comment id="13254208" author="lhofhansl" created="Sat, 14 Apr 2012 21:38:14 +0000"  >&lt;p&gt;+1 on V2&lt;/p&gt;</comment>
                            <comment id="13256177" author="stack" created="Wed, 18 Apr 2012 03:44:00 +0000"  >&lt;p&gt;This patch requires zk 3.4.x right but it doesn&apos;t check that version running before it goes and uses this new Transaction feature (I&apos;m not sure if you even can ask zk its ensemble version from the client)?  If a user puts 3.3.x under hbase, we&apos;ll hang doing this call?&lt;/p&gt;</comment>
                            <comment id="13256197" author="hadoopqa" created="Wed, 18 Apr 2012 04:32:02 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12522670/java_HBASE-5790-v1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12522670/java_HBASE-5790-v1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 7 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;/p&gt;


&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1559//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1559//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1559//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1559//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1559//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1559//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13256241" author="jesse_yates" created="Wed, 18 Apr 2012 06:30:40 +0000"  >&lt;p&gt;@stack: in short, yes. I don&apos;t see an easy way to set zk version, though I guess we could add a config option if people want to run an old version (but this gets into some really strange corner cases where we expect transaction for newer features, but have to support non-transactional views; I&apos;d rather just go wholesale into the new stuff).&lt;br/&gt;
I didn&apos;t know that we have a requirement on supporting past versions of ZK. If we want to roll this into just 0.96 we can assume singularity and say people need to run at least zk-3.4. &lt;/p&gt;</comment>
                            <comment id="13256243" author="jesse_yates" created="Wed, 18 Apr 2012 06:34:15 +0000"  >&lt;p&gt;Looks like the tests pass on that QA run, but I guess its angry about the second stage (related to keywals&apos;s recent comments on dev?). Here is the output line from the console:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.12-TRUNK-&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2&quot; title=&quot;hlog numbers should wrap around when they reach 999&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2&quot;&gt;&lt;del&gt;HBASE-2&lt;/del&gt;&lt;/a&gt;:test (secondPartTestsExecution) on project hbase: Failure or timeout&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Is there an easy way to see which findbugs warnings were introduced? I figure since we are tracking them correctly, we should have a way to say what they are, but I couldn&apos;t see a way to do it besides checking against a good run and that is a huge pain...&lt;/p&gt;</comment>
                            <comment id="13256244" author="jesse_yates" created="Wed, 18 Apr 2012 06:36:25 +0000"  >&lt;p&gt;Adding link to transactionally createWithParents ticket that also uses the zookeeper.multi functionality.&lt;/p&gt;</comment>
                            <comment id="13256628" author="zhihyu@ebaysf.com" created="Wed, 18 Apr 2012 15:03:40 +0000"  >&lt;p&gt;Our codebase uses NIOServerCnxnFactory which is not in zookeeper 3.3&lt;br/&gt;
Meaning zookeeper 3.4 is required.&lt;/p&gt;</comment>
                            <comment id="13256889" author="stack" created="Wed, 18 Apr 2012 19:48:51 +0000"  >&lt;p&gt;@Ted Its not a runtime requirement that client or ensemble be 3.4.x.  3.4.x client and ensemble is required if you run secure hbase else its not necessary and we should be wary requiring it; e.g. our ops didn&apos;t want to upgrade to 3.4.x ensemble just yet and so we run w/ a 3.4.x client against 3.3.x ensemble.&lt;/p&gt;

&lt;p&gt;@Jesse Sounds fine requiring 3.4.x in 0.96.  Want to raise a conversation out on mailing list?&lt;/p&gt;</comment>
                            <comment id="13621589" author="stack" created="Thu, 4 Apr 2013 00:39:11 +0000"  >&lt;p&gt;Removing improvement that depends on 3.4zk.&lt;/p&gt;

&lt;p&gt;Our Greg added a flag where you can set it if the quorum is 3.4.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 12   &amp;lt;property&amp;gt;
 11     &amp;lt;name&amp;gt;hbase.zookeeper.useMulti&amp;lt;/name&amp;gt;
 10     &amp;lt;value&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;lt;/value&amp;gt;
  9     &amp;lt;description&amp;gt;Instructs HBase to make use of ZooKeeper&apos;s multi-update functionality.
  8     This allows certain ZooKeeper operations to complete more quickly and prevents some issues
  7     with rare Replication failure scenarios (see the release note of HBASE-2611 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an example).
  6     IMPORTANT: only set &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; all ZooKeeper servers in the cluster are on version 3.4+
  5     and will not be downgraded.  ZooKeeper versions before 3.4 &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not support multi-update and will
  4     not fail gracefully &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; multi-update is invoked (see ZOOKEEPER-1495).
  3     &amp;lt;/description&amp;gt;
  2   &amp;lt;/property&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If patch was refactored to use this config., I&apos;d commit.&lt;/p&gt;</comment>
                            <comment id="14504046" author="apurtell" created="Tue, 21 Apr 2015 00:40:39 +0000"  >&lt;p&gt;Cancelling stale patch.&lt;br/&gt;
We&apos;re up to minimum necessary ZK now I&apos;d say. Revisit? Or close.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12551340">HBASE-5815</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12522670" name="java_HBASE-5790-v1.patch" size="10378" author="jesse_yates" created="Sat, 14 Apr 2012 06:07:44 +0000"/>
                            <attachment id="12522661" name="java_HBASE-5790.patch" size="8366" author="jesse_yates" created="Sat, 14 Apr 2012 03:14:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 14 Apr 2012 04:19:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>235787</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 34 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00rvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2448</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Unscheduling from 0.94.x, because ZK 3.4.x requirement.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>