<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:09:08 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3308/HBASE-3308.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3308] SplitTransaction.splitStoreFiles slows splits a lot</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3308</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Recently I&apos;ve been seeing some slow splits in our production environment triggering timeouts, so I decided to take a closer look into the issue.&lt;/p&gt;

&lt;p&gt;According to my debugging, we spend almost all the time it takes to split on creating the reference files. Each file in my testing takes at least 300ms to create, and averages around 600ms. Since we create two references per store file, it means that a region with 4 store file can easily take up to 5 seconds to split just to create those references.&lt;/p&gt;

&lt;p&gt;An intuitive improvement would be to create those files in parallel, so at least it wouldn&apos;t be much slower when we&apos;re splitting a higher number of files. Stack left the following comment in the code:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// TODO: If the below were multithreaded would we complete steps in less
// elapsed time?  St.Ack 20100920
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12492037">HBASE-3308</key>
            <summary>SplitTransaction.splitStoreFiles slows splits a lot</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Dec 2010 21:41:35 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:51 +0000</updated>
                            <resolved>Wed, 8 Dec 2010 21:45:38 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                    <fixVersion>0.92.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12966747" author="jdcryans" created="Sat, 4 Dec 2010 00:13:44 +0000"  >&lt;p&gt;An example from a busy machine:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
2010-12-04 00:10:27,775 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FIRSTSPLIT : = 12667
2010-12-04 00:10:28,332 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: SECONDSPLIT : = 557
2010-12-04 00:10:28,332 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FULLSPLIT : = 13225
2010-12-04 00:10:30,416 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FIRSTSPLIT : = 2083
2010-12-04 00:10:30,858 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: SECONDSPLIT : = 442
2010-12-04 00:10:30,858 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FULLSPLIT : = 2526
2010-12-04 00:10:32,292 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FIRSTSPLIT : = 1433
2010-12-04 00:10:32,917 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: SECONDSPLIT : = 625
2010-12-04 00:10:32,917 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FULLSPLIT : = 2059
2010-12-04 00:10:33,442 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FIRSTSPLIT : = 525
2010-12-04 00:10:37,796 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: SECONDSPLIT : = 4354
2010-12-04 00:10:37,796 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FULLSPLIT : = 4879
2010-12-04 00:10:38,168 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FIRSTSPLIT : = 372
2010-12-04 00:10:38,612 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: SECONDSPLIT : = 444
2010-12-04 00:10:38,612 INFO org.apache.hadoop.hbase.regionserver.SplitTransaction: FULLSPLIT : = 816
...
2010-12-04 00:10:39,269 INFO org.apache.hadoop.hbase.regionserver.CompactSplitThread: Region split, META updated,
 and report to master. Parent=TestTable,,1291421371810.40e3936261dba6e9de884473c869a925.,
 new regions: TestTable,,1291421414258.a53fa13143f61da4aac821e6d57e1db9.,
 TestTable,0028123755,1291421414258.01fc09a28eafbb5b19e856e247dc6d1f.. Split took 25sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;FIRSTSPLIT is the time to write the bottom half.&lt;br/&gt;
SECONDSPLIT is the top half.&lt;br/&gt;
FULLSPLIT is the full time to create the two files. It can be really bad!&lt;/p&gt;</comment>
                            <comment id="12968580" author="stack" created="Tue, 7 Dec 2010 05:45:38 +0000"  >&lt;p&gt;+1 on critical. +1 on fix for 0.92.&lt;/p&gt;

&lt;p&gt;Maybe there is a way to do without references &amp;#8211; we already mark the parent it has daughters?  Maybe mark the daughters with their parent and list &apos;references&apos;... removing from .META. as they are compacted out? &amp;#8211; and save ourselves having to write these reference files in the first place especially if it can be so slow?&lt;/p&gt;</comment>
                            <comment id="12969098" author="hbasereviewboard" created="Wed, 8 Dec 2010 00:40:01 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1273/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1273/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Patch that parallelizes the splitting of the files using ThreadPoolExecutor and Futures. The code is a bit ugly, but does the job really well as shown during cluster testing (which also uncovered &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3318&quot; title=&quot;Split rollback leaves parent with writesEnabled=false&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3318&quot;&gt;&lt;del&gt;HBASE-3318&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;One new behavior this patch adds is that it&apos;s now possible to rollback a split because it took too long to split the files. I did some testing with a timeout of 5 secs on my cluster, even tho each machine did a few rollbacks the import went fine. The default is 30 seconds and isn&apos;t in hbase-default.xml as I don&apos;t think anyone would really want to change that.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3308&quot; title=&quot;SplitTransaction.splitStoreFiles slows splits a lot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3308&quot;&gt;&lt;del&gt;HBASE-3308&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3308&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3308&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  /branches/0.90/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java 1043188 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1273/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1273/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jean-Daniel&lt;/p&gt;

</comment>
                            <comment id="12969110" author="hbasereviewboard" created="Wed, 8 Dec 2010 01:04:01 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1273/#review2043&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1273/#review2043&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;+1  Minor comment below.&lt;/p&gt;


&lt;p&gt;/branches/0.90/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1273/#comment6447&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1273/#comment6447&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Why not have an upper bound?  If 100 files thats 100 threads doing FS operations.  I bet if you had upper bound of 10 on the executorservice, it complete faster than an unbounded executorservice?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12969113" author="hbasereviewboard" created="Wed, 8 Dec 2010 01:08:01 +0000"  >&lt;p&gt;Message from: &quot;Jean-Daniel Cryans&quot; &amp;lt;jdcryans@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-12-07 17:02:49, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /branches/0.90/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java, line 400&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1273/diff/1/?file=17980#file17980line400&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1273/diff/1/?file=17980#file17980line400&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Why not have an upper bound?  If 100 files thats 100 threads doing FS operations.  I bet if you had upper bound of 10 on the executorservice, it complete faster than an unbounded executorservice?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we are already bounded by hbase.hstore.blockingStoreFiles&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jean-Daniel&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1273/#review2043&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1273/#review2043&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12969190" author="hbasereviewboard" created="Wed, 8 Dec 2010 05:46:03 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-12-07 17:02:49, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; /branches/0.90/src/main/java/org/apache/hadoop/hbase/regionserver/SplitTransaction.java, line 400&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1273/diff/1/?file=17980#file17980line400&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1273/diff/1/?file=17980#file17980line400&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Why not have an upper bound?  If 100 files thats 100 threads doing FS operations.  I bet if you had upper bound of 10 on the executorservice, it complete faster than an unbounded executorservice?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jean-Daniel Cryans wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I think we are already bounded by hbase.hstore.blockingStoreFiles&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;ll do.  +1 on commit.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1273/#review2043&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1273/#review2043&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12969500" author="jdcryans" created="Wed, 8 Dec 2010 21:34:00 +0000"  >&lt;p&gt;Attaching the patch I&apos;m about to commit to trunk and another patch for 0.89 that I&apos;m leaving here if anyone needs it.&lt;/p&gt;</comment>
                            <comment id="12969509" author="jdcryans" created="Wed, 8 Dec 2010 21:45:38 +0000"  >&lt;p&gt;Committed to trunk.&lt;/p&gt;

&lt;p&gt;In anyone needs it on 0.90, please use the trunk patch as it should fit perfectly.&lt;/p&gt;</comment>
                            <comment id="12970070" author="stack" created="Fri, 10 Dec 2010 05:00:33 +0000"  >&lt;p&gt;@jdcryans Should we pull this into 0.90.0?&lt;/p&gt;</comment>
                            <comment id="12970074" author="streamy" created="Fri, 10 Dec 2010 05:28:18 +0000"  >&lt;p&gt;I would be +1 on bringing in to 0.90.0 but defer to jd&lt;/p&gt;</comment>
                            <comment id="12970083" author="jdcryans" created="Fri, 10 Dec 2010 06:02:33 +0000"  >&lt;p&gt;I feel pretty confident about it , we&apos;re not running it in prod yet but it&apos;s in staging here since this morning and I didn&apos;t see any issue. Committed to branch.&lt;/p&gt;</comment>
                            <comment id="12974520" author="hudson" created="Thu, 23 Dec 2010 04:31:57 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1697 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/HBase-TRUNK/1697/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/HBase-TRUNK/1697/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="14661571" author="javaman_chen" created="Fri, 7 Aug 2015 09:54:09 +0000"  >&lt;p&gt;when i read the patch, i find this line&lt;br/&gt;
   int nbFiles = hstoreFilesToSplit.size();&lt;br/&gt;
the hstoreFilesToSplit is a Map, not a List, if you want get all the StoreFiles, the code may be not right.&lt;/p&gt;</comment>
                            <comment id="15017364" author="lars_francke" created="Fri, 20 Nov 2015 12:42:51 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12465841" name="HBASE-3308-0.89.patch" size="4211" author="jdcryans" created="Wed, 8 Dec 2010 21:34:00 +0000"/>
                            <attachment id="12465840" name="HBASE-3308.patch" size="4573" author="jdcryans" created="Wed, 8 Dec 2010 21:34:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 Dec 2010 05:45:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32983</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hlo7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100773</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>