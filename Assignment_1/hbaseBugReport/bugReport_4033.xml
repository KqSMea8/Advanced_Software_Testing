<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:15:19 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4033/HBASE-4033.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4033] The shutdown RegionServer could be added to AssignmentManager.servers again</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4033</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The folling steps can easily recreate the problem:&lt;br/&gt;
1. There&apos;s thousands of regions in the cluster.&lt;br/&gt;
2. Stop the cluster.&lt;br/&gt;
3. Start the cluster. Killing one regionserver while the regions were opening. Restarted it after 10 seconds.&lt;/p&gt;

&lt;p&gt;The shutted regionserver will appear in the AssignmentManager.servers list again.&lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;

&lt;p&gt;Issue 1:&lt;/p&gt;

&lt;p&gt;2011-06-23 14:14:30,775 DEBUG org.apache.hadoop.hbase.master.LoadBalancer: Server information: 167-6-1-12,20020,1308803390123=2220, 167-6-1-13,20020,1308803391742=2374, 167-6-1-11,20020,1308803386333=2205, 167-6-1-13,20020,1308803514394=2183&lt;/p&gt;

&lt;p&gt;Two regionservers(One of it had aborted) had the same hostname but different startcode:&lt;br/&gt;
167-6-1-13,20020,1308803391742=2374&lt;br/&gt;
167-6-1-13,20020,1308803514394=2183&lt;/p&gt;

&lt;p&gt;Issue 2:&lt;/p&gt;

&lt;p&gt;(1).The Rs 167-6-1-11,20020,1308105402003 finished shutdown at &quot;10:46:37,774&quot;:&lt;br/&gt;
10:46:37,774 INFO org.apache.hadoop.hbase.master.handler.ServerShutdownHandler: Finished processing of shutdown of 167-6-1-11,20020,1308105402003&lt;/p&gt;

&lt;p&gt;(2).Overwriting happened, it seemed the RS was still exist in the set of AssignmentManager#regions:&lt;br/&gt;
10:45:55,081 WARN org.apache.hadoop.hbase.master.AssignmentManager: Overwriting 612342de1fe4733f72299d70addb6d11 on serverName=167-6-1-11,20020,1308105402003, load=(requests=0, regions=0, usedHeap=0, maxHeap=0)&lt;/p&gt;

&lt;p&gt;(3).Region was assigned to this dead RS again at &quot;10:50:20,671&quot;:&lt;br/&gt;
10:50:20,671 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Assigning region Jeason10,08058613800000030,1308032774777.612342de1fe4733f72299d70addb6d11. to 167-6-1-11,20020,1308105402003&lt;/p&gt;</description>
                <environment></environment>
        <key id="12511518">HBASE-4033</key>
            <summary>The shutdown RegionServer could be added to AssignmentManager.servers again</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jeason">Jieshan Bean</assignee>
                                    <reporter username="jeason">Jieshan Bean</reporter>
                        <labels>
                    </labels>
                <created>Sat, 25 Jun 2011 02:11:07 +0000</created>
                <updated>Fri, 20 Nov 2015 11:54:23 +0000</updated>
                            <resolved>Thu, 7 Jul 2011 19:58:14 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.90.4</fixVersion>
                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13054799" author="jeason" created="Sat, 25 Jun 2011 02:15:42 +0000"  >&lt;p&gt;The attached logs related to the example 2 of the description.&lt;/p&gt;</comment>
                            <comment id="13055467" author="jeason" created="Mon, 27 Jun 2011 11:05:05 +0000"  >&lt;p&gt;That&apos;s my analysis about &quot;why did the shutdown RegionServer been added to AssignmentManager.servers again&quot;:&lt;br/&gt;
&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12483931/12483931_analysis.gif&quot; align=&quot;absmiddle&quot; border=&quot;0&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Suppose there&apos;s one region was sent to open on RegionServer A. The following description based on it.&lt;/p&gt;

&lt;p&gt;1. OpenedRegionHandler was called delayed. It processed after OpenRegionHandler in RegionServer and RegionServer A aborted. &lt;br/&gt;
2. &quot;this.services.getAssignmentManager().processServerShutdown()&quot; executed, it modified the data of AssignmentManager#servers, AssignmentManager#regionPlans, RIT. Move the related data of aborted RegionServer A. &lt;br/&gt;
2. OpenedRegionHandler was called at the time, so the aborted RegionServer A was added to  AssignmentManager#servers again.&lt;/p&gt;

&lt;p&gt;Then the problem happened.&lt;/p&gt;</comment>
                            <comment id="13055701" author="jdcryans" created="Mon, 27 Jun 2011 19:08:28 +0000"  >&lt;p&gt;Nice find Jieshan.&lt;/p&gt;

&lt;p&gt;So currently it seems that the only places where we call addToServers is regionOnline and rebuildUserRegions meaning that the code currently relies on being to add the server inside regionOnline once the cluster is started. The fact that regionOnline is called async from the moment it happened makes it harder to manage if a RS is gone.&lt;/p&gt;

&lt;p&gt;It seems we should only add the server when it&apos;s actually started and remove it when it&apos;s dead.&lt;/p&gt;

&lt;p&gt;Also we should consider clearing the queues that have references to something that&apos;s now stale... but that might be a lot harder to do.&lt;/p&gt;</comment>
                            <comment id="13056276" author="stack" created="Tue, 28 Jun 2011 04:00:48 +0000"  >&lt;p&gt;Can we not just add a check in addToServers to test if the server is online and not add region for a server that is not registered as online?  Do a ServerManager.isServerOnline(ServerName)?  Can even check if server is ServerManager#getDeadServers()?  &lt;/p&gt;</comment>
                            <comment id="13056343" author="jeason" created="Tue, 28 Jun 2011 06:44:19 +0000"  >&lt;p&gt;I think this check added in OpenedRegionHandler is better. If the regionserver is already in the deadlist, skip the operations(Maybe there&apos;s something to do about the region). I&apos;m trying to make a patch.&lt;/p&gt;</comment>
                            <comment id="13056489" author="stack" created="Tue, 28 Jun 2011 13:12:49 +0000"  >&lt;p&gt;You could check in OpenedRegionHandler but the regionserver might be added to the deadservers between your check and the add of the regionserver to onlineservers?&lt;/p&gt;</comment>
                            <comment id="13056490" author="stack" created="Tue, 28 Jun 2011 13:13:12 +0000"  >&lt;p&gt;BTW, nice diagram.&lt;/p&gt;</comment>
                            <comment id="13057681" author="jeason" created="Thu, 30 Jun 2011 08:44:18 +0000"  >&lt;p&gt;Thanks stack.&lt;br/&gt;
I have made a patch. &lt;br/&gt;
Any problem in it, please figure it out..&lt;br/&gt;
By the way, I want to know whether there&apos;s one xml file of code-format you have. If it&apos;s yes, can you send it to me? thanks a lot.&lt;/p&gt;</comment>
                            <comment id="13058874" author="stack" created="Fri, 1 Jul 2011 23:47:03 +0000"  >&lt;p&gt;Jieshan: Patch looks great.  This piece looks a little odd though:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.isServerOnline(serverName)) {
+      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;The server is not in online servers, then close the region, &quot;&lt;/span&gt; +
+      		&lt;span class=&quot;code-quote&quot;&gt;&quot;ServerName=&quot;&lt;/span&gt; + serverName + &lt;span class=&quot;code-quote&quot;&gt;&quot;, region=&quot;&lt;/span&gt; + 
+      		&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo.getEncodedName());
+      assignmentManager.unassign(regionInfo);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we got an open region from a server that is not in the list of online servers, its likely crashed?  So, calling unassign doesn&apos;t seem right.  If you look in unassign, the first thing it does is check if the region is online.  It&apos;ll probably fail here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions) {
      &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; region is currently assigned
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!regions.containsKey(region)) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Attempted to unassign region &quot;&lt;/span&gt; +
          region.getRegionNameAsString() + &lt;span class=&quot;code-quote&quot;&gt;&quot; but it is not &quot;&lt;/span&gt; +
          &lt;span class=&quot;code-quote&quot;&gt;&quot;currently assigned anywhere&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do you think we should call unassign here inside in openregionhandler?&lt;/p&gt;</comment>
                            <comment id="13059656" author="jeason" created="Tue, 5 Jul 2011 01:42:18 +0000"  >&lt;p&gt;Thanks stack. You&apos;re right..I think, it&apos;s no need to unassign the region in OpenedRegionHandler. For it could be opened by ServerShutdownHandler.&lt;br/&gt;
I&apos;ve made another patch..Please give out your comments..thanks.&lt;/p&gt;</comment>
                            <comment id="13061050" author="stack" created="Thu, 7 Jul 2011 06:16:23 +0000"  >&lt;p&gt;Jieshan.  I applied your v2 patch to the branch but your trunk patch seems wrong; its too much like your branch patch.  It talks about HServerInfo.  Do you have a patch for trunk that applies?  Thanks.&lt;/p&gt;</comment>
                            <comment id="13061064" author="jeason" created="Thu, 7 Jul 2011 06:38:05 +0000"  >&lt;p&gt;I have not make a same version patch for trunk...Sorry.&lt;br/&gt;
I&apos;ll make it later...&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13061542" author="stack" created="Thu, 7 Jul 2011 19:58:14 +0000"  >&lt;p&gt;Committed trunk too.  Thanks Jieshan for the patch.&lt;/p&gt;</comment>
                            <comment id="13061665" author="hudson" created="Thu, 7 Jul 2011 23:27:58 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2011 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2011/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2011/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4033&quot; title=&quot;The shutdown RegionServer could be added to AssignmentManager.servers again&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4033&quot;&gt;&lt;del&gt;HBASE-4033&lt;/del&gt;&lt;/a&gt; The shutdown RegionServer could be added to AssignmentManager.servers again&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15016212" author="lars_francke" created="Fri, 20 Nov 2015 11:54:23 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12483802" name="A_hbase-root-master-167-6-1-11.rar" size="2791545" author="jeason" created="Sat, 25 Jun 2011 02:15:41 +0000"/>
                            <attachment id="12484747" name="HBASE-4033-90-V1.patch" size="2786" author="jeason" created="Thu, 30 Jun 2011 09:29:33 +0000"/>
                            <attachment id="12485190" name="HBASE-4033-90-V2.patch" size="1410" author="jeason" created="Tue, 5 Jul 2011 01:42:18 +0000"/>
                            <attachment id="12484748" name="HBASE-4033-trunk-V1.patch" size="2786" author="jeason" created="Thu, 30 Jun 2011 09:30:48 +0000"/>
                            <attachment id="12485556" name="HBASE-4033-trunk-V2.patch" size="1320" author="jeason" created="Thu, 7 Jul 2011 08:19:57 +0000"/>
                            <attachment id="12483931" name="analysis.gif" size="16947" author="jeason" created="Mon, 27 Jun 2011 11:06:51 +0000"/>
                            <attachment id="12484740" name="test-report.txt" size="22388" author="jeason" created="Thu, 30 Jun 2011 08:44:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 27 Jun 2011 19:08:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27140</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hp3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101327</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>