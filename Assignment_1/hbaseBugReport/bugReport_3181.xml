<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:08:02 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3181/HBASE-3181.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3181] Review, document, and fix up Regions-in-Transition timeout logic</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3181</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In some of the testing Stack and I have been doing, we&apos;ve uncovered some issues with concurrent RS failure and when the Master is under heavy load.  It&apos;s led to situations where we handle ZK events far after they actually occur and have uncovered some issues in our timeout logic.&lt;/p&gt;

&lt;p&gt;This jira is about reviewing the timeout semantics, especially around ZK usage, and ensuring that we handle things appropriately.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12478773">HBASE-3181</key>
            <summary>Review, document, and fix up Regions-in-Transition timeout logic</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="streamy">Jonathan Gray</assignee>
                                    <reporter username="streamy">Jonathan Gray</reporter>
                        <labels>
                    </labels>
                <created>Sun, 31 Oct 2010 19:28:35 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:59 +0000</updated>
                            <resolved>Tue, 2 Nov 2010 02:05:45 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                    <component>master</component>
                    <component>regionserver</component>
                    <component>Zookeeper</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12926786" author="streamy" created="Sun, 31 Oct 2010 22:53:30 +0000"  >&lt;p&gt;Working on a document that goes over all this stuff, but I&apos;d like stack to give a go at my current patch.  There&apos;s a few fairly big fixes, not just to timeouts but also to server shutdown handling, and I&apos;d like to see if it fixes the issues he&apos;s been seeing.&lt;/p&gt;

&lt;p&gt;Putting patch up on RB.&lt;/p&gt;</comment>
                            <comment id="12926791" author="hbasereviewboard" created="Sun, 31 Oct 2010 23:21:14 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase and stack.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Does cleanup of RIT timeouts according to document in progress.  Still finishing document but I&apos;d like to get this patch tested before finalizing it.&lt;/p&gt;

&lt;p&gt;Also found some strange stuff in server shutdown handling that could have easily led to some double assignment issues that stack was seeing.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3181&quot; title=&quot;Review, document, and fix up Regions-in-Transition timeout logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3181&quot;&gt;&lt;del&gt;HBASE-3181&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3181&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3181&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/HRegionInfo.java 1029466 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 1029466 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1029466 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ClosedRegionHandler.java 1029466 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/EnableTableHandler.java 1029466 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/OpenedRegionHandler.java 1029466 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 1029466 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKAssign.java 1029466 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1143/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Working on tests now.  This definitely changes some behavior that is tested in the new TestMasterFailover so need to figure if the test should change or whether we need to handle things like CLOSING.  Maybe let it timeout a few times?&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12926795" author="hbasereviewboard" created="Mon, 1 Nov 2010 00:07:05 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-10-31 17:05:24.252151)&lt;/p&gt;


&lt;p&gt;Review request for hbase and stack.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Bit of cleanup on tests to make them compatible with the new changes.  For example, master cannot have PENDING_OPEN w/o existence of a zk node... and we never have to handle a node in CLOSING during failover (on RS, we will always do one of three: transition to closed, delete from closing, die).&lt;/p&gt;

&lt;p&gt;TestMasterFailover and TestRollingRestart (@ 50 regions) are both passing.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Does cleanup of RIT timeouts according to document in progress.  Still finishing document but I&apos;d like to get this patch tested before finalizing it.&lt;/p&gt;

&lt;p&gt;Also found some strange stuff in server shutdown handling that could have easily led to some double assignment issues that stack was seeing.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3181&quot; title=&quot;Review, document, and fix up Regions-in-Transition timeout logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3181&quot;&gt;&lt;del&gt;HBASE-3181&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3181&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3181&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ClosedRegionHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/EnableTableHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/OpenedRegionHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKAssign.java 1029507 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java 1029507 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/master/TestRollingRestart.java 1029507 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1143/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Working on tests now.  This definitely changes some behavior that is tested in the new TestMasterFailover so need to figure if the test should change or whether we need to handle things like CLOSING.  Maybe let it timeout a few times?&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12926825" author="hbasereviewboard" created="Mon, 1 Nov 2010 05:19:15 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-10-31 22:17:45.677862)&lt;/p&gt;


&lt;p&gt;Review request for hbase and stack.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Latest version.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Does cleanup of RIT timeouts according to document in progress.  Still finishing document but I&apos;d like to get this patch tested before finalizing it.&lt;/p&gt;

&lt;p&gt;Also found some strange stuff in server shutdown handling that could have easily led to some double assignment issues that stack was seeing.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3181&quot; title=&quot;Review, document, and fix up Regions-in-Transition timeout logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3181&quot;&gt;&lt;del&gt;HBASE-3181&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3181&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3181&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ClosedRegionHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/EnableTableHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/OpenedRegionHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKAssign.java 1029507 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java 1029507 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/master/TestRollingRestart.java 1029507 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1143/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Working on tests now.  This definitely changes some behavior that is tested in the new TestMasterFailover so need to figure if the test should change or whether we need to handle things like CLOSING.  Maybe let it timeout a few times?&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12926839" author="hbasereviewboard" created="Mon, 1 Nov 2010 05:37:15 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/#review1735&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#review1735&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Just ran TestRollingRestart with 4200 regions and it passed.  Looking good.  Needs stack cluster testing.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12926843" author="hbasereviewboard" created="Mon, 1 Nov 2010 06:09:23 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-10-31 23:06:55.505816)&lt;/p&gt;


&lt;p&gt;Review request for hbase and stack.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Latest patch.  Works with 5000 regions on TRR.&lt;/p&gt;

&lt;p&gt;TRR: Success!  Found expected number of 5002 regions&lt;br/&gt;
-------------------------------------------------------------------------------&lt;br/&gt;
Test set: org.apache.hadoop.hbase.master.TestRollingRestart&lt;br/&gt;
-------------------------------------------------------------------------------&lt;br/&gt;
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 1,227.177 sec&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Does cleanup of RIT timeouts according to document in progress.  Still finishing document but I&apos;d like to get this patch tested before finalizing it.&lt;/p&gt;

&lt;p&gt;Also found some strange stuff in server shutdown handling that could have easily led to some double assignment issues that stack was seeing.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3181&quot; title=&quot;Review, document, and fix up Regions-in-Transition timeout logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3181&quot;&gt;&lt;del&gt;HBASE-3181&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3181&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3181&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ClosedRegionHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/EnableTableHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/OpenedRegionHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 1029507 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKAssign.java 1029507 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java 1029507 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/master/TestRollingRestart.java 1029507 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1143/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Working on tests now.  This definitely changes some behavior that is tested in the new TestMasterFailover so need to figure if the test should change or whether we need to handle things like CLOSING.  Maybe let it timeout a few times?&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12926846" author="hbasereviewboard" created="Mon, 1 Nov 2010 06:15:05 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/#review1736&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#review1736&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5666&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5666&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    adding this setOfflineInZK boolean as a mandatory argument to assignment is a critical part of forcing us to get this stuff right.&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5665&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5665&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    should be &quot;are in transition&quot; not &quot;are not&quot;&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12927083" author="hbasereviewboard" created="Mon, 1 Nov 2010 18:50:15 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-11-01 11:47:35.522039)&lt;/p&gt;


&lt;p&gt;Review request for hbase and stack.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This fixes new found bug.&lt;/p&gt;

&lt;p&gt;When we processed server shutdown, we read META for regions on the dead server.  But we were only comparing HServerAddress not HServerInfo.  When rolling restart is acting up (or any time an RS comes back up w/ different startcode) this would cause double assignment.&lt;/p&gt;

&lt;p&gt;Checks against HSI now.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Does cleanup of RIT timeouts according to document in progress.  Still finishing document but I&apos;d like to get this patch tested before finalizing it.&lt;/p&gt;

&lt;p&gt;Also found some strange stuff in server shutdown handling that could have easily led to some double assignment issues that stack was seeing.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3181&quot; title=&quot;Review, document, and fix up Regions-in-Transition timeout logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3181&quot;&gt;&lt;del&gt;HBASE-3181&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3181&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3181&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/catalog/MetaReader.java 1029789 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java 1029789 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java 1029789 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java 1029789 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ClosedRegionHandler.java 1029789 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/EnableTableHandler.java 1029789 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/OpenedRegionHandler.java 1029789 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java 1029789 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKAssign.java 1029789 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java 1029789 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/master/TestRollingRestart.java 1029789 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1143/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Working on tests now.  This definitely changes some behavior that is tested in the new TestMasterFailover so need to figure if the test should change or whether we need to handle things like CLOSING.  Maybe let it timeout a few times?&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12927094" author="hbasereviewboard" created="Mon, 1 Nov 2010 19:06:05 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/#review1753&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#review1753&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Patch looks good.  I&apos;m testing it  on cluster.&lt;/p&gt;


&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5676&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5676&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Want to document the return?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12927095" author="hbasereviewboard" created="Mon, 1 Nov 2010 19:10:19 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 12:04:42, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java, line 167&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/4/?file=16342#file16342line167&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/4/?file=16342#file16342line167&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Want to document the return?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s in the javadoc:     * Returns true if specified region should be assigned, false if not.&lt;/p&gt;

&lt;p&gt;Just didn&apos;t put it in the @return... can fix that up on commit&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/#review1753&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#review1753&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12927143" author="stack" created="Mon, 1 Nov 2010 20:30:26 +0000"  >&lt;p&gt;This last patch is looking really good.  A rolling restart worked for first time and a MR rowcount confirmed table all up.  Trying some more....&lt;/p&gt;</comment>
                            <comment id="12927171" author="hbasereviewboard" created="Mon, 1 Nov 2010 21:50:24 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/#review1755&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#review1755&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;Commit after reviewing the below.  This patch makes a HUGE difference.  My trashing rolling restart of a 10 node cluster of 3k regions now works (mostly).  Seems like an errant region the odd time I test but thats for hbck to figure now....  Great work JGray.&lt;/p&gt;


&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/catalog/MetaReader.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5678&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5678&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    How did this ever work?  Why didn&apos;t typing catch this?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5679&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5679&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    We doing this or not?  Seems like we are.  Should we change this back to plain HashMap... else when concurrent map it gives impression that its ok to meddle in regionPlan w/o first synchronizing?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5680&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5680&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    want to doc this new param? (Not important &amp;#8211; its self-describing)&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5681&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5681&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    We don&apos;t have to do the remove anymore?  Passing force new plan does this for us?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5682&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5682&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Should this test go into a method of its own?  Is it repeated elsewhere?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5683&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5683&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    What happens if state.isClosing now? (You dropped it from else if here)&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5684&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5684&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Are all this.regions synchronized?  Same for this.regionPlans?  You might want to give it all a review before commit?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5685&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5685&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I think spell it out rather than NSRE in the message.&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5686&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5686&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Is this ok?  Calling assign inside a synchronize on RIT?  Is that done everywhere?  Or, this is the assign that takes a RegionState.. and expects the synchronize to be in place?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5687&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5687&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    This is good... moving this stuff inside assign.&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5688&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5688&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Nothing to do here?  Job for hbck?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5689&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5689&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    What happens here?  I suppose we used shutdown server?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5690&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5690&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Ok&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5691&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5691&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Thats an awkward sentence for a debug message...&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ClosedRegionHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/#comment5692&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#comment5692&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    We were not using this?  Probably for the best.  Probably stale by time we went to act on it?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12927251" author="hbasereviewboard" created="Tue, 2 Nov 2010 02:04:18 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Commit after reviewing the below.  This patch makes a HUGE difference.  My trashing rolling restart of a 10 node cluster of 3k regions now works (mostly).  Seems like an errant region the odd time I test but thats for hbck to figure now....  Great work JGray.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Okay, will fix up minor stuff below and commit.  Thanks for review and all the testing!&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/catalog/MetaReader.java, line 501&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16357#file16357line501&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16357#file16357line501&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     How did this ever work?  Why didn&apos;t typing catch this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This code never did work right.  This is all new master code.  Also, the HSI returning method I think in MetaReader is new from after I did fixes related to TestMasterFailover.&lt;/p&gt;

&lt;p&gt;It would only be an issue if an RS died and came back up, and the new instance of it was assigned regions before the shutdown handling of the previous instance even started.&lt;/p&gt;

&lt;p&gt;That&apos;s the killer part of the test you&apos;ve been doing and this is definitely a key part of this fix.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 111&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line111&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line111&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     We doing this or not?  Seems like we are.  Should we change this back to plain HashMap... else when concurrent map it gives impression that its ok to meddle in regionPlan w/o first synchronizing?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;we mostly do but not always.  let&apos;s open another jira for this because there&apos;s this AssignmentManager.updateTimers() call that &quot;tickles&quot; stuff that maybe should not hold a lock?&lt;/p&gt;

&lt;p&gt;Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3188&quot; title=&quot;Review locking around AssignmentManager.regionPlans&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3188&quot;&gt;&lt;del&gt;HBASE-3188&lt;/del&gt;&lt;/a&gt; (did not target to 0.90 but we can certainly do now)&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 644&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line644&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line644&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     want to doc this new param? (Not important &amp;#8211; its self-describing)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;adding javadoc&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 841&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line841&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line841&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     We don&apos;t have to do the remove anymore?  Passing force new plan does this for us?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah.  Javadoc states that if true and plan exists, will create a new one.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 935&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line935&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line935&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Should this test go into a method of its own?  Is it repeated elsewhere?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, that&apos;s only place.  If method, would take three args so probably not much simpler.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 998&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line998&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line998&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     What happens if state.isClosing now? (You dropped it from else if here)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We don&apos;t force out of isClosing state this way anymore.  In new timeout handling, we will only send another close rpc if the RS never transitions to CLOSING.  Once the RS transitions to CLOSING (state.isClosing()) it does one of three things: it finishes (goes to CLOSED), dies (RS expire), or fails (deletes node).  We handle those accordingly.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 1012&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1012&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1012&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Are all this.regions synchronized?  Same for this.regionPlans?  You might want to give it all a review before commit?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;regions looked fine when i did a review of it and RIT.  regionPlans needs review.  &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3188&quot; title=&quot;Review locking around AssignmentManager.regionPlans&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3188&quot;&gt;&lt;del&gt;HBASE-3188&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 1027&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1027&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1027&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think spell it out rather than NSRE in the message.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 1047&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1047&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1047&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Is this ok?  Calling assign inside a synchronize on RIT?  Is that done everywhere?  Or, this is the assign that takes a RegionState.. and expects the synchronize to be in place?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It seems okay except looking at it more, we end up doing a bit of work under RIT lock that we don&apos;t need to.  And all locking needed is done within assign().  Walked through it three times, we should move assign outside RIT lock.&lt;/p&gt;

&lt;p&gt;Will do that.  Need to keep RIT lock around forceRegionStateToOffline() though&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 1549&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1549&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1549&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Nothing to do here?  Job for hbck?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s hard to imagine how it would happen, so must be hbck I guess.  hbck repair would wipe all ZK state, ensure region is closed everywhere, then do assign w/ set zk offline=true&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java, line 1569&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1569&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16358#file16358line1569&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     What happens here?  I suppose we used shutdown server?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Changing to &quot;Node did not exist, can&apos;t time this out&quot;.  I guess this is hbck.&lt;/p&gt;

&lt;p&gt;I&apos;m trying not to capture every odd-ball case that &quot;should be&quot; impossible (or when possible, they should be ignored).&lt;/p&gt;

&lt;p&gt;So we could see these things happening, when master gets really overloaded and backed up, but when this is the case, we should ignore these states as events will be triggered down the road to handle things accordingly.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java, line 584&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16360#file16360line584&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16360#file16360line584&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Thats an awkward sentence for a debug message...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;rewritten as english.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-11-01 14:48:51, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ClosedRegionHandler.java, line 66&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1143/diff/5/?file=16361#file16361line66&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/diff/5/?file=16361#file16361line66&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     We were not using this?  Probably for the best.  Probably stale by time we went to act on it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;it&apos;s implied now.  this is historical from first implementation of the handler stuff.  we used to have one handler for multiple states, but now CLOSED has it&apos;s own handler so we don&apos;t need the state anymore.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1143/#review1755&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1143/#review1755&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12927252" author="streamy" created="Tue, 2 Nov 2010 02:05:45 +0000"  >&lt;p&gt;Committed to trunk.  Thanks for testing and review stack.&lt;/p&gt;</comment>
                            <comment id="12927255" author="streamy" created="Tue, 2 Nov 2010 02:08:53 +0000"  >&lt;p&gt;Final version of patch committed.&lt;/p&gt;</comment>
                            <comment id="15017399" author="lars_francke" created="Fri, 20 Nov 2015 12:42:59 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12478789">HBASE-3182</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12458598" name="HBASE-3181-FINAL.patch" size="51610" author="streamy" created="Tue, 2 Nov 2010 02:08:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 31 Oct 2010 23:21:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32939</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hl2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100675</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>