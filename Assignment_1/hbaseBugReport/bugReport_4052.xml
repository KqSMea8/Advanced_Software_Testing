<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:15:28 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4052/HBASE-4052.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4052] Enabling a table after master switch does not allow table scan, throwing NotServingRegionException</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4052</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Following is the scenario:&lt;/p&gt;

&lt;p&gt;Start RS and Active and standby masters&lt;br/&gt;
Create table and insert data.&lt;br/&gt;
Disable the table.&lt;br/&gt;
Stop the active master and switch to the standby master.&lt;br/&gt;
Now enable the table.&lt;br/&gt;
Do a scan on the enabled table.&lt;br/&gt;
NotServingRegionException is Thrown.&lt;/p&gt;

&lt;p&gt;But the same works well when we dont switch the master.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux&lt;/p&gt;</environment>
        <key id="12512427">HBASE-4052</key>
            <summary>Enabling a table after master switch does not allow table scan, throwing NotServingRegionException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ram_krish">ramkrishna.s.vasudevan</assignee>
                                    <reporter username="ram_krish">ramkrishna.s.vasudevan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Jul 2011 04:47:30 +0000</created>
                <updated>Fri, 20 Nov 2015 11:52:26 +0000</updated>
                            <resolved>Sat, 16 Jul 2011 02:40:20 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.90.4</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13058215" author="ram_krish" created="Fri, 1 Jul 2011 05:01:11 +0000"  >&lt;p&gt;As per my analysis the problem is that,&lt;/p&gt;

&lt;p&gt;When we do a remove all the online regions are closed.&lt;br/&gt;
In the Enable table flow &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  private List&amp;lt;HRegionInfo&amp;gt; regionsToAssign(final List&amp;lt;HRegionInfo&amp;gt; regionsInMeta)
  throws IOException {
    final List&amp;lt;HRegionInfo&amp;gt; onlineRegions =
      this.assignmentManager.getRegionsOfTable(tableName);
    regionsInMeta.removeAll(onlineRegions);
    return regionsInMeta;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We remove the regions if it is already online.&lt;/p&gt;

&lt;p&gt;But as per the bug, enable is called after switching,&lt;/p&gt;

&lt;p&gt;So while the standby master becomes active, in the rebuildUserRegion api,&lt;br/&gt;
we add all the regions from the Meta and we dont check if it is already disabled.&lt;/p&gt;

&lt;p&gt;So when the flow comes to enable (regionsToAssign()) we consider the region to be onlined already.  &lt;br/&gt;
Finally when we try to scan the table, we get NotServingRegionException.&lt;/p&gt;

&lt;p&gt;Correct me if am wrong in my analysis.  &lt;/p&gt;</comment>
                            <comment id="13058860" author="stack" created="Fri, 1 Jul 2011 23:18:15 +0000"  >&lt;p&gt;What you say seems plausible Ramkrishna.  I traced your reasoning above and yes, because rebuildUserRegion adds all regions without regard to whether table is enabled/disabled, when it comes to run the enable, when it asks what regions to enable, they all look as though they are already online because of what getRegionsOfTable returns (all regions that make up the table pulled from this.regions over in AM).&lt;/p&gt;

&lt;p&gt;Good stuff.&lt;/p&gt;

&lt;p&gt;Do you have a patch Ramkrishna?&lt;/p&gt;</comment>
                            <comment id="13059088" author="ram_krish" created="Sat, 2 Jul 2011 17:15:24 +0000"  >&lt;p&gt;Thanks Stack for your comments.&lt;br/&gt;
I am working on the patch.  &lt;br/&gt;
I have 2 scenarios to consider&lt;br/&gt;
1. The AM may get killed when the state is in DISABLING but still the regions are not closed&lt;br/&gt;
2. The AM may get killed when the state is in DISABLING but the regions are closed.&lt;/p&gt;

&lt;p&gt;So can we check both for DISABLING and DISABLED state.&lt;br/&gt;
I will provide my patch ASAP.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13059951" author="ram_krish" created="Tue, 5 Jul 2011 15:20:41 +0000"  >&lt;p&gt;I have some doubts and like to get some suggestion before proceeding.&lt;/p&gt;

&lt;p&gt;Following scenarios needs to be considered.&lt;br/&gt;
 Scenario 1:&lt;br/&gt;
===========&lt;br/&gt;
All the regions are disabled and the state in zookeeper is DISABLED.&lt;br/&gt;
Scenario:2&lt;br/&gt;
==========&lt;/p&gt;

&lt;p&gt;The regions are offlined but the AM went down when the zookeeper state was DISABLING.&lt;/p&gt;

&lt;p&gt;Scenario:3&lt;br/&gt;
=========&lt;/p&gt;

&lt;p&gt;The regions are not yet offlined(or only few regions are offlined) and the AM went down when the zookeeper state was DISABLING.&lt;/p&gt;

&lt;p&gt;Now when we do a switch of the master or on restart scenario of master,&lt;br/&gt;
how can we decide which regions were offlined and which are not.&lt;/p&gt;

&lt;p&gt;Though we can get the state of the table as either DISABLED or DISABLING, region wise i am not able to infer in what state the region is.&lt;/p&gt;

&lt;p&gt;So what brings me to get this info is &lt;/p&gt;

&lt;p&gt;The soln should be like we need to check for the state of the table while populating the regions map in master startup.&lt;/p&gt;

&lt;p&gt;Checking only for DISABLED state:&lt;br/&gt;
==========================&lt;br/&gt;
Check for disabled state and those regions that are not in the DISABLED state add it into the regions map in master startup.&lt;/p&gt;

&lt;p&gt;If i check only for the DISABLED state and if the table is in DISABLING state and &lt;/p&gt;

&lt;p&gt;after master retry (or switch) if i try to enable then we will not be able to scan the table because while enabling none of the regions will be enabled&lt;br/&gt;
as the regions in META table and the regions that i have populated in the regions map are same.&lt;br/&gt;
So I will be getting the same issue as in the description of the defect.&lt;/p&gt;

&lt;p&gt;Checking for DISABLED and DISABLING state:&lt;br/&gt;
===================================&lt;br/&gt;
if i check the state of the zookeeper for DISABLED and DISABLING and while restart of master(switch)  only those regions which are not in DISABLED or DISABLING state is populated.&lt;br/&gt;
When i again try to enable the region if the region was not offlined as part of disable flow(Scenario:3), the waitUntilDone in BulkAssigner is not aware that the region was &lt;br/&gt;
already onlined and keeps on waiting as the waitUntilDone() sees for the number of regions to become online from the regions map and the actual count it gets from the meta table.&lt;br/&gt;
This makes enable to go in a loop.&lt;/p&gt;

&lt;p&gt;Am i clear with the problem? so is it like before enabling any table do we need to check the state of the table and if it is DISABLING make all those regions to go to&lt;br/&gt;
offline mode.&lt;/p&gt;</comment>
                            <comment id="13060052" author="yuzhihong@gmail.com" created="Tue, 5 Jul 2011 18:24:57 +0000"  >&lt;p&gt;I think one source of confusion in the above description is that DISABLED and DISABLING states are TableState.&lt;br/&gt;
There is no concept of disabling/disabled region.&lt;/p&gt;

&lt;p&gt;I would opt for Checking for DISABLED and DISABLING TableState.&lt;/p&gt;

&lt;p&gt;I think the BulkAssigner in this case refers to EnableTableHandler.BulkEnabler which depends on assignmentManager.getRegionsOfTable() for the number of online regions.&lt;/p&gt;

&lt;p&gt;You need to write a new method, e.g. assignmentManager.getOnlineRegionsOfTable(), and call it in place of assignmentManager.getRegionsOfTable() in EnableTableHandler.regionsToAssign()&lt;/p&gt;</comment>
                            <comment id="13060474" author="ram_krish" created="Wed, 6 Jul 2011 10:59:43 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
Sorry for using wrong terminologies.  I was aware that the Tables are only disabled and regions are only onlined or offlined.&lt;br/&gt;
I would like to attach the scenarios that needs to be addressed as part of this bug&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;If a table T1 has three regions R1, R2 and R3 
We issue a disable command for T1
Scenario 1:
===========
All the regions R1, R2 and R3 are offlined and the state in zookeeper for the table is DISABLED and then the Active master went down,
R1- Offlined
R2- Offlined			T1-DISABLED
R3-Offlined
	This is straight forward scenario and the handling is also simple.
Scenario:2
==========
All the regions R1, R2 and R3 are offlined but the Active Master went down when the zookeeper state for the table was in DISABLING.
R1- Offlined
R2- Offlined			T1-DISABLING
R3-Offlined
Scenario:3
========
The regions R1, R2 and R3 are not yet offlined and the Active Master went down when the zookeeper state was DISABLING.
R1- Online
R2- Online		T1-DISABLING
R3-Online
Scenario:4
========
The regions R1, R2  are offlined and R3 are not yet offlined and the Active Master went down when the zookeeper state was DISABLING.
R1- offlined
R2- offlined		T1-DISABLING
R3-Online

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13061659" author="stack" created="Thu, 7 Jul 2011 23:18:59 +0000"  >&lt;p&gt;The above looks good to me Ramkrishna.&lt;/p&gt;</comment>
                            <comment id="13061811" author="ram_krish" created="Fri, 8 Jul 2011 07:19:45 +0000"  >&lt;p&gt;This is the test for the scenario 1&lt;br/&gt;
where the table state is DISABLED&lt;/p&gt;</comment>
                            <comment id="13061813" author="ram_krish" created="Fri, 8 Jul 2011 07:28:41 +0000"  >&lt;p&gt;The .bmp files has the sequence of changes that needs to be done.&lt;/p&gt;

&lt;p&gt;The other 3 scenarios is difficult to reproduce through testcase.&lt;/p&gt;

&lt;p&gt;Please let me know if the solution is fine.&lt;br/&gt;
Provide your comments and any scenarios needs to be verified.&lt;br/&gt;
I am working on the patch and testing it.  Will upload the patch sooner.&lt;/p&gt;</comment>
                            <comment id="13062014" author="yuzhihong@gmail.com" created="Fri, 8 Jul 2011 15:28:18 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          disabledTableRegions.add(disablingTableName);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looks like disabledTableRegions should be renamed disablingTables.&lt;/p&gt;</comment>
                            <comment id="13062097" author="ram_krish" created="Fri, 8 Jul 2011 18:28:11 +0000"  >&lt;p&gt;Yes that can be renamed. I will change it.  &lt;br/&gt;
Any scenarios to be verified Ted?&lt;/p&gt;</comment>
                            <comment id="13062166" author="yuzhihong@gmail.com" created="Fri, 8 Jul 2011 20:39:30 +0000"  >&lt;p&gt;Running your unit test, I got:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
testForCheckingIfEnableAndDisableWorksFineAfterSwitch(org.apache.hadoop.hbase.master.TestMasterRestartAfterDisablingTable)  Time elapsed: 24.594 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.reflect.UndeclaredThrowableException
        at $Proxy12.isMasterRunning(Unknown Source)
        at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getMaster(HConnectionManager.java:553)
        at org.apache.hadoop.hbase.client.HBaseAdmin.&amp;lt;init&amp;gt;(HBaseAdmin.java:101)
        at org.apache.hadoop.hbase.HBaseTestingUtility.getHBaseAdmin(HBaseTestingUtility.java:1162)
        at org.apache.hadoop.hbase.master.TestMasterRestartAfterDisablingTable.testForCheckingIfEnableAndDisableWorksFineAfterSwitch(TestMasterRestartAfterDisablingTable.java:105)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think we should wait for backup master to come up before doing:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Enabling table\n&quot;&lt;/span&gt;);
    TEST_UTIL.getHBaseAdmin().enableTable(table);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13062183" author="yuzhihong@gmail.com" created="Fri, 8 Jul 2011 21:09:15 +0000"  >&lt;p&gt;Patch for TRUNK.&lt;br/&gt;
ramkrishna&apos;s patch seems to be based on an old version of 0.90 which wouldn&apos;t apply cleanly on 0.90 branch&lt;/p&gt;

&lt;p&gt;Also the indentation was off on several lines.&lt;br/&gt;
Please use the following for new files added:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ * Copyright 2011 The Apache Software Foundation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="13062259" author="yuzhihong@gmail.com" created="Sat, 9 Jul 2011 00:08:15 +0000"  >&lt;p&gt;This test failure is new:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
testRPCException(org.apache.hadoop.hbase.master.TestHMasterRPCException)  Time elapsed: 1.543 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError: Unexpected throwable: java.net.SocketTimeoutException: Call to us01-ciqps1-grid06.carrieriq.com/10.202.50.106:19386 failed on socket timeout exception: java.net.SocketTimeoutException: 100 millis timeout &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; channel to be ready &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; read. ch : java.nio.channels.SocketChannel[connected local=/10.202.50.106:48181 remote=us01-ciqps1-grid06.carrieriq.com/10.202.50.106:19386]
        at org.junit.Assert.fail(Assert.java:91)
        at org.apache.hadoop.hbase.master.TestHMasterRPCException.testRPCException(TestHMasterRPCException.java:59)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13062295" author="ram_krish" created="Sat, 9 Jul 2011 02:30:43 +0000"  >&lt;p&gt;Hi ted&lt;br/&gt;
I had taken the 0.90 branch code&lt;br/&gt;
and applied the patch on that.&lt;br/&gt;
So do I need to apply patch only&lt;br/&gt;
on the trunk? &lt;br/&gt;
Also the test case ran cleanly in&lt;br/&gt;
my setup anyway will check it&lt;br/&gt;
Sorry for the mistakes&lt;br/&gt;
I will rectify them .&lt;/p&gt;</comment>
                            <comment id="13062297" author="yuzhihong@gmail.com" created="Sat, 9 Jul 2011 02:46:37 +0000"  >&lt;p&gt;When I tried to apply your patch on 0.90 branch:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;tyu-mbp:90hbase tyu$ patch -p0 -i HBASE-4052.patch 
(Stripping trailing CRs from patch.)
patching file src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java
Hunk #1 succeeded at 59 with fuzz 1 (offset -1 lines).
Hunk #2 FAILED at 1152.
Hunk #3 FAILED at 1445.
Hunk #4 FAILED at 1460.
Hunk #5 succeeded at 1570 (offset 86 lines).
3 out of 5 hunks FAILED -- saving rejects to file src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java.rej
(Stripping trailing CRs from patch.)
patching file src/test/java/org/apache/hadoop/hbase/master/TestMasterRestartAfterDisablingTable.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please come up with clean patch for 0.90 branch. There have been 39 bug fixes after release of 0.90.3&lt;/p&gt;

&lt;p&gt;Since this is a bug, the fix will go to both 0.90 and TRUNK.&lt;/p&gt;</comment>
                            <comment id="13063336" author="ram_krish" created="Mon, 11 Jul 2011 13:40:14 +0000"  >&lt;p&gt;The patch &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4052&quot; title=&quot;Enabling a table after master switch does not allow table scan, throwing NotServingRegionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4052&quot;&gt;&lt;del&gt;HBASE-4052&lt;/del&gt;&lt;/a&gt;-1-0.90_1.patch is for 0.90 branch.&lt;br/&gt;
The patch &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4052&quot; title=&quot;Enabling a table after master switch does not allow table scan, throwing NotServingRegionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4052&quot;&gt;&lt;del&gt;HBASE-4052&lt;/del&gt;&lt;/a&gt;-1-trunk_1.patch is for trunk branch.&lt;br/&gt;
The patch &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4052&quot; title=&quot;Enabling a table after master switch does not allow table scan, throwing NotServingRegionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4052&quot;&gt;&lt;del&gt;HBASE-4052&lt;/del&gt;&lt;/a&gt;&lt;del&gt;1&lt;/del&gt;_TestCode.patch is the test code.&lt;/p&gt;</comment>
                            <comment id="13063422" author="yuzhihong@gmail.com" created="Mon, 11 Jul 2011 16:15:40 +0000"  >&lt;p&gt;I still got the following error (in TRUNK):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;testForCheckingIfEnableAndDisableWorksFineAfterSwitch(org.apache.hadoop.hbase.master.TestMasterRestartAfterDisablingTable)  Time elapsed: 23.153 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.reflect.UndeclaredThrowableException
        at $Proxy12.isMasterRunning(Unknown Source)
        at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getMaster(HConnectionManager.java:553)
        at org.apache.hadoop.hbase.client.HBaseAdmin.&amp;lt;init&amp;gt;(HBaseAdmin.java:101)
        at org.apache.hadoop.hbase.HBaseTestingUtility.getHBaseAdmin(HBaseTestingUtility.java:1162)
        at org.apache.hadoop.hbase.master.TestMasterRestartAfterDisablingTable.testForCheckingIfEnableAndDisableWorksFineAfterSwitch(TestMasterRestartAfterDisablingTable.java:100)
...
Caused by: java.io.IOException: Connection reset by peer
        at sun.nio.ch.FileDispatcher.read0(Native Method)
        at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:21)
        at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:202)
        at sun.nio.ch.IOUtil.read(IOUtil.java:175)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13063428" author="yuzhihong@gmail.com" created="Mon, 11 Jul 2011 16:31:19 +0000"  >&lt;p&gt;Or the test hangs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;main&quot; prio=5 tid=103000800 nid=0x100601000 in Object.wait() [1005fe000]
   java.lang.Thread.State: WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        - waiting on &amp;lt;7a46c9828&amp;gt; (a org.apache.hadoop.hbase.ipc.HBaseClient$Call)
        at java.lang.Object.wait(Object.java:485)
        at org.apache.hadoop.hbase.ipc.HBaseClient.call(HBaseClient.java:835)
        - locked &amp;lt;7a46c9828&amp;gt; (a org.apache.hadoop.hbase.ipc.HBaseClient$Call)
        at org.apache.hadoop.hbase.ipc.WritableRpcEngine$Invoker.invoke(WritableRpcEngine.java:142)
        at $Proxy12.isMasterRunning(Unknown Source)
        at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getMaster(HConnectionManager.java:553)
        at org.apache.hadoop.hbase.client.HBaseAdmin.&amp;lt;init&amp;gt;(HBaseAdmin.java:101)
        at org.apache.hadoop.hbase.HBaseTestingUtility.getHBaseAdmin(HBaseTestingUtility.java:1162)
        at org.apache.hadoop.hbase.master.TestMasterRestartAfterDisablingTable.testForCheckingIfEnableAndDisableWorksFineAfterSwitch(TestMasterRestartAfterDisablingTable.java:100)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13063728" author="ram_krish" created="Tue, 12 Jul 2011 05:32:25 +0000"  >&lt;p&gt;Hi Ted,&lt;br/&gt;
I think the test case should work fine in the 0.90 branch.&lt;br/&gt;
In the trunk when we do a switch the RS is not able to connect to the new Master and we get &lt;br/&gt;
2011-07-12 11:01:22,602 INFO org.apache.hadoop.hbase.master.ServerManager: Waiting on regionserver(s) to checkin&lt;br/&gt;
2011-07-12 11:01:25,602 INFO org.apache.hadoop.hbase.master.ServerManager: Waiting on regionserver(s) to checkin&lt;br/&gt;
2011-07-12 11:01:28,602 INFO org.apache.hadoop.hbase.master.ServerManager: Waiting on regionserver(s) to checkin&lt;/p&gt;

&lt;p&gt;So when this test case is executing also we get the same problem.&lt;/p&gt;

&lt;p&gt;I will try to find why this behaviour is found in trunk and not in 0.90 branch.  Can you please tell me if the&lt;br/&gt;
test case is passing in 0.90 branch.  Because i have verified locally by running all the test cases in 0.90 branch and the testcases were passing.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Running org.apache.hadoop.hbase.master.TestMasterRestartAfterDisablingTable
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 26.148 sec
Running org.apache.hadoop.hbase.regionserver.TestFSErrorsExposed
Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 45.383 sec
Running org.apache.hadoop.hbase.client.replication.TestReplicationAdmin
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 1.044 sec
Running org.apache.hadoop.hbase.regionserver.TestScanDeleteTracker
Tests run: 6, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.234 sec
Running org.apache.hadoop.hbase.client.TestMetaScanner

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13063736" author="yuzhihong@gmail.com" created="Tue, 12 Jul 2011 06:10:14 +0000"  >&lt;p&gt;TestMasterRestartAfterDisablingTable passed for 0.90 branch.&lt;/p&gt;

&lt;p&gt;I think in TRUNK, the failure may be related to hung TestRestartCluster. See &lt;a href=&quot;https://builds.apache.org/view/G-L/view/HBase/job/HBase-TRUNK/lastCompletedBuild/artifact/trunk/target/surefire-reports/org.apache.hadoop.hbase.master.TestRestartCluster-output.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/view/G-L/view/HBase/job/HBase-TRUNK/lastCompletedBuild/artifact/trunk/target/surefire-reports/org.apache.hadoop.hbase.master.TestRestartCluster-output.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13063741" author="ram_krish" created="Tue, 12 Jul 2011 06:27:16 +0000"  >&lt;p&gt;Thanks Ted.&lt;/p&gt;

&lt;p&gt;I will try looking into the issue in trunk why the restart or switch is not working.&lt;br/&gt;
Is there any other issue in the patch or solution? or can it be committed ?&lt;/p&gt;</comment>
                            <comment id="13063744" author="yuzhihong@gmail.com" created="Tue, 12 Jul 2011 06:35:20 +0000"  >&lt;p&gt;Patch for 0.90 looks good.&lt;br/&gt;
I think patch for TRUNK should be applied around same time as patch for 0.90 is applied.&lt;/p&gt;

&lt;p&gt;Let&apos;s spend some more time on TRUNK although the cause for region server checkin problem may be somewhere else.&lt;/p&gt;</comment>
                            <comment id="13063842" author="ram_krish" created="Tue, 12 Jul 2011 12:08:34 +0000"  >&lt;p&gt;Hi Ted, &lt;br/&gt;
I got the reason why we get the following error while executing the test case &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;testForCheckingIfEnableAndDisableWorksFineAfterSwitch(org.apache.hadoop.hbase.master.TestMasterRestartAfterDisablingTable)  Time elapsed: 23.153 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.reflect.UndeclaredThrowableException
        at $Proxy12.isMasterRunning(Unknown Source)
        at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.getMaster(HConnectionManager.java:553)
        at org.apache.hadoop.hbase.client.HBaseAdmin.&amp;lt;init&amp;gt;(HBaseAdmin.java:101)
        at org.apache.hadoop.hbase.HBaseTestingUtility.getHBaseAdmin(HBaseTestingUtility.java:1162)
        at org.apache.hadoop.hbase.master.TestMasterRestartAfterDisablingTab
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think this is also a bug in HBaseAdmin.getConnection().&lt;/p&gt;

&lt;p&gt;The reason is &lt;br/&gt;
In HConnectionManager the connection object is cached based on the HConnectionKey.&lt;br/&gt;
The equals method checks the value of the CONNECTION PROPERTIES.&lt;/p&gt;

&lt;p&gt;Suppose if we do a restart/switch of the master and again try to do an enable table operation then in the test code we will create a new HBaseAdmin object.&lt;br/&gt;
But the connection that the Admin creates to the Master is taken from the cache though it is a new connection.&lt;/p&gt;

&lt;p&gt;Here none of the values in the CONNECTION PROPERTIES is changed so we get the same connection object when the previous master was active and hence though the master has been restarted we get the old active master address and hence an exception is thrown.&lt;br/&gt;
Workaround:&lt;br/&gt;
==========&lt;br/&gt;
So in order to pass the test case we change the value of one of the CONNECTION PROPERTIES so that the cached connection object is not returned.&lt;/p&gt;

&lt;p&gt;I reverted the &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4003&quot; title=&quot;Cleanup Calls Conservatively On Timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4003&quot;&gt;&lt;del&gt;HBASE-4003&lt;/del&gt;&lt;/a&gt; and this test case passed with the above change.&lt;br/&gt;
Not sure of the reason why RS doesnot checkin.&lt;/p&gt;</comment>
                            <comment id="13064080" author="yuzhihong@gmail.com" created="Tue, 12 Jul 2011 19:18:19 +0000"  >&lt;p&gt;The following test consistently failed on Linux with patch for 0.90:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;queueFailover(org.apache.hadoop.hbase.replication.TestReplication)  Time elapsed: 85.997 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError: Waited too much time for queueFailover replication
        at org.junit.Assert.fail(Assert.java:91)
        at org.apache.hadoop.hbase.replication.TestReplication.queueFailover(TestReplication.java:572)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13064338" author="ram_krish" created="Wed, 13 Jul 2011 04:07:28 +0000"  >&lt;p&gt;Ted, will look into the failure of org.apache.hadoop.hbase.replication.TestReplication.&lt;br/&gt;
But my local test bed shows success for the same testcase..&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.031 sec
Running org.apache.hadoop.hbase.rest.TestStatusResource
Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 23.785 sec
Running org.apache.hadoop.hbase.executor.TestExecutorService
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 2.324 sec
Running org.apache.hadoop.hbase.client.TestFromClientSide
Tests run: 42, Failures: 0, Errors: 0, Skipped: 3, Time elapsed: 279.871 sec
Running org.apache.hadoop.hbase.replication.TestReplication
Tests run: 7, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 213.828 sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Anyways will look into it if this patch is the root cause.&lt;/p&gt;</comment>
                            <comment id="13064374" author="stack" created="Wed, 13 Jul 2011 06:04:45 +0000"  >&lt;p&gt;Patch looks good to me Ramkrishna.  I tried to run your test but was getting NPE on trunk unrelated seemingly to your patch; I think this breaks tests &apos;HEAD is now at 46924a1... &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3904&quot; title=&quot;HConnection.isTableAvailable returns true even with not all regions available.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3904&quot;&gt;&lt;del&gt;HBASE-3904&lt;/del&gt;&lt;/a&gt; Addendum that fixes number of retries (Ita Pai)&apos;&lt;/p&gt;</comment>
                            <comment id="13064438" author="yuzhihong@gmail.com" created="Wed, 13 Jul 2011 09:01:32 +0000"  >&lt;p&gt;I applied an addendum for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3904&quot; title=&quot;HConnection.isTableAvailable returns true even with not all regions available.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3904&quot;&gt;&lt;del&gt;HBASE-3904&lt;/del&gt;&lt;/a&gt; v6 to TRUNK. NPE is fixed.&lt;br/&gt;
However, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4087&quot; title=&quot;HBaseAdmin should perform validation of connection it holds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4087&quot;&gt;&lt;del&gt;HBASE-4087&lt;/del&gt;&lt;/a&gt; is required for the new unit test to pass.&lt;/p&gt;</comment>
                            <comment id="13066344" author="yuzhihong@gmail.com" created="Sat, 16 Jul 2011 02:00:41 +0000"  >&lt;p&gt;Integrated to branch and TRUNK.&lt;/p&gt;

&lt;p&gt;Thanks for the review Stack.&lt;/p&gt;

&lt;p&gt;@ramkrishna:&lt;br/&gt;
In the future, please concatenate test file patch to main patch.&lt;/p&gt;</comment>
                            <comment id="13066367" author="hudson" created="Sat, 16 Jul 2011 06:12:47 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2036 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2036/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2036/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4052&quot; title=&quot;Enabling a table after master switch does not allow table scan, throwing NotServingRegionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4052&quot;&gt;&lt;del&gt;HBASE-4052&lt;/del&gt;&lt;/a&gt; Use same TestMasterRestartAfterDisablingTable in branch and TRUNK&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4052&quot; title=&quot;Enabling a table after master switch does not allow table scan, throwing NotServingRegionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4052&quot;&gt;&lt;del&gt;HBASE-4052&lt;/del&gt;&lt;/a&gt;  Enabling a table after master switch does not allow table scan,&lt;br/&gt;
               throwing NotServingRegionException. Add unit test&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4052&quot; title=&quot;Enabling a table after master switch does not allow table scan, throwing NotServingRegionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4052&quot;&gt;&lt;del&gt;HBASE-4052&lt;/del&gt;&lt;/a&gt;  Enabling a table after master switch does not allow table scan, &lt;br/&gt;
               throwing NotServingRegionException (ramkrishna via Ted Yu)&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterRestartAfterDisablingTable.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterRestartAfterDisablingTable.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13066775" author="ram_krish" created="Mon, 18 Jul 2011 04:00:09 +0000"  >&lt;p&gt;Thanks for the review Ted and Stack.&lt;/p&gt;
</comment>
                            <comment id="13066834" author="ram_krish" created="Mon, 18 Jul 2011 07:45:02 +0000"  >&lt;p&gt;@Ted, one small correction in the patch that was applied &lt;/p&gt;

&lt;p&gt;Actually the patch catches the NotServingRegionException as RemoteException and then&lt;br/&gt;
checks for the instanceof NotServingRegionException .&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;catch (Throwable t) {
      if (t instanceof RemoteException) {
        t = ((RemoteException)t).unwrapRemoteException();
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But the latest AssignmentManager.java in trunk shows that it was applied in &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;catch (NotServingRegionException nsre) {
      LOG.info(&quot;Server &quot; + server + &quot; returned &quot; + nsre + &quot; for &quot; +
        region.getEncodedName());
      // Presume that master has stale data.  Presume remote side just split.
      // Presume that the split message when it comes in will fix up the master&apos;s
      // in memory cluster state.
      if (checkIfRegionBelongsToDisabling(region)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So the scenario of partial disabling is failing to recover back to DISABLED state.&lt;br/&gt;
Can you please check and reapply the patch. &lt;/p&gt;</comment>
                            <comment id="13066907" author="yuzhihong@gmail.com" created="Mon, 18 Jul 2011 11:46:09 +0000"  >&lt;p&gt;Handling of NotServingRegionException has been moved to the last catch block.&lt;/p&gt;</comment>
                            <comment id="13067056" author="hudson" created="Mon, 18 Jul 2011 14:30:58 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2037 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2037/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2037/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4052&quot; title=&quot;Enabling a table after master switch does not allow table scan, throwing NotServingRegionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4052&quot;&gt;&lt;del&gt;HBASE-4052&lt;/del&gt;&lt;/a&gt; reapply code in unassign() which handles NotServingRegionException&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15015745" author="lars_francke" created="Fri, 20 Nov 2015 11:52:26 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12485783" name="4052.txt" size="13346" author="yuzhihong@gmail.com" created="Fri, 8 Jul 2011 21:09:15 +0000"/>
                            <attachment id="12485700" name="Disabled.bmp" size="1699254" author="ram_krish" created="Fri, 8 Jul 2011 07:20:40 +0000"/>
                            <attachment id="12485701" name="Disabling-1.bmp" size="1632054" author="ram_krish" created="Fri, 8 Jul 2011 07:21:56 +0000"/>
                            <attachment id="12485702" name="Disabling-2.bmp" size="1688454" author="ram_krish" created="Fri, 8 Jul 2011 07:23:32 +0000"/>
                            <attachment id="12486057" name="HBASE-4052-1-0.90_1.patch" size="5545" author="ram_krish" created="Mon, 11 Jul 2011 13:37:53 +0000"/>
                            <attachment id="12486058" name="HBASE-4052-1-_TestCode.patch" size="5824" author="ram_krish" created="Mon, 11 Jul 2011 13:38:07 +0000"/>
                            <attachment id="12486059" name="HBASE-4052-1-trunk_1.patch" size="5549" author="ram_krish" created="Mon, 11 Jul 2011 13:38:29 +0000"/>
                            <attachment id="12485747" name="HBASE-4052.patch" size="13681" author="ram_krish" created="Fri, 8 Jul 2011 15:14:50 +0000"/>
                            <attachment id="12485699" name="TestMasterRestartAfterDisablingTable.java" size="7480" author="ram_krish" created="Fri, 8 Jul 2011 07:19:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 1 Jul 2011 23:18:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27148</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hp6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101342</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>