<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:35:40 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-12712/HBASE-12712.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-12712] skipLargeFiles in minor compact but not in major compact</title>
                <link>https://issues.apache.org/jira/browse/HBASE-12712</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Here is my case. After repeatedly minor compaction, the size of storefile is very large. Compaction with large storefile will waste much bandwidth, so i use the &#8220;hbase.hstore.compaction.max.size&#8221; to skip this case. But after use this config, i find that major compaction will be skipped forever when i read the source code and the deletes and muti-versions data my waste storage. So i had to modify the code. &lt;br/&gt;
Now i&apos;m try to submit my patch.But my patch is not perfect. I think there should be an other config to determine if the large size storefile should join major compaction in HColumnDescriptor.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12762493">HBASE-12712</key>
            <summary>skipLargeFiles in minor compact but not in major compact</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mopishv0">Liu Junhong</reporter>
                        <labels>
                            <label>beginner</label>
                    </labels>
                <created>Thu, 18 Dec 2014 06:23:07 +0000</created>
                <updated>Mon, 28 Dec 2015 02:34:38 +0000</updated>
                                            <version>0.98.6</version>
                                    <fixVersion>0.98.6</fixVersion>
                                    <component>Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                    <timeoriginalestimate seconds="259200">72h</timeoriginalestimate>
                            <timeestimate seconds="259200">72h</timeestimate>
                                        <comments>
                            <comment id="14251284" author="mopishv0" created="Thu, 18 Dec 2014 06:30:00 +0000"  >&lt;p&gt;diff --git a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/RatioBasedCompactionPolicy.java b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/RatioBasedCompactionPolicy.java&lt;br/&gt;
old mode 100644&lt;br/&gt;
new mode 100755&lt;br/&gt;
index deca192..fdc9cba&lt;br/&gt;
&amp;#8212; a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/RatioBasedCompactionPolicy.java&lt;br/&gt;
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/RatioBasedCompactionPolicy.java&lt;br/&gt;
@@ -103,7 +103,6 @@ public class RatioBasedCompactionPolicy extends CompactionPolicy &lt;/p&gt;
{
           return new CompactionRequest(expiredSelection);
         }
&lt;p&gt;       }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;candidateSelection = skipLargeFiles(candidateSelection);&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     // Force a major compaction if this is a user-requested major compaction,&lt;br/&gt;
@@ -118,6 +117,9 @@ public class RatioBasedCompactionPolicy extends CompactionPolicy {&lt;br/&gt;
       );&lt;/p&gt;

&lt;p&gt;     if (!majorCompaction) {&lt;br/&gt;
+      if (!forceMajor) &lt;/p&gt;
{
+        candidateSelection = skipLargeFiles(candidateSelection);
+      }
&lt;p&gt;       // we&apos;re doing a minor compaction, let&apos;s see what files are applicable&lt;br/&gt;
       candidateSelection = filterBulk(candidateSelection);&lt;br/&gt;
       candidateSelection = applyCompactionPolicy(candidateSelection, mayUseOffPeak, mayBeStuck);&lt;/p&gt;</comment>
                            <comment id="14251295" author="hadoopqa" created="Thu, 18 Dec 2014 06:42:07 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12687977/compact.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12687977/compact.diff&lt;/a&gt;&lt;br/&gt;
  against master branch at commit 83e4bfaf73e1c7db16835b20c4f996adde30054a.&lt;br/&gt;
  ATTACHMENT ID: 12687977&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/12131//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/12131//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14251919" author="yuzhihong@gmail.com" created="Thu, 18 Dec 2014 17:26:03 +0000"  >&lt;p&gt;In master branch, we have:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(forceMajor &amp;amp;&amp;amp; isAllFiles)) {
      candidateSelection = skipLargeFiles(candidateSelection);
      isAllFiles = candidateFiles.size() == candidateSelection.size();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In 0.98, we have:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!forceMajor) {
      candidateSelection = skipLargeFiles(candidateSelection);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So what you observed is specific to 0.98 ?&lt;/p&gt;</comment>
                            <comment id="14252999" author="mopishv0" created="Fri, 19 Dec 2014 05:47:06 +0000"  >&lt;p&gt;The value of forceMajor will be only setted to true when trigger major compaction manually. In my case we need trigger major compaction by CompactionChecker. The master branch can solve this case. Thank you, i&apos;ll close this issue.&lt;/p&gt;</comment>
                            <comment id="14253004" author="mopishv0" created="Fri, 19 Dec 2014 05:53:35 +0000"  >&lt;p&gt;Sorry i misunderstanding the code in master branch. It will skipLargeFiles too when forceMajor is setted false. &lt;br/&gt;
In my case, i need major compaction can be triggered when forceMajor is setted false.&lt;br/&gt;
Is my case a widespread requirement?&lt;/p&gt;</comment>
                            <comment id="14260304" author="stack" created="Mon, 29 Dec 2014 18:38:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;In my case, i need major compaction can be triggered when forceMajor is setted false.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You need a major compaction even though majorCompaction is false?  Or do you mean it is a minor compaction but all files have been selected?&lt;/p&gt;</comment>
                            <comment id="14260837" author="mopishv0" created="Tue, 30 Dec 2014 05:56:56 +0000"  >&lt;p&gt;I need a major compaction triggered by compactionChecker even though i set hbase.hstore.compaction.max.size. In this case majorCompaction should be true when the function isMajorCompaction returns true.&lt;/p&gt;
</comment>
                            <comment id="15072353" author="junegunn" created="Mon, 28 Dec 2015 02:34:38 +0000"  >&lt;p&gt;We&apos;re having a related issue. In our case, it&apos;s not the number of versions, but TTL of the column family. We expected old (and large) storefiles to be removed from the system but they are not because skipLargeFile excludes them and thus major compaction is never triggered for them.&lt;/p&gt;

&lt;p&gt;It seems trivial to make the method take TTL into account, i.e. do not skip storefiles whose minimum timestamps are older than TTL. However, I&apos;m not completely sure if it&apos;s the right way to do it as one may argue that the current implementation is not &quot;wrong&quot; and &quot;hbase.hstore.compaction.max.size&quot; simply has priority over TTL. Also it does not fix the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mopishv0&quot; class=&quot;user-hover&quot; rel=&quot;mopishv0&quot;&gt;Liu Junhong&lt;/a&gt; is having.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12687977" name="compact.diff" size="1319" author="mopishv0" created="Thu, 18 Dec 2014 06:30:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 18 Dec 2014 06:42:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23k87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>