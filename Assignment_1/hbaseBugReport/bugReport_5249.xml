<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:26:05 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5249/HBASE-5249.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5249] Using a stale explicit row lock in a Put triggers an NPE</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5249</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;After acquiring an explicit row lock, if one attempts to send &lt;tt&gt;Put&lt;/tt&gt; after the row lock has expired, an NPE is triggered in the RegionServer, instead of throwing an &lt;tt&gt;UnknownRowLockException&lt;/tt&gt; back to the client.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-01-20 17:09:54,074 ERROR
org.apache.hadoop.hbase.regionserver.HRegionServer: Error obtaining
row lock (fsOk: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
java.lang.NullPointerException
       at java.util.concurrent.ConcurrentHashMap.put(ConcurrentHashMap.java:881)
       at org.apache.hadoop.hbase.regionserver.HRegionServer.addRowLock(HRegionServer.java:2313)
       at org.apache.hadoop.hbase.regionserver.HRegionServer.lockRow(HRegionServer.java:2299)
       at sun.reflect.GeneratedMethodAccessor15.invoke(Unknown Source)
       at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
       at java.lang.reflect.Method.invoke(Method.java:597)
       at org.apache.hadoop.hbase.ipc.WritableRpcEngine$Server.call(WritableRpcEngine.java:364)
       at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:1327)

It happened only once out of thousands of RPCs that grabbed and
released a row lock.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12539360">HBASE-5249</key>
            <summary>Using a stale explicit row lock in a Put triggers an NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Sun, 22 Jan 2012 22:42:24 +0000</created>
                <updated>Tue, 8 Sep 2015 16:39:02 +0000</updated>
                            <resolved>Tue, 8 Sep 2015 16:39:02 +0000</resolved>
                                    <version>0.92.0</version>
                                    <fixVersion>0.92.3</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13190820" author="zhihyu@ebaysf.com" created="Sun, 22 Jan 2012 23:35:37 +0000"  >&lt;p&gt;This could be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5171&quot; title=&quot;Potential NullPointerException while obtaining row lock &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5171&quot;&gt;&lt;del&gt;HBASE-5171&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13190822" author="zhihyu@ebaysf.com" created="Sun, 22 Jan 2012 23:49:25 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; r = region.obtainRowLock(row);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think r was null before the following was called:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; lockId = addRowLock(r, region);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In a busy region, this could be due to the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!existingLatch.await(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.rowLockWaitDuration,
                            TimeUnit.MILLISECONDS)) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We should check r against null in lockRow().&lt;/p&gt;</comment>
                            <comment id="13192348" author="tsuna" created="Tue, 24 Jan 2012 18:37:29 +0000"  >&lt;p&gt;I just ran into this again, still on JD&apos;s 0.92 test cluster.&lt;/p&gt;

&lt;p&gt;From the logs of OpenTSDB:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-01-24 18:32:17,605 ERROR [New I/O server worker #1-1] UniqueId: Put failed, attempts left=5 (retrying in 800 ms), put=PutRequest(table=&lt;span class=&quot;code-quote&quot;&gt;&quot;tsdb-uid&quot;&lt;/span&gt;, key=&lt;span class=&quot;code-quote&quot;&gt;&quot;\x00&quot;&lt;/span&gt;, family=&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, qualifier=&quot;metrics
&lt;span class=&quot;code-quote&quot;&gt;&quot;, value=[0, 0, 0, 0, 0, 0, 0, 1], lockid=-1, durable=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, bufferable=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, attempt=0, region=RegionInfo(table=&quot;&lt;/span&gt;tsdb-uid&lt;span class=&quot;code-quote&quot;&gt;&quot;, region_name=&quot;&lt;/span&gt;tsdb-uid,,1327429528678.c421780d32aae9959a1b821a441fca86.&lt;span class=&quot;code-quote&quot;&gt;&quot;, stop_key=&quot;&lt;/span&gt;&quot;))
org.hbase.async.RemoteException: java.io.IOException: java.lang.NullPointerException

        at org.apache.hadoop.hbase.regionserver.HRegionServer.convertThrowableToIOE(HRegionServer.java:1076)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.convertThrowableToIOE(HRegionServer.java:1065)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.put(HRegionServer.java:1815)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.hbase.ipc.WritableRpcEngine$Server.call(WritableRpcEngine.java:364)
        at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:1348)
Caused by: java.lang.NullPointerException
        at java.util.concurrent.ConcurrentHashMap.remove(ConcurrentHashMap.java:922)
        at org.apache.hadoop.hbase.regionserver.HRegion.releaseRowLock(HRegion.java:2639)
        at org.apache.hadoop.hbase.regionserver.HRegion.put(HRegion.java:1658)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.put(HRegionServer.java:1813)
        ... 6 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From the logs of the RegionServer:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-01-24 18:31:47,545 DEBUG org.apache.hadoop.hbase.regionserver.HRegionServer: Row lock -8669450923246717741 explicitly acquired by client
2012-01-24 18:32:17,554 ERROR org.apache.hadoop.hbase.regionserver.HRegionServer: 
java.lang.NullPointerException
	at java.util.concurrent.ConcurrentHashMap.remove(ConcurrentHashMap.java:922)
	at org.apache.hadoop.hbase.regionserver.HRegion.releaseRowLock(HRegion.java:2639)
	at org.apache.hadoop.hbase.regionserver.HRegion.put(HRegion.java:1658)
	at org.apache.hadoop.hbase.regionserver.HRegionServer.put(HRegionServer.java:1813)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.hadoop.hbase.ipc.WritableRpcEngine$Server.call(WritableRpcEngine.java:364)
	at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:1348)
2012-01-24 18:32:47,549 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Row Lock -8669450923246717741 lease expired
2012-01-24 18:32:47,576 WARN org.apache.hadoop.ipc.HBaseServer: (operationTooSlow): {&lt;span class=&quot;code-quote&quot;&gt;&quot;processingtimems&quot;&lt;/span&gt;:29166,&lt;span class=&quot;code-quote&quot;&gt;&quot;client&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;10.4.13.49:47018&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;starttimems&quot;&lt;/span&gt;:1327429938406,&lt;span class=&quot;code-quote&quot;&gt;&quot;queuetimems&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;class&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;HRegionServer&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;responsesize&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;method&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;put&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;totalColumns&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;table&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;tsdb-uid&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;families&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:[{&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:-8669450923246717741,&lt;span class=&quot;code-quote&quot;&gt;&quot;qualifier&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;metrics&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;vlen&quot;&lt;/span&gt;:8}]},&lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;\\x00&quot;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13192351" author="tsuna" created="Tue, 24 Jan 2012 18:41:16 +0000"  >&lt;p&gt;I can actually consistently reproduce this bug on a fresh deployment of OpenTSDB with HBase 0.92.&lt;/p&gt;</comment>
                            <comment id="13192443" author="tsuna" created="Tue, 24 Jan 2012 19:48:02 +0000"  >&lt;p&gt;Related asynchbase issue: &lt;a href=&quot;https://github.com/stumbleupon/asynchbase/issues/16&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/stumbleupon/asynchbase/issues/16&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m now wondering whether the problem is really in HBase.  Could be a bug in asynchbase too.  I&apos;m going to investigate after lunch.  Even if it&apos;s a bug in asynchbase, HBase shouldn&apos;t NPE like that.  There&apos;s some error handling that&apos;s missing in the RegionServer.&lt;/p&gt;

&lt;p&gt;But if this turns out to be an asynchbase-only bug, we can lower the severity of this bug.&lt;/p&gt;</comment>
                            <comment id="13192630" author="tsuna" created="Tue, 24 Jan 2012 22:41:58 +0000"  >&lt;p&gt;This was a bug in asynchbase, as explain in the GitHub issue linked above.  I&apos;m lowering the priority to minor.  The bug in HBase is that the RegionServer couldn&apos;t determine that the &lt;tt&gt;Put&lt;/tt&gt; that came with an explicit row lock was trying to use a lock id that didn&apos;t exist.  So it was NPE&apos;ing instead of throwing an &lt;tt&gt;UnknownRowLockException&lt;/tt&gt; back to the client.&lt;/p&gt;

&lt;p&gt;This can happen with HTable too if one acquires an explicit row lock, wait for it to expire, and then attempt to use it in a &lt;tt&gt;Put&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13192635" author="stack" created="Tue, 24 Jan 2012 22:47:08 +0000"  >&lt;p&gt;Copying over Ted comment that was in hbase-5171 (resolved as a duplicate):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Zhihong Yu added a comment - 10/Jan/12 18:03
One workaround is to increase the value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.rowlock.wait.duration&quot;&lt;/span&gt;
But a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; exception should be introduced anyways.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Yves says up on the list:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
After checking the source code I&apos;ve noticed that the value which is going to be put into the HashMap can be &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; in the &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; where the waitForLock flag is &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; or the rowLockWaitDuration is expired (HRegion#internalObtainRowLock, line 2111ff). The latter I think happens in our &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; as we have heavy load hitting the server.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14735118" author="stack" created="Tue, 8 Sep 2015 16:39:02 +0000"  >&lt;p&gt;Resolving as not-a-problem, an issue in a feature since removed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="12537913">HBASE-5171</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 22 Jan 2012 23:35:37 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224862</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 14 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02ce7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11609</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>