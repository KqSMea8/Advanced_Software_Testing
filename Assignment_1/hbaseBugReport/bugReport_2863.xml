<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:05:24 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2863/HBASE-2863.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2863] HBASE-2553 removed an important edge case </title>
                <link>https://issues.apache.org/jira/browse/HBASE-2863</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2553&quot; title=&quot;Revisit IncrementColumnValue implementation in 0.22&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2553&quot;&gt;&lt;del&gt;HBASE-2553&lt;/del&gt;&lt;/a&gt; an important edge case whereby a KV with the same TS in snapshot was lost, tests have been failing (but flakly so) indicating it as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12469888">HBASE-2863</key>
            <summary>HBASE-2553 removed an important edge case </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ryanobjc">ryan rawson</assignee>
                                    <reporter username="ryanobjc">ryan rawson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Jul 2010 06:11:37 +0000</created>
                <updated>Fri, 20 Nov 2015 12:41:33 +0000</updated>
                            <resolved>Tue, 27 Jul 2010 21:30:24 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12891052" author="hbasereviewboard" created="Thu, 22 Jul 2010 08:13:54 +0000"  >&lt;p&gt;Message from: &quot;Ryan Rawson&quot; &amp;lt;ryanobjc@gmail.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/354/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;There are tricky edge cases that were removed by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2553&quot; title=&quot;Revisit IncrementColumnValue implementation in 0.22&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2553&quot;&gt;&lt;del&gt;HBASE-2553&lt;/del&gt;&lt;/a&gt; (oopsy!)... flaky tests have been illustrating them. This patch fixes those flaky tests to be not flaky (using the EnvironmentEdgeManager thing) and also fixes them, and introduces tests that cover the particular use cases slightly better as well. Oh yes and and fixes the actual bug.&lt;/p&gt;

&lt;p&gt;Without these fixes we would end up with KVs with different values with the same Timestamp which causes problems.  This can happen when we get more than 1 increment/millisecond and especially during a snapshot.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2863&quot; title=&quot;HBASE-2553 removed an important edge case &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2863&quot;&gt;&lt;del&gt;HBASE-2863&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-2863&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-2863&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/KeyValue.java e32d683 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java 44fa0c3 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/Store.java c1ff9f2 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/ManualEnvironmentEdge.java PRE-CREATION &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java 4ead02d &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java a32eed6 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.hbase.org/r/354/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Ryan&lt;/p&gt;

</comment>
                            <comment id="12891176" author="hbasereviewboard" created="Thu, 22 Jul 2010 14:09:54 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/354/#review450&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#review450&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;At least missing license needs fixing.  There&apos;s at least one question in the below too.  Good stuff.&lt;/p&gt;


&lt;p&gt;src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/354/#comment1878&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#comment1878&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Nice.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/354/#comment1879&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#comment1879&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Nice here too&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/KeyValue.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/354/#comment1880&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#comment1880&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Good stuff.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/354/#comment1881&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#comment1881&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Could this first kv on the row in memstore have a ts in advance of &apos;now&apos;?  I suppose it can&apos;t &amp;#8211; least it shouldn&apos;t be possible, right?&lt;/p&gt;

&lt;p&gt;    If  thousands of updates a second, could this be a prob?  This logic?&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/util/ManualEnvironmentEdge.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/354/#comment1882&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#comment1882&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Missing license&lt;/p&gt;



&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/354/#comment1883&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#comment1883&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Nice test&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12891285" author="hbasereviewboard" created="Thu, 22 Jul 2010 19:05:38 +0000"  >&lt;p&gt;Message from: &quot;Ryan Rawson&quot; &amp;lt;ryanobjc@gmail.com&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-07-22 06:57:10, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java, line 384&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/354/diff/1/?file=3014#file3014line384&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/diff/1/?file=3014#file3014line384&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Could this first kv on the row in memstore have a ts in advance of &apos;now&apos;?  I suppose it can&apos;t &amp;#8211; least it shouldn&apos;t be possible, right?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     If  thousands of updates a second, could this be a prob?  This logic?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;so what was happening previously:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;snapshot happens&lt;/li&gt;
	&lt;li&gt;we do an increment which found there was no &apos;existing&apos; TS in memstore to &apos;update&apos; so we make a new one with &apos;now&apos;.&lt;/li&gt;
	&lt;li&gt;we end up with two KVs, one in snapshot one in memstore both with the same timestamp.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Another issue (which the unit test perfectly tests for) is so:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;time=1 snapshot occurs with a KV ts=1 into snapshot&lt;/li&gt;
	&lt;li&gt;time=1 ICV happens, but now the KV in memstore &lt;em&gt;must&lt;/em&gt; have a TS=2 (or else we get duplicate TS - bad!)&lt;/li&gt;
	&lt;li&gt;time=1 ICV happens, but the KV in memstore is TS=2, but now=1, so we need to keep the max(now,TS in memstore) or else we get potential duplicates&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In both these cases if we have a Put with ts=Now+X we have problems:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in HRegion we do a Get and we see Value=100 ts=Now+X&lt;/li&gt;
	&lt;li&gt;in Store we do updateColumnValue with Value=101, TS=now&lt;/li&gt;
	&lt;li&gt;If we dont clear that ts=Now+X we will put a shadowed KV, and the &lt;em&gt;next&lt;/em&gt; ICV will see value &apos;100&apos; not value &apos;101&apos; and we will never actually &apos;increment&apos; until we get past Now+X.  The compromise is to clear out all KVs in memstore period.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We can end up with a situation where the KV in memstore leads &apos;real time&apos; by a millisecond during snapshots.  If we had a way of comprehensively deduping equivalent TSs during post-hoc reads perhaps we wouldnt need this.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-07-22 06:57:10, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java, line 405&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/354/diff/1/?file=3018#file3018line405&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/diff/1/?file=3018#file3018line405&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Nice test&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;thanks, the EnvironmentEdge stuff is paying off already.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ryan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/354/#review450&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#review450&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12891341" author="hbasereviewboard" created="Thu, 22 Jul 2010 21:16:37 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/354/#review458&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/354/#review458&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;+1 I buy your rationale.  Please add missing license on commit (Oh, +1 predicated on all tests passing).&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12892938" author="stack" created="Tue, 27 Jul 2010 21:30:24 +0000"  >&lt;p&gt;Ryan committed this a while ago.&lt;/p&gt;</comment>
                            <comment id="15017008" author="lars_francke" created="Fri, 20 Nov 2015 12:41:33 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 22 Jul 2010 08:13:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26504</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hjkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100434</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>