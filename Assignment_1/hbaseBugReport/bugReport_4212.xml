<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:16:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4212/HBASE-4212.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4212] TestMasterFailover fails occasionally</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4212</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;It seems a bug. The root in RIT can&apos;t be moved..&lt;br/&gt;
In the failover process, it enforces root on-line. But not clean zk node. &lt;br/&gt;
test will wait forever.&lt;/p&gt;

&lt;p&gt;  void processFailover() throws KeeperException, IOException, InterruptedException {&lt;/p&gt;

&lt;p&gt;    // we enforce on-line root.&lt;br/&gt;
    HServerInfo hsi =&lt;br/&gt;
      this.serverManager.getHServerInfo(this.catalogTracker.getMetaLocation());&lt;br/&gt;
    regionOnline(HRegionInfo.FIRST_META_REGIONINFO, hsi);&lt;br/&gt;
    hsi = this.serverManager.getHServerInfo(this.catalogTracker.getRootLocation());&lt;br/&gt;
    regionOnline(HRegionInfo.ROOT_REGIONINFO, hsi);&lt;/p&gt;

&lt;p&gt;It seems that we should wait finished as meta region &lt;br/&gt;
  int assignRootAndMeta()&lt;br/&gt;
  throws InterruptedException, IOException, KeeperException {&lt;br/&gt;
    int assigned = 0;&lt;br/&gt;
    long timeout = this.conf.getLong(&quot;hbase.catalog.verification.timeout&quot;, 1000);&lt;/p&gt;

&lt;p&gt;    // Work on ROOT region.  Is it in zk in transition?&lt;br/&gt;
    boolean rit = this.assignmentManager.&lt;br/&gt;
      processRegionInTransitionAndBlockUntilAssigned(HRegionInfo.ROOT_REGIONINFO);&lt;br/&gt;
    if (!catalogTracker.verifyRootRegionLocation(timeout)) &lt;/p&gt;
{
      this.assignmentManager.assignRoot();
      this.catalogTracker.waitForRoot();

      //we need add this code and guarantee that the transition has completed
      this.assignmentManager.waitForAssignment(HRegionInfo.ROOT_REGIONINFO);
      assigned++;
    }

&lt;p&gt;logs:&lt;br/&gt;
2011-08-16 07:45:40,715 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RegionServer:0;C4S2.site,47710,1313495126115-EventThread&amp;#93;&lt;/span&gt; zookeeper.ZooKeeperWatcher(252): regionserver:47710-0x131d2690f780004 Received ZooKeeper Event, type=NodeDataChanged, state=SyncConnected, path=/hbase/unassigned/70236052&lt;br/&gt;
2011-08-16 07:45:40,715 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RS_OPEN_ROOT-C4S2.site,47710,1313495126115-0&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(712): regionserver:47710-0x131d2690f780004 Successfully transitioned node 70236052 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENING&lt;br/&gt;
2011-08-16 07:45:40,715 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760-EventThread&amp;#93;&lt;/span&gt; zookeeper.ZooKeeperWatcher(252): master:60701-0x131d2690f780009 Received ZooKeeper Event, type=NodeDataChanged, state=SyncConnected, path=/hbase/unassigned/70236052&lt;br/&gt;
2011-08-16 07:45:40,716 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;PostOpenDeployTasks:70236052&amp;#93;&lt;/span&gt; catalog.RootLocationEditor(62): Setting ROOT region location in ZooKeeper as C4S2.site:47710&lt;br/&gt;
2011-08-16 07:45:40,716 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760-EventThread&amp;#93;&lt;/span&gt; zookeeper.ZKUtil(1109): master:60701-0x131d2690f780009 Retrieved 52 byte(s) of data from znode /hbase/unassigned/70236052 and set watcher; region=&lt;del&gt;ROOT&lt;/del&gt;,,0, server=C4S2.site,47710,1313495126115, state=RS_ZK_REGION_OPENING&lt;br/&gt;
2011-08-16 07:45:40,717 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760-EventThread&amp;#93;&lt;/span&gt; master.AssignmentManager(477): Handling transition=RS_ZK_REGION_OPENING, server=C4S2.site,47710,1313495126115, region=70236052/&lt;del&gt;ROOT&lt;/del&gt;&lt;br/&gt;
2011-08-16 07:45:40,725 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RS_OPEN_ROOT-C4S2.site,47710,1313495126115-0&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(661): regionserver:47710-0x131d2690f780004 Attempting to transition node 70236052/&lt;del&gt;ROOT&lt;/del&gt; from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENED&lt;br/&gt;
2011-08-16 07:45:40,727 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RS_OPEN_ROOT-C4S2.site,47710,1313495126115-0&amp;#93;&lt;/span&gt; zookeeper.ZKUtil(1109): regionserver:47710-0x131d2690f780004 Retrieved 52 byte(s) of data from znode /hbase/unassigned/70236052; data=region=&lt;del&gt;ROOT&lt;/del&gt;,,0, server=C4S2.site,47710,1313495126115, state=RS_ZK_REGION_OPENING&lt;br/&gt;
2011-08-16 07:45:40,740 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RegionServer:0;C4S2.site,47710,1313495126115-EventThread&amp;#93;&lt;/span&gt; zookeeper.ZooKeeperWatcher(252): regionserver:47710-0x131d2690f780004 Received ZooKeeper Event, type=NodeDataChanged, state=SyncConnected, path=/hbase/unassigned/70236052&lt;br/&gt;
2011-08-16 07:45:40,740 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760-EventThread&amp;#93;&lt;/span&gt; zookeeper.ZooKeeperWatcher(252): master:60701-0x131d2690f780009 Received ZooKeeper Event, type=NodeDataChanged, state=SyncConnected, path=/hbase/unassigned/70236052&lt;br/&gt;
2011-08-16 07:45:40,740 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RS_OPEN_ROOT-C4S2.site,47710,1313495126115-0&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(712): regionserver:47710-0x131d2690f780004 Successfully transitioned node 70236052 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENED&lt;br/&gt;
2011-08-16 07:45:40,741 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RS_OPEN_ROOT-C4S2.site,47710,1313495126115-0&amp;#93;&lt;/span&gt; handler.OpenRegionHandler(121): Opened &lt;del&gt;ROOT&lt;/del&gt;,,0.70236052&lt;br/&gt;
2011-08-16 07:45:40,741 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760-EventThread&amp;#93;&lt;/span&gt; zookeeper.ZKUtil(1109): master:60701-0x131d2690f780009 Retrieved 52 byte(s) of data from znode /hbase/unassigned/70236052 and set watcher; region=&lt;del&gt;ROOT&lt;/del&gt;,,0, server=C4S2.site,47710,1313495126115, state=RS_ZK_REGION_OPENED&lt;br/&gt;
2011-08-16 07:45:40,741 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760-EventThread&amp;#93;&lt;/span&gt; master.AssignmentManager(477): Handling transition=RS_ZK_REGION_OPENED, server=C4S2.site,47710,1313495126115, region=70236052/&lt;del&gt;ROOT&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;//.............................................It said that zk node can&apos;t be cleaned because of we have enforced on-line the root.......................................&lt;br/&gt;
// The test will wait forever.&lt;/p&gt;

&lt;p&gt;2011-08-16 07:45:40,741 WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760-EventThread&amp;#93;&lt;/span&gt; master.AssignmentManager(540): Received OPENED for region 70236052/&lt;del&gt;ROOT&lt;/del&gt; from server C4S2.site,47710,1313495126115 but region was in  the state null and not in expected PENDING_OPEN or OPENING states&lt;/p&gt;

&lt;p&gt;2011-08-16 07:45:41,018 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Master:0;C4S2.site:60701&amp;#93;&lt;/span&gt; zookeeper.ZKUtil(1109): master:60701-0x131d2690f780009 Retrieved 52 byte(s) of data from znode /hbase/unassigned/70236052 and set watcher; region=&lt;del&gt;ROOT&lt;/del&gt;,,0, server=C4S2.site,47710,1313495126115, state=RS_ZK_REGION_OPENED&lt;br/&gt;
2011-08-16 07:45:41,233 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:41,337 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:41,439 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:41,543 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:41,645 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:41,748 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:41,900 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:42,002 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:42,105 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:42,206 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:42,308 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;br/&gt;
2011-08-16 07:45:42,410 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-760&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(807): ZK RIT -&amp;gt; 70236052&lt;/p&gt;</description>
                <environment></environment>
        <key id="12519088">HBASE-4212</key>
            <summary>TestMasterFailover fails occasionally</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sunnygao">gaojinchao</assignee>
                                    <reporter username="sunnygao">gaojinchao</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Aug 2011 08:26:13 +0000</created>
                <updated>Fri, 20 Nov 2015 11:54:39 +0000</updated>
                            <resolved>Tue, 4 Oct 2011 14:42:44 +0000</resolved>
                                    <version>0.90.4</version>
                                    <fixVersion>0.90.5</fixVersion>
                                    <component>master</component>
                        <due>Wed, 17 Aug 2011 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13086199" author="sunnygao" created="Wed, 17 Aug 2011 08:48:58 +0000"  >&lt;p&gt;I have made a patch. Please review it. Thanks.&lt;/p&gt;</comment>
                            <comment id="13086202" author="sunnygao" created="Wed, 17 Aug 2011 08:51:41 +0000"  >&lt;p&gt;I test 10 times and logs said that META is assigned after root has finished.&lt;/p&gt;

&lt;p&gt;2011-08-17 05:06:51,419 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;MASTER_OPEN_REGION-C4S2.site:47578-0&amp;#93;&lt;/span&gt; zookeeper.ZKUtil(1109): master:47578-0x131d6fe02e50009 Retrieved 52 byte(s) of data from znode /hbase/unassigned/70236052; data=region=&lt;del&gt;ROOT&lt;/del&gt;,,0, server=C4S2.site,60960,1313571996605, state=RS_ZK_REGION_OPENED&lt;br/&gt;
2011-08-17 05:06:51,425 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-755-EventThread&amp;#93;&lt;/span&gt; zookeeper.ZooKeeperWatcher(252): master:47578-0x131d6fe02e50009 Received ZooKeeper Event, type=NodeDeleted, state=SyncConnected, path=/hbase/unassigned/70236052&lt;br/&gt;
2011-08-17 05:06:51,425 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;MASTER_OPEN_REGION-C4S2.site:47578-0&amp;#93;&lt;/span&gt; zookeeper.ZKAssign(420): master:47578-0x131d6fe02e50009 Successfully deleted unassigned node for region 70236052 in expected state RS_ZK_REGION_OPENED&lt;br/&gt;
2011-08-17 05:06:51,426 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;Master:0;C4S2.site:47578&amp;#93;&lt;/span&gt; master.HMaster(437): &lt;del&gt;ROOT&lt;/del&gt; assigned=1, rit=false, location=C4S2.site:60960&lt;br/&gt;
2011-08-17 05:06:51,426 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;MASTER_OPEN_REGION-C4S2.site:47578-0&amp;#93;&lt;/span&gt; handler.OpenedRegionHandler(108): Opened region &lt;del&gt;ROOT&lt;/del&gt;,,0.70236052 on C4S2.site,60960,1313571996605&lt;br/&gt;
2011-08-17 05:06:51,427 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Master:0;C4S2.site:47578&amp;#93;&lt;/span&gt; zookeeper.ZKUtil(553): master:47578-0x131d6fe02e50009 Unable to get data of znode /hbase/unassigned/1028785192 because node does not exist (not an error)&lt;br/&gt;
2011-08-17 05:06:51,429 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;Master:0;C4S2.site:47578&amp;#93;&lt;/span&gt; catalog.CatalogTracker(421): Passed metaserver is null&lt;/p&gt;</comment>
                            <comment id="13100090" author="stack" created="Thu, 8 Sep 2011 05:43:18 +0000"  >&lt;p&gt;Gaojinchao.  The patch looks innocuous enough.  Why do you think we need to do the waitForAssignment for root too when we call catalogtracker and ask it wait on root?  Do we need to fix the way catalogtracker works?&lt;/p&gt;

&lt;p&gt;Do you see this test failing still?  I took a look at the 0.90 tests up on the apache build and they dont&apos; seem to fail on this test.  &lt;/p&gt;</comment>
                            <comment id="13101213" author="sunnygao" created="Fri, 9 Sep 2011 13:57:57 +0000"  >&lt;p&gt;@Stack&#65292; Thanks for your review. &lt;br/&gt;
In our environment, it often fails, so we skip this case(for my case is that all test cases are performed automatically every day). &lt;/p&gt;

&lt;p&gt;The step for opening a root region:&lt;br/&gt;
step A: Master tells Region server to open root region.&lt;br/&gt;
step B: Region server opens root region and sets zk node(rootServerZNodezk). It is finished means that catalogtracker can works.&lt;br/&gt;
step C: Region server updates the zk node(assignmentZNode) tells master that root has opened(some cases may fail, but we have told the root could be used).&lt;br/&gt;
step D: Master deletes the zk node (assignmentZNode) and adds root region to online set.&lt;/p&gt;

&lt;p&gt;In my case, master skipped the step D because delayed. master forced root region online in processFailover. So zk node couldn&apos;t be deleted and failover case failed.&lt;/p&gt;

&lt;p&gt;finishInitialization code&#65306;&lt;br/&gt;
    // Make sure root and meta assigned before proceeding.&lt;br/&gt;
    assignRootAndMeta();&lt;/p&gt;

&lt;p&gt;    // Is this fresh start with no regions assigned or are we a master joining&lt;br/&gt;
    // an already-running cluster?  If regionsCount == 0, then for sure a&lt;br/&gt;
    // fresh start.  TOOD: Be fancier.  If regionsCount == 2, perhaps the&lt;br/&gt;
    // 2 are .META. and &lt;del&gt;ROOT&lt;/del&gt; and we should fall into the fresh startup&lt;br/&gt;
    // branch below.  For now, do processFailover.&lt;br/&gt;
    if (regionCount == 0) &lt;/p&gt;
{
      LOG.info(&quot;Master startup proceeding: cluster startup&quot;);
      this.assignmentManager.cleanoutUnassigned();
      this.assignmentManager.assignAllUserRegions();
    }
&lt;p&gt; else &lt;/p&gt;
{
      LOG.info(&quot;Master startup proceeding: master failover&quot;);
      this.assignmentManager.processFailover();
    }

&lt;p&gt;processFailover code:&lt;br/&gt;
    HServerInfo hsi =&lt;br/&gt;
      this.serverManager.getHServerInfo(this.catalogTracker.getMetaLocation());&lt;br/&gt;
    regionOnline(HRegionInfo.FIRST_META_REGIONINFO, hsi);&lt;br/&gt;
    hsi = this.serverManager.getHServerInfo(this.catalogTracker.getRootLocation());&lt;br/&gt;
    regionOnline(HRegionInfo.ROOT_REGIONINFO, hsi);&lt;/p&gt;</comment>
                            <comment id="13116929" author="sunnygao" created="Thu, 29 Sep 2011 01:01:27 +0000"  >&lt;p&gt;Hi, Does this issue need merge ? &lt;/p&gt;</comment>
                            <comment id="13116966" author="yuzhihong@gmail.com" created="Thu, 29 Sep 2011 02:28:28 +0000"  >&lt;p&gt;@Stack:&lt;br/&gt;
Can you take a look at Jinchao&apos;s response @ 09/Sep/11 13:57 ?&lt;/p&gt;

&lt;p&gt;@Jinchao:&lt;br/&gt;
Have you run your patches for test suites of 0.90 and TRUNK recently ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13116973" author="sunnygao" created="Thu, 29 Sep 2011 02:49:54 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
Thanks, I don&apos;t run it recently. &lt;br/&gt;
I will do it right now and give the result.&lt;/p&gt;
</comment>
                            <comment id="13117137" author="sunnygao" created="Thu, 29 Sep 2011 08:32:08 +0000"  >&lt;p&gt;@Ted.&lt;br/&gt;
I have analyzed the problem that you said and opened a new issue(&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4511&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-4511&lt;/a&gt;).&lt;br/&gt;
It seems that some data is loss. You can check my analysis.&lt;/p&gt;</comment>
                            <comment id="13117145" author="sunnygao" created="Thu, 29 Sep 2011 08:43:45 +0000"  >&lt;p&gt;Version :0.90 &lt;/p&gt;

&lt;p&gt;Results :&lt;br/&gt;
Tests run: 649, Failures: 0, Errors: 0, Skipped: 1&lt;/p&gt;

&lt;p&gt; T E S T S&lt;br/&gt;
-------------------------------------------------------&lt;br/&gt;
Running org.apache.hadoop.hbase.master.TestMasterFailover&lt;br/&gt;
Tests run: 4, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 99.09 sec&lt;br/&gt;
Results :&lt;/p&gt;

&lt;p&gt;Tests run: 4, Failures: 0, Errors: 0, Skipped: 0&lt;/p&gt;
</comment>
                            <comment id="13117176" author="ram_krish" created="Thu, 29 Sep 2011 09:36:20 +0000"  >&lt;p&gt;@Ted/@Gao&lt;/p&gt;

&lt;p&gt;I think the issue exists in 0.90 branch and not in trunk.  Gao&apos;s analysis is valid in 0.90.&lt;br/&gt;
In 0.90&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
assignRootAndMeta();

    &lt;span class=&quot;code-comment&quot;&gt;// Is &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; fresh start with no regions assigned or are we a master joining
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// an already-running cluster?  If regionsCount == 0, then &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sure a
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// fresh start.  TOOD: Be fancier.  If regionsCount == 2, perhaps the
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// 2 are .META. and -ROOT- and we should fall into the fresh startup
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// branch below.  For now, &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; processFailover.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (regionCount == 0) {
      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Master startup proceeding: cluster startup&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.cleanoutUnassigned();
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.assignAllUserRegions();
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Master startup proceeding: master failover&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.assignmentManager.processFailover();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Inside AssignmentManager.processFailOver()&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 HServerInfo hsi =
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.getHServerInfo(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getMetaLocation());
    regionOnline(HRegionInfo.FIRST_META_REGIONINFO, hsi);
    hsi = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.getHServerInfo(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getRootLocation());
    regionOnline(HRegionInfo.ROOT_REGIONINFO, hsi);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;we first call regionOnline inside which the region in RIT is getting removed.&lt;br/&gt;
So even before the call back happens for OPENED state it is getting removed.  Hence ROOT node remains in RIT and testcase timesout.&lt;br/&gt;
In trunk we dont have this problem as in Assignment.joinCluster() we dont have this code of removing from regionOnline.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// Scan META to build list of existing regions, servers, and assignment
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Returns servers who have not checked in (assumed dead) and their regions
&lt;/span&gt;    Map&amp;lt;ServerName,List&amp;lt;Pair&amp;lt;HRegionInfo,Result&amp;gt;&amp;gt;&amp;gt; deadServers =
      rebuildUserRegions();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I will now verify this testcase with the patch with the script in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4480&quot; title=&quot;Testing script to simplify local testing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4480&quot;&gt;&lt;del&gt;HBASE-4480&lt;/del&gt;&lt;/a&gt;.  &lt;br/&gt;
Gao and Ted what do you suggest?&lt;/p&gt;
</comment>
                            <comment id="13117188" author="sunnygao" created="Thu, 29 Sep 2011 09:50:50 +0000"  >&lt;p&gt;I am running all test cases about Trunk. I will give a result tommorrow.&lt;/p&gt;

&lt;p&gt;I think Trunk have this problem as well in this case.&lt;br/&gt;
1.Master assigns the root &lt;br/&gt;
2.Rs set the root address in zk and then crash before finish opening the root.&lt;br/&gt;
3.Master get the root data from zk and start assigning the meta region.&lt;br/&gt;
4.Root region is offline and needs be ressigned by monitor timeout.&lt;/p&gt;

&lt;p&gt;So I think we need wait the root is removed from RIT. It is safe.&lt;/p&gt;
</comment>
                            <comment id="13117190" author="ram_krish" created="Thu, 29 Sep 2011 09:53:26 +0000"  >&lt;p&gt;without the patch i was also able to reproduce the exact problem as Gao reported&lt;/p&gt;</comment>
                            <comment id="13117292" author="yuzhihong@gmail.com" created="Thu, 29 Sep 2011 13:28:24 +0000"  >&lt;p&gt;Now that &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4511&quot; title=&quot;There is data loss when master failovers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4511&quot;&gt;&lt;del&gt;HBASE-4511&lt;/del&gt;&lt;/a&gt; has been opened, I vote +1 on Jinchao&apos;s patch.&lt;/p&gt;</comment>
                            <comment id="13117851" author="yuzhihong@gmail.com" created="Fri, 30 Sep 2011 03:33:04 +0000"  >&lt;p&gt;Integrated to 0.90, 0.92 branches and TRUNK.&lt;/p&gt;

&lt;p&gt;Thanks for the patches, Jinchao.&lt;/p&gt;

&lt;p&gt;Thanks for the analysis, Ramkrishna.&lt;/p&gt;</comment>
                            <comment id="13117975" author="ram_krish" created="Fri, 30 Sep 2011 11:15:06 +0000"  >&lt;p&gt;Just to add to Gao&apos;s comment on 29/Sep/11 09:50&lt;br/&gt;
Fix for trunk may not be needed as when the master tries to assign the root&lt;br/&gt;
it cant find the root location and hence it will wait for ServerShutdownhandler to assign it .&lt;br/&gt;
So it the ServerShutdownHandler that is going to assign the root and not the timeout.&lt;br/&gt;
Now adding the check as in 0.90 will not go to till finding the root location whereas it will wait for the ServershutdownHandler to add it to online.&lt;/p&gt;

&lt;p&gt;So it is safe to add i feel.&lt;/p&gt;</comment>
                            <comment id="13117979" author="ram_krish" created="Fri, 30 Sep 2011 11:18:55 +0000"  >&lt;p&gt;And at the same time even if the check is not there i do not think there will be a problem. Correct me if am wrong.&lt;/p&gt;</comment>
                            <comment id="13118041" author="hudson" created="Fri, 30 Sep 2011 13:10:14 +0000"  >&lt;p&gt;Integrated in HBase-0.92 #33 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92/33/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92/33/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4212&quot; title=&quot;TestMasterFailover fails occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4212&quot;&gt;&lt;del&gt;HBASE-4212&lt;/del&gt;&lt;/a&gt;  TestMasterFailover fails occasionally (Gao Jinchao)&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13118135" author="hudson" created="Fri, 30 Sep 2011 15:22:13 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2272 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2272/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2272/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4212&quot; title=&quot;TestMasterFailover fails occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4212&quot;&gt;&lt;del&gt;HBASE-4212&lt;/del&gt;&lt;/a&gt;  TestMasterFailover fails occasionally (Gao Jinchao)&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15016283" author="lars_francke" created="Fri, 20 Nov 2015 11:54:39 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12490631" name="HBASE-4212_TrunkV1.patch" size="716" author="sunnygao" created="Wed, 17 Aug 2011 09:31:08 +0000"/>
                            <attachment id="12490629" name="HBASE-4212_branch90V1.patch" size="690" author="sunnygao" created="Wed, 17 Aug 2011 08:48:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 8 Sep 2011 05:43:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27222</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hpx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101461</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>