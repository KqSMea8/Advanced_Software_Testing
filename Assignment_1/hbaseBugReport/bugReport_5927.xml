<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:32:13 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5927/HBASE-5927.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5927] SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5927</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;A possible exception: If the related regionserver was just killed(But HMaster has not perceived that), then we will get a local exception &quot;Connection reset by peer&quot;. If this region belongs to a disabling table. what will happen?&lt;/p&gt;

&lt;p&gt;ServerShutdownHandler will remove this region from AM#regions. So this region is still existing in RIT. TimeoutMonitor will take care of it after it got timeout. Then invoke unassign again. Since this region has been removed from AM#regions, it will return directly due to the below code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions) {
      &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; region is currently assigned
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!regions.containsKey(region)) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Attempted to unassign region &quot;&lt;/span&gt; +
          region.getRegionNameAsString() + &lt;span class=&quot;code-quote&quot;&gt;&quot; but it is not &quot;&lt;/span&gt; +
          &lt;span class=&quot;code-quote&quot;&gt;&quot;currently assigned anywhere&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then it leads to an end-less loop.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12553790">HBASE-5927</key>
            <summary>SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajesh23">rajeshbabu</assignee>
                                    <reporter username="jeason">Jieshan Bean</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 May 2012 15:58:36 +0000</created>
                <updated>Tue, 26 Feb 2013 08:15:49 +0000</updated>
                            <resolved>Tue, 22 May 2012 09:15:57 +0000</resolved>
                                    <version>0.92.1</version>
                    <version>0.94.1</version>
                    <version>0.95.2</version>
                                    <fixVersion>0.94.1</fixVersion>
                    <fixVersion>0.95.0</fixVersion>
                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13267550" author="zhihyu@ebaysf.com" created="Thu, 3 May 2012 16:24:22 +0000"  >&lt;p&gt;@Jieshan:&lt;br/&gt;
Can you a new test case show this possibility ?&lt;/p&gt;</comment>
                            <comment id="13268285" author="jeason" created="Fri, 4 May 2012 12:26:07 +0000"  >&lt;p&gt;Okay, I will add it&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13270523" author="jeason" created="Tue, 8 May 2012 15:11:36 +0000"  >&lt;p&gt;A simple test just help for producing this issue.&lt;/p&gt;

&lt;p&gt;The below logs show this problem:&lt;/p&gt;

&lt;p&gt;Kill one RegionServer:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-05-08 22:04:03,038 INFO  [MASTER_SERVER_OPERATIONS-Jieshan.china.huawei.com,57110,1336485831968-0] handler.ServerShutdownHandler(174): Splitting logs for Jieshan.china.huawei.com,57163,1336485834464
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Local exception occured after calling sendRegionClose&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-05-08 22:05:23,909 INFO  [Jieshan.china.huawei.com,57110,1336485831968-org.apache.hadoop.hbase.master.handler.DisableTableHandler$BulkDisabler-1] master.AssignmentManager(2066): Server jieshan.china.huawei.com,57138,1336485834409 returned java.net.ConnectException: Connection refused: no further information for fc6c3b7c6445127b63f617445aa5dfaf
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Fallen into an end-less loop.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-05-08 22:07:58,122 INFO  [Jieshan.china.huawei.com,57110,1336485831968.timeoutMonitor] master.AssignmentManager$TimeoutMonitor(2925): Region has been PENDING_CLOSE for too long, running forced unassign again on region=testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf.
2012-05-08 22:07:58,122 DEBUG [pool-8-thread-17] master.AssignmentManager(1936): Starting unassignment of region testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf. (offlining)
2012-05-08 22:07:58,122 DEBUG [pool-8-thread-17] master.AssignmentManager(1942): Attempted to unassign region testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf. but it is not currently assigned anywhere
2012-05-08 22:08:08,121 INFO  [Jieshan.china.huawei.com,57110,1336485831968.timeoutMonitor] master.AssignmentManager$TimeoutMonitor(2893): Regions in transition timed out:  testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf. state=PENDING_CLOSE, ts=1336485917495, server=null
2012-05-08 22:08:08,121 INFO  [Jieshan.china.huawei.com,57110,1336485831968.timeoutMonitor] master.AssignmentManager$TimeoutMonitor(2925): Region has been PENDING_CLOSE for too long, running forced unassign again on region=testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf.
2012-05-08 22:08:08,121 DEBUG [pool-8-thread-13] master.AssignmentManager(1936): Starting unassignment of region testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf. (offlining)
2012-05-08 22:08:08,121 DEBUG [pool-8-thread-13] master.AssignmentManager(1942): Attempted to unassign region testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf. but it is not currently assigned anywhere
2012-05-08 22:08:18,122 INFO  [Jieshan.china.huawei.com,57110,1336485831968.timeoutMonitor] master.AssignmentManager$TimeoutMonitor(2893): Regions in transition timed out:  testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf. state=PENDING_CLOSE, ts=1336485917495, server=null
2012-05-08 22:08:18,122 INFO  [Jieshan.china.huawei.com,57110,1336485831968.timeoutMonitor] master.AssignmentManager$TimeoutMonitor(2925): Region has been PENDING_CLOSE for too long, running forced unassign again on region=testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf.
2012-05-08 22:08:18,122 DEBUG [pool-8-thread-6] master.AssignmentManager(1936): Starting unassignment of region testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf. (offlining)
2012-05-08 22:08:18,125 DEBUG [pool-8-thread-6] master.AssignmentManager(1942): Attempted to unassign region testHBase5937,000,1336485845463.fc6c3b7c6445127b63f617445aa5dfaf. but it is not currently assigned anywhere
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13270690" author="stack" created="Tue, 8 May 2012 18:34:56 +0000"  >&lt;p&gt;Test looks great.  What do you need to ensure that you can reproduce the condition 100% of the time?  Do you have a proposed fix Jieshan?  Thanks.&lt;/p&gt;</comment>
                            <comment id="13271046" author="jeason" created="Wed, 9 May 2012 03:35:45 +0000"  >&lt;p&gt;I didn&apos;t do anything to ensure that test case can reproduce it each time. Just give a simple test case which can reproduced with a high probability. &lt;br/&gt;
We have an idea on how to fix this, and will provide a patch after verification. Thank you.&lt;/p&gt;</comment>
                            <comment id="13272548" author="ram_krish" created="Thu, 10 May 2012 17:52:04 +0000"  >&lt;p&gt;This is patch for 0.94 for review.  Tomorrow can upload patch for Trunk.&lt;/p&gt;</comment>
                            <comment id="13274525" author="jeason" created="Mon, 14 May 2012 09:30:22 +0000"  >&lt;p&gt;Patch looks good. Thank you, rama&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13274812" author="rajesh23" created="Mon, 14 May 2012 18:07:04 +0000"  >&lt;p&gt;Patch for trunk. Please review and provide comments/suggestions.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5914&quot; title=&quot;Bulk assign regions in the process of ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5914&quot;&gt;&lt;del&gt;HBASE-5914&lt;/del&gt;&lt;/a&gt; causing assignment of disabling/ disabled table regions. Avoided by removing regioninfo from toAssignRegions list if disable is happening to a table.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
toAssignRegions.remove(hri);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13274840" author="zhihyu@ebaysf.com" created="Mon, 14 May 2012 18:38:34 +0000"  >&lt;p&gt;Please generate the patch from project root.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void deleteClosingOrClosedNode(HRegionInfo region, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; abort) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please add javadoc for the new parameter - abort.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          &lt;span class=&quot;code-comment&quot;&gt;// The rit that we use may be a stale in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; when the table was in DISABLING state&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&apos;a stale&apos; -&amp;gt; &apos;stale&apos;. &apos;in case when&apos; -&amp;gt; &apos;in case&apos;.&lt;/p&gt;</comment>
                            <comment id="13275177" author="ram_krish" created="Tue, 15 May 2012 04:54:35 +0000"  >&lt;p&gt;@Rajesh&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5914&quot; title=&quot;Bulk assign regions in the process of ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5914&quot;&gt;&lt;del&gt;HBASE-5914&lt;/del&gt;&lt;/a&gt; causing assignment of disabling/ disabled table regions. Avoided by removing regioninfo from toAssignRegions list if disable is happening to a table.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks for taking care of this.  Good catch.&lt;/p&gt;</comment>
                            <comment id="13276369" author="rajesh23" created="Wed, 16 May 2012 00:54:57 +0000"  >&lt;p&gt;@Zhihong Yu&lt;br/&gt;
Thanks for review.&lt;/p&gt;

&lt;p&gt;Added new patch. Addressing Zhihong Yu&apos;s comments.&lt;/p&gt;

&lt;p&gt;In case of keeper exception we always abort master that&apos;s why removed abort condition in previous patch(abort parameter as well).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (abort) {
        master.abort(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected ZK exception deleting node CLOSING/CLOSED &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the region &quot;&lt;/span&gt;
            + region.getEncodedName(), ke);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="13276376" author="rajesh23" created="Wed, 16 May 2012 01:22:09 +0000"  >&lt;p&gt;updated patch for 0.94&lt;/p&gt;</comment>
                            <comment id="13276378" author="hadoopqa" created="Wed, 16 May 2012 01:32:09 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527552/HBASE-5927_94_v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527552/HBASE-5927_94_v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1881//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1881//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13276384" author="hadoopqa" created="Wed, 16 May 2012 01:46:30 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12527550/HBASE-5927_trunk_2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12527550/HBASE-5927_trunk_2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop23.  The patch compiles against the hadoop 0.23.x profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 31 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.client.TestFromClientSide&lt;br/&gt;
                  org.apache.hadoop.hbase.io.hfile.TestForceCacheImportantBlocks&lt;br/&gt;
                  org.apache.hadoop.hbase.master.TestSplitLogManager&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1880//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1880//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1880//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1880//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1880//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1880//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13276579" author="zjushch" created="Wed, 16 May 2012 08:15:08 +0000"  >&lt;p&gt;@Rajesh&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5914&quot; title=&quot;Bulk assign regions in the process of ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5914&quot;&gt;&lt;del&gt;HBASE-5914&lt;/del&gt;&lt;/a&gt; causing assignment of disabling/ disabled table regions. Avoided by removing regioninfo from toAssignRegions list if disable is happening to a table.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it&apos;s not right.&lt;/p&gt;

&lt;p&gt;1.ServerShutdownHandler#processDeadRegion will return false if the table is disabled , so we wouldn&apos;t add the region to toAssignRegions in the process of ServerShutdownHandler.&lt;/p&gt;

&lt;p&gt;2.For the disabling table regions, ServerShutdownHandler will assign it with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5914&quot; title=&quot;Bulk assign regions in the process of ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5914&quot;&gt;&lt;del&gt;HBASE-5914&lt;/del&gt;&lt;/a&gt;, however, OpenedRegionHandler will unassign it again after it is opened.&lt;/p&gt;


&lt;p&gt;However, we found SSH and DisableTableHandler happening together may cause &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6012&quot; title=&quot;Handling RegionOpeningState for bulk assign&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6012&quot;&gt;&lt;del&gt;HBASE-6012&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Could we make a new method which cancel closing if region belongs to disabling ?&lt;/p&gt;

&lt;p&gt;So we could fix the issue as the following&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!regions.containsKey(region)) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Attempted to unassign region &quot;&lt;/span&gt; +
          region.getRegionNameAsString() + &lt;span class=&quot;code-quote&quot;&gt;&quot; but it is not &quot;&lt;/span&gt; +
          &lt;span class=&quot;code-quote&quot;&gt;&quot;currently assigned anywhere&quot;&lt;/span&gt;);
        cancelClosingRegionIfDisabling(region)
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }

....
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; NotServingRegionException) {
cancelClosingRegionIfDisabling(region)

}
...


&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void cancelClosingRegionIfDisabling(HRegionInfo region) {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (checkIfRegionBelongsToDisabling(region)) {
          &lt;span class=&quot;code-comment&quot;&gt;// Remove from the regionsinTransition map
&lt;/span&gt;          LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;While trying to recover the table &quot;&lt;/span&gt;
              + region.getTableNameAsString()
              + &lt;span class=&quot;code-quote&quot;&gt;&quot; to DISABLED state the region &quot;&lt;/span&gt; + region
              + &lt;span class=&quot;code-quote&quot;&gt;&quot; was offlined but the table was in DISABLING state&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionsInTransition) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionsInTransition.remove(region.getEncodedName());
          }
          &lt;span class=&quot;code-comment&quot;&gt;// Remove from the regionsMap
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions.remove(region);
            Set&amp;lt;HRegionInfo&amp;gt; serverRegions = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.servers.get(server);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!serverRegions.remove(region)) {
              LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;No &quot;&lt;/span&gt; + region + &lt;span class=&quot;code-quote&quot;&gt;&quot; on &quot;&lt;/span&gt; + server);
            }
          }
          deleteClosingOrClosedNode(region);
        }

  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Correct me if wrong, thanks!&lt;/p&gt;


</comment>
                            <comment id="13276586" author="ram_krish" created="Wed, 16 May 2012 08:26:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;2.For the disabling table regions, ServerShutdownHandler will assign it with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5914&quot; title=&quot;Bulk assign regions in the process of ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5914&quot;&gt;&lt;del&gt;HBASE-5914&lt;/del&gt;&lt;/a&gt;, however, OpenedRegionHandler will unassign it again after it is opened.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But why should an assign happen and then go with reassign when we already know it is a disabling table? Anyway we will try to come up with a wholesome solution taking your suggestion also.&lt;br/&gt;
Good on you Chunhui.  &lt;/p&gt;</comment>
                            <comment id="13276592" author="zjushch" created="Wed, 16 May 2012 08:34:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;But why should an assign happen and then go with reassign when we already know it is a disabling table&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, we needn&apos;t do the reassign. But I think it&apos;s the problem of ServerShutdownHandler#processDeadRegion,&lt;br/&gt;
why not return false for disabling table region.&lt;br/&gt;
So I think we could modify a little for the ServerShutdownHandler#processDeadRegion:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; processDeadRegion(HRegionInfo hri, Result result,
      AssignmentManager assignmentManager, CatalogTracker catalogTracker)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
   ...
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hri.isOffline() &amp;amp;&amp;amp; hri.isSplit()) {
      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Offlined and split region &quot;&lt;/span&gt; + hri.getRegionNameAsString() +
        &lt;span class=&quot;code-quote&quot;&gt;&quot;; checking daughter presence&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (MetaReader.getRegion(catalogTracker, hri.getRegionName()) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
      }
      fixupDaughters(result, assignmentManager, catalogTracker);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }
    &lt;span class=&quot;code-comment&quot;&gt;// If table is not disabled but the region is offlined,
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; disabling = assignmentManager.getZKTable().isDisablingTable(
        hri.getTableNameAsString());
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (disabling) {
      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;The table &quot;&lt;/span&gt; + hri.getTableNameAsString()
          + &lt;span class=&quot;code-quote&quot;&gt;&quot; is disabling.  Hence not assign it.&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13276605" author="rajesh23" created="Wed, 16 May 2012 08:51:45 +0000"  >
&lt;blockquote&gt;&lt;p&gt;2.For the disabling table regions, ServerShutdownHandler will assign it with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5914&quot; title=&quot;Bulk assign regions in the process of ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5914&quot;&gt;&lt;del&gt;HBASE-5914&lt;/del&gt;&lt;/a&gt;, however, OpenedRegionHandler will unassign it again after it is opened.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;unassign happen only when znode deletion failed in OpenedRegionHandler&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      openedNodeDeleted = deleteOpenedNode(expectedVersion);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;if znode deleted success fully we end up with assignment of disabling table regions because we cannot call unassign in this case.&lt;/p&gt;</comment>
                            <comment id="13276609" author="zjushch" created="Wed, 16 May 2012 09:02:28 +0000"  >&lt;p&gt;@rajeshbabu&lt;br/&gt;
I&apos;m sorry I didn&apos;t see the current logic in OpenedRegionHandler which only call unassign if failed deleting znode.&lt;/p&gt;

&lt;p&gt;So, what about change the ServerShutdownHandler#processDeadRegion, return false for the disabling table regions.&lt;/p&gt;</comment>
                            <comment id="13276610" author="rajesh23" created="Wed, 16 May 2012 09:06:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;So I think we could modify a little for the ServerShutdownHandler#processDeadRegion:&lt;/p&gt;&lt;/blockquote&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; disabling = assignmentManager.getZKTable().isDisablingTable(
        hri.getTableNameAsString());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case we are not adding region info to toAssignRegions list no need to remove from this list&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
toAssignRegions.remove(hri)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But even we return false in case of disabling/disabled there may be chance of znode and rit present. &lt;br/&gt;
we need to wait until timeout monitor(present 30min.) to trigger unassign and call &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        cancelClosingRegionIfDisabling(region)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thats why we need to have below statements to remove rit and clear znode.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          am.deleteClosingOrClosedNode(hri);
           am.regionOffline(hri);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13276622" author="zjushch" created="Wed, 16 May 2012 09:42:21 +0000"  >&lt;p&gt;@rajeshbabu &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;we need to wait until timeout monitor(present 30min.) to trigger unassign and call&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So it would be better cancel closing disabling regions since we found it the in the process of ServerShutdownHandler.&lt;/p&gt;

&lt;p&gt;I&apos;m clear, thanks&lt;/p&gt;</comment>
                            <comment id="13277132" author="zhihyu@ebaysf.com" created="Wed, 16 May 2012 20:49:05 +0000"  >&lt;p&gt;I ran the 3 failed tests and they passed.&lt;/p&gt;

&lt;p&gt;Will wait till tomorrow for more comments.&lt;/p&gt;</comment>
                            <comment id="13278369" author="stack" created="Thu, 17 May 2012 22:50:01 +0000"  >&lt;p&gt;+1 Makes sense.  Thanks for writing a nice test.&lt;/p&gt;</comment>
                            <comment id="13278385" author="zhihyu@ebaysf.com" created="Thu, 17 May 2012 23:07:54 +0000"  >&lt;p&gt;Integrated to 0.94 and trunk.&lt;/p&gt;

&lt;p&gt;Thanks for the patch, Rajesh.&lt;/p&gt;

&lt;p&gt;Thanks for the review Stack and Chunhui.&lt;/p&gt;</comment>
                            <comment id="13278405" author="hudson" created="Thu, 17 May 2012 23:49:26 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2896 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2896/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2896/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5927&quot; title=&quot;SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5927&quot;&gt;&lt;del&gt;HBASE-5927&lt;/del&gt;&lt;/a&gt; SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map (Rajesh) (Revision 1339913)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13278410" author="hudson" created="Thu, 17 May 2012 23:50:58 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #198 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/198/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/198/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5927&quot; title=&quot;SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5927&quot;&gt;&lt;del&gt;HBASE-5927&lt;/del&gt;&lt;/a&gt; SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map (Rajesh) (Revision 1339915)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13278417" author="hudson" created="Thu, 17 May 2012 23:55:51 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #8 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/8/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/8/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5927&quot; title=&quot;SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5927&quot;&gt;&lt;del&gt;HBASE-5927&lt;/del&gt;&lt;/a&gt; SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map (Rajesh) (Revision 1339913)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13279406" author="hudson" created="Sat, 19 May 2012 02:42:08 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #27 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/27/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/27/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5927&quot; title=&quot;SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5927&quot;&gt;&lt;del&gt;HBASE-5927&lt;/del&gt;&lt;/a&gt; SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map (Rajesh) (Revision 1339915)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13280828" author="ram_krish" created="Tue, 22 May 2012 09:15:57 +0000"  >&lt;p&gt;Resolving as committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12526383" name="HBASE-5927_94.patch" size="12788" author="ram_krish" created="Thu, 10 May 2012 17:52:04 +0000"/>
                            <attachment id="12527552" name="HBASE-5927_94_v2.patch" size="11711" author="rajesh23" created="Wed, 16 May 2012 01:22:09 +0000"/>
                            <attachment id="12526790" name="HBASE-5927_trunk.patch" size="13153" author="rajesh23" created="Mon, 14 May 2012 18:07:04 +0000"/>
                            <attachment id="12527550" name="HBASE-5927_trunk_2.patch" size="12118" author="rajesh23" created="Wed, 16 May 2012 00:43:01 +0000"/>
                            <attachment id="12526000" name="TestCaseForReProduce.txt" size="5257" author="jeason" created="Tue, 8 May 2012 15:11:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 3 May 2012 16:24:22 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237999</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i068l3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34322</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>