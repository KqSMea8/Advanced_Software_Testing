<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:15:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-10636/HBASE-10636.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-10636] HBaseAdmin.deleteTable isn&apos;t &apos;really&apos; synchronous in that still some cleanup in HMaster after client thinks deleteTable() succeeds</title>
                <link>https://issues.apache.org/jira/browse/HBASE-10636</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In HBaseAdmin.deleteTable():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void deleteTable(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TableName tableName) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-comment&quot;&gt;// Wait until all regions deleted
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; tries = 0; tries &amp;lt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.numRetries * &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.retryLongerMultiplier); tries++) {
        &lt;span class=&quot;code-comment&quot;&gt;// let us wait until hbase:meta table is updated and
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// HMaster removes the table from its HTableDescriptors
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (values == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || values.length == 0) {
          tableExists = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
          GetTableDescriptorsResponse htds;
          MasterKeepAliveConnection master = connection.getKeepAliveMasterService();
          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            GetTableDescriptorsRequest req =
              RequestConverter.buildGetTableDescriptorsRequest(tableName);
            htds = master.getTableDescriptors(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, req);
          } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ServiceException se) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; ProtobufUtil.getRemoteException(se);
          } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            master.close();
          }
          tableExists = !htds.getTableSchemaList().isEmpty();
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!tableExists) {
            &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
          }
        }
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;client thinks deleteTable succeeds once it can&apos;t retrieve back the tableDescriptor&lt;/p&gt;

&lt;p&gt;But in HMaster, the DeleteTableHandler which really deletes the table:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void handleTableOperation(List&amp;lt;HRegionInfo&amp;gt; regions)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, KeeperException {
    &lt;span class=&quot;code-comment&quot;&gt;// 1. Wait because of region in transition
&lt;/span&gt;    ....
    &lt;span class=&quot;code-comment&quot;&gt;// 2. Remove regions from META
&lt;/span&gt;    LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Deleting regions from META&quot;&lt;/span&gt;);
    MetaEditor.deleteRegions(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.server.getCatalogTracker(), regions);

    &lt;span class=&quot;code-comment&quot;&gt;// 3. Move the table in /hbase/.tmp
&lt;/span&gt;    MasterFileSystem mfs = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.masterServices.getMasterFileSystem();
    Path tempTableDir = mfs.moveTableToTemp(tableName);

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-comment&quot;&gt;// 4. Delete regions from FS (temp directory)
&lt;/span&gt;      FileSystem fs = mfs.getFileSystem();
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (HRegionInfo hri: regions) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Archiving region &quot;&lt;/span&gt; + hri.getRegionNameAsString() + &lt;span class=&quot;code-quote&quot;&gt;&quot; from FS&quot;&lt;/span&gt;);
        HFileArchiver.archiveRegion(fs, mfs.getRootDir(),
            tempTableDir, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(tempTableDir, hri.getEncodedName()));
      }

      &lt;span class=&quot;code-comment&quot;&gt;// 5. Delete table from FS (temp directory)
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!fs.delete(tempTableDir, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
        LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Couldn&apos;t delete &quot;&lt;/span&gt; + tempTableDir);
      }

      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Table &apos;&quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; archived!&quot;&lt;/span&gt;);
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      &lt;span class=&quot;code-comment&quot;&gt;// 6. Update table descriptor cache
&lt;/span&gt;      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Removing &apos;&quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; descriptor.&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.masterServices.getTableDescriptors().remove(tableName);

      &lt;span class=&quot;code-comment&quot;&gt;// 7. Clean up regions of the table in RegionStates.
&lt;/span&gt;      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Removing &apos;&quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; from region states.&quot;&lt;/span&gt;);
      states.tableDeleted(tableName);

      &lt;span class=&quot;code-comment&quot;&gt;// 8. If entry &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; table in zk, and up in AssignmentManager, remove it.
&lt;/span&gt;      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Marking &apos;&quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; as deleted.&quot;&lt;/span&gt;);
      am.getZKTable().setDeletedTable(tableName);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cpHost != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      cpHost.postDeleteTableHandler(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tableName);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Removing regions out of RegionStates, Marking table deleted from ZK, Calling coprocessor&apos;s postDeleteTableHandler are all after the table is removed from TableDescriptor cache&lt;/p&gt;

&lt;p&gt;So client code relying on RegionStates/ZKTable/CP being cleaned up after deleteTable() possibly fail, if client requests hit HMaster before those three cleanup are done...&lt;/p&gt;

&lt;p&gt;Actually when I add some sleep such as 200ms after below line to simulate a possible slow-running HMaster&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.masterServices.getTableDescriptors().remove(tableName);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Some unit tests(such as moveRegion / confirming postDeleteTable CP immediately after deleteTable) can&apos;t pass no longer&lt;/p&gt;</description>
                <environment></environment>
        <key id="12697878">HBASE-10636</key>
            <summary>HBaseAdmin.deleteTable isn&apos;t &apos;really&apos; synchronous in that still some cleanup in HMaster after client thinks deleteTable() succeeds</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12697642">HBASE-10628</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="fenghh">Honghua Feng</assignee>
                                    <reporter username="fenghh">Honghua Feng</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Feb 2014 07:46:55 +0000</created>
                <updated>Fri, 28 Feb 2014 07:46:55 +0000</updated>
                                                                            <component>Client</component>
                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376352</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1supj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376648</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>