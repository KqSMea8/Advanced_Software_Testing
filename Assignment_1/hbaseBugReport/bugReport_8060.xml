<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:51:39 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8060/HBASE-8060.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8060] &quot;Num compacting KVs&quot; diverges from &quot;num compacted KVs&quot; over time</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8060</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I have been running what amounts to an ingestion test for a day or so. This is an all-in-one cluster launched with &apos;./bin/hbase master start&apos; from sources. In the RS stats on the master UI, the &quot;num compacting KVs&quot; has diverged from &quot;num compacted KVs&quot; even though compaction has been completed from perspective of selection, no compaction tasks are running on the RS. I think this could be confusing &amp;#8211; is compaction happening or not?&lt;/p&gt;

&lt;p&gt;Or maybe I&apos;m misunderstanding what this is supposed to show?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12636225">HBASE-8060</key>
            <summary>&quot;Num compacting KVs&quot; diverges from &quot;num compacted KVs&quot; over time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sershe">Sergey Shelukhin</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Sun, 10 Mar 2013 03:45:03 +0000</created>
                <updated>Mon, 23 Sep 2013 19:22:40 +0000</updated>
                            <resolved>Mon, 24 Jun 2013 20:48:36 +0000</resolved>
                                    <version>0.94.6</version>
                    <version>0.95.0</version>
                    <version>0.95.2</version>
                                    <fixVersion>0.98.0</fixVersion>
                    <fixVersion>0.95.2</fixVersion>
                                    <component>Compaction</component>
                    <component>UI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13598172" author="lhofhansl" created="Sun, 10 Mar 2013 06:21:19 +0000"  >&lt;p&gt;Wow... That pretty far off. Does this only happen in trunk/0.95?&lt;/p&gt;</comment>
                            <comment id="13598451" author="jmspaggi" created="Mon, 11 Mar 2013 00:42:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; where is this screenshot taken from? I don&apos;t reconnize the default web UI.&lt;/p&gt;</comment>
                            <comment id="13598480" author="apurtell" created="Mon, 11 Mar 2013 02:07:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmspaggi&quot; class=&quot;user-hover&quot; rel=&quot;jmspaggi&quot;&gt;Jean-Marc Spaggiari&lt;/a&gt;: Screenshot is the 0.95/trunk UI.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;: Trying it out with 0.94 now.&lt;/p&gt;</comment>
                            <comment id="13598508" author="apurtell" created="Mon, 11 Mar 2013 03:50:22 +0000"  >&lt;p&gt;Did an ingest test (via LoadTestTool) with occasional forced compactions and splits with head of 0.94 branch. After a while I turned off the load and waited for the RS compaction queue to drain. The end result is not what I would expect, some incorrect accounting across splits looks like:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cluster_test,,1362970176754.cf7153f594b71e71bced63f2f56c8c68.
  totalCompactingKVs=16752341, currentCompactedKVs=11696023, compactionProgressPct=0.0

cluster_test,198ba304c5c6d1fce170ea9ddf956540-2809310,1362970176754.653caa9699cfdaabb880d27b2be23a88.
  totalCompactingKVs=16805702, currentCompactedKVs=11748155, compactionProgressPct=0.0

cluster_test,33333333,1362970196990.cd169cb2b4699c5a8eb22fa8720c57e3.
  totalCompactingKVs=15317369, currentCompactedKVs=11711367, compactionProgressPct=0.0

cluster_test,4cd51e1b30a4a602f48fbdae91b0c94e-6910328,1362970196990.a16adf2670eb27cde0d77bf4be631c7e.
  totalCompactingKVs=15314264, currentCompactedKVs=11694850, compactionProgressPct=0.0

cluster_test,66666666,1362970208081.84222a5d47eda4fed4a5452954f2d34c.
  totalCompactingKVs=15848942, currentCompactedKVs=11675591, compactionProgressPct=0.0

cluster_test,7ff5877e8e1973e8479881e280a215ed-7188496,1362970208081.cc14e23f25e56c783f8496b903a8cfee.
  totalCompactingKVs=15860814, currentCompactedKVs=11706594, compactionProgressPct=0.0

cluster_test,99999999,1362970211112.01bfcb43664bd150379ea9f0794360d4.
  totalCompactingKVs=15428253, currentCompactedKVs=11718368, compactionProgressPct=0.0

cluster_test,b330ffc95fa2d2d53fee5cd100a0b6ef-7925280,1362970211112.fe19eaea03e367f923861fae98f6aed2.
  totalCompactingKVs=15406477, currentCompactedKVs=11701519, compactionProgressPct=0.0

cluster_test,cccccccc,1362970238452.e7d33a01530fc8cfbb457055b390ddc5.
  totalCompactingKVs=15884797, currentCompactedKVs=11730784, compactionProgressPct=0.0

cluster_test,e66be25e571007cd06022edf1662ce78-4552250,1362970238452.ef453b0873b829114ea5096164dd3ef8.
  totalCompactingKVs=15888383, currentCompactedKVs=11736683, compactionProgressPct=0.0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After this test I restarted the other instance. Compaction progress is reported at 100.00% again. My guess is at the next split this will begin to trend downward again.&lt;/p&gt;</comment>
                            <comment id="13687502" author="sershe" created="Wed, 19 Jun 2013 01:38:57 +0000"  >&lt;p&gt;Can you elaborate on the test used? There is a possible culprit from skimming the code.&lt;br/&gt;
Due to optimizations in ScanQueryMatcher compaction may not actually observe all KVs if there are updates and deletes present, some KVs/rows/columns may be skipped. So kvs compacted will never reach the total. Compaction progress is only reset when compaction is started so this &quot;unfinished&quot; progress will stick around for some time.&lt;br/&gt;
However in standard LoadTestTool there are no updates and this should not happen.&lt;br/&gt;
Did the test have updates or deletes?&lt;/p&gt;

&lt;p&gt;I will try to repro later this week, to see what is going on.&lt;/p&gt;</comment>
                            <comment id="13687504" author="apurtell" created="Wed, 19 Jun 2013 01:44:21 +0000"  >&lt;p&gt;I simply ran LoadTestTool and then while refreshing the UI noticed divergence that increased stepwise with splits looked like.&lt;/p&gt;</comment>
                            <comment id="13687505" author="apurtell" created="Wed, 19 Jun 2013 01:45:04 +0000"  >&lt;p&gt;I haven&apos;t looked at the UI of any version for many many weeks. Will have a chance this week though.&lt;/p&gt;</comment>
                            <comment id="13688593" author="sershe" created="Wed, 19 Jun 2013 22:51:33 +0000"  >&lt;p&gt;I found the root cause it seems...&lt;/p&gt;</comment>
                            <comment id="13688609" author="sershe" created="Wed, 19 Jun 2013 23:12:13 +0000"  >&lt;p&gt;This patch does two things.&lt;br/&gt;
First, it adds more correct entry count getters for HalfStoreFileReader. HalfStoreFileReader inherits the parent methods that give total for the file, resulting in inaccurate total estimate after split. If estimate is split in half, it will be less inaccurate.&lt;/p&gt;

&lt;p&gt;Then, given that all these totals are speculative even in normal case, and moreso after split, I am adding the artificial reconciliation of compaction progress after compaction is finished to show the final total and current values.&lt;/p&gt;</comment>
                            <comment id="13688610" author="sershe" created="Wed, 19 Jun 2013 23:12:41 +0000"  >&lt;p&gt;Seems to work on local cluster&lt;/p&gt;</comment>
                            <comment id="13689047" author="lhofhansl" created="Thu, 20 Jun 2013 09:27:42 +0000"  >&lt;p&gt;What is the meaning of totalCompactingKVs? Overall total? Or just the total for the last compaction?&lt;br/&gt;
Does the patch change the meaning by resetting to current compacted count?&lt;/p&gt;</comment>
                            <comment id="13689424" author="sershe" created="Thu, 20 Jun 2013 17:30:53 +0000"  >&lt;p&gt;The meaning of total compacting KVs is the number of KVs in the input for last-started compaction (this historically assumes one compaction at a time per store). I.e. either current compaction or the last finished one. It is an estimate of the number of KVs compaction will see, used to track progress. Patch does change meaning of it to reconcile the (often incorrect) estimate with reality..&lt;/p&gt;</comment>
                            <comment id="13689442" author="lhofhansl" created="Thu, 20 Jun 2013 17:48:42 +0000"  >&lt;p&gt;I see. So it does not really change the meaning - it&apos;s still the number of KV compacted in last compaction - it just corrects the value.&lt;/p&gt;</comment>
                            <comment id="13692171" author="sershe" created="Mon, 24 Jun 2013 17:36:39 +0000"  >&lt;p&gt;ping?&lt;/p&gt;</comment>
                            <comment id="13692179" author="stack" created="Mon, 24 Jun 2013 17:44:49 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13692360" author="sershe" created="Mon, 24 Jun 2013 20:48:36 +0000"  >&lt;p&gt;committed to 95 and trunk&lt;/p&gt;</comment>
                            <comment id="13692377" author="lhofhansl" created="Mon, 24 Jun 2013 20:57:58 +0000"  >&lt;p&gt;Is this an issue in 0.94 as well?&lt;/p&gt;</comment>
                            <comment id="13692460" author="hudson" created="Mon, 24 Jun 2013 22:25:42 +0000"  >&lt;p&gt;Integrated in hbase-0.95 #265 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.95/265/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.95/265/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8060&quot; title=&quot;&amp;quot;Num compacting KVs&amp;quot; diverges from &amp;quot;num compacted KVs&amp;quot; over time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8060&quot;&gt;&lt;del&gt;HBASE-8060&lt;/del&gt;&lt;/a&gt; Num compacting KVs diverges from num compacted KVs over time (Revision 1496215)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
sershe : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.95/hbase-server/src/main/java/org/apache/hadoop/hbase/io/HalfStoreFileReader.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.95/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/CompactionProgress.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.95/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/Compactor.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13692575" author="hudson" created="Mon, 24 Jun 2013 23:50:49 +0000"  >&lt;p&gt;Integrated in hbase-0.95-on-hadoop2 #147 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.95-on-hadoop2/147/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.95-on-hadoop2/147/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8060&quot; title=&quot;&amp;quot;Num compacting KVs&amp;quot; diverges from &amp;quot;num compacted KVs&amp;quot; over time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8060&quot;&gt;&lt;del&gt;HBASE-8060&lt;/del&gt;&lt;/a&gt; Num compacting KVs diverges from num compacted KVs over time (Revision 1496215)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
sershe : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.95/hbase-server/src/main/java/org/apache/hadoop/hbase/io/HalfStoreFileReader.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.95/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/CompactionProgress.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.95/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/Compactor.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13692654" author="hudson" created="Tue, 25 Jun 2013 01:17:43 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #582 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/582/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/582/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8060&quot; title=&quot;&amp;quot;Num compacting KVs&amp;quot; diverges from &amp;quot;num compacted KVs&amp;quot; over time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8060&quot;&gt;&lt;del&gt;HBASE-8060&lt;/del&gt;&lt;/a&gt; Num compacting KVs diverges from num compacted KVs over time (Revision 1496214)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
sershe : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/io/HalfStoreFileReader.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/CompactionProgress.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/Compactor.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12588720" name="HBASE-8060-v0.patch" size="3080" author="sershe" created="Wed, 19 Jun 2013 23:12:13 +0000"/>
                            <attachment id="12572946" name="screenshot.png" size="36185" author="apurtell" created="Sun, 10 Mar 2013 03:45:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 10 Mar 2013 06:21:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316717</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 25 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ing7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>317059</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>