<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:39:37 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6760/HBASE-6760.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6760] HMaster.balance() returns &apos;true&apos; even if rebalancing plan is empty and the balancer does not run</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6760</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The issue seems to exists due to oversight during the rewrite. In line 1289, the variable &apos;plans&apos; is created as a &apos;new ArrayList&amp;lt;RegionPlan&amp;gt;()&apos; and then in line 1298, balancerRan is calculated as (plans != null) which for obvious reason, will always return true.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;HMaster.java (trunk:1383496)&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
....
1289        List&amp;lt;RegionPlan&amp;gt; plans = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;RegionPlan&amp;gt;();
1290        &lt;span class=&quot;code-comment&quot;&gt;//Give the balancer the current cluster state.
&lt;/span&gt;1291        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.balancer.setClusterStatus(getClusterStatus());
1292        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map&amp;lt;ServerName, List&amp;lt;HRegionInfo&amp;gt;&amp;gt; assignments : assignmentsByTable.values()) {
1293          List&amp;lt;RegionPlan&amp;gt; partialPlans = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.balancer.balanceCluster(assignments);
1294          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partialPlans != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) plans.addAll(partialPlans);
1295        }
1296        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rpCount = 0;  &lt;span class=&quot;code-comment&quot;&gt;// number of RegionPlans balanced so far
&lt;/span&gt;1297        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; totalRegPlanExecTime = 0;
1298        balancerRan = plans != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
1299        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (plans != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !plans.isEmpty()) {
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A simple fix is to initialize &apos;balancerRan&apos; to &apos;false&apos;, remove &quot;balancerRan = plans != null&quot; and add &quot;balancerRan = true&quot; after &quot;if (plans != null &amp;amp;&amp;amp; !plans.isEmpty()) {&quot;.&lt;/p&gt;

&lt;p&gt;However, a question remains that should we call &quot;this.cpHost.postBalance();&quot; if the balancer did not run at this point?&lt;/p&gt;

&lt;p&gt;I&apos;ll attach the patch shortly if I get a confirmation on this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12607110">HBASE-6760</key>
            <summary>HMaster.balance() returns &apos;true&apos; even if rebalancing plan is empty and the balancer does not run</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="6">Invalid</resolution>
                                        <assignee username="adityakishore">Aditya Kishore</assignee>
                                    <reporter username="adityakishore">Aditya Kishore</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Sep 2012 18:33:52 +0000</created>
                <updated>Thu, 8 Jan 2015 19:20:53 +0000</updated>
                            <resolved>Thu, 8 Jan 2015 08:07:15 +0000</resolved>
                                                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13453301" author="eclark" created="Tue, 11 Sep 2012 18:56:39 +0000"  >&lt;p&gt;I would think that the cp should get called as long as the balancer ran,  even if there were no plans created or applied. &lt;/p&gt;

&lt;p&gt;Also the naming of blancerRan is pretty confusing.  appliedRegionPlans seems like a more accurate name.  Is that what we want or should it return true if the balancer was run at all?&lt;/p&gt;</comment>
                            <comment id="13453321" author="adityakishore" created="Tue, 11 Sep 2012 19:24:06 +0000"  >&lt;p&gt;The balancer truly runs only if the re-balancing plan is calculated as not null AND not empty. i.e. within the condition&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (plans != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !plans.isEmpty()) {
    &lt;span class=&quot;code-comment&quot;&gt;//run balancer
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Further the contract of HMaster.balance() is to return true iff the balancer actually runs and re-balances the region assignments. So the name blancerRan, which is also stores the return value of the function, seems appropriate.&lt;/p&gt;

&lt;p&gt;Further, IMO, &quot;this.cpHost.postBalance();&quot; should only be called if the balancer has run. Or at the least pass this information (true/false or number of regions balanced in this run) to the CP but that will require interface change in MasterCoprocessorHost.&lt;/p&gt;</comment>
                            <comment id="13453330" author="eclark" created="Tue, 11 Sep 2012 19:35:35 +0000"  >&lt;p&gt;See that&apos;s the interesting part of the naming.  The LoadBalancer is what computes the region plans.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        List&amp;lt;RegionPlan&amp;gt; partialPlans = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.balancer.balanceCluster(assignments);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the assignment manager is what&apos;s run to move regions.&lt;/p&gt;</comment>
                            <comment id="14268955" author="clehene" created="Thu, 8 Jan 2015 08:06:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adityakishore&quot; class=&quot;user-hover&quot; rel=&quot;adityakishore&quot;&gt;Aditya Kishore&lt;/a&gt;, based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;&apos;s comment in master this seems as the intended behavior:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// If LoadBalancer did not generate any plans, it means the cluster is already balanced.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Return &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; indicating a success.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also there&apos;s no more balancerRan variable.&lt;/p&gt;

&lt;p&gt;Also I believe &lt;tt&gt;LoadBalancer.balanceCluster(assignments);&lt;/tt&gt; should be named &lt;tt&gt;computeBalancePlans&lt;/tt&gt; or something as it&apos;s the &lt;tt&gt;AssignmentManager&lt;/tt&gt; that does the actual balancing...&lt;/p&gt;</comment>
                            <comment id="14268956" author="clehene" created="Thu, 8 Jan 2015 08:07:15 +0000"  >&lt;p&gt;Closing as &quot;invalid&quot; please see previous comments.&lt;/p&gt;</comment>
                            <comment id="14269893" author="enis" created="Thu, 8 Jan 2015 19:20:53 +0000"  >&lt;p&gt;Yes, this was fixed some time ago by another jira. Returning false when there is nothing to balance does not make sense. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 11 Sep 2012 18:56:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241747</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02c5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11570</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>