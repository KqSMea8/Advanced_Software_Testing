<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:09:43 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3381/HBASE-3381.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3381] Interrupt of a region open comes across as a successful open</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3381</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Meta was offline when below happened:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-12-21 19:45:23,023 DEBUG org.apache.hadoop.hbase.zookeeper.ZKAssign: regionserver:60020-0x12d0a53c540000e Attempting to transition node 337038b50e467fbd6b031f278bbd9c22 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENING
2010-12-21 19:45:23,046 DEBUG org.apache.hadoop.hbase.zookeeper.ZKAssign: regionserver:60020-0x12d0a53c540000e Successfully transitioned node 337038b50e467fbd6b031f278bbd9c22 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENING
2010-12-21 19:45:26,379 DEBUG org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Interrupting thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[PostOpenDeployTasks:337038b50e467fbd6b031f278bbd9c22,5,main]
2010-12-21 19:45:26,379 DEBUG org.apache.hadoop.hbase.zookeeper.ZKAssign: regionserver:60020-0x12d0a53c540000e Attempting to transition node 337038b50e467fbd6b031f278bbd9c22 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENED
2010-12-21 19:45:26,381 WARN org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Exception running postOpenDeployTasks; region=337038b50e467fbd6b031f278bbd9c22
org.apache.hadoop.hbase.NotAllMetaRegionsOnlineException: Interrupted
    at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMetaServerConnectionDefault(CatalogTracker.java:364)
    at org.apache.hadoop.hbase.catalog.MetaEditor.updateRegionLocation(MetaEditor.java:146)
    at org.apache.hadoop.hbase.regionserver.HRegionServer.postOpenDeployTasks(HRegionServer.java:1331)
    at org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler$PostOpenDeployTasksThread.run(OpenRegionHandler.java:195)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, we timed out trying to open the region but rather than close the region because edit failed, we missed seeing the InterruptedException.&lt;/p&gt;

&lt;p&gt;Here is suggested fix:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/src/main/java/org/apache/hadoop/hbase/catalog/MetaReader.java b/src/main/java/org/apache/hadoop/hbase/catalog/MetaReader.java
index 7bf680d..2b0078c 100644
--- a/src/main/java/org/apache/hadoop/hbase/catalog/MetaReader.java
+++ b/src/main/java/org/apache/hadoop/hbase/catalog/MetaReader.java
@@ -339,7 +339,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class MetaReader {
     get.addFamily(HConstants.CATALOG_FAMILY);
     &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] meta = getCatalogRegionNameForRegion(regionName);
     Result r = catalogTracker.waitForMetaServerConnectionDefault().get(meta, get);
-    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(r == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || r.isEmpty()) {
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (r == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || r.isEmpty()) {
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
     }
     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; metaRowToRegionPair(r);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me try it.&lt;/p&gt;

&lt;p&gt;W/o this, what we see is hbck showing that region is on server X but in .META. it shows as being on Y (its pre-balance server)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12493805">HBASE-3381</key>
            <summary>Interrupt of a region open comes across as a successful open</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Dec 2010 20:52:24 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:24 +0000</updated>
                            <resolved>Wed, 22 Dec 2010 18:16:07 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12973919" author="stack" created="Tue, 21 Dec 2010 21:48:17 +0000"  >&lt;p&gt;Jon pointed out that the above change is nought.  Here is what I meant:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java b/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java
index d3c78e1..0730fe1 100644
--- a/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java
+++ b/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java
@@ -165,7 +165,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class OpenRegionHandler &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; EventHandler {
     }
     &lt;span class=&quot;code-comment&quot;&gt;// Was there an exception opening the region?  This should trigger on
&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// InterruptedException too.  If so, we failed.
&lt;/span&gt;-    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; t.getException() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !t.interrupted() &amp;amp;&amp;amp; t.getException() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
   }
 
   /**
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the lines above, if we timeout, we interrupt the worker thread only we don&apos;t wait... we just move on to the test for exception.  I add the interrupted so if interrupted then that&apos;ll count as failed open.&lt;/p&gt;

&lt;p&gt;Testing.&lt;/p&gt;</comment>
                            <comment id="12973985" author="stack" created="Tue, 21 Dec 2010 23:49:21 +0000"  >&lt;p&gt;Here is the patch.  I&apos;ve not been able to repro the condition during last few hours of testing so would like to commit this (need a +1 &amp;#8211; Jon?).  While in here, I did some cleanup of hbck messages and stopped it claiming error when offlined split parent.  Also added logging around fixup of case where parent offlining edit got in but not daughter addtions; needed debugging.&lt;/p&gt;</comment>
                            <comment id="12973986" author="streamy" created="Wed, 22 Dec 2010 00:00:28 +0000"  >&lt;p&gt;+1 on all but the last change in HBCK.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
@@ -397,7 +399,8 @@ public class HBaseFsck {
       return;
     } else if (inMeta &amp;amp;&amp;amp; !shouldBeDeployed &amp;amp;&amp;amp; !isDeployed) {
       // offline regions shouldn&apos;t cause complaints
-      LOG.debug(&quot;Region &quot; + descriptiveName + &quot; offline, ignoring.&quot;);
+      LOG.debug(&quot;Region &quot; + descriptiveName + &quot; offline, splitParent=&quot; + splitParent +
+        &quot;, ignoring.&quot;);
       return;
     } else if (recentlyModified) {
       LOG.info(&quot;Region &quot; + descriptiveName + &quot; was recently modified -- skipping&quot;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This version of HBCK changes the &lt;tt&gt;shouldBeDeployed&lt;/tt&gt; to use the new ZK-based table disabling...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    boolean shouldBeDeployed = inMeta &amp;amp;&amp;amp; !isTableDisabled(hbi.metaEntry);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  private boolean isTableDisabled(HRegionInfo regionInfo) {
    return disabledTables.contains(regionInfo.getTableDesc().getName());
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think there should be (yet another) boolean in HBCK that is offlineInMeta.  And then separate checks for the possible good/bad states of that flag.  (and this log message should remain as it was since it&apos;s not relevant for splits).&lt;/p&gt;</comment>
                            <comment id="12973995" author="stack" created="Wed, 22 Dec 2010 00:19:30 +0000"  >&lt;p&gt;Committing to branch and trunk but changed the hbck emissions slightly after discussion with Jon.&lt;/p&gt;</comment>
                            <comment id="12974293" author="stack" created="Wed, 22 Dec 2010 17:40:01 +0000"  >&lt;p&gt;What I committed was crap.  More often than not, we&apos;d get woken up because the worker thread was done but we&apos;d then interrupt the worker thread though it was on its way out.  Made for confusing logging.&lt;/p&gt;

&lt;p&gt;I have a new patch that I&apos;ve been testing.  Will put it up in a sec.&lt;/p&gt;</comment>
                            <comment id="12974295" author="stack" created="Wed, 22 Dec 2010 17:42:13 +0000"  >&lt;p&gt;Here is evidence the mechanism is basically working (though this is not really what ths specific issue is about..... still need evidence that that is working):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-12-22 17:17:25,352 DEBUG org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Interrupting thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[PostOpenDeployTasks:9872342bec238398a94dee894ff29a6f,5,main]
2010-12-22 17:17:25,352 WARN org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Exception running postOpenDeployTasks; region=9872342bec238398a94dee894ff29a6f
org.apache.hadoop.hbase.NotAllMetaRegionsOnlineException: Interrupted
    at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMetaServerConnectionDefault(CatalogTracker.java:364)
    at org.apache.hadoop.hbase.catalog.MetaEditor.updateRegionLocation(MetaEditor.java:146)
    at org.apache.hadoop.hbase.regionserver.HRegionServer.postOpenDeployTasks(HRegionServer.java:1331)
    at org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler$PostOpenDeployTasksThread.run(OpenRegionHandler.java:205)
2010-12-22 17:17:25,352 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Closing TestTable,0612723473,1293034036869.9872342bec238398a94dee894ff29a6f.: disabling compactions &amp;amp; flushes
2010-12-22 17:17:25,352 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Updates disabled &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region TestTable,0612723473,1293034036869.9872342bec238398a94dee894ff29a6f.
2010-12-22 17:17:25,352 DEBUG org.apache.hadoop.hbase.regionserver.Store: closed info
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12974302" author="stack" created="Wed, 22 Dec 2010 17:54:28 +0000"  >&lt;p&gt;Sorry, the above stack trace IS evidence that latest spin on this patch is working (Its below).  We were stuck in CatalogManager waiting on .META. to come back and it was going on too long so the worker thread was interrupted... and the open of the region closed up (See above the &apos;Interrupting thread&apos; message and then the stack trace is actually out of the worker thread named PostOpenDeployTasksThread).&lt;/p&gt;

&lt;p&gt;Here is patch I&apos;m committing:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java b/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java
index d3c78e1..28bdfb9 100644
--- a/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java
+++ b/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java
@@ -160,8 +160,18 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class OpenRegionHandler &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; EventHandler {
     &lt;span class=&quot;code-comment&quot;&gt;// Is thread still alive?  We may have left above loop because server is
&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// stopping or we timed out the edit.  Is so, interrupt it.
&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t.isAlive()) {
-      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupting thread &quot;&lt;/span&gt; + t);
-      t.interrupt();
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!signaller.get()) {
+        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; still running; interrupt
&lt;/span&gt;+        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupting thread &quot;&lt;/span&gt; + t);
+        t.interrupt();
+      }
+      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+        t.join();
+      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) {
+        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted joining &quot;&lt;/span&gt; +
+          r.getRegionInfo().getRegionNameAsString(), ie);
+        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
+      }
     }
     &lt;span class=&quot;code-comment&quot;&gt;// Was there an exception opening the region?  This should trigger on
&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// InterruptedException too.  If so, we failed.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Only interrupt if our signaller has NOT been set (it will not be set if we are stuck trying to update meta).  Then join on the thread so we have chance to pick up any exceptions... so we return the right result out of this method.&lt;/p&gt;</comment>
                            <comment id="12974312" author="stack" created="Wed, 22 Dec 2010 18:16:07 +0000"  >&lt;p&gt;Re-resolving after testing second attempt at a fix.&lt;/p&gt;</comment>
                            <comment id="12974523" author="hudson" created="Thu, 23 Dec 2010 04:31:59 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1697 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/HBase-TRUNK/1697/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/HBase-TRUNK/1697/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="15017240" author="lars_francke" created="Fri, 20 Nov 2015 12:42:24 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12466779" name="3381.txt" size="4740" author="stack" created="Tue, 21 Dec 2010 23:49:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 22 Dec 2010 00:00:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26821</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hm1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100833</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>