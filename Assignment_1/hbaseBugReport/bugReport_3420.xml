<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:10:03 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3420/HBASE-3420.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3420] Handling a big rebalance, we can queue multiple instances of a Close event; messes up state</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3420</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;This is pretty ugly.  In short, on a heavily loaded cluster, we are queuing multiple instances of region close.  They all try to run confusing state.&lt;/p&gt;

&lt;p&gt;Long version:&lt;/p&gt;

&lt;p&gt;I have a messy cluster.  Its 16k regions on 8 servers.  One node has 5k or so regions on it.  Heaps are 1G all around.  My master had OOME&apos;d.  Not sure why but not too worried about it for now.  So, new master comes up and is trying to rebalance the cluster:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-01-05 00:48:07,385 INFO org.apache.hadoop.hbase.master.LoadBalancer: Calculated a load balance in 14ms. Moving 3666 regions off of 6 overloaded servers onto 3 less loaded servers
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The balancer ends up sending many closes to a single overloaded server are taking so long, the close times out in RIT.  We then do this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
              &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; CLOSED:
                LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Region has been CLOSED &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; too &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, &quot;&lt;/span&gt; +
                    &lt;span class=&quot;code-quote&quot;&gt;&quot;retriggering ClosedRegionHandler&quot;&lt;/span&gt;);
                AssignmentManager.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.executorService.submit(
                    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClosedRegionHandler(master, AssignmentManager.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;,
                        regionState.getRegion()));
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We queue a new close (Should we?).&lt;/p&gt;

&lt;p&gt;We time out a few more times (9 times) and each time we queue a new close.&lt;/p&gt;

&lt;p&gt;Eventually the close succeeds, the region gets assigned a new location.&lt;/p&gt;

&lt;p&gt;Then the next close pops off the eventhandler queue.&lt;/p&gt;

&lt;p&gt;Here is the telltale signature of stuff gone amiss:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-01-05 00:52:19,379 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Forcing OFFLINE; was=TestTable,0487405776,1294125523541.b1fa38bb610943e9eadc604babe4d041. state=OPEN, ts=1294188709030
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Notice how state is OPEN when we are forcing offline (It was actually just successfully opened).  We end up assigning same server because plan was still around:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-01-05 00:52:20,705 WARN org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Attempted open of TestTable,0487405776,1294125523541.b1fa38bb610943e9eadc604babe4d041. but already online on &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; server
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But later when plan is cleared, we assign new server and we have dbl-assignment.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12494748">HBASE-3420</key>
            <summary>Handling a big rebalance, we can queue multiple instances of a Close event; messes up state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Jan 2011 17:51:50 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:59 +0000</updated>
                            <resolved>Wed, 5 Jan 2011 21:08:33 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12977884" author="streamy" created="Wed, 5 Jan 2011 17:59:54 +0000"  >&lt;p&gt;Is this the timeout of a CLOSE or an OPEN?  If the master state is CLOSED, that means the region is completely offline and so the next thing is to send an OPEN RPC.&lt;/p&gt;

&lt;p&gt;As I see it, the acknowledgment of an OPEN RPC is the transitioning of the ZK node to OPENING.  That is not happening within the timeout so it makes sense that this times out.  (of course this is not great behavior but is &quot;correct&quot; as it stands now).&lt;/p&gt;

&lt;p&gt;BUT we should deal properly with the sending of multiple OPEN RPCs to different RSs.&lt;/p&gt;

&lt;p&gt;Why the force to offline?  That seems to be at the heart of this problem.  If we do a ClosedRegionHandler and the region is shown as OPEN then we should not modify the region state.&lt;/p&gt;

&lt;p&gt;Perhaps we should not be doing the ClosedRegionHandler on the timeout (which is expected to be called after a ZK node is transitioned to CLOSED).  Instead, we should just retry an assignment but w/o forcing the ZK node to a certain state and ensuring that the region is not already assigned.&lt;/p&gt;</comment>
                            <comment id="12977890" author="stack" created="Wed, 5 Jan 2011 18:10:58 +0000"  >&lt;p&gt;Its timeout of a close.  Here is sequence:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-01-05 00:49:37,670 INFO org.apache.hadoop.hbase.master.HMaster: balance hri=TestTable,0487405776,1294125523541.b1fa38bb610943e9eadc604babe4d041., src=sv2borg181,60020,1294096110452, dest=sv2borg188,60020,1294187735582
2011-01-05 00:49:37,670 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Starting unassignment of region TestTable,0487405776,1294125523541.b1fa38bb610943e9eadc604babe4d041. (offlining)
2011-01-05 00:49:37,671 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Sent CLOSE to serverName=sv2borg181,60020,1294096110452, load=(requests=0, regions=0, usedHeap=0, maxHeap=0) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region TestTable,0487405776,1294125523541.                              b1fa38bb610943e9eadc604babe4d041.
2011-01-05 00:49:38,310 DEBUG org.apache.hadoop.hbase.zookeeper.ZKUtil: master:60000-0x12d3de9e7c60e37 Retrieved 112 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;(s) of data from znode /hbase/unassigned/b1fa38bb610943e9eadc604babe4d041 and set watcher; region=TestTable,0487405776,1294125523541.           b1fa38bb610943e9eadc604babe4d041., server=sv2borg181,60020,1294096110452, state=RS_ZK_REGION_CLOSED
2011-01-05 00:49:38,385 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Handling &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; unassigned node: /hbase/unassigned/b1fa38bb610943e9eadc604babe4d041 (region=TestTable,0487405776,1294125523541.b1fa38bb610943e9eadc604babe4d041., server=sv2borg181,60020,  1294096110452, state=RS_ZK_REGION_CLOSED)
2011-01-05 00:49:38,385 DEBUG org.apache.hadoop.hbase.master.AssignmentManager: Handling transition=RS_ZK_REGION_CLOSED, server=sv2borg181,60020,1294096110452, region=b1fa38bb610943e9eadc604babe4d041
2011-01-05 00:50:12,412 INFO org.apache.hadoop.hbase.master.AssignmentManager: Regions in transition timed out:  TestTable,0487405776,1294125523541.b1fa38bb610943e9eadc604babe4d041. state=CLOSED, ts=1294188578211
2011-01-05 00:50:12,412 INFO org.apache.hadoop.hbase.master.AssignmentManager: Region has been CLOSED &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; too &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, retriggering ClosedRegionHandler
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12977897" author="stack" created="Wed, 5 Jan 2011 18:39:32 +0000"  >&lt;p&gt;Looking more, the CLOSED event had been queued over on the master but tens of seconds elapsed before it had a chance to run (This was a rebalance of thousands of regions on constrained server).  Meantime, we were requeuing CloseRegionHandlers every ten seconds as the CLOSED timeeout in RIT.&lt;/p&gt;

&lt;p&gt;I&apos;m going to post patch that removes the adding new CRH to event queue on timeout of CLOSED.  Either the queued original CRH will run or server will crash and region state will be altered appropriately at that time.&lt;/p&gt;</comment>
                            <comment id="12977904" author="stack" created="Wed, 5 Jan 2011 18:48:23 +0000"  >&lt;p&gt;This should address most egregious issue turned up by these logs.  Other things to add are maximum regions to assign per balance.  We should add that too.  Will make a new issue for that once this goes in.&lt;/p&gt;</comment>
                            <comment id="12977906" author="streamy" created="Wed, 5 Jan 2011 18:53:54 +0000"  >&lt;p&gt;So this just updates the timestamp.  Seems like it would be equivalent to logging and doing a NO-OP on CLOSED timeout (only point of updating timestamp is to prevent another timeout).  I guess this is fine since we will get a log message once per timeout period though.&lt;/p&gt;

&lt;p&gt;So once the CRH runs, the RegionState goes to OFFLINE huh?  Makes sense then.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;and +1 on a maxregionstobalanceatonce or the like&lt;/p&gt;</comment>
                            <comment id="12977909" author="yuzhihong@gmail.com" created="Wed, 5 Jan 2011 19:01:50 +0000"  >&lt;p&gt;hbase.regions.percheckin is no longer in 0.90&lt;br/&gt;
Can we reuse it ?&lt;/p&gt;</comment>
                            <comment id="12977929" author="stack" created="Wed, 5 Jan 2011 19:42:50 +0000"  >&lt;p&gt;@Ted Balancing works differently in 0.90.  Where before, when a RS would heartbeat, in the response we&apos;d give it a set of regions to open/close.  The new region assignment goes via zk.  The balancer looks at total cluster state and comes up w/ a plan.  It then starts the plan rolling which instigates a cascade of closings done via zk.&lt;/p&gt;</comment>
                            <comment id="12977930" author="streamy" created="Wed, 5 Jan 2011 19:44:27 +0000"  >&lt;p&gt;It&apos;s unrelated to the notion of &quot;checkins&quot; (which is almost completely gone now) so not sure why we would reuse this config param.  We could set per-RS limits but that would probably require significantly more hack-up of the balancing algo.&lt;/p&gt;</comment>
                            <comment id="12977968" author="stack" created="Wed, 5 Jan 2011 21:05:22 +0000"  >&lt;p&gt;Ok... with this patch in place, master was able to join the cluster w/o aborting and live through the rebalance (all regions cleared from RIT).  I&apos;m going to commit.&lt;/p&gt;</comment>
                            <comment id="12977969" author="stack" created="Wed, 5 Jan 2011 21:08:33 +0000"  >&lt;p&gt;Committed to branch and trunk.&lt;/p&gt;</comment>
                            <comment id="12977975" author="stack" created="Wed, 5 Jan 2011 21:38:41 +0000"  >&lt;p&gt;Related this issue to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3422&quot; title=&quot;Balancer will try to rebalance thousands of regions in one go; needs an upper bound added.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3422&quot;&gt;&lt;del&gt;HBASE-3422&lt;/del&gt;&lt;/a&gt; &amp;#8211; its the one about rebalancing piecemeal rather in one big lump.&lt;/p&gt;</comment>
                            <comment id="12978156" author="hudson" created="Thu, 6 Jan 2011 06:07:29 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1705 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/HBase-TRUNK/1705/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/HBase-TRUNK/1705/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="15016848" author="lars_francke" created="Fri, 20 Nov 2015 12:40:59 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12494771">HBASE-3422</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12467563" name="3420.txt" size="1278" author="stack" created="Wed, 5 Jan 2011 18:48:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 5 Jan 2011 17:59:54 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26851</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hm7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100861</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>