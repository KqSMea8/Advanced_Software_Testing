<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:13:41 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3852/HBASE-3852.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3852] ThriftServer leaks scanners</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3852</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The scannerMap in ThriftServer relies on the user to clean it by closing the scanner. If that doesn&apos;t happen, the ResultScanner will stay in the thrift server&apos;s memory and if any pre-fetching was done, it will also start accumulating Results (with all their data).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12506128">HBASE-3852</key>
            <summary>ThriftServer leaks scanners</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12655350">HBASE-8818</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 May 2011 03:48:04 +0000</created>
                <updated>Sat, 10 Jan 2015 01:58:31 +0000</updated>
                            <resolved>Sat, 10 Jan 2015 01:58:31 +0000</resolved>
                                    <version>0.90.2</version>
                                                    <component>Thrift</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13028581" author="stack" created="Wed, 4 May 2011 04:18:15 +0000"  >&lt;p&gt;Good one J-D.  How&apos;d you figure it?  Did you restart the thrift server?  Jack would be interested in this one?&lt;/p&gt;</comment>
                            <comment id="13030910" author="posix4e" created="Mon, 9 May 2011 21:34:22 +0000"  >&lt;p&gt;Should we close scanners on disconnect from the thrift server?&lt;/p&gt;</comment>
                            <comment id="13030920" author="jdcryans" created="Mon, 9 May 2011 21:54:53 +0000"  >&lt;p&gt;@Alex, I&apos;m not sure I understand what you&apos;re saying, by &quot;on disconnect&quot; you mean when client is done with the server and closes the socket? How do you know that? And what if the client was scanning but then never comes back?&lt;/p&gt;</comment>
                            <comment id="13030922" author="posix4e" created="Mon, 9 May 2011 21:59:03 +0000"  >&lt;p&gt;Yes, when the client closes the connection to the thrift server. I&apos;m just trying to understand when you think the socket should be cleaned up.&lt;/p&gt;</comment>
                            <comment id="13054006" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 17:59:15 +0000"  >&lt;p&gt;In scannerGetList():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == results) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;TRowResult&amp;gt;();
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Can we close the scanner before returning ?&lt;/p&gt;

&lt;p&gt;We still leave the scanner in scannerMap.&lt;br/&gt;
HTable.ClientScanner would check whether the scanner has been closed.&lt;/p&gt;</comment>
                            <comment id="13054181" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 23:44:48 +0000"  >&lt;p&gt;TestThriftServer passes.&lt;/p&gt;</comment>
                            <comment id="13054544" author="jdcryans" created="Fri, 24 Jun 2011 16:58:29 +0000"  >&lt;p&gt;I&apos;m not sure it fixes the problem, since the issue here is about users not getting back to close even tho there&apos;s still more data. We patched in something at SU that we&apos;ve been running for more than a month, but it is specific to our usecase. Anyways, feel free to inspire yourself with those two commits:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/stumbleupon/hbase/commit/7bcc63ee22f7e0218fb7225f387ffc0bd2279f59#src/main/java/org/apache/hadoop/hbase/thrift/ThriftServer.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/stumbleupon/hbase/commit/7bcc63ee22f7e0218fb7225f387ffc0bd2279f59#src/main/java/org/apache/hadoop/hbase/thrift/ThriftServer.java&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/stumbleupon/hbase/commit/3d08cc8ad5abfec11ee0340d5a75a2b308854e17#src/main/java/org/apache/hadoop/hbase/thrift/ThriftServer.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/stumbleupon/hbase/commit/3d08cc8ad5abfec11ee0340d5a75a2b308854e17#src/main/java/org/apache/hadoop/hbase/thrift/ThriftServer.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13054565" author="yuzhihong@gmail.com" created="Fri, 24 Jun 2011 17:23:15 +0000"  >&lt;p&gt;I was thinking about timeout-driven expiration policy.&lt;br/&gt;
SU&apos;s implementation looks nice. We can introduce a new parameter (sigh) to control whether ScannerCleaner is instantiated at startup.&lt;/p&gt;

&lt;p&gt;@J-D: do you happen to know how many scanners were closed by ScannerCleaner in the past month ?&lt;/p&gt;</comment>
                            <comment id="13054616" author="jdcryans" created="Fri, 24 Jun 2011 18:33:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;do you happen to know how many scanners were closed by ScannerCleaner in the past month ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I used to print that out but it was really spammy. Probably tens of thousands.&lt;/p&gt;</comment>
                            <comment id="13055072" author="yuzhihong@gmail.com" created="Sun, 26 Jun 2011 13:30:51 +0000"  >&lt;p&gt;SU has a solution already.&lt;/p&gt;</comment>
                            <comment id="13092530" author="yuzhihong@gmail.com" created="Sun, 28 Aug 2011 18:37:50 +0000"  >&lt;p&gt;Moving out of 0.92 for now.&lt;/p&gt;</comment>
                            <comment id="13205758" author="bcopeland" created="Fri, 10 Feb 2012 21:13:14 +0000"  >&lt;p&gt;We hit this running thrift2 in production.  With a lot of scanners buffering a lot (100) of rows per call, thrift servers would OOME in no time.  This patch just periodically expires old ones.  I can respin/rework the patch if the approach is sound.&lt;/p&gt;</comment>
                            <comment id="13205805" author="zhihyu@ebaysf.com" created="Fri, 10 Feb 2012 22:19:16 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      timestamp = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We have EnvironmentEdgeManager which provides the above service.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; key: toremove)
+        removeScanner(key);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please use curly braces around the removeScanner() call.&lt;/p&gt;</comment>
                            <comment id="13205827" author="stack" created="Fri, 10 Feb 2012 22:53:08 +0000"  >&lt;p&gt;Patch looks good.  Thanks Bob.  Suggest picking up the coding convention of surrounding class.  Rather than hardcode 60 seconds, maybe use value of hbase.regionserver.lease.period gotten from Configuration instance? &lt;/p&gt;</comment>
                            <comment id="13234506" author="lhofhansl" created="Wed, 21 Mar 2012 17:03:46 +0000"  >&lt;p&gt;Can we commit this? Or should this jira move to 0.96?&lt;/p&gt;</comment>
                            <comment id="13236928" author="lhofhansl" created="Fri, 23 Mar 2012 18:50:46 +0000"  >&lt;p&gt;Let&apos;s try for 0.94.1&lt;/p&gt;</comment>
                            <comment id="13277955" author="lhofhansl" created="Thu, 17 May 2012 16:40:23 +0000"  >&lt;p&gt;In the remove case, should we also close the scanner?&lt;/p&gt;</comment>
                            <comment id="13404542" author="lhofhansl" created="Sat, 30 Jun 2012 16:29:53 +0000"  >&lt;p&gt;Any update on this?&lt;/p&gt;</comment>
                            <comment id="13441717" author="lhofhansl" created="Sat, 25 Aug 2012 01:26:53 +0000"  >&lt;p&gt;Moving on to 0.94.3.&lt;br/&gt;
Also, since we had for quite a while it does not appear to be critical.&lt;/p&gt;</comment>
                            <comment id="13482974" author="lhofhansl" created="Wed, 24 Oct 2012 05:06:34 +0000"  >&lt;p&gt;@J-D: Are you still working on this?&lt;/p&gt;</comment>
                            <comment id="13484715" author="lhofhansl" created="Fri, 26 Oct 2012 05:04:46 +0000"  >&lt;p&gt;And on to 0.94.4&lt;/p&gt;</comment>
                            <comment id="13535694" author="lhofhansl" created="Wed, 19 Dec 2012 06:07:02 +0000"  >&lt;p&gt;And on to 0.94.5&lt;/p&gt;</comment>
                            <comment id="13558526" author="lhofhansl" created="Mon, 21 Jan 2013 04:35:41 +0000"  >&lt;p&gt;This was moved from release to release, with nobody &quot;owning&quot; it.&lt;br/&gt;
I am removing this from 0.94 altogether. Should probably be marked as &quot;Won&apos;t fix&quot; (I wish there was a &quot;Nobody cares&quot; state).&lt;/p&gt;

&lt;p&gt;Pull back in if you disagree.&lt;/p&gt;</comment>
                            <comment id="13650741" author="larsgeorge" created="Tue, 7 May 2013 11:46:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdcryans&quot; class=&quot;user-hover&quot; rel=&quot;jdcryans&quot;&gt;Jean-Daniel Cryans&lt;/a&gt; The two commits you posted a while back are now gone. Is that still worth looking at or should I just go ahead with what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bcopeland&quot; class=&quot;user-hover&quot; rel=&quot;bcopeland&quot;&gt;Bob Copeland&lt;/a&gt; attached (plus the minor tweaks suggested)?&lt;/p&gt;</comment>
                            <comment id="13651125" author="jdcryans" created="Tue, 7 May 2013 18:06:15 +0000"  >&lt;p&gt;Ah yeah, that commit it here now: &lt;a href=&quot;https://github.com/stumbleupon/hbase/commit/985508a185c51b47319541d9d151fcc108a0e590&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/stumbleupon/hbase/commit/985508a185c51b47319541d9d151fcc108a0e590&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s been running in prod for months except that hbase.thrift.scanner.cleaner.timeout was set down to 180000.&lt;/p&gt;

&lt;p&gt;Want me to put it in good shape for review here?&lt;/p&gt;</comment>
                            <comment id="13651778" author="larsgeorge" created="Wed, 8 May 2013 10:48:51 +0000"  >&lt;p&gt;That would be awesome. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdcryans&quot; class=&quot;user-hover&quot; rel=&quot;jdcryans&quot;&gt;Jean-Daniel Cryans&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13652593" author="jdcryans" created="Thu, 9 May 2013 00:38:35 +0000"  >&lt;p&gt;Attaching patch.&lt;/p&gt;

&lt;p&gt;It got a lot messier then I expected but that&apos;s because I forgot that that code relies on the new scanner stuff that we used at SU.&lt;/p&gt;

&lt;p&gt;So kind, of like the thrift2 patch, I use a wrapper for the scanners. This is what you store in the scanner map. When you use it you first remove it from the map and then later you put it back with a new timestamp.&lt;/p&gt;

&lt;p&gt;Removing the scanner from the list has 2 nice properties: we don&apos;t race when scanner the map for timeouts and if you hit this code in scannerGetList:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == results) {
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;TRowResult&amp;gt;();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then the scanner is already removed from the map so the leak there is fixed too.&lt;/p&gt;</comment>
                            <comment id="13702266" author="larsgeorge" created="Mon, 8 Jul 2013 18:45:08 +0000"  >&lt;p&gt;Just ran across this in 0.89-fb:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;commit b5f787b2836ce9750087392a4a3092f9a94f7360
Author: Mikhail Bautin &amp;lt;mbautin@apache.org&amp;gt;
Date:   Tue Aug 28 21:15:39 2012 +0000

    [HBASE-6673] Clear up the scanner in the thrift server whenever these scanners failed to read data
    
    Author: liyintang
    
    Summary:
    We have run into some memory leak problem in the thrift server. It is caused either by the application client never closed the outstanding scanner or the thr
    
    Test Plan: not tested; will tested in dev cluster;
    
    Reviewers: kannan, kranganathan
    
    Reviewed By: kannan
    
    CC: arjen, hbase-eng@, davejwatson
    
    Differential Revision: https://phabricator.fb.com/D541137
    
    git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.89-fb@1378350 13f79535-47bb-0310-9956-ffa450edef68
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should check what FB did there as well.&lt;/p&gt;</comment>
                            <comment id="14272244" author="apurtell" created="Sat, 10 Jan 2015 01:58:31 +0000"  >&lt;p&gt;Reported against now unsupported version 0.90. Closing as Wont Fix.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12655758">HBASE-8852</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12613117">HBASE-7035</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12483651" name="3852.txt" size="559" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 23:44:48 +0000"/>
                            <attachment id="12582397" name="HBASE-3852-0.94.patch" size="10046" author="jdcryans" created="Thu, 9 May 2013 00:38:35 +0000"/>
                            <attachment id="12514156" name="thrift2-scanner.patch" size="3997" author="bcopeland" created="Fri, 10 Feb 2012 21:13:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 4 May 2011 04:18:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27058</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02cpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11661</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>