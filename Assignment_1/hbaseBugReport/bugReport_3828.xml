<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:13:29 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3828/HBASE-3828.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3828] region server stuck in waitOnAllRegionsToClose</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3828</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description></description>
                <environment></environment>
        <key id="12505737">HBASE-3828</key>
            <summary>region server stuck in waitOnAllRegionsToClose</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="4">Incomplete</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="khemani">Prakash Khemani</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Apr 2011 23:31:09 +0000</created>
                <updated>Fri, 7 Sep 2012 03:50:20 +0000</updated>
                            <resolved>Fri, 7 Sep 2012 03:50:20 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13026776" author="khemani" created="Thu, 28 Apr 2011 23:34:10 +0000"  >&lt;p&gt;The regionserver is not able to exit because the rs thread is stuck here&lt;/p&gt;

&lt;p&gt;&quot;regionserver60020&quot; prio=10 tid=0x00002ab2b039e000 nid=0x760a waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x000000004365e000&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.Thread.State: TIMED_WAITING (sleeping)&lt;br/&gt;
at java.lang.Thread.sleep(Native Method)&lt;br/&gt;
at org.apache.hadoop.hbase.util.Threads.sleep(Threads.java:126)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegionServer.waitOnAllRegionsToClose(HRegionServer.java:736)&lt;br/&gt;
at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:689)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;


&lt;p&gt;This has happened a few times in my cluster.&lt;/p&gt;

&lt;p&gt;===&lt;br/&gt;
In OpenRegionHandler&lt;/p&gt;

&lt;p&gt;  @Override&lt;br/&gt;
  public void process() throws IOException {&lt;br/&gt;
    final String name = regionInfo.getRegionNameAsString();&lt;br/&gt;
    LOG.debug(&quot;Processing open of &quot; + name);&lt;br/&gt;
    if (this.server.isStopped() || this.rsServices.isStopping()) &lt;/p&gt;
{
      LOG.info(&quot;Server stopping or stopped, skipping open of &quot; + name);
      return;
    }

&lt;p&gt;Is the above check sufficient to prevent a region from being opened when the rs is stopping/aborting ... no right? A lock.readLock.lock() has to be acquired ... or shouldn&apos;t these guys do a startRegionOperation() as well?&lt;/p&gt;


&lt;p&gt;===&lt;/p&gt;

&lt;p&gt;Also in close region handler there is this code&lt;/p&gt;

&lt;p&gt;    int expectedVersion = FAILED;&lt;br/&gt;
    if (this.zk) &lt;/p&gt;
{
      expectedVersion = setClosingState();
      if (expectedVersion == FAILED) return;
    }

&lt;p&gt;This should remove from onlineRegions() before returning?&lt;/p&gt;</comment>
                            <comment id="13029036" author="stack" created="Wed, 4 May 2011 23:12:35 +0000"  >&lt;p&gt;What you thinking Prakash?  I see that stopped is volatile in HRS but stopping is not.  You think getting a read lock makes sense on open (or startRegionOperation?  The latter seems to be looking at closing flags only... if we&apos;re not open yet, looking at closing flags won&apos;t help?  Or am I reading this wrong?).&lt;/p&gt;

&lt;p&gt;On the failed expectedVersion, yes, I think that makes sense &amp;#8211; but we should probably try and run through the close code anyways w/o updating zk?&lt;/p&gt;</comment>
                            <comment id="13029452" author="khemani" created="Thu, 5 May 2011 17:34:03 +0000"  >&lt;p&gt;In my cluster this turned out to be a problem in code that we had modified internally. In the region server abort code path we had put in a check that if filesystem is unavailable then do not try to close regions. But the main thread anyway went ahead and waited for the regions to close. That was causing the hang in waitOnAllRegionsToClose(). (aside - there is an internal task on this ... when append to HLog fails, hbase relies on dfsclient to close the filesystem for the regionserver abort to be triggered. That is very roundabout and there ought to be more direct and synchronous abort facility)&lt;/p&gt;

&lt;p&gt;==&lt;/p&gt;

&lt;p&gt;It is possible that there is no further synchronization necessary when a region is being opened. But I haven&apos;t looked at the code closely enough. What happens between the time when zk node is closed and the region is actually closed on the rs? When is the region removed fron onlineRegions - is it possible that one thread adds it and the other immediately removes it  ... I will try and spend some time on it this soon.&lt;/p&gt;

&lt;p&gt;===&lt;/p&gt;
</comment>
                            <comment id="13029461" author="stack" created="Thu, 5 May 2011 17:49:07 +0000"  >&lt;p&gt;Just to say that we did have a prob. in the past where an open came in after the RS had started its shutdown holding up its exit.  We thought we&apos;d fixed it though.&lt;/p&gt;

&lt;p&gt;I notice in the master open handler that post open, we&apos;ll do a check if in actuality, the region should be closed; e.g. if the the table was disabled between receipt of the open and its completion on master.  Should we do similiar over in the regionserver open handler; before leaving the handler, check the abort/stopped flag and if set, close the region?&lt;/p&gt;</comment>
                            <comment id="13448964" author="lhofhansl" created="Wed, 5 Sep 2012 18:21:31 +0000"  >&lt;p&gt;I assume with all the recent work this has been fixed.&lt;br/&gt;
@Ram, @Stack: Would you agree with that? If so, we can just close this.&lt;/p&gt;</comment>
                            <comment id="13450316" author="stack" created="Fri, 7 Sep 2012 03:50:20 +0000"  >&lt;p&gt;Resolving as &apos;Incomplete&apos;.  Lets wait till we run into a stuck issue that is other than because of mod&apos;d code.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 4 May 2011 23:12:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27047</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ho3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101166</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>