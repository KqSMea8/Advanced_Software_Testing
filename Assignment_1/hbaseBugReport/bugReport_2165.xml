<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:59:29 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2165/HBASE-2165.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2165] Improve fragmentation display and implementation</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2165</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Improve by &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;moving the &quot;blocking&quot; FS scan into a thread so that the UI loads fast and initially displays &quot;n/a&quot; but once it has completed the scan it displays the proper numbers&lt;/li&gt;
	&lt;li&gt;explaining what fragmentation means to the user (better hints or help text in UI)&lt;/li&gt;
	&lt;li&gt;Switch &lt;del&gt;ROOT&lt;/del&gt; (and maybe even .META.?) to simply say &quot;Yes&quot; or a tick that it is fragmented as it only has 0% or 100% available (since it has only a single region)&lt;/li&gt;
	&lt;li&gt;also computing the space occupied by each table and the total and - if easily done - add a graph to display it (Google Pie Chart would be nice but is an external link)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12446537">HBASE-2165</key>
            <summary>Improve fragmentation display and implementation</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="larsgeorge">Lars George</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Jan 2010 13:35:04 +0000</created>
                <updated>Fri, 20 Nov 2015 13:01:48 +0000</updated>
                            <resolved>Fri, 6 May 2011 17:26:53 +0000</resolved>
                                    <version>0.20.4</version>
                    <version>0.90.0</version>
                                    <fixVersion>0.92.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12805250" author="jdcryans" created="Tue, 26 Jan 2010 22:39:40 +0000"  >&lt;p&gt;I love these ideas.&lt;/p&gt;</comment>
                            <comment id="12829465" author="larsgeorge" created="Thu, 4 Feb 2010 06:04:47 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2181&quot; title=&quot;remove or provide config to completely disable all aspects of &amp;#39;table fragmentation&amp;#39; &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2181&quot;&gt;&lt;del&gt;HBASE-2181&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Given the potentially low and misleading value of the metric, and how much effort must be expended to collect them, I would argue at least we should allow users to disable the feature completely.&lt;br/&gt;
The first problem is the data the metric delivers is not very useful. On any given busy system, this value is often 100%. On a sample system here, 12% of the tables were at either 0 or 100%. Furthermore the 100% metric is not particularly informative. If a table has 100% &apos;fragmentation&apos; it does not necessarily imply that this table is in dire need of compaction. The HBase compaction code will generally keep at least 2 store files around - it refuses to minor compact older and larger files, preferring to merge small files. Thus on a table taking writes on all regions, the expected value of fragmentation is in fact 100%. And this is not a bad thing either. Considering that compacting a 500GB table will take an hour and hammer a cluster, misleading users into striving to get to 0% is non ideal.&lt;/p&gt;

&lt;p&gt;The other major problem of this feature is collecting the data is non-trivial on larger clusters. I did a test where I did a lsr on a hadoop cluster, and to generate 15k lines of output, it pegged the namenode at over 100% cpu for a few seconds. On a cluster with 7000 regions, we can clearly easily have 14,000 (2 store files per region is typical) files thus causing spikes against the namenode to generate this statistic.&lt;/p&gt;

&lt;p&gt;I would propose 3 courses of actions:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;allow complete disablement of the feature, including the background thread and the UI display&lt;/li&gt;
	&lt;li&gt;change the metric to mean &apos;# of regions with &amp;gt; 5 store files&apos;&lt;/li&gt;
	&lt;li&gt;replacing the metric with a completely different one that attempts to capture the spirit of the intent but with less load.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;</comment>
                            <comment id="12829467" author="larsgeorge" created="Thu, 4 Feb 2010 06:07:39 +0000"  >&lt;p&gt;I agree with Ryan&apos;s suggestions in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2181&quot; title=&quot;remove or provide config to completely disable all aspects of &amp;#39;table fragmentation&amp;#39; &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2181&quot;&gt;&lt;del&gt;HBASE-2181&lt;/del&gt;&lt;/a&gt;, so also add&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;feature to switch it off (also hide UI components then)&lt;/li&gt;
	&lt;li&gt;make &quot;# of regions to consider fragmented&quot; a (yet hidden) config value defaulting to 5&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Do you think doing an dfs -lsr /hbase is too resource intensive given we only do it every configured interval and in the background? Could we throttle it?&lt;/p&gt;</comment>
                            <comment id="12829673" author="stack" created="Thu, 4 Feb 2010 18:02:04 +0000"  >&lt;p&gt;I don&apos;t know how to throttle it.   Its a query to NN if IIRC so maybe not too bad.  Should be done rarely though &amp;#8211; every 5 minutes?  Every ten minutes?  Can you check it?  See if under load hbase throughput goes down when full lsr or just browse how this is done in hadoop code to check no big synchronization block or something over on the NN?&lt;/p&gt;

&lt;p&gt;I agree needs more explaination at a minimum.  I&apos;m still not sure what it indicates (Witness Cosmin question up on IRC yesterday).&lt;/p&gt;</comment>
                            <comment id="12830156" author="larsgeorge" created="Fri, 5 Feb 2010 16:33:33 +0000"  >&lt;p&gt;@Stack, I think that is why Ryan posted his new issue (which I closed as dupe and copied here). The idea is to show the experienced (and that may be the crux) user what the tables are up to. I recall being asked how many store files my .META. has and when I said 10 I heard &quot;Why too much! Do compact&quot;. With the UI I am trying to get anyone quick access to this sort of information. As I said, it may not be the best way to do it as a write intense system will always be fragmented. &lt;/p&gt;

&lt;p&gt;Maybe we print not the percentage but number of regions vs. storefiles to get a ratio that could also be used to see how many files (on average then I guess) each table has. The other issue I though is size. I am wondering often how large a table is, not rows but in terms of storage. Sure a smart &quot;hadoop dfs -du /hbase/tablename&quot; or so gives the same. But the UI would be a nice spot to have this sort of info. And if I scan every configurable interval N anyways to see how many storefiles I have then the size is a free info. Also setting that interval to 0 or -1 would disable the whole thing altogether and not worry anyone. Maybe we disable it by default, that way no one wonders what that means and the experienced user can enable it as an advanced feature. As I said above, when this is disabled I would even hide those columns so that there is no constant &quot;n/a&quot; shown. Does this make more sense?&lt;/p&gt;</comment>
                            <comment id="12830349" author="ryanobjc" created="Fri, 5 Feb 2010 22:55:51 +0000"  >&lt;p&gt;my point is that:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;experienced user (me) finds the display pointless as is&lt;/li&gt;
	&lt;li&gt;large clusters means hammering the NN to display a pointless stat...&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We need to up the value of this stat to justify the resources consumed retrieving it, reduce the resources or potentially cut it completely.&lt;/p&gt;</comment>
                            <comment id="12831431" author="larsgeorge" created="Tue, 9 Feb 2010 12:05:05 +0000"  >&lt;p&gt;@ryan, not sure if I understand. As we discussed above, we would query not at all or only every N minutes, and since it hits the NN only it should be fast and not too resource intense as it has it all in RAM I would suppose.&lt;/p&gt;

&lt;p&gt;Also, you are not the target audience, you are not a &quot;user&quot; you are a hbase developer. I am looking at those who use hbase in production but are not involved otherwise. Every bit of information we can give them helps I&apos;d say. And since we do not switch this on by default it is left to those that wish to have the number to further see what their cluster does and its status-quo. &lt;/p&gt;

&lt;p&gt;As I said above the reasoning is that a terribly fragmented cluster is going slower than it should be. Just that rectifies why someone may want to know. It also adds the &quot;size&quot; of tables, something that also is not visible right now to users. How much raw data is stored, that may often be enough they need and no rowcounter run is required.&lt;/p&gt;</comment>
                            <comment id="12835595" author="jdcryans" created="Fri, 19 Feb 2010 05:29:13 +0000"  >&lt;p&gt;Saw an issue with fragmentation today in the web UI, I refreshed it around the same time a region was deleted and FileNotFound was thrown.&lt;/p&gt;</comment>
                            <comment id="12835844" author="larsgeorge" created="Fri, 19 Feb 2010 17:35:55 +0000"  >&lt;p&gt;Thanks JD, noted. The fs scan needs to be guarded for IOExceptions. Will do that when I redo this stuff.&lt;/p&gt;</comment>
                            <comment id="12837713" author="ryanobjc" created="Wed, 24 Feb 2010 09:25:37 +0000"  >&lt;p&gt;I&apos;m not sure its perfectly clear that &apos;more fragmented = slower&apos;.  certainly we should be as fast under 2 store files as 1, since it is nearly impossible on a real cluster to get to 1 store file per region.&lt;/p&gt;

&lt;p&gt;Another issue, is this calculation is done inline with the web hit (contrary to what everyone has told me), jstack says thus:&lt;/p&gt;

&lt;p&gt;&quot;1674385661@qtp0-5&quot; prio=10 tid=0x0000000041f25800 nid=0x419a in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f43b0fe8000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
        at java.lang.Object.wait(Native Method)&lt;br/&gt;
        at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
        at org.apache.hadoop.ipc.Client.call(Client.java:752)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x00007f43c77725f8&amp;gt; (a org.apache.hadoop.ipc.Client$Call)&lt;br/&gt;
        at org.apache.hadoop.ipc.RPC$Invoker.invoke(RPC.java:223)&lt;br/&gt;
        at $Proxy0.getListing(Unknown Source)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor9.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:82)&lt;br/&gt;
        at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:59)&lt;br/&gt;
        at $Proxy0.getListing(Unknown Source)&lt;br/&gt;
        at org.apache.hadoop.hdfs.DFSClient.listPaths(DFSClient.java:709)&lt;br/&gt;
        at org.apache.hadoop.hdfs.DistributedFileSystem.listStatus(DistributedFileSystem.java:289)&lt;br/&gt;
        at org.apache.hadoop.hbase.util.FSUtils.getTableFragmentation(FSUtils.java:441)&lt;br/&gt;
        at org.apache.hadoop.hbase.util.FSUtils.getTableFragmentation(FSUtils.java:395)&lt;br/&gt;
        at org.apache.hadoop.hbase.master.HMaster.getTableFragmentation(HMaster.java:1265)&lt;br/&gt;
        at org.apache.hadoop.hbase.generated.master.master_jsp._jspService(master_jsp.java:69)&lt;br/&gt;
        at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:97)&lt;br/&gt;
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:820)&lt;br/&gt;
        at org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:502)&lt;br/&gt;
        at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1124)&lt;br/&gt;
        at org.apache.hadoop.http.HttpServer$QuotingInputFilter.doFilter(HttpServer.java:667)&lt;br/&gt;
        at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1115)&lt;br/&gt;
        at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:361)&lt;br/&gt;
        at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)&lt;br/&gt;
        at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)&lt;br/&gt;
        at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)&lt;br/&gt;
        at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:417)&lt;br/&gt;
        at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:230)&lt;br/&gt;
        at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)&lt;br/&gt;
        at org.mortbay.jetty.Server.handle(Server.java:324)&lt;br/&gt;
        at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:534)&lt;br/&gt;
        at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:864)&lt;br/&gt;
        at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:533)&lt;br/&gt;
        at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:207)&lt;br/&gt;
        at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:403)&lt;br/&gt;
        at org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:409)&lt;br/&gt;
        at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:522)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12837762" author="larsgeorge" created="Wed, 24 Feb 2010 12:46:20 +0000"  >&lt;p&gt;@ryan: this jira issue is about to improve on that fact.&lt;/p&gt;</comment>
                            <comment id="12854731" author="stack" created="Wed, 7 Apr 2010 23:40:04 +0000"  >&lt;p&gt;Lets remove fragmentation for 0.20.4 release.  I&apos;ll make a new issue and move this out to 0.20.5.&lt;/p&gt;</comment>
                            <comment id="12855216" author="ryanobjc" created="Fri, 9 Apr 2010 00:01:49 +0000"  >&lt;p&gt;PS: I disabled this in SU&apos;s internal build for trunk because it makes the master UI impossible to use on a larger cluster. &lt;/p&gt;</comment>
                            <comment id="12857041" author="larsgeorge" created="Wed, 14 Apr 2010 19:22:50 +0000"  >&lt;p&gt;Hmm, this was a full reversal, bummer I did not know you were that &quot;desperate&quot;. The changes also included values that were added to the RegionServerMetrics and provided information about the compaction queues - which was fast and could have stayed (also see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2143&quot; title=&quot;Add compaction details into HMaster metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2143&quot;&gt;&lt;del&gt;HBASE-2143&lt;/del&gt;&lt;/a&gt;). In fact only the JSP&apos;s should have been edited because they trigger the slow DFS scan synchronously. &lt;/p&gt;

&lt;p&gt;I removed the whole target for 0.20 as no one is really interested in this by the looks and leave the 0.21.0 target as I may fix this all up there once and for all.&lt;/p&gt;</comment>
                            <comment id="12867000" author="stack" created="Thu, 13 May 2010 04:41:35 +0000"  >&lt;p&gt;Moved from 0.21 to 0.22 just after merge of old 0.20 branch into TRUNK.&lt;/p&gt;</comment>
                            <comment id="13030046" author="stack" created="Fri, 6 May 2011 17:26:53 +0000"  >&lt;p&gt;We don&apos;t have this attribute any more.  Resolving issue till it comes back.&lt;/p&gt;</comment>
                            <comment id="15017897" author="lars_francke" created="Fri, 20 Nov 2015 13:01:48 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12461473">HBASE-2422</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12461596">HBASE-2430</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 26 Jan 2010 22:39:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32435</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09wnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>55733</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>