<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:12:06 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3668/HBASE-3668.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3668] CatalogTracker.waitForMeta can wait forever and totally stall a RS</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3668</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We got into a weird situation after hitting &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3664&quot; title=&quot;[replication] Adding a slave when there&amp;#39;s none may kill the cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3664&quot;&gt;&lt;del&gt;HBASE-3664&lt;/del&gt;&lt;/a&gt; leaving almost half the region servers unable to open regions (we didn&apos;t kill the master but all RS were restarted).&lt;/p&gt;

&lt;p&gt;Here&apos;s the relevant jstack from the region servers:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

&lt;span class=&quot;code-quote&quot;&gt;&quot;regionserver60020-EventThread&quot;&lt;/span&gt; daemon prio=10 tid=0x0000000041297800 nid=0x5c5 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007fbd2b7f6000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (on object monitor)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
	- waiting on &amp;lt;0x00007fbd4e1ac6d0&amp;gt; (a java.util.concurrent.atomic.AtomicBoolean)
	at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMeta(CatalogTracker.java:328)
	- locked &amp;lt;0x00007fbd4e1ac6d0&amp;gt; (a java.util.concurrent.atomic.AtomicBoolean)
	at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMetaServerConnectionDefault(CatalogTracker.java:363)
	at org.apache.hadoop.hbase.zookeeper.MetaNodeTracker.nodeDeleted(MetaNodeTracker.java:64)
	at org.apache.hadoop.hbase.zookeeper.ZooKeeperNodeTracker.nodeCreated(ZooKeeperNodeTracker.java:154)
	- locked &amp;lt;0x00007fbd4d7ab060&amp;gt; (a org.apache.hadoop.hbase.zookeeper.MetaNodeTracker)
	at org.apache.hadoop.hbase.zookeeper.ZooKeeperNodeTracker.nodeDataChanged(ZooKeeperNodeTracker.java:179)
	- locked &amp;lt;0x00007fbd4d7ab060&amp;gt; (a org.apache.hadoop.hbase.zookeeper.MetaNodeTracker)
	at org.apache.hadoop.hbase.zookeeper.ZooKeeperWatcher.process(ZooKeeperWatcher.java:268)
	at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:530)
	at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:506)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Every server in that state cannot receive any ZK event. See how we first do a nodeDataChanged, then nodeCreated, then nodeDeleted. This is correlated in the logs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-03-17 17:57:03,636 DEBUG org.apache.hadoop.hbase.zookeeper.ZooKeeperWatcher: regionserver:60020-0x12d627b723e081f Received ZooKeeper Event, type=NodeDataChanged, state=SyncConnected, path=/hbase/unassigned/1028785192
2011-03-17 17:57:03,636 DEBUG org.apache.hadoop.hbase.zookeeper.ZKUtil: regionserver:60020-0x12d627b723e081f Unable to get data of znode /hbase/unassigned/1028785192 because node does not exist (not an error)
2011-03-17 17:57:03,637 DEBUG org.apache.hadoop.hbase.zookeeper.ZKUtil: regionserver:60020-0x12d627b723e081f Set watcher on existing znode /hbase/unassigned/1028785192
2011-03-17 17:57:03,637 INFO org.apache.hadoop.hbase.zookeeper.MetaNodeTracker: Detected completed assignment of META, notifying catalog tracker
2011-03-17 17:57:06,988 DEBUG org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation: Lookedup root region location, connection=org.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Node is updated, then is missing, than came back! The reason we&apos;re stuck is that CT.waitForMeta will wait forever:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getMetaServerConnection(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; metaLocation;
      }
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(!stopped &amp;amp;&amp;amp; !metaAvailable.get() &amp;amp;&amp;amp;
          (timeout == 0 || &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() &amp;lt; stop)) {
        metaAvailable.wait(timeout);
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So when it tried getMetaServerConnection the first time it didn&apos;t work, and then since the timeout is 0 then it waits. Even if it was looping, metaAvailable will never be true since we&apos;re already inside the event thread thus blocking any other event!&lt;/p&gt;

&lt;p&gt;This is what happens when the RS then tries to update .META. after opening a region:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-03-17 17:59:06,557 DEBUG org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Interrupting thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[PostOpenDeployTasks:f06b630822a161d0a8fe37481d851d05,5,main]
2011-03-17 17:59:06,557 WARN org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Exception running postOpenDeployTasks; region=f06b630822a161d0a8fe37481d851d05
org.apache.hadoop.hbase.NotAllMetaRegionsOnlineException: Interrupted
        at org.apache.hadoop.hbase.catalog.CatalogTracker.waitForMetaServerConnectionDefault(CatalogTracker.java:365)
        at org.apache.hadoop.hbase.catalog.MetaEditor.updateRegionLocation(MetaEditor.java:142)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.postOpenDeployTasks(HRegionServer.java:1359)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The master eventually tries to assign the region somewhere else where it may work, but then the balancer will screw everything up again.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12501739">HBASE-3668</key>
            <summary>CatalogTracker.waitForMeta can wait forever and totally stall a RS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Mar 2011 21:57:05 +0000</created>
                <updated>Fri, 20 Nov 2015 12:44:04 +0000</updated>
                            <resolved>Tue, 22 Mar 2011 23:52:54 +0000</resolved>
                                    <version>0.90.1</version>
                                    <fixVersion>0.90.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13008518" author="yuzhihong@gmail.com" created="Fri, 18 Mar 2011 17:09:12 +0000"  >&lt;p&gt;@J-D: Can you post more log after this line ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-03-17 17:57:06,988 DEBUG org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation: Lookedup root region location, connection=org.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also noticed that refresh passed to getMetaServerConnection() is always true. We may remove parameter refresh.&lt;/p&gt;</comment>
                            <comment id="13008581" author="jdcryans" created="Fri, 18 Mar 2011 19:04:02 +0000"  >&lt;p&gt;@Ted &lt;br/&gt;
Those lines are coming from ReplicationSink which is using a HTable so you see stuff like that being printed out. I should have left that line out as it&apos;s irrelevant.&lt;/p&gt;</comment>
                            <comment id="13008613" author="jdcryans" created="Fri, 18 Mar 2011 20:18:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;The master eventually tries to assign the region somewhere else where it may work, but then the balancer will screw everything up again.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What I meant by that is that the cluster was able to reach a &quot;stable&quot; state when the defective region servers we finally stripped out of every region they were assigned, but then the balancer tries to even the distribution so the cycle repeats. In essence, the balancer isn&apos;t doing anything wrong... it couldn&apos;t know that those RS were in a bad state.&lt;/p&gt;</comment>
                            <comment id="13008619" author="yuzhihong@gmail.com" created="Fri, 18 Mar 2011 20:33:03 +0000"  >&lt;p&gt;Were the defective region servers online ?&lt;br/&gt;
Master would distribute regions to every online server.&lt;/p&gt;</comment>
                            <comment id="13008623" author="yuzhihong@gmail.com" created="Fri, 18 Mar 2011 20:51:30 +0000"  >&lt;p&gt;In OpenRegionHandler, line 94:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    region = openRegion();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (region == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think we need a mechanism for OpenRegionHandler to convey the fact that every region failed openning to region server which in turn informs master.&lt;/p&gt;</comment>
                            <comment id="13008624" author="jdcryans" created="Fri, 18 Mar 2011 20:52:07 +0000"  >&lt;p&gt;@Ted&lt;/p&gt;

&lt;p&gt;I understand that the bug report has a lot of information, but it does answer those questions. Yes, the region servers were online. Yes, they got regions. But, as I showed, they were unable to update .META. and eventually failed on NotAllMetaRegionsOnlineException. Thus, the master saw the RIT timeout and then reassigned the regions, which may go back to a weird region server or not. Eventually they are all opened, but then the balancer runs again. Lather, rinse, repeat.&lt;/p&gt;</comment>
                            <comment id="13009501" author="jdcryans" created="Tue, 22 Mar 2011 01:17:50 +0000"  >&lt;p&gt;This patches puts the checking of meta location inside the loop instead of outside of it, this way if you&apos;re in the thread that comes from ZK then you won&apos;t be waiting on yourself.&lt;/p&gt;</comment>
                            <comment id="13009863" author="stack" created="Tue, 22 Mar 2011 21:58:07 +0000"  >&lt;p&gt;Can you do something about the metaAvailable.wait where timeout == 0?&lt;/p&gt;</comment>
                            <comment id="13009864" author="jdcryans" created="Tue, 22 Mar 2011 22:02:16 +0000"  >&lt;p&gt;Will commit with metaAvailable.wait(timeout == 0 ? 50 : timeout);&lt;/p&gt;</comment>
                            <comment id="13009909" author="jdcryans" created="Tue, 22 Mar 2011 23:52:54 +0000"  >&lt;p&gt;Committed to branch and trunk, thanks for looking at it Stack.&lt;/p&gt;</comment>
                            <comment id="13009954" author="hudson" created="Wed, 23 Mar 2011 01:44:11 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1803 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/HBase-TRUNK/1803/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/HBase-TRUNK/1803/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3668&quot; title=&quot;CatalogTracker.waitForMeta can wait forever and totally stall a RS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3668&quot;&gt;&lt;del&gt;HBASE-3668&lt;/del&gt;&lt;/a&gt;  CatalogTracker.waitForMeta can wait forever and totally stall a RS&lt;/p&gt;</comment>
                            <comment id="15017699" author="lars_francke" created="Fri, 20 Nov 2015 12:44:04 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12474255" name="HBASE-3668.patch" size="910" author="jdcryans" created="Tue, 22 Mar 2011 01:17:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 18 Mar 2011 17:09:12 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26972</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hnav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101037</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>