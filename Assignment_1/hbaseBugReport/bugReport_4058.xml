<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:15:31 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4058/HBASE-4058.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4058] Extend TestHBaseFsck with a complete .META. recovery scenario</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4058</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We should have a unit test that launches a minicluster and constructs a few tables, then deletes META files on disk, then bounces the master, then recovers the result with HBCK. Perhaps it is possible to extend TestHBaseFsck to do this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12512658">HBASE-4058</key>
            <summary>Extend TestHBaseFsck with a complete .META. recovery scenario</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Sun, 3 Jul 2011 07:24:42 +0000</created>
                <updated>Fri, 12 Oct 2012 05:35:02 +0000</updated>
                            <resolved>Wed, 21 Mar 2012 18:58:28 +0000</resolved>
                                                    <fixVersion>0.94.0</fixVersion>
                                    <component>hbck</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13062138" author="stack" created="Fri, 8 Jul 2011 19:55:40 +0000"  >&lt;p&gt;Here is the thread that prompted this issue: &lt;a href=&quot;http://search-hadoop.com/m/J27Y72CrGiD/%2522hbck+-fix%2522&amp;amp;subj=hbck+fix&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://search-hadoop.com/m/J27Y72CrGiD/%2522hbck+-fix%2522&amp;amp;subj=hbck+fix&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So, one though I had was rebuilding .META. from a scan of .META. with a timestamp behind the catastrophe.  This is not going to be bullet-proof for the case where the .META. storefiles themselves have been damaged or lost.&lt;/p&gt;

&lt;p&gt;So, we need a new add_table type fixup.  Wayne in the thread describes it as:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Bugs and human error will bring on problems and nothing will&lt;br/&gt;
ever change that, but not having tools to help recover out of the hole is&lt;br/&gt;
where I think it is lacking...The hbase .META. table&lt;br/&gt;
(and &lt;del&gt;ROOT&lt;/del&gt;?) are the core how HBase manages things. If this gets out of&lt;br/&gt;
whack all is lost...Something like a recovery mode that goes through and&lt;br/&gt;
sees what is out there and rebuilds the meta based on it. With corrupted&lt;br/&gt;
data and lost regions etc. etc. like any relational database there should be&lt;br/&gt;
one or more recovery modes that goes through everything and rebuilds it&lt;br/&gt;
consistently. Data may be lost but at least the cluster will be left in a&lt;br/&gt;
100% consistent/clean state. Manual editing of .META. is not something&lt;br/&gt;
anyone should do (especially me). It is prone to human error...it should be&lt;br/&gt;
easy to have well tested recover tools that can do the hard work for us.&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13062170" author="stack" created="Fri, 8 Jul 2011 20:45:50 +0000"  >&lt;p&gt;So, reading Wayne&apos;s blow-by-blow, he &apos;fix&apos; his hdfs, he ran &apos;fsck -move&apos; which moves corrupt files to /lost+found.  I wonder how many of the 65 corrupt files found were from hbase and how many of these were from under .META. (65 corrupt files and 173 missing blocks.... thats a lot of &apos;missing&apos; data).  Assuming an extreme, that there missing blocks in .META., this would imply we need to be able to rebuild .META. by reading the filesystem content.  It should be able to figure whats a daughter from whats a parent and it should write the .META. without overlaps and with holes plugged.  Finally it should make some sort of report on the type of surgery effected listing put-aside regions that it could not make sense of.&lt;/p&gt;

&lt;p&gt;We currently don&apos;t have such a tool.&lt;/p&gt;</comment>
                            <comment id="13062197" author="stack" created="Fri, 8 Jul 2011 21:32:24 +0000"  >&lt;p&gt;I took a look at the logs Wayne posted.  The master shows a few regionservers losing their leases and its having trouble connecting to a particular server.  The regionserver snippet posted shows a regionserver aborting because it can&apos;t roll its wal log. It gets an EOFE.  The datanode snippet shows connection refused trying to connect to the same server (130) that the master is trying to contact (NN?).&lt;/p&gt;

&lt;p&gt;Its hard to tell much from snippets posted.&lt;/p&gt;</comment>
                            <comment id="13062215" author="stack" created="Fri, 8 Jul 2011 21:58:47 +0000"  >&lt;p&gt;Dan Harvey who is still on 0.20.x had a similar issue this month.  He added four new servers to his cluster.  These new servers were not resolving properly.  What we were seeing is that on startup, I believe, these new servers would be assigned their portion of the regions on checkin.  Then, the basescanner would run &amp;#8211; its 0.20.x hbase &amp;#8211; and it would not recognize the address the new servers were writing .META. and it would then think the regions unassigned and would assign them elsewhere.  So, we have double-assignment and at same time there was splitting and compactions running.  His .META. had holes and overlaps.&lt;/p&gt;

&lt;p&gt;In his case, not all tables were honked.  Just the big ones.  I wonder if an improved add_table.rb would work in this case; i.e. do the same rewrite of the .META. content for a single table based off the content in the filesystem rather than trying fix up on .META. table.&lt;/p&gt;

&lt;p&gt;Let me try adding add_table.rb to hbck.  Let me add option of running per table and then a global, restore all tables.&lt;/p&gt;

&lt;p&gt;Dan sent me the .META. dir content.  It looks like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-rw-r--r--@ 1 Stack  staff         0 Jul  7 08:26 281906331022358506
-rw-r--r--@ 1 Stack  staff  94283152 Jul  7 08:26 5233066973300534672
-rw-r--r--@ 1 Stack  staff         0 Jul  7 08:26 6803125877105432645
-rw-r--r--@ 1 Stack  staff         0 Jul  7 08:26 8650632001596730954
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;i.e. three zero-length files.  I wonder how these were written (I asked him for a dir listing from actual cluster).&lt;/p&gt;</comment>
                            <comment id="13062317" author="stack" created="Sat, 9 Jul 2011 04:26:27 +0000"  >&lt;p&gt;So I see our fixup tool first running an evaluation on the state of meta and then it would offer admin choices.  For overlapping regions, we should make it so hbck will run online merge of the regions that span the broken key area.  If holes, offer to plug the hole.  We should also offer the option to rebuild from the fs per table or all under hbase.rootdir.&lt;/p&gt;</comment>
                            <comment id="13071498" author="yuzhihong@gmail.com" created="Wed, 27 Jul 2011 03:25:22 +0000"  >&lt;p&gt;Moving to 0.94 since there is no owner for this issue at the moment.&lt;/p&gt;</comment>
                            <comment id="13071506" author="stack" created="Wed, 27 Jul 2011 04:26:00 +0000"  >&lt;p&gt;Assigning myself. This is pretty critical one.  The online merges I just added back to 0.92 is prereq for this one.&lt;/p&gt;</comment>
                            <comment id="13234849" author="lhofhansl" created="Wed, 21 Mar 2012 18:49:25 +0000"  >&lt;p&gt;@Stack: Are you still planning this for 0.94?&lt;/p&gt;</comment>
                            <comment id="13234861" author="stack" created="Wed, 21 Mar 2012 18:58:28 +0000"  >&lt;p&gt;This issue subsumed by Jon&apos;s work on uber-hbck.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12521085">HBASE-4321</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12522826">HBASE-4377</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 8 Jul 2011 19:55:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33348</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08r07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>48975</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>