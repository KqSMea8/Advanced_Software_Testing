<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:57:45 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1956/HBASE-1956.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1956] Export HDFS read and write latency as a metric</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1956</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;HDFS write latency spikes especially are an indicator of general cluster overloading. We see this where the WAL writer complains about writes taking &amp;gt; 1 second, sometimes &amp;gt; 4, etc.  If for example the average write latency over the monitoring period is exported as a metric, then this can feed into alerting for or automatic provisioning of additional cluster hardware. While we&apos;re at it, export read side metrics as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12439926">HBASE-1956</key>
            <summary>Export HDFS read and write latency as a metric</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apurtell">Andrew Purtell</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Nov 2009 09:14:50 +0000</created>
                <updated>Fri, 20 Nov 2015 13:01:29 +0000</updated>
                            <resolved>Wed, 3 Nov 2010 01:10:08 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12774010" author="eli" created="Thu, 5 Nov 2009 18:05:35 +0000"  >&lt;p&gt;+1 &lt;/p&gt;

&lt;p&gt;By the way I&apos;ve found monitoring await in Ganglia useful, and have seen over 1000ms average waits on a busy large cluster, having both the host await and a similar dfsmetric would be useful for debugging.&lt;/p&gt;</comment>
                            <comment id="12774030" author="jdcryans" created="Thu, 5 Nov 2009 18:54:13 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12774059" author="eli" created="Thu, 5 Nov 2009 20:17:06 +0000"  >&lt;p&gt;Forgot to ask, are you proposing HDFS expose a write latency as a dfs metric, that&apos;s what I was assuming, if so we should re-categorize this under HDFS or file a separate jira. &lt;/p&gt;</comment>
                            <comment id="12774066" author="stack" created="Thu, 5 Nov 2009 20:36:21 +0000"  >&lt;p&gt;@Eli: My guess is that this would be an hbase metric.  We measure the time an append to our WAL file takes.  If &amp;gt; a second, we recently started logging it as the canary for pending hdfs issues.  I&apos;m guessing Andrew is suggesting we add this to our list of hbase metrics.&lt;/p&gt;</comment>
                            <comment id="12774184" author="apurtell" created="Fri, 6 Nov 2009 02:11:13 +0000"  >&lt;p&gt;Yes, metrics from the HBase DFS client. No dependencies on HDFS timetable or release schedule, please.&lt;/p&gt;</comment>
                            <comment id="12774448" author="stack" created="Fri, 6 Nov 2009 22:18:38 +0000"  >&lt;p&gt;Moving out of 0.20.2.  Its a new feature so shouldn&apos;t really get in way of release.  I&apos;ll put it in new 0.20.3 bucket.&lt;/p&gt;</comment>
                            <comment id="12774539" author="eli" created="Sat, 7 Nov 2009 02:33:31 +0000"  >&lt;p&gt;I double checked and there&apos;s already a dfs metric (writeBlockOp_avg_time) that you could use to monitor write latency.&lt;/p&gt;</comment>
                            <comment id="12774541" author="apurtell" created="Sat, 7 Nov 2009 03:25:17 +0000"  >&lt;p&gt;@Eli: Yes but that is a datanode server side metric. This is not exactly the latency experienced by the client.&lt;/p&gt;</comment>
                            <comment id="12795411" author="jdcryans" created="Wed, 30 Dec 2009 19:45:32 +0000"  >&lt;p&gt;Are you working on this for 0.20.3 Andrew?&lt;/p&gt;</comment>
                            <comment id="12795423" author="apurtell" created="Wed, 30 Dec 2009 20:06:07 +0000"  >&lt;p&gt;Yes. I haven&apos;t gotten to it yet. Will work on it today at some point...&lt;/p&gt;</comment>
                            <comment id="12795522" author="apurtell" created="Thu, 31 Dec 2009 03:06:02 +0000"  >&lt;p&gt;I tried a couple of options. The attached patch is the least invasive. Will commit unless voted down.&lt;/p&gt;</comment>
                            <comment id="12795531" author="stack" created="Thu, 31 Dec 2009 03:29:30 +0000"  >&lt;p&gt;Looks fine Andrew.  I&apos;d be just a little worried about all those System.currentTimeMillis calls.  They add up and are inline with the write.&lt;/p&gt;

&lt;p&gt;Do you think we need to do metrics on hfile as well as hlog?  Would hlog writes be sufficient canary-in-the-mine indicator that hdfs is slow?&lt;/p&gt;

&lt;p&gt;Good stuff.&lt;/p&gt;</comment>
                            <comment id="12795536" author="apurtell" created="Thu, 31 Dec 2009 04:43:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do you think we need to do metrics on hfile as well as hlog? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It depends on what kind of coverage we want these metrics to have.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Would hlog writes be sufficient canary-in-the-mine indicator that hdfs is slow?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, for writes.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;d be just a little worried about all those System.currentTimeMillis calls.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t disagree. &lt;/p&gt;

&lt;p&gt;On HFile read path, only the block read is timed. &lt;/p&gt;

&lt;p&gt;As to the overhead of the call itself, in the OpenJDK source this is a call to gettimeofday through the JNI. On modern Linux systems, this is a read out of a page mapped into high address space as a direct memory access, not a syscall. &lt;/p&gt;

&lt;p&gt;On the write side, could only time the writes of an end of block marker?&lt;/p&gt;</comment>
                            <comment id="12795537" author="apurtell" created="Thu, 31 Dec 2009 04:54:16 +0000"  >&lt;p&gt;Updated patch is about as minimal as it gets. Times HLog sync and write times. Times HFile block reads and only end of block writes. &lt;/p&gt;</comment>
                            <comment id="12795538" author="stack" created="Thu, 31 Dec 2009 05:07:58 +0000"  >&lt;p&gt;Ok.  +1.  Thanks Andy.&lt;/p&gt;</comment>
                            <comment id="12795540" author="apurtell" created="Thu, 31 Dec 2009 05:20:01 +0000"  >&lt;p&gt;Committed to trunk and 0.20 branch.&lt;/p&gt;</comment>
                            <comment id="12828852" author="ryanobjc" created="Wed, 3 Feb 2010 00:07:45 +0000"  >&lt;p&gt;I&apos;m using the file context and I don&apos;t seem to get the count reset. So the average is over all time, not on a heartbeat interval (10s in the config).&lt;/p&gt;

&lt;p&gt;Is this expected?&lt;/p&gt;

&lt;p&gt;According to docs on the &apos;net about volatile, it is not atomic, so maybe im always seeing a race condition and the counter is never reset.&lt;/p&gt;</comment>
                            <comment id="12834591" author="apurtell" created="Wed, 17 Feb 2010 01:32:13 +0000"  >&lt;p&gt;Average over all time is not correct&lt;/p&gt;</comment>
                            <comment id="12846299" author="stack" created="Wed, 17 Mar 2010 05:04:26 +0000"  >&lt;p&gt;Move out of the release 0.20.3 and into 0.20.4.&lt;/p&gt;</comment>
                            <comment id="12866863" author="stack" created="Wed, 12 May 2010 23:52:40 +0000"  >&lt;p&gt;Marking these as fixed against 0.21.0 rather than against 0.20.5.&lt;/p&gt;</comment>
                            <comment id="12918228" author="streamy" created="Tue, 5 Oct 2010 21:43:40 +0000"  >&lt;p&gt;Andy, this going to be done for 0.90 or should we punt to 0.92?&lt;/p&gt;</comment>
                            <comment id="12920044" author="nspiegelberg" created="Tue, 12 Oct 2010 01:08:40 +0000"  >&lt;p&gt;Is there a reason why MetricsTimeVaryingRate is incremented on the MetricsContext polling period instead of every operation?  This results in our min/max data being the maximum of all polling period aggregates seen so far instead of the maximum operation.  I understand that our write/sync metrics will not be consistent due to group commit, but we still want to observe edge case behavior, correct?&lt;/p&gt;</comment>
                            <comment id="12927237" author="ghelmling" created="Tue, 2 Nov 2010 00:37:54 +0000"  >&lt;p&gt;I believe the reason for incrementing counters in HFile and HLog and then just incrementing with totals for the polling period in RegionServerMetrics.doUpdates() was to avoid contention on the synchronized MetricsTimeVaryingRate.inc() call in the critical read and write paths.  Seems like it would be worth doing some profiling on these in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3129&quot; title=&quot;Fix Min/Avg/Max Values for FS Latency Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3129&quot;&gt;&lt;del&gt;HBASE-3129&lt;/del&gt;&lt;/a&gt; to see what the cost would actually be to call MetricsTimeVaryingRate.inc() per operation instead.&lt;/p&gt;

&lt;p&gt;But this definitely makes the FS metrics less useful as a result and squashes the real outliers.&lt;/p&gt;

&lt;p&gt;In any case, the bug that omitted fsSyncLatency from the min/max value reset was fixed with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3102&quot; title=&quot;Enhance HBase rMetrics for Long-running Stats&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3102&quot;&gt;&lt;del&gt;HBASE-3102&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3129&quot; title=&quot;Fix Min/Avg/Max Values for FS Latency Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3129&quot;&gt;&lt;del&gt;HBASE-3129&lt;/del&gt;&lt;/a&gt; addresses improving the min/max values reported, so I think we can close this issue again.&lt;/p&gt;</comment>
                            <comment id="12927240" author="ghelmling" created="Tue, 2 Nov 2010 00:43:56 +0000"  >&lt;p&gt;Sorry, strike that last comment on resets, I should pay more attention.  Yes, since these values are being incremented in separate counters, we are keeping the same values for all time.  We need to reset the HFile and HLog counters when RegionServerMetrics.resetAllMinMax() is called, to at least separate the average values for each polling period.&lt;/p&gt;</comment>
                            <comment id="12927243" author="ghelmling" created="Tue, 2 Nov 2010 00:57:52 +0000"  >&lt;p&gt;Correction #2:  both HFile and HLog reset the static counter variables in the corresponding get* methods.  As I mentioned above the &quot;fsSyncLatency&quot; metric was not being reset at the end of the metrics context period.  So the fsSyncLatency min/max values would have been carrying through regardless.  But if the other metrics (fsReadLatency, fsWriteLatency) were showing increasing counts, that would indicate a race in re-assigning the metric counters.&lt;/p&gt;</comment>
                            <comment id="12927678" author="ghelmling" created="Tue, 2 Nov 2010 23:39:24 +0000"  >&lt;p&gt;After confusing myself yesterday, I did some testing up on EC2 with YCSB to see if I could trigger a race condition causing the HFile and HLog counters to not be reset.  In my testing at least, either no race occurred or it wasn&apos;t frequent enough to be noticeable.  The counters were reset correctly on each call to RegionServerMetrics.doUpdates().&lt;/p&gt;

&lt;p&gt;However, the &quot;&lt;b&gt;&lt;em&gt;num_ops&quot; metrics _do&lt;/em&gt; continuously increment, but that is just the way that MetricsTimeVaryingRate works.  The number of operations is incremented by the new value for each polling period.  Same with the other MetricsTimeVarying&lt;/b&gt; classes.&lt;/p&gt;

&lt;p&gt;In addition, the RegionServerMetrics.resetAllMinMax() method is never called by anything in the Hadoop metrics update process (ie. MetricsContext implementations).  So the min and max values show will be for all time (though the min/max &lt;em&gt;average&lt;/em&gt; for a polling period, not individual data points as Nicolas points out).  You can manually invoke resetAllMinMax() periodically using JMX, but nothing in Hadoop metrics automatically will do it for you.  That&apos;s just a limitation in how it works.&lt;/p&gt;

&lt;p&gt;So from testing everything seems to be working correctly.  We already have &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3129&quot; title=&quot;Fix Min/Avg/Max Values for FS Latency Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3129&quot;&gt;&lt;del&gt;HBASE-3129&lt;/del&gt;&lt;/a&gt; to address improving the min/max values.  If we want to add some configurable reset period for those, I&apos;d suggest we do so there.&lt;/p&gt;

&lt;p&gt;So let&apos;s close this one out.&lt;/p&gt;</comment>
                            <comment id="12927703" author="apurtell" created="Wed, 3 Nov 2010 00:44:15 +0000"  >&lt;p&gt;+1 on close&lt;/p&gt;</comment>
                            <comment id="12927704" author="ryanobjc" created="Wed, 3 Nov 2010 00:54:47 +0000"  >&lt;p&gt;also +1 on close&lt;/p&gt;</comment>
                            <comment id="12927708" author="ghelmling" created="Wed, 3 Nov 2010 01:10:08 +0000"  >&lt;p&gt;Re-resolving on consensus.  &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3102&quot; title=&quot;Enhance HBase rMetrics for Long-running Stats&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3102&quot;&gt;&lt;del&gt;HBASE-3102&lt;/del&gt;&lt;/a&gt; fixes the one missing min/max reset and other incrementing values are (for better or worse) part of Hadoop metrics.&lt;/p&gt;</comment>
                            <comment id="12927759" author="stack" created="Wed, 3 Nov 2010 07:05:27 +0000"  >&lt;p&gt;Thanks for looking into this Gary.&lt;/p&gt;</comment>
                            <comment id="15017813" author="lars_francke" created="Fri, 20 Nov 2015 13:01:29 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12477784">HBASE-3129</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12429196" name="HBASE-1956.patch" size="8250" author="apurtell" created="Thu, 31 Dec 2009 04:54:16 +0000"/>
                            <attachment id="12429193" name="HBASE-1956.patch" size="11049" author="apurtell" created="Thu, 31 Dec 2009 03:06:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 5 Nov 2009 18:05:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32331</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hfzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99853</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>