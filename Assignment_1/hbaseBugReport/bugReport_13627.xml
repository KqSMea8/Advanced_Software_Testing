<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:45:09 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13627/HBASE-13627.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13627] Terminating RS results in redundant CLOSE RPC</title>
                <link>https://issues.apache.org/jira/browse/HBASE-13627</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Noticed while testing the 1.1.0RC0 bits. It seems we&apos;re issuing a redundant close RPC during shutdown. This results in a logging warning for each region.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-05-06 00:07:19,214 INFO  [RS:0;ndimiduk-apache-1-1-dist-6:56371] regionserver.HRegionServer: Received CLOSE for the region: 19cbe4fe2fe5335e7aace05e10e36ede, which we are already trying to CLOSE, but not completed yet
2015-05-06 00:07:19,214 WARN  [RS:0;ndimiduk-apache-1-1-dist-6:56371] regionserver.HRegionServer: Failed to close cluster_test,66666666,1430869443384.19cbe4fe2fe5335e7aace05e10e36ede. - ignoring and continuing
org.apache.hadoop.hbase.regionserver.RegionAlreadyInTransitionException: The region 19cbe4fe2fe5335e7aace05e10e36ede was already closing. New CLOSE request is ignored.
	at org.apache.hadoop.hbase.regionserver.HRegionServer.closeRegion(HRegionServer.java:2769)
	at org.apache.hadoop.hbase.regionserver.HRegionServer.closeRegionIgnoreErrors(HRegionServer.java:2695)
	at org.apache.hadoop.hbase.regionserver.HRegionServer.closeUserRegions(HRegionServer.java:2327)
	at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:937)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;1. launch a standalone cluster from tgz (./bin/start-hbase.sh)&lt;br/&gt;
2. load some data (ie, run bin/hbase ltt)&lt;br/&gt;
3. terminate cluster (./bin/stop-hbase.sh)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12827485">HBASE-13627</key>
            <summary>Terminating RS results in redundant CLOSE RPC</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ndimiduk">Nick Dimiduk</reporter>
                        <labels>
                            <label>beginner</label>
                            <label>beginners</label>
                    </labels>
                <created>Wed, 6 May 2015 00:25:39 +0000</created>
                <updated>Mon, 20 Jun 2016 18:44:49 +0000</updated>
                            <resolved>Sun, 1 May 2016 18:59:35 +0000</resolved>
                                    <version>1.1.0</version>
                                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="15167100" author="sreeram" created="Thu, 25 Feb 2016 11:24:40 +0000"  >&lt;p&gt;Nick, I am unable to reproduce this issue in a standalone cluster. I created a table, put couple of records &amp;amp; then stopped hbase. I can see only three closeRegion() calls - for meta, namespace and the table. &lt;/p&gt;</comment>
                            <comment id="15167400" author="ndimiduk" created="Thu, 25 Feb 2016 16:32:26 +0000"  >&lt;p&gt;Thanks for taking a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Sreeram&quot; class=&quot;user-hover&quot; rel=&quot;Sreeram&quot;&gt;Sreeram Venkatasubramanian&lt;/a&gt;. Probably there&apos;s some race condition in standalone mode. Might take a couple cycles to repro.&lt;/p&gt;</comment>
                            <comment id="15173501" author="sreeram" created="Tue, 1 Mar 2016 09:37:16 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndimiduk&quot; class=&quot;user-hover&quot; rel=&quot;ndimiduk&quot;&gt;Nick Dimiduk&lt;/a&gt; , I was able to reproduce the issue by testing in a slower machine. The problem occurs because in the below loop (HRegionServer.java) the region server repeatedly calls closeUserRegions() till all the regions become offline. Inside closeUserRegions() the regions are closed asynchronously, so it is possible that a given region is taking more time to close. For such a region, closeRegion() is called in the subsequent iteration of the while loop - thus triggering the INFO message that we see.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!isStopped() &amp;amp;&amp;amp; isHealthy()) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isClusterUp()) {
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isOnlineRegionsEmpty()) {
            stop(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exiting; cluster shutdown set and not carrying any regions&quot;&lt;/span&gt;);
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.stopping) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.stopping = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Closing user regions&quot;&lt;/span&gt;);
            closeUserRegions(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.abortRequested);
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.stopping) {
            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; allUserRegionsOffline = areAllUserRegionsOffline();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (allUserRegionsOffline) {
              &lt;span class=&quot;code-comment&quot;&gt;// Set stopped &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no more write requests tp meta tables
&lt;/span&gt;              &lt;span class=&quot;code-comment&quot;&gt;// since last time we went around the loop. Any open
&lt;/span&gt;              &lt;span class=&quot;code-comment&quot;&gt;// meta regions will be closed on our way out.
&lt;/span&gt;              &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldRequestCount == getWriteRequestCount()) {
                stop(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stopped; only catalog regions remaining online&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
              }
              oldRequestCount = getWriteRequestCount();
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
              &lt;span class=&quot;code-comment&quot;&gt;// Make sure all regions have been closed -- some regions may
&lt;/span&gt;              &lt;span class=&quot;code-comment&quot;&gt;// have not got it because we were splitting at the time of
&lt;/span&gt;              &lt;span class=&quot;code-comment&quot;&gt;// the call to closeUserRegions.
&lt;/span&gt;
              closeUserRegions(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.abortRequested);
            }
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Waiting on &quot;&lt;/span&gt; + getOnlineRegionsAsPrintableString());
          }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please let me know if we must leave the code as it is or if we need to track the regions to which closeRegion() call is made. So that during the next iteration, a duplicate closeRegion() call is not made - I can work on that if we want to do that.&lt;/p&gt;</comment>
                            <comment id="15263610" author="sreeram" created="Fri, 29 Apr 2016 06:22:11 +0000"  >&lt;p&gt;To summarize, I think the warnings are harmless. Regionservers are terminated asynchronously. The code checks for and stops active regionservers and keeps repeating the same. It is possible a given region server takes more time to close and thats the reason we get the warning. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndimiduk&quot; class=&quot;user-hover&quot; rel=&quot;ndimiduk&quot;&gt;Nick Dimiduk&lt;/a&gt;, ok to close the issue ?&lt;/p&gt;</comment>
                            <comment id="15265882" author="ndimiduk" created="Sun, 1 May 2016 18:59:35 +0000"  >&lt;p&gt;Yep, alright then.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 25 Feb 2016 11:24:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ec1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>