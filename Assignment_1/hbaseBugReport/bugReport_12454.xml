<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:33:11 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-12454/HBASE-12454.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-12454] Setting didPerformCompaction early in HRegion#compact</title>
                <link>https://issues.apache.org/jira/browse/HBASE-12454</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;It appears we are setting &apos;didPerformCompaction&apos; to &quot;true&quot; before attempting the compaction in HRegion#compact. If Store#compact throws an exception or is interrupted, we won&apos;t call Store#cancelRequestedCompaction in the last finally block of the method as it looks like we should.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
--- a/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
+++ b/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
@@ -1540,58 +1540,58 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class HRegion &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; HeapSize, PropagatingConfigurationObserver {
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
       }
 
       status = TaskMonitor.get().createStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;Compacting &quot;&lt;/span&gt; + store + &lt;span class=&quot;code-quote&quot;&gt;&quot; in &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.closed.get()) {
         &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;Skipping compaction on &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot; because closed&quot;&lt;/span&gt;;
         LOG.debug(msg);
         status.abort(msg);
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
       }
       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; wasStateSet = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
         &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (writestate) {
           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (writestate.writesEnabled) {
             wasStateSet = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
             ++writestate.compacting;
           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
             &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;NOT compacting region &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;. Writes disabled.&quot;&lt;/span&gt;;
             LOG.info(msg);
             status.abort(msg);
             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
           }
         }
         LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Starting compaction on &quot;&lt;/span&gt; + store + &lt;span class=&quot;code-quote&quot;&gt;&quot; in region &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
             + (compaction.getRequest().isOffPeak()?&lt;span class=&quot;code-quote&quot;&gt;&quot; as an off-peak compaction&quot;&lt;/span&gt;:&quot;&quot;));
         doRegionCompactionPrep();
         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
           status.setStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;Compacting store &quot;&lt;/span&gt; + store);
-          didPerformCompaction = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
           store.compact(compaction);
+          didPerformCompaction = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
         } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedIOException iioe) {
           &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;compaction interrupted&quot;&lt;/span&gt;;
           LOG.info(msg, iioe);
           status.abort(msg);
           &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
         }
       } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wasStateSet) {
           &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (writestate) {
             --writestate.compacting;
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (writestate.compacting &amp;lt;= 0) {
               writestate.notifyAll();
             }
           }
         }
       }
       status.markComplete(&lt;span class=&quot;code-quote&quot;&gt;&quot;Compaction complete&quot;&lt;/span&gt;);
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
     } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!didPerformCompaction) store.cancelRequestedCompaction(compaction);   &amp;lt;-----
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (status != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) status.cleanup();
       } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
         lock.readLock().unlock();
       }
     }
   }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12754245">HBASE-12454</key>
            <summary>Setting didPerformCompaction early in HRegion#compact</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apurtell">Andrew Purtell</assignee>
                                    <reporter username="apurtell">Andrew Purtell</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Nov 2014 20:36:31 +0000</created>
                <updated>Sat, 21 Feb 2015 23:50:02 +0000</updated>
                            <resolved>Wed, 10 Dec 2014 01:29:31 +0000</resolved>
                                    <version>0.98.8</version>
                                    <fixVersion>1.0.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                    <fixVersion>0.98.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="14205296" author="apurtell" created="Mon, 10 Nov 2014 20:39:38 +0000"  >&lt;p&gt;Is this right or am I missing something? &lt;/p&gt;</comment>
                            <comment id="14205389" author="lhofhansl" created="Mon, 10 Nov 2014 21:52:40 +0000"  >&lt;p&gt;That looks right to me. Too bad the RC is out already.&lt;/p&gt;</comment>
                            <comment id="14205407" author="apurtell" created="Mon, 10 Nov 2014 22:04:58 +0000"  >&lt;p&gt;I&apos;m going to veto the RC for this and since &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12319&quot; title=&quot;Inconsistencies during region recovery due to close/open of a region during recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12319&quot;&gt;&lt;del&gt;HBASE-12319&lt;/del&gt;&lt;/a&gt; didn&apos;t quite make it but was marked critical &lt;/p&gt;</comment>
                            <comment id="14205408" author="apurtell" created="Mon, 10 Nov 2014 22:05:51 +0000"  >&lt;p&gt;Will commit this shortly to 0.98+ unless there is an objection &lt;/p&gt;</comment>
                            <comment id="14205433" author="hadoopqa" created="Mon, 10 Nov 2014 22:25:59 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12680650/HBASE-12454.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12680650/HBASE-12454.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12680650&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.regionserver.TestCompaction&lt;br/&gt;
                  org.apache.hadoop.hbase.regionserver.TestCompactionWithCoprocessor&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-rest.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-rest.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-annotations.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-annotations.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11628//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14205483" author="apurtell" created="Mon, 10 Nov 2014 22:56:45 +0000"  >&lt;p&gt;Those are interesting test failures. They didn&apos;t fail locally but seem highly relevant. Looking into it. &lt;/p&gt;</comment>
                            <comment id="14205509" author="lhofhansl" created="Mon, 10 Nov 2014 23:07:31 +0000"  >&lt;p&gt;Hmm... Yes. Maybe put it in the next RC, then.&lt;/p&gt;</comment>
                            <comment id="14205537" author="apurtell" created="Mon, 10 Nov 2014 23:24:04 +0000"  >&lt;p&gt;Maybe.&lt;/p&gt;</comment>
                            <comment id="14205660" author="apurtell" created="Tue, 11 Nov 2014 00:25:33 +0000"  >&lt;p&gt;It&apos;s a test only accounting problem. &lt;/p&gt;

&lt;p&gt;The failure is an assert in HRegion#reportCompactionRequestEnd now that we are actually calling HStore#cancelRequestedCompaction when interrupted. However the test goes to HRegion#compactStores directly so the compaction request start is not first reported with HRegion#reportCompactionRequestStart. I wasn&apos;t running with assertions enabled before locally but am now.&lt;/p&gt;

&lt;p&gt;Updated patch.&lt;/p&gt;

&lt;p&gt;Patch also includes a fix for a NPE from TestCompaction that the debugger caught that is normally silent.&lt;/p&gt;</comment>
                            <comment id="14205679" author="lhofhansl" created="Tue, 11 Nov 2014 00:39:05 +0000"  >&lt;p&gt;Looks good. +1&lt;/p&gt;</comment>
                            <comment id="14205706" author="apurtell" created="Tue, 11 Nov 2014 00:52:16 +0000"  >&lt;p&gt;Waiting for Jenkins to come around again and give this another shot&lt;/p&gt;</comment>
                            <comment id="14205827" author="hadoopqa" created="Tue, 11 Nov 2014 02:15:38 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12680706/HBASE-12454.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12680706/HBASE-12454.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12680706&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 4 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-annotations.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-annotations.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-rest.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-rest.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11629//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14206054" author="stack" created="Tue, 11 Nov 2014 07:03:26 +0000"  >&lt;p&gt;Looks good Andrew.&lt;/p&gt;

&lt;p&gt;Could runner.compaction go null between check and usage on #560?&lt;/p&gt;

&lt;p&gt;559	        if (runner.compaction != null) &lt;/p&gt;
{
560	          runner.store.cancelRequestedCompaction(runner.compaction);
561	        }</comment>
                            <comment id="14206062" author="apurtell" created="Tue, 11 Nov 2014 07:13:19 +0000"  >&lt;p&gt;I can move the null check closer to where it is used.&lt;/p&gt;</comment>
                            <comment id="14206680" author="lhofhansl" created="Tue, 11 Nov 2014 17:44:20 +0000"  >&lt;p&gt;So thinking about this more. All that cancelRequestedCompaction does is cleaning up filesToCompact. So it is actually safest to indicate that we need to do this before we trigger the compaction. Otherwise the compaction sets that member, and then might fail. So I think it is correct as is. (one can argue about the naming and whether an extra state variable is needed here, but the logic seems to be sound)&lt;/p&gt;</comment>
                            <comment id="14206763" author="apurtell" created="Tue, 11 Nov 2014 18:27:41 +0000"  >&lt;p&gt;I don&apos;t like it. I think the naming of that function and the accounting implications are wrong.&lt;/p&gt;</comment>
                            <comment id="14207373" author="apurtell" created="Wed, 12 Nov 2014 00:03:22 +0000"  >&lt;p&gt;Updated patch addressing Stack&apos;s comment&lt;/p&gt;</comment>
                            <comment id="14207382" author="stack" created="Wed, 12 Nov 2014 00:06:25 +0000"  >&lt;p&gt;Go for it +1&lt;/p&gt;</comment>
                            <comment id="14207506" author="hadoopqa" created="Wed, 12 Nov 2014 01:48:15 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12680927/HBASE-12454.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12680927/HBASE-12454.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12680927&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 4 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 javadoc&lt;/font&gt;.  The javadoc tool appears to have generated 1 warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 site&lt;/font&gt;.  The patch appears to cause mvn site goal to fail.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-rest.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-rest.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-annotations.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/newPatchFindbugsWarningshbase-annotations.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Javadoc warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/patchJavadocWarnings.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//artifact/patchprocess/patchJavadocWarnings.txt&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11642//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14208343" author="apurtell" created="Wed, 12 Nov 2014 17:53:06 +0000"  >&lt;p&gt;Pushed to 98+&lt;/p&gt;</comment>
                            <comment id="14208346" author="apurtell" created="Wed, 12 Nov 2014 17:54:44 +0000"  >&lt;p&gt;0.98 version of the patch.&lt;/p&gt;

&lt;p&gt;On master and branch-1 TestCompaction#testInterruptCompaction will trigger a minor compaction. On 0.98 it&apos;s a major compaction. Something to look at later.&lt;/p&gt;</comment>
                            <comment id="14208527" author="hudson" created="Wed, 12 Nov 2014 19:41:16 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK #5767 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/5767/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/5767/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact (apurtell: rev b0a434a5ce4aac1bc6e50ebf7c58f0e65052caae)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14208569" author="lhofhansl" created="Wed, 12 Nov 2014 19:55:42 +0000"  >&lt;p&gt;Did you mean to commit this? It&apos;s not right. The previous logic was correct, just the variables/methods were named strangely. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14208588" author="apurtell" created="Wed, 12 Nov 2014 20:01:43 +0000"  >&lt;p&gt;Yes I did mean to commit this. Got a +1 for Stack above. Maybe we missed an objection from you? &lt;/p&gt;

&lt;p&gt;I don&apos;t think the previous logic was right. We wouldn&apos;t call HRegion#reportCompactionRequestEnd to cancel/clean up the compaction request if Store#compact fails. reportCompactionRequestStart and reportCompactionRequestEnd maintain counters. &lt;/p&gt;</comment>
                            <comment id="14208602" author="hudson" created="Wed, 12 Nov 2014 20:12:01 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98 #670 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/670/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/670/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact (apurtell: rev 28747bab89d5a7050b9b26e1f6581c502d6d1864)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14208603" author="hudson" created="Wed, 12 Nov 2014 20:12:04 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.0 #458 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.0/458/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.0/458/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact (apurtell: rev 16decdc19acd622df2b077c6cf5b737f589c2a52)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14208626" author="apurtell" created="Wed, 12 Nov 2014 20:29:18 +0000"  >&lt;p&gt;Ok, I reread your comment above &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; and looked again at HStore#compact. I will revert the commit and replace it with a simple rename of &apos;didPerformCompaction&apos; to &apos;cancelNeeded&apos;, and set it to true initially and false just before the call to Store#compact, with a comment, because:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In HRegion#compact it looks like &apos;didPerformCompaction&apos; is being set early. If we move it to after the call to Store#compact then Store#cancelRequestedCompaction will be called on the way out via a finally block if Store#compact fails. (Previously, it would not.)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In Store#compact there is a small finally clause that can be missed:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      finishCompactionRequest(cr);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and everything that Store#compact does of importance is within the try-finally block. So the call to finishCompactionRequest from Store#cancelRequestedCompaction in that finally clause of HRegion#compact due to &apos;didPerformCompaction&apos; doesn&apos;t seem needed after all.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This code is hard to follow and &apos;didPerformCompaction&apos; is not a good name.&lt;/p&gt;</comment>
                            <comment id="14208631" author="apurtell" created="Wed, 12 Nov 2014 20:31:23 +0000"  >&lt;p&gt;Reverts pushed to 0.98+&lt;/p&gt;</comment>
                            <comment id="14208636" author="hudson" created="Wed, 12 Nov 2014 20:33:10 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98-on-Hadoop-1.1 #638 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/638/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/638/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact (apurtell: rev 28747bab89d5a7050b9b26e1f6581c502d6d1864)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14208644" author="lhofhansl" created="Wed, 12 Nov 2014 20:41:50 +0000"  >&lt;p&gt;Hmm... I think I read the patch wrong.&lt;br/&gt;
In fact I am not sure, now. Seems we can only cancel a &lt;b&gt;requested&lt;/b&gt; compaction until it actually started (which point it is no longer requested).&lt;br/&gt;
The fact that this is a bit strange now is also indicated by the required test change to get the accounting right.&lt;/p&gt;

&lt;p&gt;If you guys thinks this is right, let&apos;s leave it in.&lt;/p&gt;</comment>
                            <comment id="14208650" author="apurtell" created="Wed, 12 Nov 2014 20:45:27 +0000"  >&lt;p&gt;Well I still need to do a bit more because assertions and sanity checks in HStore#compact are outside the try-finally clause and could cause exceptions to be thrown after we&apos;ve decided we don&apos;t need to clean up in HRegion#compact &lt;/p&gt;</comment>
                            <comment id="14208651" author="apurtell" created="Wed, 12 Nov 2014 20:45:58 +0000"  >&lt;p&gt;I already reverted. Let me put up a V2 patch here and on RB that we can chew on.&lt;/p&gt;</comment>
                            <comment id="14208653" author="apurtell" created="Wed, 12 Nov 2014 20:46:20 +0000"  >&lt;p&gt;Moving to 0.98.9&lt;/p&gt;</comment>
                            <comment id="14208684" author="sershe" created="Wed, 12 Nov 2014 21:06:02 +0000"  >&lt;p&gt;Some clarification. Variable name is indeed not good... however I think it is right to be set before compact call.&lt;br/&gt;
&quot;Physically&quot;, the end goal is to call finishCompactionRequest.&lt;br/&gt;
If compact is called at all on HStore, it would call finishCompactionRequest in the finally block (the code above try... finally is not supposed to fail, I guess it could also be included in a separate try... finally). If it wasn&apos;t called, then finishCompactionRequest is called in case of failure, via cancelRequestedCompaction&lt;/p&gt;

&lt;p&gt;&quot;Logically&quot;, we have to cancel compactions that we selected but didn&apos;t start; if we start a compaction on the store we assume it does appropriate cleanup for failure, so we don&apos;t need to cancel it. Perhaps comments could be added to that effect and variable renamed &quot;didStartCompaction&quot;&lt;/p&gt;

&lt;p&gt;Moving it after the call seems incorrect cause in that case  finishCompactionRequest can be called twice, in the finally in HStore::compact, and via cancel....&lt;/p&gt;</comment>
                            <comment id="14208689" author="apurtell" created="Wed, 12 Nov 2014 21:09:33 +0000"  >&lt;p&gt;Indeed. &lt;/p&gt;

&lt;p&gt;V2 patch attached and see &lt;a href=&quot;https://reviews.apache.org/r/27927/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/27927/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Refactor only, no behavioral change intended.&lt;/p&gt;</comment>
                            <comment id="14208804" author="hudson" created="Wed, 12 Nov 2014 22:20:07 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK #5769 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/5769/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/5769/&lt;/a&gt;)&lt;br/&gt;
Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact&quot; (apurtell: rev 210f5a3b01e67287c1120d15402a52eb158ddc33)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14208836" author="hudson" created="Wed, 12 Nov 2014 22:48:01 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.0 #460 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.0/460/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.0/460/&lt;/a&gt;)&lt;br/&gt;
Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact&quot; (apurtell: rev d0c34fb4a30aaeb705f4dd497e26cd7fe7e3bb94)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14208845" author="hudson" created="Wed, 12 Nov 2014 22:57:01 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98-on-Hadoop-1.1 #639 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/639/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/639/&lt;/a&gt;)&lt;br/&gt;
Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact&quot; (apurtell: rev 6ab844851579d2e0ee2662929d8a09c190cba18d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14208893" author="hudson" created="Wed, 12 Nov 2014 23:34:58 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98 #672 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/672/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/672/&lt;/a&gt;)&lt;br/&gt;
Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact&quot; (apurtell: rev 6ab844851579d2e0ee2662929d8a09c190cba18d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14232324" author="enis" created="Wed, 3 Dec 2014 00:03:24 +0000"  >&lt;p&gt;Found in triage. Seems good to commit. &lt;/p&gt;</comment>
                            <comment id="14240217" author="apurtell" created="Tue, 9 Dec 2014 22:53:35 +0000"  >&lt;p&gt;Committing shortly&lt;/p&gt;</comment>
                            <comment id="14240477" author="apurtell" created="Wed, 10 Dec 2014 01:29:31 +0000"  >&lt;p&gt;Pushed to 0.98+&lt;/p&gt;</comment>
                            <comment id="14240564" author="hudson" created="Wed, 10 Dec 2014 02:49:37 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-1.0 #565 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.0/565/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.0/565/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact (apurtell: rev 7ebeb89c392214ca8527587d40783ab51dbb7331)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14240597" author="hudson" created="Wed, 10 Dec 2014 03:39:30 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK #5900 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/5900/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/5900/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact (apurtell: rev 011442edda6218d9efc024e004b4f62880e8b932)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14240625" author="hudson" created="Wed, 10 Dec 2014 04:24:26 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98 #733 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/733/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/733/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact (apurtell: rev 06c4d8a8e14db8f01cce7d6e1f027df3e8f30a92)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14240711" author="hudson" created="Wed, 10 Dec 2014 06:20:23 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98-on-Hadoop-1.1 #700 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/700/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/700/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12454&quot; title=&quot;Setting didPerformCompaction early in HRegion#compact&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12454&quot;&gt;&lt;del&gt;HBASE-12454&lt;/del&gt;&lt;/a&gt; Setting didPerformCompaction early in HRegion#compact (apurtell: rev 06c4d8a8e14db8f01cce7d6e1f027df3e8f30a92)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14331913" author="enis" created="Sat, 21 Feb 2015 23:50:02 +0000"  >&lt;p&gt;Closing this issue after 1.0.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12681094" name="HBASE-12454-0.98.patch" size="2945" author="apurtell" created="Wed, 12 Nov 2014 17:54:44 +0000"/>
                            <attachment id="12681139" name="HBASE-12454-v2.patch" size="5315" author="apurtell" created="Wed, 12 Nov 2014 21:09:33 +0000"/>
                            <attachment id="12680927" name="HBASE-12454.patch" size="2921" author="apurtell" created="Tue, 11 Nov 2014 22:45:17 +0000"/>
                            <attachment id="12680706" name="HBASE-12454.patch" size="3080" author="apurtell" created="Tue, 11 Nov 2014 00:25:33 +0000"/>
                            <attachment id="12680650" name="HBASE-12454.patch" size="824" author="apurtell" created="Mon, 10 Nov 2014 20:43:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 10 Nov 2014 21:52:40 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22767:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>