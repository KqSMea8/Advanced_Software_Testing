<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:01:55 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2439/HBASE-2439.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2439] HBase can get stuck if updates to META are blocked</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2439</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;(We noticed this on a import-style test in a small test cluster.)&lt;/p&gt;

&lt;p&gt;If compactions are running slow, and we are doing a lot of region splits, then, since META has a much smaller hard-coded memstore flush size (16KB), it quickly accumulates lots of store files. Once this exceeds &quot;hbase.hstore.blockingStoreFiles&quot;, flushes to META become no-ops. This causes METAs memstore footprint to grow. Once this exceeds &quot;hbase.hregion.memstore.block.multiplier * 16KB&quot;, we block further updates to META.&lt;/p&gt;

&lt;p&gt;In my test setup:&lt;br/&gt;
  hbase.hregion.memstore.block.multiplier = 4.&lt;br/&gt;
and,&lt;br/&gt;
  hbase.hstore.blockingStoreFiles = 15.&lt;/p&gt;

&lt;p&gt;And we saw messages of the form:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-04-09 18:37:39,539 INFO org.apache.hadoop.hbase.regionserver.HRegion: Blocking updates &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &apos;IPC Server handler 23 on 60020&apos; on region .META.,,1: memstore size 64.2k is &amp;gt;= than blocking 64.0k size
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, if around the same time the CompactSplitThread does a compaction and determines it is going split the region. As part of finishing the split, it wants to update META about the daughter regions. &lt;/p&gt;

&lt;p&gt;It&apos;ll end up waiting for the META to become unblocked. The single CompactSplitThread is now held up, and no further compactions can proceed.  META&apos;s compaction request is itself blocked because the compaction queue will never get cleared.&lt;/p&gt;

&lt;p&gt;This essentially creates a deadlock and the region server is able to not progress any further. Eventually, each region server&apos;s CompactSplitThread ends up in the same state.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12461995">HBASE-2439</key>
            <summary>HBase can get stuck if updates to META are blocked</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kannanm">Kannan Muthukkaruppan</assignee>
                                    <reporter username="kannanm">Kannan Muthukkaruppan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Apr 2010 21:55:13 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:44 +0000</updated>
                            <resolved>Wed, 14 Apr 2010 22:42:10 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="12856647" author="kannanm" created="Tue, 13 Apr 2010 22:01:18 +0000"  >&lt;p&gt;One option might be to never block updates to .META. even if it violates the blockingStoreFiles limit. &lt;/p&gt;

&lt;p&gt;Also, we could perhaps now bump up the MEMSTORE_FLUSH_SIZE of META now that we have sync support at the HDFS level.&lt;/p&gt;</comment>
                            <comment id="12856651" author="jdcryans" created="Tue, 13 Apr 2010 22:12:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, we could perhaps now bump up the MEMSTORE_FLUSH_SIZE of META now that we have sync support at the HDFS level.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Was done in trunk, for branch it should be also like that if &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-200&quot; title=&quot;In HDFS, sync() not yet guarantees data available to the new readers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-200&quot;&gt;&lt;del&gt;HDFS-200&lt;/del&gt;&lt;/a&gt; and pals are there.&lt;/p&gt;</comment>
                            <comment id="12856664" author="streamy" created="Tue, 13 Apr 2010 22:29:45 +0000"  >&lt;p&gt;Yeah we should backport that change to 0.20.5&lt;/p&gt;

&lt;p&gt;Even so, we should still probably never ever block writes into META memstore.  Hard to think of a time when this would really make sense (or cause less problems than just letting the updates in).&lt;/p&gt;</comment>
                            <comment id="12856681" author="kannanm" created="Tue, 13 Apr 2010 23:10:20 +0000"  >&lt;p&gt;#1. &amp;gt;&amp;gt;&amp;gt; Was done in trunk.&lt;/p&gt;

&lt;p&gt;In the branch, the HTableDescriptor constructor for META &amp;amp; ROOT does a &quot;setMemStoreFlushSize(16 * 1024)&quot; and I don&apos;t see that call in trunk.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  /**
   * Private constructor used internally creating table descriptors &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 
   * catalog tables: e.g. .META. and -ROOT-.
   */
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; HTableDescriptor(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] name, HColumnDescriptor[] families) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.name = name.clone();
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.nameAsString = Bytes.toString(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.name);
    setMetaFlags(name);
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(HColumnDescriptor descriptor : families) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.families.put(descriptor.getName(), descriptor);
    }
    setMemStoreFlushSize(16 * 1024);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So is my understanding correct that in trunk, ROOT &amp;amp; META simply use the default (64MB) memstore flush size? Is that the change we want for branch?&lt;/p&gt;

&lt;p&gt;#2. I&apos;ll also make the changes to never block updates for meta region.  I plan to do so by removing both of the following restrictions for meta regions:&lt;/p&gt;

&lt;p&gt;a) blockingStoreFiles limit check in MemStoreFlusher.java:flushRegion():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isTooManyStoreFiles(region)) {
      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Region &quot;&lt;/span&gt; + region.getRegionNameAsString() + &lt;span class=&quot;code-quote&quot;&gt;&quot; has too many &quot;&lt;/span&gt; +
          &lt;span class=&quot;code-quote&quot;&gt;&quot;store files, putting it back at the end of the flush queue.&quot;&lt;/span&gt;);
      server.compactSplitThread.compactionRequested(region, getName());
      &lt;span class=&quot;code-comment&quot;&gt;// If there&apos;s only &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; item in the queue or they are all in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// situation, we will loop at lot. Sleep a bit.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) { } &lt;span class=&quot;code-comment&quot;&gt;// just &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;
&lt;/span&gt;      flushQueue.add(region);
      &lt;span class=&quot;code-comment&quot;&gt;// Tell a lie, it&apos;s not flushed but it&apos;s ok
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;b)  memstoresize violation restriction in HRegion.java:checkResources().&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void checkResources() {
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; blocked = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.memstoreSize.get() &amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.blockingMemStoreSize) {
      requestFlush();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!blocked) {
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Blocking updates &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &apos;&quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName() +
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12856754" author="kannanm" created="Wed, 14 Apr 2010 05:14:25 +0000"  >&lt;p&gt;Patch uploaded.  ant test pases.&lt;/p&gt;

&lt;p&gt;Repeated  my test cluster import test. No longer runs into the stuck state described earlier.&lt;/p&gt;</comment>
                            <comment id="12856756" author="tlipcon" created="Wed, 14 Apr 2010 05:23:34 +0000"  >&lt;p&gt;I can verify this bug - I saw it in my testing this afternoon as well. Relevant logs:&lt;/p&gt;

&lt;p&gt;2010-04-13 19:19:01,322 INFO org.apache.hadoop.hbase.regionserver.HRegion: compaction completed on region test1,4542214000,1271211529201 in 1sec&lt;br/&gt;
2010-04-13 19:19:01,322 INFO org.apache.hadoop.hbase.regionserver.HRegion: Starting compaction on region test1,4230893000,1271197630557&lt;br/&gt;
2010-04-13 19:19:01,328 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: MSG_REGION_OPEN: test1,9652090000,1271197954171&lt;br/&gt;
2010-04-13 19:19:01,371 INFO org.apache.hadoop.hbase.regionserver.HRegion: region test1,4983930000,1271198319326/845482654 available; sequence id is 2300024&lt;br/&gt;
2010-04-13 19:19:01,371 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Worker: MSG_REGION_OPEN: test1,8588812000,1271198227526&lt;br/&gt;
2010-04-13 19:19:01,375 INFO org.apache.hadoop.hbase.regionserver.HRegion: compaction completed on region test1,4230893000,1271197630557 in 0sec&lt;br/&gt;
2010-04-13 19:19:01,376 INFO org.apache.hadoop.hbase.regionserver.HRegion: Starting split of region test1,4230893000,1271197630557&lt;br/&gt;
2010-04-13 19:19:01,379 INFO org.apache.hadoop.hbase.regionserver.HRegion: Closed test1,4230893000,1271197630557&lt;br/&gt;
2010-04-13 19:19:01,383 INFO org.apache.hadoop.hbase.regionserver.HRegion: region test1,8588812000,1271198227526/314680607 available; sequence id is 2302647&lt;br/&gt;
2010-04-13 19:19:01,383 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Worker: MSG_REGION_OPEN: test1,9652090000,1271197954171&lt;br/&gt;
2010-04-13 19:19:01,385 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: MSG_REGION_OPEN: test1,8075160000,1271198620343&lt;br/&gt;
2010-04-13 19:19:01,399 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: MSG_REGION_OPEN: test1,4300550000,1271198160421&lt;br/&gt;
2010-04-13 19:19:01,419 INFO org.apache.hadoop.hbase.regionserver.HRegion: region test1,9652090000,1271197954171/173125735 available; sequence id is 2299793&lt;br/&gt;
2010-04-13 19:19:01,420 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Worker: MSG_REGION_OPEN: test1,8075160000,1271198620343&lt;br/&gt;
2010-04-13 19:19:01,433 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: MSG_REGION_OPEN: test1,4662590000,1271197688651&lt;br/&gt;
2010-04-13 19:19:01,448 INFO org.apache.hadoop.hbase.regionserver.HRegion: Blocking updates for &apos;IPC Server handler 11 on 60020&apos; on region .META.,,1: memstore size 32.0k is &amp;gt;= than blocking 3&lt;br/&gt;
2.0k size&lt;/p&gt;

&lt;p&gt;eventually the RS just devolves into repeatedly writing:&lt;br/&gt;
2010-04-13 19:20:17,396 WARN org.apache.hadoop.hbase.regionserver.MemStoreFlusher: Region .META.,,1 has too many store files, putting it back at the end of the flush queue.&lt;/p&gt;

&lt;p&gt;I&apos;ll try Kannan&apos;s patch&lt;/p&gt;</comment>
                            <comment id="12856757" author="tlipcon" created="Wed, 14 Apr 2010 05:26:35 +0000"  >&lt;p&gt;[From code review standpoint, +1 on the patch. I think we should commit the whole thing&lt;br/&gt;
for the durability branch, and everything but the table descriptor change for the 0.20.4 branch]&lt;/p&gt;</comment>
                            <comment id="12856979" author="kannanm" created="Wed, 14 Apr 2010 17:36:51 +0000"  >&lt;p&gt;@Todd: &lt;/p&gt;

&lt;p&gt;&amp;lt;&amp;lt;&amp;lt; eventually the RS just devolves into repeatedly writing:&lt;br/&gt;
2010-04-13 19:20:17,396 WARN org.apache.hadoop.hbase.regionserver.MemStoreFlusher: Region .META.,,1 has too many store files, putting it back at the end of the flush queue.&lt;br/&gt;
&amp;gt;&amp;gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;yes, that&apos;s exactly what I ran into as well.&lt;/p&gt;

&lt;p&gt;Re: &amp;lt;&amp;lt;&amp;lt;&amp;lt; I think we should commit the whole thing for the durability  branch, &lt;br/&gt;
and everything but the table descriptor change for the 0.20.4 branch &amp;gt;&amp;gt;&amp;gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;I am little confused about 0.20.4 vs. 0.20.5 vs. durability branch. I see &lt;br/&gt;
some issues moved to 0.20.5.  Is 0.20&apos;s trunk now essentially 0.20.5? &lt;br/&gt;
And is there a separate durability branch outside of the 0.20.x series?&lt;/p&gt;

&lt;p&gt;regards,&lt;br/&gt;
Kannan&lt;/p&gt;</comment>
                            <comment id="12856983" author="stack" created="Wed, 14 Apr 2010 17:42:10 +0000"  >&lt;p&gt;@Kannan We branched 0.20 to  make 0.20_pre_durability.  From this new branch we will take a 0.20.4.  It is critical fixes minus the big changes you fellas have been at.  We need to get the critical fixes out there sooner than 0.20.5+hdfs durability patches and testing.  Hence a 0.20.4.&lt;/p&gt;

&lt;p&gt;Let me commit.&lt;/p&gt;</comment>
                            <comment id="12857127" author="stack" created="Wed, 14 Apr 2010 22:42:10 +0000"  >&lt;p&gt;Applied to 0.20 branch as is.  Applied to 0.20_pre_durability and TRUNK w/o the change to table descriptor as per Todd suggestion (In former to minimize change and in latter because patch failed since limit had already been removed).  Thanks for the patch Kannan.&lt;/p&gt;</comment>
                            <comment id="12858513" author="ryanobjc" created="Mon, 19 Apr 2010 14:45:18 +0000"  >
&lt;p&gt;   [[ Old comment, sent by email on Tue, 13 Apr 2010 15:28:24 -0700 ]]&lt;/p&gt;

&lt;p&gt;The primary reason to do blocking store files is that compactions can&lt;br/&gt;
oome a server, so we protect ourselves.  With 0.20 that should no&lt;br/&gt;
longer be the case. I have compacted 100 files of 10gb, so i am in&lt;br/&gt;
favor of removing this feature.&lt;/p&gt;

&lt;p&gt;On Tue, Apr 13, 2010 at 3:01 PM, Kannan Muthukkaruppan (JIRA)&lt;/p&gt;
</comment>
                            <comment id="12866845" author="stack" created="Wed, 12 May 2010 23:52:22 +0000"  >&lt;p&gt;Marking these as fixed against 0.21.0 rather than against 0.20.5.&lt;/p&gt;</comment>
                            <comment id="15016788" author="lars_francke" created="Fri, 20 Nov 2015 12:40:44 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12441689" name="ASF.LICENSE.NOT.GRANTED--2439_0.20_dont_block_meta.txt" size="2005" author="kannanm" created="Wed, 14 Apr 2010 05:14:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Apr 2010 22:12:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26303</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hhpj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100131</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>