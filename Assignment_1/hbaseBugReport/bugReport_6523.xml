<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:37:31 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6523/HBASE-6523.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6523] HConnectionImplementation still does not recover from all ZK issues.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6523</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;During some testing here at Salesforce.com we found another scenario where an HConnectionImplementation would never recover from a lost ZK connection.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12602070">HBASE-6523</key>
            <summary>HConnectionImplementation still does not recover from all ZK issues.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="6">Invalid</resolution>
                                        <assignee username="lhofhansl">Lars Hofhansl</assignee>
                                    <reporter username="lhofhansl">Lars Hofhansl</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Aug 2012 18:22:58 +0000</created>
                <updated>Thu, 16 May 2013 07:39:59 +0000</updated>
                            <resolved>Wed, 8 Aug 2012 05:16:22 +0000</resolved>
                                    <version>0.94.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13430500" author="lhofhansl" created="Tue, 7 Aug 2012 18:26:11 +0000"  >&lt;p&gt;Trivial patch. Just attempt to reconnect for ConnectionLoss scenarios. Just like we do for SessionExpired scenarios.&lt;/p&gt;</comment>
                            <comment id="13430541" author="apurtell" created="Tue, 7 Aug 2012 19:12:08 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13430590" author="lhofhansl" created="Tue, 7 Aug 2012 20:16:31 +0000"  >&lt;p&gt;Committed to 0.94.&lt;/p&gt;</comment>
                            <comment id="13430677" author="hudson" created="Tue, 7 Aug 2012 22:19:34 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #385 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/385/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/385/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6523&quot; title=&quot;HConnectionImplementation still does not recover from all ZK issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6523&quot;&gt;&lt;del&gt;HBASE-6523&lt;/del&gt;&lt;/a&gt; HConnectionImplementation still does not recover from all ZK issues. (Revision 1370493)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13430795" author="lhofhansl" created="Wed, 8 Aug 2012 01:13:09 +0000"  >&lt;p&gt;Oops... That failure is related. Checking...&lt;/p&gt;</comment>
                            <comment id="13430799" author="lhofhansl" created="Wed, 8 Aug 2012 01:41:44 +0000"  >&lt;p&gt;Hmm... So HBaseAdmin.checkHBaseAvailable checks in part of ZooKeeperConnectionException, but now this will not fall through the HConnectionImplementation.abort, but instead will attempt to reestablish the connection to ZK... But, in this case there is no ZKWatcher setup, and hence the NPE.&lt;/p&gt;</comment>
                            <comment id="13430805" author="lhofhansl" created="Wed, 8 Aug 2012 02:06:30 +0000"  >&lt;p&gt;Reverted the change for now.&lt;/p&gt;</comment>
                            <comment id="13430856" author="lhofhansl" created="Wed, 8 Aug 2012 04:11:38 +0000"  >&lt;p&gt;It&apos;s not at all clear to me how to fix this now.&lt;br/&gt;
The solution is probably just wait until the session expires, instead of trying to deal with ConnectionLossException.&lt;br/&gt;
It is curious that RecoverableZookeeper does retry on a ConnectionLoss, when it seems that it can never succeed.&lt;/p&gt;</comment>
                            <comment id="13430875" author="lhofhansl" created="Wed, 8 Aug 2012 05:16:05 +0000"  >&lt;p&gt;Ohh... Just realized, my colleague was seeing this when he was playing with local hbase (not his test cluster). So ZK would be on a new port every time and of course could not be expected to recover.&lt;br/&gt;
Sorry for the noise.&lt;/p&gt;</comment>
                            <comment id="13431202" author="lhofhansl" created="Wed, 8 Aug 2012 16:30:41 +0000"  >&lt;p&gt;Something &lt;b&gt;is&lt;/b&gt; going on here. With this patch a long running client will recover even from local HBase being restarted. Without the patch it will endlessly retry and each time get a ConnectionLossException.&lt;/p&gt;

&lt;p&gt;I am not entirely clear of the semantics of ConnectionLoss, and documentation is confusing. It is said to be a recoverable exception, but is that true even across restarts of the ZK ensemble? If not, is there a way to tell the difference between a network hickup and an ensemble restart?&lt;/p&gt;</comment>
                            <comment id="13431207" author="lhofhansl" created="Wed, 8 Aug 2012 16:37:32 +0000"  >&lt;p&gt;The NPE in the test is caused by the fact that the recreation of the ZKWatcher fails (with connection loss), which is reported through the passed abortable, which then resets the ZK variables, which in turn causes an NPE in the existing invocation of ensureZKTrackers (which has not finished, yet).&lt;/p&gt;

&lt;p&gt;In the 0.94 model this is surprisingly hard to fix without other side-effects. (In 0.96 NKeyval did a wholesale redesign on HConnectionImplementation, which tackles this much better).&lt;/p&gt;

&lt;p&gt;I&apos;ll leave this closed for now, but we&apos;ll do a bit more research and I might reopen with a patch that&apos;ll also avoid this obscure NPE).&lt;/p&gt;</comment>
                            <comment id="13431212" author="apurtell" created="Wed, 8 Aug 2012 16:44:37 +0000"  >&lt;p&gt;I tried the patch on this issue and ran into test trouble, but I saw concurrently that you backed it out.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I am not entirely clear of the semantics of ConnectionLoss, and documentation is confusing.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Suggest taking this to the user@zookeeper list, it&apos;s a sharp edge of their API. &lt;/p&gt;</comment>
                            <comment id="13431238" author="nkeywal" created="Wed, 8 Aug 2012 17:39:01 +0000"  >&lt;p&gt;I agree, Zookeeper list comes handy for these questions &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;To me, to be validated by ZK experts, ConnectionLoss means that we lost the connection, but we hope it will come back. When it comes back, we receive all the events, and there should be no data loss. While for a SessionTimeout, we may have lost events, so we should re-initiate the watchers and, from an application point of view, take into account that we may have missed events in the middle.&lt;/p&gt;

&lt;p&gt;The way we manage session timeouts in HBase/RecoverableZK is tricky: we retry, because we expect that a parallel abort will have triggered a zk session recreation, so our next retry will be on a brand new ZK session (and ZooKeeper object in the RecoverableZK ) and so it will work.&lt;/p&gt;

&lt;p&gt;As we retry a limited amount of time in the RecovableZK, for connectionLoss we may stop to retry before the timeout is happening, and throw the exception to the calling layer. As such it may becoming a unrecovable error from an HBase point of view. I think that if we want to fix this we should change RecoverableZooKeeper to make it retry all the time for a connectionLoss, waiting for the session timeout to occur. May be as well we have calls not using the recovable ZK (if I&apos;m remember well I&apos;ve seen a few, and is was justified I believe). But we should not re create a session for a connection loss (it could have bad side effects with ZK having to manage too many sessions, the old and the new, for example).&lt;/p&gt;</comment>
                            <comment id="13431519" author="lhofhansl" created="Thu, 9 Aug 2012 00:53:51 +0000"  >&lt;p&gt;We double checked and verified that this only occurred with local HBase. The client successfully reconnects to a bounced cluster (which is good, because it means that I am not insane, because I did verify this when I worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5682&quot; title=&quot;Allow HConnectionImplementation to recover from ZK connection loss (for 0.94 only)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5682&quot;&gt;&lt;del&gt;HBASE-5682&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;So this must be an interaction with the client retrying the reconnection with the master and persistently failing in that (which is expected with local hbase).&lt;/p&gt;</comment>
                            <comment id="13439509" author="hudson" created="Wed, 22 Aug 2012 13:48:08 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #48 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/48/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/48/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6523&quot; title=&quot;HConnectionImplementation still does not recover from all ZK issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6523&quot;&gt;&lt;del&gt;HBASE-6523&lt;/del&gt;&lt;/a&gt; Revert (Revision 1370633)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6523&quot; title=&quot;HConnectionImplementation still does not recover from all ZK issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6523&quot;&gt;&lt;del&gt;HBASE-6523&lt;/del&gt;&lt;/a&gt; HConnectionImplementation still does not recover from all ZK issues. (Revision 1370493)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13448333" author="hudson" created="Wed, 5 Sep 2012 00:57:16 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security-on-Hadoop-23 #7 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/7/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/7/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6523&quot; title=&quot;HConnectionImplementation still does not recover from all ZK issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6523&quot;&gt;&lt;del&gt;HBASE-6523&lt;/del&gt;&lt;/a&gt; Revert (Revision 1370633)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6523&quot; title=&quot;HConnectionImplementation still does not recover from all ZK issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6523&quot;&gt;&lt;del&gt;HBASE-6523&lt;/del&gt;&lt;/a&gt; HConnectionImplementation still does not recover from all ZK issues. (Revision 1370493)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13448502" author="stack" created="Wed, 5 Sep 2012 05:41:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkeywal&quot; class=&quot;user-hover&quot; rel=&quot;nkeywal&quot;&gt;Nicolas Liochon&lt;/a&gt; Should we file an issue on not re-connecting?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12647214">HBASE-8533</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12539688" name="6523.txt" size="1104" author="lhofhansl" created="Tue, 7 Aug 2012 18:26:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 Aug 2012 19:12:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245288</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 15 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i067lj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34162</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>