<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:05:54 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2925/HBASE-2925.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2925] LRU of HConnectionManager.HBASE_INSTANCES breaks if HBaseConfiguration is changed</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2925</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;&lt;tt&gt;HConnectionManager.getConnection(config)&lt;/tt&gt; caches the created &lt;tt&gt;TableServer&lt;/tt&gt; in &lt;tt&gt;HBASE_INSTANCES&lt;/tt&gt; (a &lt;tt&gt;LinkedHashMap&lt;/tt&gt; ) which is keyed by the configuration instance itself.&lt;br/&gt;
Given the current implementation of &lt;tt&gt;hashCode()&lt;/tt&gt; (and &lt;tt&gt;equals()&lt;/tt&gt;) of &lt;tt&gt;HBaseConfiguration&lt;/tt&gt;, the hash code of the configuration is changed if any of its properties are changed, which will cause the keys of &lt;tt&gt;HBASE_INSTANCES&lt;/tt&gt; to be inconsistent with the hashtable that contains them, making some entries unreachable.&lt;br/&gt;
In this case, when the map&apos;s LRU strategy needs to remove the oldest entry, it tries to remove it based on the oldest key, which no longer gives the original hash code, therefore the lookup in &lt;tt&gt;HBASE_INSTANCES.remove(oldest)&lt;/tt&gt; doesn&apos;t actually remove anything.&lt;/p&gt;

&lt;p&gt;This has been observed to lead to OOM errors in long running clients.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12471856">HBASE-2925</key>
            <summary>LRU of HConnectionManager.HBASE_INSTANCES breaks if HBaseConfiguration is changed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rmahfoud">Robert Mahfoud</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Aug 2010 21:27:52 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:13 +0000</updated>
                            <resolved>Mon, 6 Sep 2010 15:52:27 +0000</resolved>
                                    <version>0.20.3</version>
                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12899612" author="rmahfoud" created="Tue, 17 Aug 2010 21:51:15 +0000"  >&lt;p&gt;This is a class that I put together that illustrates this problem and replicate it. Could be used as a basis for the unit test for a patch.&lt;/p&gt;</comment>
                            <comment id="12899617" author="rmahfoud" created="Tue, 17 Aug 2010 22:07:32 +0000"  >&lt;p&gt;The only fix I could think of is to clone the configuration before inserting in the new &lt;tt&gt;TableServer&lt;/tt&gt; in &lt;tt&gt;HBASE_INSTANCES&lt;/tt&gt;. This way, LRU will work since the key cannot be changed since no other object holds a reference to it.&lt;br/&gt;
This will add the overhead of creating a new &lt;tt&gt;HBaseConfiguration&lt;/tt&gt; instance with every connection, which is minimal if the cache works as it should.&lt;/p&gt;</comment>
                            <comment id="12905776" author="stack" created="Fri, 3 Sep 2010 02:59:19 +0000"  >&lt;p&gt;@Robert What if we just removed the dump hash and equals and used object equality instead?  I think it a bit much trying to equate Configuration objects; i.e. they are the same if they have &quot;same&quot; config where &quot;same&quot; is every properties&apos;s hash equates.  If we were to go the route of trying to equate Configurations by the properties they carry, we should equate the values &apos;true&apos;, &apos;True&apos;, &apos;TRUE&apos;, and if a boolean !0 (anything but zero).&lt;/p&gt;

&lt;p&gt;Thanks for filing this issue.&lt;/p&gt;</comment>
                            <comment id="12905778" author="stack" created="Fri, 3 Sep 2010 03:08:31 +0000"  >&lt;p&gt;Hmm... Looks like I thought removing hashcode from HBC a good idea a while back too (See comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1976&quot; title=&quot;HBaseConfiguration implements hashCode() without implementing equals()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1976&quot;&gt;&lt;del&gt;HBASE-1976&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="12905784" author="stack" created="Fri, 3 Sep 2010 04:54:51 +0000"  >&lt;p&gt;Here&apos;s a start.  Its not done yet but shows direction: i.e. removing hashcode and equals from HBC.  TODO, is test that prove that &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1251&quot; title=&quot;HConnectionManager.getConnection(HBaseConfiguration) returns same HConnection for different HBaseConfigurations &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1251&quot;&gt;&lt;del&gt;HBASE-1251&lt;/del&gt;&lt;/a&gt; is still fixed (I think thing to do here is just read configs down in TableServers out of the conf each time rather than once up front so if number of retries is changed mid-use, subsequent invocations will pick up new config. &amp;#8211; let me see).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Removes hashcode and equals from HBC.  Use &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; hashcode instead
of &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and have Configurations with same exact content somehow
equate.

M a/src/main/java/org/apache/hadoop/hbase/HBaseConfiguration.java
  Removed hashCode and equals.
M a/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java
M a/src/main/java/org/apache/hadoop/hbase/util/HMerge.java
M a/src/test/java/org/apache/hadoop/hbase/HBaseClusterTestCase.java
M a/src/test/java/org/apache/hadoop/hbase/util/DisabledTestMetaUtils.java
  Renamed deleteConnectionInfo as deleteConnection.
M a/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java
  Fixed up some comments and javadoc.  Moved a few methods around.
  Use Configuration instance itself as key &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; TableServer instances
  rather than the Configuation hash code &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;.
  Renamed deleteConnectionInfo as deleteConnection.
M a/src/main/java/org/apache/hadoop/hbase/client/HTable.java
  Fixed up javadoc trying to explain implication of not passing
  Configuration constructing an HTable instance.
M a/src/main/java/org/apache/hadoop/hbase/client/HTableFactory.java
  White space removal.
M a/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java
  Added testNewConnectionsDoesNotOOME.  It calls slightly
  refactored Robert Mahfoud illustrative code.  Added assertions.
  Made it not run &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ever.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12905785" author="stack" created="Fri, 3 Sep 2010 04:55:44 +0000"  >&lt;p&gt;Oh Robert, I just noticed that you did not grant Apache license on your test code.  If intentional, np, I&apos;ll back your test out of my patch.  Just say so.&lt;/p&gt;</comment>
                            <comment id="12905987" author="rmahfoud" created="Fri, 3 Sep 2010 17:51:34 +0000"  >&lt;p&gt;@stack, thank you for picking up this issue. Feel free to reuse the code provided in SimpleHConnectionManagerLeakReplicator.java in any way you want. (Let me know if this is not enough I could submit another file with Apache license added.)&lt;/p&gt;

&lt;p&gt;Back to the discussion, I agree that removing the &lt;tt&gt;hasCode()&lt;/tt&gt; and &lt;tt&gt;equals()&lt;/tt&gt; methods does resolve this issue. However, I wonder if it defeats the purpose of having a connection cache from the first place. You also alluded to the problem of the configuration settings changing after the connection is open, which, if we rely solely on Object equality, could lead to subtle error or unexpected behavior.&lt;/p&gt;

&lt;p&gt;Hence my suggestion to pin down the configuration once the TableServers instance is created. The disadvantage there is that small/unrelated changes in the configuration will invalidate the cache entry as well.&lt;/p&gt;

&lt;p&gt;If that is deemed a real problem given the common use cases, I was thinking maybe we define &quot;equality&quot; of the configuration for the purposes of caching as the equality of all properties that start with &lt;tt&gt;hbase.&lt;/tt&gt; or &lt;tt&gt;zk.&lt;/tt&gt; or any other prefix whose properties could be used as possible connection parameters. Not sure if the comparison becomes too slow in that case, but what is more important is whether correctness is compromised if we make the assumption that only properties starting with those prefixes affect the connection.&lt;/p&gt;</comment>
                            <comment id="12906002" author="stack" created="Fri, 3 Sep 2010 18:26:22 +0000"  >&lt;p&gt;@Robert ...I wonder if it defeats the purpose of having a connection cache from the first place.&lt;/p&gt;

&lt;p&gt;As I see it, the main benefit to the cache is saving on region lookups, setup of zk connection, and master proxy setup.  Having the likes of the following config cached is secondary: e.g.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; pause;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numRetries;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxRPCAttempts;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; rpcTimeout;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; prefetchRegionLimit;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In fact, I&apos;m now thinking that if a user changes any of the above in a Configuration that is being used as a key in HCM#HBASE_INSTANCES, that its ok if we don&apos;t notice the change as long as we doc the fact that the Configuration is read on instantiation of the HTable and then no more.  I don&apos;t tthink this should &apos;surprise&apos; the user too much and they can just go create new HTable with the new Configuration if they really want their new config. to take hold (Making things work this way is similar to what you suggest only you would copy the Configuration before adding it as a key).&lt;/p&gt;

&lt;p&gt;As to your last suggestion, I think we should move away from trying to equate Configurations at all; there be daemons that way.&lt;/p&gt;

&lt;p&gt;Let me know what you think.  If you are agreeable, I&apos;ll work up the patch some more mostly adding doc clarifying what we&apos;ve agreed here.&lt;/p&gt;



</comment>
                            <comment id="12906033" author="rmahfoud" created="Fri, 3 Sep 2010 19:27:34 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Making things work this way is similar to what you suggest only you would copy the Configuration before adding it as a key ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is what I had in mind... Sorry if I didn&apos;t make it clear in previous comments.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;... its ok if we don&apos;t notice the change as long as we doc the fact that the Configuration is read on instantiation of the HTable and then no more ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree that these semantics are good for all the use cases I could think of. So feel free to proceed with your patch.&lt;/p&gt;</comment>
                            <comment id="12906056" author="stack" created="Fri, 3 Sep 2010 20:15:09 +0000"  >&lt;p&gt;This version of the patch just adds javadoc to HTable explaining the advantage of shared Configuration &amp;#8211; the sharing of zookeeper connection, cache of region locations, etc.&lt;/p&gt;

&lt;p&gt;If you have a minute, give it a gander Robert and if its good w/ you, I&apos;ll go ahead and commit.&lt;/p&gt;</comment>
                            <comment id="12906429" author="rmahfoud" created="Mon, 6 Sep 2010 04:18:42 +0000"  >&lt;p&gt;You may have left out a couple of print statements in TestHCM. Not sure if that was intentional.    &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hash Code: &quot;&lt;/span&gt; + configuration.hashCode());
      ...
          &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;!! Got same connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; once !!&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Otherwise it&apos;s good to go.&lt;/p&gt;</comment>
                            <comment id="12906526" author="stack" created="Mon, 6 Sep 2010 15:52:27 +0000"  >&lt;p&gt;@Robert Yeah I removed some, left others but also added asserts so tests should fail is regression.  Thanks for doing up the test.  I just committed v2.&lt;/p&gt;</comment>
                            <comment id="15017193" author="lars_francke" created="Fri, 20 Nov 2015 12:42:13 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="12442297">HBASE-2027</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12416529">HBASE-1251</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12440510">HBASE-1976</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12504101">HBASE-3773</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12504210">HBASE-3777</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12453820" name="2925-v2.txt" size="20135" author="stack" created="Fri, 3 Sep 2010 20:15:09 +0000"/>
                            <attachment id="12453747" name="2925.txt" size="17607" author="stack" created="Fri, 3 Sep 2010 04:54:51 +0000"/>
                            <attachment id="12452332" name="SimpleHConnectionManagerLeakReplicator.java" size="3423" author="rmahfoud" created="Tue, 17 Aug 2010 21:51:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 3 Sep 2010 02:59:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26540</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hjv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100480</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>noob</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>