<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:27:31 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5414/HBASE-5414.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5414] Assign different memstoreTS to different KV&apos;s in the same WALEdit during replay</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5414</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5203&quot; title=&quot;Group atomic put/delete operation into a single WALEdit to handle region server failures.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5203&quot;&gt;&lt;del&gt;HBASE-5203&lt;/del&gt;&lt;/a&gt; combines all the different Puts/Deletes into one WALEdit. This is&lt;br/&gt;
required to ensure that we persist the atomic mutation in its enterity and not&lt;br/&gt;
in parts.&lt;/p&gt;

&lt;p&gt;When combined into a single WALEdit, we create one big familyMap that is a combination&lt;br/&gt;
of all the family maps in the mutations. The KV&apos;s in this familyMap have no information&lt;br/&gt;
about memstoreTS (it is not yet assigned).&lt;/p&gt;

&lt;p&gt;However, when we apply the mutations to the Memstore (if there are no failures) we end up&lt;br/&gt;
incrementing the memstoreTS for each operation. &lt;/p&gt;

&lt;p&gt;This can lead to the client seeing different order of operations &amp;#8211; depending on weather or&lt;br/&gt;
not there was a RS crash/restart.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12542904">HBASE-5414</key>
            <summary>Assign different memstoreTS to different KV&apos;s in the same WALEdit during replay</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12499999">HBASE-3584</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="amitanand">Amitanand Aiyer</assignee>
                                    <reporter username="amitanand">Amitanand Aiyer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Feb 2012 19:05:48 +0000</created>
                <updated>Tue, 23 Apr 2013 23:22:18 +0000</updated>
                                                                            <component>Client</component>
                    <component>Coprocessors</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13209639" author="phabricator@reviews.facebook.net" created="Thu, 16 Feb 2012 19:26:59 +0000"  >&lt;p&gt;aaiyer requested code review of &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5414&quot; title=&quot;Assign different memstoreTS to different KV&amp;#39;s in the same WALEdit during replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5414&quot;&gt;HBASE-5414&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; Assign different memstoreTS to different KV&apos;s in the same WALEdit during replay&quot;.&lt;br/&gt;
Reviewers: JIRA&lt;/p&gt;

&lt;p&gt;  Initial diff for splitting the KV&apos;s in the same WALEdit into different&lt;br/&gt;
  memstoreTS operations upon replay.&lt;/p&gt;

&lt;p&gt;  TBD:&lt;br/&gt;
  Running unit tests on MR&lt;br/&gt;
  Need to augument the test suite to reproduce the issue and fix.&lt;/p&gt;

&lt;p&gt;  &amp;lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5203&quot; title=&quot;Group atomic put/delete operation into a single WALEdit to handle region server failures.&quot;&amp;gt;&amp;lt;del&amp;gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5203&quot; title=&quot;Group atomic put/delete operation into a single WALEdit to handle region server failures.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5203&quot;&gt;&lt;del&gt;HBASE-5203&lt;/del&gt;&lt;/a&gt;&amp;lt;/del&amp;gt;&amp;lt;/a&amp;gt; combines all the different Puts/Deletes into one WALEdit. This is&lt;br/&gt;
  required to ensure that we persist the atomic mutation in its enterity and not&lt;br/&gt;
  in parts.&lt;/p&gt;

&lt;p&gt;  When combined into a single WALEdit, we create one big familyMap that is a combination&lt;br/&gt;
  of all the family maps in the mutations. The KV&apos;s in this familyMap have no information&lt;br/&gt;
  about memstoreTS (it is not yet assigned).&lt;/p&gt;

&lt;p&gt;  However, when we apply the mutations to the Memstore (if there are no failures) we end up&lt;br/&gt;
  incrementing the memstoreTS for each operation.&lt;/p&gt;

&lt;p&gt;  This can lead to the client seeing different order of operations &amp;#8211; depending on weather or&lt;br/&gt;
  not there was a RS crash/restart.&lt;/p&gt;

&lt;p&gt;TEST PLAN&lt;br/&gt;
  EMPTY&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1749&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1749&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;/p&gt;


&lt;p&gt;MANAGE HERALD DIFFERENTIAL RULES&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/herald/view/differential/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/herald/view/differential/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;WHY DID I GET THIS EMAIL?&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/herald/transcript/3741/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/herald/transcript/3741/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Tip: use the X-Herald-Rules header to filter Herald messages in your client.&lt;/p&gt;</comment>
                            <comment id="13209640" author="phabricator@reviews.facebook.net" created="Thu, 16 Feb 2012 19:27:00 +0000"  >&lt;p&gt;aaiyer has commented on the revision &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5414&quot; title=&quot;Assign different memstoreTS to different KV&amp;#39;s in the same WALEdit during replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5414&quot;&gt;HBASE-5414&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; Assign different memstoreTS to different KV&apos;s in the same WALEdit during replay&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  :2839 TBD: fix comments length.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1749&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1749&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13209657" author="phabricator@reviews.facebook.net" created="Thu, 16 Feb 2012 19:42:57 +0000"  >&lt;p&gt;stack has commented on the revision &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5414&quot; title=&quot;Assign different memstoreTS to different KV&amp;#39;s in the same WALEdit during replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5414&quot;&gt;HBASE-5414&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; Assign different memstoreTS to different KV&apos;s in the same WALEdit during replay&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  :2842 Is this enough?  What if the edits have same timestamp?  Should we bump the memstoreTSAtStartup then too?&lt;/p&gt;

&lt;p&gt;  Is memstoreTs a good name?  Should it be memstoreSeqnumber (This would be a big change and I don&apos;t expect it as part of this patch &amp;#8211; just raising the point)&lt;br/&gt;
  :2856 Why this increment?  Is it a just-in-case?&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1749&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1749&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13209675" author="kannanm" created="Thu, 16 Feb 2012 19:58:51 +0000"  >&lt;p&gt;Amit: &lt;/p&gt;

&lt;p&gt;Aren&apos;t there three pieces of the puzzle to ensure that a atomic row mutation (RowMutations) which contains a Delete &amp;amp; a Put, for example:&lt;/p&gt;

&lt;p&gt;   RowMutations(Delete R1.CF         @ NOW,  // delete the row in this CF&lt;br/&gt;
                Put    R1.CF.c1 = v1 @ NOW)  // and atomically add back a column for this row in this CF&lt;/p&gt;

&lt;p&gt;can guarantee that the Put wins over the Delete even though both happened at the same NOW timestamp.&lt;/p&gt;

&lt;p&gt;part 1) On insert, making sure the Put gets a higher memstoreTS than the Delete even thought they have the same TS.&lt;br/&gt;
part 2) On recovery (that&apos;s the piece that this JIRA seems to be covering).&lt;br/&gt;
part 3) On flush/compactions, etc. not doing the space optimization to clear out memstoreTS to 0 even if the read point for the active scanners has moved on, unless it is a major compaction where we lose the Delete markers.&lt;/p&gt;

&lt;p&gt;Do we not need parts #1 &amp;amp; #3? Or where you planning to do those as separate tasks?&lt;/p&gt;


</comment>
                            <comment id="13209684" author="stack" created="Thu, 16 Feb 2012 20:08:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;....can guarantee that the Put wins over the Delete even though both happened at the same NOW timestamp&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Trying to understand... I don&apos;t get it Kannan.  If they both went in together at same TS, doesn&apos;t the Delete sort before the Put so we&apos;d see it first... so it would overshadow the contemporaneous Put?&lt;/p&gt;</comment>
                            <comment id="13209776" author="phabricator@reviews.facebook.net" created="Thu, 16 Feb 2012 21:50:59 +0000"  >&lt;p&gt;aaiyer has commented on the revision &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5414&quot; title=&quot;Assign different memstoreTS to different KV&amp;#39;s in the same WALEdit during replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5414&quot;&gt;HBASE-5414&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; Assign different memstoreTS to different KV&apos;s in the same WALEdit during replay&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java:2842 Agreed.&lt;/p&gt;


&lt;p&gt;  Keeping track of the timestamp might be tricky.We could bump up the memstoreTS for every KV that we see. this will resolve the contention between Put/Put as well. The current approach does not.&lt;/p&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java:2856 Kind of .... This is to increment the memstoreTS across &lt;b&gt;different&lt;/b&gt; WALEdits.&lt;/p&gt;

&lt;p&gt;  The one inside the loop is incremented when we see different types within the &lt;b&gt;same&lt;/b&gt; WALEdit.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1749&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1749&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13209781" author="amitanand" created="Thu, 16 Feb 2012 21:55:28 +0000"  >&lt;p&gt;@Stack. Yes. That is the current behavior.&lt;/p&gt;

&lt;p&gt;What we are trying to get is to see if we can provide  a semantics where .... the client is able to specify the order in which the operations are applied. (This is already the case wrt the implementation, because we loop through the mutations in the AtomicRowMutation and apply them one by one &amp;#8211; in the same order in which they were applied.)&lt;/p&gt;

&lt;p&gt;So, part 1) seems to have been automatically addressed. Except for the corner race-condition which we will need to fix, so scans/gets do not see a partial application of a AtomicRowMutation.&lt;/p&gt;
</comment>
                            <comment id="13209822" author="amitanand" created="Thu, 16 Feb 2012 22:32:29 +0000"  >&lt;p&gt;My bad. we were indeed using the same memstoreTS for all the mutations in the RowMutation. So, delete would win automatically.&lt;/p&gt;

&lt;p&gt;Created a jira/updated  a patch so we can ensure that the winning update is determined based on the order in which the client adds operations to RowMutations.&lt;/p&gt;</comment>
                            <comment id="13209838" author="amitanand" created="Thu, 16 Feb 2012 22:42:13 +0000"  >&lt;p&gt;There seem to be 3 approachs we can take in terms of how we split the WALEdit into different batch of mutations (with same memstoreTS).&lt;/p&gt;

&lt;p&gt;Option &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;: Current approach. Split when we see a change in KV&apos;s type (Delete --&amp;gt; Put, or Put --&amp;gt; Delete). &lt;/p&gt;

&lt;p&gt;   Not very accurate. We might combine multiple Put mutations into one mutation. But, this should be relatively insignificant.&lt;/p&gt;

&lt;p&gt;Option (ii): Split per KV. Give a different memstoreTS to each KV.&lt;/p&gt;

&lt;p&gt;   We might be splitting a single mutation into multiple parts. But, this should not be a problem. No readers start until the replay is done.&lt;/p&gt;

&lt;p&gt;Option (iii): Find a way to mark the exact boundary. &lt;br/&gt;
   Will entail inserting a &quot;dummy/sentinel&quot; KV into the WALEdit to represent the boundary. &lt;/p&gt;</comment>
                            <comment id="13234587" author="lhofhansl" created="Wed, 21 Mar 2012 17:49:08 +0000"  >&lt;p&gt;@Amit: You want this in 0.94? Is it ready?&lt;/p&gt;</comment>
                            <comment id="13639816" author="stack" created="Tue, 23 Apr 2013 23:22:18 +0000"  >&lt;p&gt;Moving issue w/ no movement out of 0.95&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12514847" name="ASF.LICENSE.NOT.GRANTED--HBASE-5414.D1749.1.patch" size="2539" author="phabricator@reviews.facebook.net" created="Thu, 16 Feb 2012 19:26:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 16 Feb 2012 19:26:59 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>228190</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 34 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0htdj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>102021</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>