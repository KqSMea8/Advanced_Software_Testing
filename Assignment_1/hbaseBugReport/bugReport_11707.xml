<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:25:51 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11707/HBASE-11707.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11707] Using Map instead of list in FailedServers of RpcClient</title>
                <link>https://issues.apache.org/jira/browse/HBASE-11707</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Currently, FailedServers uses a list to record the black list of servers and iterate the list to check if a server is in list. It&apos;s not efficient when the list is very large. And the list is not thread safe for the add and iteration operations.&lt;/p&gt;

&lt;p&gt;RpcClient.java#175&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-comment&quot;&gt;// iterate, looking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the search entry and cleaning expired entries
&lt;/span&gt;      Iterator&amp;lt;Pair&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; it = failedServers.iterator();
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (it.hasNext()) {
        Pair&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; cur = it.next();
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cur.getFirst() &amp;lt; now) {
          it.remove();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lookup.equals(cur.getSecond())) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
          }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A simple change is to change this list to ConcurrentHashMap.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12732824">HBASE-11707</key>
            <summary>Using Map instead of list in FailedServers of RpcClient</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="10002" iconUrl="https://issues.apache.org/jira/images/icons/statuses/document.png" description="A patch for this issue has been uploaded to JIRA by a contributor.">Patch Available</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="liushaohui">Liu Shaohui</assignee>
                                    <reporter username="liushaohui">Liu Shaohui</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Aug 2014 12:49:30 +0000</created>
                <updated>Tue, 12 Aug 2014 08:17:21 +0000</updated>
                                                            <fixVersion>2.0.0</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="14090731" author="liushaohui" created="Fri, 8 Aug 2014 12:59:28 +0000"  >&lt;p&gt;A simple patch&lt;/p&gt;</comment>
                            <comment id="14090745" author="nkeywal" created="Fri, 8 Aug 2014 13:25:19 +0000"  >&lt;p&gt;You had this issue in production?&lt;/p&gt;

&lt;p&gt;The access to the list are protected by a synchronized at the method level, so we don&apos;t need the volatile or the concurrentMap (or you could remove the synchronized and check that there is no nasty race conditions).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (now &amp;gt; latestExpiry) {
+    	  failedServers.clear();
+    	  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It seems we&apos;re going to clear the map all the time if there are no failures. Is it cheap to clear an empty map?&lt;/p&gt;

&lt;p&gt;From a functional point of view, it looks like that the patch is ok.&lt;/p&gt;</comment>
                            <comment id="14092767" author="liushaohui" created="Mon, 11 Aug 2014 13:45:47 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;~liochon&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;You had this issue in production?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, just revisit the code and find this problem.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The access to the list are protected by a synchronized at the method level, so we don&apos;t need the volatile or the concurrentMap (or you could remove the synchronized and check that there is no nasty race conditions).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The isFailedServer and addToFailedServers method may run concurently, so i use the concurrentMap.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;It seems we&apos;re going to clear the map all the time if there are no failures. Is it cheap to clear an empty map?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No. If there are no failures the map will not be cleaned.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFailedServer(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; InetSocketAddress address) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (failedServers.isEmpty()) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14092786" author="nkeywal" created="Mon, 11 Aug 2014 14:05:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;The isFailedServer and addToFailedServers method may run concurently, so i use the concurrentMap.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The two methods (isFailedServer and addToFailedServers) are synchronized. What&apos;s the concurrency issue?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;No. If there are no failures the map will not be cleaned.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed.&lt;/p&gt;
</comment>
                            <comment id="14093688" author="liushaohui" created="Tue, 12 Aug 2014 03:39:57 +0000"  >&lt;p&gt;Thanks for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkeywal&quot; class=&quot;user-hover&quot; rel=&quot;nkeywal&quot;&gt;Nicolas Liochon&lt;/a&gt;&apos;s review.&lt;/p&gt;</comment>
                            <comment id="14093691" author="liushaohui" created="Tue, 12 Aug 2014 03:43:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkeywal&quot; class=&quot;user-hover&quot; rel=&quot;nkeywal&quot;&gt;Nicolas Liochon&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The isFailedServer and addToFailedServers method may run concurently, so i use the concurrentMap.&lt;br/&gt;
The two methods (isFailedServer and addToFailedServers) are synchronized. What&apos;s the concurrency issue?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s my mistake. Thank you for pointing out it.&lt;/p&gt;
</comment>
                            <comment id="14093885" author="nkeywal" created="Tue, 12 Aug 2014 08:17:21 +0000"  >&lt;p&gt;+1 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12660623" name="HBASE-11707-trunk-v1.diff" size="2938" author="liushaohui" created="Fri, 8 Aug 2014 12:59:28 +0000"/>
                            <attachment id="12661129" name="HBASE-11707-trunk-v2.diff" size="2614" author="liushaohui" created="Tue, 12 Aug 2014 03:39:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 8 Aug 2014 13:25:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410852</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 18 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yoov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410845</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>