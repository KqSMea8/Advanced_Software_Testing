<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:39:40 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6768/HBASE-6768.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6768] HBase Rest server crashes if client tries to retrieve data size &gt; 5 MB</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6768</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I have a CF with one qualifier, data size is &amp;gt; 5 MB, when i try to read the raw binary data as octet-stream using curl, rest server got crashed and curl throws exception as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 curl -v -H &lt;span class=&quot;code-quote&quot;&gt;&quot;Accept: application/octet-stream&quot;&lt;/span&gt; http:&lt;span class=&quot;code-comment&quot;&gt;//abcdefgh-hbase003.test1.test.com:9090/table1/row_key1/cf:qualifer1 &amp;gt; /tmp/out
&lt;/span&gt;
* About to connect() to abcdefgh-hbase003.test1.test.com port 9090
*   Trying xx.xx.xx.xxx... connected
* Connected to abcdefgh-hbase003.test1.test.com (xx.xxx.xx.xxx) port 9090
&amp;gt; GET /table1/row_key1/cf:qualifer1 HTTP/1.1
&amp;gt; User-Agent: curl/7.15.5 (x86_64-redhat-linux-gnu) libcurl/7.15.5 OpenSSL/0.9.8b zlib/1.2.3 libidn/0.6.5
&amp;gt; Host: abcdefgh-hbase003.test1.test.com:9090
&amp;gt; Accept: application/octet-stream
&amp;gt; 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:--  0:00:02 --:--:--     0&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Length: 5129836
&amp;lt; X-Timestamp: 1347338813129
&amp;lt; Content-Type: application/octet-stream
  0 5009k    0 16272    0     0   7460      0  0:11:27  0:00:02  0:11:25 13872transfer closed with 1148524 bytes remaining to read
 77 5009k   77 3888k    0     0  1765k      0  0:00:02  0:00:02 --:--:-- 3253k* Closing connection #0

curl: (18) transfer closed with 1148524 bytes remaining to read

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Couldn&apos;t find the exception in rest server log or no core dump either. This issue is constantly reproducible. Even i tried with HBase Rest client (HRemoteTable) and i could recreate this issue if the data size is &amp;gt; 10 MB (even with MIME_PROTOBUF accept header)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12607357">HBASE-6768</key>
            <summary>HBase Rest server crashes if client tries to retrieve data size &gt; 5 MB</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="jxiang">Jimmy Xiang</assignee>
                                    <reporter username="mubarakseyed">Mubarak Seyed</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Sep 2012 22:54:31 +0000</created>
                <updated>Tue, 5 Aug 2014 20:11:42 +0000</updated>
                            <resolved>Sat, 5 Jan 2013 00:11:55 +0000</resolved>
                                    <version>0.90.5</version>
                                                    <component>REST</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13455054" author="apurtell" created="Thu, 13 Sep 2012 17:35:11 +0000"  >&lt;p&gt;Are you running REST with &lt;tt&gt;-XX:OnOutOfMemoryError=&quot;kill -9 %p&quot;&lt;/tt&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4769&quot; title=&quot;Abort RegionServer Immediately on OOME&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4769&quot;&gt;&lt;del&gt;HBASE-4769&lt;/del&gt;&lt;/a&gt;)? That is one reason why a HBase process might be dead with nothing logged and no hs_err file. &lt;/p&gt;

&lt;p&gt;Have you tried setting/increasing MaxDirectMemory, e.g. &lt;tt&gt;-XX:MaxDirectMemorySize=$LARGE_VALUE&lt;/tt&gt;? &lt;/p&gt;</comment>
                            <comment id="13473508" author="gdmeda" created="Wed, 10 Oct 2012 19:49:59 +0000"  >&lt;p&gt;Hi Andrew, we actually had similar error too and I had set the -XX:MaxDirectMemorySize=1024m and it just decreased the rate at which memory got filled, but we are still seeing OOME.&lt;/p&gt;</comment>
                            <comment id="13473819" author="stack" created="Thu, 11 Oct 2012 04:01:17 +0000"  >&lt;p&gt;Get it to dump the heap and take a look and see what big objects it has?  Was there anything much else going on when you went for this 5MB object?&lt;/p&gt;</comment>
                            <comment id="13543458" author="jxiang" created="Fri, 4 Jan 2013 00:29:03 +0000"  >&lt;p&gt;With 0.92, I could not reproduce this issue. I can get a column &amp;gt; 10MB (Content-Length: 11485760):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;* About to connect() to test-1 port 8080 (#0)
*   Trying 10.20.204.199...   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0connected
* Connected to test-1 (10.20.204.199) port 8080 (#0)
&amp;gt; GET /usertable/row_4/f:row_4 HTTP/1.1
&amp;gt; User-Agent: curl/7.21.6 (x86_64-pc-linux-gnu) libcurl/7.21.6 OpenSSL/1.0.0e zlib/1.2.3.4 libidn/1.22 librtmp/2.3
&amp;gt; Host: test-1:8080
&amp;gt; Accept: application/octet-stream
&amp;gt; 
  0     0    0     0    0     0      0      0 --:--:--  0:00:03 --:--:--     0&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Length: 11485760
&amp;lt; X-Timestamp: 1357249057636
&amp;lt; Content-Type: application/octet-stream
&amp;lt; 
{ [data not shown]
100 10.9M  100 10.9M    0     0  3078k      0  0:00:03  0:00:03 --:--:-- 3081k
* Connection #0 to host test-1 left intact
* Closing connection #0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13543461" author="mubarakseyed" created="Fri, 4 Jan 2013 00:32:46 +0000"  >&lt;p&gt;Jimmy,&lt;br/&gt;
Have you tried using concurrent readers? like 100+ concurrent curl commands?&lt;/p&gt;</comment>
                            <comment id="13543463" author="apurtell" created="Fri, 4 Jan 2013 00:36:04 +0000"  >&lt;p&gt;How is that not just an OOME from too many concurrent fetches of large objects? HBase clients (like REST) don&apos;t stream values from the server, RPC brings them over all at once. Then they are served out.&lt;/p&gt;</comment>
                            <comment id="13543469" author="jxiang" created="Fri, 4 Jan 2013 00:44:22 +0000"  >&lt;p&gt;With many concurrent curl commands, the REST server will OOM very likely. In this case, I don&apos;t think there are much we can do, right?&lt;/p&gt;</comment>
                            <comment id="13543499" author="apurtell" created="Fri, 4 Jan 2013 01:18:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;With many concurrent curl commands, the REST server will OOM very likely. In this case, I don&apos;t think there are much we can do, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, REST has limits. To avoid the cost of HTTP overheads in cases of scanning or multigets, REST has been designed to build the response &amp;#8211; issuing multiple RPCs to the HBase cluster to do so &amp;#8211; and then send the response back to the client all in one HTTP transaction. If a client request produces a really big response, it has to fit in heap on the REST gateway. REST scanners do their own batching to handle large datasets in chunks. For a given row request however we can&apos;t divide it up, or request byte sub-ranges of values from the RegionServers. First the Result (a row) is assembled from the Get or Scan results inside the HBase client library. Then REST builds a model from the Result, which ends up copying all of the data, because REST came before KV, so its representation (Cell) predates it. Then the model is sent out by Jersey/Jetty. The Result becomes a candidate for GC as soon as the model is finished. The model is a candidate for GC as soon as Jersey finishes the request. &lt;/p&gt;

&lt;p&gt;Edit: So if the REST URL is a request for an entire row, the data in the row must fit in heap (x ~2). If the REST URL is a request for a large cell (100s of MB), likewise. Multiply by concurrent connections expected. Like with HBase in general, storing large values should be avoided. Put big blobs in HDFS. As far as I know the Thrift gateway operates similarly. For large rows or large cells, direct cluster access via Java API is the best option.&lt;/p&gt;

&lt;p&gt;There are probably some clever things we can do to reduce copying, especially if we also consider changing the client library at the same time, but to date this hasn&apos;t been urgent enough to try.&lt;/p&gt;</comment>
                            <comment id="13543506" author="apurtell" created="Fri, 4 Jan 2013 01:29:13 +0000"  >&lt;p&gt;One thing I would probably do in the context of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2677&quot; title=&quot;REST interface improvements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2677&quot;&gt;HBASE-2677&lt;/a&gt; is change the representation to be a stream of KeyValue entities, then set up a chunked encoding for transfer, then transfer the result set in parts.&lt;/p&gt;</comment>
                            <comment id="13543534" author="mubarakseyed" created="Fri, 4 Jan 2013 02:18:51 +0000"  >&lt;p&gt;Thanks Andy. Do you think that we can add an option to throttle the GET request if the value for a row / CF / CF;qualifier exceeds the defined value (as like &lt;tt&gt;hbase.client.keyvalue.maxsize&lt;/tt&gt; for PUT)?&lt;/p&gt;</comment>
                            <comment id="13543545" author="mubarakseyed" created="Fri, 4 Jan 2013 02:27:08 +0000"  >&lt;p&gt;I meant GET request using REST interface in my previous comment. Thanks.&lt;/p&gt;</comment>
                            <comment id="13543579" author="jxiang" created="Fri, 4 Jan 2013 03:41:48 +0000"  >&lt;p&gt;Thanks Andy for the clarification.  Should we close this issue now?&lt;/p&gt;

&lt;p&gt;@Mubarak, even if we have some option to limit the value size, we also limit the number of concurrent accesses.  As I remember by default a Jetty server supports about 4000 concurrent threads. I think rest server has to get the data at first, then to find its size.&lt;/p&gt;</comment>
                            <comment id="13544025" author="apurtell" created="Fri, 4 Jan 2013 16:59:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think rest server has to get the data at first, then to find its size.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes. So size limits won&apos;t work. But concurrency limits could.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;As I remember by default a Jetty server supports about 4000 concurrent threads.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is an interesting idea. We could tune down the Jetty connector&apos;s concurrency to ~100 with a comment as to why?&lt;/p&gt;
</comment>
                            <comment id="13544105" author="jxiang" created="Fri, 4 Jan 2013 18:39:21 +0000"  >&lt;p&gt;My fault, I double-checked.  The default thread pool can have maximum 250 threads, not 4000. I was wondering if we need to make this configurable.  If it is configurable, will it help us in this case?&lt;/p&gt;</comment>
                            <comment id="13544145" author="mubarakseyed" created="Fri, 4 Jan 2013 19:28:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;I was wondering if we need to make this configurable. If it is configurable, will it help us in this case?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yup, it helps us, we are having issue when load peaks and ~20% of the time we are seeing OOM.&lt;/p&gt;</comment>
                            <comment id="13544165" author="jxiang" created="Fri, 4 Jan 2013 19:38:03 +0000"  >&lt;p&gt;Cool, I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7498&quot; title=&quot;Make REST server thread pool size configurable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7498&quot;&gt;&lt;del&gt;HBASE-7498&lt;/del&gt;&lt;/a&gt; to make the thread number configurable.  I will close this one as Won&apos;t Fix tomorrow if no objection.&lt;/p&gt;</comment>
                            <comment id="13544177" author="mubarakseyed" created="Fri, 4 Jan 2013 19:45:12 +0000"  >&lt;p&gt;Thanks Jimmy and Andy. Please close this one.&lt;/p&gt;</comment>
                            <comment id="13544375" author="jxiang" created="Sat, 5 Jan 2013 00:11:55 +0000"  >&lt;p&gt;We will fix the related issue &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7498&quot; title=&quot;Make REST server thread pool size configurable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7498&quot;&gt;&lt;del&gt;HBASE-7498&lt;/del&gt;&lt;/a&gt;, which may reduce the OOM number if configured properly.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12626106">HBASE-7498</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12466315">HBASE-2677</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 13 Sep 2012 17:35:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241764</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02cg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11618</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>