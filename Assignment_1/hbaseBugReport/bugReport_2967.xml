<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:06:16 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2967/HBASE-2967.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2967] Failed split: IOE &apos;File is Corrupt!&apos; -- sync length not being written out to SequenceFile</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2967</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We saw this on one of our clusters:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-09-07 18:07:16,229 WARN org.apache.hadoop.hbase.master.RegionServerOperationQueue: Failed processing: ProcessServerShutdown of sv4borg18,60020,1283516293515; putting onto delayed todo queue
java.io.IOException: File is corrupt!
        at org.apache.hadoop.io.SequenceFile$Reader.readRecordLength(SequenceFile.java:1907)
        at org.apache.hadoop.io.SequenceFile$Reader.next(SequenceFile.java:1932)
        at org.apache.hadoop.io.SequenceFile$Reader.next(SequenceFile.java:1837)
        at org.apache.hadoop.io.SequenceFile$Reader.next(SequenceFile.java:1883)
        at org.apache.hadoop.hbase.regionserver.wal.SequenceFileLogReader.next(SequenceFileLogReader.java:121)
        at org.apache.hadoop.hbase.regionserver.wal.SequenceFileLogReader.next(SequenceFileLogReader.java:113)
        at org.apache.hadoop.hbase.regionserver.wal.HLog.parseHLog(HLog.java:1493)
        at org.apache.hadoop.hbase.regionserver.wal.HLog.splitLog(HLog.java:1256)
        at org.apache.hadoop.hbase.regionserver.wal.HLog.splitLog(HLog.java:1143)
        at org.apache.hadoop.hbase.master.ProcessServerShutdown.process(ProcessServerShutdown.java:299)
        at org.apache.hadoop.hbase.master.RegionServerOperationQueue.process(RegionServerOperationQueue.java:147)
        at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:532)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because it was an IOE, it got requeued.  Each time around we failed on it again.&lt;/p&gt;

&lt;p&gt;A few things:&lt;/p&gt;

&lt;p&gt;+ This exception needs to add filename and the position in file at which problem found.&lt;br/&gt;
+ Need to commit little patch over in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2889&quot; title=&quot;Tool to look at HLogs -- parse and tail -f&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2889&quot;&gt;&lt;del&gt;HBASE-2889&lt;/del&gt;&lt;/a&gt; that outputs position and ordinal of wal edit because it helps diagnose these kinds of issues.&lt;br/&gt;
+ We should be able to skip the bad edit; just postion ourselves at byte past the bad sync and start reading again&lt;br/&gt;
+ There must be something about our setup that makes it so we fail write of the sync 16 random bytes that make up the SF &apos;sync&apos; marker though oddly for one of the files, the sync failure happens at 1/3rd of the way into a 64MB wal, edit #2000 out of 130k odd edits.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12473532">HBASE-2967</key>
            <summary>Failed split: IOE &apos;File is Corrupt!&apos; -- sync length not being written out to SequenceFile</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Sep 2010 06:25:15 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:31 +0000</updated>
                            <resolved>Wed, 8 Sep 2010 21:23:41 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12907433" author="stack" created="Wed, 8 Sep 2010 21:13:41 +0000"  >&lt;p&gt;I got the lowdown from Todd. &lt;/p&gt;

&lt;p&gt;Problem would seem to be here in SequenceFile:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    /** create a sync point */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void sync() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sync != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; lastSyncPos != out.getPos()) {
        out.writeInt(SYNC_ESCAPE);                &lt;span class=&quot;code-comment&quot;&gt;// mark the start of the sync
&lt;/span&gt;        out.write(sync);                          &lt;span class=&quot;code-comment&quot;&gt;// write sync
&lt;/span&gt;        lastSyncPos = out.getPos();               &lt;span class=&quot;code-comment&quot;&gt;// update lastSyncPos
&lt;/span&gt;      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Notice how the method is unsynchronized and how it does two distinct writes to out.&lt;/p&gt;

&lt;p&gt;If you browse down in SequenceFile to the append methods, you&apos;ll see that these methods ARE synchronized.&lt;/p&gt;

&lt;p&gt;In concurrent times, you could imagine the above write of SYNC_ESCAPE followed by the actual 16 bytes of the sync array being interpolated by an append.  On read, we&apos;d fail the sync check.&lt;/p&gt;

&lt;p&gt;So, not calling the sync would seem to be the way to go (This is what CDH does according to Todd).  But says you, what if we ever want to make use of these sync sequences to skip records corrupted by cosmic rays up in HDFS?  Well, turns out SF calls checkAndWriteSync internal to the append calls and will write the sync out at every SYNC_INTERVAL... so when we want to come back and handle these &apos;File is Corrupt!&apos; messages later, we can.&lt;/p&gt;

&lt;p&gt;Here&apos;s the change I&apos;ll make:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: src/main/java/org/apache/hadoop/hbase/regionserver/wal/SequenceFileLogWriter.java
===================================================================
--- src/main/java/org/apache/hadoop/hbase/regionserver/wal/SequenceFileLogWriter.java   (revision 995156)
+++ src/main/java/org/apache/hadoop/hbase/regionserver/wal/SequenceFileLogWriter.java   (working copy)
@@ -120,7 +120,6 @@
 
   @Override
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void sync() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
-    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.writer.sync();
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.syncFs != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.syncFs.invoke(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.writer, HLog.NO_ARGS);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Regards other items in the above, over in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2889&quot; title=&quot;Tool to look at HLogs -- parse and tail -f&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2889&quot;&gt;&lt;del&gt;HBASE-2889&lt;/del&gt;&lt;/a&gt;, we add logging of filename+position to exception and did some fixup on HLog main to help diagnose these kinds of issues&lt;/p&gt;
</comment>
                            <comment id="12907437" author="stack" created="Wed, 8 Sep 2010 21:23:41 +0000"  >&lt;p&gt;Committed branch and trunk.&lt;/p&gt;</comment>
                            <comment id="12907478" author="stack" created="Wed, 8 Sep 2010 23:17:58 +0000"  >&lt;p&gt;So, looking at a snapshot of log files on our production, about 1/2 had this issue.  After rolling out the above change, subsequent log files are again parseable.&lt;/p&gt;</comment>
                            <comment id="15017272" author="lars_francke" created="Fri, 20 Nov 2015 12:42:31 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 20 Nov 2015 12:42:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26561</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hk2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100514</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>