<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:01:02 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2338/HBASE-2338.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2338] log recovery: deleted items may be resurrected</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2338</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2283&quot; title=&quot;row level atomicity &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2283&quot;&gt;&lt;del&gt;HBASE-2283&lt;/del&gt;&lt;/a&gt;, noticed that if you do a put followed by a delete, and then crash the RS, and trigger log recovery to happen, then deleted entries may be resurrected. &lt;/p&gt;

&lt;p&gt;Suprisingly, the issue only affected delete of a specific column. Full row delete didn&apos;t run into this issue.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;Code inspection revealed that we might have an issue with timestamps &amp;amp; WAL stuff for delete that come in with &quot;LATEST&quot; timestamp. &lt;span class=&quot;error&quot;&gt;&amp;#91;Note: The &amp;quot;LATEST&amp;quot; timestamp is syntax sugar/hint to the RS to convert it to &amp;quot;now&amp;quot;. &amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Basically, in:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
delete(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] family, List&amp;lt;KeyValue&amp;gt; kvs, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; writeToWAL)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the &quot;kv.updateLatestStamp(byteNow);&quot; time stamp massaging (from LATEST to now) happens &lt;b&gt;after&lt;/b&gt; the WAL log.append() call. So the KeyValue entries written to the HLog do not have the massaged timestamp. On recovery, when these entries are replayed, we add them back to reconstructionCache but don&apos;t do anything with timestamps. &lt;/p&gt;

&lt;p&gt;The above could be the potential source of the problem. But there could be more to the problem than my simple analysis. For instance, we still don&apos;t know why full row delete worked fine, but delete of a specific column didn&apos;t work ok. Forking this off as a separate issue from &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2283&quot; title=&quot;row level atomicity &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2283&quot;&gt;&lt;del&gt;HBASE-2283&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Note: Aravind is starting to take a look at this issue.&amp;#93;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12459407">HBASE-2338</key>
            <summary>log recovery: deleted items may be resurrected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aravind.menon">Aravind Menon</assignee>
                                    <reporter username="kannanm">Kannan Muthukkaruppan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Mar 2010 17:34:05 +0000</created>
                <updated>Fri, 20 Nov 2015 12:44:08 +0000</updated>
                            <resolved>Thu, 1 Apr 2010 13:29:14 +0000</resolved>
                                    <version>0.20.4</version>
                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="12848891" author="aravind.menon" created="Tue, 23 Mar 2010 20:25:48 +0000"  >&lt;p&gt;When keys for a particular key version are deleted, the timestamp of the delete key-value pair must match the timestamp of the put key-value. Currently, this timestamp is fixed only in the memstore and not in the log file. The result is that if the regionserver crashes before flushing memstore to a store file, the delete is lost on recovery. This patch fixes it so that the log file and memstore k-v pairs have identical timestamp.&lt;/p&gt;</comment>
                            <comment id="12850249" author="stack" created="Fri, 26 Mar 2010 17:48:21 +0000"  >&lt;p&gt;Patch looks good except for this change:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;K: &quot;&lt;/span&gt; + Bytes.toStringBinary(kv.getKey()) +
+            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;K: &quot;&lt;/span&gt; + kv +
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does that do the right thing?  Print out the key only?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;
</comment>
                            <comment id="12850293" author="kannanm" created="Fri, 26 Mar 2010 18:38:57 +0000"  >&lt;p&gt;Yes, it prints out the key only. We wondered about that too... but checked the output and the code to confirm.&lt;/p&gt;</comment>
                            <comment id="12850461" author="ryanobjc" created="Sat, 27 Mar 2010 02:34:32 +0000"  >&lt;p&gt;not only does it only print out the key, it prints out the key in&lt;br/&gt;
formatted form and includes the value length.&lt;/p&gt;

&lt;p&gt;On Fri, Mar 26, 2010 at 11:40 AM, Kannan Muthukkaruppan (JIRA)&lt;/p&gt;</comment>
                            <comment id="12850637" author="stack" created="Sun, 28 Mar 2010 05:16:05 +0000"  >&lt;p&gt;Committed to branch and trunk.  Thanks for the patch Aravind.  Makes sense now after looking &amp;#8211; the lone kv is actually kv.toString().&lt;/p&gt;</comment>
                            <comment id="12851184" author="stack" created="Tue, 30 Mar 2010 00:47:24 +0000"  >&lt;p&gt;Commit broke build.  Reopening.  TestClient.testDeletes fails.  We add two values each at different timestamps.  We then do two deletes w/o ts.  This should be purging both values but seems to only get rid of one.  I&apos;m taking a look at it...&lt;/p&gt;</comment>
                            <comment id="12851194" author="aravind.menon" created="Tue, 30 Mar 2010 01:16:08 +0000"  >&lt;p&gt;This seems to be an intermittent error. Kannan and I are seeing occasional failure of TestCLient.testDeletes, but this is not consistent, it passes several times also. Seems like a timing related issue. We are looking into this.&lt;/p&gt;</comment>
                            <comment id="12851233" author="aravind.menon" created="Tue, 30 Mar 2010 03:41:43 +0000"  >&lt;p&gt;I think we found the issue. testDelete fails when we try to delete the two latest versions of the same column within a column family. The specific test that fails is the following (TestClient.java, line 1585, simplified):&lt;/p&gt;

&lt;p&gt;put. = new Put(ROWS&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;);&lt;br/&gt;
put.add(FAMILIES&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, QUALIFIER, ts&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, VALUES&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;);&lt;br/&gt;
put.add(FAMILIES&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, QUALIFIER, ts&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, VALUES&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt;
ht.put(put);&lt;/p&gt;

&lt;p&gt;delete = new Delete(ROWS&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;);&lt;br/&gt;
delete.deleteColumn(FAMILIES&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, QUALIFIER);&lt;br/&gt;
delete.deleteColumn(FAMILIES&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, QUALIFIER);&lt;/p&gt;

&lt;p&gt;get = new Get(ROWS&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;);&lt;br/&gt;
get.addFamily(FAMILIES&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt;
get.setMaxVersions(Integer.MAX_VALUE);&lt;br/&gt;
result = ht.get(get);&lt;br/&gt;
assertTrue(&quot;Expected 0 key but received &quot; + result.size(),&lt;br/&gt;
        result.size() == 0);&lt;/p&gt;

&lt;p&gt;Previously for deleting specific column versions, after deleting a particular keyvalue, the memstore was immediately updated, before the next delete was processed in the loop (HRegion.java, line 1215). Thus, on deleting subsequent keyvalues, the &quot;get&quot; to retrieve the latest timestamp would return the correct value. &lt;/p&gt;

&lt;p&gt;With the patch, we have changed the memstore update order. The timestamps for all keyvalues are updated first, before the keyvalues are written to log and memstore. So, if there are two deletes, they would both see the same latest version number for that column, and both would delete the same version. &lt;/p&gt;</comment>
                            <comment id="12851250" author="stack" created="Tue, 30 Mar 2010 04:51:56 +0000"  >&lt;p&gt;Good on you lads.  You figured it.  Were you going to post another patch?&lt;/p&gt;</comment>
                            <comment id="12851254" author="kannanm" created="Tue, 30 Mar 2010 05:11:14 +0000"  >&lt;p&gt;To handle this correctly, one way would be to look at the list of KVs in the Delete for duplicates and determine how many versions of a column we are trying to delete. Sigh! If we determine that we are say trying to delete N versions of a column, then find the timestamps for the latest N versions (instead of one at a time), and update the N KVs with those timestamps. Then proceed to update the log and memstore.&lt;/p&gt;</comment>
                            <comment id="12852159" author="aravind.menon" created="Wed, 31 Mar 2010 23:02:50 +0000"  >&lt;p&gt;For cell version deletes, try to remember how many versions if a cell have been deleted, and update timestamps of new deletes accordingly.&lt;/p&gt;</comment>
                            <comment id="12852163" author="aravind.menon" created="Wed, 31 Mar 2010 23:16:27 +0000"  >&lt;p&gt;Reupping patch with proper path and naming.&lt;/p&gt;</comment>
                            <comment id="12852379" author="stack" created="Thu, 1 Apr 2010 13:29:14 +0000"  >&lt;p&gt;v2 looks good. Applied to branch and it fixed the build.  Just applied to trunk.  Thanks for persisting Aravind.&lt;/p&gt;</comment>
                            <comment id="12852380" author="stack" created="Thu, 1 Apr 2010 13:30:57 +0000"  >&lt;p&gt;Added Aravind as contributor and assigned him this issue.&lt;/p&gt;</comment>
                            <comment id="12866899" author="stack" created="Wed, 12 May 2010 23:53:16 +0000"  >&lt;p&gt;Marking these as fixed against 0.21.0 rather than against 0.20.5.&lt;/p&gt;</comment>
                            <comment id="15017719" author="lars_francke" created="Fri, 20 Nov 2015 12:44:08 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12440420" name="HBASE-2338-v2.patch" size="2721" author="aravind.menon" created="Wed, 31 Mar 2010 23:16:27 +0000"/>
                            <attachment id="12440417" name="delete.patch" size="2793" author="aravind.menon" created="Wed, 31 Mar 2010 23:02:50 +0000"/>
                            <attachment id="12439605" name="delete.patch" size="3784" author="aravind.menon" created="Tue, 23 Mar 2010 20:29:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 23 Mar 2010 20:25:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26265</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hhbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100067</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>