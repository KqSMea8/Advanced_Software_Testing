<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:34:54 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6228/HBASE-6228.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6228] Fixup daughters twice  cause daughter region assigned twice</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6228</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;First, how fixup daughters twice happen?&lt;br/&gt;
1.we will fixupDaughters at the last of HMaster#finishInitialization&lt;br/&gt;
2.ServerShutdownHandler will fixupDaughters when reassigning region through ServerShutdownHandler#processDeadRegion&lt;/p&gt;

&lt;p&gt;When fixupDaughters, we will added daughters to .META., but it coudn&apos;t prevent the above case, because FindDaughterVisitor.&lt;/p&gt;

&lt;p&gt;The detail is as the following:&lt;br/&gt;
Suppose region A is a splitted parent region, and its daughter region B is missing&lt;/p&gt;

&lt;p&gt;1.First, ServerShutdownHander thread fixup daughter, so add daughter region B to .META. with serverName=null, and assign the daughter.&lt;/p&gt;

&lt;p&gt;2.Then, Master&apos;s initialization thread will also find the daughter region B is missing and assign it. It is because FindDaughterVisitor consider daughter is missing if its serverName=null&lt;/p&gt;</description>
                <environment></environment>
        <key id="12593998">HBASE-6228</key>
            <summary>Fixup daughters twice  cause daughter region assigned twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10">Implemented</resolution>
                                        <assignee username="zjushch">chunhui shen</assignee>
                                    <reporter username="zjushch">chunhui shen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jun 2012 06:10:47 +0000</created>
                <updated>Mon, 23 Sep 2013 18:30:49 +0000</updated>
                            <resolved>Wed, 3 Oct 2012 22:14:48 +0000</resolved>
                                                    <fixVersion>0.95.0</fixVersion>
                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13395994" author="ram_krish" created="Mon, 18 Jun 2012 16:12:52 +0000"  >&lt;p&gt;Submitting to HadoopQA.&lt;/p&gt;</comment>
                            <comment id="13396036" author="hadoopqa" created="Mon, 18 Jun 2012 17:08:08 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12532372/HBASE-6228.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12532372/HBASE-6228.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 7 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2185//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2185//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2185//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2185//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2185//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2185//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2185//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2185//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13396978" author="zhihyu@ebaysf.com" created="Tue, 19 Jun 2012 18:46:14 +0000"  >&lt;p&gt;Patch looks good.&lt;/p&gt;</comment>
                            <comment id="13397286" author="ram_krish" created="Wed, 20 Jun 2012 06:16:41 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
So this happens when master restart and SSH goes in parallel only?&lt;/p&gt;</comment>
                            <comment id="13397291" author="zjushch" created="Wed, 20 Jun 2012 06:28:37 +0000"  >&lt;p&gt;@ram&lt;br/&gt;
So this happens when master restart and SSH goes in parallel only?&lt;br/&gt;
Yes, as the current logic, we only fixup daughter in the two places.&lt;/p&gt;</comment>
                            <comment id="13397297" author="ram_krish" created="Wed, 20 Jun 2012 06:34:27 +0000"  >&lt;p&gt;So as i see the code if in the normal case where SSH tries to fix up, if SSH sees there is no servername i.e the servername is null, it will try to fixup daughter and assign it.&lt;br/&gt;
As i see the patch now we are trying to remove code where we get ServerName as null.  So if only SSH is going on and there is no master restart scenario how this patch will work?  Sorry if my question is dumb?&lt;/p&gt;</comment>
                            <comment id="13397301" author="zjushch" created="Wed, 20 Jun 2012 06:48:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;So if only SSH is going on and there is no master restart scenario how this patch will work?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In current logic, we will add daughter to META with serverName in the SplitTransaction. And we won&apos;t added daughter with serverName==null except fixup daughter.&lt;br/&gt;
However, master may die after added daughter but before assign it, and master won&apos;t assign it when restart&lt;/p&gt;

&lt;p&gt;So I think we should added daughter with parent&apos;s serverName.&lt;/p&gt;

&lt;p&gt;Thanks ram to find the hole&lt;/p&gt;</comment>
                            <comment id="13397336" author="zjushch" created="Wed, 20 Jun 2012 07:50:25 +0000"  >&lt;p&gt;Updating patch&#65306; added daughter with parent region&apos;s serverName when fixup daughters&lt;/p&gt;</comment>
                            <comment id="13397339" author="hadoopqa" created="Wed, 20 Jun 2012 07:55:16 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12532666/HBASE-6228v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12532666/HBASE-6228v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2199//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2199//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13397344" author="zjushch" created="Wed, 20 Jun 2012 08:01:32 +0000"  >&lt;p&gt;Reattaching patch v2&lt;/p&gt;</comment>
                            <comment id="13397365" author="hadoopqa" created="Wed, 20 Jun 2012 09:01:29 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12532668/HBASE-6228v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12532668/HBASE-6228v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 7 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2200//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2200//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2200//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2200//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2200//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2200//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2200//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2200//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13397544" author="zhihyu@ebaysf.com" created="Wed, 20 Jun 2012 14:29:19 +0000"  >&lt;p&gt;+1 on patch v2.&lt;/p&gt;</comment>
                            <comment id="13399370" author="ram_krish" created="Fri, 22 Jun 2012 15:12:42 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
Going thro the patch again.  &lt;br/&gt;
Now you are trying to update the parent region server name into the daughter.  Now assume a region that was split and still not daughters are not added to META.&lt;br/&gt;
Now the RS goes down.  SSH will start and find the missing daughter.  Now you try to add the parent server name to the daughter.  Before the assignment is done master goes down.&lt;br/&gt;
Now when trying to fix daughter it will find the the parent server name associated with it and it will not assign it right.  &lt;br/&gt;
So i think here what we should try is to avoid two assignments.&lt;br/&gt;
What do you feel Chunhui?&lt;br/&gt;
In the previous patch because the check if the server was null is commented the problem is almost same but in a different way. Correct me if am wrong Chunhui.&lt;/p&gt;</comment>
                            <comment id="13400251" author="zjushch" created="Mon, 25 Jun 2012 02:06:58 +0000"  >&lt;p&gt;@ram&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Now when trying to fix daughter it will find the the parent server name associated with it and it will not assign it right. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think it won&apos;t happen.&lt;/p&gt;

&lt;p&gt;If master goes down before the assignment is done and after fixup daughters,  when master restart, it will assign the daughter through rebuildUserRegions because the added parent server name is a dead server.&lt;/p&gt;
</comment>
                            <comment id="13401243" author="ram_krish" created="Tue, 26 Jun 2012 08:31:42 +0000"  >&lt;p&gt;+1 Chunhui.  Your explanation is right.  Sorry for making noise here. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="13401326" author="jmhsieh" created="Tue, 26 Jun 2012 12:04:11 +0000"  >&lt;p&gt;Is there anyway we can add tests to these subtle recovery fixes?  &lt;/p&gt;

&lt;p&gt;Part of me says we should just take a something like lock on the region (in zk, possibly moving it into RIT) before we start fixing them up like this to make this obvious and to eliminate these classes of races.  &lt;/p&gt;</comment>
                            <comment id="13401539" author="ram_krish" created="Tue, 26 Jun 2012 17:23:30 +0000"  >&lt;p&gt;@Jon&lt;br/&gt;
So you not ok with this fix Jon? &lt;/p&gt;</comment>
                            <comment id="13401690" author="jmhsieh" created="Tue, 26 Jun 2012 21:17:14 +0000"  >&lt;p&gt;I&apos;m -0.  (Not going to block if others are ok with it, but am just uncomfortable since there are no tests).&lt;/p&gt;

&lt;p&gt;I&apos;ve only recently started spending time looking at the recovery/bugs/races but my general impression is that I cannot easily tell if this patch (and several similar to it) are just pushing a race from one place to another.  If we add tests then we can detect the fact that this change doesn&apos;t re-introduce a previously solved problem.&lt;/p&gt;

&lt;p&gt;I haven&apos;t thought out the locking idea yet but it seems if we have state races, locks could simplify the reasoning that may eliminate classes of subtle bugs.&lt;/p&gt;</comment>
                            <comment id="13402065" author="zjushch" created="Wed, 27 Jun 2012 08:53:10 +0000"  >&lt;p&gt;Adding test case for this issue in the patch v3&lt;/p&gt;</comment>
                            <comment id="13402091" author="ram_krish" created="Wed, 27 Jun 2012 09:46:28 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
Thanks for the testcase.  I ran the testcase without patch.  It passes many times even with out the fix.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                RegionTransition rt = RegionTransition.parseFrom(data);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rt.getEventType() == EventHandler.EventType.RS_ZK_REGION_OPENED) {
                  &lt;span class=&quot;code-comment&quot;&gt;// Make a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; region plan
&lt;/span&gt;                  master.getAssignmentManager().getRegionPlan(daughterARegionState,
                      daughterARegionState.getServerName(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This part of code may not work right.  Because the node state can be changed before that Thread.sleep is done.&lt;br/&gt;
And so if we don&apos;t update the region plan we cannot assure that double assignment can be done.  Even i was trying to write a testcase and was caught up in a similar state.  Good on you Chunhui.&lt;/p&gt;</comment>
                            <comment id="13402094" author="hadoopqa" created="Wed, 27 Jun 2012 09:51:56 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12533624/HBASE-6228v3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12533624/HBASE-6228v3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 6 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.replication.TestReplication&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2272//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2272//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2272//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2272//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2272//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2272//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2272//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2272//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13402106" author="zjushch" created="Wed, 27 Jun 2012 10:06:17 +0000"  >&lt;p&gt;@ram&lt;br/&gt;
Do you run the case in trunk? Maybe case is not good, but I run it and always failed without patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;update the region plan we cannot assure that double assignment can be done&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If we restart master after fixup daughter, master won&apos;t contain any plans, so I just simulate it and ensure case could happen.&lt;/p&gt;

&lt;p&gt;Another thing, I think I must say:&lt;br/&gt;
If we send open region RPC twice for one region, but not assigned twice because we have many protection through version. But we also have risk of data correctness.&lt;br/&gt;
Why?:&lt;br/&gt;
When region in opening, it will replay log edits and flush; if two regionservers do opening region together, could we ensure data correctness?&lt;/p&gt;</comment>
                            <comment id="13402145" author="ram_krish" created="Wed, 27 Jun 2012 11:18:30 +0000"  >&lt;p&gt;@Jon &lt;br/&gt;
I have added a testcase to show the problem.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;but my general impression is that I cannot easily tell if this patch (and several similar to it) are just pushing a race from one place to another.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Could you let us know what type of issues are like that, if you have some list with you?&lt;/p&gt;

&lt;p&gt;@Chunhui&lt;br/&gt;
What if the master initialization and SSH both are in fixUpDaughters? Then we are bound to get double assignment right?&lt;br/&gt;
The scenario am telling is Master has just completed joinCluster().  By the time a RS went down while splitting .  SSH starts and it comes to processDeadRegion.&lt;br/&gt;
Later master also sees there are daughters to fixup.  Now we may end up in same problem? I think here we need some sync mechanism.  What do you feel Chunhui?&lt;/p&gt;</comment>
                            <comment id="13402167" author="hadoopqa" created="Wed, 27 Jun 2012 12:10:16 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12533642/HBASE-6228v4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12533642/HBASE-6228v4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 hadoop2.0.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 6 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2273//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2273//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2273//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2273//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2273//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2273//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2273//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2273//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13402168" author="zjushch" created="Wed, 27 Jun 2012 12:10:19 +0000"  >&lt;p&gt;@ram&lt;br/&gt;
Could you talk about sync mechanism?&lt;br/&gt;
Based on the current patch, I think we won&apos;t assign twice. If need, we could add a synchronized block for the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;isDaughterMissing(catalogTracker, daughter)) {
LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Fixup; missing daughter &quot;&lt;/span&gt; + daughter.getRegionNameAsString());
MetaEditor.addDaughter(catalogTracker, daughter, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="13403908" author="ram_krish" created="Fri, 29 Jun 2012 13:53:32 +0000"  >&lt;p&gt;@Chunhui&lt;br/&gt;
We are able to reproduce the double assignment scenario between SSH and master restart.&lt;br/&gt;
So i think we should have synchronized block or as Jon says we need some lock mechanism but that may be a bigger task.&lt;/p&gt;
</comment>
                            <comment id="13406182" author="jmhsieh" created="Tue, 3 Jul 2012 23:50:45 +0000"  >&lt;p&gt;@Ram, @Chunhui&lt;/p&gt;

&lt;p&gt;I think stack may have started looking at some of these things but let me give a list that I&apos;ve been looking at which I think are related: (there are probably more).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6012&quot; title=&quot;Handling RegionOpeningState for bulk assign&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6012&quot;&gt;&lt;del&gt;HBASE-6012&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6060&quot; title=&quot;Regions&amp;#39;s in OPENING state from failed regionservers takes a long time to recover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6060&quot;&gt;&lt;del&gt;HBASE-6060&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5914&quot; title=&quot;Bulk assign regions in the process of ServerShutdownHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5914&quot;&gt;&lt;del&gt;HBASE-5914&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5882&quot; title=&quot;Prcoess RIT on master restart can try assigning the region if the region is found on a dead server instead of waiting for Timeout Monitor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5882&quot;&gt;&lt;del&gt;HBASE-5882&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6147&quot; title=&quot;SSH and AM.joinCluster leads to region assignment inconsistency in many cases.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6147&quot;&gt;&lt;del&gt;HBASE-6147&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5916&quot; title=&quot;RS restart just before master intialization we make the cluster non operative&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5916&quot;&gt;&lt;del&gt;HBASE-5916&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5546&quot; title=&quot;Master assigns region in the original region server when opening region failed  &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5546&quot;&gt;&lt;del&gt;HBASE-5546&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5816&quot; title=&quot;Balancer and ServerShutdownHandler concurrently reassign the same region&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5816&quot;&gt;&lt;del&gt;HBASE-5816&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6160&quot; title=&quot;META entries from daughters can be deleted before parent entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6160&quot;&gt;&lt;del&gt;HBASE-6160&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5918&quot; title=&quot;Master will block forever at startup if root server dies between assigning root and assigning meta&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5918&quot;&gt;&lt;del&gt;HBASE-5918&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6016&quot; title=&quot;ServerShutdownHandler#processDeadRegion could return false for disabling table regions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6016&quot;&gt;&lt;del&gt;HBASE-6016&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5927&quot; title=&quot;SSH and DisableTableHandler happening together does not clear the znode of the region and RIT map.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5927&quot;&gt;&lt;del&gt;HBASE-5927&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ve been gathering the list with the intent of seeing if there is a common pattern.  At the highest level, I think that we need somethign to protect meta from changes coming from multiple uncoordinated sources like RS&apos;s and HM.   My gut is that the long term solution is something like a region lock (possibly a ZK &quot;regionlock&quot;) that is used to isolate and protect hbase metadata modifications.   Something like that would reduce the space of possible problems and hopefully make testing easier along the way.&lt;/p&gt;</comment>
                            <comment id="13406273" author="ram_krish" created="Wed, 4 Jul 2012 04:40:18 +0000"  >&lt;p&gt;@Jon&lt;br/&gt;
Thanks for sharing the list.  &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;(possibly a ZK &quot;regionlock&quot;)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes Jon. I agree.  Still we keep getting issues in AM, SSH, Master restart etc. &lt;/p&gt;</comment>
                            <comment id="13406715" author="stack" created="Wed, 4 Jul 2012 20:29:36 +0000"  >&lt;p&gt;I&apos;ve been looking at hbase-6060 as a background task (sorry, its taking me a while Ram and Rajesh to get back to you lot).  When I put together multiple threads (SSH, HMaster joining cluster, single vs bulk assigning/unassign, timeout monitor, zk callbacks etc.) and then try to trace state changes not only across multiple state keepers (RegionState, RegionInTransition, AM#this.regions and AM#this.servers) in the master process but then also too x-process master -&amp;gt; regionserver -&amp;gt; via zk, I want to throw out what we have and start over (smile).  That ain&apos;t going to happen though.&lt;/p&gt;

&lt;p&gt;Meantime I think we need to identify patterns or practices and broadcast them so all can sign on.  For example, I appreciate stuff like Jimmy&apos;s small win simplifying AM breaking out RegionStates into a standalone class apart from AM.  This at least collects a bunch of in-memory state in the one place.&lt;/p&gt;

&lt;p&gt;We also need to have more tests I&apos;d say so we can have some confidence stuff still works when we shift things around.&lt;/p&gt;</comment>
                            <comment id="13406753" author="stack" created="Wed, 4 Jul 2012 21:08:04 +0000"  >&lt;p&gt;For example, on study:&lt;/p&gt;

&lt;p&gt;+ RegionState is unreliable figuring state of region in master&apos;s memory; you cannot rely on it to answer the bigger question of who a region belongs to: master or regionserver.&lt;br/&gt;
+ In assign, we are careful with retries.  We actually need to be more careful especially around things like socket timeout (see Maryann&apos;s recent issue).  Bulk assign does none of these checks.  Bulk assign was introduced originally to do assigns on cluster start; if anything failed, contract was we&apos;d just crash out and restart cluster over.  That was how it was originally.  Now bulk assign is used all over &amp;#8211; e.g. in SSH &amp;#8211; in spite of its being loosey-goosey around failures.&lt;/p&gt;</comment>
                            <comment id="13416697" author="jxiang" created="Tue, 17 Jul 2012 23:08:52 +0000"  >&lt;p&gt;@Chunhui, this is a very rare case. Is it better to synchronize SSH.isDaughterMissing()?  This method is not in critical path, so there should be no performance issue.&lt;/p&gt;</comment>
                            <comment id="13419691" author="jxiang" created="Fri, 20 Jul 2012 23:46:28 +0000"  >&lt;p&gt;I&apos;d like to fix this in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6381&quot; title=&quot;AssignmentManager should use the same logic for clean startup and failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6381&quot;&gt;&lt;del&gt;HBASE-6381&lt;/del&gt;&lt;/a&gt; by making sure SSH blocks on AM.processServerShutdown until the master has joined the cluster, and fixed missing daughters.&lt;/p&gt;</comment>
                            <comment id="13438290" author="jxiang" created="Mon, 20 Aug 2012 23:01:22 +0000"  >&lt;p&gt;@Chunhui, I posted a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6381&quot; title=&quot;AssignmentManager should use the same logic for clean startup and failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6381&quot;&gt;&lt;del&gt;HBASE-6381&lt;/del&gt;&lt;/a&gt; at RB: &lt;a href=&quot;https://reviews.apache.org/r/6535/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/6535/&lt;/a&gt;&lt;br/&gt;
I could not block SSH till the master fixed missing daughters.  However, I tried to&lt;br/&gt;
make sure the master doesn&apos;t compete with SSH. Please take a look. Thanks.&lt;/p&gt;</comment>
                            <comment id="13468204" author="stack" created="Wed, 3 Oct 2012 00:01:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjushch&quot; class=&quot;user-hover&quot; rel=&quot;zjushch&quot;&gt;chunhui shen&lt;/a&gt; What about this issue.  Is it fixed by hbase-6381?&lt;/p&gt;</comment>
                            <comment id="13468913" author="jxiang" created="Wed, 3 Oct 2012 22:14:49 +0000"  >&lt;p&gt;Yes, I think the issue is not there any more.&lt;/p&gt;</comment>
                            <comment id="13775141" author="stack" created="Mon, 23 Sep 2013 18:30:49 +0000"  >&lt;p&gt;Marking closed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12598584">HBASE-6381</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12532372" name="HBASE-6228.patch" size="817" author="zjushch" created="Mon, 18 Jun 2012 06:18:56 +0000"/>
                            <attachment id="12532668" name="HBASE-6228v2.patch" size="976" author="zjushch" created="Wed, 20 Jun 2012 08:01:32 +0000"/>
                            <attachment id="12532666" name="HBASE-6228v2.patch" size="937" author="zjushch" created="Wed, 20 Jun 2012 07:50:22 +0000"/>
                            <attachment id="12533624" name="HBASE-6228v3.patch" size="6945" author="zjushch" created="Wed, 27 Jun 2012 08:53:10 +0000"/>
                            <attachment id="12533642" name="HBASE-6228v4.patch" size="9457" author="ram_krish" created="Wed, 27 Jun 2012 11:10:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 18 Jun 2012 16:12:52 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240669</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i014fz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4489</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>