<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:01:03 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2340/HBASE-2340.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2340] Add end-to-end test of sync/flush</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2340</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Add a test to do the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ Start a HBase/HDFS cluster (local node is fine).
 + Use top-level (HTable) level APIs to put items. 
+ Try about single column puts, as well as puts which span multiple columns/multiple column families, etc.
+ Then kill one region server.
+ Wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; recovery to happen.
+ And then check the rows exist.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assigning myself.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12459443">HBASE-2340</key>
            <summary>Add end-to-end test of sync/flush</summary>
                <type id="3" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/task.png">Task</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Mar 2010 22:18:52 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:33 +0000</updated>
                            <resolved>Fri, 26 Mar 2010 17:39:14 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="12846623" author="tlipcon" created="Wed, 17 Mar 2010 22:32:11 +0000"  >&lt;p&gt;A reasonably simple test would also be the following:&lt;/p&gt;

&lt;p&gt;Write a simple client that does something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Random r = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(myClientId);
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
  &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; toWrite = r.nextLong();
  writeKey(toWrite);
  writeToLocalDiskAndFsync(i);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then run N of these clients concurrently while injecting various bits of churn into the cluster (kill -9, kill -STOP, pull network jacks, etc).&lt;/p&gt;

&lt;p&gt;Success criterion 1 is that all of the clients proceed without throwing exceptions. Success criterion 2 is to start the clients again in verification mode and run the same number of iterations as recorded on the local disk, checking that all of the data is there.&lt;/p&gt;</comment>
                            <comment id="12846630" author="streamy" created="Wed, 17 Mar 2010 22:38:05 +0000"  >&lt;p&gt;Excellent jira.  Another interesting thing to test would be what happens if there&apos;s a master failover at the same time (or at some random time in between failure and finishing recovery).  Seems there would definitely be some holes found there.&lt;/p&gt;

&lt;p&gt;At the least we might test the situation where the failed server is hosting both the regionserver and active master and there is a backup master waiting which is more likely than two distinct nodes crashing that close to each other.&lt;/p&gt;</comment>
                            <comment id="12846634" author="tlipcon" created="Wed, 17 Mar 2010 22:44:31 +0000"  >&lt;p&gt;Yea, what I&apos;d love to see eventually is a &quot;rambo&quot; script that will do any number of nasty things periodically to nodes in the cluster. Including but not limited to:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;kill -9 a 
{RS,Master,DN,ZKNode}&lt;br/&gt;
- kill -INT a {RS,Master,DN,ZKNode}&lt;/li&gt;
	&lt;li&gt;kill -STOP a 
{RS,Master,DN,ZKNode}
&lt;p&gt;, followed by -CONT a few minutes later&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;ifconfig eth0 down ; sleep 10; ifconfig eth0 up&lt;/li&gt;
	&lt;li&gt;insert bad routes to 
{ZK,NN,HM}
&lt;p&gt; for short periods of time (to simulate situation where you can&apos;t talk to DFS but you can still talk to ZK, etc)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;this script could be done rather generally and would be useful for testing Hadoop by itself as well.&lt;/p&gt;</comment>
                            <comment id="12846635" author="stack" created="Wed, 17 Mar 2010 22:44:54 +0000"  >&lt;p&gt;J-D points out that TRUNK has a basic test of failed regionserver verifying edits are in place: TestFullLogReconstruction.  Let this issue then be about backporting that test and adding in support for the suggestions made above.&lt;/p&gt;</comment>
                            <comment id="12847837" author="stack" created="Sat, 20 Mar 2010 21:47:39 +0000"  >&lt;p&gt;I&apos;m backporting J-D&apos;s test for a start.  Required me to backport HBaseTestingUtility from trunk and adding a junit jar that supports junit4.  Working on making TestFullLogReconstruction work on branch now.&lt;/p&gt;

&lt;p&gt;Once this is working, we can discuss what else we&apos;d like to add.&lt;/p&gt;</comment>
                            <comment id="12847846" author="stack" created="Sat, 20 Mar 2010 23:12:27 +0000"  >&lt;p&gt;Here is patch that adds TestFullLogReconstruction.java.  It currently fails.  Looking to why.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Testcase: testReconstruction took 275.704 sec
        Caused an ERROR
Trying to contact region server 192.168.1.157:55472 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region tabletest,,1269121970753, row &apos;&apos;, but failed after 10 attempts.
Exceptions:
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused

org.apache.hadoop.hbase.client.RetriesExhaustedException: Trying to contact region server 192.168.1.157:55472 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region tabletest,,1269121970753, row &apos;&apos;, but failed after 10 attempts.
Exceptions:
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused
java.net.ConnectException: Connection refused

        at org.apache.hadoop.hbase.client.HConnectionManager$TableServers.getRegionServerWithRetries(HConnectionManager.java:1073)
        at org.apache.hadoop.hbase.client.HTable$ClientScanner.nextScanner(HTable.java:1935)
        at org.apache.hadoop.hbase.client.HTable$ClientScanner.initialize(HTable.java:1855)
        at org.apache.hadoop.hbase.client.HTable.getScanner(HTable.java:376)
        at org.apache.hadoop.hbase.TestFullLogReconstruction.testReconstruction(TestFullLogReconstruction.java:115)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12847883" author="jdcryans" created="Sun, 21 Mar 2010 04:55:27 +0000"  >&lt;p&gt;I don&apos;t see that test enabling dfs.append.enabled and IIRC it&apos;s required in 0.20 for a working fsSync?&lt;/p&gt;</comment>
                            <comment id="12848566" author="stack" created="Tue, 23 Mar 2010 06:26:16 +0000"  >&lt;p&gt;TestFullLogReconstruction works now after enabling dfs.append.support=true (and other configs. from Nicolas hbase-2345) and making it so exiting regionserver doesn&apos;t shutdown the filesystem (because then the filesystem is closed for daemons in the JVM).  The test runs for 200 seconds, mostly because we&apos;re loading up a good bit of data.  Could make it less I suppose.&lt;/p&gt;

&lt;p&gt;I see this in test log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-03-22 23:10:33,232 INFO  [HMaster] regionserver.HLog(1096): Splitting 1 hlog(s) in hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61468/user/stack/.logs/192.168.1.157,61497,1269324534078
&lt;/span&gt;2010-03-22 23:10:33,232 DEBUG [HMaster] regionserver.HLog(1183): Splitting hlog 1 of 1: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61468/user/stack/.logs/192.168.1.157,61497,1269324534078/hlog.dat.1269324534191, length=0
&lt;/span&gt;2010-03-22 23:10:33,233 WARN  [IPC Server handler 8 on 61468] namenode.FSNamesystem(1144): DIR* NameSystem.startFile: failed to create file /user/stack/.logs/192.168.1.157,61497,1269324534078/hlog.dat.1269324534191 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; DFSClient_343812212 on client 127.0.0.1 because current leaseholder is trying to recreate file.
2010-03-22 23:10:33,240 INFO  [HMaster] regionserver.HLog(1427): Failed open &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; append, waiting on lease recovery: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61468/user/stack/.logs/192.168.1.157,61497,1269324534078/hlog.dat.1269324534191
&lt;/span&gt;org.apache.hadoop.ipc.RemoteException: org.apache.hadoop.hdfs.protocol.AlreadyBeingCreatedException: failed to create file /user/stack/.logs/192.168.1.157,61497,1269324534078/hlog.dat.1269324534191 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; DFSClient_343812212 on client 127.0.0.1 because current leaseholder is trying to recreate file.
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... and after RS fully goes down we&apos;re able to open the log and process its content.&lt;/p&gt;
</comment>
                            <comment id="12848567" author="stack" created="Tue, 23 Mar 2010 06:27:18 +0000"  >&lt;p&gt;I attached the wrong file previously.&lt;/p&gt;</comment>
                            <comment id="12848569" author="stack" created="Tue, 23 Mar 2010 06:28:18 +0000"  >&lt;p&gt;@Kannan Please take a look.  What else do you need it to do?  Would you like to be able to kill datanodes too?  Let me know.&lt;/p&gt;</comment>
                            <comment id="12848570" author="stack" created="Tue, 23 Mar 2010 06:28:58 +0000"  >&lt;p&gt;Assigning Kannan so he&apos;ll take a look at posted patch (Thanks K).&lt;/p&gt;</comment>
                            <comment id="12848898" author="kannanm" created="Tue, 23 Mar 2010 20:37:20 +0000"  >&lt;p&gt;Thanks Stack! I will take a look at this.&lt;/p&gt;</comment>
                            <comment id="12849355" author="jdcryans" created="Wed, 24 Mar 2010 18:50:37 +0000"  >&lt;p&gt;Working on replication, I wrote a test that does something like TestFullLogReconstruction except that instead of waiting for the full insert to finish, I start a thread an kill a RS after some seconds. It passes half of the time because of what people described in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2231&quot; title=&quot;Compaction events should be written to HLog&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2231&quot;&gt;&lt;del&gt;HBASE-2231&lt;/del&gt;&lt;/a&gt; e.g. a region server is able to append and even roll logs! I think TestFullLogReconstruction should also do something like that.&lt;/p&gt;</comment>
                            <comment id="12849947" author="kannanm" created="Thu, 25 Mar 2010 23:29:27 +0000"  >&lt;p&gt;Curious why the &quot;flush&quot; in the middle of the test-- coz flushing the row and loading the &lt;b&gt;same&lt;/b&gt; rows again could mask problems with recovery. So perhaps we should remove the flush?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 4; i++) {
      TEST_UTIL.loadTable(table, FAMILY);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(i == 2) {
        TEST_UTIL.flush();
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Otherwise, the test looks good for testing log reconstruction. Perhaps you can commit this, and then I&apos;ll add specific cases for Puts containing multiple edits, Deletes, etc. (related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2383&quot; title=&quot;Replace JSON-licensed json dependencies&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2383&quot;&gt;&lt;del&gt;HBASE-2383&lt;/del&gt;&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2338&quot; title=&quot;log recovery: deleted items may be resurrected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2338&quot;&gt;&lt;del&gt;HBASE-2338&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;We should also enhance the test or add tests to test datanode failures-- but please commit this for now.&lt;/p&gt;





</comment>
                            <comment id="12849959" author="jdcryans" created="Fri, 26 Mar 2010 00:07:46 +0000"  >&lt;p&gt;That test is imperfect, I don&apos;t remember exactly why I put a flush there but I remember I had some issues without it.&lt;/p&gt;</comment>
                            <comment id="12849989" author="kannanm" created="Fri, 26 Mar 2010 03:02:08 +0000"  >&lt;p&gt;Typo in my previous post: &amp;lt;&amp;lt;&amp;lt;I&apos;ll add specific cases for Puts containing multiple edits, Deletes, etc. (related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2383&quot; title=&quot;Replace JSON-licensed json dependencies&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2383&quot;&gt;&lt;del&gt;HBASE-2383&lt;/del&gt;&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2338&quot; title=&quot;log recovery: deleted items may be resurrected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2338&quot;&gt;&lt;del&gt;HBASE-2338&lt;/del&gt;&lt;/a&gt;).&amp;gt;&amp;gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;The relevant JIRAs should be &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2283&quot; title=&quot;row level atomicity &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2283&quot;&gt;&lt;del&gt;HBASE-2283&lt;/del&gt;&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2338&quot; title=&quot;log recovery: deleted items may be resurrected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2338&quot;&gt;&lt;del&gt;HBASE-2338&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12850240" author="stack" created="Fri, 26 Mar 2010 17:39:14 +0000"  >&lt;p&gt;Committed to branch without flush (Seems to work w/o it).  Thanks for review Kannan.&lt;/p&gt;</comment>
                            <comment id="12866866" author="stack" created="Wed, 12 May 2010 23:52:44 +0000"  >&lt;p&gt;Marking these as fixed against 0.21.0 rather than against 0.20.5.&lt;/p&gt;</comment>
                            <comment id="15017280" author="lars_francke" created="Fri, 20 Nov 2015 12:42:33 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12439546" name="2340-v2.patch" size="6120" author="stack" created="Tue, 23 Mar 2010 06:27:18 +0000"/>
                            <attachment id="12439382" name="2340.patch" size="45447" author="stack" created="Sat, 20 Mar 2010 23:12:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 17 Mar 2010 22:32:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32528</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hhbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100069</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>