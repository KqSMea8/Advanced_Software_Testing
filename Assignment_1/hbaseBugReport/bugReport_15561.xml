<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:04:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-15561/HBASE-15561.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-15561] See how G1GC works with MSLAB and chunk pool</title>
                <link>https://issues.apache.org/jira/browse/HBASE-15561</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Based on the discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-14613&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-14613&lt;/a&gt;, we need to identify specifically how MSLAB and G1GC work. This sub-task is mainly to identify how things work with G1GC and note down the observations. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12954539">HBASE-15561</key>
            <summary>See how G1GC works with MSLAB and chunk pool</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12954202">HBASE-15555</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ram_krish">ramkrishna.s.vasudevan</assignee>
                                    <reporter username="ram_krish">ramkrishna.s.vasudevan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Mar 2016 06:51:55 +0000</created>
                <updated>Wed, 12 Oct 2016 06:15:19 +0000</updated>
                            <resolved>Wed, 12 Oct 2016 06:15:18 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="15544437" author="ram_krish" created="Tue, 4 Oct 2016 05:51:32 +0000"  >&lt;p&gt;Just wanted to update this JIRa with our findings and result over here. If things are discussed we could close this JIRA.&lt;/p&gt;

&lt;p&gt;There are two parts to this&lt;br/&gt;
-&amp;gt; testing trunk (default memstore) with &lt;b&gt;MSLAB and chunk pool ON&lt;/b&gt; and without MSLAB with G1GC configs&lt;br/&gt;
-&amp;gt; Next is to test G1GC with defaut memstore and offheap memstore (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15179&quot; title=&quot;Cell/DBB end-to-end on the write-path&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15179&quot;&gt;HBASE-15179&lt;/a&gt;). For now this offheap is not in trunk. It is a POC work. Working on getting things committed to trunk.&lt;/p&gt;

&lt;p&gt;cluster setup&lt;br/&gt;
==========&lt;br/&gt;
The set up is a single node set up with one RS and the client in the same machine. The machine has 150G of RAM.&lt;/p&gt;

&lt;p&gt;GC config:&lt;br/&gt;
========&lt;br/&gt;
export HBASE_OPTS=&quot;-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:InitiatingHeapOccupancyPercent=60 -XX:G1HeapWastePercent=20  -XX:G1MixedGCCountTarget=8&quot;&lt;/p&gt;

&lt;p&gt;&amp;lt;property&amp;gt;&lt;br/&gt;
            &amp;lt;name&amp;gt;hbase.regionserver.global.memstore.size&amp;lt;/name&amp;gt;&lt;br/&gt;
  &amp;lt;value&amp;gt;0.42&amp;lt;/value&amp;gt;&lt;br/&gt;
&amp;lt;/property&amp;gt;&lt;/p&gt;


&lt;p&gt;PE command:&lt;br/&gt;
===========&lt;br/&gt;
./hbase org.apache.hadoop.hbase.PerformanceEvaluation --nomapred --presplit=50 --size=150 --columns=50 --valueSize=200  --oneCon=true  --writeToWAL=false --bloomFilter=NONE --inmemoryCompaction=false randomWrite 100&lt;/p&gt;

&lt;p&gt;We think MSLAB and chunk pool is important mainly because when you move things to offheap we need to ensure that we are managing the offheap buffers &lt;br/&gt;
efficiently. It is very dangerous to allocate offheap buffers and keep them unclaimed which will lead to offheap memory leak. Whereas in onheap buffers cases we&lt;br/&gt;
are able to manage it with the help of GC.&lt;br/&gt;
Hence it is always recommended for offheap memstore to go with MSLAB and chunk pool.&lt;/p&gt;

&lt;p&gt;Perf readings&lt;br/&gt;
==========&lt;br/&gt;
For details on onheap and offheap memstore comparison with MSLAB and chunk pool pls refer to these docs and various GC configs&lt;br/&gt;
&lt;a href=&quot;https://docs.google.com/document/d/1fj5P8JeutQ-Uadb29ChDscMuMaJqaMNRI86C4k5S1rQ/edit&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://docs.google.com/document/d/1fj5P8JeutQ-Uadb29ChDscMuMaJqaMNRI86C4k5S1rQ/edit&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://docs.google.com/document/d/1bYIkwNVVyYk8bgik-C5x_yc_2hWHyi2-9KMwEFWLfzY/edit&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://docs.google.com/document/d/1bYIkwNVVyYk8bgik-C5x_yc_2hWHyi2-9KMwEFWLfzY/edit&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The above experiments were done on top of a POc branch where we had our own changes to support offheap memstore including some PB changes.&lt;/p&gt;


&lt;p&gt;With the current trunk we performed experiments with 50 threads and 100 threads and with 64 G heap memory.&lt;/p&gt;

&lt;p&gt;With 100 threads and 10 cols per row pushed from a single client the setup with MSLAB and chunk pool performs 13% better than the no MSLAB case.&lt;br/&gt;
With 50 threads and 10 cols per row pushed from a single client the setup with MSLAB and chunk pool performs 11% better than the no MSLAB case.&lt;/p&gt;

&lt;p&gt;PE completion time for 50 threads, 10 cols&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Default memstore with MSLAB &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Default memstore with NO MSLAB&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1132.923 secs&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1262 secs&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;PE completion time for 100 threads, 10 cols&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Default memstore with MSLAB &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Default memstore with NO MSLAB&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1947.330 secs&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2214.201 secs&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;No of GC pauses for 100 threads&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Default memstore with MSLAB &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Default memstore with NO MSLAB&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;403&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;475&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;GC pause in secs for 100 threads&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Default memstore with MSLAB &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Default memstore with NO MSLAB&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;181.58 secs&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;239.9 secs&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Pls feel free to share your feedback or thoughts on this. It helps to see if there is something to be tested or some configs needs to be changed and the tests has to be repeated. &lt;/p&gt;</comment>
                            <comment id="15547684" author="ram_krish" created="Wed, 5 Oct 2016 05:03:08 +0000"  >&lt;p&gt;Ping for feedback/reviews. This topic has been discussed quite frequently and it was concluded to have the MSLAB and chunkpool ON. The tests further shows it is needed. &lt;br/&gt;
If so we can close this JIRA. &lt;/p&gt;</comment>
                            <comment id="15547885" author="stack" created="Wed, 5 Oct 2016 06:59:14 +0000"  >&lt;p&gt;In doc. you had more GCs when MSLAB was on?&lt;/p&gt;</comment>
                            <comment id="15547894" author="ram_krish" created="Wed, 5 Oct 2016 07:02:46 +0000"  >&lt;p&gt;That is because the doc case we had done the tests with the POC code which had BB pooling on the Rpc layer side.&lt;br/&gt;
The trunk does not have it.&lt;/p&gt;
</comment>
                            <comment id="15547921" author="stack" created="Wed, 5 Oct 2016 07:17:41 +0000"  >&lt;p&gt;Trunk does not have pooling? We want that, right?&lt;/p&gt;</comment>
                            <comment id="15547932" author="ram_krish" created="Wed, 5 Oct 2016 07:23:32 +0000"  >&lt;p&gt;Oops. Sorry. I read the other way. The reason the number of GCs to be lesser in trunk case is that &lt;br/&gt;
in PE tool the oneCon = true is needed for me to run with 100 threads where as in the other case I was able to run without that property. So all threads were sharing the same connection. So comparatively the load was lesser or may be due to Netty client which I have not checked. But the overall take away is that MSLAB ON is beneficial ( in terms of this JIRA&apos;s purpose).  If the other report is creating a confusion here, I will edit the comment so that only the trunk related test details are revealed here. Anyway once the offheap things are integrated to trunk we plan to carry out one more set of test runs.&lt;br/&gt;
Ya we need BB pool in trunk too. &lt;/p&gt;</comment>
                            <comment id="15550103" author="vrodionov" created="Wed, 5 Oct 2016 22:16:11 +0000"  >&lt;blockquote&gt;
&lt;p&gt;But the overall take away is that MSLAB ON is beneficial&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure, were these tests with chunk pool enabled? How beneficial is chunk pool by itself, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="15550918" author="ram_krish" created="Thu, 6 Oct 2016 05:21:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sure, were these tests with chunk pool enabled? How beneficial is chunk pool by itself, ramkrishna.s.vasudevan?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. The entire tests were with MSLAB and Chunk Pool ON. &lt;br/&gt;
Chunk pool is ideally the one where the actual object reuse happens. So for offheap buffers that is a  must have to avoid offheap memory fragementation and problems leading to unclaimed offheap buffers lying. &lt;/p&gt;</comment>
                            <comment id="15553616" author="vrodionov" created="Fri, 7 Oct 2016 00:02:07 +0000"  >&lt;p&gt;I think we have got enough pro-pool pro-MSLAB evidence already. What do you think, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=saint.ack%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;saint.ack@gmail.com&quot;&gt;Stack&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="15554857" author="ram_krish" created="Fri, 7 Oct 2016 11:30:05 +0000"  >&lt;p&gt;Yes. All tests have been performed with MSLAB and chunk pool ON. &lt;br/&gt;
When there is no MSLAB there is no Chunk pool also. JFI.&lt;/p&gt;</comment>
                            <comment id="15563851" author="enis" created="Mon, 10 Oct 2016 23:13:07 +0000"  >&lt;p&gt;So as a result of this, we will enable chunk pool by default? From the results, it seems that we should even with G1. &lt;/p&gt;</comment>
                            <comment id="15563893" author="vrodionov" created="Mon, 10 Oct 2016 23:32:59 +0000"  >&lt;p&gt;Yes.&lt;/p&gt;

&lt;p&gt;We have a JIRA: &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15513&quot; title=&quot;hbase.hregion.memstore.chunkpool.maxsize is 0.0 by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15513&quot;&gt;&lt;del&gt;HBASE-15513&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15564497" author="stack" created="Tue, 11 Oct 2016 05:12:40 +0000"  >&lt;p&gt;Was the server under load when only one client pushing load?&lt;/p&gt;</comment>
                            <comment id="15564510" author="stack" created="Tue, 11 Oct 2016 05:20:30 +0000"  >&lt;p&gt;Were we doing any i/o? Or all was cached?&lt;/p&gt;

&lt;p&gt;Client was on same machine as the RS. How many cores? &lt;/p&gt;

&lt;p&gt;Nice writeup.&lt;/p&gt;

&lt;p&gt;Lets flip the default for chunk pool to be on &amp;#8211; it has to be for the offheap and these basic tests show it generally better. There&apos;ll be more perf testing. If a mistake, we can undo then ( FYI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vrodionov&quot; class=&quot;user-hover&quot; rel=&quot;vrodionov&quot;&gt;Vladimir Rodionov&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="15564682" author="ram_krish" created="Tue, 11 Oct 2016 06:46:06 +0000"  >&lt;p&gt;it was only one client. &lt;br/&gt;
Client on the same machine as RS. Single node Set up. If needed I can try with client on another node.&lt;br/&gt;
Its a 24 core machine.&lt;/p&gt;</comment>
                            <comment id="15567741" author="ram_krish" created="Wed, 12 Oct 2016 06:11:47 +0000"  >&lt;p&gt;I will close this JIRA linking &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15513&quot; title=&quot;hbase.hregion.memstore.chunkpool.maxsize is 0.0 by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15513&quot;&gt;&lt;del&gt;HBASE-15513&lt;/del&gt;&lt;/a&gt; as that is the outcome of this JIRA.&lt;/p&gt;</comment>
                            <comment id="15567747" author="ram_krish" created="Wed, 12 Oct 2016 06:15:18 +0000"  >&lt;p&gt;As per the reports and discussion we have concluded that MSLAB and chunk pool are beneficial. So will close this JIRA linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-15513&quot; title=&quot;hbase.hregion.memstore.chunkpool.maxsize is 0.0 by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-15513&quot;&gt;&lt;del&gt;HBASE-15513&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12952284">HBASE-15513</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 5 Oct 2016 06:59:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vdwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>