<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:53:41 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8276/HBASE-8276.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8276] Backport hbase-6738 to 0.94 &quot;Too aggressive task resubmission from the distributed log manager&quot;</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8276</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In recent tests, we found situations that when some data nodes are down and file operations are slow depending on underlying hdfs timeout(normally 30 secs and socket connection timeout maybe around 1 min). While split log task heart beat time out is only 25 secs, a split log task will be preempted by SplitLogManager and assign to someone else after the 25 secs. On a small cluster, you&apos;ll see the same task is keeping bounced back &amp;amp; force for a while. I pasted a snippet of related logs below. You can search &quot;preempted from&quot; to see a task is preempted.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-04-01 21:22:08,599 INFO org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Splitting hlog: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/.logs/ip-10-137-20-188.ec2.internal,60020,1364849530779-splitting/ip-10-137-20-188.ec2.internal%2C60020%2C1364849530779.1364865506159, length=127639653
&lt;/span&gt;2013-04-01 21:22:08,599 INFO org.apache.hadoop.hbase.util.FSHDFSUtils: Recovering file hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/.logs/ip-10-137-20-188.ec2.internal,60020,1364849530779-splitting/ip-10-137-20-188.ec2.internal%2C60020%2C1364849530779.1364865506159
&lt;/span&gt;2013-04-01 21:22:09,603 INFO org.apache.hadoop.hbase.util.FSHDFSUtils: Finished lease recover attempt &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/.logs/ip-10-137-20-188.ec2.internal,60020,1364849530779-splitting/ip-10-137-20-188.ec2.internal%2C60020%2C1364849530779.1364865506159
&lt;/span&gt;2013-04-01 21:22:09,629 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Found existing old edits file. It could be the result of a previous failed split attempt. Deleting hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/IntegrationTestLoadAndVerify/73387f8d327a45bacf069bd631d70b3b/recovered.edits/0000000000003703447.temp, length=0
&lt;/span&gt;2013-04-01 21:22:09,629 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Found existing old edits file. It could be the result of a previous failed split attempt. Deleting hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/IntegrationTestLoadAndVerify/b749cbceaaf037c97f70cc2a6f48f2b8/recovered.edits/0000000000003703446.temp, length=0
&lt;/span&gt;2013-04-01 21:22:09,630 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Found existing old edits file. It could be the result of a previous failed split attempt. Deleting hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/IntegrationTestLoadAndVerify/c26b9d4a042d42c1194a8c2f389d33c8/recovered.edits/0000000000003703448.temp, length=0
&lt;/span&gt;2013-04-01 21:22:09,666 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Found existing old edits file. It could be the result of a previous failed split attempt. Deleting hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/IntegrationTestLoadAndVerify/adabdb40ccd52140f09f953ff41fd829/recovered.edits/0000000000003703451.temp, length=0
&lt;/span&gt;2013-04-01 21:22:09,722 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Found existing old edits file. It could be the result of a previous failed split attempt. Deleting hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/IntegrationTestLoadAndVerify/19f463fe74f4365e7df3e5fdb13aecad/recovered.edits/0000000000003703468.temp, length=0
&lt;/span&gt;2013-04-01 21:22:09,734 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Found existing old edits file. It could be the result of a previous failed split attempt. Deleting hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/IntegrationTestLoadAndVerify/b3e759a3fc9c4e83064961cc3cd4a911/recovered.edits/0000000000003703459.temp, length=0
&lt;/span&gt;2013-04-01 21:22:09,770 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Found existing old edits file. It could be the result of a previous failed split attempt. Deleting hdfs:&lt;span class=&quot;code-comment&quot;&gt;//ip-10-137-16-140.ec2.internal:8020/apps/hbase/data/IntegrationTestLoadAndVerify/6f078553be50897a986734ae043a5889/recovered.edits/0000000000003703454.temp, length=0
&lt;/span&gt;2013-04-01 21:22:34,985 INFO org.apache.hadoop.hbase.regionserver.SplitLogWorker: task /hbase/splitlog/hdfs%3A%2F%2Fip-10-137-16-140.ec2.internal%3A8020%2Fapps%2Fhbase%2Fdata%2F.logs%2Fip-10-137-20-188.ec2.internal%2C60020%2C1364849530779-splitting%2Fip-10-137-20-188.ec2.internal%252C60020%252C1364849530779.1364865506159 preempted from ip-10-151-29-196.ec2.internal,60020,1364849530671, current task state and owner=unassigned ip-10-137-16-140.ec2.internal,60000,1364849528428
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The exact same issue is fixed by hbase-6738 in trunk so here comes the backport. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12640899">HBASE-8276</key>
            <summary>Backport hbase-6738 to 0.94 &quot;Too aggressive task resubmission from the distributed log manager&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jeffreyz">Jeffrey Zhong</assignee>
                                    <reporter username="jeffreyz">Jeffrey Zhong</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Apr 2013 00:34:10 +0000</created>
                <updated>Sat, 27 Apr 2013 15:55:17 +0000</updated>
                            <resolved>Sat, 6 Apr 2013 03:23:31 +0000</resolved>
                                                    <fixVersion>0.94.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13623229" author="jeffreyz" created="Fri, 5 Apr 2013 01:14:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkeywal&quot; class=&quot;user-hover&quot; rel=&quot;nkeywal&quot;&gt;Nicolas Liochon&lt;/a&gt; Could you please review this if it&apos;s good on 0.94 branch?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Jeffrey&lt;/p&gt;</comment>
                            <comment id="13623453" author="nkeywal" created="Fri, 5 Apr 2013 08:25:45 +0000"  >&lt;p&gt;I think (I m&apos;not sure but it seems better) we should put here the release notes of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6738&quot; title=&quot;Too aggressive task resubmission from the distributed log manager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6738&quot;&gt;&lt;del&gt;HBASE-6738&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+      ServerName curWorker = null;
+      if (!Strings.isNullOrEmpty(task.cur_worker_name)) {
+        try {
+          curWorker = ServerName.parseServerName(task.cur_worker_name);
+        } catch (IllegalArgumentException ie) {
+          LOG.warn(&quot;Got invalid server name:&quot; + task.cur_worker_name);
+        }
+      }
+      final boolean alive =
+          (master.getServerManager() != null &amp;amp;&amp;amp; curWorker != null) ? master.getServerManager()
+              .isServerOnline(curWorker) : true;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You&apos;re doing more work than on 0.95 here (on 0.95 we don&apos;t parse task.cur_worker_name and we expect it to be non null/non empty).&lt;br/&gt;
Does it mean that 0.95 has a bug?&lt;/p&gt;

&lt;p&gt;If I&apos;m not wrong, if it can&apos;t be parsed or it&apos;s null it will be marked as live hence not submitted before the timeout. I don&apos;t have any opinion on this (I guess we&apos;re in a bad shape anyway), but we we log our intend explicitly&lt;br/&gt;
+        } catch (IllegalArgumentException ie) &lt;/p&gt;
{
+          LOG.error(&quot;Got invalid server name:&quot; + task.cur_worker_name + &quot; - task &quot; +  taskId + &quot; won&apos;t be resubmitted before timeout&quot;);
+        }
&lt;p&gt;+      } else &lt;/p&gt;
{
+          LOG.error(&quot;Got empty/null server name:&quot; + task.cur_worker_name + &quot; - task &quot; +  taskId + &quot; won&apos;t be resubmitted before timeout&quot;);
+       }

&lt;p&gt;In anycase, the code should be commented to say if the check is for protecting us from a development bugs or of if it&apos;s something that can be expected in some conditions in production.&lt;/p&gt;

&lt;p&gt;As well, we should not rely on the timeout imho (imho, the original distributed split should have relied only on the ZK timeout: my initial patch kept itto be compatible with the existing design while adding this, but I would personnaly recommend a timeout of 15 minutes or no timeout at all).&lt;/p&gt;</comment>
                            <comment id="13624037" author="jeffreyz" created="Fri, 5 Apr 2013 20:33:27 +0000"  >&lt;p&gt;Incorporate Nicolas feedbacks.&lt;/p&gt;</comment>
                            <comment id="13624069" author="jeffreyz" created="Fri, 5 Apr 2013 21:06:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkeywal&quot; class=&quot;user-hover&quot; rel=&quot;nkeywal&quot;&gt;Nicolas Liochon&lt;/a&gt; Thanks for reviewing!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;You&apos;re doing more work than on 0.95 here (on 0.95 we don&apos;t parse task.cur_worker_name and we expect it to be non null/non empty).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Because in 0.94, task.cur_worker_name is declared as &quot;String&quot; not &quot;ServerName&quot; so I have to convert it to ServerName.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;but we we log our intend explicitly&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good point!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I would personnaly recommend a timeout of 15 minutes&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Per our discussion, I&apos;ll increase the timeout to 5 mins to be good in normal cases. A user still able to adjust it for extreme situations.&lt;/p&gt;</comment>
                            <comment id="13624132" author="yuzhihong@gmail.com" created="Fri, 5 Apr 2013 22:26:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;:&lt;br/&gt;
Okay to include in 0.94.7 ?&lt;/p&gt;</comment>
                            <comment id="13624134" author="lhofhansl" created="Fri, 5 Apr 2013 22:31:25 +0000"  >&lt;p&gt;Looks good. In 0.94 can we get away with just increasing the timeout to 5mins?&lt;/p&gt;</comment>
                            <comment id="13624140" author="jeffreyz" created="Fri, 5 Apr 2013 22:41:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; For your question:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In 0.94 can we get away with just increasing the timeout to 5mins?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;A good question. I guess not. The reason we could possibly increase the timeout to 5mins because the patch adds the logic to immediately resubmit a task when a dead server is detected without reaching timeout(while, before the fix, SplitLogManager waits for 25 secs timeout no matter if a server is already marked as dead in master). Back to your question, if we just bump up the time out to 5mins, it will hurt recovery time because log splitting slow down for normal dead server scenarios.&lt;/p&gt;</comment>
                            <comment id="13624196" author="lhofhansl" created="Fri, 5 Apr 2013 23:51:28 +0000"  >&lt;p&gt;Thanks Jeffrey. +1 on patch then.&lt;/p&gt;</comment>
                            <comment id="13624204" author="yuzhihong@gmail.com" created="Fri, 5 Apr 2013 23:56:41 +0000"  >&lt;p&gt;Integrated to 0.94&lt;/p&gt;

&lt;p&gt;Thanks for the patch, Jeffrey.&lt;/p&gt;

&lt;p&gt;Thanks for the reviews, Nicolas and Lars.&lt;/p&gt;</comment>
                            <comment id="13624563" author="hudson" created="Sun, 7 Apr 2013 01:18:57 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #949 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/949/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/949/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8276&quot; title=&quot;Backport hbase-6738 to 0.94 &amp;quot;Too aggressive task resubmission from the distributed log manager&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8276&quot;&gt;&lt;del&gt;HBASE-8276&lt;/del&gt;&lt;/a&gt; Backport hbase-6738 to 0.94 &quot;Too aggressive task resubmission from the distributed log manager&quot; (Jeffrey) (Revision 1465161)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/SplitLogManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKSplitLog.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestSplitLogManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13626344" author="hudson" created="Tue, 9 Apr 2013 07:33:24 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #133 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/133/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/133/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8276&quot; title=&quot;Backport hbase-6738 to 0.94 &amp;quot;Too aggressive task resubmission from the distributed log manager&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8276&quot;&gt;&lt;del&gt;HBASE-8276&lt;/del&gt;&lt;/a&gt; Backport hbase-6738 to 0.94 &quot;Too aggressive task resubmission from the distributed log manager&quot; (Jeffrey) (Revision 1465161)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/MasterFileSystem.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/SplitLogManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKSplitLog.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestSplitLogManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12577284" name="hbase-8276-v1.patch" size="16567" author="jeffreyz" created="Fri, 5 Apr 2013 20:33:27 +0000"/>
                            <attachment id="12577124" name="hbase-8276.patch" size="16308" author="jeffreyz" created="Fri, 5 Apr 2013 01:14:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 5 Apr 2013 08:25:45 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>321358</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 36 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1jg3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>321703</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The Split Log Manager now takes into account the state of the region server doing the split. If this region server is marked as dead (i.e. its ZooKeeper connection expires), its task is immediately resubmitted. If the region server is still in the &amp;quot;alive&amp;quot; state, then we wait for 5 minutes before resubmitting, instead of 25 seconds previously. This delay can be changed with the parameter &amp;quot;hbase.splitlog.manager.timeout&amp;quot; (milliseconds, new default: 300000). </customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>