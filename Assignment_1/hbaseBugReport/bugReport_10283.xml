<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:12:17 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-10283/HBASE-10283.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-10283] Client can&apos;t connect with all the running zk servers in MiniZooKeeperCluster</title>
                <link>https://issues.apache.org/jira/browse/HBASE-10283</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Refer to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3052&quot; title=&quot;Add ability to have multiple ZK servers in a quorum in MiniZooKeeperCluster for test writing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3052&quot;&gt;&lt;del&gt;HBASE-3052&lt;/del&gt;&lt;/a&gt;, multiple zk servers can run together in minicluster. The problem is that client can only connect with the first zk server and if you kill the first one, it fails to access the cluster even though other zk servers are serving.&lt;/p&gt;

&lt;p&gt;It&apos;s easy to repro.  Firstly `TEST_UTIL.startMiniZKCluster(3)`. Secondly call `killCurrentActiveZooKeeperServer` in MiniZooKeeperCluster. Then when you construct the zk client, it can&apos;t connect with the zk cluster for any way. Here is the simple log you can refer.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-01-03 12:06:58,625 INFO  [main] zookeeper.MiniZooKeeperCluster(194): Started MiniZK Cluster and connect 1 ZK server on client port: 55227
......
2014-01-03 12:06:59,134 INFO  [main] zookeeper.MiniZooKeeperCluster(264): Kill the current active ZK servers in the cluster on client port: 55227
2014-01-03 12:06:59,134 INFO  [main] zookeeper.MiniZooKeeperCluster(272): Activate a backup zk server in the cluster on client port: 55228
2014-01-03 12:06:59,366 INFO  [main-EventThread] zookeeper.ZooKeeper(434): Initiating client connection, connectString=localhost:55227 sessionTimeout=3000 watcher=com.xiaomi.infra.timestamp.TimestampWatcher@a383118
(then it throws exceptions......)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The log is kind of problematic because it always show &quot;Started MiniZK Cluster and connect 1 ZK server&quot; but actually there&apos;re three zk servers.&lt;/p&gt;

&lt;p&gt;Looking deeply we find that the client is still trying to connect with the dead zk server&apos;s port. When I print out the zkQuorum it used, only the first zk server&apos;s hostport is there and it will not change no matter you kill the server or not. The reason for this is in ZKConfig which will convert HBase settings into zk&apos;s. MiniZooKeeperCluster create three servers with the same host name, &quot;localhost&quot;, and different ports. But HBase self force to use the same port for each zk server and ZKConfig will ignore the other two servers which have the same host name.&lt;/p&gt;

&lt;p&gt;MiniZooKeeperCluster works improperly before we fix this. The bug is not found because we never test whether HBase works or not if we kill the zk active or backup servers in ut. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12687391">HBASE-10283</key>
            <summary>Client can&apos;t connect with all the running zk servers in MiniZooKeeperCluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="tobe">chendihao</assignee>
                                    <reporter username="tobe">chendihao</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Jan 2014 04:02:14 +0000</created>
                <updated>Tue, 14 Jan 2014 08:02:54 +0000</updated>
                                            <version>0.94.3</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13869396" author="tobe" created="Mon, 13 Jan 2014 10:13:33 +0000"  >&lt;p&gt;There&apos;re two solutions for this. The first one is allowing to set different zk ports for HBase(generic but contrary to original design). And the next one is adding extra code in ZKConf to support multiple ports for MiniZooKeeperCluster. I prefer the last one and try to reduce the change of code. &lt;/p&gt;

&lt;p&gt;MiniZooKeeperCluster can&apos;t be used for zk failover test before it&apos;s fixed. Can &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; help to review this?&lt;/p&gt;</comment>
                            <comment id="13869517" author="tobe" created="Mon, 13 Jan 2014 13:09:17 +0000"  >&lt;p&gt;patch for 0.94&lt;/p&gt;</comment>
                            <comment id="13870504" author="tobe" created="Tue, 14 Jan 2014 08:02:54 +0000"  >&lt;p&gt;Thanks all &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
There&apos;re two minor issues about minicluster, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10282&quot; title=&quot;We can&amp;#39;t assure that the first ZK server is active server in MiniZooKeeperCluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10282&quot;&gt;HBASE-10282&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10283&quot; title=&quot;Client can&amp;#39;t connect with all the running zk servers in MiniZooKeeperCluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10283&quot;&gt;HBASE-10283&lt;/a&gt;, do you mind taking a look?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12622621" name="HBASE-10283-0.94-v1.patch" size="1526" author="tobe" created="Mon, 13 Jan 2014 13:09:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366392</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1r5mv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366703</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>