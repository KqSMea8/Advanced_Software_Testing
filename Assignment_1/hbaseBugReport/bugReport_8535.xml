<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:56:10 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8535/HBASE-8535.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8535] Test for zk leak does not account for unsynchronized access to zk watcher</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8535</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Test can detect a live zk connection in a closed hconnection because it does not accesses the zk watcher in a synchronized manner. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12647318">HBASE-8535</key>
            <summary>Test for zk leak does not account for unsynchronized access to zk watcher</summary>
                <type id="6" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/requirement.png">Test</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="yue">Eric Yu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 May 2013 15:26:46 +0000</created>
                <updated>Mon, 23 Sep 2013 19:08:26 +0000</updated>
                            <resolved>Wed, 15 May 2013 15:34:56 +0000</resolved>
                                    <version>0.98.0</version>
                    <version>0.95.1</version>
                                    <fixVersion>0.98.0</fixVersion>
                    <fixVersion>0.95.1</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13656082" author="hadoopqa" created="Mon, 13 May 2013 16:34:50 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12582938/HBASE-8535.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12582938/HBASE-8535.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop1.0&lt;/font&gt;.  The patch compiles against the hadoop 1.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop2.0&lt;/font&gt;.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5652//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13657714" author="stack" created="Tue, 14 May 2013 23:59:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt; Patch looks good but I am not too clear on what it does &amp;#8211; seems like it moves the close out a paren...  Can you saw what is changed?  Thanks.&lt;/p&gt;</comment>
                            <comment id="13658074" author="stack" created="Wed, 15 May 2013 05:26:03 +0000"  >&lt;p&gt;Is the patch here to fix this kind of failure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt; ? &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/4118/testReport/org.apache.hadoop.hbase.client/TestHCM/testDeleteForZKConnLeak/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/4118/testReport/org.apache.hadoop.hbase.client/TestHCM/testDeleteForZKConnLeak/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13658324" author="yue" created="Wed, 15 May 2013 12:54:18 +0000"  >&lt;p&gt;@stack Yes, this change is meant to correct a flaw in the testDeleteForZKConnLeak where it will occassionally fail for versions 0.95 and 0.98. On internalClose, HConnection implementation marks itself as closed and then closes watcher. So the test fails if it checks after the connection is marked as closed but before the watcher is closed. The test doesn&apos;t have access to the object used internally by HConnection to synchronize so I added a delay that double checks whether the watcher is closed if watcher was still open. I didn&apos;t always delay every time because I didn&apos;t want to slow down the test too much.&lt;/p&gt;</comment>
                            <comment id="13658466" author="stack" created="Wed, 15 May 2013 15:34:56 +0000"  >&lt;p&gt;Committed to trunk and 0.95 branch.   Thanks for fixing a failing test Eric.&lt;/p&gt;</comment>
                            <comment id="13658565" author="hudson" created="Wed, 15 May 2013 17:36:37 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #4121 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/4121/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/4121/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8535&quot; title=&quot;Test for zk leak does not account for unsynchronized access to zk watcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8535&quot;&gt;&lt;del&gt;HBASE-8535&lt;/del&gt;&lt;/a&gt; Test for zk leak does not account for unsynchronized access to zk watcher (Revision 1482905)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13658578" author="stack" created="Wed, 15 May 2013 17:48:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt; I see that TestHCM just hung on the trunk build &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/4121/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/4121/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Do you think it related at all going by the output:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/4121/artifact/trunk/hbase-server/target/surefire-reports/org.apache.hadoop.hbase.client.TestHCM-output.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/4121/artifact/trunk/hbase-server/target/surefire-reports/org.apache.hadoop.hbase.client.TestHCM-output.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think I&apos;ll dig in anyways but asking just in case you have insight...&lt;/p&gt;</comment>
                            <comment id="13658593" author="yue" created="Wed, 15 May 2013 17:57:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=saint.ack%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;saint.ack@gmail.com&quot;&gt;Stack&lt;/a&gt; Does appear to be related as that test is the one that uses the method that generates this log &lt;br/&gt;
2013-05-15 16:08:55,270 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;test-hcm-delete-pool-267-thread-1&amp;#93;&lt;/span&gt; client.HConnectionManager$HConnectionImplementation(609): ClusterId is default-cluster&lt;/p&gt;

&lt;p&gt;I will take a look as well.&lt;/p&gt;</comment>
                            <comment id="13658612" author="stack" created="Wed, 15 May 2013 18:05:38 +0000"  >&lt;p&gt;Hmm... the hang seems to originate in the test this patch fixes.  Search for &apos;before: client.TestHCM#testDeleteForZKConnLeak&apos; in the output above.&lt;/p&gt;

&lt;p&gt;The test falls into a loop about here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2013-05-15 16:07:44,351 WARN  [pool-1-thread-1] zookeeper.RecoverableZooKeeper(237): Possibly &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; ZooKeeper, quorum=localhost:54737, exception=org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /hbase/meta-region-server
2013-05-15 16:07:44,351 INFO  [pool-1-thread-1] util.RetryCounter(54): Sleeping 2000ms before retry #1...
2013-05-15 16:07:44,351 DEBUG [pool-1-thread-1-EventThread] zookeeper.ZooKeeperWatcher(377): hconnection-0x10ea988-0x13ea8f23825000e connected
2013-05-15 16:07:44,352 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,354 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,355 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,356 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,359 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,360 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,362 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,364 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,365 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,366 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,366 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,367 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,368 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,369 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
2013-05-15 16:07:44,370 INFO  [test-hcm-delete-pool-267-thread-1] client.HConnectionManager$HConnectionImplementation(609): ClusterId is &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-cluster
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you want to punt to me that is fine Eric, just say, and I&apos;ll open a new issue to dig in on it (minimally we should never spew as we do above the same INFO log every miliisecond.&lt;/p&gt;</comment>
                            <comment id="13658636" author="yue" created="Wed, 15 May 2013 18:30:27 +0000"  >&lt;p&gt;testDeleteForZKConnLeak is using a hconnection to create a HTable while another thread is calling deleteStaleConnection because previous if a hconnection gets closed at the wrong time while it is being used by constructor of HTable, HTable constructor can restart zk connection on a closed hconnection. I couldn&apos;t figure out how to reproduce the problem precisely so the test just calls both a lot in two separate threads and hopes that if a leak exists, it will happen during the test. However, when the conn gets closed while being used for HTable constructor, there is an exception and a sleep and a retry three times (2s, 4s, 8s?) somewhere in the constructor that makes the test quite slow. I will see if I can set connection property to not do this retry.  &lt;/p&gt;</comment>
                            <comment id="13658656" author="yue" created="Wed, 15 May 2013 18:44:41 +0000"  >&lt;p&gt;I&apos;m not sure why, but the exception doesn&apos;t occur as frequently when I run the test locally. For some reason, the exception occurs much more frequently for ci (util.RetryCounter logs much more frequently). Anyway, I will see if modifying RecoverableZookeeper retry count and retry wait (zookeeper.recovery.retry, zookeeper.recovery.retry.intervalmill) in the config used by the test will help.&lt;/p&gt;</comment>
                            <comment id="13658660" author="stack" created="Wed, 15 May 2013 18:49:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt; Does the test make sense?  Deleting a &apos;stale&apos; connection though it is in use?  And why no protection against a stale delete coming in on a connection in use?  I was going to look at this...&lt;/p&gt;</comment>
                            <comment id="13658662" author="stack" created="Wed, 15 May 2013 18:52:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt; nvm  The test is yours IIRC.  If you want, I can take this one np.  I should fix that spew at least.&lt;/p&gt;</comment>
                            <comment id="13658682" author="stack" created="Wed, 15 May 2013 19:14:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt; It fails for me the odd time locally; taking a look see too... &lt;/p&gt;</comment>
                            <comment id="13658693" author="stack" created="Wed, 15 May 2013 19:32:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt; hmm... so it is just slow &amp;#8211; especially if connection gets trounced at a particularly bad time.  Maybe we don&apos;t have to cycle 50 times.  And we could remove the dumb log line:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java
index 763b79f..6455c07 100644
--- a/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java
+++ b/hbase-client/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java
@@ -604,9 +604,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class HConnectionManager {
       &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.clusterId = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.registry.getClusterId();
       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (clusterId == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
         clusterId = HConstants.CLUSTER_ID_DEFAULT;
+        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;clusterid came back &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; &quot;&lt;/span&gt; + clusterId);
       }
-
-      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;ClusterId is &quot;&lt;/span&gt; + clusterId);
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;... to get rid of the spew.&lt;/p&gt;
</comment>
                            <comment id="13658709" author="yue" created="Wed, 15 May 2013 19:49:17 +0000"  >&lt;p&gt;Also need to set hbase.rpc.timeout for this test to get it to finish in a decent amount of time. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=saint.ack%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;saint.ack@gmail.com&quot;&gt;Stack&lt;/a&gt; I assumed a stale connection was one that had old values and anything using it would expect to see exceptions anyways. If not, probably wouldn&apos;t be too big a change to just remove stale hconnection from hcm map and wait until every client has released it to close the hconnection.&lt;/p&gt;</comment>
                            <comment id="13658745" author="stack" created="Wed, 15 May 2013 20:21:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt; &apos;stale&apos; is a judgement made on a Connection by a HConnectionManager when close is called &amp;#8211; the connection is being aborted/abandoned so all bets are off ... crash it down and clean up all resources overriding all usual cleanup mechanisms to do stuff like force cleanup of the zk ignoring the reference counting the connection is doing so connections are reused rather than estabilished every time.  Would NOT calling deleteStaleConnection be a better test, instead just calling a close o the connection in your background thread?  Would it repro what you were seeing from your app; i.e. if all connections closed, then should be no outstanding zks?  Do you need an api to see if zk still up?&lt;/p&gt;</comment>
                            <comment id="13658780" author="yue" created="Wed, 15 May 2013 20:40:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=saint.ack%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;saint.ack@gmail.com&quot;&gt;Stack&lt;/a&gt;Calling just close doesn&apos;t cause zk leak in previous version as hcm would only wipe out the connection if it isn&apos;t allocated to any clients. Problem only happened when the connection is wiped out while other clients are still using i.e. connection user would start creating HTable, verify connection is open, closeStale caller would mark connection as closed and shutdown zk, connection user thread would call getZKWatcher which would restart zk). The overwhelming majority of cases our application calls close, but sometimes if app thinks the connection is no longer usable, our app will call closeStale.&lt;/p&gt;

&lt;p&gt;I don&apos;t think it is necessary to add to the api just for a test case. Ideally, client of connection doesn&apos;t need to know anything about zk.&lt;/p&gt;

</comment>
                            <comment id="13658791" author="yue" created="Wed, 15 May 2013 20:45:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=saint.ack%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;saint.ack@gmail.com&quot;&gt;Stack&lt;/a&gt; I have values for config properties that I believe will make the test run faster when exceptions occur. Should I submit a new version of patch for this jira or did you want a separate jira and also include the change from debug to info level?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java
===================================================================
--- hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java              (revision 1483058)
+++ hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java           (working copy)
@@ -809,7 +814,10 @@
   @Test
   public void testDeleteForZKConnLeak() throws Exception {
     TEST_UTIL.createTable(TABLE_NAME4, FAM_NAM);
-    final Configuration config = TEST_UTIL.getConfiguration();
+    final Configuration config = HBaseConfiguration.create(TEST_UTIL.getConfiguration());
+    config.setInt(&quot;zookeeper.recovery.retry&quot;, 1);
+    config.setInt(&quot;zookeeper.recovery.retry.intervalmill&quot;, 1000);
+    config.setInt(&quot;hbase.rpc.timeout&quot;, 2000);

     ThreadPoolExecutor pool = new ThreadPoolExecutor(1, 10,
       5, TimeUnit.SECONDS,
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13658939" author="stack" created="Wed, 15 May 2013 22:34:43 +0000"  >&lt;p&gt;Here is an addendum.&lt;/p&gt;

&lt;p&gt;A few things.&lt;/p&gt;

&lt;p&gt;+ This test as is takes too long; 4minutes down here on my laptop and that is with Eric&apos;s new suggested lower timeouts (incorporated).  I changed the number of cycles from 50 to 30.&lt;br/&gt;
+ We are closing zk connections so aggressively, the retries cuts in setting up the HTable instance with its expotential backouff.... I cut down the retries to 3.  And added small pause of 10ms between trashing zk closes.&lt;br/&gt;
+ My &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8531&quot; title=&quot;TestZooKeeper fails in trunk/0.95 builds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8531&quot;&gt;&lt;del&gt;HBASE-8531&lt;/del&gt;&lt;/a&gt; TestZooKeeper fails in trunk/0.95 builds&quot; commit was missing an implementation of the get clusterid.. I add it back in here... it helps this test anyways.&lt;br/&gt;
+ Added logging and some comments around the test so its easier to understand why.&lt;/p&gt;

</comment>
                            <comment id="13658953" author="stack" created="Wed, 15 May 2013 22:49:30 +0000"  >&lt;p&gt;Here is what I will commit...  Adds more comments and downed the retries.  still takes too long but when it goes to long, it means we&apos;ve reproduced the car crash we were looking for... (Added a TODO: where we first cycle a few times to get timings that make sense for the context before we start doing connection killing....).&lt;/p&gt;</comment>
                            <comment id="13658958" author="stack" created="Wed, 15 May 2013 22:53:37 +0000"  >&lt;p&gt;I committed the addendum.  Lets see if it cures the hanging.  Will do another issue if I see it hang again.  Thanks for help &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ericyu&quot; class=&quot;user-hover&quot; rel=&quot;ericyu&quot;&gt;Eric Yu&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13658962" author="hudson" created="Wed, 15 May 2013 22:57:41 +0000"  >&lt;p&gt;Integrated in hbase-0.95 #196 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.95/196/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.95/196/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8535&quot; title=&quot;Test for zk leak does not account for unsynchronized access to zk watcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8535&quot;&gt;&lt;del&gt;HBASE-8535&lt;/del&gt;&lt;/a&gt; Test for zk leak does not account for unsynchronized access to zk watcher (Revision 1482904)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.95/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13659232" author="hudson" created="Thu, 16 May 2013 05:19:49 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #532 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/532/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/532/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8535&quot; title=&quot;Test for zk leak does not account for unsynchronized access to zk watcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8535&quot;&gt;&lt;del&gt;HBASE-8535&lt;/del&gt;&lt;/a&gt; Test for zk leak does not account for unsynchronized access to zk watcher (Revision 1482905)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13659266" author="hudson" created="Thu, 16 May 2013 06:13:05 +0000"  >&lt;p&gt;Integrated in hbase-0.95-on-hadoop2 #101 (See &lt;a href=&quot;https://builds.apache.org/job/hbase-0.95-on-hadoop2/101/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/hbase-0.95-on-hadoop2/101/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8535&quot; title=&quot;Test for zk leak does not account for unsynchronized access to zk watcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8535&quot;&gt;&lt;del&gt;HBASE-8535&lt;/del&gt;&lt;/a&gt; Test for zk leak does not account for unsynchronized access to zk watcher (Revision 1482904)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.95/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13711540" author="hudson" created="Wed, 17 Jul 2013 19:54:30 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.94-security #213 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/213/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/213/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8969&quot; title=&quot;Backport HBASE-8535+HBASE-8586 TestHCM#testDeleteForZKConnLeak  enhancement to 0.94&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8969&quot;&gt;&lt;del&gt;HBASE-8969&lt;/del&gt;&lt;/a&gt; Backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8535&quot; title=&quot;Test for zk leak does not account for unsynchronized access to zk watcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8535&quot;&gt;&lt;del&gt;HBASE-8535&lt;/del&gt;&lt;/a&gt;+&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8586&quot; title=&quot;Revisit of hbase-8483, &amp;quot;HConnectionManager can leak ZooKeeper connections when using deleteStaleConnection&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8586&quot;&gt;&lt;del&gt;HBASE-8586&lt;/del&gt;&lt;/a&gt; TestHCM#testDeleteForZKConnLeak enhancement to 0.94 (jxiang: rev 1504215)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13711602" author="hudson" created="Wed, 17 Jul 2013 20:52:48 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.94 #1059 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/1059/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/1059/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8969&quot; title=&quot;Backport HBASE-8535+HBASE-8586 TestHCM#testDeleteForZKConnLeak  enhancement to 0.94&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8969&quot;&gt;&lt;del&gt;HBASE-8969&lt;/del&gt;&lt;/a&gt; Backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8535&quot; title=&quot;Test for zk leak does not account for unsynchronized access to zk watcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8535&quot;&gt;&lt;del&gt;HBASE-8535&lt;/del&gt;&lt;/a&gt;+&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8586&quot; title=&quot;Revisit of hbase-8483, &amp;quot;HConnectionManager can leak ZooKeeper connections when using deleteStaleConnection&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8586&quot;&gt;&lt;del&gt;HBASE-8586&lt;/del&gt;&lt;/a&gt; TestHCM#testDeleteForZKConnLeak enhancement to 0.94 (jxiang: rev 1504215)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/client/TestHCM.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12583390" name="8535.addendum.txt" size="4510" author="stack" created="Wed, 15 May 2013 22:34:43 +0000"/>
                            <attachment id="12583392" name="8535.addendumv2.txt" size="5323" author="stack" created="Wed, 15 May 2013 22:49:30 +0000"/>
                            <attachment id="12582938" name="HBASE-8535.patch" size="2347" author="yue" created="Mon, 13 May 2013 15:29:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 13 May 2013 16:34:50 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327674</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kjbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>328018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>