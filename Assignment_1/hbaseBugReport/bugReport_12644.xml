<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:34:59 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-12644/HBASE-12644.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-12644] Visibility Labels: issue with storing super users in labels table</title>
                <link>https://issues.apache.org/jira/browse/HBASE-12644</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Super users have all the permissions for ACL and Visibility labels.&lt;br/&gt;
They are defined in hbase-site.xml.&lt;br/&gt;
Currently in VisibilityController, we persist super user with their system permission in hbase:labels.&lt;br/&gt;
This makes change in super user difficult.&lt;br/&gt;
There are two issues:&lt;br/&gt;
In the current DefaultVisibilityLabelServiceImpl.addSystemLabel, we only add super user when we initially create the &apos;system&apos; label.&lt;br/&gt;
No additional update after that even if super user changed. See code for details.&lt;/p&gt;

&lt;p&gt;Additionally, there is no mechanism to remove any super user from the labels table.&lt;/p&gt;

&lt;p&gt;We probably should not persist super users in the labels table.&lt;br/&gt;
They are in hbase-site.xml and can just stay in labelsCache and used from labelsCache after retrieval by Visibility Controller.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12759809">HBASE-12644</key>
            <summary>Visibility Labels: issue with storing super users in labels table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jinghe">Jerry He</assignee>
                                    <reporter username="jinghe">Jerry He</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Dec 2014 19:51:02 +0000</created>
                <updated>Sat, 21 Feb 2015 23:50:13 +0000</updated>
                            <resolved>Tue, 16 Dec 2014 01:51:21 +0000</resolved>
                                    <version>0.98.8</version>
                    <version>0.99.2</version>
                                    <fixVersion>1.0.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                    <fixVersion>0.98.10</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="14236014" author="jinghe" created="Fri, 5 Dec 2014 20:04:25 +0000"  >&lt;p&gt;In the AccessController, it seems that we don&apos;t persist any super user info in the hbase:acl table.&lt;/p&gt;</comment>
                            <comment id="14236038" author="jinghe" created="Fri, 5 Dec 2014 20:15:30 +0000"  >&lt;p&gt;Attached a patch.&lt;br/&gt;
No big change.  Just put super user auth info in the labelsCache always.&lt;br/&gt;
It will be sync&apos;ed thru zk watch as usual.&lt;br/&gt;
Comment, concern?  I will do more testing.&lt;/p&gt;</comment>
                            <comment id="14236204" author="hadoopqa" created="Fri, 5 Dec 2014 22:14:23 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12685415/HBASE-12644-master.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12685415/HBASE-12644-master.patch&lt;/a&gt;&lt;br/&gt;
  against master branch at commit 09cd3d7bfb9f4c4b279a74441d4059da6b8177d2.&lt;br/&gt;
  ATTACHMENT ID: 12685415&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 checkstyle&lt;/font&gt;.  The applied patch does not increase the total number of checkstyle errors&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-thrift.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-hadoop2-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-rest.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-rest.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-annotations.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/newPatchFindbugsWarningshbase-annotations.html&lt;/a&gt;&lt;br/&gt;
Checkstyle Errors: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/checkstyle-aggregate.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//artifact/patchprocess/checkstyle-aggregate.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;  Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11957//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14236666" author="anoop.hbase" created="Sat, 6 Dec 2014 07:04:36 +0000"  >&lt;p&gt;Thanks for the test and issue Jerry.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Additionally, there is no mechanism to remove any super user from the labels table.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Will the patch fix this also? I believe no.&lt;/p&gt;</comment>
                            <comment id="14237069" author="jinghe" created="Sun, 7 Dec 2014 06:20:45 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoop.hbase&quot; class=&quot;user-hover&quot; rel=&quot;anoop.hbase&quot;&gt;Anoop Sam John&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let me step back a little.&lt;br/&gt;
Currently we can actually use &apos;clear_auths&apos; to remove a super user&apos;s &apos;system&apos; auth.&lt;br/&gt;
For example,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  clear_auths &apos;superuser1&apos;, &apos;system&apos; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Similarly, we can use &apos;set_auths&apos; to grant &apos;system&apos; auth.&lt;/p&gt;

&lt;p&gt;But the concept of super users should probably means &apos;automatic&apos; privilege without explicit &apos;set&apos; or &apos;clear&apos;.  &lt;br/&gt;
Since we use a hbase-site.xml property to determine super users at startup time, &lt;br/&gt;
presence or absence in the property will determine the privilege without a need of any explicit action.&lt;/p&gt;

&lt;p&gt;The proposed approach is to let super users (their auths) only stay in cache, not persist them.&lt;br/&gt;
Otherwise we will have complexity to maintain consistency with the property value in case it changes.&lt;br/&gt;
Looking over the AccessController class, I think it is done this way.&lt;/p&gt;

&lt;p&gt;After doing some testing, I realize the patch seems not enough. The super user auths are also persisted in ZK node together with the other auths.&lt;br/&gt;
I should change that as well.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;
</comment>
                            <comment id="14237161" author="anoop.hbase" created="Sun, 7 Dec 2014 14:33:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;But the concept of super users should probably means &apos;automatic&apos; privilege without explicit &apos;set&apos; or &apos;clear&apos;. Since we use a hbase-site.xml property to determine super users at startup time, presence or absence in the property will determine the privilege without a need of any explicit action.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1 for doing this way. I was thinking the 1st patch going this way around and saw it was not. That is why asked abt 2nd issue in  the desc.&lt;/p&gt;</comment>
                            <comment id="14237350" author="jinghe" created="Mon, 8 Dec 2014 01:39:16 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoop.hbase&quot; class=&quot;user-hover&quot; rel=&quot;anoop.hbase&quot;&gt;Anoop Sam John&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks.  I will provide an updated patch.&lt;/p&gt;</comment>
                            <comment id="14237426" author="ram_krish" created="Mon, 8 Dec 2014 04:31:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jerryhe&quot; class=&quot;user-hover&quot; rel=&quot;jerryhe&quot;&gt;Jerry He&lt;/a&gt;&lt;br/&gt;
Thanks for the patch. So for the automatic way of updation to happen can we now change this addition of super users to the start() of VC as part of RegionServerObserver itself then?  I think that would make sense rather than calling every time during region open intialization? But even if it is part of region we could still have a contains check before adding, but what would make more sense? &lt;/p&gt;</comment>
                            <comment id="14239011" author="jinghe" created="Tue, 9 Dec 2014 05:35:42 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks.  I will look into that.&lt;/p&gt;</comment>
                            <comment id="14240205" author="apurtell" created="Tue, 9 Dec 2014 22:46:27 +0000"  >&lt;p&gt;Canceling stale patch. Moving out of 0.98.9&lt;/p&gt;</comment>
                            <comment id="14240687" author="jinghe" created="Wed, 10 Dec 2014 05:47:59 +0000"  >&lt;p&gt;Attached patch v2, with unit tests.&lt;br/&gt;
Super users are not persisted in hbase:labels, nor labelsCache.&lt;/p&gt;

&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoop.hbase&quot; class=&quot;user-hover&quot; rel=&quot;anoop.hbase&quot;&gt;Anoop Sam John&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Comment please.  Thanks.&lt;/p&gt;</comment>
                            <comment id="14240710" author="anoop.hbase" created="Wed, 10 Dec 2014 06:18:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;this.labelsCache.refreshLabelsCache(serialized);&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Any reason for this addition of code?&lt;br/&gt;
Similar way call to refreshUserAuthsCache()&lt;/p&gt;</comment>
                            <comment id="14242080" author="jinghe" created="Thu, 11 Dec 2014 03:43:13 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoop.hbase&quot; class=&quot;user-hover&quot; rel=&quot;anoop.hbase&quot;&gt;Anoop Sam John&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for the review.&lt;br/&gt;
It seems that if I don&apos;t have the above two refresh calls, some of the Visibility unit tests fail sometimes. Sometimes they all pass. Manual testing on a cluster is always fine.&lt;br/&gt;
I think there is a race condition that is surfaced by this patch, and happens in unit test because of the tight time (both client and server) in the tests.&lt;br/&gt;
Still looking into it.&lt;/p&gt;

&lt;p&gt;Also, I see you have the two fresh calls in DefaultVisibilityLabelServiceImpl.init().  I thought there is no harm having the fresh call in updateZk() as well so we don&apos;t need to wait for ZK event processing.&lt;/p&gt;
</comment>
                            <comment id="14242212" author="anoop.hbase" created="Thu, 11 Dec 2014 06:33:26 +0000"  >&lt;p&gt;Actually the refresh will happen indirect way. The refresh has to happen in all RSs. So we rely on zk nodeChanged callback event. Within the same RS (which host labels table) also, this way it happens.  Yes there can be a time gap because of which tests failing. (But is this new? May be because of your change the ops and remaining test execution happening faster?)  There is no problem in explicitly calling this refresh call. Only thing is, again the nodeChanged will call the refresh.  We may avoid that too with slight changes.  Pls see after giving some time gaps btw ops (like label/auth add and scan/put) in tests and see whether u are getting no issue.&lt;/p&gt;</comment>
                            <comment id="14242242" author="jinghe" created="Thu, 11 Dec 2014 07:02:55 +0000"  >&lt;p&gt;The race condition seems to be here:&lt;/p&gt;

&lt;p&gt;In ZKVisibilityLabelWatcher.writeToZookeeper() &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      ZKUtil.createWithParents(watcher, znode);
      ZKUtil.updateExistingNodeData(watcher, znode, data, -1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that these are two separate calls. If the node does not exist (for example, user_auths node is getting created for the first time),&lt;br/&gt;
the two calls will trigger two events: nodeCreated, and nodeDataChanged.&lt;/p&gt;

&lt;p&gt;On the receiving side, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void nodeCreated(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (path.equals(labelZnode) || path.equals(userAuthsZnode)) {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        ZKUtil.watchAndCheckExists(watcher, path);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException ke) {
        LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error setting watcher on node &quot;&lt;/span&gt; + path, ke);
        &lt;span class=&quot;code-comment&quot;&gt;// only option is to abort
&lt;/span&gt;        watcher.abort(&lt;span class=&quot;code-quote&quot;&gt;&quot;Zookeeper error obtaining label node children&quot;&lt;/span&gt;, ke);
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the nodeDataChanged event come in before the ZKUtil.watchAndCheckExists() when the first event is still being processed, then the second event is lost by this receiver.&lt;br/&gt;
I am seeing even after the setAuths() is done, the scan still lacks the auth.&lt;/p&gt;

&lt;p&gt;It did not happen before in the tests is because we create the &apos;user_auths&apos; node when adding the system and super user auths. Now with this patch, the creation of the node is postponed.&lt;/p&gt;
</comment>
                            <comment id="14245105" author="jinghe" created="Sat, 13 Dec 2014 02:04:55 +0000"  >&lt;p&gt;Attached v3 patch.&lt;br/&gt;
This patch removed the call to this.labelsCache.refreshLabelsCache(serialized) updateZk().&lt;br/&gt;
It also puts the creation of the zk nodes in init()--&amp;gt;ZKVisibilityLabelWatcher.start().&lt;br/&gt;
Separate the creation of the zk nodes event from data update would practically reduce the race condition mentioned in the previous comment.&lt;br/&gt;
In theory, clients can call addLabel or setAuths from mutiple threads and trigger zk data update events.&lt;br/&gt;
But it much less likely to cause problem because each involves a sequence of intermediate steps.&lt;/p&gt;

&lt;p&gt;With the patch. testing with org.apache.hadoop.hbase.security.visibility.* pass everytime I ran.&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoop.hbase&quot; class=&quot;user-hover&quot; rel=&quot;anoop.hbase&quot;&gt;Anoop Sam John&lt;/a&gt;&lt;br/&gt;
Comment please.  Are you ok with patch?&lt;/p&gt;
</comment>
                            <comment id="14245313" author="anoop.hbase" created="Sat, 13 Dec 2014 13:04:05 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14245420" author="yuzhihong@gmail.com" created="Sat, 13 Dec 2014 17:13:40 +0000"  >&lt;p&gt;Integrated to master and branch-1&lt;/p&gt;

&lt;p&gt;Thanks for the review, Anoop.&lt;br/&gt;
Thanks for the contribution, Jerry. Can you prepare patch for 0.98 ?&lt;/p&gt;</comment>
                            <comment id="14245433" author="yuzhihong@gmail.com" created="Sat, 13 Dec 2014 17:30:04 +0000"  >&lt;p&gt;Generating patch for 0.98 is not difficult.&lt;/p&gt;

&lt;p&gt;But, for existing 0.98 deployment, the persisted super user in labels table should be removed, right ?&lt;/p&gt;</comment>
                            <comment id="14245483" author="hudson" created="Sat, 13 Dec 2014 18:56:31 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.0 #579 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.0/579/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.0/579/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12644&quot; title=&quot;Visibility Labels: issue with storing super users in labels table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12644&quot;&gt;&lt;del&gt;HBASE-12644&lt;/del&gt;&lt;/a&gt; Visibility Labels: issue with storing super users in labels table (Jerry He) (tedyu: rev 4d218bb2ede6c241c754ec0c9f15be218f8d11a6)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/ZKVisibilityLabelWatcher.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/TestDefaultScanLabelGeneratorStack.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/ExpAsStringVisibilityLabelServiceImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/TestEnforcingScanLabelGenerator.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/DefaultVisibilityLabelServiceImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14245499" author="hudson" created="Sat, 13 Dec 2014 19:38:02 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-TRUNK #5917 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/5917/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/5917/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12644&quot; title=&quot;Visibility Labels: issue with storing super users in labels table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12644&quot;&gt;&lt;del&gt;HBASE-12644&lt;/del&gt;&lt;/a&gt; Visibility Labels: issue with storing super users in labels table (Jerry He) (tedyu: rev b24518562adb5deb41a8780cead268cb163864d1)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/TestEnforcingScanLabelGenerator.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/TestDefaultScanLabelGeneratorStack.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/ZKVisibilityLabelWatcher.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/DefaultVisibilityLabelServiceImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/ExpAsStringVisibilityLabelServiceImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14245547" author="jinghe" created="Sat, 13 Dec 2014 21:30:30 +0000"  >&lt;p&gt;Hi, Ted&lt;/p&gt;

&lt;p&gt;If we want to do any cleaning of the super users from the labels table automatically, currently there is no way to tell the super users from the normal users who were explicitly granted &apos;system&apos; label. &lt;br/&gt;
Also for rolling upgrade to work continuously, we probably can not delete the super user entries in the labels table until the rolling upgrade is entirely completed.&lt;/p&gt;</comment>
                            <comment id="14245579" author="jinghe" created="Sat, 13 Dec 2014 21:56:10 +0000"  >&lt;p&gt;This fix prevents the described issue from happening in the future.&lt;br/&gt;
But if there is a previous deployment with super users in the labels table already, it looks like we can not clean them because of the above reasons.&lt;br/&gt;
It will not break any upgrade.&lt;br/&gt;
What about a release note that document this?&lt;/p&gt;</comment>
                            <comment id="14245767" author="jinghe" created="Sun, 14 Dec 2014 01:35:35 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Do you have any comment or suggestion?  Thanks. &lt;/p&gt;</comment>
                            <comment id="14245862" author="anoop.hbase" created="Sun, 14 Dec 2014 07:23:25 +0000"  >&lt;p&gt;Will there be some issue if we keep the existing super user auth info as is in labels table?  I think no issue.  With this patch, we will ensure on start of the system we wont add the super users from now on (new deployments). But the flow which checks for SYSTEM label presence for the user, we have added the super users check new way. This should help.  Issue is when a super user is removed later, from the conf.  At that time another super user can remove the user auth... This needs a manual step.  We can document that clearly. Other than that all is well. Right?&lt;/p&gt;</comment>
                            <comment id="14247585" author="yuzhihong@gmail.com" created="Tue, 16 Dec 2014 01:51:21 +0000"  >&lt;p&gt;@Jerry:&lt;br/&gt;
Please add release notes.&lt;/p&gt;</comment>
                            <comment id="14248697" author="jinghe" created="Tue, 16 Dec 2014 19:03:37 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu&quot; class=&quot;user-hover&quot; rel=&quot;tedyu&quot;&gt;Ted Yu&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoop.hbase&quot; class=&quot;user-hover&quot; rel=&quot;anoop.hbase&quot;&gt;Anoop Sam John&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I do not find an option in the menu for me to add release note.  Probably I do not have the permission.&lt;br/&gt;
Here is the info that needs to be added.  Feel free to change the wording as you desire. Thanks.&lt;/p&gt;

&lt;p&gt;-------------------------------------------------&lt;br/&gt;
The system visibility label authorization for super users will no longer be persisted in hbase:labels table. Super users will be determined at server startup time. They will have all the permissions for Visibility labels.&lt;br/&gt;
If you have a prior deployment that had super users&apos; system label persisted in hbase:labels, you can clean up by invoking the shell command &apos;clear_auths&apos;.&lt;br/&gt;
For example:  clear_auths &apos;old_superuser&apos;, &apos;system&apos;&lt;br/&gt;
This is particular necessary when you change super users, i.e. a previous super user is no longer a super user.&lt;/p&gt;</comment>
                            <comment id="14248714" author="yuzhihong@gmail.com" created="Tue, 16 Dec 2014 19:08:56 +0000"  >&lt;p&gt;I filled Release Note with Jerry&apos;s description.&lt;/p&gt;

&lt;p&gt;When you click on &apos;Edit&apos; button, you should find &apos;Release Note&apos; field under &apos;Hadoop Flags&apos; field.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14248757" author="jinghe" created="Tue, 16 Dec 2014 19:35:34 +0000"  >&lt;p&gt;Got it.  Thanks, Ted.&lt;/p&gt;</comment>
                            <comment id="14277386" author="apurtell" created="Wed, 14 Jan 2015 18:26:54 +0000"  >&lt;p&gt;I assume you want the 0.98 patch applied. This feature is experimental in 0.98 so the considerations explained in the release notes are sufficient. Applying now.&lt;/p&gt;</comment>
                            <comment id="14277800" author="hudson" created="Wed, 14 Jan 2015 22:28:27 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98 #796 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/796/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/796/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12644&quot; title=&quot;Visibility Labels: issue with storing super users in labels table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12644&quot;&gt;&lt;del&gt;HBASE-12644&lt;/del&gt;&lt;/a&gt; Visibility Labels: issue with storing super users in labels table (Jerry He) (apurtell: rev 6218e64ce8985e86b156179867636f80429495c6)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/TestDefaultScanLabelGeneratorStack.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/ExpAsStringVisibilityLabelServiceImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/TestEnforcingScanLabelGenerator.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/ZKVisibilityLabelWatcher.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/DefaultVisibilityLabelServiceImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14277883" author="hudson" created="Wed, 14 Jan 2015 23:30:31 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98-on-Hadoop-1.1 #759 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/759/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/759/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12644&quot; title=&quot;Visibility Labels: issue with storing super users in labels table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12644&quot;&gt;&lt;del&gt;HBASE-12644&lt;/del&gt;&lt;/a&gt; Visibility Labels: issue with storing super users in labels table (Jerry He) (apurtell: rev 6218e64ce8985e86b156179867636f80429495c6)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/DefaultVisibilityLabelServiceImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/TestEnforcingScanLabelGenerator.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/TestDefaultScanLabelGeneratorStack.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/security/visibility/ExpAsStringVisibilityLabelServiceImpl.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/ZKVisibilityLabelWatcher.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14331937" author="enis" created="Sat, 21 Feb 2015 23:50:13 +0000"  >&lt;p&gt;Closing this issue after 1.0.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12687047" name="12644-0.98.patch" size="13020" author="yuzhihong@gmail.com" created="Sat, 13 Dec 2014 17:30:38 +0000"/>
                            <attachment id="12686197" name="HBASE-12644-master-v2.patch" size="12740" author="jinghe" created="Wed, 10 Dec 2014 05:42:34 +0000"/>
                            <attachment id="12686997" name="HBASE-12644-master-v3.patch" size="13981" author="jinghe" created="Sat, 13 Dec 2014 01:50:04 +0000"/>
                            <attachment id="12685415" name="HBASE-12644-master.patch" size="2454" author="jinghe" created="Fri, 5 Dec 2014 20:15:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 5 Dec 2014 22:14:23 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i234dj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The system visibility label authorization for super users will no longer be persisted in hbase:labels table. Super users will be determined at server startup time. They will have all the permissions for Visibility labels.&lt;br/&gt;
If you have a prior deployment that had super users&amp;#39; system label persisted in hbase:labels, you can clean up by invoking the shell command &amp;#39;clear_auths&amp;#39;.&lt;br/&gt;
For example: clear_auths &amp;#39;old_superuser&amp;#39;, &amp;#39;system&amp;#39;&lt;br/&gt;
This is particularly necessary when you change super users, i.e. a previous super user is no longer a super user.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>