<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:26:41 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-11793/HBASE-11793.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-11793] RegionStates shouldn&apos;t be locked while writing to META</title>
                <link>https://issues.apache.org/jira/browse/HBASE-11793</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Following scenario with zk-less assignment&lt;br/&gt;
Two shutdown handler threads are running where one is METAServerShutdownHandler.&lt;br/&gt;
The ServershutdownHandler thread doing recovering of region server other than META acquires lock on RegionStates while doing serverOffline() operation. It keeps the lock while its trying to write to META (not assigned) &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Thread 118 (MASTER_SERVER_OPERATIONS-gsbl90723:50510-2):&lt;br/&gt;
  State: TIMED_WAITING&lt;br/&gt;
  Blocked count: 430&lt;br/&gt;
  Waited count: 36755&lt;br/&gt;
  Stack:&lt;br/&gt;
    java.lang.Object.wait(Native Method)&lt;br/&gt;
    org.apache.hadoop.hbase.client.AsyncProcess.waitForNextTaskDone(AsyncProcess.java:853)&lt;br/&gt;
    org.apache.hadoop.hbase.client.AsyncProcess.waitForMaximumCurrentTasks(AsyncProcess.java:879)&lt;br/&gt;
    org.apache.hadoop.hbase.client.AsyncProcess.waitUntilDone(AsyncProcess.java:892)&lt;br/&gt;
    org.apache.hadoop.hbase.client.HTable.backgroundFlushCommits(HTable.java:968)&lt;br/&gt;
    org.apache.hadoop.hbase.client.HTable.flushCommits(HTable.java:1252)&lt;br/&gt;
    org.apache.hadoop.hbase.client.HTable.put(HTable.java:910)&lt;br/&gt;
    org.apache.hadoop.hbase.master.RegionStateStore.updateRegionState(RegionStateStore.java:223)&lt;br/&gt;
    org.apache.hadoop.hbase.master.RegionStates.updateRegionState(RegionStates.java:804)&lt;br/&gt;
    org.apache.hadoop.hbase.master.RegionStates.updateRegionState(RegionStates.java:329)&lt;br/&gt;
    org.apache.hadoop.hbase.master.RegionStates.updateRegionState(RegionStates.java:298)&lt;br/&gt;
    org.apache.hadoop.hbase.master.RegionStates.regionOffline(RegionStates.java:449)&lt;br/&gt;
    org.apache.hadoop.hbase.master.RegionStates.regionOffline(RegionStates.java:429)&lt;br/&gt;
    org.apache.hadoop.hbase.master.RegionStates.serverOffline(RegionStates.java:498)&lt;br/&gt;
    org.apache.hadoop.hbase.master.AssignmentManager.processServerShutdown(AssignmentManager.java:3404)&lt;br/&gt;
    org.apache.hadoop.hbase.master.handler.ServerShutdownHandler.process(ServerShutdownHandler.java:214)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In meanwhile, MetaServerShutdownHandler thread cant assign META as it is blocked on RegionStates lock &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Thread 126 (MASTER_META_SERVER_OPERATIONS-gsbl90723:50510-0):&lt;br/&gt;
	  State: BLOCKED&lt;br/&gt;
	  Blocked count: 52&lt;br/&gt;
	  Waited count: 100&lt;br/&gt;
	  Blocked on org.apache.hadoop.hbase.master.RegionStates@7398b4c1&lt;br/&gt;
	  Blocked by 118 (MASTER_SERVER_OPERATIONS-gsbl90723:50510-2)&lt;br/&gt;
	  Stack:&lt;br/&gt;
	    org.apache.hadoop.hbase.master.RegionStates.clearLastAssignment(RegionStates.java:422)&lt;br/&gt;
	    org.apache.hadoop.hbase.master.RegionStates.logSplit(RegionStates.java:418)&lt;br/&gt;
 org.apache.hadoop.hbase.master.handler.MetaServerShutdownHandler.process(MetaServerShutdownHandler.java:79)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As the first thread wont be able to write to META, it keeps on retrying (the retry time is huge: hbase.client.retries.number*10) till it fails.&lt;br/&gt;
During that time MetaServerShutdownHandler is blocked. &lt;br/&gt;
Also the first thread calls abort on Master as it had failed, but to aggravate the problem, Master wont abort as it also wants to lock the RegionStates &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;	  Blocked on org.apache.hadoop.hbase.master.RegionStates@7398b4c1&lt;br/&gt;
		  Blocked by 118 (MASTER_SERVER_OPERATIONS-gsbl90723:50510-2)&lt;br/&gt;
		  Stack:&lt;br/&gt;
		    org.apache.hadoop.hbase.master.RegionStates.getRegionsInTransition(RegionStates.java:152)&lt;br/&gt;
		    org.apache.hadoop.hbase.master.AssignmentManager.updateRegionsInTransitionMetrics(AssignmentManager.java:3081)&lt;br/&gt;
		    org.apache.hadoop.hbase.master.HMaster.doMetrics(HMaster.java:751)&lt;br/&gt;
		    org.apache.hadoop.hbase.master.HMaster.loop(HMaster.java:738)&lt;br/&gt;
		    org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:607)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Seems region states shouldn&apos;t be locked when IO is happening.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12735603">HBASE-11793</key>
            <summary>RegionStates shouldn&apos;t be locked while writing to META</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="virag">Virag Kothari</assignee>
                                    <reporter username="virag">Virag Kothari</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Aug 2014 23:59:36 +0000</created>
                <updated>Thu, 21 Aug 2014 02:14:13 +0000</updated>
                                                                            <component>Region Assignment</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="14104830" author="virag" created="Thu, 21 Aug 2014 00:08:15 +0000"  >&lt;p&gt;Multiple ways to address this&lt;br/&gt;
1) Nothing to do here, let this one be contained by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11290&quot; title=&quot;Unlock RegionStates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11290&quot;&gt;HBASE-11290&lt;/a&gt;.&lt;br/&gt;
2) Release lock on region states when RegionStateStore is updating META (Seems only happening during serverOffline())&lt;/p&gt;

&lt;p&gt;One advantage of doing 2) would be that when &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11546&quot; title=&quot;Backport ZK-less region assignment to 0.98&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11546&quot;&gt;&lt;del&gt;HBASE-11546&lt;/del&gt;&lt;/a&gt; is added to 0.98.6, we can add this one too. &lt;br/&gt;
I am not sure whether &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11290&quot; title=&quot;Unlock RegionStates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11290&quot;&gt;HBASE-11290&lt;/a&gt; will be completed before 0.98.6 is released.&lt;/p&gt;

&lt;p&gt;What is your opinion &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;?&lt;/p&gt;

</comment>
                            <comment id="14104836" author="jxiang" created="Thu, 21 Aug 2014 00:15:36 +0000"  >&lt;p&gt;This happens only when meta and master are not co-located, right?&lt;/p&gt;</comment>
                            <comment id="14104859" author="virag" created="Thu, 21 Aug 2014 00:34:30 +0000"  >&lt;p&gt;Correct. Forgot to add that I was running on 0.98&lt;/p&gt;</comment>
                            <comment id="14104904" author="virag" created="Thu, 21 Aug 2014 01:14:12 +0000"  >&lt;p&gt;Also asking &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;, is it ok if we not fix this but still add &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11546&quot; title=&quot;Backport ZK-less region assignment to 0.98&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11546&quot;&gt;&lt;del&gt;HBASE-11546&lt;/del&gt;&lt;/a&gt; to 0.98.6 (as zk-less will be off by default)? The improvement in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11290&quot; title=&quot;Unlock RegionStates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11290&quot;&gt;HBASE-11290&lt;/a&gt; will try to make the locks more granular and supersede this one.&lt;/p&gt;</comment>
                            <comment id="14104956" author="apurtell" created="Thu, 21 Aug 2014 02:14:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;is it ok if we not fix this but still add &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11546&quot; title=&quot;Backport ZK-less region assignment to 0.98&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11546&quot;&gt;&lt;del&gt;HBASE-11546&lt;/del&gt;&lt;/a&gt; to 0.98.6 (as zk-less will be off by default)? The improvement in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-11290&quot; title=&quot;Unlock RegionStates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-11290&quot;&gt;HBASE-11290&lt;/a&gt; will try to make the locks more granular and supersede this one.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure, +1&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12718069">HBASE-11290</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12710152">HBASE-11059</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12728295">HBASE-11546</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 21 Aug 2014 00:15:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 17 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1z5wv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>