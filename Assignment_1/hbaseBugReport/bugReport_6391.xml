<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:36:21 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6391/HBASE-6391.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6391] Master restart when enabling table will lead to region assignned twice</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6391</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The Scenario can be reproduce below.&lt;br/&gt;
Enabling an table, some region is online on regionserver,some are still being processed.&lt;br/&gt;
And restart the master.&lt;/p&gt;

&lt;p&gt;when master failover:&lt;br/&gt;
        // Region is being served and on an active server&lt;br/&gt;
        // add only if region not in disabled and enabling table&lt;br/&gt;
        if (false == checkIfRegionBelongsToDisabled(regionInfo)&lt;br/&gt;
            &amp;amp;&amp;amp; false == checkIfRegionsBelongsToEnabling(regionInfo)) &lt;/p&gt;
{
          regions.put(regionInfo, regionLocation);
          addToServers(regionLocation, regionInfo);
        }

&lt;p&gt;the opened region will not add to the Regions in master.&lt;br/&gt;
and in the following recoverTableInEnablingState,the region will be assigned again.&lt;br/&gt;
that will lead to the cluster inconsistent&lt;/p&gt;</description>
                <environment></environment>
        <key id="12598663">HBASE-6391</key>
            <summary>Master restart when enabling table will lead to region assignned twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="zhou wenjian">zhou wenjian</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Jul 2012 05:11:07 +0000</created>
                <updated>Wed, 16 Nov 2016 22:01:46 +0000</updated>
                            <resolved>Wed, 16 Nov 2016 22:01:46 +0000</resolved>
                                    <version>0.94.0</version>
                                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="13413500" author="zhou wenjian" created="Fri, 13 Jul 2012 05:13:16 +0000"  >&lt;p&gt;may anyone tell me why  not to add region in enabling state to regions in master&lt;/p&gt;</comment>
                            <comment id="13413545" author="stack" created="Fri, 13 Jul 2012 07:36:42 +0000"  >&lt;p&gt;Is this the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6317&quot; title=&quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6317&quot;&gt;&lt;del&gt;HBASE-6317&lt;/del&gt;&lt;/a&gt; &quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot;?&lt;/p&gt;</comment>
                            <comment id="13413550" author="zhou wenjian" created="Fri, 13 Jul 2012 07:39:35 +0000"  >&lt;p&gt;that is different, i think&lt;/p&gt;</comment>
                            <comment id="13413571" author="zhou wenjian" created="Fri, 13 Jul 2012 07:56:56 +0000"  >&lt;p&gt;in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6317&quot; title=&quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6317&quot;&gt;&lt;del&gt;HBASE-6317&lt;/del&gt;&lt;/a&gt; &lt;br/&gt;
rajeshbabu  comments&lt;br/&gt;
As per the current code two scenarios may cause assignment incosistent.&lt;br/&gt;
1)in EnableTableHandler we dont assign regions if they are present in regions map.&lt;br/&gt;
final List&amp;lt;HRegionInfo&amp;gt; onlineRegions =this.assignmentManager.getRegionsOfTable(tableName);&lt;br/&gt;
regionsInMeta.removeAll(onlineRegions);&lt;br/&gt;
But in case of enabling table regions during master start up we are not adding them to regions map in rebuldUseRegions even the regions in/transition to onlineServers.&lt;br/&gt;
if (false == checkIfRegionBelongsToDisabled(regionInfo) &amp;amp;&amp;amp; false == checkIfRegionsBelongsToEnabling(regionInfo)) {&lt;br/&gt;
          synchronized (this.regions) &lt;/p&gt;
{
            regions.put(regionInfo, regionLocation);
            addToServers(regionLocation, regionInfo);
          }
&lt;p&gt;        }&lt;br/&gt;
So we will call assign to all the regions even they are in transition/already assigned to online servers which may cause double assignment.&lt;br/&gt;
2) If all the tables are in ENABLING we may consider as clean cluster startup(because regions map is empty) and again call assignment for all the regions.(Which may again cause double assignment)&lt;/p&gt;


&lt;p&gt;if we romove the check for RegionsBelongsToEnabling, the first scenario will not happen again.&lt;br/&gt;
and for the other scenario we just need to worry about only one case.&lt;br/&gt;
that is ,all tables are enabling ,and none of the regions&apos; location are registered in the meta.&lt;/p&gt;</comment>
                            <comment id="13413576" author="zhou wenjian" created="Fri, 13 Jul 2012 08:15:07 +0000"  >&lt;p&gt;in my opinion, we could treat the case as failover rather than clean start.&lt;/p&gt;

</comment>
                            <comment id="13413588" author="rajesh23" created="Fri, 13 Jul 2012 08:43:58 +0000"  >&lt;p&gt;I feel this is same as &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6317&quot; title=&quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6317&quot;&gt;&lt;del&gt;HBASE-6317&lt;/del&gt;&lt;/a&gt; and we are trying to address the concerns in that.&lt;br/&gt;
To answer your questions&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;may anyone tell me why not to add region in enabling state to regions in master&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Consider a case where i had disabled a table.  Again try to ENABLE.  But in the middle the master restarted.  Now if we add the regions to the this.regions map then the EnableTableHandler will see if the regions are available in this.regions and wont call assign.  So those regions will remain closed in the RS.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;in my opinion, we could treat the case as failover rather than clean start.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6317&quot; title=&quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6317&quot;&gt;&lt;del&gt;HBASE-6317&lt;/del&gt;&lt;/a&gt; we are making it as a failover only.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-comment&quot;&gt;// store all the enabling state table names and corresponding online servers&apos; regions.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// This may be needed to avoid calling assign twice &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the regions of the ENABLING table
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// that could have been assigned through processRIT.
&lt;/span&gt;  Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;HRegionInfo&amp;gt;&amp;gt; enablingTables = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;HRegionInfo&amp;gt;&amp;gt;(1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the patch available in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6317&quot; title=&quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6317&quot;&gt;&lt;del&gt;HBASE-6317&lt;/del&gt;&lt;/a&gt; we are trying to avoid double assignment by making a map of the enabling table regions so that if those regions are already assigned by processRIT we wont assign it now.&lt;br/&gt;
Also even if roundrobinassignemt is set to true on master restart and if we find some partially enabled tables we go with single assignment.  Please review the patch over in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6317&quot; title=&quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6317&quot;&gt;&lt;del&gt;HBASE-6317&lt;/del&gt;&lt;/a&gt; and let us know if you have some more open points.&lt;/p&gt;</comment>
                            <comment id="13414186" author="lhofhansl" created="Sat, 14 Jul 2012 00:16:40 +0000"  >&lt;p&gt;I think this could be closed as DUP as well.&lt;br/&gt;
Moving to 0.94.2 for now.&lt;/p&gt;</comment>
                            <comment id="13414946" author="zhou wenjian" created="Mon, 16 Jul 2012 09:14:39 +0000"  >&lt;p&gt;@rajeshbabu&lt;br/&gt;
thanks for the reply.&lt;br/&gt;
I mistake for the use of checkIfRegionsBelongsToEnabling.&lt;/p&gt;

&lt;p&gt;in your patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6317&quot; title=&quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6317&quot;&gt;&lt;del&gt;HBASE-6317&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
If there exists enabling state in zk and restart the whole cluster, it will be considered as a failover, will this slow down the startup of master?  Can&apos;t we got the explicit range of what cause double assign or inconsistent&lt;/p&gt;

&lt;p&gt;Correct me if i&apos;m wrong&lt;/p&gt;</comment>
                            <comment id="13414968" author="rajesh23" created="Mon, 16 Jul 2012 09:57:30 +0000"  >&lt;p&gt;@zhou&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If there exists enabling state in zk and restart the whole cluster, it will be considered as a failover, will this slow down the startup of master?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes you are correct. Your suggestion also valid.&lt;br/&gt;
I will identify the pattern to check whether it is clean cluster startup or failover and come up with updated patch. I will upload latest patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6317&quot; title=&quot;Master clean start up and Partially enabled tables make region assignment inconsistent.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6317&quot;&gt;&lt;del&gt;HBASE-6317&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13442967" author="lhofhansl" created="Tue, 28 Aug 2012 05:39:10 +0000"  >&lt;p&gt;So can we close this as DUP?&lt;/p&gt;</comment>
                            <comment id="13488490" author="lhofhansl" created="Thu, 1 Nov 2012 05:46:18 +0000"  >&lt;p&gt;No update, unscheduling.&lt;/p&gt;</comment>
                            <comment id="15671786" author="stack" created="Wed, 16 Nov 2016 22:01:46 +0000"  >&lt;p&gt;Reopen if can repro in more modern hbase.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 13 Jul 2012 07:36:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241740</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02bxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11535</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>