<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:46:54 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13814/HBASE-13814.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13814] AssignmentManager does not write the correct server name into Zookeeper when unassign region</title>
                <link>https://issues.apache.org/jira/browse/HBASE-13814</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When moving region, the region will firstly be unassigned from corresponding region server by the method AssignmentManager#unassign(). AssignmentManager will write the region info and the server name into Zookeeper by the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          versionOfClosingNode = ZKAssign.createNodeClosing(
            master.getZooKeeper(), region, master.getServerName());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It seems that the AssignmentManager misuses the master&apos;s name as the server name. If the ROOT region is being moved and the region server holding the ROOT region is just crashed. The Master will try to start a MetaServerShutdownHandler if the server is judged as holding meta region. The judgment will be done by the method AssignmentManager#isCarryingRegion, and the method will firstly check the server name in Zookeeper:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    ServerName addressFromZK = (data != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; data.getOrigin() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) ?
      data.getOrigin() : &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (addressFromZK != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we get something from ZK, we will use the data
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; matchZK = (addressFromZK != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp;
        addressFromZK.equals(serverName));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The wrong server name from Zookeeper will make the server not be judged as holding the ROOT region. Then, the master will start a ServerShutdownHandler. Unlike MetaServerShutdownHandler, the ServerShutdownHandler won&apos;t assign ROOT region firstly, making the ROOT region won&apos;t be assigned forever. In our test environment, we encounter this problem when moving ROOT region and stopping the region server concurrently.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12833964">HBASE-13814</key>
            <summary>AssignmentManager does not write the correct server name into Zookeeper when unassign region</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="cuijianwei">Jianwei Cui</reporter>
                        <labels>
                    </labels>
                <created>Sat, 30 May 2015 08:46:29 +0000</created>
                <updated>Sat, 27 Jun 2015 06:07:09 +0000</updated>
                                            <version>0.94.27</version>
                                                    <component>Region Assignment</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14565905" author="cuijianwei" created="Sat, 30 May 2015 09:03:38 +0000"  >&lt;p&gt;patch for 0.94&lt;/p&gt;</comment>
                            <comment id="14578249" author="stack" created="Tue, 9 Jun 2015 03:27:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; Patch for 0.94!&lt;/p&gt;</comment>
                            <comment id="14578275" author="lhofhansl" created="Tue, 9 Jun 2015 03:58:23 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Maybe it&apos;s time to do another maintenance release.&lt;/p&gt;</comment>
                            <comment id="14578280" author="lhofhansl" created="Tue, 9 Jun 2015 04:06:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cuijianwei&quot; class=&quot;user-hover&quot; rel=&quot;cuijianwei&quot;&gt;Jianwei Cui&lt;/a&gt;, can you explain in a few words how this fixes the problem. I think I get it: master.getServerName() does not have the right server, right?&lt;/p&gt;

&lt;p&gt;I think we can simplify:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!regions.containsKey(region) || (serverName = regions.get(region)) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((serverName = regions.get(region)) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Can we move:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    ServerName serverName = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Inside the synchronized?&lt;/p&gt;</comment>
                            <comment id="14599244" author="cuijianwei" created="Wed, 24 Jun 2015 11:04:53 +0000"  >&lt;p&gt;Thanks for your concern &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; and sorry to reply late&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Yes, master.getServerName() is not the correct server name serving the region and I think we need to save the right region server name into znode in AssignmentManager#unassign so that AssignmentManager#isCarryingRegion will get the right result. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I think we can simplify:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!regions.containsKey(region) || (serverName = regions.get(region)) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((serverName = regions.get(region)) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, it looks better, I will update the patch.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Can we move:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    ServerName serverName = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Inside the synchronized?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you mean move it in the synchronized:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions) {
       &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; region is currently assigned
&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((serverName = regions.get(region)) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
           ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, the serverName will be used in another synchronized:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (regionsInTransition) {
      state = regionsInTransition.get(encodedName);
       &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (regionsInTransition) {
      state = regionsInTransition.get(encodedName);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
         &lt;span class=&quot;code-comment&quot;&gt;// Create the znode in CLOSING state
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          versionOfClosingNode = ZKAssign.createNodeClosing(
            master.getZooKeeper(), region, serverName); &lt;span class=&quot;code-comment&quot;&gt;// ===&amp;gt; need to be used here
&lt;/span&gt;      
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so that the serverName is not visible if it is defined in the first synchronized?&lt;/p&gt;</comment>
                            <comment id="14604003" author="lhofhansl" created="Sat, 27 Jun 2015 06:07:09 +0000"  >&lt;p&gt;+1 on v2.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12736324" name="HBASE-13814-0.94-v1.patch" size="1437" author="cuijianwei" created="Sat, 30 May 2015 09:03:38 +0000"/>
                            <attachment id="12741580" name="HBASE-13814-0.94-v2.patch" size="1405" author="cuijianwei" created="Wed, 24 Jun 2015 11:09:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 9 Jun 2015 03:27:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fesn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>