<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:52:16 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8127/HBASE-8127.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8127] Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8127</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The issue happens when a RS dies during a master starts up. After the RS reports open to the new master instance and dies immediately thereafter, the RITs of disabling tables(or disabled table) on the died RS will be in RIT state forever.&lt;/p&gt;

&lt;p&gt;I attached a patch to simulate the situation and you can run the following command to reproduce the issue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn test -PlocalTests -Dtest=TestMasterFailover#testMasterFailoverWithMockedRITOnDeadRS&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Basically, we skip regions of a dead server inside AM.processDeadServersAndRecoverLostRegions as the following code and relies on SSH to process those skipped regions:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Pair&amp;lt;HRegionInfo, Result&amp;gt; deadRegion : deadServer.getValue()) {
            nodes.remove(deadRegion.getFirst().getEncodedName());
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;While in SSH, we skip regions of disabling(or disabled table) again by function processDeadRegion. Finally comes to the issue that RITs of disabling(or disabled table) stuck there forever.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12637408">HBASE-8127</key>
            <summary>Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajesh23">rajeshbabu</assignee>
                                    <reporter username="jeffreyz">Jeffrey Zhong</reporter>
                        <labels>
                    </labels>
                <created>Sat, 16 Mar 2013 23:21:14 +0000</created>
                <updated>Sat, 27 Apr 2013 15:55:13 +0000</updated>
                            <resolved>Fri, 5 Apr 2013 03:30:32 +0000</resolved>
                                    <version>0.94.5</version>
                                    <fixVersion>0.94.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                <comments>
                            <comment id="13604450" author="jeffreyz" created="Sat, 16 Mar 2013 23:32:57 +0000"  >&lt;p&gt;After applying the patch, run a clean build and then the following command:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
mvn test -PlocalTests -Dtest=TestMasterFailover#testMasterFailoverWithMockedRITOnDeadRS
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You should be able to see the following error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
test timed out after 180000 milliseconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13604455" author="jeffreyz" created="Sat, 16 Mar 2013 23:48:14 +0000"  >&lt;p&gt;The fix is to remove the RIT regions skipping parts becasue the later of function processDeadServersAndRecoverLostRegions can set internal AM.regionsInTransition correctly and SSH is able to handle RITs of a dead server.&lt;/p&gt;

&lt;p&gt;I haven&apos;t run full test suit yet, just propose a fix for reviewing.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Jeffrey&lt;/p&gt;</comment>
                            <comment id="13604503" author="yuzhihong@gmail.com" created="Sun, 17 Mar 2013 04:16:48 +0000"  >&lt;p&gt;Looking at reproduce-hang.patch, can we modify TestMasterFailover so that this scenario can be reproduced without changing master code ?&lt;br/&gt;
e.g. by simulating the case where the region server which died didn&apos;t carry .META. table&lt;/p&gt;</comment>
                            <comment id="13604528" author="ram_krish" created="Sun, 17 Mar 2013 07:09:48 +0000"  >&lt;p&gt;I already pointed out this is the place that does not allow the Nodes in RIT to be processed while in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7824&quot; title=&quot;Improve master start up time when there is log splitting work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7824&quot;&gt;&lt;del&gt;HBASE-7824&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Let me check the scenarios and get back to you.  If there is no harm in removing this piece of code then we can go ahead and commit it.&lt;/p&gt;
</comment>
                            <comment id="13604529" author="rajesh23" created="Sun, 17 Mar 2013 07:36:58 +0000"  >&lt;p&gt;We are removing deadserver nodes to avoid double assignments from SSH and master startup. Even if we remove the code as in patch, same problem can come with DISABLING.IMO we need to handle in SSH case only.&lt;/p&gt;</comment>
                            <comment id="13604531" author="ram_krish" created="Sun, 17 Mar 2013 07:41:12 +0000"  >&lt;p&gt;After going thro the code i have the following concerns, but not sure if it is going to create problems&lt;br/&gt;
-&amp;gt; Basically &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5916&quot; title=&quot;RS restart just before master intialization we make the cluster non operative&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5916&quot;&gt;&lt;del&gt;HBASE-5916&lt;/del&gt;&lt;/a&gt; was addressed for the case where the RS goes down just before master initialization completes.&lt;br/&gt;
-&amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6227&quot; title=&quot;SSH and cluster startup  causes data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6227&quot;&gt;&lt;del&gt;HBASE-6227&lt;/del&gt;&lt;/a&gt; describes the scenario fully.&lt;br/&gt;
I think removing this will lead to double assignment.&lt;/p&gt;</comment>
                            <comment id="13604533" author="ram_krish" created="Sun, 17 Mar 2013 07:41:59 +0000"  >&lt;p&gt;I think Rajesh has just pitched in to see this.  &lt;/p&gt;</comment>
                            <comment id="13604537" author="ram_krish" created="Sun, 17 Mar 2013 08:02:22 +0000"  >&lt;p&gt;@Jeffrey&lt;br/&gt;
Is there a way to differentiate a deadServer that was really dead when the master came up and the one that went down before the master could finish initialization.&lt;br/&gt;
Now when the already dead Servers are added to the deadServers list we get into this problem.&lt;/p&gt;

&lt;p&gt;Another thing is even before the patch ie. &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7824&quot; title=&quot;Improve master start up time when there is log splitting work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7824&quot;&gt;&lt;del&gt;HBASE-7824&lt;/del&gt;&lt;/a&gt; we were ensuring the region was removed from RIT but the znode was not getting delted in the case where the znode for Disabled table was in OPENING state.  But in a normal case i don&apos;t think this could happen.  Need to check this.&lt;/p&gt;

&lt;p&gt;I can understand from your patch that it does optimization of the ROOT and META to be splitted earlier and then the other regions and you depend more on the SSH to do the split for the userregions.  Let me think more and come up with a patch if possible.&lt;/p&gt;</comment>
                            <comment id="13604539" author="rajesh23" created="Sun, 17 Mar 2013 08:06:30 +0000"  >&lt;p&gt;Rough patch for 94. I will add some more tests and upload again.&lt;br/&gt;
I think similar problem exists in trunk as well when the table is disabling and rit state is other than PENDING_CLOSE or CLOSING.&lt;/p&gt;

&lt;p&gt;I will check more in detail and come back.&lt;/p&gt;</comment>
                            <comment id="13604541" author="rajesh23" created="Sun, 17 Mar 2013 08:12:43 +0000"  >&lt;p&gt;Sorry Ram, crossed comments.&lt;/p&gt;</comment>
                            <comment id="13604851" author="jeffreyz" created="Mon, 18 Mar 2013 03:44:30 +0000"  >
&lt;blockquote&gt;
&lt;p&gt;Looking at reproduce-hang.patch, can we modify TestMasterFailover so that this scenario can be reproduced without changing master code ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The reproduce-hang patch is just for description purpose only. The issue could happen in both meta RS or non-meta RS scenarios.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;We are removing deadserver nodes to avoid double assignments from SSH and master startup. Even if we remove the code as in patch, same problem can come with DISABLING.IMO we need to handle in SSH case only.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The reproduce-hang.patch is already set the table as DISABLING(zktable.setDisablingTable(Bytes.toString(disabledTable))&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and the original patch can work for both disabled and disabling case.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;double assignments concern&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Assuming the check removed in the original patch does to prevent double assignment or other issues while right after the check there is another RS(with similar state as the RS skipped by the check) just died. Therefore, possible double assignment still could happen. IMHO, the effectiveness of the check is questionable.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;s there a way to differentiate a deadServer that was really dead when the master came up and the one that went down before the master could finish initialization.&lt;br/&gt;
Now when the already dead Servers are added to the deadServers list we get into this problem.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s possible. It&apos;s better not to introduce a new type of dead servers though.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;we were ensuring the region was removed from RIT but the znode was not getting delted in the case where the znode for Disabled table was in OPENING state. But in a normal case i don&apos;t think this could happen. Need to check this.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m thinking if can change the test case to set the disabledTable to disabling because I&apos;m not sure if a RIT in opening state could exist for a disabled table.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Rough patch for 94. I will add some more tests and upload again.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I saw that you address the issue in SSH and I&apos;m fine with it. I&apos;m afraid to do so before is due to its higher impact. I didn&apos;t see you handle disabled case so the test case will fail again if I set disabledTable to disabled in the test case. In addition, RITs in the test case exists not only for died RS but on the live RS as well. Once a while I saw the opening RIT of the disabled table either got assigned or stuck there so I think it&apos;s better to add some safe guards when we deal with RITs during a master node starts up. I put my feedbacks in the feedback patch for your references.&lt;/p&gt;</comment>
                            <comment id="13604879" author="rajesh23" created="Mon, 18 Mar 2013 05:36:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffreyz&quot; class=&quot;user-hover&quot; rel=&quot;jeffreyz&quot;&gt;Jeffrey Zhong&lt;/a&gt;&lt;br/&gt;
Thanks for review.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;. I didn&apos;t see you handle disabled case so the test case will fail again if I set disabledTable to disabled in the test case.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ideally if a table is disabled then the table regions should not be in transition or online thats why not calling ZKAssign#deleteNodeFailSilent on each region otherwise SSH processing will take more time if disabled table regions present on deadserver as for the META. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Once a while I saw the opening RIT of the disabled table either got assigned or stuck there so I think it&apos;s better to add some safe guards when we deal with RITs during a master node starts up. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ideally it should not happen we need to dig more into this when it is possible. If possible can you give some details about this?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I put my feedbacks in the feedback patch for your references &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks for your feedback patch as well. I will check this in more detail. &lt;/p&gt;</comment>
                            <comment id="13605358" author="jeffreyz" created="Mon, 18 Mar 2013 17:01:48 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Ideally it should not happen we need to dig more into this when it is possible. If possible can you give some details about this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we need to agree if RIT in opening state could exist for a disabled table. If that could not happen, we can adjust the test case to remove the opening RITs of disabled table(or set to the table to disabling)  and we don&apos;t need to do extra work.&lt;/p&gt;

&lt;p&gt;One time when I saw the opening RIT stuck is due to the offlineDisabledRegion function in assignment manager. As you can see we don&apos;t handle opening RIT inside the function.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void offlineDisabledRegion(HRegionInfo regionInfo) {
...
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!ZKAssign.deleteClosedNode(watcher, regionInfo.getEncodedName())) {
        &lt;span class=&quot;code-comment&quot;&gt;// Could also be in OFFLINE mode
&lt;/span&gt;        ZKAssign.deleteOfflineNode(watcher, regionInfo.getEncodedName());
      }
...
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13605582" author="rajesh23" created="Mon, 18 Mar 2013 20:22:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;One time when I saw the opening RIT stuck is due to the offlineDisabledRegion function in assignment manager. As you can see we don&apos;t handle opening RIT inside the function.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If I am not wrong &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7824&quot; title=&quot;Improve master start up time when there is log splitting work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7824&quot;&gt;&lt;del&gt;HBASE-7824&lt;/del&gt;&lt;/a&gt; patch applied at that time right?&lt;/p&gt;

&lt;p&gt;One problem I am suspecting with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7824&quot; title=&quot;Improve master start up time when there is log splitting work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7824&quot;&gt;&lt;del&gt;HBASE-7824&lt;/del&gt;&lt;/a&gt; patch is &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (preMetaServer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; failedServers.contains(preMetaServer)) {
+      &lt;span class=&quot;code-comment&quot;&gt;// create recovered edits file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; .META. server
&lt;/span&gt;+      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fileSystemManager.splitLog(preMetaServer);
+      failedServers.remove(preMetaServer);
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If a RS carrying ROOT or META went down,we are not calling SSH for that RS(not even adding to deadservers). We are handling regions in transitions to the dead server by processRegionsInTransitions which can cause RIT stuck in case OPENING state. If znode in RS_ZK_REGION_OPENING state then we will just add to RIT and wait for TM to handle. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
       regionsInTransition.put(encodedRegionName, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RegionState(regionInfo,
            RegionState.State.OPENING, data.getStamp(), data.getOrigin()));
        failoverProcessedRegions.put(encodedRegionName, regionInfo);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When ever TM handles we we will assign,in that case RIT can stuck because its seeing table in DISABLING/DISABLED. If really the RS is ALIVE this case wont happen because after assignment unassign will be called.&lt;/p&gt;

&lt;p&gt;for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7824&quot; title=&quot;Improve master start up time when there is log splitting work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7824&quot;&gt;&lt;del&gt;HBASE-7824&lt;/del&gt;&lt;/a&gt; patch we can do below change which avoids RIT stuck like in opening state.&lt;br/&gt;
If meta RS is down before/during master restart we can add it to deadservers and start SSH by passing shouldSplitHlog as false because already splitted logs.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.deadservers.add(serverName);
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.services.getExecutorService().submit(
      &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServerShutdownHandler(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.services, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.deadservers, serverName, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Any way actual problem you have given in description we can handle in SSH side. I am working on it.&lt;/p&gt;

&lt;p&gt;One more thing about your feedback patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-comment&quot;&gt;// delete RITs &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; exists in any state of disabling or disabled tables during master starts
&lt;/span&gt;+        &lt;span class=&quot;code-comment&quot;&gt;// up
&lt;/span&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!hri.isMetaTable()) {
+          &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; tableName = hri.getTableNameAsString();
+          &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; disabled = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zkTable.isDisabledTable(tableName);
+          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (disabled || &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zkTable.isDisablingTable(tableName)) {
+            ZKAssign.deleteNodeFailSilent(watcher, hri);
+            regionOffline(hri);
+            &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
+          }
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We dont know whether the DISABLING table region is already closed or not on RS, so we should not offline region directly. In SSH we can do because the RS is went down.&lt;/p&gt;</comment>
                            <comment id="13605616" author="jeffreyz" created="Mon, 18 Mar 2013 20:51:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; Thanks for the detailed comments.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If I am not wrong &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7824&quot; title=&quot;Improve master start up time when there is log splitting work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7824&quot;&gt;&lt;del&gt;HBASE-7824&lt;/del&gt;&lt;/a&gt; patch applied at that time right?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No. Actually with the &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;failedServers.remove(preMetaServer);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; we don&apos;t see any issue at all. The only problem is when we have non-empty dead severs which are simulated by the reproduce-hang patch&lt;/p&gt;

&lt;p&gt;Anyway, the opening RIT of disabled table which causing issues is on the live RS not the one dies(or aborted) in the test. So the changes in SSH should not have any impact IMHO. &lt;/p&gt;
</comment>
                            <comment id="13607701" author="rajesh23" created="Wed, 20 Mar 2013 15:17:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffreyz&quot; class=&quot;user-hover&quot; rel=&quot;jeffreyz&quot;&gt;Jeffrey Zhong&lt;/a&gt;&lt;br/&gt;
I ran TestMasterFailover multiple times with reproduce-hang.patch I didnt see any RIT hang of regions transitioning to online region servers. &lt;/p&gt;</comment>
                            <comment id="13609265" author="jeffreyz" created="Thu, 21 Mar 2013 18:26:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; If you run the test in a loop, you most likely will see it fail about once in 5 times due to the reason I logged in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8169&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-8169&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;After I apply your fix + repro_hang + the fix of hbase-8169 on the test case, I was able to run the test successfully 20 times in a loop.(I saw it failed once due to RS could not start, which I think it&apos;s normal to other test cases as well).&lt;/p&gt;

&lt;p&gt;If you like, you can reassign the JIRA to yourself.&lt;/p&gt;</comment>
                            <comment id="13609912" author="ram_krish" created="Fri, 22 Mar 2013 04:33:38 +0000"  >&lt;p&gt;Will check closely and get back on this Rajesh.&lt;/p&gt;</comment>
                            <comment id="13609933" author="jeffreyz" created="Fri, 22 Mar 2013 04:56:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt; When you&apos;re checking, could you also see if we can change zktable.setDisabledTable to zktable.setDisablingTable in test case to make the test more practical. Thanks in advance. &lt;/p&gt;</comment>
                            <comment id="13610984" author="ram_krish" created="Fri, 22 Mar 2013 17:49:42 +0000"  >&lt;p&gt;@Rajesh &lt;br/&gt;
Checking with the existing code and the patch uploaded here i have some questions&lt;br/&gt;
From your patch i can see one thing is you are now not checking if rit is null in checkForDisablingOrDisabledTables().That is fine.&lt;br/&gt;
What ever state it is we are now deleting the znode for disabling/disabled node.  I think any exception on it we need not abort the master.  Just log and leave it.. it will not cause any harm.  &lt;/p&gt;

&lt;p&gt;Going thro the code again previously before the patch the call to assign would have taken care of this scenario anyway (In AM.offlineDisabledRegion())?  The only thing is we are trying to do it once again SSH.  Am i right?&lt;/p&gt;

&lt;p&gt;Also what is the major difference between this JIRA and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8133&quot; title=&quot;avoid assign for disabling table regions(OPENING/PENDING_OPEN) in SSH&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8133&quot;&gt;&lt;del&gt;HBASE-8133&lt;/del&gt;&lt;/a&gt;.  If you feel both are related close one of them and combine the patch.  &lt;/p&gt;

</comment>
                            <comment id="13610986" author="ram_krish" created="Fri, 22 Mar 2013 17:53:03 +0000"  >&lt;p&gt;I will also go thro the actual failure log once again and confirm on this.&lt;/p&gt;</comment>
                            <comment id="13611018" author="jeffreyz" created="Fri, 22 Mar 2013 18:16:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt; I have the similar comment for the following function.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;AM.offlineDisabledRegion()&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The function only deletes znodes in closed or offline not other states. That&apos;s correct by design while the test case has some other invalid znode states(created by the test case) not covered by the function. It&apos;d be better we can reuse the function here.&lt;/p&gt;</comment>
                            <comment id="13611663" author="rajesh23" created="Sat, 23 Mar 2013 08:52:18 +0000"  >&lt;p&gt;Patch with test cases. &lt;/p&gt;

&lt;p&gt;1)TestRSKilledWhenMasterInitializing.testMasterFailoverWhenDisablingTableRegionsInRITOnDeadRS reproduces exact problem of this JIRA.&lt;/p&gt;

&lt;p&gt;2)TestAssignmentManager.testSSHWhenDisablingTableRegionsInOpeningState reproduces the problem with Opening regions of disabling table(some times there may be RIT hang or some times unnecessary assignment of partially disabled table).&lt;/p&gt;

&lt;p&gt;Please review.&lt;/p&gt;</comment>
                            <comment id="13611666" author="rajesh23" created="Sat, 23 Mar 2013 09:25:23 +0000"  >&lt;p&gt;@Ram,&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I think any exception on it we need not abort the master. Just log and leave it.. it will not cause any harm.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If any unexpected zk exceptions we are aborting server every where. Followed the same thing in this patch as well.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Going thro the code again previously before the patch the call to assign would have taken care of this scenario anyway (In AM.offlineDisabledRegion())? The only thing is we are trying to do it once again SSH. Am i right?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In normal case like region server went down after master initialization then we will call assign once again and which will be taken care of deleting znode in AM.offlineDisabledRegion(). But if a RS went down during master initialization no one are deleting/processing znode of disabling table regions because master dont have in-memory state of RIT info, assigned regions info with him. Even assign also getting skipped. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also what is the major difference between this JIRA and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8133&quot; title=&quot;avoid assign for disabling table regions(OPENING/PENDING_OPEN) in SSH&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8133&quot;&gt;&lt;del&gt;HBASE-8133&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8127&quot; title=&quot;Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8127&quot;&gt;&lt;del&gt;HBASE-8127&lt;/del&gt;&lt;/a&gt; is not a problem in trunk. But unncessary assigns and unassigns happening in SSH if disabling table regions in OPENING/PENDING_OPEN state(&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8133&quot; title=&quot;avoid assign for disabling table regions(OPENING/PENDING_OPEN) in SSH&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8133&quot;&gt;&lt;del&gt;HBASE-8133&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8133&quot; title=&quot;avoid assign for disabling table regions(OPENING/PENDING_OPEN) in SSH&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8133&quot;&gt;&lt;del&gt;HBASE-8133&lt;/del&gt;&lt;/a&gt; also possible in 0.94 so combined with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8127&quot; title=&quot;Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8127&quot;&gt;&lt;del&gt;HBASE-8127&lt;/del&gt;&lt;/a&gt; handled in the latest patch.&lt;/p&gt;</comment>
                            <comment id="13612397" author="jeffreyz" created="Mon, 25 Mar 2013 05:26:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; I reviewed your latest path with one question:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+            HRegionInfo hri = deadRegion.getFirst();
+            &lt;span class=&quot;code-comment&quot;&gt;// Delete znode of region in transition &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; table is disabled or disabling. If a region
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// server went down during master initialization then SSH cannot handle the regions of
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// partially disabled tables because in memory region state information may not be
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// available with master.
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (zkTable.isDisablingOrDisabledTable(hri.getTableNameAsString())) {
+              &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+                &lt;span class=&quot;code-comment&quot;&gt;// If table is partially disabled then delete znode &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; exists in any state.
&lt;/span&gt;+                ZKAssign.deleteNodeFailSilent(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.getZooKeeper(), hri);
+              } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException ke) {
+                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.abort(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected ZK exception deleting unassigned node &quot;&lt;/span&gt; + hri, ke);
+              }
+              regionOffline(hri);
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why don&apos;t you handle this situation in SSH as well by removing RIT null check? There are two following reasons we should put in SSH:&lt;/p&gt;

&lt;p&gt;1) another RS with similar states could fail right after this check(RITs may still not be fully initialized)&lt;br/&gt;
2) In SSH, you only check RIT nullness not values, therefore, it&apos;s safe to remove the check because the null states should only happen in master situation phase. Any issue do you see when remove the RIT null check?&lt;br/&gt;
3) In SSH, we remove a region from assignment while may still leave RIT in ZK due to the null check. So it&apos;s possible some RIT could stuck there forever.&lt;/p&gt;

&lt;p&gt;The rest path looks good to me.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Jeffrey&lt;/p&gt;</comment>
                            <comment id="13612421" author="rajesh23" created="Mon, 25 Mar 2013 06:21:56 +0000"  >&lt;p&gt;Thanks for review Jeffrey. &lt;/p&gt;

&lt;p&gt;If a RS went down after rebuildUserRegions it wont be added to deadServers map retruring in that method.&lt;br/&gt;
Since its not in deadServers map we are not removing the region entry from nodes to be processed which will be handled in processRegionInTransition.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!nodes.isEmpty()) {
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; encodedRegionName : nodes) {
        processRegionInTransition(encodedRegionName, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, deadServers);
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So its not a problem and RIT wont stuck forever.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why don&apos;t you handle this situation in SSH as well by removing RIT null check?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If we handle this case in SSH without null check then SSH processing will take more time if any regions of  DISABLING/DISABLED tables opened when it was online. Because we need to contact zookeeper every time even there may not be znodes of RIT present.&lt;/p&gt;
</comment>
                            <comment id="13612899" author="jeffreyz" created="Mon, 25 Mar 2013 17:49:39 +0000"  >&lt;blockquote&gt;
&lt;p&gt;If we handle this case in SSH without null check then SSH processing will take more time if any regions of DISABLING/DISABLED tables opened when it was online. Because we need to contact zookeeper every time even there may not be znodes of RIT present.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If we change the check &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rit != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; disabled) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; to  &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; /* pseudocode */ &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( (!master.initialized || rit != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &amp;amp;&amp;amp; disabled) ) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;. Will that work for you to consolidate the code into SSH? &lt;/p&gt;


</comment>
                            <comment id="13613401" author="rajesh23" created="Tue, 26 Mar 2013 02:10:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;Will that work for you to consolidate the code into SSH? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I also got the same idea, but with this also what ever problem i told before will happen.&lt;br/&gt;
Let us take an example. There are 250 regions in RIT need to process during initialization and 250 regions of DISABLED table are opened before a server went down. In that case SSH will take same time as master initialization becuase in both the cases we need to read from zk.&lt;/p&gt;

&lt;p&gt;IMHO, handling like is fine because we are sure that znode is present for a disabling/disabled table region,transitioning on dead server.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (actualDeadServers.contains(deadServer.getKey())) {
           &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Pair&amp;lt;HRegionInfo, Result&amp;gt; deadRegion : deadServer.getValue()) {
+            HRegionInfo hri = deadRegion.getFirst();
+            &lt;span class=&quot;code-comment&quot;&gt;// Delete znode of region in transition &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; table is disabled or disabling. If a region
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// server went down during master initialization then SSH cannot handle the regions of
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// partially disabled tables because in memory region state information may not be
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// available with master.
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (zkTable.isDisablingOrDisabledTable(hri.getTableNameAsString())) {
+              &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+                &lt;span class=&quot;code-comment&quot;&gt;// If table is partially disabled then delete znode &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; exists in any state.
&lt;/span&gt;+                ZKAssign.deleteNodeFailSilent(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.getZooKeeper(), hri);
+              } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException ke) {
+                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.abort(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected ZK exception deleting unassigned node &quot;&lt;/span&gt; + hri, ke);
+              }
+              regionOffline(hri);
+            }
             nodes.remove(deadRegion.getFirst().getEncodedName());
           }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;do you see any problems with this Jeffrey?&lt;/p&gt;</comment>
                            <comment id="13613530" author="jeffreyz" created="Tue, 26 Mar 2013 06:04:02 +0000"  >&lt;p&gt;The reason for me to raise the question is that we have very similar code in two places. This will likely cause issue later if we need to change the logic in the snippet of code because it&apos;s quite possible to forget to update both places.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Let us take an example. There are 250 regions in RIT need to process during initialization and 250 regions of DISABLED table are opened before a server went down. In that case SSH will take same time as master initialization becuase in both the cases we need to read from zk.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If it&apos;s a dead server, we will skip those regions by &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;nodes.remove(deadRegion.getFirst().getEncodedName());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; during initialization and SSH is handed in a separate thread of a thread pool. So just the thread which handles the dead server SSH will slow down not others. No matter what the deletions have to happen and it&apos;s preferable not in master initialization path. If we block master node by this, it has more impacts because mater node is kind of single failure point and we need it start as fast as possible. If there is no correctness issue, it&apos;s better to consolidate the code in SSH. The concern you have can happen in normal cases more frequently such as after the master starts up and a server dies with lots of RIT regions of disabling tables. If the ZK operations still concern you, you can handle them asynchronously while I think it&apos;s a little bit too much for this.&lt;/p&gt;
</comment>
                            <comment id="13616097" author="rajesh23" created="Thu, 28 Mar 2013 06:18:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffreyz&quot; class=&quot;user-hover&quot; rel=&quot;jeffreyz&quot;&gt;Jeffrey Zhong&lt;/a&gt;&lt;br/&gt;
Understood. I will update the patch with your suggestion. &lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="13616961" author="jeffreyz" created="Fri, 29 Mar 2013 01:35:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; Thanks!&lt;/p&gt;</comment>
                            <comment id="13618620" author="jeffreyz" created="Mon, 1 Apr 2013 05:25:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt; Have you got a chance to revisit this JIRA? It&apos;d be better if you can offer some insights. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; I integrated your current batch with another fix into hbase-7824 patch, so far everything looks good in tests. Let me know when you&apos;ll update your patch. Thanks!&lt;/p&gt;</comment>
                            <comment id="13618621" author="rajesh23" created="Mon, 1 Apr 2013 05:32:26 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffreyz&quot; class=&quot;user-hover&quot; rel=&quot;jeffreyz&quot;&gt;Jeffrey Zhong&lt;/a&gt;. Today I will update it.&lt;/p&gt;</comment>
                            <comment id="13618895" author="rajesh23" created="Mon, 1 Apr 2013 16:41:48 +0000"  >&lt;p&gt;Patch Addressing Jeffrey&apos;s comments. Please review.&lt;/p&gt;</comment>
                            <comment id="13618903" author="ram_krish" created="Mon, 1 Apr 2013 16:48:25 +0000"  >&lt;p&gt;I will review this today or my time tomorrow morning.  Also if things are fine will commit the patch.&lt;br/&gt;
Jeffrey, if you have comments on the latest feel free to comment on it.&lt;/p&gt;</comment>
                            <comment id="13618932" author="yuzhihong@gmail.com" created="Mon, 1 Apr 2013 17:12:50 +0000"  >&lt;p&gt;I got the following based on latest patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  testMasterFailoverWhenDisablingTableRegionsInRITOnDeadRS(org.apache.hadoop.hbase.regionserver.TestRSKilledWhenMasterInitializing): test timed out after 180000 milliseconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13618960" author="rajesh23" created="Mon, 1 Apr 2013 17:42:48 +0000"  >&lt;p&gt;@Ted,&lt;br/&gt;
I ran multiple times before uploading patch then its passed. But Now when I ran it,got the same problem.&lt;br/&gt;
Thanks.&lt;br/&gt;
Here the problem is SSH started after master initialization. Same problem exists with latest patch.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((rit != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !((HMaster) &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.server).isInitialized()) &amp;amp;&amp;amp; disabled) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12575180/HBASE-8127_94_2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12575180/HBASE-8127_94_2.patch&lt;/a&gt; will be better.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffreyz&quot; class=&quot;user-hover&quot; rel=&quot;jeffreyz&quot;&gt;Jeffrey Zhong&lt;/a&gt;&lt;br/&gt;
what do you say?&lt;/p&gt;</comment>
                            <comment id="13619026" author="jeffreyz" created="Mon, 1 Apr 2013 18:38:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; I see. Sorry for the exercise. Let&apos;s go with 94_2.patch then. +1 from me.&lt;/p&gt;</comment>
                            <comment id="13619061" author="yuzhihong@gmail.com" created="Mon, 1 Apr 2013 19:13:17 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;HRegionInfo&amp;gt; checkForDisablingOrDisabledTables(Set&amp;lt;HRegionInfo&amp;gt; regionsFromRIT,
-      List&amp;lt;HRegionInfo&amp;gt; toAssign, RegionState rit, AssignmentManager assignmentManager) {
-    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rit == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
-      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; toAssign;
+      List&amp;lt;HRegionInfo&amp;gt; toAssign, RegionState rit, HRegionInfo hri,
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do we need to pass hri to the above method ? We can obtain this information through rit, right ?&lt;/p&gt;</comment>
                            <comment id="13619314" author="yuzhihong@gmail.com" created="Mon, 1 Apr 2013 23:24:17 +0000"  >&lt;p&gt;Test suite is green for patch v2.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;:&lt;br/&gt;
Do you want to take one more look ?&lt;/p&gt;</comment>
                            <comment id="13619400" author="rajesh23" created="Tue, 2 Apr 2013 01:18:54 +0000"  >&lt;p&gt;@Ted,&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Do we need to pass hri to the above method ? We can obtain this information through rit, right ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;During master startup rit will be null then SSH will try to assign disabling table regions present on the dead server. hri will help to avoid it.&lt;/p&gt;</comment>
                            <comment id="13619426" author="lhofhansl" created="Tue, 2 Apr 2013 01:54:10 +0000"  >&lt;p&gt;I don&apos;t know this part of the code well. Looks fine on cursory inspection.&lt;/p&gt;</comment>
                            <comment id="13619492" author="ram_krish" created="Tue, 2 Apr 2013 03:50:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt;&lt;br/&gt;
I think you and Jeffrey had thought of different approaches and finally decided on patch_2.&lt;br/&gt;
I tried removing the code in AM from your patch and all the testcases including TestMasterFailOver is passing.&lt;br/&gt;
So may be handling for the Disabled and Disabling during master initialization when in process RIT may not be needed i fee.&lt;br/&gt;
The SSH code will any way be triggered for the RS that went down during master start up(for the RS that went down during start up).&lt;br/&gt;
Now there we try to handle the case based on the ZKTable state.  That should be fine.  And infact SSH in normal cases also will now handle for DISABLED/DISABLING tables.&lt;br/&gt;
What you feel?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Let us take an example. There are 250 regions in RIT need to process during initialization and 250 regions of DISABLED table are opened before a server went down. In that case SSH will take same time as master initialization becuase in both the cases we need to read from zk.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I can see that you have given an example to substantiate your point.  But i do feel like having same code and doing same job will make our code less readable and later any bug over here we need to address in 2 places.&lt;/p&gt;</comment>
                            <comment id="13619500" author="rajesh23" created="Tue, 2 Apr 2013 04:14:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;tried removing the code in AM from your patch and all the testcases including TestMasterFailOver is passing.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Can you run TestRSKilledWhenMasterInitializing.testMasterFailoverWhenDisablingTableRegionsInRITOnDeadRS test added in the patch Which will timeout.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And infact SSH in normal cases also will now handle for DISABLED/DISABLING tables&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Its handling only if rit is not null and regions in pending close or closing state. during master startup we are not able to decide whether the region in transition or not(regions,rit map dont have entries for the regions). If we remove null check for rit in SSH,then SSH processing will be slow in normal case as well(every time unncessarily contact zookeeper to check any znode is present or not). But the code in AM delete only if node is present.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But i do feel like having same code and doing same job will make our code less readable and later any bug over here we need to address in 2 places.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We can extract to a method and call the same in 2 places. What do you say Ram?&lt;/p&gt;</comment>
                            <comment id="13619502" author="ram_krish" created="Tue, 2 Apr 2013 04:18:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;TestRSKilledWhenMasterInitializing.testMasterFailoverWhenDisablingTableRegionsInRITOnDeadRS test added in the patch Which will timeout.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I ran this.  It works mostly.  And after you said this once it timedout. (So may be without AM fix there is some race you mean?).&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;ff we remove null check for rit in SSH,then SSH processing will be slow in normal case as well(every time unncessarily contact zookeeper to check any znode is present or not)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You mean the zkTable node?  If you are talking about the zkTable znode, we can maintain a set locally and just ensure that only for the first time when we get a new table we hit the ZK, else don&apos;t hit.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;We can extract to a method and call the same in 2 places&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If still we are not convinced, extracting to a method will surely help us. &lt;/p&gt;</comment>
                            <comment id="13619506" author="rajesh23" created="Tue, 2 Apr 2013 04:31:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;So may be without AM fix there is some race you mean?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;You mean the zkTable node?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No. The RIT node for a region to check whether a region actually in transition or not.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If still we are not convinced, extracting to a method will surely help us. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will extract to a method and update the patch.&lt;/p&gt;</comment>
                            <comment id="13620041" author="rajesh23" created="Tue, 2 Apr 2013 17:43:09 +0000"  >&lt;p&gt;Extracted duplicate code into a method. Functionality wise no change.&lt;/p&gt;</comment>
                            <comment id="13621763" author="ram_krish" created="Thu, 4 Apr 2013 04:34:06 +0000"  >&lt;p&gt;+1 on patch.  Lars you can take this into 0.94.7 itself i think.&lt;/p&gt;</comment>
                            <comment id="13621831" author="lhofhansl" created="Thu, 4 Apr 2013 05:57:58 +0000"  >&lt;p&gt;Thanks Ram. Will commit tomorrow.&lt;br/&gt;
(This is fixed already in 0.95+ I assume)&lt;/p&gt;</comment>
                            <comment id="13622734" author="yuzhihong@gmail.com" created="Thu, 4 Apr 2013 20:22:14 +0000"  >&lt;p&gt;Integrated to 0.94&lt;/p&gt;

&lt;p&gt;Thanks for the patch, Rajesh.&lt;/p&gt;

&lt;p&gt;Thanks for the reviews, Ram, Jeff and Lars.&lt;/p&gt;</comment>
                            <comment id="13622801" author="hudson" created="Thu, 4 Apr 2013 21:16:29 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #130 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/130/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/130/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8127&quot; title=&quot;Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8127&quot;&gt;&lt;del&gt;HBASE-8127&lt;/del&gt;&lt;/a&gt; Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization (Rajeshbabu) (Revision 1464724)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestRSKilledWhenMasterInitializing.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13622963" author="hudson" created="Thu, 4 Apr 2013 23:20:34 +0000"  >&lt;p&gt;Integrated in HBase-0.94 #943 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/943/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/943/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8127&quot; title=&quot;Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8127&quot;&gt;&lt;del&gt;HBASE-8127&lt;/del&gt;&lt;/a&gt; Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization (Rajeshbabu) (Revision 1464724)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestRSKilledWhenMasterInitializing.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13623195" author="hudson" created="Fri, 5 Apr 2013 01:00:57 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security-on-Hadoop-23 #13 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/13/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/13/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8127&quot; title=&quot;Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8127&quot;&gt;&lt;del&gt;HBASE-8127&lt;/del&gt;&lt;/a&gt; Region of a disabling or disabled table could be stuck in transition state when RS dies during Master initialization (Rajeshbabu) (Revision 1464724)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/master/handler/ServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/master/TestAssignmentManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestRSKilledWhenMasterInitializing.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12631850">HBASE-7824</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12574039" name="HBASE-8127.patch" size="2880" author="rajesh23" created="Sun, 17 Mar 2013 08:06:30 +0000"/>
                            <attachment id="12575180" name="HBASE-8127_94_2.patch" size="13522" author="rajesh23" created="Sat, 23 Mar 2013 08:52:18 +0000"/>
                            <attachment id="12576397" name="HBASE-8127_94_3.patch" size="15831" author="rajesh23" created="Mon, 1 Apr 2013 16:41:48 +0000"/>
                            <attachment id="12576615" name="HBASE-8127_94_4.patch" size="13561" author="rajesh23" created="Tue, 2 Apr 2013 17:43:09 +0000"/>
                            <attachment id="12574107" name="HBASE-8127_feedback.patch" size="4153" author="jeffreyz" created="Mon, 18 Mar 2013 03:44:30 +0000"/>
                            <attachment id="12574027" name="hbase-8127_v1.patch" size="855" author="jeffreyz" created="Sat, 16 Mar 2013 23:48:14 +0000"/>
                            <attachment id="12574024" name="reproduce-hang.patch" size="2693" author="jeffreyz" created="Sat, 16 Mar 2013 23:32:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 17 Mar 2013 04:16:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>317900</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1iuqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>318241</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>