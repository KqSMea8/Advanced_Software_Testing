<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:52:11 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1274/HBASE-1274.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1274] TestMergeTable is broken in Hudson</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1274</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;&lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/HBase-Patch/539/testReport/org.apache.hadoop.hbase/TestMergeTable/testMergeTable/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hudson.zones.apache.org/hudson/job/HBase-Patch/539/testReport/org.apache.hadoop.hbase/TestMergeTable/testMergeTable/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;java.io.IOException: Files have same sequenceid&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegion.merge(HRegion.java:2500)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegion.mergeAdjacent(HRegion.java:2412)&lt;br/&gt;
	at org.apache.hadoop.hbase.HMerge$Merger.merge(HMerge.java:167)&lt;br/&gt;
	at org.apache.hadoop.hbase.HMerge$Merger.process(HMerge.java:126)&lt;br/&gt;
	at org.apache.hadoop.hbase.HMerge.merge(HMerge.java:91)&lt;br/&gt;
	at org.apache.hadoop.hbase.TestMergeTable.testMergeTable(TestMergeTable.java:35)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12417357">HBASE-1274</key>
            <summary>TestMergeTable is broken in Hudson</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nitay">Nitay Joffe</assignee>
                                    <reporter username="nitay">Nitay Joffe</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Mar 2009 08:37:09 +0000</created>
                <updated>Sun, 13 Sep 2009 22:24:29 +0000</updated>
                            <resolved>Mon, 23 Mar 2009 20:37:50 +0000</resolved>
                                                    <fixVersion>0.20.0</fixVersion>
                                    <component>test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12683795" author="nitay" created="Fri, 20 Mar 2009 08:39:51 +0000"  >&lt;p&gt;I know what caused this, it&apos;s this part of r755878:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git src/java/org/apache/hadoop/hbase/HMerge.java src/java/org/apache/hadoop/hbase/HMerge.java
index af0bc89..361d1d3 100644
--- src/java/org/apache/hadoop/hbase/HMerge.java
+++ src/java/org/apache/hadoop/hbase/HMerge.java
@@ -110,7 +110,7 @@ class HMerge &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; HConstants {
 
       &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tabledir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(
           fs.makeQualified(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(conf.get(HBASE_DIR))),
-          tableName.toString()
+          Bytes.toString(tableName)
       );
       Path logdir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(tabledir, &lt;span class=&quot;code-quote&quot;&gt;&quot;merge_&quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() +
           HREGION_LOGDIR_NAME);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I undo this the test passes.&lt;/p&gt;

&lt;p&gt;Stack and I thought that change was innocuous and only helpful (because calling toString on an tableName, which is an array, yields garbage). Turns out some logic in the test/code actually depends on it.&lt;/p&gt;

&lt;p&gt;Will dig deeper to find out why.&lt;/p&gt;</comment>
                            <comment id="12683812" author="stack" created="Fri, 20 Mar 2009 09:21:26 +0000"  >&lt;p&gt;Sequenceids for edit files need to be different because sequenceid is the key in a map of all a Stores edit files.&lt;/p&gt;

&lt;p&gt;There is already an issue to deal with the case where there is a sequenceid clash; unlikely but a possibility.&lt;/p&gt;

&lt;p&gt;Whats going on here is that you&apos;ve probably fixed something that was broken.  The fact that sequenceids are now clashing was probably always there but before hfile, we&apos;d just move on one of the sequenceids &amp;#8211; a suspect practise and something we no longer can do now the meta is kept in hfile... can&apos;t rewrite &amp;#8211; so perhaps the thing to do if can&apos;t figure anything else is to make the TestMergeTable make irregular files with diffrening numbers of edits.&lt;/p&gt;</comment>
                            <comment id="12688091" author="nitay" created="Sun, 22 Mar 2009 01:23:49 +0000"  >&lt;p&gt;Ah, thanks for the info Stack, that helps explain a lot.&lt;/p&gt;

&lt;p&gt;The test used to pass because the tableName.toString() would not match anything and no merge would actually occur. Now, we actually try to merge and fail.&lt;br/&gt;
The test does not actually assert anything, which is why it was passing blindly. There should always be two regions after the merge, so I can just add check for that, right?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There is already an issue to deal with the case where there is a sequenceid clash; unlikely but a possibility.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the issue you mention, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1212&quot; title=&quot;merge tool expects regions all have different sequence ids&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1212&quot;&gt;&lt;del&gt;HBASE-1212&lt;/del&gt;&lt;/a&gt;, is actually the cause here.&lt;/p&gt;

&lt;p&gt;We initially create three regions using this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
     HRegion[] regions = {
       createAregion(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, row_70001, 1, 70000),
       createAregion(row_70001, row_80001, 70001, 10000),
       createAregion(row_80001, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 80001, 10000)
     };
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The last two create store files with the same sequence id.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The fact that sequenceids are now clashing was probably always there but before hfile, we&apos;d just move on one of the sequenceids&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think we actually currently do the logic you describe. Where is that code?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;a suspect practise and something we no longer can do now the meta is kept in hfile... can&apos;t rewrite&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I noticed that we use random filenames. What about using something that sorts lexicographically and sorting the dir.listFiles we use when grabbing the store files? Then when we move around two files with the same sequence ids to do a merge we can rename the actual files.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;so perhaps the thing to do if can&apos;t figure anything else is to make the TestMergeTable make irregular files with diffrening numbers of edits.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I can make that change, it&apos;s very easy. Should I just do that and leave the merging of same sequenceid files for another issue?&lt;/p&gt;</comment>
                            <comment id="12688092" author="nitay" created="Sun, 22 Mar 2009 01:30:52 +0000"  >&lt;p&gt;To move things along, here&apos;s a patch with the simple fix to this test alone.&lt;/p&gt;</comment>
                            <comment id="12688405" author="stack" created="Mon, 23 Mar 2009 20:37:50 +0000"  >&lt;p&gt;Thanks Nitay.  Yeah, lets figure the merging of same sequenceids out in the other issue (I like idea of non-random filenames).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12403377" name="hbase-1274.patch" size="2371" author="nitay" created="Sun, 22 Mar 2009 01:30:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 20 Mar 2009 09:21:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25659</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 39 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hccf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99262</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>