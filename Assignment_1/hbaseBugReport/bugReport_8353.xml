<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:54:25 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8353/HBASE-8353.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8353] -ROOT-/.META. regions are hanging if master restarted while closing -ROOT-/.META. regions on dead RS</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8353</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;ROOT/META are not getting assigned if master restarted while closing ROOT/META.&lt;br/&gt;
Lets suppose catalog table regions in M_ZK_REGION_CLOSING state during master initialization and then just we are adding the them to RIT and waiting for TM. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isOnDeadServer(regionInfo, deadServers) &amp;amp;&amp;amp;
            (data.getOrigin() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !serverManager.isServerOnline(data.getOrigin()))) {
          &lt;span class=&quot;code-comment&quot;&gt;// If was on dead server, its closed now. Force to OFFLINE and &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// will get it reassigned &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; appropriate
&lt;/span&gt;          forceOffline(regionInfo, data);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          &lt;span class=&quot;code-comment&quot;&gt;// Just insert region into RIT.
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// If &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; never updates the timeout will trigger &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; assignment
&lt;/span&gt;          regionsInTransition.put(encodedRegionName, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RegionState(
            regionInfo, RegionState.State.CLOSING,
            data.getStamp(), data.getOrigin()));
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;isOnDeadServer always return false to ROOT/META because deadServers is null.&lt;/p&gt;

&lt;p&gt;Even TM cannot close them properly because its not available in online regions since its not yet assigned.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regions) {
      &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; region is currently assigned
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!regions.containsKey(region)) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Attempted to unassign region &quot;&lt;/span&gt; +
          region.getRegionNameAsString() + &lt;span class=&quot;code-quote&quot;&gt;&quot; but it is not &quot;&lt;/span&gt; +
          &lt;span class=&quot;code-quote&quot;&gt;&quot;currently assigned anywhere&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12642759">HBASE-8353</key>
            <summary>-ROOT-/.META. regions are hanging if master restarted while closing -ROOT-/.META. regions on dead RS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="rajesh23">rajeshbabu</assignee>
                                    <reporter username="rajesh23">rajeshbabu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Apr 2013 16:21:48 +0000</created>
                <updated>Sun, 20 Oct 2013 21:04:13 +0000</updated>
                            <resolved>Sun, 20 Oct 2013 21:04:13 +0000</resolved>
                                    <version>0.94.6</version>
                                                    <component>Region Assignment</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13632979" author="ram_krish" created="Tue, 16 Apr 2013 16:30:09 +0000"  >&lt;p&gt;Nice.. What you suggest here?&lt;/p&gt;</comment>
                            <comment id="13632987" author="ram_krish" created="Tue, 16 Apr 2013 16:35:30 +0000"  >&lt;p&gt;Is this after the latest change?&lt;/p&gt;</comment>
                            <comment id="13633005" author="rajesh23" created="Tue, 16 Apr 2013 16:50:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is this after the latest change?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is present from long back. &lt;/p&gt;

&lt;p&gt;Thinking on solution Ram, there are multiple scenarios to handle(RS is dead or online).&lt;/p&gt;</comment>
                            <comment id="13633009" author="ram_krish" created="Tue, 16 Apr 2013 16:59:16 +0000"  >&lt;p&gt;@Rajesh, &lt;br/&gt;
I agree.  Can we lower the priority of this if it occurs very rare and if HBCK can retrieve the cluster back then it is ok right. Should it be critical?&lt;br/&gt;
Saw your mail saying HBCK will bring the cluster back so just asking.&lt;/p&gt;

&lt;p&gt;Let me also think of a soln and comment here.&lt;/p&gt;</comment>
                            <comment id="13633011" author="jxiang" created="Tue, 16 Apr 2013 17:02:09 +0000"  >&lt;p&gt;Good catch. It is an issue when the master and the meta/root region server restart while the meta/root is closing.&lt;/p&gt;</comment>
                            <comment id="13633013" author="jxiang" created="Tue, 16 Apr 2013 17:03:15 +0000"  >&lt;p&gt;I agree to lower the priority.&lt;/p&gt;</comment>
                            <comment id="13633020" author="ram_krish" created="Tue, 16 Apr 2013 17:12:08 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; processRegionInTransitionAndBlockUntilAssigned(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HRegionInfo hri)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException, KeeperException, IOException {
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; intransistion =
      processRegionInTransition(hri.getEncodedName(), hri, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!intransistion) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; intransistion;
    LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Waiting on &quot;&lt;/span&gt; + HRegionInfo.prettyPrint(hri.getEncodedName()));
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionsInTransition) {
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master.isStopped() &amp;amp;&amp;amp;
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionsInTransition.containsKey(hri.getEncodedName())) {
        &lt;span class=&quot;code-comment&quot;&gt;// We expect a notify, but by security we set a timout
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionsInTransition.wait(100);
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; intransistion;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here if we see CatalogTables in CLOSING state and we can do the check for serverManager.isServerOnline from the CLOSING znode data.origin and avoid waiting and go for assignment.&lt;br/&gt;
Should it be ok?&lt;/p&gt;</comment>
                            <comment id="13633025" author="jxiang" created="Tue, 16 Apr 2013 17:16:53 +0000"  >&lt;p&gt;Sounds good.&lt;/p&gt;</comment>
                            <comment id="13633040" author="rajesh23" created="Tue, 16 Apr 2013 17:32:27 +0000"  >&lt;p&gt;@Ram,&lt;br/&gt;
Yes,If the RS closing is not online we can directly assign otherwise we can add to RIT and leave as it is in such a way that it will be assigned once the znode transitioned to RS_ZK_REGION_CLOSED by the live RS.&lt;br/&gt;
Checking any other transitions have issues.&lt;/p&gt;</comment>
                            <comment id="13633090" author="lhofhansl" created="Tue, 16 Apr 2013 17:58:31 +0000"  >&lt;p&gt;Let&apos;s do this in 0.94.8.&lt;/p&gt;</comment>
                            <comment id="13633094" author="rajesh23" created="Tue, 16 Apr 2013 18:00:56 +0000"  >&lt;p&gt;RS_ZK_REGION_OPENING has one problem with user regions.&lt;br/&gt;
User regions will be hanged if the RS opening a region went down and master restarted.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (regionInfo.isMetaTable()) {
          regionsInTransition.put(encodedRegionName, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RegionState(
              regionInfo, RegionState.State.OPENING, data.getStamp(), data
                  .getOrigin()));
          &lt;span class=&quot;code-comment&quot;&gt;// If ROOT or .META. table is waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; timeout monitor to assign
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// it may take lot of time when the assignment.timeout.period is
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; value which may be very &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;.  We will not be able
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// to serve any request during &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; time.
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// So we will assign the ROOT and .META. region immediately.
&lt;/span&gt;          processOpeningState(regionInfo);
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
        regionsInTransition.put(encodedRegionName, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RegionState(regionInfo,
            RegionState.State.OPENING, data.getStamp(), data.getOrigin()));

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13633377" author="jeffreyz" created="Tue, 16 Apr 2013 21:20:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; I just want to know more about this issue. Could you please clarify a detailed scenario where catalog table regions are in M_ZK_REGION_CLOSING state while the hosting RS isn&apos;t in deadServers? Thanks. &lt;/p&gt;</comment>
                            <comment id="13633716" author="rajesh23" created="Wed, 17 Apr 2013 03:25:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffreyz&quot; class=&quot;user-hover&quot; rel=&quot;jeffreyz&quot;&gt;Jeffrey Zhong&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Could you please clarify a detailed scenario where catalog table regions are in M_ZK_REGION_CLOSING state while the hosting RS isn&apos;t in deadServers? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There can be multiple cases but these are rare.&lt;br/&gt;
1) CloseRegionHandler thread on live server may not be scheduled on slower machines(by the time backup master become active and it sees M_ZK_REGION_CLOSING rit on online server).&lt;br/&gt;
2) for .META. flushes/compaction may be in progress which blocks closing.&lt;/p&gt;

&lt;p&gt;Actual problem here comes if the RS closing catalog regions and master are dead at a time(zk is stopped/killed).&lt;/p&gt;</comment>
                            <comment id="13634283" author="rajesh23" created="Wed, 17 Apr 2013 18:25:33 +0000"  >&lt;p&gt;Patch for 94. Please review.&lt;/p&gt;</comment>
                            <comment id="13634384" author="jeffreyz" created="Wed, 17 Apr 2013 20:30:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt; for the clarifications! It seems to me the state &quot;M_ZK_REGION_CLOSING&quot; is only set by AM.unassign. CloseRegionHandler only sets a region state to closed. Once a CloseRegionHandler starts, it will close the region eventually or the RS will abort itself for any unexpected error. Please let me know if that&apos;s the case. Thanks. &lt;/p&gt;</comment>
                            <comment id="13634419" author="jxiang" created="Wed, 17 Apr 2013 20:45:30 +0000"  >&lt;p&gt;I was wondering if it is simpler to fix it this way: changing&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;        if (isOnDeadServer(regionInfo, deadServers) &amp;amp;&amp;amp;&lt;br/&gt;
            (data.getOrigin() == null || !serverManager.isServerOnline(data.getOrigin()))) {&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;to something like&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;        if (isOnDeadServer(regionInfo, deadServers) ||&lt;br/&gt;
            !serverManager.isServerOnline(data.getOrigin())) {&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In 0.94, data.getOrigin() could be the master where the ZK node is set.  In trunk, it is always the target server where the transition should happen.  Is there any side impact if it is changed to the target server in 0.94 (except possible compatibility issue?)?  Should this address Jeffrey&apos;s concern?&lt;/p&gt;
</comment>
                            <comment id="13634812" author="rajesh23" created="Thu, 18 Apr 2013 04:18:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isOnDeadServer(regionInfo, deadServers) ||
!serverManager.isServerOnline(data.getOrigin())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the condition always return true since origin is master which is never in online servers list but it will be good if we change server in closing node to target server.&lt;/p&gt;

&lt;p&gt;One more solution is :&lt;br/&gt;
 read servername from zk or ROOT table and if the server is not online then form dead servers to pass it to processRegionInTransition&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; processRegionInTransitionAndBlockUntilAssigned(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HRegionInfo hri)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException, KeeperException, IOException {
    ServerName serverName =
        hri.isRootRegion() ? &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getRootLocation()
            : hri.isMetaRegion() ? &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getMetaLocationOrReadLocationFromRoot()
                : &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    Map&amp;lt;ServerName,List&amp;lt;Pair&amp;lt;HRegionInfo,Result&amp;gt;&amp;gt;&amp;gt; deadServers = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (serverName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !serverManager.isServerOnline(serverName)) {
      List&amp;lt;Pair&amp;lt;HRegionInfo, Result&amp;gt;&amp;gt; offlineRegion = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;Pair&amp;lt;HRegionInfo, Result&amp;gt;&amp;gt;(1);
      offlineRegion.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Pair&amp;lt;HRegionInfo, Result&amp;gt;(hri, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;));
      deadServers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeMap&amp;lt;ServerName, List&amp;lt;Pair&amp;lt;HRegionInfo, Result&amp;gt;&amp;gt;&amp;gt;();
      deadServers.put(serverName, offlineRegion);
    }
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; intransistion =
      processRegionInTransition(hri.getEncodedName(), hri, deadServers);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What do you say about this?&lt;/p&gt;</comment>
                            <comment id="13634824" author="ram_krish" created="Thu, 18 Apr 2013 04:38:00 +0000"  >&lt;p&gt;I will review this patch and post my comments.&lt;/p&gt;</comment>
                            <comment id="13634850" author="rajesh23" created="Thu, 18 Apr 2013 05:00:22 +0000"  >&lt;p&gt;in unassign of a region&lt;br/&gt;
1) create closing node&lt;br/&gt;
2) send close request to the server holding the region.&lt;/p&gt;

&lt;p&gt;one more problem here is if master restarted before 2nd step there is a possible double assignment if the RS holding the region is online.&lt;br/&gt;
in processRegionInTransition we need to make a decision whether to call unassign or just to add to rit. In case of catalog regions unassign itself fails because online regions map dont have it.&lt;/p&gt;</comment>
                            <comment id="13635317" author="ram_krish" created="Thu, 18 Apr 2013 16:37:47 +0000"  >&lt;p&gt;I feel the patch is ok.  &lt;br/&gt;
@Rajesh &lt;br/&gt;
Again if we go to check the ROOT/META while startup we have to again see how long we should wait if ROOT/META goes down at that time..  What do you think?&lt;/p&gt;</comment>
                            <comment id="13635350" author="jxiang" created="Thu, 18 Apr 2013 17:05:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh23&quot; class=&quot;user-hover&quot; rel=&quot;rajesh23&quot;&gt;rajeshbabu&lt;/a&gt;, if we don&apos;t change the origin, does this mean&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;+        if (regionInfo.isMetaTable()&lt;br/&gt;
+            &amp;amp;&amp;amp; !serverManager.isServerOnline(data.getOrigin())) {&lt;br/&gt;
+          forceOffline(regionInfo, data);&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We always re-assign the meta table when the master restarts, if it&apos;s closing?&lt;/p&gt;

&lt;p&gt;I am ok with not changing the origin since it could be a compatibility issue.&lt;/p&gt;</comment>
                            <comment id="13635438" author="rajesh23" created="Thu, 18 Apr 2013 17:59:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;We always re-assign the meta table when the master restarts, if it&apos;s closing?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. we will re-assign even the RS holding the catalog region is not dead.&lt;/p&gt;

&lt;p&gt;@Ram, with first patch we are not able to identify the origin is dead nor not which may cause double assignments.&lt;/p&gt;

&lt;p&gt;In latest patch tried to handle without changing the origin. What do you say about latest patch? &lt;/p&gt;
</comment>
                            <comment id="13635784" author="lhofhansl" created="Thu, 18 Apr 2013 22:42:27 +0000"  >&lt;p&gt;We just ran into this in one of our test clusters. Pretty annoying when it happens.&lt;/p&gt;</comment>
                            <comment id="13635791" author="jxiang" created="Thu, 18 Apr 2013 22:57:51 +0000"  >&lt;p&gt;The latest patch looks fine to me. However, I think it is more reliable to change the origin. Although it may not work during rolling-upgrade, it is an existing issue any way. What do you guys say?&lt;/p&gt;</comment>
                            <comment id="13635792" author="lhofhansl" created="Thu, 18 Apr 2013 22:58:41 +0000"  >&lt;p&gt;Nit:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+            regionsInTransition.put(encodedRegionName, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RegionState(regionInfo,
+              RegionState.State.CLOSING, data.getStamp(), serverName));
+            unassign(regionInfo,
+              &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RegionState(regionInfo, RegionState.State.CLOSING, data.getStamp(), serverName),
+              expectedVersion, serverName);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This would look nicer if we only created the RegionState once and passed it to both methods. Can do on commit.&lt;/p&gt;</comment>
                            <comment id="13635793" author="lhofhansl" created="Thu, 18 Apr 2013 22:59:46 +0000"  >&lt;p&gt;If there are (even potential) issues with rolling upgrades, we should not do it.&lt;/p&gt;</comment>
                            <comment id="13635943" author="jxiang" created="Fri, 19 Apr 2013 01:56:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;If there are (even potential) issues with rolling upgrades, we should not do it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agree.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;, the origin is not used anywhere else, right?  If so, then there is no compatibility issue.&lt;br/&gt;
We need to double check and confirm, of course.&lt;/p&gt;</comment>
                            <comment id="13636069" author="ram_krish" created="Fri, 19 Apr 2013 04:57:19 +0000"  >&lt;p&gt;If i read the patch correctly&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+          ServerName sn = regions.get(regionInfo);
+          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sn == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) sn = data.getOrigin();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the region is not a metaTable and we don&apos;t get the Server name from the regions map we take the origin from the data.  Here the RIT is with master&apos;s name.&lt;br/&gt;
Incase of MetaTable if serverName is available we populate RIT with the RS name?&lt;/p&gt;

&lt;p&gt;So better we unify by updating the RS name in the creation time itself. Checking out the issues with Rolling restart as Jimmy said.  Will update on it later.&lt;/p&gt;
</comment>
                            <comment id="13636129" author="rajesh23" created="Fri, 19 Apr 2013 06:28:05 +0000"  >&lt;p&gt;@Ram,&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If the region is not a metaTable and we don&apos;t get the Server name from the regions map we take the origin from the data.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In rebuildUserRegions we will populate the regions map. In case of disabling or enabled we add the region to regions map(which is any way read from .META.). A region in M_ZK_REGION_CLOSING state only in disabling/balance(ENABLED) only, so its always available in regions map and we can get the proper server where its assigned previously.&lt;/p&gt;


&lt;p&gt;Lets suppose if we change the origin to target server, during rolling restart we may face most of the issues like double assignments mentioned in above comments, because latest version sees master as origin. Otherwise it will be good only.&lt;/p&gt;
</comment>
                            <comment id="13636130" author="rajesh23" created="Fri, 19 Apr 2013 06:28:06 +0000"  >&lt;p&gt;@Ram,&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If the region is not a metaTable and we don&apos;t get the Server name from the regions map we take the origin from the data.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In rebuildUserRegions we will populate the regions map. In case of disabling or enabled we add the region to regions map(which is any way read from .META.). A region in M_ZK_REGION_CLOSING state only in disabling/balance(ENABLED) only, so its always available in regions map and we can get the proper server where its assigned previously.&lt;/p&gt;


&lt;p&gt;Lets suppose if we change the origin to target server, during rolling restart we may face most of the issues like double assignments mentioned in above comments, because latest version sees master as origin. Otherwise it will be good only.&lt;/p&gt;
</comment>
                            <comment id="13649986" author="rajesh23" created="Mon, 6 May 2013 18:59:21 +0000"  >&lt;p&gt;In the latest patch &lt;br/&gt;
1)addressed Lars comment.&lt;br/&gt;
2)Changed origin of M_ZK_REGION_OFFLINE and M_ZK_REGION_CLOSING nodes to target region server but the logic in process RIT of M_ZK_REGION_CLOSING kept as it ease to handle rolling restart cases. Any way changing origin of M_ZK_REGION_OFFLINE does not effect much.&lt;br/&gt;
3)Added some more tests to check rolling restart scenarios.&lt;/p&gt;

&lt;p&gt;Please review. &lt;/p&gt;</comment>
                            <comment id="13656203" author="rajesh23" created="Mon, 13 May 2013 18:17:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;,&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt;,&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;&lt;br/&gt;
Can you please provide your suggestions on the latest patch?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13657020" author="ram_krish" created="Tue, 14 May 2013 12:51:24 +0000"  >&lt;p&gt;Sorry Rajesh. Not able to find some good time. Will sure do the review in today or tomorrow morning.&lt;br/&gt;
Good job. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13657894" author="ram_krish" created="Wed, 15 May 2013 04:31:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Changed origin of M_ZK_REGION_OFFLINE and M_ZK_REGION_CLOSING nodes to target region server but the logic in process RIT of M_ZK_REGION_CLOSING kept as it ease to handle rolling restart cases. Any way changing origin of M_ZK_REGION_OFFLINE does not effect much.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;HAve you tested this in a cluster?  This should not cause any impact as this patch will go into 0.94.  &lt;br/&gt;
Also if the any region is on dead RS it will be forced to OFFLINE and not only the ROOT and META?  &lt;/p&gt;

&lt;p&gt;Still not gone through the patch fully.  Anyway your testcases should be a safeguard for us.  Thanks Rajesh.&lt;/p&gt;</comment>
                            <comment id="13658695" author="rajesh23" created="Wed, 15 May 2013 19:35:07 +0000"  >&lt;p&gt;In M_ZK_REGION_OFFLINE case region should be assigned in any case whether target server is online or not instead of waiting for TM.&lt;br/&gt;
So removed unnecessary checks while processing M_ZK_REGION_OFFLINE node and directly calling assign through ClosedRegionHandler.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// Region is offline, insert into RIT and handle it like a closed
&lt;/span&gt;        addToRITandCallClose(regionInfo, RegionState.State.OFFLINE, data);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;&lt;p&gt;HAve you tested this in a cluster?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will test all the scenarios including rolling restart tomorrow morning IST and let you know.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Also if the any region is on dead RS it will be forced to OFFLINE and not only the ROOT and META? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, It will be forced to OFFLINE and assign.&lt;/p&gt;

&lt;p&gt;Thanks for review Ram.&lt;/p&gt;</comment>
                            <comment id="13660374" author="lhofhansl" created="Fri, 17 May 2013 06:05:53 +0000"  >&lt;p&gt;Kicking it down to the road to 0.94.9&lt;/p&gt;</comment>
                            <comment id="13690804" author="lhofhansl" created="Fri, 21 Jun 2013 22:11:47 +0000"  >&lt;p&gt;Any activity?&lt;br/&gt;
Moving to 0.94.10&lt;/p&gt;</comment>
                            <comment id="13710715" author="rajesh23" created="Wed, 17 Jul 2013 05:16:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;&lt;br/&gt;
Can you review this latest patch?&lt;/p&gt;</comment>
                            <comment id="13710724" author="ram_krish" created="Wed, 17 Jul 2013 05:23:01 +0000"  >&lt;p&gt;Yes i will review this patch.  &lt;/p&gt;</comment>
                            <comment id="13711883" author="lhofhansl" created="Thu, 18 Jul 2013 00:55:48 +0000"  >&lt;p&gt;Passing over to 0.94.11.&lt;/p&gt;</comment>
                            <comment id="13715152" author="ram_krish" created="Mon, 22 Jul 2013 12:17:18 +0000"  >&lt;p&gt;&amp;gt;&amp;gt;I will test all the scenarios including rolling restart tomorrow morning IST and let you know.&lt;br/&gt;
Have you tried this down in a cluster.  &lt;/p&gt;</comment>
                            <comment id="13727392" author="lhofhansl" created="Fri, 2 Aug 2013 06:19:39 +0000"  >&lt;p&gt;So this has been open since 0.94.7. Should finish this. Moving on to 0.94.12 for now.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt; What do you think. Is this safe, good to go? (Can&apos;t say I&apos;m an expert on the this part of the code).&lt;/p&gt;</comment>
                            <comment id="13762376" author="lhofhansl" created="Mon, 9 Sep 2013 22:17:15 +0000"  >&lt;p&gt;Pushing again. After will remove after 0.94.13.&lt;/p&gt;</comment>
                            <comment id="13800226" author="lhofhansl" created="Sun, 20 Oct 2013 21:04:13 +0000"  >&lt;p&gt;As threatened, closing as &quot;Won&apos;t fix&quot; due to a lack of interest.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12579167" name="HBASE-8353_94.patch" size="11484" author="rajesh23" created="Wed, 17 Apr 2013 18:25:33 +0000"/>
                            <attachment id="12579379" name="HBASE-8353_94_2.patch" size="16785" author="rajesh23" created="Thu, 18 Apr 2013 17:50:16 +0000"/>
                            <attachment id="12581931" name="HBASE-8353_94_3.patch" size="26412" author="rajesh23" created="Mon, 6 May 2013 18:59:21 +0000"/>
                            <attachment id="12583358" name="HBASE-8353_94_4.patch" size="26566" author="rajesh23" created="Wed, 15 May 2013 19:35:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 16 Apr 2013 16:30:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>323173</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1jran:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>323518</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>