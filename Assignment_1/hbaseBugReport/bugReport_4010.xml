<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:15:00 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4010/HBASE-4010.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4010] HMaster.createTable could be heavily optimized</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4010</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Looking at the createTable method in HMaster (the one that&apos;s private), we seem to be very inefficient:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We set the enabled flag for the table for every region (should be done only once).&lt;/li&gt;
	&lt;li&gt;Every time we create a new region we create a new HLog and then close it (reuse one instead or see if it&apos;s really necessary).&lt;/li&gt;
	&lt;li&gt;We do one RPC to .META. per region (we should batch put).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This should provide drastic speedups even for those creating tables with just 50 regions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12511010">HBASE-4010</key>
            <summary>HMaster.createTable could be heavily optimized</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yuzhihong@gmail.com">Ted Yu</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Jun 2011 22:08:30 +0000</created>
                <updated>Fri, 20 Nov 2015 11:52:58 +0000</updated>
                            <resolved>Fri, 24 Jun 2011 15:43:13 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.92.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13052263" author="yuzhihong@gmail.com" created="Mon, 20 Jun 2011 22:53:38 +0000"  >&lt;p&gt;HLog depends on regionDir (computed from HRegionInfo) and HRegionInfo itself.&lt;br/&gt;
The HLog instance is used by the new HRegion.&lt;/p&gt;</comment>
                            <comment id="13052345" author="yuzhihong@gmail.com" created="Tue, 21 Jun 2011 04:40:47 +0000"  >&lt;p&gt;First attempt.&lt;br/&gt;
TestAdmin passes.&lt;/p&gt;

&lt;p&gt;batch put to .META. may require a new config parameter (hbase.createtable.metabatch.size). I am thinking of using default batch of 5.&lt;br/&gt;
Will create MetaEditor.addRegionsToMeta() once we agree on the strategy for batching.&lt;/p&gt;</comment>
                            <comment id="13052610" author="yuzhihong@gmail.com" created="Tue, 21 Jun 2011 15:10:50 +0000"  >&lt;p&gt;Implemented batching puts to .META.&lt;/p&gt;</comment>
                            <comment id="13052852" author="jdcryans" created="Tue, 21 Jun 2011 21:28:42 +0000"  >&lt;p&gt;On the v2 patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It seems the new createTable method is mostly copy pasted from the other, refactor?&lt;/li&gt;
	&lt;li&gt;Same in MetaEditor.&lt;/li&gt;
	&lt;li&gt;On the batch Put... I would almost prefer not doing multiple batches since in 0.92 we don&apos;t even carry the HTD in the HRI meaning that the edits are really small.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Is it passing all unit tests (that are currently green)?&lt;/p&gt;</comment>
                            <comment id="13052861" author="yuzhihong@gmail.com" created="Tue, 21 Jun 2011 21:41:25 +0000"  >&lt;p&gt;For item 1, I think you meant createHRegion(). Some variables are computed before HRegion.newHRegion() is called. So I didn&apos;t refactor the method.&lt;br/&gt;
I can refactor addRegionsToMeta() and addRegionToMeta()&lt;/p&gt;

&lt;p&gt;For batch Put, shall we choose a larger batch size (e.g. 100). Some users would create table with many regions (e.g. 70k). But I don&apos;t have strong opinion on this item.&lt;/p&gt;

&lt;p&gt;I am running unit tests.&lt;br/&gt;
TestMasterFailover hung in the suite. When I ran it manually, it passed.&lt;br/&gt;
I started another round of tests.&lt;/p&gt;</comment>
                            <comment id="13052877" author="yuzhihong@gmail.com" created="Tue, 21 Jun 2011 22:02:28 +0000"  >&lt;p&gt;Version 3 refactors addRegionsToMeta()&lt;br/&gt;
I also changed batch size to 100 - feel free to modify or abandon it.&lt;/p&gt;</comment>
                            <comment id="13053033" author="stack" created="Wed, 22 Jun 2011 04:14:00 +0000"  >&lt;p&gt;Seems to be a copy/paste prob. with javadoc (You copy from another method but do not amend this new methods javadoc &amp;#8211; or amend the old if this is the method used by &apos;bootstrap code in the HMaster constructor&apos;&lt;/p&gt;

&lt;p&gt;Why does this new method in HRegion pass in an hlog instance but not use it?&lt;/p&gt;

&lt;p&gt;Should we make it so you can pass a null hlog so when doing these bulk creates, we don&apos;t bother with the hlog open/close/edit especially when its not necessary.&lt;/p&gt;

&lt;p&gt;In fact this new method createHRegion looks exactly same as existing method?&lt;/p&gt;

&lt;p&gt;The addRegionsToMeta looks like nice addition.&lt;/p&gt;

&lt;p&gt;Don&apos;t hardcode this: +    final int batchSize = 100;  Make it final int batchSize = this.conf.getInt(&quot;hbase.master.tablecreate.batchsize&quot;, 100);&lt;/p&gt;

&lt;p&gt;As soon as you commit it, someone else will want to change it (smile).&lt;/p&gt;

&lt;p&gt;Patch looks good otherwise.&lt;/p&gt;</comment>
                            <comment id="13053044" author="yuzhihong@gmail.com" created="Wed, 22 Jun 2011 05:04:58 +0000"  >&lt;p&gt;The new HRegion.createHRegion() was mostly correct in version 2. When I rebased my patch on TRUNK, I forgot to make necessary changes.&lt;/p&gt;

&lt;p&gt;Version 5 is based on Stack&apos;s comment.&lt;br/&gt;
Now TestAdmin passes smoothly.&lt;/p&gt;

&lt;p&gt;Running test suite.&lt;/p&gt;</comment>
                            <comment id="13053047" author="stack" created="Wed, 22 Jun 2011 05:22:32 +0000"  >&lt;p&gt;I was thinking of passing the hlog into HRegion constructor and just having HRegion deal with a null hlog but not important.  We can do that in another issue.  This patch looks good to me.  +1 on commit if tests pass.&lt;/p&gt;</comment>
                            <comment id="13053076" author="yuzhihong@gmail.com" created="Wed, 22 Jun 2011 06:50:58 +0000"  >&lt;p&gt;I ran test suite.&lt;/p&gt;

&lt;p&gt;The failed tests were: TestFSTableDescriptors and TestMergeTable&lt;br/&gt;
TestTableMapReduce hung.&lt;br/&gt;
These were consistent with results of build 1980.&lt;/p&gt;

&lt;p&gt;Committed to TRUNK.&lt;/p&gt;

&lt;p&gt;Thanks Stack for the review, J-D for the initiative.&lt;/p&gt;</comment>
                            <comment id="13053514" author="apurtell" created="Wed, 22 Jun 2011 22:40:49 +0000"  >&lt;p&gt;Shouldn&apos;t this be committed to 0.90 branch too?&lt;/p&gt;</comment>
                            <comment id="13053517" author="jdcryans" created="Wed, 22 Jun 2011 22:49:05 +0000"  >&lt;p&gt;I think it could... it&apos;d be nice also to have a before/after comparison when trying to create a table with thousands of regions.&lt;/p&gt;</comment>
                            <comment id="13053552" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 00:05:59 +0000"  >&lt;p&gt;Patch adjusted for 0.90 branch.&lt;br/&gt;
TestAdmin passes.&lt;/p&gt;</comment>
                            <comment id="13053614" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 02:52:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;when trying to create a table with thousands of regions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We should do that. But the createTable() call would timeout.&lt;br/&gt;
Shall we consider &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3904&quot; title=&quot;HConnection.isTableAvailable returns true even with not all regions available.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3904&quot;&gt;&lt;del&gt;HBASE-3904&lt;/del&gt;&lt;/a&gt; where I made createTable() synchronous &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13053649" author="jdcryans" created="Thu, 23 Jun 2011 04:44:59 +0000"  >&lt;p&gt;That timeout is configurable IIRC.&lt;/p&gt;</comment>
                            <comment id="13053966" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 17:01:04 +0000"  >&lt;p&gt;I did some initial performance test on a cluster with 7 region servers (4GB heap).&lt;br/&gt;
OS is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Linux ciq.com 2.6.18-53.el5 #1 SMP Wed Oct 10 16:34:19 EDT 2007 x86_64 x86_64 x86_64 GNU/Linux
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Creating table with 1000 regions took 37 seconds pre-4010&lt;br/&gt;
It took 32 seconds with 4010-0.90.txt applied.&lt;/p&gt;</comment>
                            <comment id="13053972" author="jdcryans" created="Thu, 23 Jun 2011 17:05:44 +0000"  >&lt;p&gt;Can you tell where most of the time is spent? Should we create the HRegions in parallel?&lt;/p&gt;</comment>
                            <comment id="13053983" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 17:19:18 +0000"  >&lt;p&gt;I did not profile HMaster. The numbers were logged at client side.&lt;/p&gt;

&lt;p&gt;I have been thinking about using executor service to make HRegion creation more parallel. But I think that would help if there&apos;re many many regions when creating the table. I am not sure how common that use case is.&lt;/p&gt;</comment>
                            <comment id="13053987" author="jdcryans" created="Thu, 23 Jun 2011 17:25:12 +0000"  >&lt;p&gt;We have a use case where were are re-creating a table with a few hundred regions as part of a MR job, it&apos;s currently taking a lot of time so anything that helps is welcome.&lt;/p&gt;</comment>
                            <comment id="13053991" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 17:28:53 +0000"  >&lt;p&gt;Do you know how long re-creating a table with a few hundred regions took ?&lt;br/&gt;
From my test result, the duration can be shortened 13%.&lt;br/&gt;
If that&apos;s still unsatisfactory, shall we address it in another JIRA ?&lt;/p&gt;</comment>
                            <comment id="13054042" author="jdcryans" created="Thu, 23 Jun 2011 19:11:37 +0000"  >&lt;p&gt;Yes another jira.&lt;/p&gt;</comment>
                            <comment id="13054109" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 21:22:10 +0000"  >&lt;p&gt;I apologize for presenting incorrect performance data.&lt;/p&gt;

&lt;p&gt;The 37 second was for a 0.90.3 cluster which had run for a while.&lt;br/&gt;
The 32 second was for a 0.90.4 cluster started fresh without 4010-0.90.txt applied - I copied the correct hbase-0.90.4-SNAPSHOT.jar but forgot to rename it.&lt;/p&gt;

&lt;p&gt;So I started the cluster with the hbase-0.90.4-SNAPSHOT.jar which has 4010-0.90.txt applied&lt;br/&gt;
I created two tables with 1000 regions. The first took 16 seconds and the second took 15 seconds.&lt;/p&gt;</comment>
                            <comment id="13056856" author="hudson" created="Tue, 28 Jun 2011 22:42:50 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1995 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/1995/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/1995/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="13067288" author="larsgeorge" created="Mon, 18 Jul 2011 20:47:51 +0000"  >&lt;p&gt;Not sure if this was discussed, but isn&apos;t this work what was described in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3503&quot; title=&quot;HBaseAdmin#createTable with 70k keys takes hours when it should only take minutes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3503&quot;&gt;&lt;del&gt;HBASE-3503&lt;/del&gt;&lt;/a&gt;? Should we close/link this issue?&lt;/p&gt;</comment>
                            <comment id="13067553" author="stack" created="Tue, 19 Jul 2011 07:27:46 +0000"  >&lt;p&gt;@Ted What lars said.  We should close hbase-3503 because this issue fixes it?&lt;/p&gt;</comment>
                            <comment id="15015874" author="lars_francke" created="Fri, 20 Nov 2015 11:52:58 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12479744">HBASE-3229</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12511401">HBASE-4021</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12483523" name="4010-0.90.txt" size="8027" author="yuzhihong@gmail.com" created="Thu, 23 Jun 2011 00:05:59 +0000"/>
                            <attachment id="12483296" name="4010-v2.txt" size="8363" author="yuzhihong@gmail.com" created="Tue, 21 Jun 2011 15:10:49 +0000"/>
                            <attachment id="12483360" name="4010-v3.txt" size="8578" author="yuzhihong@gmail.com" created="Tue, 21 Jun 2011 22:02:28 +0000"/>
                            <attachment id="12483404" name="4010-v5.txt" size="9273" author="yuzhihong@gmail.com" created="Wed, 22 Jun 2011 05:04:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 20 Jun 2011 22:53:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>33321</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05ibj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30065</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>