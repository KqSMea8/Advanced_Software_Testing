<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:14:50 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3989/HBASE-3989.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3989] Error occured while RegionServer report to Master &quot;we are up&quot; should get master address again</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3989</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I happened to fall across a problem, after some further analysis, I found the problem(The logs was attached at the end of the email)&lt;/p&gt;

&lt;p&gt;Consider the following scenario which is similar with my problem :&lt;/p&gt;

&lt;p&gt;1. Due to some unclear reason,  the report to master got error. And retrying several times, but also failed.&lt;br/&gt;
2. During this time , the standby master becomes the active one. So the endless loop is still running, and it won&apos;t success, for the master address has updated, but it didn&apos;t know. And won&apos;t know again.&lt;/p&gt;

&lt;p&gt;   while (!stopped &amp;amp;&amp;amp; (masterAddress = getMaster()) == null) &lt;/p&gt;
{
      sleeper.sleep();
      LOG.warn(&quot;Unable to get master for initialization&quot;);
    }

&lt;p&gt;    MapWritable result = null;&lt;br/&gt;
    long lastMsg = 0;&lt;br/&gt;
    while (!stopped) {&lt;br/&gt;
      try &lt;/p&gt;
{
        this.requestCount.set(0);
        lastMsg = System.currentTimeMillis();
        ZKUtil.setAddressAndWatch(zooKeeper,
          ZKUtil.joinZNode(zooKeeper.rsZNode, ZKUtil.getNodeName(serverInfo)),
          this.serverInfo.getServerAddress());
        this.serverInfo.setLoad(buildServerLoad());
        LOG.info(&quot;Telling master at &quot; + masterAddress + &quot; that we are up&quot;);
        result = this.hbaseMaster.regionServerStartup(this.serverInfo,
            EnvironmentEdgeManager.currentTimeMillis());
        break;
      }
&lt;p&gt; catch (RemoteException e) {&lt;br/&gt;
        IOException ioe = e.unwrapRemoteException();&lt;br/&gt;
        if (ioe instanceof ClockOutOfSyncException) &lt;/p&gt;
{
          LOG.fatal(&quot;Master rejected startup because clock is out of sync&quot;,
              ioe);
          // Re-throw IOE will cause RS to abort
          throw ioe;
        }
&lt;p&gt; else &lt;/p&gt;
{
          LOG.warn(&quot;remote error telling master we are up&quot;, e);
        }
&lt;p&gt;      } catch (IOException e) &lt;/p&gt;
{
        LOG.warn(&quot;error telling master we are up&quot;, e);
      }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
        LOG.warn(&quot;error putting up ephemeral node in zookeeper&quot;, e);
      }
&lt;p&gt;      sleeper.sleep(lastMsg);&lt;br/&gt;
    }&lt;/p&gt;


&lt;p&gt;Here&apos;s the logs:&lt;/p&gt;

&lt;p&gt;2011-06-13 11:25:12,236 WARN org.apache.hadoop.hbase.regionserver.HRegionServer: error telling master we are up&lt;br/&gt;
java.net.ConnectException: Connection refused&lt;br/&gt;
	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)&lt;br/&gt;
	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:574)&lt;br/&gt;
	at org.apache.hadoop.net.SocketIOWithTimeout.connect(SocketIOWithTimeout.java:207)&lt;br/&gt;
	at org.apache.hadoop.net.NetUtils.connect(NetUtils.java:419)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseClient$Connection.setupIOstreams(HBaseClient.java:328)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseClient.getConnection(HBaseClient.java:883)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseClient.call(HBaseClient.java:750)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseRPC$Invoker.invoke(HBaseRPC.java:257)&lt;br/&gt;
	at $Proxy5.regionServerStartup(Unknown Source)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.reportForDuty(HRegionServer.java:1511)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.tryReportForDuty(HRegionServer.java:1479)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:571)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2011-06-13 11:25:15,231 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Telling master at 157-5-111-22:20000 that we are up&lt;br/&gt;
2011-06-13 11:25:15,232 WARN org.apache.hadoop.hbase.regionserver.HRegionServer: error telling master we are up&lt;br/&gt;
java.net.ConnectException: Connection refused&lt;br/&gt;
	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)&lt;br/&gt;
	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:574)&lt;br/&gt;
	at org.apache.hadoop.net.SocketIOWithTimeout.connect(SocketIOWithTimeout.java:207)&lt;br/&gt;
	at org.apache.hadoop.net.NetUtils.connect(NetUtils.java:419)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseClient$Connection.setupIOstreams(HBaseClient.java:328)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseClient.getConnection(HBaseClient.java:883)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseClient.call(HBaseClient.java:750)&lt;br/&gt;
	at org.apache.hadoop.hbase.ipc.HBaseRPC$Invoker.invoke(HBaseRPC.java:257)&lt;br/&gt;
	at $Proxy5.regionServerStartup(Unknown Source)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.reportForDuty(HRegionServer.java:1511)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.tryReportForDuty(HRegionServer.java:1479)&lt;br/&gt;
	at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:571)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2011-06-13 11:25:18,225 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Telling master at 157-5-111-22:20000 that we are up&lt;/p&gt;

&lt;p&gt;So I think, while the error orrured, we should re-get the master address. This problem could be solved.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12510386">HBASE-3989</key>
            <summary>Error occured while RegionServer report to Master &quot;we are up&quot; should get master address again</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jeason">Jieshan Bean</assignee>
                                    <reporter username="jeason">Jieshan Bean</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Jun 2011 01:59:53 +0000</created>
                <updated>Fri, 20 Nov 2015 11:52:13 +0000</updated>
                            <resolved>Fri, 17 Jun 2011 04:11:32 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.90.4</fixVersion>
                                    <component>regionserver</component>
                        <due>Wed, 15 Jun 2011 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13050240" author="jeason" created="Thu, 16 Jun 2011 06:45:25 +0000"  >&lt;p&gt;I have take some tests on the patch. It&apos;s indeed worked.&lt;/p&gt;</comment>
                            <comment id="13050657" author="stack" created="Thu, 16 Jun 2011 19:11:14 +0000"  >&lt;p&gt;Jieshan: A few questions.&lt;/p&gt;

&lt;p&gt;+ What if the reason we failed was NOT because the master went away.  Is it ok calling getMaster again setting up the rpc proxy though we already have a connection?&lt;br/&gt;
+ Do we need this check also over in tryRegionServerReport?  Won&apos;t it suffer same issue?&lt;/p&gt;

&lt;p&gt;Thank you Jieshan.&lt;/p&gt;</comment>
                            <comment id="13050871" author="jeason" created="Fri, 17 Jun 2011 02:35:21 +0000"  >&lt;p&gt;Thanks stack.&lt;/p&gt;

&lt;p&gt;+ What if the reason we failed was NOT because the master went away. Is it ok calling getMaster again setting up the rpc proxy though we already have a connection?&lt;/p&gt;

&lt;p&gt;  If the reason we failed was not because the master went away, I think it&apos;s also worth to do that(If it indeed the problem due to master address got changed, that will be an endless loop here..). Maybe there&apos;s other possible reasons, but we&apos;re not sure about whether the master address has been changed. Check it again just to avoid this problem. &lt;/p&gt;

&lt;p&gt;+ Do we need this check also over in tryRegionServerReport? Won&apos;t it suffer same issue?&lt;/p&gt;

&lt;p&gt;  In tryRegionServerReport, it checked the master address again while report failed. Isn&apos;t it?&lt;br/&gt;
  (I don&apos;t know whether I have got about you question correctly)&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  try {
        msgs = this.hbaseMaster.regionServerReport(this.serverInfo,
          outboundMessages.toArray(HMsg.EMPTY_HMSG_ARRAY),
          getMostLoadedRegions());
        break;
      } catch (IOException ioe) {
        if (ioe instanceof RemoteException) {
          ioe = ((RemoteException)ioe).unwrapRemoteException();
        }
        if (ioe instanceof YouAreDeadException) {
          // This will be caught and handled as a fatal error in run()
          throw ioe;
        }
        // Couldn&apos;t connect to the master, get location from zk and reconnect
        // Method blocks until new master is found or we are stopped
        getMaster();
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13050891" author="stack" created="Fri, 17 Jun 2011 04:04:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;In tryRegionServerReport, it checked the master address again while report failed. Isn&apos;t it?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;(I don&apos;t know whether I have got about you question correctly)&lt;/p&gt;

&lt;p&gt;You understood me and you are correct.&lt;/p&gt;

&lt;p&gt;Thanks for the answers to the questions.  Let me go commit Jieshan.&lt;/p&gt;</comment>
                            <comment id="13050892" author="stack" created="Fri, 17 Jun 2011 04:11:32 +0000"  >&lt;p&gt;Committed to branch.  Not needed on TRUNK.  Thank you Jieshan.&lt;/p&gt;

&lt;p&gt;For the future, make your patches just under the HBASE_HOME directory.  Thats the convention.  Do:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cd $HBASE_HOME
$ svn diff &amp;gt; PATCH_FILE
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And we have to teach you too how to write a unit test or two (smile).&lt;/p&gt;

&lt;p&gt;Good stuff.&lt;/p&gt;</comment>
                            <comment id="13050894" author="jeason" created="Fri, 17 Jun 2011 04:21:54 +0000"  >&lt;p&gt;OK...I&apos;ll remember how to make the patch. And I am learning how to write a unit test. And while I&apos;m making a patch, I&apos;ll check whether somewhere to modify or add to the unit test next time.&lt;br/&gt;
Thanks for your suggestions, stack &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15015694" author="lars_francke" created="Fri, 20 Nov 2015 11:52:13 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12482632" name="HBASE-3989-RegionServer.patch" size="1234" author="jeason" created="Wed, 15 Jun 2011 02:00:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 16 Jun 2011 19:11:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27123</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hov3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101290</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>