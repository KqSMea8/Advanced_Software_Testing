<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:25:40 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5202/HBASE-5202.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5202] NPE during Master failover in master.AssignmentManager.regionOnline()</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5202</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The following NPE can occur during master failover:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-01-15 17:45:00,314 FATAL [Master:1;ip-10-166-123-193.us-west-1.compute.internal:36708] master.HMaster(944): Unhandled exception. Starting shutdown.
java.lang.NullPointerException
        at org.apache.hadoop.hbase.master.AssignmentManager.regionOnline(AssignmentManager.java:724)
        at org.apache.hadoop.hbase.master.AssignmentManager.processFailover(AssignmentManager.java:214)
        at org.apache.hadoop.hbase.master.HMaster.finishInitialization(HMaster.java:396)
        at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:279)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:636)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is caused by regionOnline() being passed a null serverInfo (its second parameter). &lt;/p&gt;

&lt;p&gt;The AssignmentManager&apos;s processFailover() method is passing a null to regionOnline() because the value that regionOnline is passing, hsi, is set as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
hsi = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.getHServerInfo(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getMetaLocation());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
hsi = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.serverManager.getHServerInfo(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.catalogTracker.getRootLocation());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;getHServerInfo() is defined as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; HServerInfo getHServerInfo(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HServerAddress hsa) {
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.onlineServers) {
      &lt;span class=&quot;code-comment&quot;&gt;// TODO: This is primitive.  Do a better search.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, HServerInfo&amp;gt; e: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.onlineServers.entrySet()) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e.getValue().getServerAddress().equals(hsa)) {
          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; e.getValue();
        }
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will return null if the onlineServers map does not yet have a value corresponding to the key supplied by the catalogTracker&apos;s getRootLocation() or getMetaLocation(). &lt;/p&gt;

&lt;p&gt;Since the catalogTracker uses zookeeper to establish the server locations of &lt;tt&gt;&lt;del&gt;ROOT&lt;/del&gt;&lt;/tt&gt; and &lt;tt&gt;.META.&lt;/tt&gt;, while the onlineServers map is set according to the these servers&apos; registering with the master, there can be an inconsistency between the catalogTracker and the onlineServers if either of these regionservers is online with respect to zookeeper, but haven&apos;t yet registered with the master (perhaps due to a high latency network between the master and the regionserver).&lt;/p&gt;

&lt;p&gt;The attached testMasterFailoverWithSlowRS.txt patch can be used to modify TestMasterFailover to cause this NPE. &lt;/p&gt;

&lt;p&gt;The proposed fix (provided along with the above test in a separate attachment) is for the master to use the new verifyMetaTablesAreUp() to wait for both of the servers named by the catalog tracker&apos;s getRootLocation() and getMetaLocation() to register with the master before the master can continue with failover.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12538447">HBASE-5202</key>
            <summary>NPE during Master failover in master.AssignmentManager.regionOnline()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="4">Incomplete</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ekoontz">Eugene Koontz</reporter>
                        <labels>
                    </labels>
                <created>Sun, 15 Jan 2012 18:23:09 +0000</created>
                <updated>Sat, 11 Apr 2015 00:16:30 +0000</updated>
                            <resolved>Sat, 11 Apr 2015 00:16:30 +0000</resolved>
                                    <version>0.90.6</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13186554" author="ekoontz" created="Sun, 15 Jan 2012 18:27:08 +0000"  >&lt;p&gt;patch to TestMasterFailover.java to cause NPE.&lt;/p&gt;</comment>
                            <comment id="13186559" author="hadoopqa" created="Sun, 15 Jan 2012 18:51:44 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12510634/HBASE-5202.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12510634/HBASE-5202.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/763//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/763//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13186561" author="ekoontz" created="Sun, 15 Jan 2012 18:53:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5202&quot; title=&quot;NPE during Master failover in master.AssignmentManager.regionOnline()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5202&quot;&gt;&lt;del&gt;HBASE-5202&lt;/del&gt;&lt;/a&gt; is the continuation of work that started on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3933&quot; title=&quot;Hmaster throw NullPointerException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3933&quot;&gt;&lt;del&gt;HBASE-3933&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3933&quot; title=&quot;Hmaster throw NullPointerException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3933&quot;&gt;&lt;del&gt;HBASE-3933&lt;/del&gt;&lt;/a&gt; was closed and is old enough that it was suggested that a new JIRA be opened.&lt;/p&gt;</comment>
                            <comment id="13186596" author="ekoontz" created="Sun, 15 Jan 2012 21:13:07 +0000"  >&lt;p&gt;&lt;tt&gt;mvn clean test&lt;/tt&gt; returns:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Results :

Tests run: 704, Failures: 0, Errors: 0, Skipped: 9

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1:23:11.247s

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Running &lt;tt&gt;mvn test -Dtest=TestMasterFailover&lt;/tt&gt; runs 100+ times with no failures.&lt;/p&gt;</comment>
                            <comment id="13186601" author="zhihyu@ebaysf.com" created="Sun, 15 Jan 2012 21:41:58 +0000"  >&lt;p&gt;@Eugene:&lt;br/&gt;
I got the following when I tried to apply &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5202&quot; title=&quot;NPE during Master failover in master.AssignmentManager.regionOnline()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5202&quot;&gt;&lt;del&gt;HBASE-5202&lt;/del&gt;&lt;/a&gt;.patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2 out of 3 hunks FAILED -- saving rejects to file src/main/java/org/apache/hadoop/hbase/master/HMaster.java.rej
patching file src/main/java/org/apache/hadoop/hbase/master/ServerManager.java
Hunk #1 succeeded at 608 (offset -90 lines).
patching file src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java
Hunk #1 succeeded at 21 with fuzz 1.
Hunk #2 FAILED at 35.
Hunk #3 succeeded at 50 with fuzz 2 (offset -6 lines).
Hunk #4 FAILED at 953.
2 out of 4 hunks FAILED -- saving rejects to file src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java.rej
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Can you provide a new patch ?&lt;/p&gt;

&lt;p&gt;Normally if a patch is accepted by Hadoop QA, we should only need to rerun the tests reported as failed by Hadoop QA.&lt;/p&gt;

&lt;p&gt;Thanks for working over the weekend.&lt;/p&gt;</comment>
                            <comment id="13186604" author="ekoontz" created="Sun, 15 Jan 2012 22:03:25 +0000"  >&lt;p&gt;Hi Zhihong, my patch is based on apache&apos;s 0.90 branch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
commit 508659a260579e4fecc3d45d3b112c7fd19d5a1f
Author: Ramkrishna S. Vasudevan &amp;lt;ramkrishna@apache.org&amp;gt;
Date:   Sat Jan 14 18:44:33 2012 +0000

    HBASE-5155 ServerShutDownHandler And Disable/Delete should not happen parallely leading to recreation 
    
    
    git-svn-id: https:&lt;span class=&quot;code-comment&quot;&gt;//svn.apache.org/repos/asf/hbase/branches/0.90@1231555 13f79535-47bb-0310-9956-ffa45&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;on my github: &lt;a href=&quot;https://github.com/ekoontz/hbase/commits/HBASE-5202&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/ekoontz/hbase/commits/HBASE-5202&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13186605" author="zhihyu@ebaysf.com" created="Sun, 15 Jan 2012 22:06:22 +0000"  >&lt;p&gt;The attached patch is for 0.90 branch.&lt;/p&gt;

&lt;p&gt;@Eugene:&lt;br/&gt;
Can you prepare a patch for TRUNK ?&lt;br/&gt;
In TRUNK, this.regionServerTracker.getOnlineServers() returns List&amp;lt;ServerName&amp;gt;.&lt;br/&gt;
ServerManager.onlineServers is keyed by ServerName. So the lookup would be much faster.&lt;/p&gt;

&lt;p&gt;For 0.90, I suggest passing List&amp;lt;HServerAddress&amp;gt; to serverManager.isServerOnline() so that we can iterate through the entries of ServerManager.onlineServers and find out if both &lt;tt&gt;&lt;del&gt;ROOT&lt;/del&gt;&lt;/tt&gt; and .META. servers are online.&lt;/p&gt;</comment>
                            <comment id="13186606" author="zhihyu@ebaysf.com" created="Sun, 15 Jan 2012 22:08:32 +0000"  >&lt;p&gt;Also, I think we should impose a timeout for verifyMetaTablesAreUp() so that we don&apos;t wait indefinitely.&lt;/p&gt;</comment>
                            <comment id="13186609" author="ekoontz" created="Sun, 15 Jan 2012 22:14:11 +0000"  >&lt;p&gt;Jinchao wrote (in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3933?focusedCommentId=13186098&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13186098&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HBASE-5202&lt;/a&gt;):&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;@Eugene&lt;br/&gt;
In your patches, You only deale with the root/meta regionserver. If a normal regionserver registers laterly.&lt;br/&gt;
Master will process it as a dead one. Some regions in the later one will be opened twice.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Jinchao, can you explain this scenario more? Does my patch cause duplicate openings that could not happen before? Or are you saying that this patch does not fix the existing NPE described on &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3933&quot; title=&quot;Hmaster throw NullPointerException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3933&quot;&gt;&lt;del&gt;HBASE-3933&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13186681" author="sunnygao" created="Mon, 16 Jan 2012 04:15:02 +0000"  >&lt;p&gt;The root reason of this issue is some region server register lately.&lt;/p&gt;

&lt;p&gt;when one region server without META/ROOT registers atfer &quot;rebuildUserRegions&quot; finished. The regions in this one will be opened twice.&lt;/p&gt;</comment>
                            <comment id="13187421" author="sunnygao" created="Tue, 17 Jan 2012 03:51:11 +0000"  >&lt;p&gt;look &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5179&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5179&lt;/a&gt;. Maybe it can resolve this issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12538023">HBASE-5179</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12508703">HBASE-3933</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12518969">HBASE-4203</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12510634" name="HBASE-5202.patch" size="13723" author="ekoontz" created="Sun, 15 Jan 2012 18:50:40 +0000"/>
                            <attachment id="12510633" name="testMasterFailoverWithSlowRS.txt" size="9473" author="ekoontz" created="Sun, 15 Jan 2012 18:27:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 15 Jan 2012 18:51:44 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>223951</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02d7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11740</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>