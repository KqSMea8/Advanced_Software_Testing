<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:07:50 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3160/HBASE-3160.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3160] Compactions: Use more intelligent priorities for PriorityCompactionQueue</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3160</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;One of the problems with the current compaction queue is that we have a very low granularity on the importance of the various compactions in the queue.  If a StoreFile count exceeds 15 files, only then do we bump via enum change.  We should instead look into more intelligent, granular priority metrics for choosing the next compaction.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12478482">HBASE-3160</key>
            <summary>Compactions: Use more intelligent priorities for PriorityCompactionQueue</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nspiegelberg">Nicolas Spiegelberg</assignee>
                                    <reporter username="nspiegelberg">Nicolas Spiegelberg</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Oct 2010 18:45:22 +0000</created>
                <updated>Fri, 12 Oct 2012 06:17:51 +0000</updated>
                            <resolved>Fri, 29 Oct 2010 06:10:36 +0000</resolved>
                                    <version>0.89.20100924</version>
                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12925502" author="nspiegelberg" created="Wed, 27 Oct 2010 18:48:58 +0000"  >&lt;p&gt;My initial suggestion:&lt;/p&gt;

&lt;p&gt;Priority = max(len(s.storefiles) for s in region.stores)&lt;/p&gt;

&lt;p&gt;This will preserve the priority of Stores exceeding the 15 file limit while prioritizing Stores that are getting close to exceeding that limit.  As a further topic of discussion, it would be good to interrupt a low-pri compaction (&amp;lt; 15 pri) when a 15+ pri request comes in.  Of course, a lot of this would be nicer if we had a compaction thread pool. A man can dream...&lt;/p&gt;</comment>
                            <comment id="12925616" author="hbasereviewboard" created="Thu, 28 Oct 2010 00:28:10 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Switch to more intelligent priority metric: blockingSize - max(len(s.storefiles) for s in region.stores) . This will allow us to better prioritize, give us faster responsiveness to users, and feel more cavalier about issuing new compaction requests.  Note that we also found/fixed a major compaction downgrade bug while writing this code.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3160&quot; title=&quot;Compactions: Use more intelligent priorities for PriorityCompactionQueue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3160&quot;&gt;&lt;del&gt;HBASE-3160&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3160&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3160&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactionRequestor.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/MemStoreFlusher.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 1027787 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestPriorityCompactionQueue.java 1027787 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1103/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;mvn clean install -Dtest=TestPriorityCompaction&lt;br/&gt;
dev cluster tests (on 0.89)&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Nicolas&lt;/p&gt;

</comment>
                            <comment id="12925621" author="hbasereviewboard" created="Thu, 28 Oct 2010 00:34:20 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1683&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1683&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/MemStoreFlusher.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5584&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5584&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Does this need to be explicitly PRIORITY_BLOCKING?  My first thought was no (thinking that SF count would still handle priorities), but it looks like this really prioritizes META compactions to always be critical.  Should this be MIN_INT, so it even prioritizes over true blocked stores?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12925622" author="nspiegelberg" created="Thu, 28 Oct 2010 00:35:01 +0000"  >&lt;p&gt;added diff to Review Board&lt;/p&gt;</comment>
                            <comment id="12925631" author="hbasereviewboard" created="Thu, 28 Oct 2010 01:06:15 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1684&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1684&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/MemStoreFlusher.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5585&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5585&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    never mind.  my fault for inverting the conditional logic.  this is the correct logic.  if (isTooManyStorefiles() == true) region.getCompactPriority() &amp;lt;= 0, so we&apos;re okay&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12925960" author="hbasereviewboard" created="Thu, 28 Oct 2010 21:49:19 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-10-28 14:48:04.897593)&lt;/p&gt;


&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Updates after internal review.&lt;br/&gt;
1. Removed PRIORITY_BLOCKING.  It was a little confusing because blocking is &amp;lt;= 0 and not necessarily the value 0 itself.&lt;br/&gt;
2. Cleaned up compaction downgrade conditional.&lt;/p&gt;

&lt;p&gt;Questions resolved:&lt;br/&gt;
1q. Wondering if we want to go ahead with a split if the compaction priority is PRIORITY_BLOCKING?&lt;br/&gt;
1a. Counter-example: storefiles could be very small and compaction will reduce it to one medium file. It was starved because a major compaction occurred immediately beforehand and took forever to finish.&lt;br/&gt;
2q. Should we add in logic to interrupt a running compaction if it is lower priority (e.g. Pri &amp;gt;= 5) and we have a PRIORITY_BLOCKING request? We can then re-enqueue the compaction to run at a less pressured time.&lt;br/&gt;
2a. Save this problem for another JIRA.  Since the master has threadpools, we should give the CompactSplitThread prioritized threadpools and dedicate one thread only to blocking requests.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Switch to more intelligent priority metric: blockingSize - max(len(s.storefiles) for s in region.stores) . This will allow us to better prioritize, give us faster responsiveness to users, and feel more cavalier about issuing new compaction requests.  Note that we also found/fixed a major compaction downgrade bug while writing this code.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3160&quot; title=&quot;Compactions: Use more intelligent priorities for PriorityCompactionQueue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3160&quot;&gt;&lt;del&gt;HBASE-3160&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3160&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3160&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactionRequestor.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/MemStoreFlusher.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 1027787 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestPriorityCompactionQueue.java 1027787 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1103/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;mvn clean install -Dtest=TestPriorityCompaction&lt;br/&gt;
dev cluster tests (on 0.89)&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Nicolas&lt;/p&gt;

</comment>
                            <comment id="12926167" author="hbasereviewboard" created="Fri, 29 Oct 2010 04:27:19 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1695&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1695&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Looks good to me.  You fellas think it a bug fix or a feature?  Should I punt to 0.92 or include now in TRUNK?&lt;/p&gt;


&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5605&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Why would we do this &amp;#8211; fiddle w/ our priority if we are going to split?  Should we check if we are to split first and if not then mess w/ priority?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5606&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5606&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    So, we aggregate these Store counts to come up w/ a Region count and the Region w/ most storefiles gets highest compaction priority?&lt;/p&gt;



&lt;p&gt;trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestPriorityCompactionQueue.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5607&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5607&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    There is white space here on end of lines... I can fix on commit.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12926170" author="hbasereviewboard" created="Fri, 29 Oct 2010 04:41:17 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1696&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1696&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5608&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5608&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    @Stack you&apos;re completely correct.  remember that we have splits turned off, so I wasn&apos;t thinking in that vein.  I think we want to unconditionally remove and then add only if(just_removed &amp;amp;&amp;amp; !splitting)&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5609&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5609&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    exactly.  that is how blockingStoreFile decisions are made right now.  this will also make it easy to transition to per-store compactions in the future.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12926173" author="hbasereviewboard" created="Fri, 29 Oct 2010 04:51:10 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1697&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1697&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;@Stack: Note that this is going into our 0.89 branch, so it should receive thorough real-world testing.  I would suggest the 0.90 branch.  It&apos;s actually a bug fix in addition to a feature.  With the current compaction logic (pre &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2462&quot; title=&quot;Review compaction heuristic and move compaction code out so standalone and independently testable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2462&quot;&gt;&lt;del&gt;HBASE-2462&lt;/del&gt;&lt;/a&gt;), the CompactSplitThread can get overwhlemed without this.  You unconditionally compact at least 4 files to be aggressive in times of light load.  This is fine until your load picks up, you&apos;re congested, and writing too many storefiles.  Then, since the PriorityCompactionQueue is essentially operating as a FIFO until the blocking limit, it doesn&apos;t make any informed decisions about who to service next and waits until your puts freeze to be intelligent...&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12926175" author="hbasereviewboard" created="Fri, 29 Oct 2010 05:05:22 +0000"  >&lt;p&gt;Message from: &quot;Ted Yu&quot; &amp;lt;ted_yu@yahoo.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1698&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1698&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5610&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5610&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Seems to be typo here.&lt;br/&gt;
    Should be: this region should have&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5611&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5611&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    It is possible to return a negative priority here.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ted&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12926176" author="hbasereviewboard" created="Fri, 29 Oct 2010 05:17:19 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-28 22:04:28, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java, line 1333&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line1333&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line1333&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     It is possible to return a negative priority here.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;that is correct.  the 0 is centered around the blocking limit.  I added a test to ensure that we can properly handle negative priorities and prioritize the most negative value @ TestPriorityCompactionQueue.java:308 .  Note that the code to handle priorities in the heap is @ PriorityCompactionQueue.java:89&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-28 22:04:28, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 3258&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16195#file16195line3258&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16195#file16195line3258&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Seems to be typo here.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Should be: this region should have&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;will fix&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1698&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1698&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12926178" author="hbasereviewboard" created="Fri, 29 Oct 2010 05:47:11 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-28 22:04:28, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 3258&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16195#file16195line3258&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16195#file16195line3258&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Seems to be typo here.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Should be: this region should have&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;will fix&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK... put up a new patch N and I&apos;ll commit.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1698&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1698&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12926179" author="hbasereviewboard" created="Fri, 29 Oct 2010 05:49:05 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-10-28 22:47:02.663004)&lt;/p&gt;


&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Just saying I&apos;ll commit after you put up new version Nicolas.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Switch to more intelligent priority metric: blockingSize - max(len(s.storefiles) for s in region.stores) . This will allow us to better prioritize, give us faster responsiveness to users, and feel more cavalier about issuing new compaction requests.  Note that we also found/fixed a major compaction downgrade bug while writing this code.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3160&quot; title=&quot;Compactions: Use more intelligent priorities for PriorityCompactionQueue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3160&quot;&gt;&lt;del&gt;HBASE-3160&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3160&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3160&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactionRequestor.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/MemStoreFlusher.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 1027787 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestPriorityCompactionQueue.java 1027787 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1103/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;mvn clean install -Dtest=TestPriorityCompaction&lt;br/&gt;
dev cluster tests (on 0.89)&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Nicolas&lt;/p&gt;

</comment>
                            <comment id="12926180" author="hbasereviewboard" created="Fri, 29 Oct 2010 05:53:12 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1703&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1703&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Oh, nm, I see you want to fix the typo AND change the split stuff...&lt;/p&gt;

&lt;p&gt;Ok, I&apos;ll wait on new patch.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12926181" author="hbasereviewboard" created="Fri, 29 Oct 2010 05:53:18 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-28 22:04:28, Ted Yu wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java, line 3258&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16195#file16195line3258&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16195#file16195line3258&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Seems to be typo here.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Should be: this region should have&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;will fix&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;OK... put up a new patch N and I&apos;ll commit.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nm nicolas... I&apos;ll fix this on commit... Committing now.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1698&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1698&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12926183" author="hbasereviewboard" created="Fri, 29 Oct 2010 06:01:05 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-10-28 23:00:28.324768)&lt;/p&gt;


&lt;p&gt;Review request for hbase.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;addressed Stack &amp;amp; Ted&apos;s comments&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Switch to more intelligent priority metric: blockingSize - max(len(s.storefiles) for s in region.stores) . This will allow us to better prioritize, give us faster responsiveness to users, and feel more cavalier about issuing new compaction requests.  Note that we also found/fixed a major compaction downgrade bug while writing this code.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3160&quot; title=&quot;Compactions: Use more intelligent priorities for PriorityCompactionQueue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3160&quot;&gt;&lt;del&gt;HBASE-3160&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3160&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3160&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactSplitThread.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/CompactionRequestor.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/MemStoreFlusher.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java 1027787 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 1027787 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestPriorityCompactionQueue.java 1027787 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1103/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;mvn clean install -Dtest=TestPriorityCompaction&lt;br/&gt;
dev cluster tests (on 0.89)&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Nicolas&lt;/p&gt;

</comment>
                            <comment id="12926184" author="nspiegelberg" created="Fri, 29 Oct 2010 06:06:53 +0000"  >&lt;p&gt;I made a minor typo when moving my fixes from internal to 0.90 in the Review Board diff.  This is the final version for the commit&lt;/p&gt;</comment>
                            <comment id="12926185" author="stack" created="Fri, 29 Oct 2010 06:10:36 +0000"  >&lt;p&gt;Committed because its a bug fix.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Nicolas and thanks for reviewing Ted.&lt;/p&gt;</comment>
                            <comment id="12926344" author="hbasereviewboard" created="Fri, 29 Oct 2010 16:51:11 +0000"  >&lt;p&gt;Message from: &quot;Kannan Muthukkaruppan&quot; &amp;lt;kannan@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1704&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1704&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5620&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5620&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    the comment around &quot;if it is already present in the queue&quot; needs to be updated.&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5621&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5621&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I think here and in this diff overall (as well as the log outputs) readability will be much better if we flipped the sign of the priority... i.e. higher values imply higher priority.&lt;/p&gt;






&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5619&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5619&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    -1 and not Integer.MAX_VALUE?&lt;/p&gt;

&lt;p&gt;    If blocking store files is not specified (i.e. user can tolerate any number of files), then as per your intent, don&apos;t you want PRIORITY_USER to be higher-pri always?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/#comment5618&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#comment5618&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I think we should state it here (or somewhere) explicitly that smaller values implies higher priority.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Kannan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12926356" author="hbasereviewboard" created="Fri, 29 Oct 2010 17:15:47 +0000"  >&lt;p&gt;Message from: &quot;Kannan Muthukkaruppan&quot; &amp;lt;kannan@facebook.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1705&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1705&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On second thoughts, I take back my comments on flipping the sign of the priority. I guess it is common to usage ( P0 &amp;gt; P1 &amp;gt; P2). Perhaps the -ve numbers were a little confusing, but what you have seems reasonable.&lt;/p&gt;




&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Kannan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12926363" author="hbasereviewboard" created="Fri, 29 Oct 2010 17:25:15 +0000"  >&lt;p&gt;Message from: &quot;Nicolas&quot; &amp;lt;nspiegelberg@facebook.com&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-29 09:48:53, Kannan Muthukkaruppan wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java, line 138&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16198#file16198line138&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16198#file16198line138&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     the comment around &quot;if it is already present in the queue&quot; needs to be updated.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;will update&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-29 09:48:53, Kannan Muthukkaruppan wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java, line 149&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16198#file16198line149&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16198#file16198line149&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think here and in this diff overall (as well as the log outputs) readability will be much better if we flipped the sign of the priority... i.e. higher values imply higher priority.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yeah, priority ordering on heaps are always controversial.  I think we should keep it as a minheap unless there is a reason to switch (no permanent state = no problem).  The nice thing about this ordering is that you know Pri &amp;lt;= 0 is bad, no matter what your blocking limit is.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-29 09:48:53, Kannan Muthukkaruppan wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java, line 190&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line190&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line190&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     -1 and not Integer.MAX_VALUE?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     If blocking store files is not specified (i.e. user can tolerate any number of files), then as per your intent, don&apos;t you want PRIORITY_USER to be higher-pri always?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;agreed.  I just used the original value from MemStoreFlusher, but your version makes the most sense.  Should this be a seperate jira though?  We would need to intestigate any other areas of code that would need to be changed by altering this default...&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-29 09:48:53, Kannan Muthukkaruppan wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java, line 1330&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line1330&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line1330&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think we should state it here (or somewhere) explicitly that smaller values implies higher priority.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;should we mention that in the CompactSplitThread?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Nicolas&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1704&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1704&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12926370" author="hbasereviewboard" created="Fri, 29 Oct 2010 17:39:05 +0000"  >&lt;p&gt;Message from: &quot;Kannan Muthukkaruppan&quot; &amp;lt;kannan@facebook.com&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-29 09:48:53, Kannan Muthukkaruppan wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/PriorityCompactionQueue.java, line 149&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16198#file16198line149&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16198#file16198line149&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think here and in this diff overall (as well as the log outputs) readability will be much better if we flipped the sign of the priority... i.e. higher values imply higher priority.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;yeah, priority ordering on heaps are always controversial.  I think we should keep it as a minheap unless there is a reason to switch (no permanent state = no problem).  The nice thing about this ordering is that you know Pri &amp;lt;= 0 is bad, no matter what your blocking limit is.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, ok with as is. I posted a subsequent comment to that effect.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-29 09:48:53, Kannan Muthukkaruppan wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java, line 190&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line190&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line190&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     -1 and not Integer.MAX_VALUE?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     If blocking store files is not specified (i.e. user can tolerate any number of files), then as per your intent, don&apos;t you want PRIORITY_USER to be higher-pri always?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;agreed.  I just used the original value from MemStoreFlusher, but your version makes the most sense.  Should this be a seperate jira though?  We would need to intestigate any other areas of code that would need to be changed by altering this default...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;separate JIRA is fine too. Whatever is easier.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-10-29 09:48:53, Kannan Muthukkaruppan wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java, line 1330&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line1330&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/diff/2/?file=16199#file16199line1330&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I think we should state it here (or somewhere) explicitly that smaller values implies higher priority.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Nicolas wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;should we mention that in the CompactSplitThread?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yes, that seems like a good spot.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Kannan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1704&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1704&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12926373" author="hbasereviewboard" created="Fri, 29 Oct 2010 17:53:17 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1103/#review1709&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1103/#review1709&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Please do as separate JIRA.  I committed last version of N&apos;s patch.  Do as separate JIRA and I&apos;ll commit.  Thanks lads.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12927694" author="whitingj" created="Tue, 2 Nov 2010 23:59:43 +0000"  >&lt;p&gt;Nicholas you mentioned in the jira that &quot;Note that we also found/fixed a major compaction downgrade bug while writing this code.&quot;  Being the primary author of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2646&quot; title=&quot;Compaction requests should be prioritized to prevent blocking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2646&quot;&gt;&lt;del&gt;HBASE-2646&lt;/del&gt;&lt;/a&gt; which added the priority compaction queue, I&apos;m interested in knowing what the bug was!  So what was the bug?  And what was your fix?&lt;/p&gt;

&lt;p&gt;I like the improvement and especially how it makes it much more granular in who should get priority.&lt;/p&gt;</comment>
                            <comment id="12927696" author="nspiegelberg" created="Wed, 3 Nov 2010 00:10:47 +0000"  >&lt;p&gt;@Jeff: The bug wasn&apos;t related to the priority compaction code.  The problem was in CompactSplitThread.requestCompaction().  If the user requested a major compaction, then the code would issue HRegion.setForceMajorCompaction(true).  however, if that region required a compaction while the HRegion was waiting in the compact queue, then the code would call setForceMajorCompaction(false) and downgrade the compaction request.&lt;/p&gt;</comment>
                            <comment id="12927887" author="davelatham" created="Wed, 3 Nov 2010 15:58:14 +0000"  >&lt;p&gt;Does that mean &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2770&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-2770&lt;/a&gt; is fixed then?&lt;/p&gt;</comment>
                            <comment id="12927969" author="nspiegelberg" created="Wed, 3 Nov 2010 19:41:18 +0000"  >&lt;p&gt;@Jeff: I forgot yesterday, but I also did fix an issue with the compaction priorities.  If a flush happened for the store that was being compacted, it would be added to the compaction queue at the pre-compact priority instead of post-compact.  We now do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
              &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.server.isStopRequested()) {
                &lt;span class=&quot;code-comment&quot;&gt;// requests that were added during compaction will have a 
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// stale priority. remove and re-insert to update priority
&lt;/span&gt;                &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hadCompaction = compactionQueue.remove(r);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (midKey != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                  split(r, midKey);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hadCompaction) {
                  compactionQueue.add(r);
                }
              }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12467631">HBASE-2770</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12462305">HBASE-2462</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12465893">HBASE-2646</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12458309" name="HBASE-3160.patch" size="20158" author="nspiegelberg" created="Fri, 29 Oct 2010 06:06:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 28 Oct 2010 00:28:10 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32927</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08sgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>49211</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>