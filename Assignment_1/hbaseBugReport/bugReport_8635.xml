<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:57:05 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8635/HBASE-8635.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8635] Define prefetcher.resultsize.max as percentage</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8635</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Currently &quot;hbase.hregionserver.prefetcher.resultsize.max&quot; defines global limit for prefetching.&lt;br/&gt;
The default value is 256MB.&lt;/p&gt;

&lt;p&gt;It would be more flexible to define this measure as a percentage of the heap.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12649808">HBASE-8635</key>
            <summary>Define prefetcher.resultsize.max as percentage</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="jxiang">Jimmy Xiang</assignee>
                                    <reporter username="yuzhihong@gmail.com">Ted Yu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 May 2013 22:48:46 +0000</created>
                <updated>Mon, 3 Jun 2013 21:54:28 +0000</updated>
                            <resolved>Mon, 3 Jun 2013 21:54:28 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13670713" author="jxiang" created="Thu, 30 May 2013 21:02:38 +0000"  >&lt;p&gt;Yes, it is more flexible to use percentage of max heap size.&lt;/p&gt;</comment>
                            <comment id="13670717" author="jxiang" created="Thu, 30 May 2013 21:07:17 +0000"  >&lt;p&gt;Attached a patch. It changed the meaning of &quot;hbase.hregionserver.prefetcher.resultsize.max&quot; from the actual bytes to the percentage.  Didn&apos;t change the parameter name. Added a check to make sure the value is between 0 and 1.  The default is 0.1.  The max heap size is calculated only once in HRegionServer to save some time, although it could change according to the java doc.&lt;/p&gt;</comment>
                            <comment id="13670813" author="hadoopqa" created="Thu, 30 May 2013 22:18:02 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12585473/trunk-8635.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12585473/trunk-8635.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop1.0&lt;/font&gt;.  The patch compiles against the hadoop 1.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop2.0&lt;/font&gt;.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;  &lt;font color=&quot;green&quot;&gt;+1 site&lt;/font&gt;.  The mvn site goal succeeds with this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5890//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13670928" author="yuzhihong@gmail.com" created="Thu, 30 May 2013 23:02:19 +0000"  >&lt;p&gt;Looks good to me.&lt;/p&gt;</comment>
                            <comment id="13671127" author="anoop.hbase" created="Fri, 31 May 2013 04:05:31 +0000"  >&lt;p&gt;HBaseConfiguration#checkForClusterFreeMemoryLimit()&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; globalMemstoreLimit = conf.getFloat(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.regionserver.global.memstore.upperLimit&quot;&lt;/span&gt;, 0.4f);
      &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; gml = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)(globalMemstoreLimit * CONVERT_TO_PERCENTAGE);
      &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; blockCacheUpperLimit =
        conf.getFloat(HConstants.HFILE_BLOCK_CACHE_SIZE_KEY,
          HConstants.HFILE_BLOCK_CACHE_SIZE_DEFAULT);
      &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bcul = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)(blockCacheUpperLimit * CONVERT_TO_PERCENTAGE);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (CONVERT_TO_PERCENTAGE - (gml + bcul)
              &amp;lt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)(CONVERT_TO_PERCENTAGE *
                      HConstants.HBASE_CLUSTER_MINIMUM_MEMORY_THRESHOLD)) {
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(....)
		  ...
	  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As per this check we need a memory of min 20%(other than the reserved max spaces) for the functioning of RS. Now in the Trunk gloabl memstore upperlimit and block cache size are default to 40% making sum to 80%. A default value of 10% to the prefetch scan should be accomodated in this condition. &lt;br/&gt;
We need to sacrifice 10% from the block cache?&lt;/p&gt;</comment>
                            <comment id="13671547" author="jxiang" created="Fri, 31 May 2013 15:09:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoop.hbase&quot; class=&quot;user-hover&quot; rel=&quot;anoop.hbase&quot;&gt;Anoop Sam John&lt;/a&gt;, what&apos;s your suggestion? I think it is reasonable to default to 10%.  It is the upper limit, not reserved all the time.&lt;/p&gt;</comment>
                            <comment id="13671603" author="anoop.hbase" created="Fri, 31 May 2013 16:06:10 +0000"  >&lt;p&gt;10% is reasonable. Only thing is we need to consider this also in the above scenario.  May be we need to reduce the block cache max% to 30? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; what do you say?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;It is the upper limit, not reserved all the time.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ya block cache also upper limit only. My point was what if ,at some point, all these caches taking its max possible? Will have only 10% remaining memory for op of the RS. Will that be enough? &lt;/p&gt;</comment>
                            <comment id="13671612" author="jxiang" created="Fri, 31 May 2013 16:14:31 +0000"  >&lt;p&gt;I agree. I think we can adjust the block cache upper limit percentage.  If more memory is needed, users have to increase the total.&lt;/p&gt;</comment>
                            <comment id="13671616" author="anoop.hbase" created="Fri, 31 May 2013 16:20:57 +0000"  >&lt;p&gt;Yes. Both block cache and prefetch cache associate with scan and user can adjust as per the need. We can reduce the default block cache %. This was recently increased from 25 to 40%. If Stack is fine with this, we can change. Thanks Jimmy&lt;/p&gt;</comment>
                            <comment id="13671701" author="jdcryans" created="Fri, 31 May 2013 18:11:07 +0000"  >&lt;p&gt;I agree that prefetching should be checked in checkForClusterFreeMemoryLimit() but one thing that worries me is all those users that already use 80% of their heap with BC and MemStores that won&apos;t be able to restart HBase once they upgrade because they&apos;d now be at 90% with pre-fetching.&lt;/p&gt;

&lt;p&gt;Next thing that worries me is that it&apos;s not clear to me that prefetching needs to scale with the amount of memory given to HBase. 10% of 1GB is ~100MB, of 10GB it&apos;s 1GB and of 24GB it&apos;s 2.4GB... that&apos;s a lot! Realistically, the main case I can think of that would do a lot of concurrent long scans is TIF. Let&apos;s say your TTs have 12 map slots, so you have as many scanners, and each of them read batches of 10MB (which is a lot), then you only need 12*10MB = 120MB for prefetching. I also voiced that concern in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-8420&quot; title=&quot;Port  HBASE-6874  Implement prefetching for scanners from 0.89-fb&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-8420&quot;&gt;&lt;del&gt;HBASE-8420&lt;/del&gt;&lt;/a&gt; that even 256MB seems too big.&lt;/p&gt;</comment>
                            <comment id="13672280" author="jxiang" created="Sat, 1 Jun 2013 22:27:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;worries me is all those users that already use 80% of their heap with BC and MemStores that won&apos;t be able to restart HBase once they upgrade because they&apos;d now be at 90% with pre-fetching.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will make sure prefetching is in checkForClusterFreeMemoryLimit. Fortunately, this is for 0.96.  I agree it is a concern, but it will be a little less of concern.&lt;/p&gt;

&lt;p&gt;I think that the fixed number is not very nice, either 256MB or 128MB.  I think it is good to scale with the amount of memory given to HBase.  If this is not wanted, the percentage can be adjusted. BC is very helpful if data is accessed multiple times.  Prefetching, however, should help all the time.  As Anoop suggested, we can lower the default BC to 30%.&lt;/p&gt;</comment>
                            <comment id="13673331" author="jdcryans" created="Mon, 3 Jun 2013 17:16:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Fortunately, this is for 0.96. I agree it is a concern, but it will be a little less of concern.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I can already see the emails titled &quot;Upgraded to 0.96.0 but cluster doesn&apos;t start, help!&quot; in which we tell them they have to change their configs and they have to pick which one of the 3 they want less of.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think it is good to scale with the amount of memory given to HBase&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought I gave a good demonstration why this is not a good idea with bigger heaps, was there anything you didn&apos;t agree with or do you have a counter-example?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Prefetching, however, should help all the time&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, Get-based workloads won&apos;t be faster and short Scans that require only 1 next call won&apos;t either. Short Scans that require a few next calls will beneficiate from it but I don&apos;t see that sort of use case needing GBs of prefetching.&lt;/p&gt;</comment>
                            <comment id="13673337" author="eclark" created="Mon, 3 Jun 2013 17:25:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;Prefetching, however, should help all the time&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Get based work loads will be hurt pretty significantly, as the block cache will be smaller due to the unused reserved space for pre-fetching.&lt;/p&gt;

&lt;p&gt;Honestly the whole on server pre-fetching scares me, and I would prefer to see usage before dedicated large amounts of ram to it by default.  Maybe by then we&apos;ll have autotuning (T-Pain style)&lt;/p&gt;</comment>
                            <comment id="13673351" author="jxiang" created="Mon, 3 Jun 2013 17:36:38 +0000"  >&lt;p&gt;One choice is to disable prefetching by default, so that users can make their own decision about when to turn it on and how much space it can use.&lt;/p&gt;</comment>
                            <comment id="13673640" author="jxiang" created="Mon, 3 Jun 2013 21:54:28 +0000"  >&lt;p&gt;OK, resolve it as &quot;Won&apos;t Fix&quot; due to strong objections.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12585473" name="trunk-8635.patch" size="6752" author="jxiang" created="Thu, 30 May 2013 21:01:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 30 May 2013 21:02:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>330135</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 28 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kyfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>330469</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>