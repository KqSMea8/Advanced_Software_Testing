<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:19:15 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-16935/HBASE-16935.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-16935] deleteColumn/modifyTable don&apos;t delete all family&apos;s StoreFile from file system</title>
                <link>https://issues.apache.org/jira/browse/HBASE-16935</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;The method deleteColumn(TableName tableName, byte[] columnName) of the class org.apache.hadoop.hbase.client.Admin shoud delete specified column family from specified table. (Despite of its name the method removes the family, not a column - view the &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1989&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;issue&lt;/a&gt;.)&lt;br/&gt;
This method changes the table&apos;s schema, but it doesn&apos;t delete column family&apos;s Store File from a file system. To be precise - I run this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.conf.Configuration;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HBaseConfiguration;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HColumnDescriptor;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.HTableDescriptor;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.TableName;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.client.*;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hbase.util.Bytes;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class ToHBaseIssueTracker {

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        TableName tableName = TableName.valueOf(&lt;span class=&quot;code-quote&quot;&gt;&quot;test_table&quot;&lt;/span&gt;);
        HTableDescriptor desc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTableDescriptor(tableName);
        desc.addFamily(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HColumnDescriptor(&lt;span class=&quot;code-quote&quot;&gt;&quot;cf1&quot;&lt;/span&gt;));
        desc.addFamily(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HColumnDescriptor(&lt;span class=&quot;code-quote&quot;&gt;&quot;cf2&quot;&lt;/span&gt;));

        Configuration conf = HBaseConfiguration.create();
        Connection connection = ConnectionFactory.createConnection(conf);
        Admin admin = connection.getAdmin();

        admin.createTable(desc);

        HTable table = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTable(conf, &lt;span class=&quot;code-quote&quot;&gt;&quot;test_table&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 4; i++) {
            Put put = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Put(Bytes.toBytes(i)); &lt;span class=&quot;code-comment&quot;&gt;// Use i as row key.
&lt;/span&gt;            put.addColumn(Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;cf1&quot;&lt;/span&gt;), Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;), Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;));
            put.addColumn(Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;cf2&quot;&lt;/span&gt;), Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;), Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;));
            table.put(put);
        }

        admin.deleteColumn(tableName, Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;cf2&quot;&lt;/span&gt;));
        admin.majorCompact(tableName);
        admin.close();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then I see that the store file for the &quot;cf2&quot; family persists in file system.&lt;br/&gt;
I observe this effect in standalone hbase installation and in pseudo-distributed mode.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13014745">HBASE-16935</key>
            <summary>deleteColumn/modifyTable don&apos;t delete all family&apos;s StoreFile from file system</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Mikhail_Zvagelsky">Mikhail Zvagelsky</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Oct 2016 14:39:16 +0000</created>
                <updated>Mon, 21 Nov 2016 15:00:08 +0000</updated>
                                            <version>1.2.3</version>
                                                    <component>Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="15602195" author="mikhail_zvagelsky" created="Mon, 24 Oct 2016 14:44:01 +0000"  >&lt;p&gt;Attach the &quot;cf2&quot; column family store file in hdfs file system browser - Selection_008.png. &lt;/p&gt;</comment>
                            <comment id="15612318" author="mikhail_zvagelsky" created="Thu, 27 Oct 2016 15:58:40 +0000"  >&lt;p&gt;It turns that we should disable table at first, and then delete a column family:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
admin.disableTable(tableName);
admin.deleteColumn(tableName, Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;cf2&quot;&lt;/span&gt;));
admin.enableTable(tableName);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In that case the store file for the the &quot;cf2&quot; family will be deleted from file system.&lt;/p&gt;</comment>
                            <comment id="15677128" author="mikhail_zvagelsky" created="Fri, 18 Nov 2016 16:53:05 +0000"  >&lt;p&gt;It would be handy if we can completely delete column family and its store files from a table without disabling the table, in the case when we can guarantee what will be no read/write operations with this column family, and we don&apos;t need this family more.&lt;/p&gt;</comment>
                            <comment id="15677463" author="mbertozzi" created="Fri, 18 Nov 2016 19:02:20 +0000"  >&lt;p&gt;from the code we actually remove the family dirs in both cases (table enabled or disabled). but since we reopen the regions after deleting the family folders we end up with the flushed on-close file in the deleted family.&lt;br/&gt;
so, all the files in the family except the flush on-close one will be removed.&lt;/p&gt;

&lt;p&gt;basically the simplified order of operation we have (since 0.94 or even before) is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;change the htd&lt;/li&gt;
	&lt;li&gt;drop the family folder&lt;/li&gt;
	&lt;li&gt;re-open regions (close region will trigger a flush of the family)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;we should probably flip the order, so we reopen with the new htd and then we remove the dirs.&lt;/p&gt;</comment>
                            <comment id="15683218" author="mikhail_zvagelsky" created="Mon, 21 Nov 2016 11:04:42 +0000"  >&lt;p&gt; Dear Matteo, thank you very much for the explanation!&lt;br/&gt;
Indeed if we flush memstore before column family deletion:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
admin.flush(tableName);
admin.deleteColumn(tableName, Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;cf2&quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the family&apos;s folder disappears from file system.&lt;br/&gt;
Probably the deleteColumn() method should remove column family data from memstore by default, otherwise, if used carelessly, it can produce unwanted files. &lt;br/&gt;
Thank you again!&lt;/p&gt;</comment>
                            <comment id="15683379" author="mikhail_zvagelsky" created="Mon, 21 Nov 2016 11:48:51 +0000"  >&lt;p&gt;Should I close this issue?&lt;/p&gt;</comment>
                            <comment id="15683788" author="mbertozzi" created="Mon, 21 Nov 2016 15:00:08 +0000"  >&lt;p&gt;I think we should fix it. &lt;br/&gt;
if no one has time to work on it, I&apos;ll take it as soon I have a bit of time.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12834948" name="Selection_008.png" size="36147" author="Mikhail_Zvagelsky" created="Mon, 24 Oct 2016 14:44:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 18 Nov 2016 19:02:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35ay7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>