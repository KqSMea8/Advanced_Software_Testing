<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:24:56 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5121/HBASE-5121.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5121] MajorCompaction may affect scan&apos;s correctness</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5121</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In our test, there are two families&apos; keyvalue for one row.&lt;/p&gt;

&lt;p&gt;But we could find a infrequent problem when doing scan&apos;s next if majorCompaction happens concurrently.&lt;br/&gt;
In the client&apos;s two continuous doing scan.next():&lt;br/&gt;
1.First time, scan&apos;s next returns the result where family A is null.&lt;br/&gt;
2.Second time, scan&apos;s next returns the result where family B is null.&lt;br/&gt;
The two next()&apos;s result have the same row.&lt;/p&gt;

&lt;p&gt;If there are more families, I think the scenario will be more strange...&lt;/p&gt;

&lt;p&gt;We find the reason is that storescanner.peek() is changed after majorCompaction if there are delete type KeyValue.&lt;br/&gt;
This change causes the PriorityQueue&amp;lt;KeyValueScanner&amp;gt; of RegionScanner&apos;s heap is not sure to be sorted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12537140">HBASE-5121</key>
            <summary>MajorCompaction may affect scan&apos;s correctness</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zjushch">chunhui shen</assignee>
                                    <reporter username="zjushch">chunhui shen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Jan 2012 06:39:08 +0000</created>
                <updated>Fri, 12 Oct 2012 05:34:54 +0000</updated>
                            <resolved>Tue, 10 Jan 2012 23:41:34 +0000</resolved>
                                    <version>0.90.4</version>
                                    <fixVersion>0.92.1</fixVersion>
                    <fixVersion>0.94.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="13179390" author="zhihyu@ebaysf.com" created="Wed, 4 Jan 2012 10:10:05 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.lastTop = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Storescanner.peek() is changed where before = &quot;&lt;/span&gt;
+            + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.lastTop.toString() + &lt;span class=&quot;code-quote&quot;&gt;&quot;,and after = &quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Should null assignment for lastTop be after the debug log ?&lt;/p&gt;</comment>
                            <comment id="13179666" author="lhofhansl" created="Wed, 4 Jan 2012 17:26:46 +0000"  >&lt;p&gt;I see the patch is against trunk. Does this happen in trunk only?&lt;/p&gt;

&lt;p&gt;It might have to do with the various optimization for scanning that the FB folks put in (if I recall FB rarely does major compactions).&lt;br/&gt;
Maybe Mikhail could have a look at this too.&lt;/p&gt;</comment>
                            <comment id="13179743" author="tlipcon" created="Wed, 4 Jan 2012 18:48:53 +0000"  >&lt;p&gt;No test for this? Can we get a functional test that can at least be run from the command line to trigger it?&lt;/p&gt;

&lt;p&gt;Nits: the javadoc on the constructors are unnecessary (they don&apos;t give any extra information)&lt;br/&gt;
Using the exception for control flow here looks dirty IMO.&lt;/p&gt;</comment>
                            <comment id="13180115" author="zjushch" created="Thu, 5 Jan 2012 01:55:40 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
I&apos;m sorry for the mistake when making patch for trunk.&lt;/p&gt;</comment>
                            <comment id="13180116" author="zjushch" created="Thu, 5 Jan 2012 01:58:40 +0000"  >&lt;p&gt;@Lars&lt;br/&gt;
Our test environment uses the 0.90 version,but I think it will also happens in 0.92 and trunk too.&lt;/p&gt;</comment>
                            <comment id="13180118" author="zjushch" created="Thu, 5 Jan 2012 02:01:10 +0000"  >&lt;p&gt;@Todd&lt;br/&gt;
I will append tests for this patch later.&lt;/p&gt;</comment>
                            <comment id="13180269" author="zjushch" created="Thu, 5 Jan 2012 10:35:11 +0000"  >&lt;p&gt;I add a unit test case in  hbase-5121-testcase.patch for this issue.&lt;br/&gt;
And the solution is  hbase-5121v2.patch &lt;/p&gt;</comment>
                            <comment id="13180279" author="zhihyu@ebaysf.com" created="Thu, 5 Jan 2012 10:57:45 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/672/console:&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/672/console:&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
HBASE-5121 patch is being downloaded at Thu Jan  5 10:51:42 UTC 2012 from
http:&lt;span class=&quot;code-comment&quot;&gt;//issues.apache.org/jira/secure/attachment/12509522/hbase-5121-testcase.patch&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the future, please attach the patch with solution last so that Hadoop QA can pick up.&lt;/p&gt;</comment>
                            <comment id="13180280" author="hadoopqa" created="Thu, 5 Jan 2012 10:58:03 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12509522/hbase-5121-testcase.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12509522/hbase-5121-testcase.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -151 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 79 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.regionserver.TestScanner&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/672//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/672//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/672//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/672//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/672//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/672//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13180281" author="zhihyu@ebaysf.com" created="Thu, 5 Jan 2012 11:03:49 +0000"  >&lt;p&gt;The above test failure shows the bug, that&apos;s great.&lt;/p&gt;

&lt;p&gt;About the patch itself, some minor comments:&lt;br/&gt;
Please add Apache license to PeekChangedException header.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+            + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.lastTop.toString() + &lt;span class=&quot;code-quote&quot;&gt;&quot;,and after = &quot;&lt;/span&gt;
+            + (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.heap.peek() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt; : &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.heap.peek().toString()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The null check on the second line is not needed for string concatenation. See &lt;a href=&quot;http://docs.oracle.com/javase/1.5.0/docs/api/java/lang/StringBuffer.html#append%28java.lang.String%29&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://docs.oracle.com/javase/1.5.0/docs/api/java/lang/StringBuffer.html#append%28java.lang.String%29&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      mayContainsMoreRows = currentAsInternal.next(result, limit);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since this part of the code is changed, please name the variable mayContainMoreRows.&lt;/p&gt;

&lt;p&gt;Please combine the two patches in one next time they&apos;re uploaded.&lt;/p&gt;

&lt;p&gt;Great work, Chunhui.&lt;/p&gt;</comment>
                            <comment id="13180284" author="zhihyu@ebaysf.com" created="Thu, 5 Jan 2012 11:17:15 +0000"  >&lt;p&gt;For the new test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
+      LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed&quot;&lt;/span&gt;, e);
+      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Is the above needed ? The exception, if thrown, would fail the test anyway.&lt;/p&gt;</comment>
                            <comment id="13180288" author="zjushch" created="Thu, 5 Jan 2012 11:23:53 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
Thanks for the advice.&lt;br/&gt;
I will submit a new patch later.&lt;/p&gt;</comment>
                            <comment id="13180615" author="zhihyu@ebaysf.com" created="Thu, 5 Jan 2012 17:43:45 +0000"  >&lt;p&gt;Combined patch for TRUNK based on the two files Chunhui provided.&lt;/p&gt;

&lt;p&gt;Putting it through tests and waiting for more reviews.&lt;/p&gt;</comment>
                            <comment id="13180631" author="lhofhansl" created="Thu, 5 Jan 2012 17:56:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;We find the reason is that storescanner.peek() is changed after majorCompaction if there are delete type KeyValue.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do we know why/how that happens? Just want to make sure that we&apos;re not just pasting over symptoms with this.&lt;/p&gt;</comment>
                            <comment id="13180662" author="hadoopqa" created="Thu, 5 Jan 2012 18:27:34 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12509573/5121-trunk-combined.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12509573/5121-trunk-combined.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -151 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 79 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.replication.TestReplicationPeer&lt;br/&gt;
                  org.apache.hadoop.hbase.replication.TestReplication&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestImportTsv&lt;br/&gt;
                  org.apache.hadoop.hbase.mapred.TestTableMapReduce&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestHFileOutputFormat&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/673//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/673//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/673//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/673//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/673//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/673//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13180686" author="nspiegelberg" created="Thu, 5 Jan 2012 18:51:25 +0000"  >&lt;p&gt;Seems like this touches the work that Amitanand worked on with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2856&quot; title=&quot;TestAcidGuarantee broken on trunk &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2856&quot;&gt;&lt;del&gt;HBASE-2856&lt;/del&gt;&lt;/a&gt;.  You should have him look at this.  &lt;/p&gt;</comment>
                            <comment id="13180887" author="zhihyu@ebaysf.com" created="Thu, 5 Jan 2012 22:14:27 +0000"  >&lt;p&gt;Amit&apos;s review is certainly welcome.&lt;br/&gt;
We may add more tests involving deletion and major compaction.&lt;/p&gt;</comment>
                            <comment id="13181034" author="zjushch" created="Fri, 6 Jan 2012 01:39:27 +0000"  >&lt;p&gt;@Lars&lt;br/&gt;
Its happen need two conditions.&lt;br/&gt;
1.storescanner.peek() is delete type keyvalue.&lt;br/&gt;
2.do majorcompaction before scan.next(), and this majorcompaction combine the del type KV and put type KV to nothing.&lt;/p&gt;</comment>
                            <comment id="13181120" author="zhihyu@ebaysf.com" created="Fri, 6 Jan 2012 05:32:32 +0000"  >&lt;p&gt;@Chunhui:&lt;br/&gt;
Do you mind producing a patch for 0.90 branch ?&lt;br/&gt;
If you&apos;re busy, I can do it.&lt;/p&gt;</comment>
                            <comment id="13181484" author="zhihyu@ebaysf.com" created="Fri, 6 Jan 2012 18:09:38 +0000"  >&lt;p&gt;Patch for 0.90 branch.&lt;/p&gt;</comment>
                            <comment id="13181502" author="ram_krish" created="Fri, 6 Jan 2012 18:37:49 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
Thanks for the 0.90 patch.&lt;/p&gt;</comment>
                            <comment id="13181543" author="zhihyu@ebaysf.com" created="Fri, 6 Jan 2012 19:27:15 +0000"  >&lt;p&gt;People expressed concern whether introducing a new exception is the best approach to take.&lt;/p&gt;

&lt;p&gt;@Chunhui:&lt;br/&gt;
Please extrapolate on other alternatives.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13181735" author="zjushch" created="Sat, 7 Jan 2012 00:50:42 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
when majorcompaction changes storescanner.peek, we need to tell the upper storeheap(regionscanner&apos;s heap) to resort this storescanner again.&lt;br/&gt;
we have tried some other approaches for the above motivation.But we think throwing an exception is much easier and available to transfer the message of peek changed.&lt;br/&gt;
It only happen in a read handler. So it is healthy and will not affect the kernal thread of regionserver.&lt;/p&gt;

&lt;p&gt;If there are other approaches, I&apos;d like to discuss about them.&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="13181791" author="zhihyu@ebaysf.com" created="Sat, 7 Jan 2012 03:16:54 +0000"  >&lt;p&gt;w.r.t. introducing new exception, here is StoreScanner.next():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there are more rows, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; scanner is done
   */
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; next(List&amp;lt;KeyValue&amp;gt; outResult, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; limit) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {

    checkReseek();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The return value has clear meaning. One approach is to change return type to an enum.&lt;/p&gt;

&lt;p&gt;@Chunhui:&lt;br/&gt;
Do you have time to come up with a patch that doesn&apos;t rely on new exception. Instead, it relies on StoreScanner.next() returning an enum (SCAN_DONE, MORE_ROWS, PEEK_CHANGED).&lt;br/&gt;
This way, people can evaluate both approaches.&lt;/p&gt;

&lt;p&gt;Of course, Stack and Todd may comment on other areas of the patch.&lt;/p&gt;</comment>
                            <comment id="13182166" author="zjushch" created="Sun, 8 Jan 2012 00:57:59 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
ok, I will make a new patch&lt;/p&gt;</comment>
                            <comment id="13182178" author="zjushch" created="Sun, 8 Jan 2012 02:08:27 +0000"  >&lt;p&gt;@Ted&lt;/p&gt;

&lt;p&gt;If we change StoreScanner.next() to return an enum , we should change all the implement of InternalScanner.next(), therefore KeyValueHeap.next()&apos;s return should also be changed to an enum. It needs to change the logic who calles KeyValueHeap.next() .&lt;/p&gt;

&lt;p&gt;I think it changes too much, does it need?&lt;/p&gt;</comment>
                            <comment id="13182184" author="zhihyu@ebaysf.com" created="Sun, 8 Jan 2012 02:29:08 +0000"  >&lt;p&gt;@Chunhui:&lt;br/&gt;
I agree.&lt;/p&gt;

&lt;p&gt;That&apos;s why I think creating a new exception is acceptable.&lt;br/&gt;
Maybe Todd or Stack has better idea.&lt;/p&gt;</comment>
                            <comment id="13182185" author="lhofhansl" created="Sun, 8 Jan 2012 02:41:31 +0000"  >&lt;p&gt;I was looking at the patch a bit. Maybe there is a simpler solution:&lt;br/&gt;
You say in that when this scenario happens the KV just &quot;vanishes&quot;.&lt;br/&gt;
What your logic in KeyValueHeap is essentially doing is to retry with the next KV on the heap.&lt;br/&gt;
So, we can just tell the KeyValueHeap that there are more KVs in this case (returning true for mayContainMoreRows).&lt;/p&gt;

&lt;p&gt;With this your test passes.&lt;br/&gt;
(it is entirely possible that my reasoning is incorrect, and it just accidentally lets the test pass).&lt;/p&gt;</comment>
                            <comment id="13182190" author="hadoopqa" created="Sun, 8 Jan 2012 03:27:12 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12509823/5121-suggest.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12509823/5121-suggest.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -151 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 79 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.mapreduce.TestImportTsv&lt;br/&gt;
                  org.apache.hadoop.hbase.mapred.TestTableMapReduce&lt;br/&gt;
                  org.apache.hadoop.hbase.mapreduce.TestHFileOutputFormat&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/700//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/700//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/700//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/700//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/700//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/700//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13182345" author="zjushch" created="Mon, 9 Jan 2012 01:55:51 +0000"  >&lt;p&gt;@Lars&lt;br/&gt;
I agree with the suggested patch which is simpler and available.&lt;/p&gt;</comment>
                            <comment id="13183016" author="lhofhansl" created="Tue, 10 Jan 2012 02:22:44 +0000"  >&lt;p&gt;Any more input on the latest patch?&lt;/p&gt;

&lt;p&gt;Re: 0.90.6. It seems we should do this only in 0.92 and above as 0.90.x does not provide many of the ACID guarantees anyway (see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2856&quot; title=&quot;TestAcidGuarantee broken on trunk &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2856&quot;&gt;&lt;del&gt;HBASE-2856&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4838&quot; title=&quot;Port 2856 (TestAcidGuarantee is failing) to 0.92&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4838&quot;&gt;&lt;del&gt;HBASE-4838&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13183019" author="zhihyu@ebaysf.com" created="Tue, 10 Jan 2012 02:29:35 +0000"  >&lt;p&gt;+1 on latest patch going to 0.92 and TRUNK.&lt;/p&gt;</comment>
                            <comment id="13183101" author="lhofhansl" created="Tue, 10 Jan 2012 05:57:16 +0000"  >&lt;p&gt;OK... will commit tomorrow unless there are any objections.&lt;br/&gt;
@Ram: You OK with this not being in 0.90.6?&lt;/p&gt;</comment>
                            <comment id="13183110" author="ram_krish" created="Tue, 10 Jan 2012 06:33:52 +0000"  >&lt;p&gt;@Lars&lt;br/&gt;
Ok for not going into 0.90.6. Thanks Lars.&lt;/p&gt;</comment>
                            <comment id="13183711" author="lhofhansl" created="Tue, 10 Jan 2012 23:41:15 +0000"  >&lt;p&gt;Patch against 0.92&lt;/p&gt;</comment>
                            <comment id="13183712" author="lhofhansl" created="Tue, 10 Jan 2012 23:41:34 +0000"  >&lt;p&gt;Committed to 0.92 and trunk (5121-suggest.txt)&lt;/p&gt;</comment>
                            <comment id="13183803" author="hudson" created="Wed, 11 Jan 2012 02:22:07 +0000"  >&lt;p&gt;Integrated in HBase-0.92 #239 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92/239/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92/239/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; MajorCompaction may affect scan&apos;s correctness (chunhui shen and Lars H)&lt;/p&gt;

&lt;p&gt;larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/KeyValueHeap.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/regionserver/TestScanner.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13183917" author="hudson" created="Wed, 11 Jan 2012 06:56:25 +0000"  >&lt;p&gt;Integrated in HBase-0.92-security #71 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92-security/71/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92-security/71/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; MajorCompaction may affect scan&apos;s correctness (chunhui shen and Lars H)&lt;/p&gt;

&lt;p&gt;larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/KeyValueHeap.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/regionserver/TestScanner.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13183930" author="hudson" created="Wed, 11 Jan 2012 07:34:20 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-security #72 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-security/72/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-security/72/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; MajorCompaction may affect scan&apos;s correctness (chunhui shen and Lars H)&lt;/p&gt;

&lt;p&gt;larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/KeyValueHeap.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestScanner.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13183972" author="hudson" created="Wed, 11 Jan 2012 10:31:01 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2617 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2617/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2617/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5121&quot; title=&quot;MajorCompaction may affect scan&amp;#39;s correctness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5121&quot;&gt;&lt;del&gt;HBASE-5121&lt;/del&gt;&lt;/a&gt; MajorCompaction may affect scan&apos;s correctness (chunhui shen and Lars H)&lt;/p&gt;

&lt;p&gt;larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/KeyValueHeap.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestScanner.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13185113" author="lhofhansl" created="Thu, 12 Jan 2012 18:05:44 +0000"  >&lt;p&gt;Thanks for finding and patch chunhui.&lt;/p&gt;</comment>
                            <comment id="13420274" author="lhofhansl" created="Sun, 22 Jul 2012 19:07:17 +0000"  >&lt;p&gt;@chunhui: Could have a look at the suggested change in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5659&quot; title=&quot;TestAtomicOperation.testMultiRowMutationMultiThreads is still failing occasionally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5659&quot;&gt;&lt;del&gt;HBASE-5659&lt;/del&gt;&lt;/a&gt;?&lt;br/&gt;
The observation is that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;after the scanner is reset the top KV will in the vast majority of all case be changed&lt;/li&gt;
	&lt;li&gt;that is only a problem when the top KV&apos;s row has changed, in many case StoreScanner.next indicates more work than necessary to a caller.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Edit: Misspelled chunhui&apos;s name...&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12548382">HBASE-5659</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12469746">HBASE-2856</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12510123" name="5121-0.92.txt" size="7272" author="lhofhansl" created="Tue, 10 Jan 2012 23:41:14 +0000"/>
                            <attachment id="12509823" name="5121-suggest.txt" size="7601" author="lhofhansl" created="Sun, 8 Jan 2012 02:41:31 +0000"/>
                            <attachment id="12509573" name="5121-trunk-combined.txt" size="9032" author="zhihyu@ebaysf.com" created="Thu, 5 Jan 2012 17:43:45 +0000"/>
                            <attachment id="12509698" name="5121.90" size="8487" author="zhihyu@ebaysf.com" created="Fri, 6 Jan 2012 18:09:38 +0000"/>
                            <attachment id="12509522" name="hbase-5121-testcase.patch" size="4570" author="zjushch" created="Thu, 5 Jan 2012 10:33:32 +0000"/>
                            <attachment id="12509381" name="hbase-5121.patch" size="4530" author="zjushch" created="Wed, 4 Jan 2012 06:46:06 +0000"/>
                            <attachment id="12509521" name="hbase-5121v2.patch" size="3427" author="zjushch" created="Thu, 5 Jan 2012 10:33:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 4 Jan 2012 10:10:05 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>222650</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i069rz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34515</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>