<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:32:25 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-12376/HBASE-12376.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-12376] HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException)</title>
                <link>https://issues.apache.org/jira/browse/HBASE-12376</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;This is a 0.98 issue that some users have been running into mostly running Canary and for whatever reason, setup of zk connection fails, usually with a ConnectionLossException.  End result is ugly leak zk connections.  ZKWatcher created instances are just left hang out.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12751470">HBASE-12376</key>
            <summary>HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Oct 2014 19:36:07 +0000</created>
                <updated>Sat, 29 Nov 2014 22:31:42 +0000</updated>
                            <resolved>Wed, 29 Oct 2014 21:58:50 +0000</resolved>
                                    <version>0.98.7</version>
                    <version>0.94.24</version>
                                    <fixVersion>0.98.8</fixVersion>
                    <fixVersion>0.94.25</fixVersion>
                                    <component>Zookeeper</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="14188864" author="stack" created="Wed, 29 Oct 2014 19:38:38 +0000"  >&lt;p&gt;Patch for 0.98.&lt;/p&gt;

&lt;p&gt;Don&apos;t have issue in master/branch-1.&lt;/p&gt;

&lt;p&gt;Opened up CatalogTracker some so I could inject failure for a unit test.&lt;/p&gt;

&lt;p&gt;Reviews please.  Locally 0.98 TestAdmin passes.&lt;/p&gt;</comment>
                            <comment id="14188870" author="stack" created="Wed, 29 Oct 2014 19:42:21 +0000"  >&lt;p&gt;There is no CatalogTracker in branch-1+&lt;/p&gt;</comment>
                            <comment id="14188918" author="busbey" created="Wed, 29 Oct 2014 20:12:11 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
+      &lt;span class=&quot;code-comment&quot;&gt;// If we did not succeed but created a catalogtracker, clean it up. CT has a ZK instance
&lt;/span&gt;+      &lt;span class=&quot;code-comment&quot;&gt;// in it and we&apos;ll leak &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we don&apos;t &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; the &apos;stop&apos;.
&lt;/span&gt;+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!succeeded &amp;amp;&amp;amp; ct != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+        ct.stop();
+        ct = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Wrap the ct.stop() call in a try/catch(RuntimeException) that logs a warning. Otherwise, if we end up in the finally block because of an exception (RuntimeException, ZooKeeperConnectionException, or IOException) and it should throw we&apos;ll overrun the original exception.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  /**
+   * For testing so can intercept the catalog tracker start.
+   * @param c
+   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Instance of CatalogTracker or exceptions &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we fail
+   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
+   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException
+   */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;leave out the boilerplate javadoc param and throws.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+  @VisibleForTesting
+  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; CatalogTracker startCatalogTracker(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CatalogTracker ct)
+  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;nit: this can be package-private and still be used in the test it&apos;s currently used in.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      CatalogTracker ct = doctoredAdmin.getCatalogTracker();
+      assertFalse(ct.isStopped());
+      ct.stop();
+      assertTrue(ct.isStopped());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;use &lt;tt&gt;doctoredAdmin.cleanupCatalogTracker(ct)&lt;/tt&gt; instead of &lt;tt&gt;ct.stop()&lt;/tt&gt; since that&apos;s what the javadoc for getCatalogTracker says to do.&lt;/p&gt;</comment>
                            <comment id="14188950" author="stack" created="Wed, 29 Oct 2014 20:32:31 +0000"  >&lt;p&gt;Thanks for nice review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=busbey&quot; class=&quot;user-hover&quot; rel=&quot;busbey&quot;&gt;Sean Busbey&lt;/a&gt;  This version addresses all your comments.&lt;/p&gt;

&lt;p&gt;Regards....&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Wrap the ct.stop() call in a try/catch(RuntimeException) that logs a warning. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So, you say RuntimeException in case an unexpected Exception (OOME or something?).  The stop does pretty good job at catching all other crap.  This a style you think we should institute throughout?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="14188986" author="busbey" created="Wed, 29 Oct 2014 21:00:36 +0000"  >&lt;blockquote&gt;
&lt;p&gt;So, you say RuntimeException in case an unexpected Exception (OOME or something?). The stop does pretty good job at catching all other crap. This a style you think we should institute throughout?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, something like that. It&apos;s a general code hygiene thing to guard against exceptions in finally blocks because of how it hides root causes. I&apos;d be in favor of fixing it where we can.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+          ct.stop();
+        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RuntimeException re) {
+          LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;In cleanup&quot;&lt;/span&gt;, re);
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since this is client side code, something with a stronger statement of action maybe something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to clean up HBase&apos;s internal catalog tracker after a failed initialization. &quot;&lt;/span&gt; +
      &lt;span class=&quot;code-quote&quot;&gt;&quot;We may have leaked network connections to ZooKeeper; they won&apos;t be cleaned up until &quot;&lt;/span&gt; +
      &lt;span class=&quot;code-quote&quot;&gt;&quot;the JVM exits. If you see a large number of stale connections to ZooKeeper &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is likely &quot;&lt;/span&gt; +
      &lt;span class=&quot;code-quote&quot;&gt;&quot;the cause. The following exception details will be needed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; assistance from the &quot;&lt;/span&gt; +
      &lt;span class=&quot;code-quote&quot;&gt;&quot;HBase community.&quot;&lt;/span&gt;, re);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Actually now that I&apos;m reading it, that&apos;s a bit long. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Maybe an additional section for the ref guide section on troubleshooting related to ZooKeeper (currently 15.11) and then a link to it in the log message?&lt;/p&gt;

&lt;p&gt;Otherwise, +1 LGTM (I&apos;m presuming you&apos;ll squash before pushing)&lt;/p&gt;</comment>
                            <comment id="14189090" author="stack" created="Wed, 29 Oct 2014 21:58:50 +0000"  >&lt;p&gt;I liked your text &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=busbey&quot; class=&quot;user-hover&quot; rel=&quot;busbey&quot;&gt;Sean Busbey&lt;/a&gt;; thats what I committed to 0.94 and 0.98 branches.  Thanks for reviews.&lt;/p&gt;</comment>
                            <comment id="14189221" author="hudson" created="Wed, 29 Oct 2014 23:05:53 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.94-security #549 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/549/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/549/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12376&quot; title=&quot;HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12376&quot;&gt;&lt;del&gt;HBASE-12376&lt;/del&gt;&lt;/a&gt; HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException) (stack: rev 23c71579caf4884aaa6bea894e647c643afbc64c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java&lt;/li&gt;
	&lt;li&gt;src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14189244" author="hudson" created="Wed, 29 Oct 2014 23:13:44 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.94 #1435 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94/1435/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94/1435/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12376&quot; title=&quot;HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12376&quot;&gt;&lt;del&gt;HBASE-12376&lt;/del&gt;&lt;/a&gt; HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException) (stack: rev 23c71579caf4884aaa6bea894e647c643afbc64c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;/li&gt;
	&lt;li&gt;src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java&lt;/li&gt;
	&lt;li&gt;src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14189262" author="hudson" created="Wed, 29 Oct 2014 23:21:13 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.94-JDK7 #204 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-JDK7/204/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-JDK7/204/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12376&quot; title=&quot;HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12376&quot;&gt;&lt;del&gt;HBASE-12376&lt;/del&gt;&lt;/a&gt; HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException) (stack: rev 23c71579caf4884aaa6bea894e647c643afbc64c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java&lt;/li&gt;
	&lt;li&gt;src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14189386" author="hudson" created="Thu, 30 Oct 2014 00:38:31 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98-on-Hadoop-1.1 #607 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/607/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/607/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12376&quot; title=&quot;HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12376&quot;&gt;&lt;del&gt;HBASE-12376&lt;/del&gt;&lt;/a&gt; HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException) (stack: rev 8e64e1bbe0fce72074eae14c80541ef3e1365429)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14189412" author="hudson" created="Thu, 30 Oct 2014 01:02:49 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98 #638 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/638/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/638/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12376&quot; title=&quot;HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12376&quot;&gt;&lt;del&gt;HBASE-12376&lt;/del&gt;&lt;/a&gt; HBaseAdmin leaks ZK connections if failure starting watchers (ConnectionLossException) (stack: rev 8e64e1bbe0fce72074eae14c80541ef3e1365429)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java&lt;/li&gt;
	&lt;li&gt;hbase-client/src/main/java/org/apache/hadoop/hbase/catalog/CatalogTracker.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12677976" name="0001-12376-HBaseAdmin-leaks-ZK-connections-if-failure-sta.patch" size="11373" author="stack" created="Wed, 29 Oct 2014 19:38:38 +0000"/>
                            <attachment id="12677991" name="0001-12376-HBaseAdmin-leaks-ZK-connections-if-failure-sta.version2.patch" size="13972" author="stack" created="Wed, 29 Oct 2014 20:32:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Oct 2014 20:12:11 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21qf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>