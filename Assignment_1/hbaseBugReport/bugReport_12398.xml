<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:32:37 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-12398/HBASE-12398.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-12398] Region isn&apos;t assigned in an extreme race condition</title>
                <link>https://issues.apache.org/jira/browse/HBASE-12398</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In a test, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; has seen a condition which made one of the regions unassigned. &lt;/p&gt;

&lt;p&gt;The client failed since the region is not online anywhere: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-10-29 01:51:40,731 WARN  [HBaseReaderThread_13] util.MultiThreadedReader: org.apache.hadoop.hbase.client.RetriesExhaustedException: Failed after attempts=35, exceptions:
Wed Oct 29 01:39:51 UTC 2014, org.apache.hadoop.hbase.client.RpcRetryingCaller@cc21330, org.apache.hadoop.hbase.NotServingRegionException: org.apache.hadoop.hbase.NotServingRegionException: Region IntegrationTestRegionReplicaReplication,06666666,1414545619766_0001.689b77e1bad7e951b0d9ef4663b217e9. is not online on hor8n08.gq1.ygridcore.net,60020,1414546670414
        at org.apache.hadoop.hbase.regionserver.HRegionServer.getRegionByEncodedName(HRegionServer.java:2774)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.getRegion(HRegionServer.java:4257)
        at org.apache.hadoop.hbase.regionserver.HRegionServer.get(HRegionServer.java:2906)
        at org.apache.hadoop.hbase.protobuf.generated.ClientProtos$ClientService$2.callBlockingMethod(ClientProtos.java:29990)
        at org.apache.hadoop.hbase.ipc.RpcServer.call(RpcServer.java:2078)
        at org.apache.hadoop.hbase.ipc.CallRunner.run(CallRunner.java:108)
        at org.apache.hadoop.hbase.ipc.RpcExecutor.consumerLoop(RpcExecutor.java:114)
        at org.apache.hadoop.hbase.ipc.RpcExecutor$1.run(RpcExecutor.java:94)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The root cause of the issue is due to some extreme race condition:&lt;/p&gt;

&lt;p&gt;a) a region is about to open and receives a closeRpc request triggered by a second re-assignment&lt;br/&gt;
b) the second re-assignment updates region state to offline while immediately is overwritten to OPEN from previous region open ZK opened notification&lt;br/&gt;
c) when the region reopened on the same RS by the second assignment, AM force the region to close as the its region state isn&apos;t in PendingOpenOrOpening state.  &lt;br/&gt;
d) the region ends up offline &amp;amp; can&apos;t server any request&lt;/p&gt;

&lt;p&gt;Region Server Side:&lt;br/&gt;
1) A region almost opens region 689b77e1bad7e951b0d9ef4663b217e9 while the RS(hor8n10) receives a closeRegion request.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-10-29 01:39:43,153 INFO  [PriorityRpcServer.handler=2,queue=0,port=60020] regionserver.HRegionServer: Received CLOSE for the region:689b77e1bad7e951b0d9ef4663b217e9 , which we are already trying to OPEN. Cancelling OPENING.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2) Since region 689b77e1bad7e951b0d9ef4663b217e9 was already opened right before some final steps, so the RS logs the following message and close 689b77e1bad7e951b0d9ef4663b217e9 immediately after the RS update ZK node state to &apos;OPENED&apos;.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-10-29 01:39:43,198 ERROR [RS_OPEN_REGION-hor8n10:60020-0] handler.OpenRegionHandler: Race condition: we&apos;ve finished to open a region, while a close was requested  on region=IntegrationTestRegionReplicaReplication,06666666,1414545619766_0001.689b77e1bad7e951b0d9ef4663b217e9.. It can be a critical error, as a region that should be closed is now opened. Closing it now
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In Master Server Side:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-10-29 01:39:43,177 DEBUG [AM.ZK.Worker-pool2-t55] master.AssignmentManager: Handling RS_ZK_REGION_OPENED, server=hor8n10.gq1.ygridcore.net,60020,1414546531945, region=689b77e1bad7e951b0d9ef4663b217e9, current_state={689b77e1bad7e951b0d9ef4663b217e9 state=OPENING, ts=1414546783152, server=hor8n10.gq1.ygridcore.net,60020,1414546531945}
....
2014-10-29 01:39:43,255 DEBUG [AM.-pool1-t16] master.AssignmentManager: Offline IntegrationTestRegionReplicaReplication,06666666,1414545619766_0001.689b77e1bad7e951b0d9ef4663b217e9., it&apos;s not any more on hor8n10.gq1.ygridcore.net,60020,1414546531945
....
2014-10-29 01:39:43,942 DEBUG [AM.ZK.Worker-pool2-t58] master.AssignmentManager: Handling RS_ZK_REGION_OPENED, server=hor8n10.gq1.ygridcore.net,60020,1414546531945, region=689b77e1bad7e951b0d9ef4663b217e9, current_state={689b77e1bad7e951b0d9ef4663b217e9 state=OPEN, ts=1414546783387, server=hor8n10.gq1.ygridcore.net,60020,1414546531945}
2014-10-29 01:39:43,942 WARN  [AM.ZK.Worker-pool2-t58] master.AssignmentManager: Received OPENED for 689b77e1bad7e951b0d9ef4663b217e9 from hor8n10.gq1.ygridcore.net,60020,1414546531945 but the region isn&apos;t PENDING_OPEN/OPENING here: {689b77e1bad7e951b0d9ef4663b217e9 state=OPEN, ts=1414546783387, server=hor8n10.gq1.ygridcore.net,60020,1414546531945}
2014-10-29 01:39:43,948 DEBUG [AM.ZK.Worker-pool2-t58] master.AssignmentManager: Sent CLOSE to hor8n10.gq1.ygridcore.net,60020,1414546531945 for region IntegrationTestRegionReplicaReplication,06666666,1414545619766_0001.689b77e1bad7e951b0d9ef4663b217e9.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


</description>
                <environment></environment>
        <key id="12752040">HBASE-12398</key>
            <summary>Region isn&apos;t assigned in an extreme race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jeffreyz">Jeffrey Zhong</assignee>
                                    <reporter username="jeffreyz">Jeffrey Zhong</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Oct 2014 19:06:35 +0000</created>
                <updated>Sat, 21 Feb 2015 23:45:38 +0000</updated>
                            <resolved>Wed, 3 Dec 2014 03:52:35 +0000</resolved>
                                    <version>0.98.7</version>
                                    <fixVersion>0.98.9</fixVersion>
                    <fixVersion>0.99.2</fixVersion>
                                    <component>Region Assignment</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="14192285" author="jeffreyz" created="Fri, 31 Oct 2014 19:16:12 +0000"  >&lt;p&gt;The patch makes sure that we transition a region&apos;s state to open in checkAndPut fashion so it won&apos;t overlap with another operation.&lt;/p&gt;</comment>
                            <comment id="14192299" author="hadoopqa" created="Fri, 31 Oct 2014 19:24:41 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12678531/HBASE-12398.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12678531/HBASE-12398.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12678531&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11547//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11547//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14192413" author="enis" created="Fri, 31 Oct 2014 20:24:07 +0000"  >&lt;p&gt;I think this is a 0.98 patch. It looks good to me, but we will need a patch for master as well. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;Jimmy Xiang&lt;/a&gt; maybe you can take a look. &lt;/p&gt;</comment>
                            <comment id="14192770" author="jeffreyz" created="Fri, 31 Oct 2014 23:53:13 +0000"  >&lt;p&gt;Yes, this is only 0.98 &amp;amp; branch-1. Trunk code change significantly and seems may not happen. &lt;/p&gt;</comment>
                            <comment id="14192803" author="apurtell" created="Sat, 1 Nov 2014 00:14:19 +0000"  >&lt;p&gt;+1 for 0.98&lt;/p&gt;</comment>
                            <comment id="14193657" author="jxiang" created="Sun, 2 Nov 2014 02:32:43 +0000"  >&lt;p&gt;The master branch should not have such a problem because only master updates the region states (step b won&apos;t happen). So I think we don&apos;t need a patch for master.&lt;/p&gt;</comment>
                            <comment id="14232535" author="enis" created="Wed, 3 Dec 2014 03:52:35 +0000"  >&lt;p&gt;Committed this to 0.98 and branch-1. Thanks Jeffrey. &lt;/p&gt;</comment>
                            <comment id="14232646" author="hudson" created="Wed, 3 Dec 2014 06:17:39 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-1.0 #533 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-1.0/533/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-1.0/533/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12398&quot; title=&quot;Region isn&amp;#39;t assigned in an extreme race condition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12398&quot;&gt;&lt;del&gt;HBASE-12398&lt;/del&gt;&lt;/a&gt; Region isn&apos;t assigned in an extreme race condition (Jeffrey Zhong) (enis: rev a25194a3e4af29cbd356e09e734e83df4299af2f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/RegionStates.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14232650" author="hudson" created="Wed, 3 Dec 2014 06:20:42 +0000"  >&lt;p&gt;SUCCESS: Integrated in HBase-0.98 #711 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98/711/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98/711/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12398&quot; title=&quot;Region isn&amp;#39;t assigned in an extreme race condition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12398&quot;&gt;&lt;del&gt;HBASE-12398&lt;/del&gt;&lt;/a&gt; Region isn&apos;t assigned in an extreme race condition (Jeffrey Zhong) (enis: rev 4c93982fb3380748e2601e4ff81e54c8af532797)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/RegionStates.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14232670" author="hudson" created="Wed, 3 Dec 2014 06:37:28 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-0.98-on-Hadoop-1.1 #678 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/678/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/678/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12398&quot; title=&quot;Region isn&amp;#39;t assigned in an extreme race condition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12398&quot;&gt;&lt;del&gt;HBASE-12398&lt;/del&gt;&lt;/a&gt; Region isn&apos;t assigned in an extreme race condition (Jeffrey Zhong) (enis: rev 4c93982fb3380748e2601e4ff81e54c8af532797)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/RegionStates.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14331650" author="enis" created="Sat, 21 Feb 2015 23:45:38 +0000"  >&lt;p&gt;Closing this issue after 0.99.2 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12678531" name="HBASE-12398.patch" size="1896" author="jeffreyz" created="Fri, 31 Oct 2014 19:16:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 31 Oct 2014 19:24:41 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21tvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>