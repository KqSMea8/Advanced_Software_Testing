<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:24:05 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5027/HBASE-5027.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5027] HConnection.create(final Connection conf) does not clone, it creates a new Configuration reading *.xmls and then does a merge.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5027</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Its more expensive that it should be; its causing TestAdmin to fail after &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4417&quot; title=&quot;HBaseAdmin.checkHBaseAvailable() doesn&amp;#39;t close ZooKeeper connections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4417&quot;&gt;&lt;del&gt;HBASE-4417&lt;/del&gt;&lt;/a&gt;  went in.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12535191">HBASE-5027</key>
            <summary>HConnection.create(final Connection conf) does not clone, it creates a new Configuration reading *.xmls and then does a merge.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkeywal">Nicolas Liochon</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Dec 2011 18:57:57 +0000</created>
                <updated>Fri, 12 Oct 2012 05:35:09 +0000</updated>
                            <resolved>Thu, 15 Dec 2011 17:14:01 +0000</resolved>
                                    <version>0.94.0</version>
                                    <fixVersion>0.94.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13169583" author="stack" created="Wed, 14 Dec 2011 18:58:19 +0000"  >&lt;p&gt;See tail of hbase-4993 for some discussion.&lt;/p&gt;</comment>
                            <comment id="13169587" author="zhihyu@ebaysf.com" created="Wed, 14 Dec 2011 19:06:31 +0000"  >&lt;p&gt;I think cloned Configuration should have the same identity with the original one in terms of ConnectionKey.&lt;/p&gt;</comment>
                            <comment id="13169590" author="nkeywal" created="Wed, 14 Dec 2011 19:11:38 +0000"  >&lt;p&gt;In hbase-5022, I replaced the reload implementation with a simple clone. But the comparison with a full removal of the clone in HBaseAdmin shows that the clone is still an expensive function. I believe it triggers some GC as well.&lt;/p&gt;

&lt;p&gt;TestAdmin fails sometimes even without the clone (may be less often ? I don&apos;t know. But still fails for sure).&lt;/p&gt;</comment>
                            <comment id="13169678" author="stack" created="Wed, 14 Dec 2011 20:47:43 +0000"  >&lt;p&gt;Is it same test that fails each time, this long-running one of 1000 cycles?&lt;/p&gt;</comment>
                            <comment id="13169682" author="nkeywal" created="Wed, 14 Dec 2011 20:55:30 +0000"  >&lt;p&gt;Yes, I executed it alone. On 5 times, it fails 1.&lt;/p&gt;

&lt;p&gt;On Wed, Dec 14, 2011 at 9:49 PM, stack (Commented) (JIRA)&lt;/p&gt;
</comment>
                            <comment id="13169685" author="zhihyu@ebaysf.com" created="Wed, 14 Dec 2011 20:58:40 +0000"  >&lt;p&gt;I think we should reduce the number of iterations for this test to e.g. 200.&lt;/p&gt;</comment>
                            <comment id="13169687" author="stack" created="Wed, 14 Dec 2011 21:00:17 +0000"  >&lt;p&gt;I was thinking to whatever the zk client sessions max is + 1 or doubled.&lt;/p&gt;</comment>
                            <comment id="13169693" author="nkeywal" created="Wed, 14 Dec 2011 21:03:56 +0000"  >&lt;p&gt;It it possible to count the number of connection open? Then we would just have to check that it does not increase after two calls.&lt;/p&gt;

&lt;p&gt;But may be there is a real issue behind this flakiness, even if it&apos;s not what the test is looking for. &lt;/p&gt;</comment>
                            <comment id="13169711" author="stack" created="Wed, 14 Dec 2011 21:26:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;It it possible to count the number of connection open? Then we would just have to check that it does not increase after two calls.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you added this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/src/test/java/org/apache/hadoop/hbase/client/HConnectionTestingUtility.java b/src/test/java/org/apache/hadoop/hbase/client/HConnectionTestingUtility.java
index 17da42d..00f4541 100644
--- a/src/test/java/org/apache/hadoop/hbase/client/HConnectionTestingUtility.java
+++ b/src/test/java/org/apache/hadoop/hbase/client/HConnectionTestingUtility.java
@@ -85,4 +85,13 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class HConnectionTestingUtility {
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; connection;
     }
   }
-}
+
+  /**
+   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Count of extant connection instances
+   */
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getConnectionCount() {
+    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (HConnectionManager.HBASE_INSTANCES) {
+      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; HConnectionManager.HBASE_INSTANCES.size();
+    }
+  }
+}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... you could count connections.  We shouldn&apos;t open access to HCM.HBASE_INSTANCES Map.  Above does it in a way that allows tests count instances.&lt;/p&gt;</comment>
                            <comment id="13169715" author="nkeywal" created="Wed, 14 Dec 2011 21:31:30 +0000"  >&lt;p&gt;Ok, I will do that and change the test then.&lt;/p&gt;

&lt;p&gt;On Wed, Dec 14, 2011 at 10:27 PM, stack (Commented) (JIRA)&lt;/p&gt;
</comment>
                            <comment id="13170165" author="nkeywal" created="Thu, 15 Dec 2011 12:49:40 +0000"  >&lt;p&gt;Patch submitted with the implementation proposed by Stack.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I checked, if we leak a connection, the test fails&lt;/li&gt;
	&lt;li&gt;I removed the clone anyway, it&apos;s more efficient&lt;/li&gt;
	&lt;li&gt;I added a check on connection count in the ResourceChecker&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13170260" author="hadoopqa" created="Thu, 15 Dec 2011 15:02:09 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12507513/5027.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12507513/5027.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated -152 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 75 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;     -1 core tests.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.client.TestInstantSchemaChange&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/513//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/513//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/513//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/513//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/513//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/513//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13170280" author="nkeywal" created="Thu, 15 Dec 2011 15:25:26 +0000"  >&lt;p&gt;&quot;Too many open files&quot;&lt;/p&gt;

&lt;p&gt;We&apos;re using quite a lot of threads here:&lt;br/&gt;
hbase.ResourceChecker(145): after client.TestInstantSchemaChange#testInstantSchemaJanitor: 343 threads (was 117), 863 file descriptors (was 600). 6 connections,  &lt;del&gt;thread leak?&lt;/del&gt;  &lt;del&gt;file handle leak?&lt;/del&gt; &lt;/p&gt;

&lt;p&gt;The patch can be committed imho, but I wonder why we have so many threads &amp;amp; open files.&lt;/p&gt;</comment>
                            <comment id="13170330" author="stack" created="Thu, 15 Dec 2011 16:29:16 +0000"  >&lt;p&gt;First, counting connections addition is excellent.&lt;/p&gt;

&lt;p&gt;Should we add an lsof dump when your checks notice leak?  Could run it in hadoop qa only?&lt;/p&gt;

&lt;p&gt;Is this a regression: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void checkHBaseAvailable(Configuration conf)
   &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MasterNotRunningException, ZooKeeperConnectionException {
-    Configuration copyOfConf = HBaseConfiguration.create(conf);
-    copyOfConf.setInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.client.retries.number&quot;&lt;/span&gt;, 1);
-    HBaseAdmin admin = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HBaseAdmin(copyOfConf);
+    HBaseAdmin admin = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HBaseAdmin(conf);
     &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You&apos;ve dropped the retry once config?&lt;/p&gt;

&lt;p&gt;I like your change to the testCheckHBaseAvailableClosesConnection test.&lt;/p&gt;</comment>
                            <comment id="13170342" author="nkeywal" created="Thu, 15 Dec 2011 16:52:26 +0000"  >&lt;p&gt;Yes, I removed the retry counter because the clone is expensive. It&apos;s true that when HBase is not available it will be slower. Put it back if yoy think it was an error to remove it.&lt;/p&gt;

&lt;p&gt;for lsof: will we have the access rights for this? I can give it a try. But with the few hundreds of open file descriptors, it can be hard to read. As the connection counter comes from HBase, we may get more info from HBase directly I think.&lt;/p&gt;
</comment>
                            <comment id="13170343" author="stack" created="Thu, 15 Dec 2011 16:56:02 +0000"  >&lt;p&gt;You are right on the lsof; we&apos;re running as lowly user, not as root... though I suppose could run it on local machine as root and see?&lt;/p&gt;

&lt;p&gt;Maybe I should make a cheaper clone first over in HBaseConfiguration, commit that, then commit above using the cheaper clone?&lt;/p&gt;</comment>
                            <comment id="13170346" author="stack" created="Thu, 15 Dec 2011 17:00:28 +0000"  >&lt;p&gt;Pardon me, you already made the cheaper clone fix over in hbase-5022.  So, I should just apply this patch minus the change to src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java.... that should remove the regression?&lt;/p&gt;</comment>
                            <comment id="13170347" author="nkeywal" created="Thu, 15 Dec 2011 17:04:30 +0000"  >&lt;p&gt;The cheap clone was already committed by Ted in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5022&quot; title=&quot;Optimize HBaseConfiguration#create&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5022&quot;&gt;&lt;del&gt;HBASE-5022&lt;/del&gt;&lt;/a&gt;. But even with&lt;br/&gt;
this, it&apos;s still expensive. As we now have only one check now instead of&lt;br/&gt;
1000 before, it won&apos;t really impact the test however.&lt;/p&gt;


&lt;p&gt;On Thu, Dec 15, 2011 at 5:56 PM, stack (Commented) (JIRA)&lt;/p&gt;
</comment>
                            <comment id="13170348" author="nkeywal" created="Thu, 15 Dec 2011 17:06:30 +0000"  >&lt;p&gt;Yes, i will work&lt;/p&gt;

&lt;p&gt;On Thu, Dec 15, 2011 at 6:00 PM, stack (Commented) (JIRA)&lt;/p&gt;
</comment>
                            <comment id="13170350" author="nkeywal" created="Thu, 15 Dec 2011 17:09:12 +0000"  >&lt;p&gt;&apos;t&apos; is missing in my last comment =&amp;gt; yes, &quot;just apply this patch minus the change to src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java.... that should remove the regression&quot; will work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13170353" author="stack" created="Thu, 15 Dec 2011 17:14:01 +0000"  >&lt;p&gt;Committed the patch minus TestAdmin change.  Thanks Nicolas.&lt;/p&gt;</comment>
                            <comment id="13170775" author="hudson" created="Fri, 16 Dec 2011 05:02:52 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-security #33 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-security/33/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-security/33/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5027&quot; title=&quot;HConnection.create(final Connection conf) does not clone, it creates a new Configuration reading *.xmls and then does a merge.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5027&quot;&gt;&lt;del&gt;HBASE-5027&lt;/del&gt;&lt;/a&gt; HConnection.create(final Connection conf) does not clone, it creates a new Configuration reading *.xmls and then does a merge.&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/ResourceChecker.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/client/HConnectionTestingUtility.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12507513" name="5027.patch" size="5323" author="nkeywal" created="Thu, 15 Dec 2011 12:46:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 14 Dec 2011 19:06:31 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>220875</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i069yv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34546</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>