<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:28:58 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-12030/HBASE-12030.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-12030] Wrong compaction report and assert when MOB compaction switches to minor</title>
                <link>https://issues.apache.org/jira/browse/HBASE-12030</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;when zookeeper is down during a major compaction or a sweep tool run in progress, we switch to a minor.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  zk = MobZookeeper.newInstance(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.conf, compactionName);
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException e) {
  LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot connect to the zookeeper, ready to perform the minor compaction instead&quot;&lt;/span&gt;, e);
  &lt;span class=&quot;code-comment&quot;&gt;// change the major compaction into a minor one
&lt;/span&gt;  compaction.getRequest().setIsMajor(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.compact(compaction);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but the &quot;request start&quot; (HRegion.reportCompactionRequestStart) is &quot;major&quot; and increments the major-compactions counter&lt;br/&gt;
while the &quot;request end&quot; (HRegion.reportCompactionRequestEnd) is &quot;minor&quot; and decrements the minor-compactions counter&lt;br/&gt;
triggering the assert newValue &amp;gt;= 0, since we are decrementing the wrong counter&lt;/p&gt;</description>
                <environment></environment>
        <key id="12742793">HBASE-12030</key>
            <summary>Wrong compaction report and assert when MOB compaction switches to minor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anoop.hbase">Anoop Sam John</assignee>
                                    <reporter username="mbertozzi">Matteo Bertozzi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Sep 2014 18:22:46 +0000</created>
                <updated>Wed, 22 Jul 2015 22:48:48 +0000</updated>
                            <resolved>Thu, 25 Sep 2014 04:19:34 +0000</resolved>
                                    <version>hbase-11339</version>
                                    <fixVersion>hbase-11339</fixVersion>
                                    <component>Compaction</component>
                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="14142109" author="anoop.hbase" created="Sat, 20 Sep 2014 16:53:55 +0000"  >&lt;p&gt;Thanks for the good catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt;.  I had doubt on this major - minor degradation. Checked other angles bit missed the part of metric. &lt;br/&gt;
Thinking in that angle I am coming up with a patch. Trying to not degrade major to minor.  Just providing way in CompactionRequest to forcefully say that keep delete markers.  If this is set, whatever be the type of compaction, we will keep the delete tomb stones after the compaction.&lt;br/&gt;
patch coming soon&lt;/p&gt;

&lt;p&gt;Also Jingcheng noticed and informed me that there is an issue in HMobStore#compact() where we check whether we need major- minor degrade. We check just CompactionRequest#isMajor().  Actually we should check isAllFiles() because that decided whether to keep the delete markers or not.  I will fix that issue also in this patch&lt;/p&gt;</comment>
                            <comment id="14142956" author="hadoopqa" created="Mon, 22 Sep 2014 06:51:53 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12670237/HBASE-12030.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12670237/HBASE-12030.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12670237&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11011//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11011//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14143563" author="anoop.hbase" created="Mon, 22 Sep 2014 18:19:07 +0000"  >&lt;p&gt;Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmhsieh&quot; class=&quot;user-hover&quot; rel=&quot;jmhsieh&quot;&gt;Jonathan Hsieh&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14145013" author="mbertozzi" created="Tue, 23 Sep 2014 16:51:37 +0000"  >&lt;p&gt;looks ok to me, &lt;br/&gt;
it will be nice having a test to cover the path when zk throws an exception.. maybe the easiest way there is mocking zk?&lt;/p&gt;</comment>
                            <comment id="14146077" author="jingcheng.du@intel.com" created="Wed, 24 Sep 2014 08:48:07 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbertozzi&quot; class=&quot;user-hover&quot; rel=&quot;mbertozzi&quot;&gt;Matteo Bertozzi&lt;/a&gt;.&lt;br/&gt;
The patch contains the unit test is uploaded.&lt;/p&gt;</comment>
                            <comment id="14146082" author="hadoopqa" created="Wed, 24 Sep 2014 08:52:12 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12670931/HBASE-12030-V2.diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12670931/HBASE-12030-V2.diff&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12670931&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11049//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11049//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14146157" author="anoop.hbase" created="Wed, 24 Sep 2014 10:00:45 +0000"  >&lt;p&gt;Thanks a lot Jingcheng for the test.&lt;br/&gt;
2 comments on the test&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; compactionThreshold; i++) {
+      Put p = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Put(Bytes.toBytes(i));
+      p.setDurability(Durability.SKIP_WAL);
+      p.add(COLUMN_FAMILY, Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;colX&quot;&lt;/span&gt;), dummyData);
+      loader.put(p);
+      loader.flushcache();
+    }
+    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Before compaction: store files&quot;&lt;/span&gt;, compactionThreshold,
+        countStoreFiles());
+    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Before compaction: mob file count&quot;&lt;/span&gt;, compactionThreshold,
+        countMobFiles());
+    Delete delete = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Delete(deleteRow);
+    delete.deleteFamily(COLUMN_FAMILY);
+    region.delete(delete);
+    loader.flushcache();
+    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Before compaction: store files&quot;&lt;/span&gt;, compactionThreshold + 1,
+        countStoreFiles());
+    region.compactStores(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
+    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Before compaction: store files&quot;&lt;/span&gt;, 1, countStoreFiles());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We flush compactionThreshold with puts. This itself can trigger an auto compaction (before the delete going in)  So the assert assertEquals(compactionThreshold + 1, countStoreFiles()) can get failed some times. Better we add compactionThreshold -1 times put and one time delete and then go with compaction.&lt;/p&gt;

&lt;p&gt;assertEquals(&quot;Before compaction: store files&quot;, 1, countStoreFiles()); -&amp;gt; The msg to be After compaction&lt;/p&gt;</comment>
                            <comment id="14146161" author="anoop.hbase" created="Wed, 24 Sep 2014 10:08:20 +0000"  >&lt;p&gt;Fixing the comments in tests&lt;/p&gt;</comment>
                            <comment id="14146164" author="hadoopqa" created="Wed, 24 Sep 2014 10:11:54 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12670944/HBASE-12030_V3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12670944/HBASE-12030_V3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;br/&gt;
  ATTACHMENT ID: 12670944&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 patch&lt;/font&gt;.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/11051//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/11051//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14146410" author="ram_krish" created="Wed, 24 Sep 2014 15:15:47 +0000"  >&lt;p&gt;+1 on patch.  Looks good.&lt;/p&gt;</comment>
                            <comment id="14146610" author="jmhsieh" created="Wed, 24 Sep 2014 17:56:11 +0000"  >&lt;p&gt;lgtm +1.&lt;/p&gt;</comment>
                            <comment id="14147348" author="anoop.hbase" created="Thu, 25 Sep 2014 04:19:34 +0000"  >&lt;p&gt;Pushed to hbase-11339 branch.&lt;br/&gt;
Thanks a lot Jingcheng for helping with a nice test.&lt;br/&gt;
Thanks all for the reviews&lt;/p&gt;</comment>
                            <comment id="14637838" author="hudson" created="Wed, 22 Jul 2015 22:48:48 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK #6672 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/6672/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/6672/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12030&quot; title=&quot;Wrong compaction report and assert when MOB compaction switches to minor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12030&quot;&gt;&lt;del&gt;HBASE-12030&lt;/del&gt;&lt;/a&gt; Wrong compaction report and assert when MOB compaction switches to minor. (anoopsamjohn: rev a0d9e18ccf3842395a410a6c966f108ab2f55473)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestMobCompaction.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/CompactionRequest.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/compactions/DefaultCompactor.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HMobStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12670931" name="HBASE-12030-V2.diff" size="13927" author="jingcheng.du@intel.com" created="Wed, 24 Sep 2014 08:48:07 +0000"/>
                            <attachment id="12670237" name="HBASE-12030.patch" size="6884" author="anoop.hbase" created="Sat, 20 Sep 2014 17:33:49 +0000"/>
                            <attachment id="12670944" name="HBASE-12030_V3.patch" size="13723" author="anoop.hbase" created="Wed, 24 Sep 2014 10:08:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 20 Sep 2014 16:53:55 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i209lr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>