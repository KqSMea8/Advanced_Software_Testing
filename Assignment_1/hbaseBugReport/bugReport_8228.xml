<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:53:15 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8228/HBASE-8228.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8228] Investigate time taken to snapshot memstore</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8228</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Snapshotting memstores is normally quick. But, sometimes it seems to take long. This JIRA is to track the investigation and fix to improve the outliers.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12639901">HBASE-8228</key>
            <summary>Investigate time taken to snapshot memstore</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12639900">HBASE-8227</parent>
                                    <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="eclark">Elliott Clark</assignee>
                                    <reporter username="amitanand">Amitanand Aiyer</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Mar 2013 23:37:53 +0000</created>
                <updated>Mon, 6 Apr 2015 19:52:07 +0000</updated>
                            <resolved>Mon, 6 Apr 2015 19:52:07 +0000</resolved>
                                                    <fixVersion>0.89-fb</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13617991" author="v.himanshu" created="Sat, 30 Mar 2013 05:46:36 +0000"  >&lt;p&gt;Interesting. How frequent? Any specific patterns... like while intensive write workload? When do you start its timer? Since taking the updateLock?&lt;/p&gt;</comment>
                            <comment id="13618148" author="amitanand" created="Sat, 30 Mar 2013 20:27:20 +0000"  >&lt;p&gt;Yeah, I start the timer once we grab the write lock for the update lock; until it is released.&lt;/p&gt;

&lt;p&gt;Most of the times the value is 0 ms. But sometimes it is as high as 225 sec.&lt;/p&gt;

&lt;p&gt;Here are some log lines, across various clusters. (removed the machine names part).&lt;/p&gt;

&lt;p&gt;: 2013-03-29 16:17:29,420 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 4679 ms.&lt;br/&gt;
: 2013-03-29 16:17:31,231 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 6481 ms.&lt;br/&gt;
: 2013-03-29 16:17:32,421 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7667 ms.&lt;br/&gt;
: 2013-03-29 16:17:34,640 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 9882 ms.&lt;br/&gt;
: 2013-03-29 16:17:37,864 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 13101 ms.&lt;br/&gt;
: 2013-03-29 16:17:45,824 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 14414 ms.&lt;br/&gt;
: 2013-03-29 16:17:44,076 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 14479 ms.&lt;br/&gt;
: 2013-03-29 16:17:47,361 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 14814 ms.&lt;br/&gt;
: 2013-03-29 16:17:42,829 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 14982 ms.&lt;br/&gt;
: 2013-03-29 16:17:39,923 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 15160 ms.&lt;/p&gt;

&lt;p&gt;: 2013-03-26 01:32:22,441 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7819 ms.&lt;br/&gt;
: 2013-03-26 01:32:24,770 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7873 ms.&lt;br/&gt;
: 2013-03-26 13:42:08,474 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 8470 ms.&lt;br/&gt;
: 2013-03-25 13:30:30,404 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 8565 ms.&lt;br/&gt;
: 2013-03-26 01:32:24,056 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 9422 ms.&lt;br/&gt;
: 2013-03-29 23:39:23,840 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 9824 ms.&lt;br/&gt;
: 2013-03-25 13:30:32,207 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 10368 ms.&lt;br/&gt;
: 2013-03-25 13:30:33,620 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 11781 ms.&lt;br/&gt;
: 2013-03-25 13:30:36,327 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 14488 ms.&lt;br/&gt;
: 2013-03-25 13:30:38,915 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 14719 ms.&lt;/p&gt;

&lt;p&gt;: 2013-03-20 15:16:24,890 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7543 ms.&lt;br/&gt;
: 2013-03-20 15:16:22,730 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7641 ms.&lt;br/&gt;
: 2013-03-27 00:20:06,791 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7748 ms.&lt;br/&gt;
: 2013-03-25 05:06:32,657 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7773 ms.&lt;br/&gt;
: 2013-03-20 15:16:25,790 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7843 ms.&lt;br/&gt;
: 2013-03-27 00:20:05,957 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7972 ms.&lt;br/&gt;
: 2013-03-20 15:16:29,719 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 8518 ms.&lt;br/&gt;
: 2013-03-20 15:16:28,645 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 8707 ms.&lt;br/&gt;
: 2013-03-20 15:16:27,764 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 8965 ms.&lt;br/&gt;
: 2013-03-27 00:20:04,811 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 11526 ms.&lt;/p&gt;

&lt;p&gt;: 2013-03-17 10:32:29,415 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 5043 ms.&lt;br/&gt;
: 2013-03-17 10:32:28,687 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 5487 ms.&lt;br/&gt;
: 2013-03-17 10:32:31,868 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 5497 ms.&lt;br/&gt;
: 2013-03-17 10:32:31,445 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 5598 ms.&lt;br/&gt;
: 2013-03-17 10:32:30,617 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 5635 ms.&lt;br/&gt;
: 2013-03-17 10:32:28,159 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 6355 ms.&lt;br/&gt;
: 2013-03-17 10:32:27,035 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 6391 ms.&lt;br/&gt;
: 2013-03-17 10:32:26,273 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7039 ms.&lt;br/&gt;
: 2013-03-17 10:32:25,747 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 7097 ms.&lt;br/&gt;
: 2013-03-17 10:32:24,851 DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 8349 ms.&lt;/p&gt;

&lt;p&gt;,60020,1364409296334.cacheFlusher.1] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 94859 ms.&lt;br/&gt;
,60020,1364409296754.cacheFlusher.0] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 97814 ms.&lt;br/&gt;
,60020,1364409297006.cacheFlusher.1] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 104621 ms.&lt;br/&gt;
,60020,1364409292493.cacheFlusher.0] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 105046 ms.&lt;br/&gt;
,60020,1364409295677.cacheFlusher.0] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 116958 ms.&lt;br/&gt;
,60020,1364409297314.cacheFlusher.1] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 131425 ms.&lt;br/&gt;
,60020,1364409297449.cacheFlusher.0] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 134293 ms.&lt;br/&gt;
,60020,1364409294933.cacheFlusher.0] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 165076 ms.&lt;br/&gt;
,60020,1364409291262.cacheFlusher.1] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 216242 ms.&lt;br/&gt;
,60020,1364409296374.cacheFlusher.0] DEBUG org.apache.hadoop.hbase.regionserver.HRegion: Finished snapshotting. Held region-wide updates lock for 223500 ms.&lt;/p&gt;</comment>
                            <comment id="13694028" author="amitanand" created="Wed, 26 Jun 2013 15:25:08 +0000"  >&lt;p&gt;Looks like this is caused when we are using multiple memstore-flusher threads; and two flush requests have a log-roll between them.&lt;/p&gt;

&lt;p&gt;to flush a region, we grab the HRegion.updatesLock.writeLock, and then try to grab the HLog.cacheFlushLock.readLock(). Most of the operation that happens within the lock, is done in memory, so this should have been a short duration. ... unless, we are waiting to grab the lock.&lt;/p&gt;

&lt;p&gt;HLog.rollWriter tries to grab the HLog.cacheFlushLock.writeLock(). This means that a Log-roll cannot happen when a flush is already in progress.&lt;/p&gt;

&lt;p&gt;If a second flush were to be initiated, when there is already a flush going on, and there is a log-roll, waiting (for a writer&apos;s lock); then&lt;br/&gt;
the second flush, is able to get the HRegion.updatesLock.writeLock (presumably, for a different region). But, will stall on the HLog.cacheFlushLock.readLock(). This is because the ReaderWriterLock implementation, which uses the NonFairSync() will cause the reader locks to wait on the writer&apos;s request; if the writer is at the head of the queue.&lt;/p&gt;

&lt;p&gt;This interleaving results in the second flush request, holding the HRegion.updatesLock.writeLock() for as long as the first thread took to flush a region + do a log roll.&lt;/p&gt;

&lt;p&gt;Swapping the order of the HRegion.updatesLock.writeLock(), and startCacheFlush should probably fix this issue. Reducing the # of memstore flusher threads to &amp;lt;= 1 can also stop this behavior.&lt;/p&gt;</comment>
                            <comment id="13694064" author="v.himanshu" created="Wed, 26 Jun 2013 16:34:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Swapping the order of the HRegion.updatesLock.writeLock(), and startCacheFlush should probably fix this issue.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So, you don&apos;t lock the region until you get the cacheFlushLock.readLock(). &lt;/p&gt;

&lt;p&gt;In 0.94, cacheFlushLock is still a ReentrantLock. I wonder whether multiple memstore flush threads help there at all (if multiple flushers are there in 0.94).&lt;br/&gt;
In trunk, we no longer write flush events to hlog. Basically, a flush can happen while log rolling is going on.&lt;/p&gt;</comment>
                            <comment id="13694319" author="amitanand" created="Wed, 26 Jun 2013 22:32:34 +0000"  >&lt;p&gt;I think open source is using one memstore flusher.&lt;/p&gt;

&lt;p&gt;Multiple memstore flush threads was added pretty recently. This was part of the efforts to reduce the time it takes to send machines to repairs etc. &lt;/p&gt;</comment>
                            <comment id="14481753" author="eclark" created="Mon, 6 Apr 2015 19:52:07 +0000"  >&lt;p&gt;0.89-fb is no longer being actively maintained. If issues persist open an issue against the current master or stable versions.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 30 Mar 2013 05:46:36 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320370</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j9zj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320711</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>