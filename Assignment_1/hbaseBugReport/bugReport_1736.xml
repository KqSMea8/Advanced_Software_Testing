<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:55:56 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1736/HBASE-1736.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1736] If RS can&apos;t talk to master, pause; more importantly, don&apos;t split (Currently we do and splits are lost and table is wounded)</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1736</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;What I saw was master shutting itself down because it had lost zk lease.  Fine.   The RS though doesn&apos;t look like it can deal with this situation.    We&apos;ll see stuff like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...failed on connection exception: java.net.ConnectException: Connection refused
    at org.apache.hadoop.hbase.ipc.HBaseClient.wrapException(HBaseClient.java:744)
    at org.apache.hadoop.hbase.ipc.HBaseClient.call(HBaseClient.java:722)
    at org.apache.hadoop.hbase.ipc.HBaseRPC$Invoker.invoke(HBaseRPC.java:328)
    at $Proxy0.regionServerReport(Unknown Source)
    at org.apache.hadoop.hbase.regionserver.HRegionServer.run(HRegionServer.java:470)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
Caused by: java.net.ConnectException: Connection refused
    at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)
    at sun.nio.ch.SocketChannelImpl.finishConnect(Unknown Source)
    at org.apache.hadoop.net.SocketIOWithTimeout.connect(SocketIOWithTimeout.java:206)
    at org.apache.hadoop.net.NetUtils.connect(NetUtils.java:404)
    at org.apache.hadoop.hbase.ipc.HBaseClient$Connection.setupIOstreams(HBaseClient.java:305)
    at org.apache.hadoop.hbase.ipc.HBaseClient.getConnection(HBaseClient.java:826)
    at org.apache.hadoop.hbase.ipc.HBaseClient.call(HBaseClient.java:707)
    ... 4 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... all over the regionserver as it tries to send heartbeat to master on this broken connection.&lt;/p&gt;

&lt;p&gt;On split, we close parent, add children to the catalog but then when we try to tell the master about the split, it fails.  Means the children never get deployed.  Meantime  the parent is offline.&lt;/p&gt;

&lt;p&gt;This issue is about going through the regionserver and anytime it has a connection to master, make sure on fault that no damage is done the table and then that the regionserver puts a pause on splitting.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12432014">HBASE-1736</key>
            <summary>If RS can&apos;t talk to master, pause; more importantly, don&apos;t split (Currently we do and splits are lost and table is wounded)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="6">Invalid</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Aug 2009 00:06:37 +0000</created>
                <updated>Wed, 16 Jul 2014 18:52:41 +0000</updated>
                            <resolved>Wed, 16 Jul 2014 18:52:40 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12738156" author="stack" created="Mon, 3 Aug 2009 00:12:53 +0000"  >&lt;p&gt;Looking at logs and aftermath, on master restart, the meta doesn&apos;t have entries for the split daughters, just the parent.&lt;/p&gt;</comment>
                            <comment id="12738157" author="jimk" created="Mon, 3 Aug 2009 00:25:33 +0000"  >&lt;p&gt;Heartbeat and communication between Master and HRS in 0.21 should be greatly reduced, with region assignment happening via ZK, so this should be somewhat less of an issue at that time. However, I&lt;br/&gt;
agree that the HRS can continue so long as it does not need to split.&lt;/p&gt;

&lt;p&gt;The problem is, what do we do when we reach that point?&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Put the cluster into &quot;real-safe-mode&quot; where no requests are accepted from clients?&lt;/li&gt;
	&lt;li&gt;Make the cluster read-only?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Both of the above would exit that mode when a new master is available.&lt;/p&gt;

&lt;p&gt;If we do region assignment more at the HRS level and use the master for just scanning for unassigned&lt;br/&gt;
regions so it can put them into a pool, the master becomes much less significant. The HRS could update the .META. and place the split children into the unassigned pool.&lt;/p&gt;</comment>
                            <comment id="12738162" author="stack" created="Mon, 3 Aug 2009 00:45:39 +0000"  >&lt;p&gt;So, I notice that RS has a watcher on master.  We got this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2009-08-01 19:29:38,018 [main-EventThread] INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Got ZooKeeper event, state: SyncConnected, type: NodeDeleted, path: /hbase/master
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;.. but all we do is reset the watcher:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (type == EventType.NodeDeleted) {
      watchMasterAddress();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should set a flag that stops splitting &amp;#8211; take out the CompactSplitThread#lock &amp;#8211; until we get NodeCreated (NodeCreated does getMaster() ... could release lock too...).  Holding lock would hold up the CompactSplitThead... it does compactions too... probably not whats wanted.&lt;/p&gt;</comment>
                            <comment id="12738163" author="jdcryans" created="Mon, 3 Aug 2009 00:54:30 +0000"  >&lt;p&gt;I think we should assume that a Master failure is promptly resolved so holding back compactions isn&apos;t that bad. So +1 on latest solution.&lt;/p&gt;

&lt;p&gt;If not, compactions won&apos;t be our only problem.&lt;/p&gt;</comment>
                            <comment id="12738448" author="stack" created="Mon, 3 Aug 2009 17:40:46 +0000"  >&lt;p&gt;I&apos;m thinking of making it so compactions go on but not splits... minimize the functionality turned-off when no master.  Let me work up a patch... see what you think.&lt;/p&gt;</comment>
                            <comment id="12738451" author="stack" created="Mon, 3 Aug 2009 17:41:39 +0000"  >&lt;p&gt;Making critical since we lose a region.  Will do for 0.20.1.&lt;/p&gt;</comment>
                            <comment id="12754629" author="stack" created="Sat, 12 Sep 2009 22:50:05 +0000"  >&lt;p&gt;Before sending split message, should check can or if fail, park the message somewhere where it can be picked up when master comes back.  Added as part of &apos;master rewrite&apos;.&lt;/p&gt;</comment>
                            <comment id="12845520" author="aravind.menon" created="Mon, 15 Mar 2010 20:49:30 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I am looking into this issue with Kannan and Karthik. I was wondering if this was still an issue. As I see it, the workflow should be as follows:&lt;/p&gt;

&lt;p&gt;1. On a split, the RS closes the parent and adds the children to the META table. (It should add the children to the META before closing the parent, so that children are not lost if RS crashes after closing parent).&lt;br/&gt;
2. RS tries to contact master but fails because master has lost ZK lease.&lt;br/&gt;
3. On a master restart, it finds the children in the META table, and assigns them to an appropriate RS, so children are not lost.&lt;/p&gt;

&lt;p&gt;As per this flow, the children should never be lost, so this issue should not arise. &lt;/p&gt;

&lt;p&gt;Would appreciate your feedback on this issue.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Aravind&lt;/p&gt;</comment>
                            <comment id="12846074" author="stack" created="Tue, 16 Mar 2010 19:04:07 +0000"  >&lt;p&gt;This issue is not as bad as it was.  We made a change so that if the RS fails to deliver message to master, it&apos;ll retry rather than drop the message on the ground as it used to.&lt;/p&gt;

&lt;p&gt;There is also the notion that loss of a split, while a pain, is not the end of the world.  We can redo it if we have to.  There is some comment in the code in CompactSplitThread#split where try to reason what happens to split if crash at various points along the split.  They could do with review I&apos;d say (smile).&lt;/p&gt;

&lt;p&gt;On &quot;It should add the children to the META before closing the parent, so that children are not lost if RS crashes after closing parent&quot;, what are you thinking?  The parent would still be online when we add in the daughter regions &amp;#8211; pre-close?  We&apos;d have to deal then with clients coming in and finding the daughter regions instead of the parent in .META.  (See how HRegion#getClosestRowBefore works and then how its used in HCM#locateRegionInMeta).  We might have to add in some code to not hand out daughter regions that don&apos;t have an info:server (They won&apos;t have an info:server value in .META. if they have not deployed) but this will still be unsatisfactory since most of the time it&apos;ll just end up with an offlined parent.&lt;/p&gt;

&lt;p&gt;A related, big issue in here is currently closing the parent can take some time during which attempts at reaching the parent region are rejected with NotServingRegionException.  Parents can take a while to close because flush of memory content happens while the &apos;closing&apos; flag is set on the region.  Its as though we need to flush before we go into the close taking on writes while we do so and then only flush the small amount we accumulated during the flush while under the &apos;closing&apos; flag (This is still unsatisfactory because if loaded system and flushes are slow, memory might be filled by the time flush completes and again we&apos;ll have a slow close because we&apos;re flushing lots of memory).  There is a &apos;make splits faster&apos; issue already.  I&apos;m just calling attention to it here since it a little related.&lt;/p&gt;

</comment>
                            <comment id="12848990" author="aravind.menon" created="Wed, 24 Mar 2010 01:00:02 +0000"  >&lt;p&gt;Hi, &lt;/p&gt;

&lt;p&gt;Thanks for that explanation. I had a wrong picture in mind about how daughter regions are added to the META table. So as I understand, this issue is pretty much &lt;br/&gt;
closed correctness wise. &lt;/p&gt;

&lt;p&gt;Regards, &lt;br/&gt;
Aravind&lt;/p&gt;</comment>
                            <comment id="12849064" author="stack" created="Wed, 24 Mar 2010 05:49:07 +0000"  >&lt;p&gt;Ok Aravind.  Thanks for taking a look.&lt;/p&gt;

&lt;p&gt;I&apos;ll leave this issue open until we do what subject line says.  If no master, RS should have its watcher called.  Until a new master shows up, we just shouldn&apos;t split... its better to let the regionsize just grow.&lt;/p&gt;</comment>
                            <comment id="12930297" author="stack" created="Tue, 9 Nov 2010 21:40:01 +0000"  >&lt;p&gt;Moving out of 0.90.0.  If master is gone when we go to split, we&apos;ll just keep trying to send the split message.   For ever.  If new splits meantime, should get added to messages to pass the master (TODO: verify).  When new master comes up, he&apos;ll get the split message and update internal state.  New master will have visited zk and .META. to establish internal state as part of joining cluster.  The messages should align with what master found in .META. and zk.&lt;/p&gt;

&lt;p&gt;All above is speculation.  Needs a test but  doesn&apos;t need to happen for 0.90.0RC.&lt;/p&gt;</comment>
                            <comment id="14063900" author="stack" created="Wed, 16 Jul 2014 18:52:41 +0000"  >&lt;p&gt;All is different now, 5 years later.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12434794">HBASE-1816</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 3 Aug 2009 00:25:33 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25947</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 22 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02cuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11684</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>