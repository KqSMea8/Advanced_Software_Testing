<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:08:32 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3235/HBASE-3235.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3235] Intermittent incrementColumnValue failure in TestHRegion</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3235</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;I first saw this in a Hudson build, but can reproduce locally with enough test runs (5-10 times):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-------------------------------------------------------------------------------
Test set: org.apache.hadoop.hbase.regionserver.TestHRegion
-------------------------------------------------------------------------------
Tests run: 51, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 39.413 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
testIncrementColumnValue_UpdatingInPlace(org.apache.hadoop.hbase.regionserver.TestHRegion)  Time elapsed: 0.079 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
junit.framework.AssertionFailedError: expected:&amp;lt;1&amp;gt; but was:&amp;lt;2&amp;gt;
        at junit.framework.Assert.fail(Assert.java:47)
        at junit.framework.Assert.failNotEquals(Assert.java:283)
        at junit.framework.Assert.assertEquals(Assert.java:64)
        at junit.framework.Assert.assertEquals(Assert.java:195)
        at junit.framework.Assert.assertEquals(Assert.java:201)
        at org.apache.hadoop.hbase.regionserver.TestHRegion.testIncrementColumnValue_UpdatingInPlace(TestHRegion.java:1889)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Alternately, the failure can also show up in testIncrementColumnValue_UpdatingInPlace_Negative():&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;testIncrementColumnValue_UpdatingInPlace_Negative(org.apache.hadoop.hbase.regionserver.TestHRegion)  Time elapsed: 0.03 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
junit.framework.AssertionFailedError: expected:&amp;lt;2&amp;gt; but was:&amp;lt;3&amp;gt;
        at junit.framework.Assert.fail(Assert.java:47)
        at junit.framework.Assert.failNotEquals(Assert.java:283)
        at junit.framework.Assert.assertEquals(Assert.java:64)
        at junit.framework.Assert.assertEquals(Assert.java:130)
        at junit.framework.Assert.assertEquals(Assert.java:136)
        at
org.apache.hadoop.hbase.regionserver.TestHRegion.assertICV(TestHRegion.java:2081)
        at
org.apache.hadoop.hbase.regionserver.TestHRegion.testIncrementColumnValue_UpdatingInPlace_Negative(TestHRegion.java:1990)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12479902">HBASE-3235</key>
            <summary>Intermittent incrementColumnValue failure in TestHRegion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ghelmling">Gary Helmling</assignee>
                                    <reporter username="ghelmling">Gary Helmling</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Nov 2010 08:30:26 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:32 +0000</updated>
                            <resolved>Tue, 16 Nov 2010 21:23:34 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12932265" author="ghelmling" created="Mon, 15 Nov 2010 23:52:38 +0000"  >&lt;p&gt;Some further info on this.  I added logging of the contents of store.memstore.kvset when kvset.size() &amp;gt; 1 in testIncrementColumnValue_UpdatingInPlace(), like so:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; value = 1L;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; amount = 3L;

    Put put = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Put(row);
    put.add(fam1, qual1, Bytes.toBytes(value));
    region.put(put);

    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; result = region.incrementColumnValue(row, fam1, qual1, amount, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

    assertEquals(value+amount, result);

    Store store = region.getStore(fam1);
    &lt;span class=&quot;code-comment&quot;&gt;// ICV removes any extra values floating around in there.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (store.memstore.kvset.size() &amp;gt; 1) {
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (KeyValue kv : store.memstore.kvset) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;memstore.kvset: row=&quot;&lt;/span&gt;+Bytes.toString(kv.getRow()) +
            &lt;span class=&quot;code-quote&quot;&gt;&quot; fam=&quot;&lt;/span&gt;+Bytes.toString(kv.getFamily())+&lt;span class=&quot;code-quote&quot;&gt;&quot; col=&quot;&lt;/span&gt;+Bytes.toString(kv.getQualifier())+
            &lt;span class=&quot;code-quote&quot;&gt;&quot; val=&quot;&lt;/span&gt;+Bytes.toLong(kv.getValue())+&lt;span class=&quot;code-quote&quot;&gt;&quot; ts=&quot;&lt;/span&gt;+kv.getTimestamp()+&lt;span class=&quot;code-quote&quot;&gt;&quot; memstore_ts=&quot;&lt;/span&gt;+kv.getMemstoreTS());
      }
    }
    assertEquals(1, store.memstore.kvset.size());
    assertTrue(store.memstore.snapshot.isEmpty());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With this in place, I get the following output for the failure case:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-11-15 15:36:24,242 DEBUG [main] regionserver.TestHRegion(1891): memstore.kvset: row=rowA fam=colfamily1 col=qual1 val=1 ts=1289864184241 memstore_ts=1
2010-11-15 15:36:24,242 DEBUG [main] regionserver.TestHRegion(1891): memstore.kvset: row=rowA fam=colfamily1 col=qual1 val=4 ts=1289864184241 memstore_ts=0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it seems like it&apos;s only happening when the timestamps for the initial put and the ICV are identical.  In this case, the put gets memstoreTS=1 (from RWCC.getWriteNumber()), but the ICV memstoreTS=0 in MemStore.upsert(List).&lt;/p&gt;

&lt;p&gt;So, in MemStore.upsert(KeyValue), when we call kvset.tailSet(kv), we&apos;re missing the initial put, because KeyValue.KV_COMPARATOR is evaluating it as less than the ICV put, by inverting the memstoreTS comparison.&lt;/p&gt;

&lt;p&gt;Given that that&apos;s the cause, what is the correct fix?  Should the ICV put get using RWCC.getWriteNumber() as well?  Or should we be obtaining the tailset without regards to the memstoreTS?&lt;/p&gt;</comment>
                            <comment id="12932357" author="hbasereviewboard" created="Tue, 16 Nov 2010 07:11:15 +0000"  >&lt;p&gt;Message from: &quot;Gary Helmling&quot; &amp;lt;ghelmling@gmail.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1224/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1224/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase and Ryan Rawson.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Fix for MemStore.upsert(KeyValue) to start the kvset.tailSet() of potential KVs to remove at the beginning of entries for the row/family/qualifier combination, ignoring timestamp to prevent Puts being skipped based on timestamp alone and masking the ICV.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3235&quot; title=&quot;Intermittent incrementColumnValue failure in TestHRegion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3235&quot;&gt;&lt;del&gt;HBASE-3235&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3235&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3235&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/regionserver/MemStore.java b7409b0 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java 7640997 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1224/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1224/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Added a new test: TestHRegion.testIncrementColumnValue_UpdatingInPlace_TimestampClobber() to recreate the existing failure condition: 1) put to a row/family/qualifier, 2) ICV to the same row/family/qualifier with the same timestamp.  This test fails consistently without the patch to MemStore.&lt;/p&gt;

&lt;p&gt;With the patch to MemStore, the new test case consistently passes.  I also ran TestHRegion 15+ times and saw no more intermittent failures of testIncrementColumnValue_UpdatingInPlace().  Previously this was failing every 5 or so test runs, so this seems a pretty good indication it&apos;s fixed.&lt;/p&gt;

&lt;p&gt;I also ran through the full test suite on 0.90 and all passed except for an error in TestHLog...&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;

</comment>
                            <comment id="12932385" author="hbasereviewboard" created="Tue, 16 Nov 2010 08:47:15 +0000"  >&lt;p&gt;Message from: &quot;Andrew Purtell&quot; &amp;lt;apurtell@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1224/#review1937&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1224/#review1937&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;I believe the TestHLog failure noted was on our Hudson. If so it is unrelated to this change. &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Andrew&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12932538" author="ghelmling" created="Tue, 16 Nov 2010 17:07:16 +0000"  >&lt;p&gt;Bumping up as a blocker and marking for 0.90.0 since it represents possible data loss.&lt;/p&gt;</comment>
                            <comment id="12932658" author="ryanobjc" created="Tue, 16 Nov 2010 21:23:34 +0000"  >&lt;p&gt;committed to branch and trunk, thanks for the work Gary!&lt;/p&gt;</comment>
                            <comment id="15016737" author="lars_francke" created="Fri, 20 Nov 2015 12:40:32 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 16 Nov 2010 07:11:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26729</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hlcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100721</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>