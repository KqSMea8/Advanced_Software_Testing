<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:06:55 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3048/HBASE-3048.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3048] unify code for major/minor compactions</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3048</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Today minor compactions do not process deletes, purge old versions, etc. Only major compactions do.  The rationale was probably to save CPU &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. We should evaluate if major compaction logic indeed runs significantly slower.&lt;/p&gt;

&lt;p&gt;Unifying minor compactions to do the same thing as major compactions has other advantages:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If the same keys are deleted/updated repeatedly, the fact that deletes/overwrites are not processed during minor compaction makes each subsequent minor compaction more expensive as the total amount of data keeps growing.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;We&apos;ll have fewer bugs if the logic is as symmetric as possible. Any bugs in TTL enforcement, version enforcement, etc. could cause behavior to be different after a major compaction. Keeping the same logic means these bugs will get caught earlier.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-&lt;/p&gt;

&lt;p&gt;Note: There will still need to be one difference in the two schemes, and that has to do with delete markers. Any compaction which doesn&apos;t compact all files will still need to leave delete markers.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12475367">HBASE-3048</key>
            <summary>unify code for major/minor compactions</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amitanand">Amitanand Aiyer</assignee>
                                    <reporter username="kannanm">Kannan Muthukkaruppan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Sep 2010 00:19:26 +0000</created>
                <updated>Fri, 20 Nov 2015 12:41:18 +0000</updated>
                            <resolved>Mon, 8 Nov 2010 16:20:25 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="12916006" author="stack" created="Wed, 29 Sep 2010 03:51:49 +0000"  >&lt;p&gt;This is fine by me.  The one objection I was going to raise was the delete markers story but you got that in your footnote.&lt;/p&gt;</comment>
                            <comment id="12917300" author="pranavkhaitan" created="Sun, 3 Oct 2010 09:28:24 +0000"  >&lt;p&gt;This can be done using the following simple change:&lt;br/&gt;
Currently, MajorCompaction uses StoreScanner while MinorCompaction uses MinorCompactionStoreScanner which does a subset of things done by StoreScanner. We now want MinorCompaction to do most of the things being done by StoreScanner. Therefore, I would suggest making a flag in the StoreScanner which says if deletes should be processed or not. This flag will be ON by default and will only be set to OFF during a minor compaction. The only alternative to this idea would result in duplicating code which doesn&apos;t seem like a good idea.&lt;/p&gt;</comment>
                            <comment id="12917359" author="kannanm" created="Sun, 3 Oct 2010 16:25:36 +0000"  >&lt;p&gt;Hi Pranav! yes, the flag approach should work well. The intention is to unify not only the processing details but the code/logic too. &lt;/p&gt;</comment>
                            <comment id="12926150" author="amitanand" created="Fri, 29 Oct 2010 02:13:58 +0000"  >&lt;p&gt;Hey Guys,&lt;br/&gt;
  Here is an initial diff with the changes to implement the unification. Would like to add in some more changes to the TestCompaction code to make it more exhaustive.&lt;/p&gt;

&lt;p&gt;  If you have any comments/suggestions that would be great!&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Amit&lt;/p&gt;</comment>
                            <comment id="12926163" author="stack" created="Fri, 29 Oct 2010 04:10:53 +0000"  >&lt;p&gt;@Amit Did you attach a patch?  I don&apos;t see it.  Thanks.&lt;/p&gt;</comment>
                            <comment id="12926165" author="amitanand" created="Fri, 29 Oct 2010 04:20:06 +0000"  >&lt;p&gt;Hi Stack, can you try again. I&apos;ve uploaded it again now.&lt;/p&gt;</comment>
                            <comment id="12926169" author="stack" created="Fri, 29 Oct 2010 04:32:19 +0000"  >&lt;p&gt;Ohh, radical.&lt;/p&gt;

&lt;p&gt;All tests pass?&lt;/p&gt;

&lt;p&gt;Patch looks good to me.   I like the unit tests that assert stuff works as it used to (Thats what you are doing as I read this, right?)&lt;/p&gt;

&lt;p&gt;Good stuff Amit. &lt;/p&gt;</comment>
                            <comment id="12926330" author="kannanm" created="Fri, 29 Oct 2010 16:13:19 +0000"  >&lt;p&gt;Amit,&lt;/p&gt;

&lt;p&gt;This overload of StoreScanner which takes a set of columns:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  StoreScanner(Store store, Scan scan, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; NavigableSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; columns,
                              &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; includeDeletes) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;doesn&apos;t seem to be ever called with anything other than &quot;false&quot;. So, perhaps no need to introduce this.&lt;/p&gt;

&lt;p&gt;You can instead have the old method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  StoreScanner(Store store, Scan scan, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; NavigableSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; columns) 
                              &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;simply call ScanQueryMatcher with &quot;false&quot; for includeDeletes.&lt;/p&gt;

</comment>
                            <comment id="12926508" author="ryanobjc" created="Sat, 30 Oct 2010 00:04:40 +0000"  >&lt;p&gt;The code is using an additional flag to the StoreScanner constructor, perhaps we should use the InternalScan infrastructure added by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3082&quot; title=&quot;For ICV gets, first look in MemStore before reading StoreFiles&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3082&quot;&gt;&lt;del&gt;HBASE-3082&lt;/del&gt;&lt;/a&gt; to keep this as clean as possible?  That seems to be the primary criticism of this patch I think.  The rest looks good, perhaps instead of &quot;includeDeletes&quot; it should be called &quot;keepDeletesInOutput&quot; or something really descriptive like that?  Write one read many and all that.&lt;/p&gt;</comment>
                            <comment id="12928789" author="streamy" created="Fri, 5 Nov 2010 19:44:03 +0000"  >&lt;p&gt;This is a rebased patch for trunk.  We committed this to our internal 0.89-based repo.&lt;/p&gt;</comment>
                            <comment id="12929168" author="hbasereviewboard" created="Sat, 6 Nov 2010 19:32:27 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1185/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1185/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase, stack, Kannan Muthukkaruppan, and Ryan Rawson.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is a rebased patch from Amit.  This was internally reviewed but we may want some minor modifications for 0.90 with the new InternalScanner, if possible.  (suggestion from ryan on jira)&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3048&quot; title=&quot;unify code for major/minor compactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3048&quot;&gt;&lt;del&gt;HBASE-3048&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3048&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3048&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/MinorCompactingStoreScanner.java 1031745 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/ScanQueryMatcher.java 1031745 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 1031745 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java 1031745 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java 1031745 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestMinorCompactingStoreScanner.java 1031745 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1185/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1185/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Lot&apos;s of good new additions by Amit to TestCompaction which passes.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12929261" author="hbasereviewboard" created="Sat, 6 Nov 2010 22:52:01 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1185/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1185/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-11-06 15:50:30.615330)&lt;/p&gt;


&lt;p&gt;Review request for hbase, stack, Kannan Muthukkaruppan, and Ryan Rawson.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Minor cleanup of whitespace and stuff.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is a rebased patch from Amit.  This was internally reviewed but we may want some minor modifications for 0.90 with the new InternalScanner, if possible.  (suggestion from ryan on jira)&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3048&quot; title=&quot;unify code for major/minor compactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3048&quot;&gt;&lt;del&gt;HBASE-3048&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-3048&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-3048&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/MinorCompactingStoreScanner.java 1032175 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/ScanQueryMatcher.java 1032175 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 1032175 &lt;br/&gt;
  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java 1032175 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java 1032175 &lt;br/&gt;
  trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestMinorCompactingStoreScanner.java 1032175 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1185/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1185/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Lot&apos;s of good new additions by Amit to TestCompaction which passes.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;

</comment>
                            <comment id="12929263" author="hbasereviewboard" created="Sat, 6 Nov 2010 22:56:08 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1185/#review1835&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1185/#review1835&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Looking at this now, it&apos;s at completely different level than the new InternalScan we have.  That deals with scanner selection, this deals with an option in the QueryMatcher.  There are already a bunch of options in SQM so we could consolidate at some point, but it&apos;s only a single level so doesn&apos;t seem so bad.&lt;/p&gt;

&lt;p&gt;I&apos;m +1 on it (it&apos;s not my patch) but want to get someone else to review.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12929315" author="kannanm" created="Sun, 7 Nov 2010 06:59:54 +0000"  >&lt;p&gt;+1 on patch. Looks good to me.&lt;/p&gt;</comment>
                            <comment id="12929449" author="hbasereviewboard" created="Mon, 8 Nov 2010 04:55:53 +0000"  >&lt;p&gt;Message from: &quot;Ryan Rawson&quot; &amp;lt;ryanobjc@gmail.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1185/#review1837&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1185/#review1837&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;ok lets go with this&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ryan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12929609" author="streamy" created="Mon, 8 Nov 2010 16:16:09 +0000"  >&lt;p&gt;v3 patch is final one for commit.&lt;/p&gt;</comment>
                            <comment id="12929614" author="streamy" created="Mon, 8 Nov 2010 16:20:24 +0000"  >&lt;p&gt;Committed to trunk.  Thanks for the great work Amit.  Thanks for reviews from Ryan and Kannan.&lt;/p&gt;</comment>
                            <comment id="12930279" author="kannanm" created="Tue, 9 Nov 2010 20:33:50 +0000"  >&lt;p&gt;Prakash reported that he was seeing really good benefit of this optimization for his &quot;incr&quot; use case (which essentially rewrites the same keys over and over again). So doing delete processing in minor compactions reduce the working set nicely, and also improves block cache efficiencies and so on.&lt;/p&gt;
</comment>
                            <comment id="12930339" author="stack" created="Tue, 9 Nov 2010 22:59:27 +0000"  >&lt;p&gt;@Kannan Thanks for reporting back.&lt;/p&gt;</comment>
                            <comment id="15016940" author="lars_francke" created="Fri, 20 Nov 2015 12:41:18 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12458947" name="HBASE-3048-0.90-v2.patch" size="32123" author="streamy" created="Fri, 5 Nov 2010 19:44:03 +0000"/>
                            <attachment id="12459063" name="HBASE-3048-v3.patch" size="32937" author="streamy" created="Mon, 8 Nov 2010 16:16:09 +0000"/>
                            <attachment id="12458307" name="unify.patch" size="19072" author="amitanand" created="Fri, 29 Oct 2010 04:17:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 29 Sep 2010 03:51:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32884</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hkhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100582</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>minor compactions now enforce ttl, maxversions, deletes, etc... but will let through the delete markers themselves</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>