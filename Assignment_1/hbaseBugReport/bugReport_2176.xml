<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:59:34 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2176/HBASE-2176.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2176] HRegionInfo reported empty on regions in meta, leading to them being deleted, although the regions contain data and exist</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2176</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We ran some tests on our cluster, and getting back reports about WrongRegionException, on some rows. After looking at the data, we see that we have &quot;gaps&quot; between regions, like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;demo__users,user_8949795897,1264089193398  l2:60030  736660864  user_8949795897  user_8950697145 &amp;lt;- end key
demo__users,user_8953502603,1263992844343  l5:60030  593335873  user_8953502603 &amp;lt;- should be star key here   user_8956071605
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Fact: we had 28 regions that were reported with empty HRegionInfo, and deleted from .META.. &lt;/p&gt;

&lt;p&gt;Fact: we recovered our data entirely, without any issues, by running the .META. restore script from table contents (bin/add_table.rb)&lt;/p&gt;

&lt;p&gt;Fact: on our regionservers, we have three days with no logs. To the best of our knowledge, the machines were not rebooted, the processes were running. During these three days, on the master, the only entry in the logs (repeated), every second, is a .META. scan:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-01-23 00:01:27,816 INFO org.apache.hadoop.hbase.master.BaseScanner: RegionManager.rootScanner scan of 1 row(s) of meta region {server: 10.72.135.7:60020, regionname: -ROOT-,,0, startKey: &amp;lt;&amp;gt;} complete
2010-01-23 00:01:34,413 INFO org.apache.hadoop.hbase.master.ServerManager: 6 region servers, 0 dead, average load 1113.6666666666667
2010-01-23 00:02:23,645 INFO org.apache.hadoop.hbase.master.BaseScanner: RegionManager.metaScanner scanning meta region {server: 10.72.135.10:60020, regionname: .META.,,1, startKey: &amp;lt;&amp;gt;}
2010-01-23 00:02:26,002 INFO org.apache.hadoop.hbase.master.BaseScanner: RegionManager.metaScanner scan of 6679 row(s) of meta region {server: 10.72.135.10:60020, regionname: .META.,,1, startKey: &amp;lt;&amp;gt;} complete
2010-01-23 00:02:26,002 INFO org.apache.hadoop.hbase.master.BaseScanner: All 1 .META. region(s) scanned
2010-01-23 00:02:27,821 INFO org.apache.hadoop.hbase.master.BaseScanner: RegionManager.rootScanner scanning meta region {server: 10.72.135.7:60020, regionname: -ROOT-,,0, startKey: &amp;lt;&amp;gt;}
.......................................................
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the master logs, we see a pretty normal evolution: region r0 is split into r1 and r2. Now, r1 exists and is good, r2 does not exist in .META. anymore, because it was reported as having empty HRegionInfo. The only thing in the master logs that is weird is that the message about updating the region in meta comes up twice:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-01-27 22:46:45,007 INFO org.apache.hadoop.hbase.master.RegionServerOperation: demo__users,user_8950697145,1264089193398 open on 10.72.135.7:60020
2010-01-27 22:46:45,010 INFO org.apache.hadoop.hbase.master.RegionServerOperation: Updated row demo__users,user_8950697145,1264089193398 in region .META.,,1 with startcode=1264661019484, server=10.72.135.7:60020
2010-01-27 22:46:45,010 INFO org.apache.hadoop.hbase.master.RegionServerOperation: demo__users,user_8950697145,1264089193398 open on 10.72.135.7:60020
2010-01-27 22:46:45,012 INFO org.apache.hadoop.hbase.master.RegionServerOperation: Updated row demo__users,user_8950697145,1264089193398 in region .META.,,1 with startcode=1264661019484, server=10.72.135.7:60020
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Attached you will find the entire forensics work, with explanations, in a text file. &lt;/p&gt;

&lt;p&gt;Suppositions:&lt;/p&gt;

&lt;p&gt;Our entire cluster was in a really weird state. All the regionservers are missing logs for three days, and to the best of our knowledge they were running, and in this time the master has ONLY .META. scan messages, every second, reporting 6 regionservers live, out of 7 total. &lt;/p&gt;

&lt;p&gt;Also, during this time, we get filesystem closed messages on a regionservers with one of the missing regions. This is after the gap in the logs. &lt;/p&gt;

&lt;p&gt;How we suppose the data in .META. was lost&lt;/p&gt;

&lt;p&gt;1. Race conditions in ServerManager / RegionManager. In our logs, we have about 3 or 4 CME, in these classes (see the attached file)&lt;br/&gt;
2. Data loss in HDFS. On a regionserver, we get filesystem closed messages&lt;br/&gt;
3. Data could not be read fro HDFS ( highly unlikely, there are no weird data read messages)&lt;br/&gt;
4. Race condition leading to loss of the HRegionInfo from memory, and then persisted as empty. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12447050">HBASE-2176</key>
            <summary>HRegionInfo reported empty on regions in meta, leading to them being deleted, although the regions contain data and exist</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="adragomir">Andrei Dragomir</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Jan 2010 20:32:22 +0000</created>
                <updated>Wed, 16 Jul 2014 18:59:03 +0000</updated>
                            <resolved>Wed, 16 Jul 2014 18:59:03 +0000</resolved>
                                    <version>0.90.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12806488" author="adragomir" created="Fri, 29 Jan 2010 20:33:34 +0000"  >&lt;p&gt;Log forensics on our cluster. &lt;/p&gt;</comment>
                            <comment id="12806648" author="clehene" created="Sat, 30 Jan 2010 09:44:26 +0000"  >&lt;p&gt;the double .META. update log bothers me. Looking through the logs, there are a only double log entries for a while, then they start to mingle with single entries and then we get only single entries. Looking into code it seems logs are from ProcessRegionOpen. This is called from HMaster.processToDoQueue() from either toDoQueue or delatedToDoQueue. The actual deletion takes place when doing a maintenanceScan on .META. followed by empty regionInfo data and deletion.  &lt;/p&gt;</comment>
                            <comment id="14063921" author="stack" created="Wed, 16 Jul 2014 18:59:03 +0000"  >&lt;p&gt;stale&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12431812" name="799255.txt" size="24965" author="adragomir" created="Fri, 29 Jan 2010 20:33:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 30 Jan 2010 09:44:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26190</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 22 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02cxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11695</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>