<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:24:28 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5071/HBASE-5071.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5071] HFile has a possible cast issue.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5071</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3040&quot; title=&quot;BlockIndex readIndex too slowly in heavy write scenario&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3040&quot;&gt;&lt;del&gt;HBASE-3040&lt;/del&gt;&lt;/a&gt; introduced this line originally in HFile.Reader#loadFileInfo(...):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; allIndexSize = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fileSize - &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.trailer.dataIndexOffset - FixedFileTrailer.trailerSize());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which on trunk today, for HFile v1 is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; sizeToLoadOnOpen = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (fileSize - trailer.getLoadOnOpenDataOffset() -
        trailer.getTrailerSize());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This computed (and casted) integer is then used to build an array of the same size. But if fileSize is very large (&amp;gt;&amp;gt; Integer.MAX_VALUE), then there&apos;s an easy chance this can go negative at some point and spew out exceptions such as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NegativeArraySizeException 
at org.apache.hadoop.hbase.io.hfile.HFile$Reader.readAllIndex(HFile.java:805) 
at org.apache.hadoop.hbase.io.hfile.HFile$Reader.loadFileInfo(HFile.java:832) 
at org.apache.hadoop.hbase.regionserver.StoreFile$Reader.loadFileInfo(StoreFile.java:1003) 
at org.apache.hadoop.hbase.regionserver.StoreFile.open(StoreFile.java:382) 
at org.apache.hadoop.hbase.regionserver.StoreFile.createReader(StoreFile.java:438) 
at org.apache.hadoop.hbase.regionserver.Store.loadStoreFiles(Store.java:267) 
at org.apache.hadoop.hbase.regionserver.Store.&amp;lt;init&amp;gt;(Store.java:209) 
at org.apache.hadoop.hbase.regionserver.HRegion.instantiateHStore(HRegion.java:2088) 
at org.apache.hadoop.hbase.regionserver.HRegion.initialize(HRegion.java:358) 
at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:2661) 
at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:2647) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Did we accidentally limit single region sizes this way?&lt;/p&gt;

&lt;p&gt;(Unsure about HFile v2&apos;s structure so far, so do not know if v2 has the same issue.)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12535784">HBASE-5071</key>
            <summary>HFile has a possible cast issue.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="qwertymaniac">Harsh J</reporter>
                        <labels>
                            <label>hfile</label>
                    </labels>
                <created>Tue, 20 Dec 2011 05:13:59 +0000</created>
                <updated>Mon, 23 Sep 2013 18:30:59 +0000</updated>
                            <resolved>Thu, 27 Sep 2012 20:04:58 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.95.0</fixVersion>
                                    <component>HFile</component>
                    <component>io</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13172943" author="stack" created="Tue, 20 Dec 2011 05:51:51 +0000"  >&lt;p&gt;Probably.&lt;/p&gt;

&lt;p&gt;Thanks Harsh.&lt;/p&gt;</comment>
                            <comment id="13178709" author="qwertymaniac" created="Tue, 3 Jan 2012 12:12:22 +0000"  >&lt;p&gt;Hm, given the array building, I can&apos;t really figure out a way to bypass this one.&lt;/p&gt;

&lt;p&gt;The following is ugly, but lemme know what you think of it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; sizeToLoadOnOpen = min(fileSize - trailer.getLoadOnOpenDataOffset() - trailer.getTrailerSize(), &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
&lt;span class=&quot;code-comment&quot;&gt;// First param computes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; type, and we cap that to &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13179838" author="stack" created="Wed, 4 Jan 2012 20:28:49 +0000"  >&lt;p&gt;lgtm&lt;/p&gt;</comment>
                            <comment id="13464296" author="ctrezzo" created="Wed, 26 Sep 2012 23:52:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikhail&quot; class=&quot;user-hover&quot; rel=&quot;mikhail&quot;&gt;Mikhail Bautin&lt;/a&gt; Do you want to have a look?&lt;/p&gt;</comment>
                            <comment id="13464300" author="ctrezzo" created="Wed, 26 Sep 2012 23:58:23 +0000"  >&lt;p&gt;It seems like this might not be a problem in HFileV2. Should we just close this issue?&lt;/p&gt;</comment>
                            <comment id="13464431" author="qwertymaniac" created="Thu, 27 Sep 2012 04:44:34 +0000"  >&lt;p&gt;We could close it with a note that it does not affect HFileV2.&lt;/p&gt;</comment>
                            <comment id="13465028" author="ctrezzo" created="Thu, 27 Sep 2012 20:05:36 +0000"  >&lt;p&gt;Closed and left a comment in the release notes. Thanks Harsh J!&lt;/p&gt;</comment>
                            <comment id="13468235" author="mikhail" created="Wed, 3 Oct 2012 01:05:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qwertymaniac&quot; class=&quot;user-hover&quot; rel=&quot;qwertymaniac&quot;&gt;Harsh J&lt;/a&gt;: Good catch! Looks good to me.&lt;/p&gt;</comment>
                            <comment id="13585860" author="shmuma" created="Mon, 25 Feb 2013 13:51:59 +0000"  >&lt;p&gt;Add my notes on this bug. This could be helpful to somewone who as we are still use HFileV1.&lt;/p&gt;

&lt;p&gt;This bug was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3040&quot; title=&quot;BlockIndex readIndex too slowly in heavy write scenario&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3040&quot;&gt;&lt;del&gt;HBASE-3040&lt;/del&gt;&lt;/a&gt; performance optimisation and cannot be fixed by Harsh&apos;s patch, which truncates index data (there are later problems rise on index parse).&lt;/p&gt;

&lt;p&gt;I fixed this issue in our installation by replacing readAllIndex whith BufferedInputStreams, which is transparent and have no index size limitations: &lt;a href=&quot;https://github.com/Shmuma/hbase/commit/d0ef517482a0475588e229344558c31b47d5a269&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/Shmuma/hbase/commit/d0ef517482a0475588e229344558c31b47d5a269&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13586395" author="qwertymaniac" created="Mon, 25 Feb 2013 22:44:34 +0000"  >&lt;p&gt;Hi Max,&lt;/p&gt;

&lt;p&gt;Why go down that path instead of upgrading to HFileV2?&lt;/p&gt;</comment>
                            <comment id="13586673" author="shmuma" created="Tue, 26 Feb 2013 03:12:26 +0000"  >&lt;p&gt;Harsh: at the moment, we aren&apos;t ready to upgrade from 0.90.6 to 0.92&lt;/p&gt;</comment>
                            <comment id="13775213" author="stack" created="Mon, 23 Sep 2013 18:30:59 +0000"  >&lt;p&gt;Marking closed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 20 Dec 2011 05:51:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>221467</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i069v3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34529</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>This issue only effects HFileV1 and is not an issue for HFileV2.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>