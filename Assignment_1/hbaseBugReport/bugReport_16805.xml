<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:18:00 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-16805/HBASE-16805.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-16805] HMaster may send reportForDuty himself while shutting down</title>
                <link>https://issues.apache.org/jira/browse/HBASE-16805</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We met an interesting scenario where HMaster had sent reportForDuty to himself during shutting down. &lt;/p&gt;

&lt;p&gt;Initially HMaster had registered himself as active master, but couldn&apos;t finish its initialization as Namespace table was not assigned due to some reason within the specified time,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-07-30 19:36:52,161 | FATAL | hadoopc1h2:21300.activeMasterManager | Failed to become active master | org.apache.hadoop.hbase.master.HMaster$1.run(HMaster.java:1610)
java.io.IOException: Timedout 300000ms waiting for namespace table to be assigned
	at org.apache.hadoop.hbase.master.TableNamespaceManager.start(TableNamespaceManager.java:102)
	at org.apache.hadoop.hbase.master.HMaster.initNamespace(HMaster.java:977)
	at org.apache.hadoop.hbase.master.HMaster.finishActiveMasterInitialization(HMaster.java:763)
	at org.apache.hadoop.hbase.master.HMaster.access$600(HMaster.java:171)
	at org.apache.hadoop.hbase.master.HMaster$1.run(HMaster.java:1606)
	at java.lang.Thread.run(Thread.java:745)
2016-07-30 19:36:52,162 | FATAL | hadoopc1h2:21300.activeMasterManager | Master server abort: loaded coprocessors are: [org.apache.hadoop.hbase.security.access.AccessController, org.apache.hadoop.hbase.index.coprocessor.master.IndexMasterObserver, org.apache.hadoop.hbase.JMXListener] | org.apache.hadoop.hbase.master.HMaster.abort(HMaster.java:1981)
2016-07-30 19:36:52,162 | FATAL | hadoopc1h2:21300.activeMasterManager | Unhandled exception. Starting shutdown. | org.apache.hadoop.hbase.master.HMaster.abort(HMaster.java:1984)
java.io.IOException: Timedout 300000ms waiting for namespace table to be assigned
	at org.apache.hadoop.hbase.master.TableNamespaceManager.start(TableNamespaceManager.java:102)
	at org.apache.hadoop.hbase.master.HMaster.initNamespace(HMaster.java:977)
	at org.apache.hadoop.hbase.master.HMaster.finishActiveMasterInitialization(HMaster.java:763)
	at org.apache.hadoop.hbase.master.HMaster.access$600(HMaster.java:171)
	at org.apache.hadoop.hbase.master.HMaster$1.run(HMaster.java:1606)
	at java.lang.Thread.run(Thread.java:745)
2016-07-30 19:36:52,187 | INFO  | master/hadoopc1h2/machine-ip:21300 | reportForDuty to master=hadoopc1h2,21300,1469877905979 with port=21300, startcode=1469877905979 | org.apache.hadoop.hbase.regionserver.HRegionServer.reportForDuty(HRegionServer.java:2271)
2016-07-30 19:36:52,198 | INFO  | hadoopc1h2:21300.activeMasterManager | ConnectorServer stopped! | org.apache.hadoop.hbase.JMXListener.stopConnectorServer(JMXListener.java:160)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Above in the second last line, HMaster sent reportForDuty to himself.&lt;/p&gt;


&lt;p&gt;Background:&lt;br/&gt;
1) During master startup HMasterCommandLine constructs the HMaster which starts another thread which is waiting to become active,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	startActiveMasterManager(infoPort);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2) Same time after constructing HMaster, HMasterCommandLine started the HMaster thread, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	 HMaster master = HMaster.constructMaster(masterClass, conf, csm);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (master.isStopped()) {
          LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Won&apos;t bring the Master up as a shutdown is requested&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 1;
        }
        master.start();
        master.join();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which will be waiting at below code flow,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	HRegionServer
		run()
		   preRegistrationInitialization()
		      initializeZooKeeper()
			waitForMasterActive()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3) In HMaster,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void waitForMasterActive(){
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; tablesOnMaster = BaseLoadBalancer.tablesOnMaster(conf);
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!(tablesOnMaster &amp;amp;&amp;amp; isActiveMaster)
        &amp;amp;&amp;amp; !isStopped() &amp;amp;&amp;amp; !isAborted()) {
      sleeper.sleep();
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;HMaster will wait here until it is stopped/aborted as &quot;hbase.balancer.tablesOnMaster&quot; is not configured.&lt;/p&gt;


&lt;p&gt;When HMaster failed to complete its initialization (as Namespace table was not assigned) then it will be abort,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	abort(&quot;Unhandled exception. Starting shutdown.&quot;, t);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So step-2 thread will not wait anymore on HMaster abort and while processing further it will send send report to active master.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-comment&quot;&gt;// Try and register with the Master; tell it we are here.  Break &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// server is stopped or the clusterup flag is down or hdfs went wacky.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (keepLooping()) {
        RegionServerStartupResponse w = reportForDuty();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (w == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;reportForDuty failed; sleeping and then retrying.&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sleeper.sleep();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          handleReportForDutyResponse(w);
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13011234">HBASE-16805</key>
            <summary>HMaster may send reportForDuty himself while shutting down</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="pankaj2461">Pankaj Kumar</assignee>
                                    <reporter username="pankaj2461">Pankaj Kumar</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Oct 2016 03:20:19 +0000</created>
                <updated>Tue, 11 Oct 2016 03:23:02 +0000</updated>
                                                                            <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34pev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>