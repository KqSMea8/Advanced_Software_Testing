<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:56:57 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1856/HBASE-1856.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1856] HBASE-1765 broke MapReduce when using Result.list()</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1856</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Not sure if it is just me, but using MR over HBase employing a TableReducer is not working. After the first row is read all subsequent rows get the same Result&apos;s of that very first row. After tracing this from the Map phase I found the culprit in Result and the &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1765&quot; title=&quot;Delay Result deserialization until asked for and permit access to the raw binary to prevent forced deserialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1765&quot;&gt;&lt;del&gt;HBASE-1765&lt;/del&gt;&lt;/a&gt; delayed field parsing change.&lt;/p&gt;

&lt;p&gt;This is the code I use in the reduce():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void reduce(ImmutableBytesWritable key, Iterable&amp;lt;Result&amp;gt; values,
        Context context) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException {
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; skey = Bytes.toString(key.get());
      context.getCounter(CountersTotals.ROWS).increment(1);
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Result result : values) {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (KeyValue kv: result.list()) {
          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;reduce: key -&amp;gt; &quot;&lt;/span&gt; + skey + &lt;span class=&quot;code-quote&quot;&gt;&quot;, kv -&amp;gt; &quot;&lt;/span&gt; + kv);
            ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the current list() implementation:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;KeyValue&amp;gt; list() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.kvs == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      readFields();
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; isEmpty()? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;: Arrays.asList(sorted());
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is that readFields(DataInput) does not clear kvs!&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void readFields(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DataInput in)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    familyMap = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    row = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; totalBuffer = in.readInt();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(totalBuffer == 0) {
      bytes = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] raw = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[totalBuffer];
    in.readFully(raw, 0, totalBuffer);
    bytes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ImmutableBytesWritable(raw, 0, totalBuffer);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above is called by the MR framework&apos;s WritableSerialization for each map output. But since &quot;kvs&quot; is already set &quot;list()&quot; returns the old data!&lt;/p&gt;

&lt;p&gt;I assume the only change needed is clearing kvs as well:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void readFields(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DataInput in)
  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    familyMap = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    row = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    kvs = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll test that now and report.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12436283">HBASE-1856</key>
            <summary>HBASE-1765 broke MapReduce when using Result.list()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="larsgeorge">Lars George</assignee>
                                    <reporter username="larsgeorge">Lars George</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Sep 2009 08:31:34 +0000</created>
                <updated>Fri, 20 Nov 2015 13:01:23 +0000</updated>
                            <resolved>Tue, 22 Sep 2009 18:49:02 +0000</resolved>
                                    <version>0.20.1</version>
                    <version>0.90.0</version>
                                    <fixVersion>0.20.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12758254" author="stack" created="Tue, 22 Sep 2009 14:21:24 +0000"  >&lt;p&gt;Good man Lars.  I found this too and have the fix you describe above in as part of hbase-1815 IIRC.&lt;/p&gt;</comment>
                            <comment id="12758268" author="larsgeorge" created="Tue, 22 Sep 2009 15:21:20 +0000"  >&lt;p&gt;Hrmm, can&apos;t see it in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1815&quot; title=&quot;HBaseClient can get stuck in an infinite loop while attempting to contact a failed regionserver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1815&quot;&gt;&lt;del&gt;HBASE-1815&lt;/del&gt;&lt;/a&gt; though. Did you mean a different issue?&lt;/p&gt;</comment>
                            <comment id="12758288" author="stack" created="Tue, 22 Sep 2009 16:29:46 +0000"  >&lt;p&gt;Assigning Lars (he found it &amp;#8211; I can&apos;t find my &apos;fix&apos; in hbase-1815 and its not in any local repo here...).&lt;/p&gt;</comment>
                            <comment id="12758293" author="larsgeorge" created="Tue, 22 Sep 2009 16:44:51 +0000"  >&lt;p&gt;+1 with a minor comment on using &quot;this.&quot;. famliyMap and row is used without it, so I would do the same for kvs?&lt;/p&gt;</comment>
                            <comment id="12758358" author="stack" created="Tue, 22 Sep 2009 18:49:02 +0000"  >&lt;p&gt;Committed branch and trunk (with Lars&apos;s suggestion).&lt;/p&gt;</comment>
                            <comment id="15017786" author="lars_francke" created="Fri, 20 Nov 2015 13:01:23 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12420283" name="1856.patch" size="662" author="stack" created="Tue, 22 Sep 2009 16:29:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 22 Sep 2009 14:21:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26020</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hfn3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99796</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>