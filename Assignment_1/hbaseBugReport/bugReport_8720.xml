<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:57:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-8720/HBASE-8720.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-8720] Only one snapshot region tasks that can run at a time</title>
                <link>https://issues.apache.org/jira/browse/HBASE-8720</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    SnapshotSubprocedurePool(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, Configuration conf) {
      &lt;span class=&quot;code-comment&quot;&gt;// configure the executor service
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; keepAlive = conf.getLong(
        RegionServerSnapshotManager.SNAPSHOT_TIMEOUT_MILLIS_KEY,
        RegionServerSnapshotManager.SNAPSHOT_TIMEOUT_MILLIS_DEFAULT);
      &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; threads = conf.getInt(CONCURENT_SNAPSHOT_TASKS_KEY, DEFAULT_CONCURRENT_SNAPSHOT_TASKS);
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.name = name;
      executor = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadPoolExecutor(1, threads, keepAlive, TimeUnit.MILLISECONDS,
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LinkedBlockingQueue&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;&amp;gt;(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DaemonThreadFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;rs(&quot;&lt;/span&gt;
              + name + &lt;span class=&quot;code-quote&quot;&gt;&quot;)-snapshot-pool&quot;&lt;/span&gt;));
      taskPool = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExecutorCompletionService&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;(executor);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;ThreadPoolExecutor&#65306; &lt;br/&gt;
corePoolSize&#65306;1&lt;br/&gt;
maximumPoolSize&#65306;3&lt;br/&gt;
workQueue&#65306;LinkedBlockingQueue&#65292;unlimited&lt;br/&gt;
so when a new task submit to the ThreadPoolExecutor, if there is a task is running, the new task is queued in the queue, so all snapshot region tasks execute one by one.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12651905">HBASE-8720</key>
            <summary>Only one snapshot region tasks that can run at a time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="aoxiang">binlijin</reporter>
                        <labels>
                    </labels>
                <created>Sun, 9 Jun 2013 07:01:13 +0000</created>
                <updated>Tue, 21 Apr 2015 00:50:24 +0000</updated>
                            <resolved>Tue, 21 Apr 2015 00:50:24 +0000</resolved>
                                    <version>0.94.8</version>
                    <version>0.95.0</version>
                                                    <component>snapshots</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13679042" author="yuzhihong@gmail.com" created="Sun, 9 Jun 2013 13:07:28 +0000"  >&lt;p&gt;executor.allowCoreThreadTimeOut(true) is added in patch v2.&lt;/p&gt;</comment>
                            <comment id="13679071" author="hadoopqa" created="Sun, 9 Jun 2013 14:20:50 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12586949/8720-v2.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12586949/8720-v2.txt&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop1.0&lt;/font&gt;.  The patch compiles against the hadoop 1.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 hadoop2.0&lt;/font&gt;.  The patch compiles against the hadoop 2.0 profile.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 lineLengths&lt;/font&gt;.  The patch does not introduce lines longer than 100&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 site&lt;/font&gt;.  The patch appears to cause mvn site goal to fail.&lt;/p&gt;

&lt;p&gt;     &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests:&lt;br/&gt;
                       org.apache.hadoop.hbase.security.access.TestAccessController&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-protocol.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-client.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-examples.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop1-compat.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-prefix-tree.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-common.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-server.html&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//artifact/trunk/patchprocess/newPatchFindbugsWarningshbase-hadoop-compat.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/5982//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13679120" author="mbertozzi" created="Sun, 9 Jun 2013 17:56:20 +0000"  >&lt;p&gt;ok for having the number of thread configurable, but keep in mind that the current snapshot triggers a flush and you don&apos;t want all the regions flush at the same time.&lt;/p&gt;</comment>
                            <comment id="13681020" author="aoxiang" created="Wed, 12 Jun 2013 07:41:51 +0000"  >&lt;p&gt;+1, LGTM.&lt;/p&gt;</comment>
                            <comment id="13681306" author="mbertozzi" created="Wed, 12 Jun 2013 14:55:08 +0000"  >&lt;p&gt;I&apos;m -1 on this patch... &lt;/p&gt;

&lt;p&gt;The first argument of the ThreadPoolExecutor is used to defined how many idle threads you want to keep around... and you want this number to be low expecially for snapshots, since they are used just used in the order of 1 or 2 times per hour (I guess is around that if you&apos;re a heavy user)...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
corePoolSize - the number of threads to keep in the pool, even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; they are idle.
maximumPoolSize - the maximum number of threads to allow in the pool.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;NOTE that increasing that number doesn&apos;t give you the parallelism, you have to increase the number in the configuration property... and if you have space (maxPoolSize) a new thread will be added.&lt;/p&gt;

&lt;p&gt;Also the allowCoreThreadTimeOut(true) added in v2 is basically the same as saying corePoolSize = 0, since you are asking to remove idle threads based on the keepAlive.&lt;/p&gt;

&lt;p&gt;another note is that having more threads may make things worse in the current case. Each thread will trigger a flush, to take a snapshot, and this means more I/O.. and you end up slowing down everything else.&lt;/p&gt;

&lt;p&gt;If you want to spend more time on this patch&lt;br/&gt;
1. Add a test to demonstrate how many threads are really running during the snapshot&lt;br/&gt;
2. Test and get performance result of what is the gain and the performance degradation that you have by increasing the number of threads&lt;/p&gt;</comment>
                            <comment id="13681337" author="aoxiang" created="Wed, 12 Jun 2013 15:39:35 +0000"  >&lt;p&gt;hi Matteo Bertozzi &#65306;&lt;br/&gt;
Queuing:&lt;br/&gt;
Any BlockingQueue may be used to transfer and hold submitted tasks. The use of this queue interacts with pool sizing:&lt;br/&gt;
If fewer than corePoolSize threads are running, the Executor always prefers adding a new thread rather than queuing.&lt;br/&gt;
If corePoolSize or more threads are running, the Executor always prefers queuing a request rather than adding a new thread.&lt;br/&gt;
If a request cannot be queued, a new thread is created unless this would exceed maximumPoolSize, in which case, the task will be rejected.&lt;br/&gt;
so when a new task submit to the ThreadPoolExecutor, if there is a task is running, the new task is queued in the queue, so all snapshot region tasks execute one by one.&lt;/p&gt;

&lt;p&gt;And i think CONCURENT_SNAPSHOT_TASKS_KEY makes people misunderstanding.&lt;br/&gt;
  /** Maximum number of snapshot region tasks that can run concurrently */&lt;br/&gt;
  private static final String CONCURENT_SNAPSHOT_TASKS_KEY = &quot;hbase.snapshot.region.concurrentTasks&quot;;&lt;br/&gt;
  private static final int DEFAULT_CONCURRENT_SNAPSHOT_TASKS = 3;&lt;/p&gt;</comment>
                            <comment id="13681357" author="mbertozzi" created="Wed, 12 Jun 2013 16:07:32 +0000"  >&lt;p&gt;The current snapshot implementation is just a first cut, so some names and code are there ready for the future. (Example, this concurrent name, the restoreWALs() in the restore code and so on)&lt;/p&gt;

&lt;p&gt;again, I don&apos;t think that having N idle thread around for the snapshot is a good idea, changing the queue type can be a more acceptable patch, but still. If you don&apos;t have a test and a benchmark that demonstrate that you have a real performance gain having more thread doesn&apos;t make sense at this time. &lt;br/&gt;
You may consider introducing a a new snapshot procedure that doesn&apos;t flush the memstore and and keeps track of the logs, and with that you may consider increasing the number of threads, since is more likely to have a perf gain and less downside.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12586949" name="8720-v2.txt" size="1979" author="yuzhihong@gmail.com" created="Sun, 9 Jun 2013 13:07:28 +0000"/>
                            <attachment id="12586930" name="HBASE-8720.patch" size="1923" author="aoxiang" created="Sun, 9 Jun 2013 07:04:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sun, 9 Jun 2013 13:07:28 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332229</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 27 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lban:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>