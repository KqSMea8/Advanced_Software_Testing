<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:13:54 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3874/HBASE-3874.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3874] ServerShutdownHandler fails on NPE if a plan has a random region assignment</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3874</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;By chance, we were able to revert the ulimit on one of our clusters to 1024 and it started dying non-stop on &quot;Too many open files&quot;. Now the bad thing is that some region servers weren&apos;t completely ServerShutdownHandler&apos;d because they failed on:&lt;/p&gt;

&lt;blockquote&gt;

&lt;p&gt;2011-05-07 00:04:46,203 ERROR org.apache.hadoop.hbase.executor.EventHandler: Caught throwable while processing event M_SERVER_SHUTDOWN&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.hadoop.hbase.master.AssignmentManager.processServerShutdown(AssignmentManager.java:1804)&lt;br/&gt;
	at org.apache.hadoop.hbase.master.handler.ServerShutdownHandler.process(ServerShutdownHandler.java:101)&lt;br/&gt;
	at org.apache.hadoop.hbase.executor.EventHandler.run(EventHandler.java:156)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Reading the code, it seems the NPE is in the if statement:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, RegionPlan&amp;gt; e = i.next();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e.getValue().getDestination().equals(hsi)) {
  &lt;span class=&quot;code-comment&quot;&gt;// Use iterator&apos;s remove &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; we&apos;ll get CME
&lt;/span&gt;  i.remove();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which means that the destination (HSI) is null. Looking through the code, it seems we instantiate a RegionPlan with a null HSI when it&apos;s a random assignment. &lt;/p&gt;

&lt;p&gt;It means that if there&apos;s a random assignment going on while a node dies then this issue might happen.&lt;/p&gt;

&lt;p&gt;Initially I thought that this could mean data loss, but the logs are already split so it&apos;s just the reassignment that doesn&apos;t happen (still bad).&lt;/p&gt;

&lt;p&gt;Also it left the master with dead server being processed, so for two days the balancer didn&apos;t run failing on:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;org.apache.hadoop.hbase.master.HMaster: Not running balancer because processing dead regionserver(s): []&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;And the reason why the array is empty is because we are running 0.90.3 which removes the RS from the dead list if it comes back.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12506787">HBASE-3874</key>
            <summary>ServerShutdownHandler fails on NPE if a plan has a random region assignment</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdcryans">Jean-Daniel Cryans</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 May 2011 00:12:34 +0000</created>
                <updated>Fri, 20 Nov 2015 12:43:48 +0000</updated>
                            <resolved>Thu, 19 May 2011 00:24:34 +0000</resolved>
                                    <version>0.90.2</version>
                                    <fixVersion>0.90.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13035777" author="jdcryans" created="Wed, 18 May 2011 22:04:38 +0000"  >&lt;p&gt;Adding a check if HSI is null. I looked into writing a unit test but it&apos;s not obvious how to create a random plan for a region without having the actual reassignment taking place.&lt;/p&gt;</comment>
                            <comment id="13035847" author="stack" created="Wed, 18 May 2011 23:20:18 +0000"  >&lt;p&gt;+1 on patch.&lt;/p&gt;

&lt;p&gt;I spent a few minutes trying to see if I could construct an AssignmentManager standalone so we could write a unit test but its a pain.  It takes a ServerManager, etc.&lt;/p&gt;</comment>
                            <comment id="13035885" author="jdcryans" created="Thu, 19 May 2011 00:23:16 +0000"  >&lt;p&gt;Patch for trunk.&lt;/p&gt;</comment>
                            <comment id="13035886" author="jdcryans" created="Thu, 19 May 2011 00:24:34 +0000"  >&lt;p&gt;Committed to branch and trunk, thanks for the review Stack!&lt;/p&gt;</comment>
                            <comment id="13037173" author="hudson" created="Sat, 21 May 2011 00:04:26 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1930 (See &lt;a href=&quot;https://builds.apache.org/hudson/job/HBase-TRUNK/1930/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/hudson/job/HBase-TRUNK/1930/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="15017625" author="lars_francke" created="Fri, 20 Nov 2015 12:43:48 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12479697" name="HBASE-3874-trunk.patch" size="861" author="jdcryans" created="Thu, 19 May 2011 00:23:16 +0000"/>
                            <attachment id="12479669" name="HBASE-3874.patch" size="866" author="jdcryans" created="Wed, 18 May 2011 22:04:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 18 May 2011 23:20:18 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27068</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hoa7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101196</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>