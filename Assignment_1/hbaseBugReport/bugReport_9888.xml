<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:08:31 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-9888/HBASE-9888.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-9888] HBase replicates edits written before the replication peer is created</title>
                <link>https://issues.apache.org/jira/browse/HBASE-9888</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;When creating a new replication peer the ReplicationSourceManager enqueues the currently open HLog to the ReplicationSource to ship to the destination cluster.  The ReplicationSource starts at the beginning of the HLog and ships over any pre-existing writes.&lt;/p&gt;

&lt;p&gt;A workaround is to roll all the HLogs before enabling replication.&lt;/p&gt;

&lt;p&gt;A little background for how it affected us - we were migrating one cluster in a master-master pair.  I.e. transitioning from A &amp;lt;&amp;#45;&amp;gt; B to B &amp;lt;-&amp;gt; C.  After shutting down writes from A -&amp;gt; B we enabled writes from C -&amp;gt; B.  However, this replicated some earlier writes that were in C&apos;s HLogs that had originated in A.  Since we were running a version of HBase before &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7709&quot; title=&quot;Infinite loop possible in Master/Master replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7709&quot;&gt;&lt;del&gt;HBASE-7709&lt;/del&gt;&lt;/a&gt; those writes then got caught in a infinite replication cycle and bringing down region servers OOM because of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9865&quot; title=&quot;Reused WALEdits in replication may cause RegionServers to go OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9865&quot;&gt;&lt;del&gt;HBASE-9865&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;However, in general, if one wants to manage what data gets replicated, one wouldn&apos;t expect that potentially very old writes would be included when setting up a new replication link.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12677419">HBASE-9888</key>
            <summary>HBase replicates edits written before the replication peer is created</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="davelatham">Dave Latham</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Nov 2013 18:08:16 +0000</created>
                <updated>Mon, 8 Feb 2016 16:28:55 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13813663" author="anoop.hbase" created="Tue, 5 Nov 2013 05:39:24 +0000"  >&lt;p&gt;So in your case the replication was enabled at the master cluster and the table cf was also replication enabled (scope&amp;gt;0) At a later point u added a peer to the master and you can see the older edits also getting replicated.  The scenario is correct?&lt;/p&gt;</comment>
                            <comment id="13814686" author="techbuddy01" created="Wed, 6 Nov 2013 07:51:11 +0000"  >&lt;p&gt;Did you consider writing a replication controller to be deployed on the sink cluster ?&lt;br/&gt;
The idea is to implement a edits filter plugin as a ReplicationSinkService implementation that can be defined in the hbase-site.xml as follows? &lt;/p&gt;

&lt;p&gt;&amp;lt;property&amp;gt;&lt;br/&gt;
&amp;lt;name&amp;gt;hbase.replication.source.service&amp;lt;/name&amp;gt;&lt;br/&gt;
&amp;lt;value&amp;gt;com......replication.ReplicationController&amp;lt;/value&amp;gt;&lt;br/&gt;
&amp;lt;/property&amp;gt;&lt;/p&gt;

&lt;p&gt;You can consider extending the default implementation org.apache.hadoop.hbase.replication.regionserver.Replication of ReplicationSinkService, and just override the replicateLogEntries() method to apply your filtering logic. For your specific usecase, your sink cluster needs to know when it was added as a peer, and then ,assuming the two clusters are time-synced, the custom sink service can filter the edits based on this timestamp, leaving out the ones that were created earlier than the timestamp.&lt;/p&gt;</comment>
                            <comment id="13815084" author="jdcryans" created="Wed, 6 Nov 2013 18:07:52 +0000"  >&lt;p&gt;In 0.94, HLogKey has a &lt;tt&gt;writeTime&lt;/tt&gt; and we could seek in the current WAL until we find an edit that&apos;s been written after the source was created. It&apos;s still fuzzy since the time that each source actually gets created will differ for each RS, but at least you wouldn&apos;t start replicating old edits.&lt;/p&gt;</comment>
                            <comment id="13815111" author="davelatham" created="Wed, 6 Nov 2013 18:22:46 +0000"  >&lt;blockquote&gt;
&lt;p&gt;So in your case the replication was enabled at the master cluster and the table cf was also replication enabled (scope&amp;gt;0) At a later point u added a peer to the master and you can see the older edits also getting replicated. The scenario is correct?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, that&apos;s correct.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Did you consider writing a replication controller to be deployed on the sink cluster ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Nope, didn&apos;t consider it because we weren&apos;t aware of the issue ahead of time.  We ended up resolving the infinite replication cycle by introducing a patch to allow configuring specific cluster UUIDs whose edits should not be replication.  For the future, I&apos;d prefer a built in improvement.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;In 0.94, HLogKey has a writeTime and we could seek in the current WAL until we find an edit that&apos;s been written after the source was created. It&apos;s still fuzzy since the time that each source actually gets created will differ for each RS, but at least you wouldn&apos;t start replicating old edits.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That sounds great.  Is that 0.94 only or do the newer versions also have it?  Do you have an idea where the minimum timestamp would be generated?  Would it work to just do it in each RS when the ReplicationSource on that RS is created (in the mode for add_peer)?&lt;/p&gt;

&lt;p&gt;Alternatively, should each RS roll its HLog when creating a new peer?&lt;/p&gt;</comment>
                            <comment id="13815313" author="techbuddy01" created="Wed, 6 Nov 2013 21:31:49 +0000"  >&lt;blockquote&gt;&lt;p&gt; In 0.94, HLogKey has a writeTime and we could seek in the current WAL until we find an edit that&apos;s been written after the source was created.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This sounds interesting. So,are you suggesting implementing a custom ReplicationSource to seek into the current WAL to find the edit with writeTime &amp;gt; sourceCreationTimestamp?&lt;/p&gt;</comment>
                            <comment id="13815314" author="jdcryans" created="Wed, 6 Nov 2013 21:32:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;That sounds great. Is that 0.94 only or do the newer versions also have it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s in trunk too.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Do you have an idea where the minimum timestamp would be generated?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Once we get the zk event? Not sure.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Would it work to just do it in each RS when the ReplicationSource on that RS is created (in the mode for add_peer)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s what I was proposing, sorry if not clear.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Alternatively, should each RS roll its HLog when creating a new peer?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That could work but I&apos;d rather not roll logs for this.&lt;/p&gt;</comment>
                            <comment id="13815322" author="jdcryans" created="Wed, 6 Nov 2013 21:36:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;So,are you suggesting implementing a custom ReplicationSource to seek into the current WAL to find the edit with writeTime &amp;gt; sourceCreationTimestamp?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It wouldn&apos;t be custom, it&apos;d be the default behavior.&lt;/p&gt;</comment>
                            <comment id="13815337" author="davelatham" created="Wed, 6 Nov 2013 21:54:40 +0000"  >&lt;blockquote&gt;
&lt;p&gt;&amp;gt; Would it work to just do it in each RS when the ReplicationSource on that RS is created (in the mode for add_peer)?&lt;br/&gt;
That&apos;s what I was proposing, sorry if not clear.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1 for the proposal.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12937494">HBASE-15230</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 5 Nov 2013 05:39:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356794</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pibr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>357084</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>