<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:10:08 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3431/HBASE-3431.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3431] Regionserver is not using the name given it by the master; double entry in master listing of servers</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3431</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Our man Ted Dunning found the following where RS checks in with one name, the master tells it use another name but we seem to go ahead and continue with our original name.&lt;/p&gt;

&lt;p&gt;In RS logs I see:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-01-07 15:45:50,757 INFO  org.apache.hadoop.hbase.regionserver.HRegionServer [regionserver60020]: Master passed us address to use. Was=perfnode11:60020, Now=10.10.30.11:60020
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;On master I see&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-01-07 15:45:38,613 INFO  org.apache.hadoop.hbase.master.ServerManager [IPC Server handler 0 on 60000]: Registering server=10.10.30.11,60020,1294443935414, regionCount=0, userLoad=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;....&lt;/p&gt;

&lt;p&gt;then later&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-01-07 15:45:44,247 INFO  org.apache.hadoop.hbase.master.ServerManager [IPC Server handler 2 on 60000]: Registering server=perfnode11,60020,1294443935414, regionCount=0, userLoad=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This might be since we started letting servers register in other than with the reportStartup.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12495008">HBASE-3431</key>
            <summary>Regionserver is not using the name given it by the master; double entry in master listing of servers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Sat, 8 Jan 2011 01:39:40 +0000</created>
                <updated>Fri, 20 Nov 2015 12:44:08 +0000</updated>
                            <resolved>Wed, 4 May 2011 20:13:14 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.92.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="12979056" author="stack" created="Sat, 8 Jan 2011 01:41:10 +0000"  >&lt;p&gt;Why is RS not taking what the Master tells it use when gong to the Master?&lt;/p&gt;</comment>
                            <comment id="12979087" author="stack" created="Sat, 8 Jan 2011 04:34:06 +0000"  >&lt;p&gt;Seems like this is a regression since 0.89.  Ted says 0.89 works on his cluster.  The master is seeing RS as an IP then subsequently the RS is giving the IP back as its &apos;name&apos;.  Ted is also starting things a little odd... manually starting each daemon... with the RS saying that its NotReadyYet exception in 0.90.&lt;/p&gt;</comment>
                            <comment id="12979971" author="stack" created="Tue, 11 Jan 2011 07:20:12 +0000"  >&lt;p&gt;A unit test that has master setting an address for the regionserver to use and then verifying that subsequently the regionserver volunteers what we told it use.  Passes on TRUNK which would seem to say this stuff should be working fine.&lt;/p&gt;

&lt;p&gt;I compared 0.89 and 0.90 HRS.  Nothing jumps out.&lt;/p&gt;</comment>
                            <comment id="12987318" author="stack" created="Thu, 27 Jan 2011 00:45:32 +0000"  >&lt;p&gt;We are seeing lots of permutations on this issue up in mailing lists.  Lets fix this in a 0.90.1.&lt;/p&gt;</comment>
                            <comment id="12987320" author="stack" created="Thu, 27 Jan 2011 00:54:36 +0000"  >&lt;p&gt;Workaround is to make reverse DNS on master produce same hostname as that which the RegionServer reports (RS hostname lookup).&lt;/p&gt;</comment>
                            <comment id="12987334" author="stack" created="Thu, 27 Jan 2011 01:28:56 +0000"  >&lt;p&gt;Up on IRC we just had case where RS was reporting hostname only but reverse lookup was return FQDN.&lt;/p&gt;</comment>
                            <comment id="12990852" author="stack" created="Sat, 5 Feb 2011 00:36:36 +0000"  >&lt;p&gt;If master can&apos;t find regionserver address, then master does this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.IllegalArgumentException: Could not resolve the DNS name of sv2borg185:60020
    at org.apache.hadoop.hbase.HServerAddress.checkBindAddressCanBeResolved(HServerAddress.java:105)
    at org.apache.hadoop.hbase.HServerAddress.readFields(HServerAddress.java:168)
    at org.apache.hadoop.hbase.HServerInfo.readFields(HServerInfo.java:230)
    at org.apache.hadoop.hbase.io.HbaseObjectWritable.readObject(HbaseObjectWritable.java:521)
    ... 8 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... which is kinda dumb but means no progress unless server can get an address.&lt;/p&gt;

&lt;p&gt;If DNS is wrong, e.g. on master, when it does a lookup on passed name, we come up w/ a different address, then we&apos;ll tell the regionserver go forward with the IP.&lt;/p&gt;

&lt;p&gt;At moment you&apos;ll see two entries for this badly configured server.  The regionserver will show by its name and by its bad IP.&lt;/p&gt;

&lt;p&gt;Symptom is you can&apos;t shutdown because master is waiting on the ghost server to finish its close up (this is what was happening for mr oracle.com).&lt;/p&gt;

&lt;p&gt;I manufactured Ted&apos;s prob. by changing hosts on master to have different subnet for a server.  Then I got this in RS log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2011-02-05 00:33:49,409 INFO org.apache.hadoop.hbase.regionserver.HRegionServer: Master passed us address to use. Was=sv2borg185:60020, Now=10.20.20.185:60020
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me dig in.&lt;/p&gt;
</comment>
                            <comment id="12991060" author="stack" created="Sat, 5 Feb 2011 21:17:34 +0000"  >&lt;p&gt;The issue is that if the master sees a RegionServer differently to how the RS sees itself &amp;#8211; e.g. master gets an ip when it does lookup though RS passed a name or if RS passed a FQDN but master has hostname only &amp;#8211; then the master will ask the RS to take on the name the Master sees by passing it back an HServerAddress.  This does not work if the two servers are getting different answers from their respective DNS&apos;s.  The Master knows RS&apos;s by their &apos;ServerName&apos; which is hostname+port+startcode.  If DNS is wonky, then the Master and RS will come up with different &apos;ServerName&apos;s even if the Master passes back its HSA (HSA could be IP only, RS does lookup and comes up w/ different hostname if DNS is broke).  This patch removes the code that has master trying the RS the identity to use.  Instead Master just uses the ServerName the RS volunteered.&lt;/p&gt;

&lt;p&gt;So far in testing it seems to work when DNS is set up properly and when Master side DNS is broke where its finding IP only for RS.  Let me do some more testing.&lt;/p&gt;</comment>
                            <comment id="12991074" author="stack" created="Sat, 5 Feb 2011 22:20:47 +0000"  >&lt;p&gt;Should have stripped setting IP of RS on Master side when doing startup message.  More breaking of DNS turned up this one.  Still testing.&lt;/p&gt;</comment>
                            <comment id="12991075" author="stack" created="Sat, 5 Feb 2011 22:22:32 +0000"  >&lt;p&gt;More DNS breaking turned up fact that on startup, Master should not be setting RS address into HSI.  Still testing.&lt;/p&gt;</comment>
                            <comment id="12991081" author="jdcryans" created="Sat, 5 Feb 2011 23:18:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;Instead Master just uses the ServerName the RS volunteered.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So what happens if region server passes 127.0.0.1?&lt;/p&gt;</comment>
                            <comment id="12991094" author="stack" created="Sun, 6 Feb 2011 01:32:40 +0000"  >&lt;p&gt;If RS passes 127.0.0.1, then thats what its bound too and no (remote) client will be able to connect.  Its broke.&lt;/p&gt;

&lt;p&gt;The fixup in master would let this (broke) server successfully register.  The master would call remoteIP on the connected socket to get the RSs&apos; address and it would then know the RS as this.  This would happen only on startup, in reportForDuty, not subsequently during heartbeating; we only do the lookup of remoteip on reportForDuty.&lt;/p&gt;

&lt;p&gt;Heartbeating, the RS was supposed to be volunteering the HServerInfo that the Master had passed it back as response to the reportForDuty.&lt;/p&gt;

&lt;p&gt;Since 0.90.0, servers can register at heartbeat time.  This is because masters can join an already running cluster.  The RSs do not rerun the reportForDuty step.  They just start heartbeating the new Master.&lt;/p&gt;

&lt;p&gt;We could I suppose add lookup on the sockets remoteip to heartbeating too with reverse lookup.&lt;/p&gt;

&lt;p&gt;I&apos;m thinking its better to just strip all this crap out.&lt;/p&gt;</comment>
                            <comment id="12991099" author="stack" created="Sun, 6 Feb 2011 05:19:34 +0000"  >&lt;p&gt;Tested w/ name resolution broke on both ends.  If I broke lookup good, server wouldn&apos;t start complaining couldn&apos;t resolve name (thats not new to my patch).  If no resolve when it got to server side then again same thing w/ a complaint that couldn&apos;t resolve regionserver name... again not new to my patch... more a commentary on how hbase will complain loudly already if resolve is mangled.  Messages are pretty plain about whats wrong.&lt;/p&gt;

&lt;p&gt;I broke master resolve so the incoming RS did not resolve to a proper address &amp;#8211; in the past we&apos;d send back an IP and use that ever after and then you&apos;d have double-vision after next heartbeat &amp;#8211; and then on RS I broke it so passed back a FQDN when Master was dealing in host names only.  That worked too.&lt;/p&gt;

&lt;p&gt;Review please.  Unit tests are hard to do.  Would have to somehow mock java dns lookup.  Changing the dns doesn&apos;t seem to be possible (I can see providing alternate dns provider to jndi if you provide flags on JVM startup).&lt;/p&gt;</comment>
                            <comment id="12991217" author="ryanobjc" created="Sun, 6 Feb 2011 21:03:31 +0000"  >&lt;p&gt;I&apos;ll have a look monday&lt;/p&gt;</comment>
                            <comment id="12991610" author="stack" created="Mon, 7 Feb 2011 21:09:35 +0000"  >&lt;p&gt;Chatted w/ Jon and J-D on this.  Jon suggests EnvironmentEdgeManager utility as means of intercepting lookups so we can do up tests returning different answers.  Let me try it out.  J-D rehearsed issues w/ have had in here over time and that this &apos;mess&apos; was &apos;working&apos; in 0.20.x and even unto 0.89.x (He remembers also that a RS can volunteer its address as 127.0.0.1 but actually bind to real, non-localhost address somehow).  He&apos;s wary about stripping it all out as the patch does.  Let me try and put up unit tests that can mock the various scenarios.&lt;/p&gt;

&lt;p&gt;Looking at code w/ J-D, we turned up one problematic bit of code &amp;#8211; HSA will create a new InetSocketAddress on deserialization which can result in a lookup.&lt;/p&gt;

&lt;p&gt;Looking in hdfs, datanode generates a registration name &amp;#8211; e.g. DS-198919343-10.20.20.187-10010-1291133524722 &amp;#8211; and this is how it identifies itself to NN regardless.  No messing w/ NN telling it what name to use.   TT does something similar.&lt;/p&gt;</comment>
                            <comment id="12991612" author="ryanobjc" created="Mon, 7 Feb 2011 21:14:00 +0000"  >&lt;p&gt;one thing to consider is a lot of the network code attempts to figure&lt;br/&gt;
out what is the &apos;primary ip&apos; then bind to just that IP.&lt;/p&gt;

&lt;p&gt;would it make sense to bind to * instead? (ie: 0.0.0.0) Why not accept&lt;br/&gt;
RPCs on all interfaces? If security is a concern, I think SASL and&lt;br/&gt;
host level firewall controls are a better way to address that, rather&lt;br/&gt;
than bake it in HBase.  That way it won&apos;t really &quot;matter&quot; what our IP&lt;br/&gt;
is, whatever IP the master &apos;sees&apos; us as could be used as what to stuff&lt;br/&gt;
in the META.  Then we could use the registration name to identify dead&lt;br/&gt;
hosts, etc, etc.&lt;/p&gt;</comment>
                            <comment id="12991661" author="stack" created="Mon, 7 Feb 2011 22:24:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking in hdfs, datanode generates a registration name &#8211; e.g. DS-198919343-10.20.20.187-10010-1291133524722 &#8211; and this is how it identifies itself to NN regardless. No messing w/ NN telling it what name to use. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;J-D points out that I&apos;m reading this code lazily (i.e. wrong), that on registration, the NN returns a DataRegistration instance that the DN will use going forward.&lt;/p&gt;</comment>
                            <comment id="12991662" author="stack" created="Mon, 7 Feb 2011 22:24:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking in hdfs, datanode generates a registration name &#8211; e.g. DS-198919343-10.20.20.187-10010-1291133524722 &#8211; and this is how it identifies itself to NN regardless. No messing w/ NN telling it what name to use. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;J-D points out that I&apos;m reading this code lazily (i.e. wrong), that on registration, the NN returns a DataRegistration instance that the DN will use going forward.&lt;/p&gt;</comment>
                            <comment id="12991694" author="stack" created="Mon, 7 Feb 2011 23:12:28 +0000"  >&lt;p&gt;I can&apos;t use EnvironmentEdge to change addresses since the InetSocketAddress that is at root of our HServerAddress, etc., is taken from the socket down in RPC &amp;#8211; I can&apos;t interject EnvironmentEdge inside Socket.getLocalSocketAddress, etc.&lt;/p&gt;

&lt;p&gt;I can&apos;t change how HSA or HSI serialize since this is a point release.&lt;/p&gt;

&lt;p&gt;All this is going to go away, or at least change radically, 0.92 because we intend dropping heartbeat.&lt;/p&gt;</comment>
                            <comment id="12991733" author="stack" created="Tue, 8 Feb 2011 00:17:06 +0000"  >&lt;p&gt;Moving out.  J-D won&apos;t let me get away w/ my radical strip back of code; i&apos;ll break stuff thats currently &apos;working&apos; (probably true).  I can&apos;t change the RPC because we&apos;re on a point version.  I can&apos;t change the way HSI and HSA work, because we are on a point version.  The only invariant in the communication between Master and RS is the server startcode (and port).  I could try and leverage this fact but looks like a bunch of work &amp;#8211; and this stuff is all going away in 0.92.&lt;/p&gt;

&lt;p&gt;Let me add to the FAQ in the book what to do if user has double-vision.  That&apos;ll do for 0.90.1.&lt;/p&gt;</comment>
                            <comment id="13028930" author="stack" created="Wed, 4 May 2011 20:13:14 +0000"  >&lt;p&gt;Resolving.  I added to FAQ section on what to do if you are seeing double (the regionservers).  Resolving also because hbase-1502 changes how this all works so hopefully we don&apos;t see this type of issue anymore.&lt;/p&gt;</comment>
                            <comment id="13030215" author="hudson" created="Sat, 7 May 2011 00:08:30 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1909 (See &lt;a href=&quot;https://builds.apache.org/hudson/job/HBase-TRUNK/1909/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/hudson/job/HBase-TRUNK/1909/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="15017715" author="lars_francke" created="Fri, 20 Nov 2015 12:44:08 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12470372" name="3431-v2.txt" size="3594" author="stack" created="Sat, 5 Feb 2011 21:17:34 +0000"/>
                            <attachment id="12470375" name="3431-v3.txt" size="6569" author="stack" created="Sat, 5 Feb 2011 22:22:32 +0000"/>
                            <attachment id="12470374" name="3431-v3.txt" size="6569" author="stack" created="Sat, 5 Feb 2011 22:20:47 +0000"/>
                            <attachment id="12470381" name="3431-v4.txt" size="6569" author="stack" created="Sun, 6 Feb 2011 04:36:59 +0000"/>
                            <attachment id="12467980" name="3431.txt" size="6799" author="stack" created="Tue, 11 Jan 2011 07:20:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 5 Feb 2011 23:18:39 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26858</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hm9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100868</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>