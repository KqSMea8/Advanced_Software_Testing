<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:03:43 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-15453/HBASE-15453.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-15453] [Performance] Considering reverting HBASE-10015 - reinstate synchronized in StoreScanner</title>
                <link>https://issues.apache.org/jira/browse/HBASE-15453</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10015&quot; title=&quot;Replace intrinsic locking with explicit locks in StoreScanner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10015&quot;&gt;&lt;del&gt;HBASE-10015&lt;/del&gt;&lt;/a&gt; back then I found that intrinsic locks (synchronized) in StoreScanner are slower that explicit locks.&lt;/p&gt;

&lt;p&gt;I was surprised by this. To make sure I added a simple perf test and many folks ran it on their machines. All found that explicit locks were faster.&lt;/p&gt;

&lt;p&gt;Now... I just ran that test again. On the latest JDK8 I find that now the intrinsic locks are significantly faster:&lt;br/&gt;
(OpenJDK Runtime Environment (build 1.8.0_72-b15))&lt;/p&gt;

&lt;p&gt;Explicit locks:&lt;br/&gt;
10 runs  mean:2223.6 sigma:72.29412147609237&lt;/p&gt;

&lt;p&gt;Intrinsic locks:&lt;br/&gt;
10 runs  mean:1865.3 sigma:32.63755505548784&lt;/p&gt;

&lt;p&gt;I confirmed the same with timing some Phoenix scans. We can save a bunch of time by changing this back &lt;/p&gt;

&lt;p&gt;Arrghhh... So maybe it&apos;s time to revert this now...?&lt;/p&gt;

&lt;p&gt;(Note that in trunk due to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;&apos;s work, we do not lock in StoreScanner anymore)&lt;/p&gt;

&lt;p&gt;I&apos;ll attach the perf test and a patch that changes lock to synchronized, if some folks could run this on 0.98, that&apos;d be great.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12949731">HBASE-15453</key>
            <summary>[Performance] Considering reverting HBASE-10015 - reinstate synchronized in StoreScanner</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="lhofhansl">Lars Hofhansl</assignee>
                                    <reporter username="lhofhansl">Lars Hofhansl</reporter>
                        <labels>
                    </labels>
                <created>Sun, 13 Mar 2016 22:57:44 +0000</created>
                <updated>Mon, 18 Jul 2016 21:31:44 +0000</updated>
                                                                            <component>Performance</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="15192559" author="lhofhansl" created="Sun, 13 Mar 2016 23:01:33 +0000"  >&lt;p&gt;Here&apos;s the patch with test.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;, and anybody else, if you guys have some time, could you apply this patch and run TestScanFilterPerformance?&lt;br/&gt;
Then undo the changes to StoreScanner and ReversedStoreScanner and run the test again.&lt;/p&gt;

&lt;p&gt;The test does some warm up, then runs the perf test 10 times and calculates mean and standard deviation.&lt;/p&gt;</comment>
                            <comment id="15192562" author="lhofhansl" created="Sun, 13 Mar 2016 23:13:36 +0000"  >&lt;p&gt;Another 4 runs:&lt;br/&gt;
Intrinsic:&lt;br/&gt;
10 runs  mean:1918.1 sigma:24.122396232547054&lt;br/&gt;
10 runs  mean:1898.5 sigma:22.531089631884207&lt;/p&gt;

&lt;p&gt;Explicit:&lt;br/&gt;
10 runs  mean:2164.2 sigma:21.48394749574668&lt;br/&gt;
10 runs  mean:2145.9 sigma:22.322410264126948&lt;/p&gt;</comment>
                            <comment id="15192726" author="lhofhansl" created="Mon, 14 Mar 2016 04:23:34 +0000"  >&lt;p&gt;Work machine (OpenJDK Runtime Environment (IcedTea 2.6.4) (7u95-2.6.4))&lt;br/&gt;
Intrinsic:&lt;br/&gt;
10 runs  mean:1749.9 sigma:25.76606295109907&lt;br/&gt;
10 runs  mean:1782.8 sigma:54.50100916496868&lt;/p&gt;

&lt;p&gt;Explicit:&lt;br/&gt;
10 runs  mean:1487.6 sigma:117.99169462296913&lt;br/&gt;
10 runs  mean:1479.6 sigma:41.01511916354749&lt;/p&gt;

&lt;p&gt;So on JDK7 the explicit locks are (still inexplicably) faster.&lt;/p&gt;</comment>
                            <comment id="15193701" author="lhofhansl" created="Mon, 14 Mar 2016 17:32:47 +0000"  >&lt;p&gt;What&apos;s the best way to just commit the perf test? I want to easily be able to run it without compiling and installing HBase somewhere.&lt;/p&gt;

&lt;p&gt;Right now it&apos;s a test that in its failure message displays the runtime. Any better way to do this? I suppose I could check in but comment the &amp;#64;test marker by default...?&lt;/p&gt;</comment>
                            <comment id="15194017" author="stack" created="Mon, 14 Mar 2016 19:51:20 +0000"  >&lt;p&gt;Yeah... remove the @Test... Add a main that calls your test on this class? You want to test a long scan? We have test of a 10k scan in PE. You want to run longer than this? The full 5M table?&lt;/p&gt;</comment>
                            <comment id="15194018" author="stack" created="Mon, 14 Mar 2016 19:52:32 +0000"  >&lt;p&gt;Marking Critical because seems like big benefit for simple change. I can try this later....&lt;/p&gt;</comment>
                            <comment id="15194697" author="lhofhansl" created="Tue, 15 Mar 2016 03:51:20 +0000"  >&lt;p&gt;Note that &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10015&quot; title=&quot;Replace intrinsic locking with explicit locks in StoreScanner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10015&quot;&gt;&lt;del&gt;HBASE-10015&lt;/del&gt;&lt;/a&gt; in had many folks confirm the numbers. Explicit locks were better back then.&lt;br/&gt;
Also note that with JDK7 tested at work, Explicit locks were still better.&lt;br/&gt;
Only with JDK8 at home did I find that intrinsic locks (synchronized) was better.&lt;/p&gt;

&lt;p&gt;It&apos;s not slam dunk, it depends on the JDK.&lt;/p&gt;</comment>
                            <comment id="15194725" author="lhofhansl" created="Tue, 15 Mar 2016 04:48:50 +0000"  >&lt;p&gt;For a Phoenix count&amp;#40;*) query on the JDK8 machine I measure a 7.5% end-to-end improvement.&lt;br/&gt;
I also tried the new JDK8 StampedLock, which should be better than ReentrantLock especially when not contended... Came to about the same as the intrinsic locks.&lt;/p&gt;</comment>
                            <comment id="15205211" author="apurtell" created="Mon, 21 Mar 2016 21:38:58 +0000"  >&lt;p&gt;The patch hurts a little on 7u and helps a little bit more on 8u on my open source laptop. Magnitude of difference will vary by CPU generation too I&apos;m sure.&lt;/p&gt;

&lt;p&gt;On Intel Core i5 CPU M 520  @ 2.40GHz (cpufreq governor userspace freq 2.40GHz)&lt;/p&gt;

&lt;p&gt;java version &quot;1.7.0_79&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_79-b15)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 24.79-b02, mixed mode)&lt;/p&gt;

&lt;p&gt;Without patch: 10 runs  mean:2077.1 sigma:91.84601243385582&lt;br/&gt;
With patch: 10 runs  mean:2782.6 sigma:116.52313075093717&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;java version &quot;1.8.0_60&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.8.0_60-b27)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 25.60-b23, mixed mode)&lt;/p&gt;

&lt;p&gt;Without patch: 10 runs  mean:2129.6 sigma:75.55289537800653&lt;br/&gt;
With patch: 10 runs  mean:1805.7 sigma:30.870860046328477&lt;/p&gt;</comment>
                            <comment id="15208984" author="lhofhansl" created="Wed, 23 Mar 2016 19:19:27 +0000"  >&lt;p&gt;So what do we do here?&lt;br/&gt;
I&apos;ll do one more test later... See how it compares to no memory fencing at all.&lt;/p&gt;

&lt;p&gt;So perf loss on JDK 7 is significant, so is the perf gain with JDK 8.&lt;/p&gt;</comment>
                            <comment id="15209184" author="stack" created="Wed, 23 Mar 2016 21:12:21 +0000"  >&lt;p&gt;JDK7 is dead.&lt;/p&gt;</comment>
                            <comment id="15209200" author="eclark" created="Wed, 23 Mar 2016 21:24:23 +0000"  >&lt;p&gt;Yay&lt;/p&gt;</comment>
                            <comment id="15209318" author="apurtell" created="Wed, 23 Mar 2016 22:33:51 +0000"  >&lt;p&gt;Agreed, make the change. We should all be advocating 8 runtimes. &lt;/p&gt;</comment>
                            <comment id="15381946" author="lhofhansl" created="Mon, 18 Jul 2016 09:09:47 +0000"  >&lt;p&gt;Alright shall I commit to all branches (except trunk, which removed the synchronization)?&lt;/p&gt;</comment>
                            <comment id="15383116" author="stack" created="Mon, 18 Jul 2016 21:31:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; yes&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12793220" name="15453-0.98.txt" size="8355" author="lhofhansl" created="Sun, 13 Mar 2016 23:01:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 14 Mar 2016 19:51:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            21 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ukqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>