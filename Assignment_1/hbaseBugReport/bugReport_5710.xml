<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:30:15 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5710/HBASE-5710.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5710] NPE in MiniCluster during metadata scan for a pre-split table with multiple column families</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5710</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In the MiniCluster test environment, an NPE occurs while scanning regions&lt;br/&gt;
of a pre-split table with multiple column families. Without this working&lt;br/&gt;
in the test environment, you cannot write unit tests for these types of&lt;br/&gt;
scenarios.&lt;/p&gt;

&lt;p&gt;Add the following to TestMetaScanner to repro:&lt;/p&gt;

&lt;p&gt;   @Test&lt;br/&gt;
   public void testMultiFamilyMultiRegionMetaScanner() throws Exception {&lt;br/&gt;
     LOG.info(&quot;Starting testMetaScanner&quot;);&lt;br/&gt;
     final byte[] TABLENAME = Bytes.toBytes(&quot;testMetaScanner&quot;);&lt;br/&gt;
     final byte[] FAMILY1 = Bytes.toBytes(&quot;family1&quot;);&lt;br/&gt;
     final byte[] FAMILY2 = Bytes.toBytes(&quot;family2&quot;);&lt;br/&gt;
     TEST_UTIL.createTable(TABLENAME, new byte[][] &lt;/p&gt;
{FAMILY1,FAMILY2}
&lt;p&gt;);&lt;br/&gt;
     Configuration conf = TEST_UTIL.getConfiguration();&lt;br/&gt;
     HTable table = new HTable(conf, TABLENAME);&lt;br/&gt;
     TEST_UTIL.createMultiRegions(conf, table, FAMILY1,&lt;br/&gt;
         new byte[][]&lt;/p&gt;
{
           HConstants.EMPTY_START_ROW,
           Bytes.toBytes(&quot;region_a&quot;),
           Bytes.toBytes(&quot;region_b&quot;)}
&lt;p&gt;);&lt;br/&gt;
     TEST_UTIL.createMultiRegions(conf, table, FAMILY2,&lt;br/&gt;
             new byte[][]&lt;/p&gt;
{
               HConstants.EMPTY_START_ROW,
               Bytes.toBytes(&quot;region_a&quot;),
               Bytes.toBytes(&quot;region_b&quot;)}
&lt;p&gt;);&lt;br/&gt;
     // Make sure all the regions are deployed&lt;br/&gt;
     TEST_UTIL.countRows(table);&lt;/p&gt;

&lt;p&gt;     // This fails with an NPE currently&lt;br/&gt;
     MetaScanner.allTableRegions(conf, TABLENAME, false).keySet();&lt;br/&gt;
     table.close();&lt;br/&gt;
   }&lt;/p&gt;

</description>
                <environment>&lt;p&gt;MiniCluster&lt;/p&gt;</environment>
        <key id="12549434">HBASE-5710</key>
            <summary>NPE in MiniCluster during metadata scan for a pre-split table with multiple column families</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="giacomotaylor">James Taylor</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Apr 2012 01:04:08 +0000</created>
                <updated>Sat, 11 Apr 2015 01:25:02 +0000</updated>
                            <resolved>Sat, 11 Apr 2015 01:25:02 +0000</resolved>
                                    <version>0.94.0</version>
                                                    <component>test</component>
                    <component>util</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13247641" author="lhofhansl" created="Thu, 5 Apr 2012 20:36:14 +0000"  >&lt;p&gt;I took a look. The problem is this:&lt;br/&gt;
The problem occurs because createMultiRegions tries to clean up the empty default region for an existing table. It does that by listing the existing regions and then deleting them &lt;b&gt;after&lt;/b&gt; the new regions were added.&lt;/p&gt;

&lt;p&gt;Since regions are per table, not per column family createMultiRegions should only be called &lt;b&gt;once&lt;/b&gt;, regardless of how many column families there are.&lt;/p&gt;

&lt;p&gt;So createMultiRegions really should not have columnFamily as parameter, this is pure convenience to add the column family if the table did not have it. IMHO it is more confusing than useful. And it should document that it should only be called once.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this necessarily needs to be fixed, though. In your case you create the table with the two column families and then just pass the first column family to a single call to createMultiRegions, which will set up the table&apos;s regions correctly:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testMultiFamilyMultiRegionMetaScanner() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Starting testMetaScanner&quot;&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] TABLENAME = Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;testMetaScanner&quot;&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] FAMILY1 = Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;family1&quot;&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] FAMILY2 = Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;family2&quot;&lt;/span&gt;);
    TEST_UTIL.createTable(TABLENAME, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[][] { FAMILY1, FAMILY2 });
    Configuration conf = TEST_UTIL.getConfiguration();
    HTable table = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTable(conf, TABLENAME);
    TEST_UTIL.createMultiRegions(conf, table, FAMILY1, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[][] { HConstants.EMPTY_START_ROW,
        Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;region_a&quot;&lt;/span&gt;), Bytes.toBytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;region_b&quot;&lt;/span&gt;) });
    TEST_UTIL.countRows(table);

    &lt;span class=&quot;code-comment&quot;&gt;// This fails with an NPE currently
&lt;/span&gt;    MetaScanner.allTableRegions(conf, TABLENAME, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).keySet();
    table.close();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 5 Apr 2012 20:36:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>234425</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02co7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>