<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:45:20 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-549/HBASE-549.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-549] Don&apos;t CLOSE region if message is not from server that opened it or is opening it</title>
                <link>https://issues.apache.org/jira/browse/HBASE-549</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We assign a region to a server.  It takes too long to open (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-505&quot; title=&quot;Region assignments should never time out so long as the region server reports that it is processing the open request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-505&quot;&gt;&lt;del&gt;HBASE-505&lt;/del&gt;&lt;/a&gt;).  Region gets assigned to another server.  Meantime original host returns a MSG_REPORT_CLOSE (because other regions opening messes it up moving files on disk out from under it).  We queue a shutdown which marks the region as needing reassignment.  Second server reports in that it successfully opened the region.  Master tells it it should not have opened it.  Churn ensues.&lt;/p&gt;

&lt;p&gt;Fix is to ignore the CLOSE if its reported server/startcode does not match that of the server currently trying to open region.  Fix is not easy because currently we don&apos;t keep list of server info in unassigned regions.&lt;/p&gt;

&lt;p&gt;Here&apos;s master log snippet showing problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
2008-03-25 19:16:43,711 INFO org.apache.hadoop.hbase.HMaster: assigning region enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 to server XX.XX.XX.220:60020
2008-03-25 19:16:46,725 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_PROCESS_OPEN : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.XX.220:60020
2008-03-25 19:18:06,411 DEBUG org.apache.hadoop.hbase.HMaster: shutdown scanner looking at enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:18:06,811 DEBUG org.apache.hadoop.hbase.HMaster: shutdown scanner looking at enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:19:46,841 INFO org.apache.hadoop.hbase.HMaster: assigning region enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 to server XX.XX.XX.221:60020
2008-03-25 19:19:49,849 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_PROCESS_OPEN : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.XX.221:60020
2008-03-25 19:19:56,883 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_CLOSE : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.XX.220:60020
2008-03-25 19:19:56,883 INFO org.apache.hadoop.hbase.HMaster: XX.XX.XX.220:60020 no longer serving regionname: enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482, startKey: &amp;lt;iLStZ0yTnfVUziYcNVVxWV==&amp;gt;, endKey: &amp;lt;jLB27Q4hKls4tSvp64rJfF==
&amp;gt;, encodedName: 1857033608, tableDesc: {name: enwiki_080103, families: {alternate_title:={name: alternate_title, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, alternate_url:={name: al
ternate_url, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, anchor:={name: anchor, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, mi
sc:={name: misc, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, page:={name: page, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, re
direct:={name: redirect, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}}
2008-03-25 19:19:56,885 DEBUG org.apache.hadoop.hbase.HMaster: Main processing loop: ProcessRegionClose of enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
2008-03-25 19:19:56,885 INFO org.apache.hadoop.hbase.HMaster: region closed: enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:19:56,887 INFO org.apache.hadoop.hbase.HMaster: reassign region: enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:19:57,288 INFO org.apache.hadoop.hbase.HMaster: assigning region enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 to server XX.XX.XX.189:60020
2008-03-25 19:20:00,296 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_PROCESS_OPEN : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.XX.189:60020
2008-03-25 19:20:16,885 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_OPEN : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.XX.221:60020
2008-03-25 19:20:16,885 DEBUG org.apache.hadoop.hbase.HMaster: region server XX.XX.XX.221:60020 should not have opened region enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:23:51,707 DEBUG org.apache.hadoop.hbase.HMaster: shutdown scanner looking at enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:23:51,834 DEBUG org.apache.hadoop.hbase.HMaster: shutdown scanner looking at enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:23:53,947 INFO org.apache.hadoop.hbase.HMaster: assigning region enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 to server XX.XX.XX.97:60020
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12392462">HBASE-549</key>
            <summary>Don&apos;t CLOSE region if message is not from server that opened it or is opening it</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="6">Invalid</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Mar 2008 15:58:40 +0000</created>
                <updated>Tue, 7 Dec 2010 20:32:02 +0000</updated>
                            <resolved>Tue, 7 Dec 2010 20:32:02 +0000</resolved>
                                    <version>0.16.0</version>
                    <version>0.1.0</version>
                    <version>0.1.1</version>
                    <version>0.2.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12582736" author="stack" created="Thu, 27 Mar 2008 17:02:47 +0000"  >&lt;p&gt;The close offlines the region and makes it so we reassign it though we have an outstanding assignment to 221.   Our knickers are now truely all in a twist.  In the mess of subsequent messages, the region never makes it back online (Later messages have the region deployed to new regionserver but the offline state wins through so its deployed but offlined).&lt;/p&gt;</comment>
                            <comment id="12582750" author="stack" created="Thu, 27 Mar 2008 17:53:35 +0000"  >&lt;p&gt;In response to a query from Jim, I actually cannot explicitly explain how the region went offline.  While this is a patched 0.16.0, it does have the patch that stops us reading offline flag from regioninfo that is passed over from the remote regionserver.  Below I include more logs from around the failing, logs that include the meta scan that show the region going from online to offline:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
2008-03-25 19:19:49,849 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_PROCESS_OPEN : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.45.221:60020
2008-03-25 19:19:56,883 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_CLOSE : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.45.220:60020
2008-03-25 19:19:56,883 INFO org.apache.hadoop.hbase.HMaster: XX.XX.45.220:60020 no longer serving regionname: enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482, startKey: &amp;lt;iLStZ0yTnfVUziYcNVVxWV==&amp;gt;, endKey: &amp;lt;jLB27Q4hKls4tSvp64rJfF==&amp;gt;, encodedName: 1857033608, tableDesc: {name: enwiki_080103, families: {alternate_title:={name: alternate_title, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, alternate_url:={name: alternate_url, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, anchor:={name: anchor, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, misc:={name: misc, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, page:={name: page, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, redirect:={name: redirect, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}}
2008-03-25 19:19:56,885 DEBUG org.apache.hadoop.hbase.HMaster: Main processing loop: ProcessRegionClose of enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
2008-03-25 19:19:56,885 INFO org.apache.hadoop.hbase.HMaster: region closed: enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 
2008-03-25 19:19:56,887 INFO org.apache.hadoop.hbase.HMaster: reassign region: enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:19:57,288 INFO org.apache.hadoop.hbase.HMaster: assigning region enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 to server XX.XX.45.189:60020
2008-03-25 19:20:00,296 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_PROCESS_OPEN : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.45.189:60020
2008-03-25 19:20:14,575 DEBUG org.apache.hadoop.hbase.HMaster: HMaster.metaScanner regioninfo: {regionname: enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482, startKey: &amp;lt;iLStZ0yTnfVUziYcNVVxWV==&amp;gt;, endKey: &amp;lt;jLB27Q4hKls4tSvp64rJfF==&amp;gt;, encodedName: 1857033608, offline: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, tableDesc: {name: enwiki_080103, families: {alternate_title:={name: alternate_title, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, alternate_url:={name: alternate_url, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, anchor:={name: anchor, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, misc:={name: misc, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, page:={name: page, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, redirect:={name: redirect, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}}}, server: , startCode: -1
2008-03-25 19:20:16,885 DEBUG org.apache.hadoop.hbase.HMaster: Received MSG_REPORT_OPEN : enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482 from XX.XX.45.221:60020
2008-03-25 19:20:16,885 DEBUG org.apache.hadoop.hbase.HMaster: region server XX.XX.45.221:60020 should not have opened region enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482
2008-03-25 19:21:16,118 DEBUG org.apache.hadoop.hbase.HMaster: HMaster.metaScanner regioninfo: {regionname: enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482, startKey: &amp;lt;iLStZ0yTnfVUziYcNVVxWV==&amp;gt;, endKey: &amp;lt;jLB27Q4hKls4tSvp64rJfF==&amp;gt;, encodedName: 1857033608, offline: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, tableDesc: {name: enwiki_080103, families: {alternate_title:={name: alternate_title, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, alternate_url:={name: alternate_url, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, anchor:={name: anchor, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, misc:={name: misc, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, page:={name: page, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, redirect:={name: redirect, max versions: 3, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}}}, server: , startCode: -1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The most interesting line is this one: &apos;2008-03-25 19:19:56,885 DEBUG org.apache.hadoop.hbase.HMaster: Main processing loop: ProcessRegionClose of enwiki_080103,iLStZ0yTnfVUziYcNVVxWV==,1205393076482, true, false&apos;&lt;/p&gt;

&lt;p&gt;That first &apos;true&apos; is saying that we&apos;re doing a close but the region is to be reassigned... &lt;/p&gt;</comment>
                            <comment id="12584293" author="jimk" created="Tue, 1 Apr 2008 20:33:51 +0000"  >&lt;p&gt;Won&apos;t fix for 0.1. Too complicated.&lt;/p&gt;</comment>
                            <comment id="12585865" author="jimk" created="Sat, 5 Apr 2008 01:56:34 +0000"  >&lt;p&gt;Is this still an issue since &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-505&quot; title=&quot;Region assignments should never time out so long as the region server reports that it is processing the open request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-505&quot;&gt;&lt;del&gt;HBASE-505&lt;/del&gt;&lt;/a&gt; was committed?&lt;/p&gt;</comment>
                            <comment id="12585872" author="stack" created="Sat, 5 Apr 2008 02:12:48 +0000"  >&lt;p&gt;Its less likely to happen but the mess it makes when it does happen makes for the kind of churn that gets us to offline regions in ways logging cannot explain&lt;/p&gt;</comment>
                            <comment id="12586042" author="stack" created="Sat, 5 Apr 2008 19:51:04 +0000"  >&lt;p&gt;Messages currently have Type and &apos;subject&apos; where subject is usually a HRI; splits reported to master IIRC carry the daughter regions.&lt;/p&gt;

&lt;p&gt;To fix this issue and others like it that may occur,missing is an Message &apos;source&apos;.  Would also be sweet if Messages could carry optional payload.  I&apos;m thinking of when a HRS sends a CLOSE, it could bundle the Exception that prompted the closing.  This way, could read the master log and get a sense of the whole cluster.&lt;/p&gt;

&lt;p&gt;So, a suggestion without having dug in to check that this suggestion is overkill would be to change HMsg to be something like the below interface in pseudo-code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; Message {
    ServerAddress getSource();
    &lt;span class=&quot;code-comment&quot;&gt;// Are all of our Messages always about a Region?
&lt;/span&gt;    HRI getSubject();
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; getType();
    Text getOptionalPayload();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The split message could subclass the above.&lt;/p&gt;

&lt;p&gt;Do we need an ID too?  Should IDs be monotonically increasing so message processing can be done in order?&lt;/p&gt;</comment>
                            <comment id="12586442" author="jimk" created="Mon, 7 Apr 2008 15:59:47 +0000"  >&lt;p&gt;So my current understanding of this issue is:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Taking too long to open should no longer be an issue because &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-505&quot; title=&quot;Region assignments should never time out so long as the region server reports that it is processing the open request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-505&quot;&gt;&lt;del&gt;HBASE-505&lt;/del&gt;&lt;/a&gt; has been addressed. (unless region server does not report in and its lease expires?)&lt;/li&gt;
	&lt;li&gt;We no longer offline regions if a region server cannot open it.&lt;/li&gt;
	&lt;li&gt;apparently we still see regions being offlined for some unexplained reason?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We discussed the idea that this issue and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-543&quot; title=&quot;A region&amp;#39;s state is kept in several places in the master opening the possibility for race conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-543&quot;&gt;&lt;del&gt;HBASE-543&lt;/del&gt;&lt;/a&gt; are related. After thinking about it, I agree.&lt;/p&gt;

&lt;p&gt;When the master receives a close message, it knows which region server sent it. If we were to combine this with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-543&quot; title=&quot;A region&amp;#39;s state is kept in several places in the master opening the possibility for race conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-543&quot;&gt;&lt;del&gt;HBASE-543&lt;/del&gt;&lt;/a&gt;, when we assign a region we could record in the &quot;region state&quot; which server it was assigned to and that would make it easy to determine if we should ignore the close message.&lt;/p&gt;

&lt;p&gt;So I am thinking that these two issues could be addressed together. Stack, do you want to take 543? I hadn&apos;t done much about it other than thinking about how to approach it, so I don&apos;t have a lot of time invested here. If we continue to work on two separate patches, it seems likely we are going to step on each other&apos;s toes. (Not to mention there are plenty of other issues to address).  If you want 543, take it and link to this issue.&lt;/p&gt;

&lt;p&gt;I do like the idea of HMsg carrying an exception as an optional parameter.&lt;/p&gt;</comment>
                            <comment id="12586459" author="stack" created="Mon, 7 Apr 2008 16:30:43 +0000"  >&lt;p&gt;I&apos;ll have a go at it.  I&apos;ll put up a proposal first over in 543.&lt;/p&gt;</comment>
                            <comment id="12613735" author="irubin" created="Tue, 15 Jul 2008 21:13:08 +0000"  >&lt;p&gt;It&apos;s hard to tell exactly what is going on, since (a) the code has changed a lot since the creation of this issue, and (b) it&apos;s very hard/rare to replicate this problem.  However, after looking at this issue for several hours, here&apos;s what I&apos;ve been able to glean:&lt;/p&gt;

&lt;p&gt;I think the basic steps going on are as follows:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We tell the ServerManager (working with HMaster) to start opening a region on a server.&lt;/li&gt;
	&lt;li&gt;The ServerManager won&apos;t mark the HRegionInfo object (region) as being online until it actually receives a success message from the server.  The server sends in periodic messages saying that it is working on opening the region (MSG_REPORT_PROCESS_OPEN), but this only extends the lease or time limit on the server.&lt;/li&gt;
	&lt;li&gt;For whatever reason (maybe the server goes out-of-touch for too long?), the master decides that the server is taking too long, and it asks a new server to start opening the region.  The old server sends a MSG_REPORT_CLOSE to the master (not totally sure why).&lt;/li&gt;
	&lt;li&gt;The ServerManager, in processing the MSG_REPORT_CLOSE from the old server, sees that the region was never assigned.  It therefore assumes that the intent of the close message is to either offline or delete the region, and a ProcessRegionClose object is created.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Beyond this I am unsure of what happens.  It seems to me that the ProcessRegionClose object would try to delete the region since (I think) it hasn&apos;t been marked for &quot;offline-ing,&quot; but that doesn&apos;t seem right.  Either way, it&apos;s my impression that the close message &lt;b&gt;will not&lt;/b&gt; lead to the region being reassigned.  I think this is a part of the code that might have changed since the issue was created.  The problem may still exist, but in a slightly different form?  The logs posted above show problems arising when the second server finally opens the region successfully - the master complains that this is wrong, that someone else should be opening the region.  Maybe now the problem would be different - the master would complain because it believes that nobody should have the region (since the close message offlined or deleted the region).  &lt;/p&gt;

&lt;p&gt;I want to be totally clear that my analysis is completely based on the old logs and on poking through the current code (without even running the code) - I apologize and expect that it isn&apos;t very accurate.&lt;/p&gt;

&lt;p&gt;Either way, it&apos;s clear that a lot of problems originate from the close message sent by the original (failed) server.  The master needs to be made &quot;smarter&quot; such that it would ignore a message if it&apos;s from someone who isn&apos;t currently processing the relevant region.  In essence, the master needs to know - for each region that is either open, being opened, or being closed - which server is responsible.  Or, if we really want to be minimalist and avoid overhead, just keep a mapping for all regions that are in the process of being opened.  Maybe RegionManager would be an appropriate place to keep this mappping.  As it is, RegionManager keeps a Set of all regions that are &quot;pending.&quot;  Perhaps all we would have to do is turn the Set into a Map, where the key is the region and the value is the server?  I&apos;m sure there are many other modifications that would work, but this one seems reasonable to me.&lt;/p&gt;</comment>
                            <comment id="12614014" author="stack" created="Wed, 16 Jul 2008 16:41:15 +0000"  >&lt;p&gt;Moving out of 0.2.  The scenario orginally reported should never happen because of refactorings; in particular the addition of the MSG_REPORT_PROCESS_OPEN keep-alive mechanism.  &lt;/p&gt;

&lt;p&gt;Would still be good to verify message origin jibes with who the master things the owner of the message target/region but we can do that later.&lt;/p&gt;

&lt;p&gt;Thanks for taking a look Izaak.&lt;/p&gt;</comment>
                            <comment id="12746345" author="stack" created="Fri, 21 Aug 2009 23:08:36 +0000"  >&lt;p&gt;Fix in 0.21 rewrite.&lt;/p&gt;</comment>
                            <comment id="12866972" author="stack" created="Thu, 13 May 2010 04:40:50 +0000"  >&lt;p&gt;Moved from 0.21 to 0.22 just after merge of old 0.20 branch into TRUNK.&lt;/p&gt;</comment>
                            <comment id="12968951" author="stack" created="Tue, 7 Dec 2010 20:32:02 +0000"  >&lt;p&gt;Master doesn&apos;t work like this any more.  Resolving as invalid.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12392212">HBASE-543</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12390792">HBASE-504</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 1 Apr 2008 20:33:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25258</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 2 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h7zb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98555</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>