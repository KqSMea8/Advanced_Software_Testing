<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:48:04 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-13932/HBASE-13932.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-13932] Add mob integrity check in HFilePrettyPrinter</title>
                <link>https://issues.apache.org/jira/browse/HBASE-13932</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We need to know whether a reference cell is dangling in mob. We can add this to HFilePrettyPrinter.&lt;br/&gt;
We can add a new option to the command, to check the integrity of mob cells either per region or per file.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12838715">HBASE-13932</key>
            <summary>Add mob integrity check in HFilePrettyPrinter</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12721032">HBASE-11339</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jingcheng.du@intel.com">Jingcheng Du</assignee>
                                    <reporter username="jingcheng.du@intel.com">Jingcheng Du</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Jun 2015 08:27:13 +0000</created>
                <updated>Wed, 22 Jul 2015 22:48:44 +0000</updated>
                            <resolved>Wed, 24 Jun 2015 03:54:20 +0000</resolved>
                                    <version>hbase-11339</version>
                                    <fixVersion>hbase-11339</fixVersion>
                                    <component>mob</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="14591481" author="jingcheng.du@intel.com" created="Thu, 18 Jun 2015 08:39:06 +0000"  >&lt;p&gt;Upload the patch.&lt;br/&gt;
Now we add a new option to the command, &quot;-i&quot;. It means the checking mob is enabled.&lt;br/&gt;
We can also indicate the -r (region) or -f (file) in the checking.&lt;br/&gt;
For example, run &quot;java HFile -i -r regionName&quot;, we can get the following output if the referenced mob files are missing.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR, the mob file [d41d8cd98f00b204e9800998ecf8427e20150618969dc85f0aa44fa584abad4aacc9866e] is missing referenced by cell row1/myCF:qual/1434612497744/Put/vlen=76/seqid=4
ERROR, the mob file [d41d8cd98f00b204e9800998ecf8427e20150618c2f9e0f7d86242e880612ae9499e4a0a] is missing referenced by cell row2/myCF:qual/1434612498023/Put/vlen=76/seqid=9
ERROR, the mob file [d41d8cd98f00b204e9800998ecf8427e20150618c2f9e0f7d86242e880612ae9499e4a0a] is missing referenced by cell row3/myCF:qual/1434612498026/Put/vlen=76/seqid=11
ERROR, the mob file [d41d8cd98f00b204e9800998ecf8427e20150618209c0d89cd8841cc81b2466a2bdf7c0e] is missing referenced by cell row4/myCF:qual/1434612498062/Put/vlen=76/seqid=16
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Alternatively, we can run the check per hfile, run &quot;java HFile -i -f hfilePath&quot;, we can get the following output.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR, the mob file [d41d8cd98f00b204e9800998ecf8427e20150618c2f9e0f7d86242e880612ae9499e4a0a] is missing referenced by cell row2/myCF:qual/1434612498023/Put/vlen=76/seqid=9
ERROR, the mob file [d41d8cd98f00b204e9800998ecf8427e20150618c2f9e0f7d86242e880612ae9499e4a0a] is missing referenced by cell row3/myCF:qual/1434612498026/Put/vlen=76/seqid=11
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmhsieh&quot; class=&quot;user-hover&quot; rel=&quot;jmhsieh&quot;&gt;Jonathan Hsieh&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anoopsamjohn&quot; class=&quot;user-hover&quot; rel=&quot;anoopsamjohn&quot;&gt;Anoop Sam John&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;, would you mind reviewing the patch? Thanks!&lt;/p&gt;</comment>
                            <comment id="14591663" author="bhupendra" created="Thu, 18 Jun 2015 11:30:38 +0000"  >&lt;p&gt;Few observations.&lt;br/&gt;
1) locations = new ArrayList&amp;lt;Path&amp;gt;();&lt;br/&gt;
&amp;gt;&amp;gt; Better initialize with size 2 (as of now only 2 locations)&lt;/p&gt;

&lt;p&gt;2) fs.exists(mobFilePath)&lt;br/&gt;
&amp;gt;&amp;gt; exists call may be costly (Not very sure). Should we have cache for mobFilePath.(Can be a HasHSet&amp;lt;Path&amp;gt; mobFileExistsCache)&lt;br/&gt;
   Many of the cells may be pointing to same mobFilePath. We can utilize this cache and avoid exists call.&lt;/p&gt;

&lt;p&gt;3) String mobFileName = MobUtils.getMobFileName(cell);&lt;br/&gt;
&amp;gt;&amp;gt; Any chance that mobFileName becomes NULL or Empty String ? I think, the case will not happen in practical until unless the hfile is corrupted. If the case happens, then &quot;new Path(location, mobFileName);&quot; will throw IllegalArgumentException. Do we need the NULL / Empty String check along with Error printing.&lt;/p&gt;

&lt;p&gt;Please excuse if observations are not correct.  &lt;/p&gt;</comment>
                            <comment id="14592874" author="jingcheng.du@intel.com" created="Fri, 19 Jun 2015 01:58:34 +0000"  >&lt;p&gt;Thanks a lot for comments!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Better initialize with size 2 (as of now only 2 locations)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Right, it&apos;s better to have a fixed size for list.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Many of the cells may be pointing to same mobFilePath. We can utilize this cache and avoid exists call.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s right, I had the same thought, I can add a cache for these file names.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Any chance that mobFileName becomes NULL or Empty String ? I think, the case will not happen in practical until unless the hfile is corrupted. If the case happens, then &quot;new Path(location, mobFileName);&quot; will throw IllegalArgumentException. Do we need the NULL / Empty String check along with Error printing.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I can add one more check to validate the cell value.&lt;/p&gt;</comment>
                            <comment id="14593042" author="jingcheng.du@intel.com" created="Fri, 19 Jun 2015 05:48:23 +0000"  >&lt;p&gt;Upload a new patch.&lt;br/&gt;
1. Validate the value format of reference cell.&lt;br/&gt;
2. Add cache to the visited mob files.&lt;br/&gt;
3. Add fixed size to the candidate locations of mob files.&lt;/p&gt;</comment>
                            <comment id="14593047" author="jingcheng.du@intel.com" created="Fri, 19 Jun 2015 05:53:39 +0000"  >&lt;p&gt;Re-attach the patch V2.&lt;/p&gt;</comment>
                            <comment id="14593246" author="jingcheng.du@intel.com" created="Fri, 19 Jun 2015 09:10:34 +0000"  >&lt;p&gt;Re-attach patch V2 to improve the cache implementation.&lt;/p&gt;</comment>
                            <comment id="14593317" author="bhupendra" created="Fri, 19 Jun 2015 10:56:55 +0000"  >&lt;p&gt;Thanks for addressing comments. New patch lgtm. &lt;/p&gt;

&lt;p&gt;Just one more change , can be done before commit.&lt;/p&gt;

&lt;p&gt;1) evictMobFilesIfNecessary(foundMobFiles, 50);&lt;br/&gt;
&amp;gt;&amp;gt; foundMobFiles are initalized with 100. So limit should be 100 or initialize with 50&lt;/p&gt;

&lt;p&gt;2) Query : As per current patch, cache scope is only per HFile. Can it be across HFile ( Global scope ) ?&lt;/p&gt;</comment>
                            <comment id="14597013" author="jingcheng.du@intel.com" created="Tue, 23 Jun 2015 02:23:24 +0000"  >&lt;p&gt;Thanks for comments.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;foundMobFiles are initalized with 100. So limit should be 100 or initialize with 50&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Right, I will correct this in a new patch&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;As per current patch, cache scope is only per HFile. Can it be across HFile ( Global scope ) ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There are not needs to cache it in a global scope. There is no way that a mob file is shared by multiple hfiles.&lt;/p&gt;</comment>
                            <comment id="14597035" author="jingcheng.du@intel.com" created="Tue, 23 Jun 2015 02:39:57 +0000"  >&lt;p&gt;Upload a new patch V3. Thanks.&lt;/p&gt;</comment>
                            <comment id="14597152" author="ram_krish" created="Tue, 23 Jun 2015 04:38:32 +0000"  >&lt;p&gt;LGTM. Just minor nit&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;options.addOption(&quot;i&quot;, &quot;checkMob&quot;, false, &quot;Print all cells whose mob files are missing&quot;);&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The option i is to indicate the integrity of mob? Or should it be &apos;m&apos; to say that checkMob?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Iterator&amp;lt;String&amp;gt; fnir = mobFileNames.iterator();&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Can this be fileNamesItr? Rest looks good to me. +1.&lt;/p&gt;</comment>
                            <comment id="14597193" author="jingcheng.du@intel.com" created="Tue, 23 Jun 2015 05:32:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;The option i is to indicate the integrity of mob? Or should it be &apos;m&apos; to say that checkMob?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;m is used for printMetadata. How about &quot;-mob&quot; as the option?&lt;/p&gt;</comment>
                            <comment id="14597249" author="jingcheng.du@intel.com" created="Tue, 23 Jun 2015 06:32:29 +0000"  >&lt;p&gt;Upload a new patch V4, thanks!&lt;/p&gt;</comment>
                            <comment id="14597320" author="ram_krish" created="Tue, 23 Jun 2015 08:12:02 +0000"  >&lt;p&gt;+1. Will wait for reviews before committing.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bhupendra&quot; class=&quot;user-hover&quot; rel=&quot;Bhupendra&quot;&gt;Bhupendra Kumar Jain&lt;/a&gt; Do you have any comments?&lt;/p&gt;</comment>
                            <comment id="14597353" author="bhupendra" created="Tue, 23 Jun 2015 08:44:37 +0000"  >&lt;p&gt;LGTM .. Thanks for addressing comments ... &lt;/p&gt;</comment>
                            <comment id="14598830" author="ram_krish" created="Wed, 24 Jun 2015 03:53:56 +0000"  >&lt;p&gt;Pushed to hbase-11339 branch. Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jingcheng.du%40intel.com&quot; class=&quot;user-hover&quot; rel=&quot;jingcheng.du@intel.com&quot;&gt;Jingcheng Du&lt;/a&gt; and thank for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bhupendra&quot; class=&quot;user-hover&quot; rel=&quot;Bhupendra&quot;&gt;Bhupendra Kumar Jain&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14637825" author="hudson" created="Wed, 22 Jul 2015 22:48:44 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK #6672 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/6672/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/6672/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13932&quot; title=&quot;Add mob integrity check in HFilePrettyPrinter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13932&quot;&gt;&lt;del&gt;HBASE-13932&lt;/del&gt;&lt;/a&gt; - Add mob integrity check in HFilePrettyPrinter (Jingcheng du) (ramkrishna: rev ba4ba32b0dd5166b1cc2862e55e5c1c6eacfdf43)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/io/hfile/HFilePrettyPrinter.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12740613" name="HBASE-13932-V2.patch" size="7043" author="jingcheng.du@intel.com" created="Fri, 19 Jun 2015 09:10:34 +0000"/>
                            <attachment id="12741202" name="HBASE-13932-V3.patch" size="7291" author="jingcheng.du@intel.com" created="Tue, 23 Jun 2015 02:39:57 +0000"/>
                            <attachment id="12741230" name="HBASE-13932-V4.patch" size="7393" author="jingcheng.du@intel.com" created="Tue, 23 Jun 2015 06:32:29 +0000"/>
                            <attachment id="12740343" name="HBASE-13932.patch" size="5300" author="jingcheng.du@intel.com" created="Thu, 18 Jun 2015 08:39:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 18 Jun 2015 11:30:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2g71z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>