<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:06:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3043/HBASE-3043.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3043] &apos;hbase-daemon.sh stop regionserver&apos; should kill compactions that are in progress</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3043</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;During rolling restarts, we&apos;ll occasionally get into a situation with our 100-node cluster where a RS stop takes 5-10 minutes.  The problem is that the RS is undergoing a compaction and won&apos;t stop until it is complete.  In a stop situation, it would be preferable to preempt the compaction, delete the newly-created compaction file, and try again once the cluster is restarted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12475264">HBASE-3043</key>
            <summary>&apos;hbase-daemon.sh stop regionserver&apos; should kill compactions that are in progress</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nspiegelberg">Nicolas Spiegelberg</assignee>
                                    <reporter username="nspiegelberg">Nicolas Spiegelberg</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Sep 2010 01:00:57 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:43 +0000</updated>
                            <resolved>Mon, 4 Oct 2010 17:54:15 +0000</resolved>
                                    <version>0.89.20100621</version>
                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12915612" author="jdcryans" created="Tue, 28 Sep 2010 04:33:20 +0000"  >&lt;p&gt;+1, although I don&apos;t think it&apos;s going to be included in 0924 unless the RC&apos;s sunk.&lt;/p&gt;</comment>
                            <comment id="12915862" author="nspiegelberg" created="Tue, 28 Sep 2010 18:15:32 +0000"  >&lt;p&gt;I&apos;m developing this patch against the 0.89 branch that we&apos;re running.  It should work fine with 0.90, but I just wanted to note that in case any problems occur&lt;/p&gt;</comment>
                            <comment id="12917275" author="nspiegelberg" created="Sun, 3 Oct 2010 02:44:53 +0000"  >&lt;p&gt;NOTE: The default writeCheckInterval of 10MB came out to about 2sec between checks on my system.  I choose a high number so minimize the performance impact on stores while maintaining a decently-responsive delay.&lt;/p&gt;</comment>
                            <comment id="12917308" author="pranavkhaitan" created="Sun, 3 Oct 2010 10:15:51 +0000"  >&lt;p&gt;Patch looks good!&lt;/p&gt;

&lt;p&gt;One possibility is to maintain the variable &apos;WriteState writestate&apos; as private and add a set method.&lt;/p&gt;

&lt;p&gt;Surprising that the following lock was never being unlocked before.&lt;br/&gt;
   void interruptIfNecessary() {&lt;br/&gt;
     if (lock.tryLock()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this.interrupt();&lt;br/&gt;
+      try 
{
+        this.interrupt();
+      }
&lt;p&gt; finally &lt;/p&gt;
{
+        lock.unlock();
+      }
&lt;p&gt;     }&lt;br/&gt;
   }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12917413" author="stack" created="Sun, 3 Oct 2010 22:04:02 +0000"  >&lt;p&gt;Looks grand to me Nicolas.  Answer Pranav above and then I&apos;ll commit.&lt;/p&gt;</comment>
                            <comment id="12917414" author="stack" created="Sun, 3 Oct 2010 22:08:22 +0000"  >&lt;p&gt;Oh, one thought, if we are interrupted, we do not seem to cleanup after ourselves.  Is the thought that cleanup happens when the region is next opened?&lt;/p&gt;</comment>
                            <comment id="12917423" author="nspiegelberg" created="Sun, 3 Oct 2010 22:41:42 +0000"  >&lt;p&gt;Pranav&apos;s comments: &lt;br/&gt;
1) On WriteState variable privacy: 6 of one, half-dozen of the other.  I made sure the WriteState variable was package private.  I was looking at possibly some more unit tests dealing with our write state, so I didn&apos;t want to write a bunch of accessors just to deal with unit tests.  In the unit test case, we don&apos;t really need to worry about synchronization either.  My thought was to add accessor methods if we&apos;re going to use it outside of a unit test.  Okay?&lt;br/&gt;
2) The lack of unlock() actually could have caused some extremely-rare deadlock conditions but only on exit, so no one&apos;s probably run across it.  Just mainly wanted to fix poor practice.&lt;/p&gt;

&lt;p&gt;Stack&apos;s comment:&lt;br/&gt;
Your thought is correct.  However, I do need to make a small change that I had done internally, but lost when I refactored.  This works because of some subtle interactions between server.stopRequested(), CompactSplitThread.lock, &amp;amp; HRegion.writeState.writesEnabled.  States that can happen:&lt;br/&gt;
1) We get the lock &amp;amp; interrupt compactionQueue.poll().  It throws an InterruptedException, which calls continue, which fails the next while() check, which finishes the close&lt;br/&gt;
2) We get the lock &amp;amp; interrupt, but the thread is somewhere between the poll() and the lock().  &lt;span class=&quot;error&quot;&gt;&amp;#91;In new patch&amp;#93;&lt;/span&gt; CompactSplitThread.run() queries stopRequested() immediately after getting the lock(), which skips the compact/split code to return to the while() check and ...&lt;br/&gt;
3) We don&apos;t get the lock.  HRegionServer.run() calls closeAllRegions(), which calls HRegion.close(), which sets the writeState.  The compaction sees this, throws an InterruptedIOE, which is aborts the current compaction, goes to the while() check in CompactSplitThread.run() and ...&lt;/p&gt;</comment>
                            <comment id="12917430" author="pranavkhaitan" created="Sun, 3 Oct 2010 23:47:00 +0000"  >&lt;p&gt;Nicolas: great catch about that lock! That may have led to a deadlock&lt;br/&gt;
The access issue can be ignored as it was just a trivial thing.&lt;/p&gt;</comment>
                            <comment id="12917431" author="nspiegelberg" created="Sun, 3 Oct 2010 23:49:09 +0000"  >&lt;p&gt;Patches, updated after peer review.  Also changed closeCheckInterval to static to fix TestHeapSize (no current reason for it to be per-instance)&lt;/p&gt;</comment>
                            <comment id="12917678" author="stack" created="Mon, 4 Oct 2010 17:49:40 +0000"  >&lt;p&gt;@Nicolas Excellent... Let me apply (running tests now to check nothing broke)&lt;/p&gt;</comment>
                            <comment id="12917681" author="stack" created="Mon, 4 Oct 2010 17:54:15 +0000"  >&lt;p&gt;Committed.  Thanks for the sweet patch Nicolas.&lt;/p&gt;</comment>
                            <comment id="12919385" author="kannanm" created="Fri, 8 Oct 2010 21:30:05 +0000"  >&lt;p&gt;I love how this patch also speeds up operations like table disables, region reassignments etc. which might otherwise be stuck on compactions to finish.&lt;/p&gt;</comment>
                            <comment id="15016783" author="lars_francke" created="Fri, 20 Nov 2015 12:40:43 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12456291">HBASE-2228</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12456258" name="HBASE-3043_0.89.patch" size="13483" author="nspiegelberg" created="Sun, 3 Oct 2010 23:49:09 +0000"/>
                            <attachment id="12456259" name="HBASE-3043_0.90.patch" size="13318" author="nspiegelberg" created="Sun, 3 Oct 2010 23:49:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 28 Sep 2010 04:33:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32882</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hkh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100579</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>