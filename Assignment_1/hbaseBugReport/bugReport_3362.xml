<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:09:34 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3362/HBASE-3362.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3362] If .META. offline between OPENING and OPENED, then wrong server location in .META. is possible</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3362</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;This is a good one.  It happened to me testing OOME in split logging.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Balancer moves region to new location, regionservrer X.&lt;/li&gt;
	&lt;li&gt;New location regionserver X successfully opens the region and then goes to update .META.&lt;/li&gt;
	&lt;li&gt;At this point, the server carrying .META. crashes.&lt;/li&gt;
	&lt;li&gt;Regionserver X is stuck waiting on .META. to come back online.  It takes so long master times out the region-in-transition&lt;/li&gt;
	&lt;li&gt;Master assigns the region elsewhere to regionserver Y&lt;/li&gt;
	&lt;li&gt;It opens successfully on regionserver Y and then it also parks waiting on .META. coming online&lt;/li&gt;
	&lt;li&gt;.META. comes online&lt;/li&gt;
	&lt;li&gt;The two servers X and Y race to update .META.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I saw case where server X edit went in after server Ys edit which means that lookups in .META. get the wrong server.  HBCK can detect this situation.&lt;/p&gt;

&lt;p&gt;RegionServer X when it wakes up coreeclty notices that its lost control of the region but the damage is done &amp;#8211; where damage is .META. edit.&lt;/p&gt;

&lt;p&gt;Chatting with Jon, he suggested that regionserver X should &apos;rollback&apos; the .META. edit &amp;#8211; do explicit delete of what it added.  This would work I think but chatting more, I&apos;ll make a fix that keeps updating the zookeeper OPENING state while edit goes on in a separate thread.  Our continuous setting of OPENING will make it so region-in-transition does not timeout.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12493361">HBASE-3362</key>
            <summary>If .META. offline between OPENING and OPENED, then wrong server location in .META. is possible</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Dec 2010 20:50:18 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:30 +0000</updated>
                            <resolved>Fri, 17 Dec 2010 05:42:15 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12971896" author="hbasereviewboard" created="Thu, 16 Dec 2010 00:17:03 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1298/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase and Jonathan Gray.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;M src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
 Removed stale comments and TODOs.&lt;/p&gt;

&lt;p&gt; Added a &apos;version&apos; datamenber, the znode edit version which we keep across open process.&lt;/p&gt;

&lt;p&gt; Refactored the setting of OPENING out into a method that is used in multiple places &lt;br/&gt;
 now rather than repeat code.  Did this in new tickleOpening method.&lt;/p&gt;

&lt;p&gt; Added new PostOpenDeployTasksThread which we run to do the postOpenDeployTasks.&lt;br/&gt;
 While its running we update OPENING state if its running a while.&lt;/p&gt;


&lt;p&gt;This addresses bug hbase-3362.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/hbase-3362&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/hbase-3362&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java 1049707 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1298/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Ran it on my cluster. Seems to work as the old code did.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;stack&lt;/p&gt;

</comment>
                            <comment id="12971997" author="hbasereviewboard" created="Thu, 16 Dec 2010 08:17:04 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1298/#review2083&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#review2083&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;a few small comments.  i think the loop should change as described in my comment (busy loop w/ call to currentTimeMillis as i read it).  otherwise +1, good stuff.  we need some tickle util class soon &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;


&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/#comment6529&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#comment6529&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    &quot;on this server&quot; should probably be left in comment to be clear what this is checking&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/#comment6530&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#comment6530&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    We were not previously but we should probably log this condition&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/#comment6531&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#comment6531&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    This is a busy wait loop?&lt;/p&gt;

&lt;p&gt;    Should we add a wait/notify on something passed to the thread and w/ a timeout of the period?&lt;/p&gt;

&lt;p&gt;    And then we should probably also have some kind of max timeout.  Even if minutes, there could be weird cluster state where the RS misses META availability but someone else might handle it properly, so max timeout might be good?&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/#comment6533&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#comment6533&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    whitespace&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/#comment6532&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#comment6532&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    maybe this should be warn.  i think i&apos;d want to see it and also logging of stack trace (i don&apos;t see logging of it elsewhere)&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12972162" author="hbasereviewboard" created="Thu, 16 Dec 2010 17:59:03 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-12-16 00:14:36, Jonathan Gray wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java, line 96&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line96&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line96&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     We were not previously but we should probably log this condition&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We do in the method?&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-12-16 00:14:36, Jonathan Gray wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java, line 173&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line173&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line173&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     This is a busy wait loop?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Should we add a wait/notify on something passed to the thread and w/ a timeout of the period?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     And then we should probably also have some kind of max timeout.  Even if minutes, there could be weird cluster state where the RS misses META availability but someone else might handle it properly, so max timeout might be good?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I need to add a small sleep.  I&apos;d rather do this than wait/notify.  t.isAlive should be enough.  Regards max timeout, I should add check if server is stopped ... and for max timeout, what you think?  Ten minutes?  Then abort?&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-12-16 00:14:36, Jonathan Gray wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java, line 238&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line238&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line238&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     maybe this should be warn.  i think i&apos;d want to see it and also logging of stack trace (i don&apos;t see logging of it elsewhere)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For sure.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1298/#review2083&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#review2083&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12972164" author="hbasereviewboard" created="Thu, 16 Dec 2010 18:03:01 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-12-16 00:14:36, Jonathan Gray wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java, line 96&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line96&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line96&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     We were not previously but we should probably log this condition&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We do in the method?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yeah you&apos;re right, thought that was only on the exception.  nvm.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-12-16 00:14:36, Jonathan Gray wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java, line 173&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line173&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line173&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     This is a busy wait loop?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Should we add a wait/notify on something passed to the thread and w/ a timeout of the period?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     And then we should probably also have some kind of max timeout.  Even if minutes, there could be weird cluster state where the RS misses META availability but someone else might handle it properly, so max timeout might be good?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I need to add a small sleep.  I&apos;d rather do this than wait/notify.  t.isAlive should be enough.  Regards max timeout, I should add check if server is stopped ... and for max timeout, what you think?  Ten minutes?  Then abort?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was thinking 5 minutes.&lt;/p&gt;

&lt;p&gt;How long you going to sleep for?  That seems like an unideal way to do this.  I would prefer wait/notify and have timeout on wait be this 1/3 period, but small sleep could work.  If really small, we&apos;re in busy loop again.  If too big, we increase how long we have to wait.  This is on critical path of every single region open.&lt;/p&gt;

&lt;p&gt;If we go down path of threads doing work, I don&apos;t see why we don&apos;t want to use wait/notify to let the blocked thread know when it&apos;s done.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1298/#review2083&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#review2083&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12972172" author="hbasereviewboard" created="Thu, 16 Dec 2010 18:17:01 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-12-16 00:14:36, Jonathan Gray wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java, line 173&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line173&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/diff/1/?file=18309#file18309line173&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     This is a busy wait loop?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Should we add a wait/notify on something passed to the thread and w/ a timeout of the period?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     And then we should probably also have some kind of max timeout.  Even if minutes, there could be weird cluster state where the RS misses META availability but someone else might handle it properly, so max timeout might be good?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I need to add a small sleep.  I&apos;d rather do this than wait/notify.  t.isAlive should be enough.  Regards max timeout, I should add check if server is stopped ... and for max timeout, what you think?  Ten minutes?  Then abort?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Jonathan Gray wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I was thinking 5 minutes.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;How long you going to sleep for?  That seems like an unideal way to do this.  I would prefer wait/notify and have timeout on wait be this 1/3 period, but small sleep could work.  If really small, we&apos;re in busy loop again.  If too big, we increase how long we have to wait.  This is on critical path of every single region open.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;If we go down path of threads doing work, I don&apos;t see why we don&apos;t want to use wait/notify to let the blocked thread know when it&apos;s done.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;5 minute is not enough.  IIRC, it was &amp;gt; 5 minutes before the region came back online.  Let me see.&lt;/p&gt;

&lt;p&gt;I want to avoid mother thread depending on daughter thread signaling it to stop... seems redundant when I&apos;m watching the daughter with the isAlive already.&lt;/p&gt;

&lt;p&gt;The sleep would be short.  1ms or so.  Normally we&apos;d not trip into the sleep.  The operation will have compeleted before we have chance to sleep.  It&apos;d only sleep when no progress can be made.&lt;/p&gt;

&lt;p&gt;I&apos;ll add wait/notify for you to get this patch cleared past review, np.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1298/#review2083&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#review2083&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12972321" author="hbasereviewboard" created="Fri, 17 Dec 2010 01:03:01 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1298/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-12-16 17:01:04.757304)&lt;/p&gt;


&lt;p&gt;Review request for hbase and Jonathan Gray.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;I implemented Jon&apos;s suggestions and then some.  Not pretty but works in my local and cluster testing.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;M src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
 Removed stale comments and TODOs.&lt;/p&gt;

&lt;p&gt; Added a &apos;version&apos; datamenber, the znode edit version which we keep across open process.&lt;/p&gt;

&lt;p&gt; Refactored the setting of OPENING out into a method that is used in multiple places &lt;br/&gt;
 now rather than repeat code.  Did this in new tickleOpening method.&lt;/p&gt;

&lt;p&gt; Added new PostOpenDeployTasksThread which we run to do the postOpenDeployTasks.&lt;br/&gt;
 While its running we update OPENING state if its running a while.&lt;/p&gt;


&lt;p&gt;This addresses bug hbase-3362.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/hbase-3362&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/hbase-3362&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java 1050086 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.cloudera.org/r/1298/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Ran it on my cluster. Seems to work as the old code did.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;stack&lt;/p&gt;

</comment>
                            <comment id="12972331" author="hbasereviewboard" created="Fri, 17 Dec 2010 01:15:01 +0000"  >&lt;p&gt;Message from: &quot;Jonathan Gray&quot; &amp;lt;jgray@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.cloudera.org/r/1298/#review2103&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#review2103&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;it&apos;s getting pretty crazy but this looks good.&lt;/p&gt;

&lt;p&gt;it&apos;s unfortunate we have all these extra node transitioning methods inside this class.  this pattern of doing node transitions and tracking expected version is very common and we&apos;ll probably have more of it so we should look at doing some kind of generic abstraction for that pattern soon.&lt;/p&gt;

&lt;p&gt;+1 for commit, thanks for the changes&lt;/p&gt;


&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/#comment6561&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#comment6561&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    typo &apos;initalizes&apos; but good comment&lt;/p&gt;



&lt;p&gt;trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.cloudera.org/r/1298/#comment6562&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.cloudera.org/r/1298/#comment6562&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    interesting thing is... we only use this progressable if we do a log replay.  in that case, a region open is not really idempotent as we treat it here.&lt;/p&gt;

&lt;p&gt;    outside scope of this jira but something to think about.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Jonathan&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12972360" author="stack" created="Fri, 17 Dec 2010 05:42:15 +0000"  >&lt;p&gt;Committed branch and trunk.  Thanks for review Jon.  I tested it more up on cluster and seems to be doing at least what old stuff used to.  Yes to pulling out this code and generalizing it.  For instance guava SimpleTimeLimiter looks useful but has its own semantics and you pass Callable.  Might be worth going that route with a generalized soln.&lt;/p&gt;</comment>
                            <comment id="12974513" author="hudson" created="Thu, 23 Dec 2010 04:31:49 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1697 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/HBase-TRUNK/1697/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://hudson.apache.org/hudson/job/HBase-TRUNK/1697/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="15017267" author="lars_francke" created="Fri, 20 Nov 2015 12:42:30 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 16 Dec 2010 00:17:03 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hlxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100816</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>