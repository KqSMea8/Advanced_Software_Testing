<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:16:06 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-10673/HBASE-10673.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-10673] [replication] Recovering a large number of queues can cause OOME</title>
                <link>https://issues.apache.org/jira/browse/HBASE-10673</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Recently we had an accidental shutdown of approx 400 RegionServers in our cluster. Our cluster runs master-master replication to our secondary datacenter. Once we got the nodes sorted out and added back to the cluster, we noticed RSes continuing to die from OOMExceptions. Investigating the heap dumps from the dead RSes I found them full of WALEdits, and a lot of ReplicationSource threads generated by the NodeFailoverWorker replicating a lot of queues for the dead RSes.&lt;/p&gt;

&lt;p&gt;After doing some digging into the code and with a lot of help from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdcryans&quot; class=&quot;user-hover&quot; rel=&quot;jdcryans&quot;&gt;Jean-Daniel Cryans&lt;/a&gt; we found that it is possible for the node failover process in a very few regionservers to pick up the majority of queues when a lot of RSes die simultaneously. This causes a lot of HLogs to be opened and read simultaneously, thus overflowing the heap.&lt;/p&gt;

&lt;p&gt;as per &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdcryans&quot; class=&quot;user-hover&quot; rel=&quot;jdcryans&quot;&gt;Jean-Daniel Cryans&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Well there&apos;s a race to grab the queues to recover, and the surviving region servers are just scanning the znode with all the RS to try to determine which ones are dead (and when it finds a dead one it forks off a NodeFailoverWorker) so that if one RS got the notification that one RS died but in reality a bunch of them died, it could win a lot of those races.&lt;/p&gt;

&lt;p&gt;My guess is after that one died, its queues were redistributed, and maybe you had another hero RS, but as more and more died the queues eventually got manageable since a single RS cannot win all the races. Something like this:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;400 die, one RS manages to grab 350&lt;/li&gt;
	&lt;li&gt;That RS dies, one other RS manages to grab 300 of the 350 (the other queues going to other region servers)&lt;/li&gt;
	&lt;li&gt;That second RS dies, hero #3 grabs 250&lt;br/&gt;
etc.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;We don&apos;t have the concept of a limit of recovered queues, less so the concept of respecting it. Aggregating the queues into one is one solution, but it would perform poorly as show with your use case where one region server would be responsible to replicate the data for 300 others. It would scale better if the queues were more evenly distributed (and it was the original intent, except that in practice the dynamics are different).&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="12698744">HBASE-10673</key>
            <summary>[replication] Recovering a large number of queues can cause OOME</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ianfriedman">Ian Friedman</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Mar 2014 21:47:06 +0000</created>
                <updated>Mon, 30 Jun 2014 17:03:39 +0000</updated>
                                            <version>0.94.5</version>
                                                    <component>Replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="14047818" author="lhofhansl" created="Mon, 30 Jun 2014 16:32:20 +0000"  >&lt;p&gt;Just came across this. Seems serious.&lt;/p&gt;</comment>
                            <comment id="14047853" author="apurtell" created="Mon, 30 Jun 2014 17:03:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;We don&apos;t have the concept of a limit of recovered queues,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Seems the solution is for each RS to limit the concurrency of their recovery actions to something reasonable. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 30 Jun 2014 16:32:20 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>377092</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 24 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1sz9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>377387</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>