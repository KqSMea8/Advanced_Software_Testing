<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:21:26 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-17125/HBASE-17125.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-17125] Inconsistent result when use filter to read data</title>
                <link>https://issues.apache.org/jira/browse/HBASE-17125</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Assume a cloumn&apos;s max versions is 3, then we write 4 versions of this column. The oldest version doesn&apos;t remove immediately. But from the user view, the oldest version has gone. When user use a filter to query, if the filter skip a new version, then the oldest version will be seen again. But after compact the region, then the oldest version will never been seen. So it is weird for user. The query will get inconsistent result before and after region compaction.&lt;/p&gt;

&lt;p&gt;The reason is matchColumn method of UserScanQueryMatcher. It first check the cell by filter, then check the number of versions needed. So if the filter skip the new version, then the oldest version will be seen again when it is not removed.&lt;/p&gt;

&lt;p&gt;Have a discussion offline with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Apache9&quot; class=&quot;user-hover&quot; rel=&quot;Apache9&quot;&gt;Duo Zhang&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fenghh&quot; class=&quot;user-hover&quot; rel=&quot;fenghh&quot;&gt;Honghua Feng&lt;/a&gt;, now we have two solution for this problem. The first idea is check the number of versions first, then check the cell by filter. As the comment of setFilter, the filter is called after all tests for ttl, column match, deletes and max versions have been run.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  /**
   * Apply the specified server-side filter when performing the Query.
   * Only {@link Filter#filterKeyValue(Cell)} is called AFTER all tests
   * &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ttl, column match, deletes and max versions have been run.
   * @param filter filter to run on the server
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; invocation chaining
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Query setFilter(Filter filter) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.filter = filter;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But this idea has another problem, if a column&apos;s max version is 5 and the user query only need 3 versions. It first check the version&apos;s number, then check the cell by filter. So the cells number of the result may less than 3. But there are 2 versions which don&apos;t read anymore.&lt;/p&gt;

&lt;p&gt;So the second idea has three steps.&lt;br/&gt;
1. check by the max versions of this column&lt;br/&gt;
2. check the kv by filter&lt;br/&gt;
3. check the versions which user need.&lt;br/&gt;
But this will lead the ScanQueryMatcher more complicated. And this will break the javadoc of Query.setFilter.&lt;/p&gt;

&lt;p&gt;Now we don&apos;t have a final solution for this problem. Suggestions are welcomed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13021710">HBASE-17125</key>
            <summary>Inconsistent result when use filter to read data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="zghaobac">Guanghao Zhang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Nov 2016 08:55:17 +0000</created>
                <updated>Mon, 28 Nov 2016 06:09:16 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                <comments>
                            <comment id="15676213" author="zghaobac" created="Fri, 18 Nov 2016 09:01:06 +0000"  >&lt;p&gt;Upload a test example for this problem.&lt;/p&gt;</comment>
                            <comment id="15682336" author="apache9" created="Mon, 21 Nov 2016 03:06:58 +0000"  >&lt;p&gt;I prefer the simple &apos;check versions then check filter&apos; fix, but I&apos;m not sure if some daughter projects need the old behavior.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; Does Phoenix need the old behavior where maxVersions is a limit for the whole result, not the result before filtering?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15682424" author="apurtell" created="Mon, 21 Nov 2016 03:58:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=giacomotaylor&quot; class=&quot;user-hover&quot; rel=&quot;giacomotaylor&quot;&gt;James Taylor&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="15688628" author="apache9" created="Wed, 23 Nov 2016 02:15:57 +0000"  >&lt;p&gt;Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=giacomotaylor&quot; class=&quot;user-hover&quot; rel=&quot;giacomotaylor&quot;&gt;James Taylor&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15699795" author="apurtell" created="Sun, 27 Nov 2016 14:48:11 +0000"  >&lt;p&gt;Let&apos;s wait a week due to the thanksgiving holiday in the US, then proceed as you like if still no response. We can run the Phoenix unit test suite with a patched HBase to check if they are obviously affected. &lt;/p&gt;</comment>
                            <comment id="15700590" author="apache9" created="Mon, 28 Nov 2016 00:46:33 +0000"  >&lt;p&gt;Fine. Thanks.&lt;/p&gt;</comment>
                            <comment id="15700952" author="ram_krish" created="Mon, 28 Nov 2016 05:19:54 +0000"  >&lt;p&gt;I think this was discussed previouly also. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt; had some similar thoughts. But I think not only down stream projects but many user apps may be running with the current logic. If we change it then it could have a bigger impact. &lt;br/&gt;
May be we should introduce the new one as a toggle or by allowing user to configure this new ScanTracker? Am not sure on the best soln but just saying.&lt;/p&gt;</comment>
                            <comment id="15700963" author="apache9" created="Mon, 28 Nov 2016 05:26:10 +0000"  >&lt;p&gt;I think we can do it for 2.0 only.&lt;/p&gt;

&lt;p&gt;The old logic is not stable, I do not think we should let user depend on a broken semantic anymore, especially that we never guarantee this in the documentation.&lt;/p&gt;</comment>
                            <comment id="15700978" author="lhofhansl" created="Mon, 28 Nov 2016 05:32:19 +0000"  >&lt;p&gt;Simply put: There &lt;em&gt;is&lt;/em&gt; no right order in which to evaluate filters, versions, column tracking, and deletes. Regardless of which order you pick someone will complain about it. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;This has changed various times in the past. I think we should stick with how it is. If filters can see versions they can act accordingly (and filter extra versions if needed). If filters do not see all version, but you happen to need to look at all versions... Well then you&apos;d be out of luck if we make this change.&lt;/p&gt;

&lt;p&gt;See also &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13094&quot; title=&quot;Consider Filters that are evaluated before deletes and see delete markers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13094&quot;&gt;HBASE-13094&lt;/a&gt;. That one is about the order of filters w.r.t. delete markers.&lt;/p&gt;

&lt;p&gt;I guess, in hindsight for maximum flexibility filters should have been placed before everything else so that they can be used to intervene into the entire pipeline.&lt;/p&gt;</comment>
                            <comment id="15701045" author="apache9" created="Mon, 28 Nov 2016 06:09:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-13094&quot; title=&quot;Consider Filters that are evaluated before deletes and see delete markers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-13094&quot;&gt;HBASE-13094&lt;/a&gt; aims to add a new type of filter right? This issue aims to solve the problem for the current fiter implementation.&lt;/p&gt;

&lt;p&gt;And I need to speak again, the old &apos;filter then check verions&apos; is not stable. The same request can return different results only if there is a major compaction. This is a bug and we need to fix it.&lt;/p&gt;

&lt;p&gt;And the biggest problem here, is the semantic of setMaxVerions. In the javadoc of setFilter method, the max versions check should be evaluated before filtering but the current implementation is more likely a limitation of the final result. This leads to two approaches to fix the bug, one is try to break our javadoc and the new implementation will be more complicated, but can keep compatible with the old implementation as much as possible. The other is to change the implementation according to our javadoc, the fix is simple and straight-forward.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12839529" name="example.diff" size="3720" author="zghaobac" created="Fri, 18 Nov 2016 09:01:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 21 Nov 2016 03:06:58 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36hwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>