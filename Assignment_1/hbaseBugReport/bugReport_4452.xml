<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:19:02 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4452/HBASE-4452.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4452] Possibility of RS opening a region though tickleOpening fails due to znode version mismatch</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4452</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Consider the following code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; period = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(1, assignmentTimeout/ 3);
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; lastUpdate = now;
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!signaller.get() &amp;amp;&amp;amp; t.isAlive() &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.server.isStopped() &amp;amp;&amp;amp;
        !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.rsServices.isStopping() &amp;amp;&amp;amp; (endTime &amp;gt; now)) {
      &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; elapsed = now - lastUpdate;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (elapsed &amp;gt; period) {
        &lt;span class=&quot;code-comment&quot;&gt;// Only tickle OPENING &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; postOpenDeployTasks is taking some time.
&lt;/span&gt;        lastUpdate = now;
        tickleOpening(&lt;span class=&quot;code-quote&quot;&gt;&quot;post_open_deploy&quot;&lt;/span&gt;);
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Whenever the postopenDeploy tasks takes considerable time we try to tickleOpening so that there is no timeout deducted.  But before it could do this if the TimeoutMonitor tries to assign the node to another RS then the other RS will move the node from OFFLINE to OPENING.  Hence when the first RS tries to do tickleOpening the operation will fail. Now here lies the problem,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; encodedName = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo.getEncodedName();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.version =
        ZKAssign.retransitionNodeOpening(server.getZooKeeper(),
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionInfo, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.server.getServerName(), &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.version);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException e) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Now this.version becomes -1 as the operation failed.&lt;br/&gt;
Now as in the first code snippet as the return type is not captured after tickleOpening() fails we go on with moving the node to OPENED.  Here again we dont have any check for this condition as already the version has been changed to -1.  Hence the OPENING to OPENED becomes successful. Chances of double assignment.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2011-09-22 00:57:29,930 WARN org.apache.hadoop.hbase.zookeeper.ZKAssign: regionserver:60020-0x1328ceaa1ff000d Attempt to transition the unassigned node for 69797d064f773d1aa9adba56e7ff90a3 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENING failed, the node existed but was version 5 not the expected version 2
2011-09-22 00:57:33,494 WARN org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Failed refreshing OPENING; region=69797d064f773d1aa9adba56e7ff90a3, context=post_open_deploy
2011-09-22 00:58:02,356 DEBUG org.apache.hadoop.hbase.zookeeper.ZKAssign: regionserver:60020-0x1328ceaa1ff000d Attempting to transition node 69797d064f773d1aa9adba56e7ff90a3 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENED
2011-09-22 00:58:11,853 DEBUG org.apache.hadoop.hbase.zookeeper.ZKAssign: regionserver:60020-0x1328ceaa1ff000d Successfully transitioned node 69797d064f773d1aa9adba56e7ff90a3 from RS_ZK_REGION_OPENING to RS_ZK_REGION_OPENED
2011-09-22 00:58:13,956 DEBUG org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler: Opened t9,,1316633193606.69797d064f773d1aa9adba56e7ff90a3.

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Correct me if this analysis is wrong.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12523865">HBASE-4452</key>
            <summary>Possibility of RS opening a region though tickleOpening fails due to znode version mismatch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ram_krish">ramkrishna.s.vasudevan</assignee>
                                    <reporter username="ram_krish">ramkrishna.s.vasudevan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Sep 2011 13:30:34 +0000</created>
                <updated>Fri, 20 Nov 2015 11:54:23 +0000</updated>
                            <resolved>Thu, 22 Sep 2011 23:10:25 +0000</resolved>
                                                    <fixVersion>0.90.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                <comments>
                            <comment id="13109505" author="yuzhihong@gmail.com" created="Wed, 21 Sep 2011 13:46:26 +0000"  >&lt;p&gt;Good catch, Ramkrishna.&lt;br/&gt;
This is the only place where return value from tickleOpening() isn&apos;t checked.&lt;/p&gt;</comment>
                            <comment id="13109581" author="ram_krish" created="Wed, 21 Sep 2011 15:33:18 +0000"  >&lt;p&gt;Running the test cases.. will submit the patch tomorrow morning.  &lt;/p&gt;</comment>
                            <comment id="13112492" author="ram_krish" created="Thu, 22 Sep 2011 11:54:41 +0000"  >&lt;p&gt;Ted testcases are running fine with this.&lt;br/&gt;
Hope it does not cause any problem like &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4153&quot; title=&quot;Handle RegionAlreadyInTransitionException in AssignmentManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4153&quot;&gt;&lt;del&gt;HBASE-4153&lt;/del&gt;&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13112535" author="yuzhihong@gmail.com" created="Thu, 22 Sep 2011 13:12:18 +0000"  >&lt;p&gt;Minor comment:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-comment&quot;&gt;// InterruptedException too.  If so, we failed.  Even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; tickle opening fails
&lt;/span&gt;+    &lt;span class=&quot;code-comment&quot;&gt;// then it is a failure.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think we don&apos;t need &apos;Even&apos; above.&lt;/p&gt;

&lt;p&gt;Also, I would initialize the new boolean with false.&lt;/p&gt;

&lt;p&gt;Running test suite.&lt;/p&gt;</comment>
                            <comment id="13112539" author="ram_krish" created="Thu, 22 Sep 2011 13:18:45 +0000"  >&lt;p&gt;@Ted, reason for initializing to true is like the tickleOpening may not be invoked always unlesss the PostOpenDeploytask takes more time.  That is why i initialized to true.&lt;/p&gt;

&lt;p&gt;Want to change it ?&lt;/p&gt;</comment>
                            <comment id="13112558" author="yuzhihong@gmail.com" created="Thu, 22 Sep 2011 13:37:15 +0000"  >&lt;p&gt;@Ramkrishna:&lt;br/&gt;
Your consideration makes sense.&lt;br/&gt;
There is no need to change.&lt;/p&gt;</comment>
                            <comment id="13112682" author="yuzhihong@gmail.com" created="Thu, 22 Sep 2011 16:10:22 +0000"  >&lt;p&gt;Test suite passed with patch.&lt;br/&gt;
+1.&lt;/p&gt;</comment>
                            <comment id="13112988" author="stack" created="Thu, 22 Sep 2011 22:51:19 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13112999" author="streamy" created="Thu, 22 Sep 2011 22:57:43 +0000"  >&lt;p&gt;lgtm.  nice catch.  pulling in to 0.92&lt;/p&gt;</comment>
                            <comment id="13113005" author="yuzhihong@gmail.com" created="Thu, 22 Sep 2011 23:03:35 +0000"  >&lt;p&gt;Patch for 0.90 branch.&lt;/p&gt;

&lt;p&gt;TestOpenRegionHandler passes.&lt;/p&gt;</comment>
                            <comment id="13113010" author="yuzhihong@gmail.com" created="Thu, 22 Sep 2011 23:09:26 +0000"  >&lt;p&gt;Integrated to 0.90, 0.92 and TRUNK.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Ramkrishna.&lt;/p&gt;

&lt;p&gt;Thanks for the review Stack and Jonathan.&lt;/p&gt;</comment>
                            <comment id="13113109" author="hudson" created="Fri, 23 Sep 2011 02:15:27 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2244 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2244/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2244/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4452&quot; title=&quot;Possibility of RS opening a region though tickleOpening fails due to znode version mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4452&quot;&gt;&lt;del&gt;HBASE-4452&lt;/del&gt;&lt;/a&gt;  Possibility of RS opening a region though tickleOpening fails due to&lt;br/&gt;
               znode version mismatch (Ramkrishna)&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13113145" author="hudson" created="Fri, 23 Sep 2011 04:11:26 +0000"  >&lt;p&gt;Integrated in HBase-0.92 #15 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.92/15/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.92/15/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4452&quot; title=&quot;Possibility of RS opening a region though tickleOpening fails due to znode version mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4452&quot;&gt;&lt;del&gt;HBASE-4452&lt;/del&gt;&lt;/a&gt;  Possibility of RS opening a region though tickleOpening fails due to&lt;br/&gt;
               znode version mismatch (Ramkrishna)&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.92/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/branches/0.92/src/main/java/org/apache/hadoop/hbase/regionserver/handler/OpenRegionHandler.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15016214" author="lars_francke" created="Fri, 20 Nov 2015 11:54:23 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12496195" name="4452.90" size="1432" author="yuzhihong@gmail.com" created="Thu, 22 Sep 2011 23:03:35 +0000"/>
                            <attachment id="12496095" name="HBASE-4452.patch" size="1451" author="ram_krish" created="Thu, 22 Sep 2011 11:54:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 21 Sep 2011 13:46:26 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27303</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hqxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101626</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>