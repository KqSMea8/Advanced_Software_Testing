<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:26:55 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5344/HBASE-5344.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5344] [89-fb] Scan unassigned region directory on master failover</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5344</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In case the master dies after a regionserver writes region state as OPENED or CLOSED in ZK but before the update is received by master and written to meta, the new master that comes up has to pick up the region state from ZK and write it to meta. Otherwise we can get multiply-assigned regions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12541552">HBASE-5344</key>
            <summary>[89-fb] Scan unassigned region directory on master failover</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikhail">Mikhail Bautin</assignee>
                                    <reporter username="mikhail">Mikhail Bautin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Feb 2012 02:49:55 +0000</created>
                <updated>Fri, 31 Aug 2012 20:26:47 +0000</updated>
                            <resolved>Fri, 31 Aug 2012 20:26:47 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13202029" author="phabricator@reviews.facebook.net" created="Tue, 7 Feb 2012 02:54:57 +0000"  >&lt;p&gt;mbautin requested code review of &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;br/&gt;
Reviewers: Kannan, Karthik, Liyin, JIRA, stack&lt;/p&gt;

&lt;p&gt;  In case the master dies after a regionserver writes region state as OPENED or CLOSED in ZK but before the update is received by master and written to meta, the new master that comes up has to pick up the region state from ZK and write it to meta. Otherwise we can get multiply-assigned regions.&lt;/p&gt;

&lt;p&gt;  The current solution tries to reassign the root region if it is unassigned but does not implement a work-around if META regions are missing. Also, it currently heavily relies on &quot;direct scanning&quot; of regionservers (reading regionserver list from ZK and doing an RPC on each regionserver to get the list of online regions). We were already doing that in master failover, but I am making it parallel here.&lt;/p&gt;

&lt;p&gt;TEST PLAN&lt;br/&gt;
  Unit tests, dev cluster, dark launch with killing regionservers and master&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/executor/RegionTransitionEventData.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/ipc/HBaseServer.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/BaseScanner.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ProcessRegionOpen.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/RegionManager.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/RootScanner.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ZKUnassignedWatcher.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/handler/MasterOpenRegionHandler.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/master/TestRegionStateOnMasterFailure.java&lt;/p&gt;

&lt;p&gt;MANAGE HERALD DIFFERENTIAL RULES&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/herald/view/differential/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/herald/view/differential/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;WHY DID I GET THIS EMAIL?&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/herald/transcript/3429/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/herald/transcript/3429/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Tip: use the X-Herald-Rules header to filter Herald messages in your client.&lt;/p&gt;</comment>
                            <comment id="13203286" author="phabricator@reviews.facebook.net" created="Wed, 8 Feb 2012 05:20:57 +0000"  >&lt;p&gt;stack has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  I should work on the forward-port to trunk of this patch (it won&apos;t look much like this when done but there is some good stuff in here).&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java:50 Nice.  Should we do same in trunk?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java:156 Single thread access in here only?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java:1207 This is interesting.  YOu just trying to figure who called this method?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ZKUnassignedWatcher.java:62 We should do this in trunk too...&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java:254 So, you&apos;d do this rather than wait on the regionservers to report in?  Via heartbeat?&lt;/p&gt;

&lt;p&gt;  I need to glean from this patch stuff that will help our trunk story.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13208018" author="phabricator@reviews.facebook.net" created="Tue, 14 Feb 2012 21:19:58 +0000"  >&lt;p&gt;stack has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  Whats the state on this patch Mikhail?  You going to apply to 0.89fb?  If it goes into 0.89fb, I&apos;d then like to forward port it.  It looks like it could take care of some trunk issues we see.&lt;/p&gt;

&lt;p&gt;  Is it possible that querying the regionservers would return state that is different to what is up in .META.? (I suppose if it does, we have bigger issues?)&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java:56 Should get via Configuration?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java:68 This does not do retries (and it looks like down in the code you are not doing retrying of Callable).  In TRUNK we use an HTable instance &amp;#8211; i.e. a Callable w/ retries &amp;#8211; so we get retying (thats a big change in trunk &amp;#8211; doing retries rather than one-time HConnection calls)&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java:51 FYI, in trunk, hbck needs what this class does over in HBaseFSCK#processRegionServers.  It could use this class one day.  Currently it asks master for this cluster status (which wouldn&apos;t work where this is needed on master failover)&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java:96 What is this?  It seems fb particular?  If no regionservers in zk, then its a cluster startup which means?  Does it mean cluster is starting?  What if there was a a regionserver up and running already but it had not yet been assigned any regions?  Wouldn&apos;t this be a clean cluster startup too?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java:107 Yeah, this stuff does not retry which maybe ok on startup here.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java:235 Nice utility&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java:160 Misspelled&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ZKUnassignedWatcher.java:50 We don&apos;t have this class in TRUNK.  Was it added to 0.89fb?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ZKUnassignedWatcher.java:88 Why delete it?  In case it has unassigned znodes?  I suppose this legit if the isClusterStartup means no regionservers up on cluster.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ZKUnassignedWatcher.java:128 ZKUtil.joinZNode does this.&lt;/p&gt;

&lt;p&gt;  So we are going through each of the unassigned znodes and we are going to update .META.?  I see that in the loop, if we trip over .META., then we&apos;ll just return.  Whats that about?  Is it that .META. is not assigned?  Is .META. and &lt;del&gt;ROOT&lt;/del&gt; assigned before this method is called?&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13208029" author="phabricator@reviews.facebook.net" created="Tue, 14 Feb 2012 21:33:58 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  @stack: I am working on a new patch that would avoid directly taking to all RSs and will focus on the state in ZK. It will also assign ROOT and META out-of-band if they are not online.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13208036" author="phabricator@reviews.facebook.net" created="Tue, 14 Feb 2012 21:39:57 +0000"  >&lt;p&gt;stack has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  Looking forward to it.&lt;/p&gt;

&lt;p&gt;  Why the change in direction?  Why not ask the regionservers?  (Out of interest?)  Good stuff.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13208089" author="phabricator@reviews.facebook.net" created="Tue, 14 Feb 2012 22:39:57 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  The bigger context of our current/planned changes in 89-fb master is as follows. In 89-fb, region assignments happen as responses to RS -&amp;gt; master RPC, and RSs communicate success of region open operations back to the master through ZK. The master then writes the new assignments to META. ZK is the only piece in the picture that could be considered a trusted highly-available source of truth for the region assignment, if only it had all assignments. Currently the region assignment can be obtained from the combination of META and ZK&apos;s UNASSIGNED directory. We have a plan to move towards always having the full assignment in ZK (the UNASSIGNED directory will change its meaning then) to help guarantee that we never have a duplicate assignment and to have only one source of truth for assignment. We will also keep writing the region assignment to META for client backward-compatibility. Even though the master failover fix does not depend on those planned changes, I thought it would b&lt;br/&gt;
 e useful to mention them here.&lt;/p&gt;

&lt;p&gt;  Contacting all regionservers directly to get the region assignment is probably useful as a sanity-check, but it is not scalable, and is subject to unpredictable timeouts in the worst case. We would like to rely on ZK and (for now) on META instead to recover the region assignment on master startup/failure. Also, by the way, we are planning to unify master startup on a fresh cluster start and failover and everything in between, and use the same logic to build a coherent picture of region assignment.&lt;/p&gt;


&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13208103" author="phabricator@reviews.facebook.net" created="Tue, 14 Feb 2012 23:11:59 +0000"  >&lt;p&gt;stack has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  Thanks for the explaination Mikhail.  Let me tag along as a reviewer so I can follow whats going on and so can help w/ the forward port.&lt;/p&gt;


&lt;p&gt;  &quot;We have a plan to move towards always having the full assignment in ZK (the UNASSIGNED directory will change its meaning then) to help guarantee that we never have a duplicate assignment and to have only one source of truth for assignment.&quot;&lt;/p&gt;

&lt;p&gt;  So, the &apos;/unassigned&apos; dir will change to be named &apos;/regions&apos; or some such?  On region open, we&apos;ll update its state in zk to be OPENED? And leave it there (and update .META. too).  We don&apos;t really need .META. then?  Smile.&lt;/p&gt;

&lt;p&gt;  &quot;We would like to rely on ZK and (for now) on META instead to recover the region assignment on master startup/failure.&quot;  The hard part in here is on failover, what if the .META. is on a crashed server?  You&apos;ll need to process its logs and get .META. back online before you can proceed w/ failover.  To get it online, you&apos;ll need to listen for events (though I suppose you could filter and only process .META. events).  Or what if the the server carrrying .META. crashes during onlining.&lt;/p&gt;

&lt;p&gt;  &quot;Also, by the way, we are planning to unify master startup on a fresh cluster start and failover and everything in between, and use the same logic to build a coherent picture of region assignment.&quot;&lt;/p&gt;

&lt;p&gt;  Sweet.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13208180" author="phabricator@reviews.facebook.net" created="Wed, 15 Feb 2012 01:37:59 +0000"  >&lt;p&gt;Karthik has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  Looks awesome! Couple of comments:&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java:254 Why do we rescanRSDirectory() here? Is it only to figure out if this is a fresh cluster start or not? Could we rename to checkIfFreshClusterStart()?&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ZKUnassignedWatcher.java:171 We should set this to false only after draining the queue, otherwise an older event could overwrite a newer one?&lt;/p&gt;

&lt;p&gt;  Might need something like:&lt;/p&gt;

&lt;p&gt;  while (true) {&lt;br/&gt;
    synchronized (deferredLock) {&lt;br/&gt;
      if (bufferedEvents.isEmpty()) &lt;/p&gt;
{
        deferRegionEventProcessing = false;
        break;
      }
&lt;p&gt;      else &lt;/p&gt;
{
        event = bufferedEvents.take();
      }
&lt;p&gt;    }&lt;br/&gt;
    process(event);&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;  Need the lock on the queueing side as well.&lt;/p&gt;


&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13208196" author="phabricator@reviews.facebook.net" created="Wed, 15 Feb 2012 02:25:57 +0000"  >&lt;p&gt;mbautin has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;INLINE COMMENTS&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java:254 Yes, that is to figure out whether it is fresh cluster startup. We do that by scanning the regionservers directory in ZK and checking if it is empty. I will try to unify cluster startup and failover cases in further iterations.&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ZKUnassignedWatcher.java:171 Makes a lot of sense. Thanks!&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13209128" author="phabricator@reviews.facebook.net" created="Thu, 16 Feb 2012 05:52:57 +0000"  >&lt;p&gt;Karthik has commented on the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  @stack -&lt;/p&gt;

&lt;p&gt;  &amp;lt;&amp;lt; So, the &apos;/unassigned&apos; dir will change to be named &apos;/regions&apos; or some such? On region open, we&apos;ll update its state in zk to be OPENED? And leave it there (and update .META. too). We don&apos;t really need .META. then? Smile. &amp;gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;  Not totally... the idea is to change /unassigned to /regions/&amp;lt;tablename&amp;gt; and it will not be deleted on the region being opened. This will only track assignment of regions though. We still need meta to figure out start/stop keys and other information like preferred regionservers for the regions. In order to truly eliminate meta, we should be willing to store more permanent data in ZK, but thats probably not needed unless we are going all the way to rip out root and meta special-casing, which would be a huge change.&lt;/p&gt;

&lt;p&gt;  &amp;lt;&amp;lt; &quot;We would like to rely on ZK and (for now) on META instead to recover the region assignment on master startup/failure.&quot; The hard part in here is on failover, what if the .META. is on a crashed server? You&apos;ll need to process its logs and get .META. back online before you can proceed w/ failover. To get it online, you&apos;ll need to listen for events (though I suppose you could filter and only process .META. events). Or what if the the server carrrying .META. crashes during onlining. &amp;gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;  The idea here is that the master can read unassigned (while continuing to queue events). It will split all logs (via distributed log splitting) and process opening of the meta region out of band (not go though the standard heartbeat based assignment - we do this for root upon startup, we need something similar for meta).&lt;/p&gt;


&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13242146" author="phabricator@reviews.facebook.net" created="Fri, 30 Mar 2012 07:54:45 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;br/&gt;
Reviewers: Kannan, Karthik, Liyin, JIRA, stack&lt;/p&gt;

&lt;p&gt;  Deleting a bunch of files that should be deleted in this patch and fixing a compilation error in TestMiniClusterLoadSequential.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  pom.xml&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/EmptyWatcher.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/EmptyWatcher.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/HConstants.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/util/AbstractHBaseTool.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/manual/HBaseTest.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/manual/RestartMetaTest.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/manual/utils/HBaseUtils.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/manual/utils/KillProcessesAndVerify.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/manual/utils/MultiThreadedAction.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/manual/utils/MultiThreadedReader.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/manual/utils/MultiThreadedWriter.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/manual/utils/ProcessBasedLocalHBaseCluster.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/LoadTestTool.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/MultiThreadedAction.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/MultiThreadedReader.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/MultiThreadedWriter.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/ProcessBasedLocalHBaseCluster.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/RestartMetaTest.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestLoadTestKVGenerator.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestMiniClusterLoadEncoded.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestMiniClusterLoadParallel.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/util/TestMiniClusterLoadSequential.java&lt;/p&gt;</comment>
                            <comment id="13242154" author="phabricator@reviews.facebook.net" created="Fri, 30 Mar 2012 08:22:54 +0000"  >&lt;p&gt;mbautin updated the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;br/&gt;
Reviewers: Kannan, Karthik, Liyin, JIRA, stack&lt;/p&gt;

&lt;p&gt;  Attached the wrong diff to this revision. Restoring its old state rebased on recent changes.&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;AFFECTED FILES&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/executor/RegionTransitionEventData.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/ipc/HBaseServer.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/BaseScanner.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/DirectRegionServerScanner.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ProcessRegionOpen.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/RegionManager.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/RootScanner.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ServerManager.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/ZKUnassignedWatcher.java&lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/master/handler/MasterOpenRegionHandler.java&lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/master/TestRegionStateOnMasterFailure.java&lt;/p&gt;</comment>
                            <comment id="13266204" author="phabricator@reviews.facebook.net" created="Tue, 1 May 2012 22:28:49 +0000"  >&lt;p&gt;mbautin has abandoned the revision &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5344&quot; title=&quot;[89-fb] Scan unassigned region directory on master failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5344&quot;&gt;&lt;del&gt;HBASE-5344&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;89-fb&amp;#93;&lt;/span&gt; Scan unassigned region directory on master failover&quot;.&lt;/p&gt;

&lt;p&gt;  Abandoning this revision. The useful part of this will be included in the full master failover diff (&lt;a href=&quot;https://reviews.facebook.net/D2085&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D2085&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;REVISION DETAIL&lt;br/&gt;
  &lt;a href=&quot;https://reviews.facebook.net/D1605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D1605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13444107" author="ivarley" created="Wed, 29 Aug 2012 14:38:15 +0000"  >&lt;p&gt;Hey Mikhail, I see that the original phabricator review was abandoned, and that there&apos;s a new one (D2085) that shows to be committed on 8/5 (presumably to the FB-89 branch). Should this JIRA be closed? Is there another JIRA to include porting the work in review D2085 to trunk? (I searched and couldn&apos;t find one, but maybe it&apos;s under another name.)&lt;/p&gt;</comment>
                            <comment id="13446337" author="mikhail" created="Fri, 31 Aug 2012 20:26:47 +0000"  >&lt;p&gt;Ian: yes, I am closing this JIRA. The patch was committed to the 89-fb branch. There is no other JIRA to port this feature to trunk yet (feel free to create one if you are interested), and due to significant differences between master code in 0.89-fb and trunk we will not focus on porting this feature to the trunk at this time. I think would be more appropriate for someone more experienced with the trunk master code to do the port (or maybe it would be easier to reimplement the same idea on trunk).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12513561" name="ASF.LICENSE.NOT.GRANTED--D1605.1.patch" size="45592" author="phabricator@reviews.facebook.net" created="Tue, 7 Feb 2012 02:54:58 +0000"/>
                            <attachment id="12520577" name="ASF.LICENSE.NOT.GRANTED--D1605.2.patch" size="147745" author="phabricator@reviews.facebook.net" created="Fri, 30 Mar 2012 07:54:47 +0000"/>
                            <attachment id="12520580" name="ASF.LICENSE.NOT.GRANTED--D1605.3.patch" size="45371" author="phabricator@reviews.facebook.net" created="Fri, 30 Mar 2012 08:22:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 7 Feb 2012 02:54:57 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>226839</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i069fb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34458</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>