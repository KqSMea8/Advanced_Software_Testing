<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:28:59 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-5572/HBASE-5572.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-5572] KeeperException.SessionExpiredException management could be improved in Master</title>
                <link>https://issues.apache.org/jira/browse/HBASE-5572</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Synthesis:&lt;br/&gt;
 1) TestMasterZKSessionRecovery distinguish two cases on SessionExpiredException. One is explicitly not managed. However, is seems that there is no reason for this.&lt;br/&gt;
 2) The issue lies in ActiveMasterManager#blockUntilBecomingActiveMaster, a quite complex function, with a useless recursive call.&lt;br/&gt;
 3) TestMasterZKSessionRecovery#testMasterZKSessionRecoverySuccess is equivalent to TestZooKeeper#testMasterSessionExpired&lt;br/&gt;
 4) TestMasterZKSessionRecovery#testMasterZKSessionRecoveryFailure can be removed if we merge the two cases mentioned above.&lt;/p&gt;


&lt;p&gt;Changes are:&lt;br/&gt;
 2) Changing ActiveMasterManager#blockUntilBecomingActiveMaster to have a single case and remove recursion&lt;br/&gt;
 1) Removing TestMasterZKSessionRecovery&lt;/p&gt;


&lt;p&gt;Detailed justification:&lt;br/&gt;
testMasterZKSessionRecoveryFailure says:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  /**
   * Negative test of master recovery from zk session expiry.
   *
   * Starts with one master. Fakes the master zk session expired.
   * Ensures the master cannot recover the expired zk session since
   * the master zk node is still there.
   */
  public void testMasterZKSessionRecoveryFailure() throws Exception {
    MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();
    HMaster m = cluster.getMaster();
    m.abort(&quot;Test recovery from zk session expired&quot;,
      new KeeperException.SessionExpiredException());
    assertTrue(m.isStopped());
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This tests works, i.e. the assertion is always verified.&lt;br/&gt;
But do we really want this behavior?&lt;/p&gt;

&lt;p&gt;When looking at the code, we see that this what&apos;s happening is strange:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;HMaster#abort calls Master#abortNow. If HMaster#abortNow returns false HMaster#abort stops the master.&lt;/li&gt;
	&lt;li&gt;HMaster#abortNow checks the exception type. As it&apos;s a SessionExpiredException it will try to recover, calling HMaster#tryRecoveringExpiredZKSession. If it cannot, it will return false (and that will make HMaster#abort stopping the master)&lt;/li&gt;
	&lt;li&gt;HMaster#tryRecoveringExpiredZKSession recreates a ZooKeeperConnection and then try to become the active master. If it cannot, it will return false (and that will make HMaster#abort stopping the master).&lt;/li&gt;
	&lt;li&gt;HMaster#becomeActiveMaster returns the result of ActiveMasterManager#blockUntilBecomingActiveMaster. blockUntilBecomingActiveMaster says it will return false if there is any error preventing it to become the active master.&lt;/li&gt;
	&lt;li&gt;ActiveMasterManager#blockUntilBecomingActiveMaster reads ZK for the master address. If it&apos;s the same port &amp;amp; host, it deletes the nodes, that will start a recursive call to blockUntilBecomingActiveMaster. This second call succeeds (we became the active master) and return true. This result is ignored by the first blockUntilBecomingActiveMaster: it return false (even if we actually became the active master), hence the whole suite call returns false and HMaster#abort stops the master.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In other words, the comment says &quot;Ensures the master cannot recover the expired zk session since the master zk node is still there.&quot; but we&apos;re actually doing a check just for this and deleting the node. If we were not ignoring the result, we would return &quot;true&quot;, so we would not stop the master, so the test would fail.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12546241">HBASE-5572</key>
            <summary>KeeperException.SessionExpiredException management could be improved in Master</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkeywal">Nicolas Liochon</assignee>
                                    <reporter username="nkeywal">Nicolas Liochon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Mar 2012 14:26:07 +0000</created>
                <updated>Mon, 23 Sep 2013 18:45:00 +0000</updated>
                            <resolved>Fri, 16 Mar 2012 21:40:36 +0000</resolved>
                                    <version>0.95.2</version>
                                    <fixVersion>0.95.0</fixVersion>
                                    <component>master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="13228460" author="stack" created="Tue, 13 Mar 2012 15:50:56 +0000"  >&lt;p&gt;@N Thanks for digging in.  So, it looks like your patch retains the behavior where if the current master has same host and port, we&apos;ll expire it, and then try and register ourselves (because we go around to the top of your new while loop)?  Is that so?  I believe we have a test to ensure this behavior IIRC.  Patch looks good.  +1.&lt;/p&gt;</comment>
                            <comment id="13228476" author="nkeywal" created="Tue, 13 Mar 2012 16:09:40 +0000"  >&lt;p&gt;Yes. I&apos;ve done 3 modifications in the code, two like for like (hopefully!) and one with a different behavior. I:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removed the variable named cleanSetOfActiveMaster, replaced by &quot;return true&quot; or &quot;return false&quot;.&lt;/li&gt;
	&lt;li&gt;replaced the recursive call by a while(true) loop.&lt;/li&gt;
	&lt;li&gt;implicitly (it&apos;s hidden because there is no recursive call anymore) changed the function behavior: we now return the final result. For this reason the function behaves differently (we return true instead of false), but it&apos;s more on line with the method contract. This change breaks the testMasterZKSessionRecoveryFailure, because it does not fail anymore.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;TestMasterZKSessionRecovery#testMasterZKSessionRecoveryFailure was testing explicitly the behavior with both SessionExpired AND master with same host &amp;amp; port. I removed it, but I can move it to TestZooKeeper (to save a cluster start/stop) and reverse the assertion in the test (now it does not fail).&lt;/p&gt;


</comment>
                            <comment id="13228487" author="stack" created="Tue, 13 Mar 2012 16:20:42 +0000"  >&lt;p&gt;Above sounds good.  Would suggest we retain the test that verifies that we expire znode if same host and port.  That behavior can be useful in the single-master case.&lt;/p&gt;</comment>
                            <comment id="13228598" author="stack" created="Tue, 13 Mar 2012 19:03:32 +0000"  >&lt;p&gt;+1 on patch.  Waiting on hadoopqa...&lt;/p&gt;</comment>
                            <comment id="13228689" author="nkeywal" created="Tue, 13 Mar 2012 20:51:14 +0000"  >&lt;p&gt;for an unknown reason the first two patches didn&apos;t make it to hadoop-qa. Rewriting once again.&lt;/p&gt;</comment>
                            <comment id="13228872" author="hadoopqa" created="Wed, 14 Mar 2012 01:17:00 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12518238/5572.v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12518238/5572.v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 161 new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed unit tests in .&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1179//testReport/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1179//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1179//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1179//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/1179//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/1179//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13230035" author="nkeywal" created="Thu, 15 Mar 2012 10:15:36 +0000"  >&lt;p&gt;@stack: it seems the patch could be committed?&lt;/p&gt;</comment>
                            <comment id="13231655" author="zhihyu@ebaysf.com" created="Fri, 16 Mar 2012 21:40:36 +0000"  >&lt;p&gt;Resolved as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5549&quot; title=&quot;Master can fail if ZooKeeper session expires&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5549&quot;&gt;&lt;del&gt;HBASE-5549&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13231693" author="hudson" created="Fri, 16 Mar 2012 22:32:12 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2686 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2686/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2686/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5549&quot; title=&quot;Master can fail if ZooKeeper session expires&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5549&quot;&gt;&lt;del&gt;HBASE-5549&lt;/del&gt;&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5572&quot; title=&quot;KeeperException.SessionExpiredException management could be improved in Master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5572&quot;&gt;&lt;del&gt;HBASE-5572&lt;/del&gt;&lt;/a&gt; Master can fail if ZooKeeper session expires (N Keywal) (Revision 1301775)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/ActiveMasterManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/RecoverableZooKeeper.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperWatcher.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestDistributedLogSplitting.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterZKSessionRecovery.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransactionOnCluster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationPeer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13231854" author="hudson" created="Sat, 17 Mar 2012 05:56:20 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-security #140 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-security/140/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-security/140/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5549&quot; title=&quot;Master can fail if ZooKeeper session expires&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5549&quot;&gt;&lt;del&gt;HBASE-5549&lt;/del&gt;&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5572&quot; title=&quot;KeeperException.SessionExpiredException management could be improved in Master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5572&quot;&gt;&lt;del&gt;HBASE-5572&lt;/del&gt;&lt;/a&gt; Master can fail if ZooKeeper session expires (N Keywal) (Revision 1301775)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/ActiveMasterManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/RecoverableZooKeeper.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperWatcher.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestDistributedLogSplitting.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterZKSessionRecovery.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestSplitTransactionOnCluster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationPeer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12545833">HBASE-5549</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12545833">HBASE-5549</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12518190" name="5572.v1.patch" size="11969" author="nkeywal" created="Tue, 13 Mar 2012 14:57:26 +0000"/>
                            <attachment id="12518238" name="5572.v2.patch" size="13585" author="nkeywal" created="Tue, 13 Mar 2012 20:49:39 +0000"/>
                            <attachment id="12518210" name="5572.v2.patch" size="13585" author="nkeywal" created="Tue, 13 Mar 2012 18:29:37 +0000"/>
                            <attachment id="12518200" name="5572.v2.patch" size="13585" author="nkeywal" created="Tue, 13 Mar 2012 17:26:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 13 Mar 2012 15:50:56 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231399</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0htnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>102068</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>