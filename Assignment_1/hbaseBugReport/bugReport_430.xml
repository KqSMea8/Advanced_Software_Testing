<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:44:10 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-430/HBASE-430.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-430] Performance: Scanners and getRow return maps with duplicate data</title>
                <link>https://issues.apache.org/jira/browse/HBASE-430</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Right now, whenever we get back multiple cells worth of data at a time, we do so in a map of HStoreKey-&amp;gt;byte[]. This means that there is a duplicated Text row and long timestamp at the very least between every cell. This is quite a bit wasted. It also means we have to do a lot of translation every time. &lt;/p&gt;

&lt;p&gt;We could create a new Writable that contains just one row, one timestamp, and a map of Text-&amp;gt;byte[].&lt;/p&gt;</description>
                <environment></environment>
        <key id="12388250">HBASE-430</key>
            <summary>Performance: Scanners and getRow return maps with duplicate data</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanduxbury">Bryan Duxbury</assignee>
                                    <reporter username="bryanduxbury">Bryan Duxbury</reporter>
                        <labels>
                    </labels>
                <created>Sat, 9 Feb 2008 01:05:23 +0000</created>
                <updated>Fri, 22 Aug 2008 21:13:08 +0000</updated>
                            <resolved>Wed, 12 Mar 2008 15:43:07 +0000</resolved>
                                                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12576397" author="bryanduxbury" created="Fri, 7 Mar 2008 22:06:44 +0000"  >&lt;p&gt;I&apos;m thinking we could add a class called RowResult, which has a Text row and HBaseMapWritable&amp;lt;Text, Cell&amp;gt; columns. This itself can be a writable. &lt;/p&gt;

&lt;p&gt;Then, when you call scanner.next, you can just return a single record from the method instead of a bool + modify parameters. If it&apos;s null, there&apos;s nothing more left.&lt;/p&gt;</comment>
                            <comment id="12576398" author="bryanduxbury" created="Fri, 7 Mar 2008 22:07:43 +0000"  >&lt;p&gt;Need to get Cell objects in place before this will work.&lt;/p&gt;</comment>
                            <comment id="12576709" author="bryanduxbury" created="Sun, 9 Mar 2008 05:49:35 +0000"  >&lt;p&gt;I have a simple implementation for the RowResult class itself already. It&apos;ll be pretty easy to use from a consumption standpoint (implements Map&amp;lt;Text, Cell&amp;gt;). However, if I change HScannerInterface#next from boolean(HStoreKey, SortedMap&amp;lt;Text, byte[]&amp;gt;) to RowResult(), there will be far-reaching changes throughout the code. This is because all scanners everywhere, including the internal ones used in the region server, implement HScannerInterface at some point. &lt;/p&gt;

&lt;p&gt;Overall I don&apos;t think it&apos;s going to be a challenging change, beyond the fact that all the mechanics of advancing scanners is pretty hairy.&lt;/p&gt;</comment>
                            <comment id="12576837" author="bryanduxbury" created="Mon, 10 Mar 2008 01:04:39 +0000"  >&lt;p&gt;This patch makes it so RowResults are what are used in HRegionInterface. HTable still reconstitutes the Map&amp;lt;HStoreKey, byte[]&amp;gt; the client side scanners use. Ultimately I&apos;d like to change scanners to use RowResults everywhere instead of the existing interface, but this might be a good incremental step. All unit tests pass.&lt;/p&gt;</comment>
                            <comment id="12576838" author="bryanduxbury" created="Mon, 10 Mar 2008 01:05:05 +0000"  >&lt;p&gt;Please review.&lt;/p&gt;</comment>
                            <comment id="12577167" author="stack" created="Mon, 10 Mar 2008 20:30:38 +0000"  >
&lt;p&gt;Rather than currentMillis, should you use the HCONSTANTS.LATEST_TIMESTAMP (or whatever its called)?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: src/java/org/apache/hadoop/hbase/HMerge.java
===================================================================
--- src/java/org/apache/hadoop/hbase/HMerge.java    (revision 635107)
+++ src/java/org/apache/hadoop/hbase/HMerge.java    (working copy)
@@ -335,8 +335,9 @@
       root = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HRegion(rootTableDir, hlog, fs, conf,
           HRegionInfo.rootRegionInfo, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
 
-      HScannerInterface rootScanner = root.getScanner(COL_REGIONINFO_ARRAY,
-          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Text(), &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
+      HScannerInterface rootScanner = 
+        root.getScanner(COL_REGIONINFO_ARRAY, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Text(), 
+        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Made other comments up on IRC about removing commented out TODO and that there is a Writables.getHRegionInfo if you want to use instead of other Writables methods... but otherwise, patch is great removing a bunch of duplicated Map making every time we get a row&lt;/p&gt;</comment>
                            <comment id="12577188" author="bryanduxbury" created="Mon, 10 Mar 2008 21:02:03 +0000"  >&lt;p&gt;This patch incorporates suggestions, passes tests. Looking for another run of tests and a +1 to commit.&lt;/p&gt;</comment>
                            <comment id="12577199" author="bryanduxbury" created="Mon, 10 Mar 2008 21:21:28 +0000"  >&lt;p&gt;Forgot to svn add my new RowResult class.&lt;/p&gt;</comment>
                            <comment id="12577611" author="stack" created="Tue, 11 Mar 2008 21:43:49 +0000"  >&lt;p&gt;Patch is missing DeprecatedScannerInterface&lt;/p&gt;</comment>
                            <comment id="12577644" author="bryanduxbury" created="Tue, 11 Mar 2008 23:07:19 +0000"  >&lt;p&gt;This patch removes the HDeprecatedScannerInterface nonsense.&lt;/p&gt;</comment>
                            <comment id="12577695" author="stack" created="Wed, 12 Mar 2008 04:10:30 +0000"  >&lt;p&gt;Last patch builds successfully on my machine.  Before committing, you might make the following changes:&lt;/p&gt;

&lt;p&gt;In src/java/org/apache/hadoop/hbase/client/HBaseAdmin.java remove:&lt;/p&gt;

&lt;p&gt;+          // HStoreKey key = (HStoreKey) e.getKey();&lt;/p&gt;

&lt;p&gt;In src/java/org/apache/hadoop/hbase/client/HConnectionManager.java remove:&lt;/p&gt;

&lt;p&gt;+            // for (Map.Entry&amp;lt;Text, Cell&amp;gt; e: values.entrySet()) {&lt;br/&gt;
+            //   if (e.getKey().equals(COL_REGIONINFO)) &lt;/p&gt;
{
+            //     // HRegionInfo info = new HRegionInfo();
+            //     // info = (HRegionInfo) Writables.getWritable(
+            //     //   e.getValue().getValue(), info);
+            // 
+            //   }
&lt;p&gt;+            // }&lt;/p&gt;

&lt;p&gt;In src/java/org/apache/hadoop/hbase/io/RowResult.java, copyright should be 2008, not 2007.  Thats kinda sweet that you have it implement Map&lt;/p&gt;

&lt;p&gt;Whats going on here?  + &lt;br/&gt;
+  public Set&amp;lt;Text&amp;gt; keySet() {&lt;br/&gt;
+    Set&amp;lt;Text&amp;gt; result = new HashSet&amp;lt;Text&amp;gt;();&lt;br/&gt;
+    for (Writable w : cells.keySet()) &lt;/p&gt;
{
+      result.add((Text)w);
+    }
&lt;p&gt;+    return result;&lt;br/&gt;
+  }&lt;/p&gt;

&lt;p&gt;You are trying to protect against client alterations of underlying cell?  If so, instead wrap in a call to Collections.unmodifiableSet: &lt;a href=&quot;http://java.sun.com/j2se/1.5.0/docs/api/java/util/Collections.html#unmodifiableSet(java.util.Set&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://java.sun.com/j2se/1.5.0/docs/api/java/util/Collections.html#unmodifiableSet(java.util.Set&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;There are a few other places where you do similar copies.&lt;/p&gt;

&lt;p&gt;+1 on patch after consideration of above.&lt;/p&gt;


</comment>
                            <comment id="12577713" author="bryanduxbury" created="Wed, 12 Mar 2008 05:19:28 +0000"  >&lt;p&gt;Removed the commented code from HBaseAdmin and HConnectionManager.&lt;/p&gt;

&lt;p&gt;RowResult has to do that mapping for keySet et al because HBaseMapWritable is a map of &amp;lt;Writable, Writable&amp;gt;, not a map of &amp;lt;Text, Cell&amp;gt;. The mapping does the cast. Is there a simpler way?&lt;/p&gt;</comment>
                            <comment id="12577718" author="stack" created="Wed, 12 Mar 2008 05:44:10 +0000"  >&lt;p&gt;Ok on the mapping.  I don&apos;t know of a way around the copy. Go ahead and apply I&apos;d say.&lt;/p&gt;</comment>
                            <comment id="12577881" author="bryanduxbury" created="Wed, 12 Mar 2008 15:43:07 +0000"  >&lt;p&gt;I just committed this to trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12390103">HBASE-489</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12377548" name="430-v2.patch" size="33051" author="bryanduxbury" created="Mon, 10 Mar 2008 21:02:03 +0000"/>
                            <attachment id="12377552" name="430-v3.patch" size="37560" author="bryanduxbury" created="Mon, 10 Mar 2008 21:21:28 +0000"/>
                            <attachment id="12377649" name="430-v4.patch" size="36693" author="bryanduxbury" created="Tue, 11 Mar 2008 23:07:19 +0000"/>
                            <attachment id="12377670" name="430-v5.patch" size="36594" author="bryanduxbury" created="Wed, 12 Mar 2008 05:19:28 +0000"/>
                            <attachment id="12377497" name="430.patch" size="32231" author="bryanduxbury" created="Mon, 10 Mar 2008 01:04:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 10 Mar 2008 20:30:38 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31699</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h79j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98439</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>