<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:35:40 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6313/HBASE-6313.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6313] Client hangs because the client is not notified </title>
                <link>https://issues.apache.org/jira/browse/HBASE-6313</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;If the call first remove from the calls, when some exception happened in reading from the DataInputStream, the call will not be notified, cause the client hangs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12597031">HBASE-6313</key>
            <summary>Client hangs because the client is not notified </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aoxiang">binlijin</assignee>
                                    <reporter username="aoxiang">binlijin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jul 2012 08:51:35 +0000</created>
                <updated>Sun, 2 Jun 2013 02:44:33 +0000</updated>
                            <resolved>Sat, 7 Jul 2012 02:15:16 +0000</resolved>
                                    <version>0.92.1</version>
                    <version>0.94.0</version>
                                    <fixVersion>0.92.2</fixVersion>
                    <fixVersion>0.94.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13405701" author="aoxiang" created="Tue, 3 Jul 2012 09:00:39 +0000"  >&lt;p&gt;        Call call = calls.remove(id); // first remove from the calls&lt;/p&gt;

&lt;p&gt;        // Read the flag byte&lt;br/&gt;
        byte flag = in.readByte();&lt;br/&gt;
        boolean isError = ResponseFlag.isError(flag);&lt;br/&gt;
        if (ResponseFlag.isLength(flag)) &lt;/p&gt;
{
          // Currently length if present is unused.
          in.readInt();
        }
&lt;p&gt;        int state = in.readInt(); // Read the state.  Currently unused.&lt;br/&gt;
        if (isError) {&lt;br/&gt;
          if (call != null) &lt;/p&gt;
{
            //noinspection ThrowableInstanceNeverThrown
            call.setException(new RemoteException(WritableUtils.readString(in),
                WritableUtils.readString(in))); 
// if some error happens in WritableUtils.readString(in), the client that wait for the call will not be notifed. because the call has been removed from the calls and call.callComplete() will not be called. 

          }
&lt;p&gt;        } else {&lt;br/&gt;
          Writable value = ReflectionUtils.newInstance(valueClass, conf);&lt;br/&gt;
          value.readFields(in);                 // read value&lt;br/&gt;
          // it&apos;s possible that this call may have been cleaned up due to a RPC&lt;br/&gt;
          // timeout, so check if it still exists before setting the value.&lt;br/&gt;
          if (call != null) &lt;/p&gt;
{
            call.setValue(value);
          }
&lt;p&gt;        }&lt;/p&gt;</comment>
                            <comment id="13405707" author="ram_krish" created="Tue, 3 Jul 2012 09:12:49 +0000"  >&lt;p&gt;@Binljin&lt;br/&gt;
I was just creating an issue for this.  I will attach a thread dump do let me know if you also faced the same dump.&lt;/p&gt;</comment>
                            <comment id="13405717" author="ram_krish" created="Tue, 3 Jul 2012 09:20:16 +0000"  >&lt;p&gt;Attaching the thread dump. Is this the same you got Binljin?&lt;/p&gt;</comment>
                            <comment id="13405721" author="aoxiang" created="Tue, 3 Jul 2012 09:26:08 +0000"  >&lt;p&gt;@ramkrishna.s.vasudevan&lt;br/&gt;
Yes&#65292;the same stack&#65292;the Connection thread has been exited&#65292;but the client still waits for the call to be done. &lt;/p&gt;</comment>
                            <comment id="13405723" author="ram_krish" created="Tue, 3 Jul 2012 09:35:33 +0000"  >&lt;p&gt;+1.  Thanks.. Nice one.&lt;/p&gt;</comment>
                            <comment id="13405795" author="hadoopqa" created="Tue, 3 Jul 2012 10:43:58 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12534670/clienthangthread.out&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12534670/clienthangthread.out&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HBASE-Build/2317//console&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/PreCommit-HBASE-Build/2317//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13405931" author="zhihyu@ebaysf.com" created="Tue, 3 Jul 2012 13:50:06 +0000"  >&lt;p&gt;calls.remove(id) is added for two cases.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (status == Status.FATAL) {
           &lt;span class=&quot;code-comment&quot;&gt;// Close the connection&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What about the case above ?&lt;/p&gt;</comment>
                            <comment id="13406229" author="aoxiang" created="Wed, 4 Jul 2012 01:41:28 +0000"  >&lt;p&gt;if status == Status.FATAL Connection.markClosed(IOException e) will be called, shouldCloseConnection will set to be true, the connection will be close.&lt;br/&gt;
Connection.close() &lt;del&gt;&amp;gt; Connection.cleanupCalls()&lt;/del&gt;&amp;gt; Call.setException(IOException error), so all call in calls will be notified. &lt;/p&gt;</comment>
                            <comment id="13406268" author="zhihyu@ebaysf.com" created="Wed, 4 Jul 2012 04:29:43 +0000"  >&lt;p&gt;Hadoop QA has been dormant.&lt;/p&gt;

&lt;p&gt;Please post test suite result.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13407626" author="lhofhansl" created="Fri, 6 Jul 2012 00:33:00 +0000"  >&lt;p&gt;+1 on patch and commit&lt;br/&gt;
(Patch looks benign enough, don&apos;t need HadoopQA, we can monitor the build for failures)&lt;/p&gt;</comment>
                            <comment id="13407635" author="zhihyu@ebaysf.com" created="Fri, 6 Jul 2012 00:57:40 +0000"  >&lt;p&gt;I integrated the patch into internal repo (0.92 based).&lt;br/&gt;
The build passed.&lt;/p&gt;</comment>
                            <comment id="13408310" author="zhihyu@ebaysf.com" created="Fri, 6 Jul 2012 20:54:22 +0000"  >&lt;p&gt;Integrated to trunk.&lt;/p&gt;

&lt;p&gt;Thanks for the patch, binlijin.&lt;/p&gt;

&lt;p&gt;Thanks for the review, Lars.&lt;/p&gt;</comment>
                            <comment id="13408504" author="lhofhansl" created="Sat, 7 Jul 2012 00:58:58 +0000"  >&lt;p&gt;Is the behavior of the 0.94 patch different?&lt;br/&gt;
In the 0.94 patch we remove the call unless an exception was thrown. In the trunk patch we remove it on success and in some cases on error (but not on FATAL).&lt;/p&gt;

&lt;p&gt;@binlijin: Can you briefly comment on this. I&apos;ll then commit to 0.94 as well.&lt;/p&gt;</comment>
                            <comment id="13408533" author="aoxiang" created="Sat, 7 Jul 2012 01:53:37 +0000"  >&lt;p&gt;For 0.94, in Connection.receiveResponse(), two possible:&lt;br/&gt;
(1) read from the in (DataInputStream) success, Call.callComplete() is called, client will be wake.&lt;br/&gt;
(2) read from the in (DataInputStream) failed, throws Exception, Connection.markClosed() will be called and so the thread Connection will exit, all calls in queue(calls) will remove and notify.&lt;/p&gt;

&lt;p&gt;Without this patch, first remove from the queue(calls), &lt;br/&gt;
 for possible 1, no exception&#65292; normal&lt;br/&gt;
 for possible 2, the call is not in queue(calls), so Client wait for the call will not be notified. &lt;/p&gt;

&lt;p&gt;With this patch, first get from the queue(calls), &lt;br/&gt;
 for possible 1, no exception&#65292; normal, call remove from the queue(calls)&lt;br/&gt;
 for possible 2, have a exception the call is still in queue(calls), so Client wait for the call will be notified, because all call in queue(calls) will be removed and notified. &lt;/p&gt;
</comment>
                            <comment id="13408539" author="lhofhansl" created="Sat, 7 Jul 2012 02:15:16 +0000"  >&lt;p&gt;Committed to 0.92 and 0.94 as well.&lt;/p&gt;</comment>
                            <comment id="13408540" author="lhofhansl" created="Sat, 7 Jul 2012 02:15:34 +0000"  >&lt;p&gt;Thanks for the explanation!&lt;/p&gt;</comment>
                            <comment id="13411159" author="hudson" created="Wed, 11 Jul 2012 02:36:55 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security #39 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security/39/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security/39/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6313&quot; title=&quot;Client hangs because the client is not notified &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6313&quot;&gt;&lt;del&gt;HBASE-6313&lt;/del&gt;&lt;/a&gt; Client hangs because the client is not notified (binlijin) (Revision 1358489)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/ipc/HBaseClient.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13428714" author="hudson" created="Sun, 5 Aug 2012 00:51:11 +0000"  >&lt;p&gt;Integrated in HBase-0.94-security-on-Hadoop-23 #6 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/6/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-0.94-security-on-Hadoop-23/6/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6313&quot; title=&quot;Client hangs because the client is not notified &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6313&quot;&gt;&lt;del&gt;HBASE-6313&lt;/del&gt;&lt;/a&gt; Client hangs because the client is not notified (binlijin) (Revision 1358489)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
larsh : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/ipc/HBaseClient.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12650116">HBASE-8656</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12534669" name="HBASE-6313-0.92-2.patch" size="1248" author="aoxiang" created="Tue, 3 Jul 2012 09:18:11 +0000"/>
                            <attachment id="12535059" name="HBASE-6313-0.92-3.patch" size="1242" author="aoxiang" created="Wed, 4 Jul 2012 09:33:13 +0000"/>
                            <attachment id="12534667" name="HBASE-6313-0.92.patch" size="2911" author="aoxiang" created="Tue, 3 Jul 2012 09:12:49 +0000"/>
                            <attachment id="12535058" name="HBASE-6313-0.94-2.patch" size="1242" author="aoxiang" created="Wed, 4 Jul 2012 09:31:14 +0000"/>
                            <attachment id="12534664" name="HBASE-6313-0.94.patch" size="1248" author="aoxiang" created="Tue, 3 Jul 2012 08:52:56 +0000"/>
                            <attachment id="12535061" name="HBASE-6313-trunk-2.patch" size="3512" author="aoxiang" created="Wed, 4 Jul 2012 09:34:49 +0000"/>
                            <attachment id="12534765" name="HBASE-6313-trunk.patch" size="3518" author="aoxiang" created="Tue, 3 Jul 2012 11:55:59 +0000"/>
                            <attachment id="12534670" name="clienthangthread.out" size="37098" author="ram_krish" created="Tue, 3 Jul 2012 09:20:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 3 Jul 2012 09:12:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245347</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i067yn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34221</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>