<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:09:54 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-3404/HBASE-3404.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-3404] Compaction Ordering for Bulk Import Files</title>
                <link>https://issues.apache.org/jira/browse/HBASE-3404</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We got into an issue today where we were using HFileOutputFormat to perform an incremental load on an already-large cluster.  Because bulk-loaded files don&apos;t have a sequence ID, they are put in the front of the StoreFile list.  This resulted in the following StoreFile ordering&lt;/p&gt;

&lt;p&gt;2GB (bulk) =&amp;gt; 25GB =&amp;gt; 2GB =&amp;gt; ...&lt;/p&gt;

&lt;p&gt;So this triggered a 30+GB major compaction for every single region.  Optimally, we would like bulk import files to be ordered in the compaction list at the time of insertion so this can be a much smaller compaction and rely on StoreFile age for major compaction trigger.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12494337">HBASE-3404</key>
            <summary>Compaction Ordering for Bulk Import Files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nspiegelberg">Nicolas Spiegelberg</assignee>
                                    <reporter username="nspiegelberg">Nicolas Spiegelberg</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Dec 2010 00:01:32 +0000</created>
                <updated>Sat, 11 Apr 2015 00:54:28 +0000</updated>
                            <resolved>Sat, 11 Apr 2015 00:54:28 +0000</resolved>
                                    <version>0.90.0</version>
                    <version>0.90.1</version>
                    <version>0.92.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="12976153" author="tlipcon" created="Fri, 31 Dec 2010 00:08:51 +0000"  >&lt;p&gt;I thought we had decided at some point that this ordering didn&apos;t matter anymore? If so, could we sort the storefiles by size before deciding which files to compact?&lt;/p&gt;</comment>
                            <comment id="12976155" author="nspiegelberg" created="Fri, 31 Dec 2010 00:27:51 +0000"  >&lt;p&gt;@Todd : You&apos;re thinking of the original idea for max compaction size pruning in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3209&quot; title=&quot;New Compaction Heuristic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3209&quot;&gt;&lt;del&gt;HBASE-3209&lt;/del&gt;&lt;/a&gt;, where my first diff attempted to sort the files, then compact.  The problem is that we use StoreFile seqid during compaction to determine which value to use when we encounter a duplicate ROW+COL+TS.  The problem is this:&lt;/p&gt;

&lt;p&gt;1.  we could have 3 StoreFiles with seqid &lt;span class=&quot;error&quot;&gt;&amp;#91;1,2,3&amp;#93;&lt;/span&gt;&lt;br/&gt;
2.  there is a duplicate in 1 &amp;amp; 2&lt;br/&gt;
3. we sort by size and 2 is small, so we compact &lt;span class=&quot;error&quot;&gt;&amp;#91;1,3&amp;#93;&lt;/span&gt;&lt;br/&gt;
4. the resulting StoreFile has seqid 3, so it would beat seqid 2 in compaction&lt;/p&gt;

&lt;p&gt;This fix should be addressed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2856&quot; title=&quot;TestAcidGuarantee broken on trunk &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2856&quot;&gt;&lt;del&gt;HBASE-2856&lt;/del&gt;&lt;/a&gt;, which associates each KV with a seqid.  However, I was hoping to get a quicker fix in for this case&lt;/p&gt;</comment>
                            <comment id="12976159" author="tlipcon" created="Fri, 31 Dec 2010 00:38:58 +0000"  >&lt;p&gt;How can we order it in the compaction list at the time of insertion? That would require editing the HFile in place to set its seqid, no?&lt;/p&gt;</comment>
                            <comment id="12976160" author="nspiegelberg" created="Fri, 31 Dec 2010 01:00:48 +0000"  >&lt;p&gt;The perils of choosing a sequence ID have been discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1923&quot; title=&quot;Bulk incremental load into an existing table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1923&quot;&gt;&lt;del&gt;HBASE-1923&lt;/del&gt;&lt;/a&gt;.  It seems like the biggest pitfall is making sure that the Bulk Upload seq id &amp;lt; lowest un-flushed sequence ID.  The discussion mentions that duplicate seqids would be perilous, but I&apos;m still trying to understand why this is the case.  The main problems seemed to be:&lt;/p&gt;

&lt;p&gt;1. StoreFiles was structured as Map&amp;lt;seqid, StoreFile&amp;gt;, didn&apos;t want to MultiMap. This is no longer the case.&lt;br/&gt;
2. If 2 StoreFiles have duplicate ROW+COL+TS, we discard the one with the lowest StoreFile seqid on compaction&lt;/p&gt;

&lt;p&gt;#2 is by far the hardest thing to worry about.  A couple options I have been thinking about:&lt;/p&gt;

&lt;p&gt;1. Query the region for the lowest un-flushed sequence ID on HFile create.  Don&apos;t worry about duplicate seq ids.&lt;br/&gt;
2. Like daughter files on split, create a special meta file on HRegionServer::bulkLoadHFile() that contains the seq id&lt;/p&gt;

&lt;p&gt;#1 is easier to implement, but has a couple edge case bugs.  I don&apos;t think you have to worry about duplicate seq ids, is there something obscure here? More importantly.  If a compaction happens between HFOF HFile create and HRegionServer::bulkLoadHFile(), then you don&apos;t deterministically know if the bulk load file will have the oldest seqid when it is inserted.  #2 is a pretty solid solution, albeit a little hacky.  It needs more code modification and could also be prone to odd race conditions (RS dies between writing the bulk seq id file &amp;amp; moving the actual bulk file).  Thoughts?&lt;/p&gt;</comment>
                            <comment id="13147507" author="nspiegelberg" created="Thu, 10 Nov 2011 05:48:12 +0000"  >&lt;p&gt;need to work with Amit to get bulk files put into the proper location by obtaining a sequence ID for the entire HFile that is being bulk imported.  I think it&apos;s sufficient to use the sequence ID at the time of file creation instead of at time of online insertion.  The only problem would be a second major compaction if one occurred during the HFile creation.&lt;/p&gt;</comment>
                            <comment id="13148234" author="hudson" created="Fri, 11 Nov 2011 02:56:37 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2427 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2427/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2427/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3690&quot; title=&quot;Option to Exclude Bulk Import Files from Minor Compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3690&quot;&gt;&lt;del&gt;HBASE-3690&lt;/del&gt;&lt;/a&gt; Option to Exclude Bulk Import Files from Minor Compaction&lt;/p&gt;

&lt;p&gt;Summary:&lt;br/&gt;
We ran an incremental scrape with HFileOutputFormat and&lt;br/&gt;
encountered major compaction storms. This is caused by the bug in&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-3404&quot; title=&quot;Compaction Ordering for Bulk Import Files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-3404&quot;&gt;&lt;del&gt;HBASE-3404&lt;/del&gt;&lt;/a&gt;. The permanent fix is a little tricky without &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2856&quot; title=&quot;TestAcidGuarantee broken on trunk &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2856&quot;&gt;&lt;del&gt;HBASE-2856&lt;/del&gt;&lt;/a&gt;. We&lt;br/&gt;
realized that a quicker solution for avoiding these compaction storms is&lt;br/&gt;
to simply exclude bulk import files from minor compactions and let them&lt;br/&gt;
only be handled by time-based major compactions. Add with functionality&lt;br/&gt;
along with a config option to enable it.&lt;/p&gt;

&lt;p&gt;Rewrote this feature to be done on a per-bulkload basis.&lt;/p&gt;

&lt;p&gt;Test Plan:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;mvn test -Dtest=TestHFileOutputFormat&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;DiffCamp Revision:&lt;/p&gt;

&lt;p&gt;Reviewers: stack, Kannan, JIRA, dhruba&lt;/p&gt;

&lt;p&gt;Reviewed By: stack&lt;/p&gt;

&lt;p&gt;CC: dhruba, lhofhansl, nspiegelberg, stack&lt;/p&gt;

&lt;p&gt;Differential Revision: 357&lt;/p&gt;

&lt;p&gt;nspiegelberg : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/mapreduce/HFileOutputFormat.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/StoreFile.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHFileOutputFormat.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12438532">HBASE-1923</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12502123">HBASE-3690</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12469746">HBASE-2856</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 31 Dec 2010 00:08:51 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26839</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02e0v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11873</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>