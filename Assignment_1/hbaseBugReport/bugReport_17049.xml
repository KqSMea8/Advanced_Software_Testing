<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:20:32 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-17049/HBASE-17049.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-17049] Find out why AsyncFSWAL issues much more syncs than FSHLog</title>
                <link>https://issues.apache.org/jira/browse/HBASE-17049</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-16890?focusedCommentId=15647590&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15647590&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-16890?focusedCommentId=15647590&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15647590&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13019207">HBASE-17049</key>
            <summary>Find out why AsyncFSWAL issues much more syncs than FSHLog</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12911749">HBASE-14790</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Apache9">Duo Zhang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Nov 2016 13:42:34 +0000</created>
                <updated>Tue, 6 Dec 2016 15:47:57 +0000</updated>
                                            <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>wal</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="15661591" author="apache9" created="Sun, 13 Nov 2016 14:47:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-17085&quot; title=&quot;AsyncFSWAL may issue unnecessary AsyncDFSOutput.sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-17085&quot;&gt;&lt;del&gt;HBASE-17085&lt;/del&gt;&lt;/a&gt; fix a problem which may cause unnecessary DFSOutput.sync. Will test the performance with the patch in place.&lt;/p&gt;</comment>
                            <comment id="15662787" author="apache9" created="Mon, 14 Nov 2016 05:06:18 +0000"  >&lt;p&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-17085&quot; title=&quot;AsyncFSWAL may issue unnecessary AsyncDFSOutput.sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-17085&quot;&gt;&lt;del&gt;HBASE-17085&lt;/del&gt;&lt;/a&gt; we can perform a little better in the PE.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;./bin/hbase org.apache.hadoop.hbase.PerformanceEvaluation --nomapred --presplit=50 --size=50 --columns=50 --valueSize=200 --writeToWAL=true --bloomFilter=NONE randomWrite 50

FSHLog: Min: 494940ms   Max: 527185ms   Avg: 520070ms
AsyncFSWAL-old: Min: 899553ms   Max: 937701ms   Avg: 931112ms
AsyncFSWAL-new:Min: 745193ms   Max: 770322ms   Avg: 764724ms
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Still slower than FSHLog. Need to find out more.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15667229" author="apache9" created="Tue, 15 Nov 2016 14:06:47 +0000"  >&lt;p&gt;I think I found a possible reason that why AsyncFSWAL issues &apos;more&apos; syncs than FSHLog.&lt;/p&gt;

&lt;p&gt;For FSHLog, if the currentPacket is full, then it will be queued to the dataQueue and processed by DataStreamer. We do not consider this as a sync. But for AsyncFSWAL, every packet that sent to DN will be included when compute the sync count. &lt;/p&gt;

&lt;p&gt;So the comparison of sync count in our WAL metrics is meaningless. We need to get the number of packets sent to DN for FSHLog and compare it with the sync count for AsyncFSWAL.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15669434" author="stack" created="Wed, 16 Nov 2016 05:04:53 +0000"  >&lt;p&gt;Agree. Compare packet sizes and their rates is next I think. Let me see if I can help here.&lt;/p&gt;</comment>
                            <comment id="15669565" author="ram_krish" created="Wed, 16 Nov 2016 06:14:23 +0000"  >&lt;p&gt;This is valid I think. Also almost for every 3 or 4 appends we create one packet and that is being synced.&lt;/p&gt;</comment>
                            <comment id="15669845" author="ram_krish" created="Wed, 16 Nov 2016 08:45:54 +0000"  >&lt;p&gt;One question though. The WALPE histogram should give a correct picture on the sync part, correct? Because they are calculated in the postSync API? &lt;/p&gt;</comment>
                            <comment id="15669890" author="apache9" created="Wed, 16 Nov 2016 09:04:40 +0000"  >&lt;p&gt;For FSHLog, the sync is done inside DFSOutputStream automatically if the buffer is full so we can not record it with our metrics.&lt;/p&gt;</comment>
                            <comment id="15673616" author="apache9" created="Thu, 17 Nov 2016 12:41:16 +0000"  >&lt;p&gt;Tried to delay sync so we can aggregate more appends before actually issue a sync. It could reduce the sync count greatly in WALPE with a 1ms delay, but the performance is also reduced... And for PE, I can not get a better result either...&lt;/p&gt;

&lt;p&gt;I also set the initial buffer size to 80KB in FanOutOneBlockDFSOutput as there is no progress in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-17048&quot; title=&quot;Calcuate suitable ByteBuf size when allocating send buffer in FanOutOneBlockAsyncDFSOutput&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-17048&quot;&gt;&lt;del&gt;HBASE-17048&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt; You guys could have a try to see if it helps. And you guys could also try changing the batchSize to see if it helps. For me it does not help either but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt; said use a large batchSize could get a better result for him.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15673648" author="apache9" created="Thu, 17 Nov 2016 12:55:36 +0000"  >&lt;p&gt;Delay sync is my last trick to aggregate more syncs. If it does not work, then I have no idea...&lt;/p&gt;

&lt;p&gt;As in the perf result posted by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;, it seems that AsyncFSWAL has less instructions but cost more time. I think it means that the AsyncFSWAL can not make use of all the cores on the machine. FSHLog does better than us. And I think it is reasonable. We use one thread to do everything, but FSHLog has one disruptor thread, five sync threads, one DataStreamer thread, and one Responder thread.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;FSHLog
4987370.861017 task-clock (msec)         #   12.922 CPUs utilized
9,934,495,287,070 cycles                 #    1.992 GHz
3,796,677,865,651 instructions           #    0.38  insns per cycle

AsyncFSWAL
4568572.588814 task-clock (msec)         #    7.454 CPUs utilized
9,292,754,813,201 cycles                 #    2.034 GHz
3,245,931,999,369 instructions           #    0.35  insns per cycle
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I think we should try multiwal next? With multiwal, we will have multiple AsyncFSWAL instance thus we could make use of more cores.&lt;/p&gt;

&lt;p&gt;What do you guys think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15692257" author="ram_krish" created="Thu, 24 Nov 2016 05:32:55 +0000"  >&lt;p&gt;Larger batch size with WALPE helped me. With default batch size I could see lesser performance. I could verify that.&lt;br/&gt;
Let me check &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-17048&quot; title=&quot;Calcuate suitable ByteBuf size when allocating send buffer in FanOutOneBlockAsyncDFSOutput&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-17048&quot;&gt;&lt;del&gt;HBASE-17048&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15692987" author="ram_krish" created="Thu, 24 Nov 2016 11:07:06 +0000"  >&lt;p&gt;Do you mean multiWAL per region? &lt;br/&gt;
Do you have the infra to run with 3 nodes with AsyncWAL (and with PE) to see how much Fanout is helping us. I think may be as there is only one node and there are flushes and compactions this eventloop that waits for response from DN is getting delayed for the response. &lt;/p&gt;</comment>
                            <comment id="15693114" author="apache9" created="Thu, 24 Nov 2016 12:11:52 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Do you mean multiWAL per region? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For a single region it is impossible to use more than one WAL, but I think in both PE and WALPE we are using at least 50 regions in our current tests?&lt;/p&gt;

&lt;p&gt;Yeah I have a cluster with 7 nodes, I could test AsyncFSWAL on it.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15693150" author="ram_krish" created="Thu, 24 Nov 2016 12:24:32 +0000"  >&lt;p&gt;I meant to ask WAL per region and that way multiWAL.&lt;/p&gt;</comment>
                            <comment id="15693165" author="apache9" created="Thu, 24 Nov 2016 12:30:05 +0000"  >&lt;p&gt;Fine. I think you could try multiwal and set &lt;tt&gt;hbase.wal.regiongrouping.numgroups&lt;/tt&gt; to 2, 4, or even more to see if it make some differences in your single node PE run.&lt;/p&gt;

&lt;p&gt;I will try a multi node WALPE and PE run tomorrow.&lt;/p&gt;</comment>
                            <comment id="15695104" author="ram_krish" created="Fri, 25 Nov 2016 07:33:58 +0000"  >&lt;p&gt;When we try with multiWAL and numgroups as 4 we are getting better performance almost in line with FSHLOG with multiWAL. I just tried with 10G data. Will try with bigger data. &lt;/p&gt;</comment>
                            <comment id="15695368" author="ram_krish" created="Fri, 25 Nov 2016 09:21:01 +0000"  >&lt;p&gt;With 50G of data still asyncWAL is slower with single node.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
fshlog - multiwal
 Min: 364747ms   Max: 381766ms   Avg: 377440ms

asyncfs - multiwal
Min: 442857ms   Max: 459009ms   Avg: 454908ms
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But it is not 2x slower as it used to be. &lt;/p&gt;</comment>
                            <comment id="15695391" author="apache9" created="Fri, 25 Nov 2016 09:28:29 +0000"  >&lt;p&gt;Good. At least we are making progress here. And I&apos;d say sorry that I have been stuck by an online service accident so I haven&apos;t got enough time to run the multi node test...&lt;/p&gt;

&lt;p&gt;Will test it this weekend...&lt;/p&gt;</comment>
                            <comment id="15721989" author="ram_krish" created="Mon, 5 Dec 2016 11:11:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Apache9&quot; class=&quot;user-hover&quot; rel=&quot;Apache9&quot;&gt;Duo Zhang&lt;/a&gt;&lt;br/&gt;
Any updates here?&lt;/p&gt;</comment>
                            <comment id="15723987" author="apache9" created="Tue, 6 Dec 2016 01:41:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt; Busy these days, haven&apos;t got enough time to setup the test environment yet...&lt;/p&gt;</comment>
                            <comment id="15725574" author="apache9" created="Tue, 6 Dec 2016 14:07:15 +0000"  >&lt;p&gt;I planned to run a single node HBase on a distributed HDFS, but the testing node which is in the same DC of the HDFS cluster is used by others these days. Will try this later, or I will just run a PE on a fully distributed cluster(both HBase and HDFS).&lt;/p&gt;

&lt;p&gt;And I have run a single node PE test with multiwal, BoundedGroupingStrategy, 8 wals.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;./bin/hbase org.apache.hadoop.hbase.PerformanceEvaluation --nomapred --presplit=50 --size=50 --columns=50 --valueSize=200 --writeToWAL=true --bloomFilter=NONE randomWrite 50

FSHLog: Min: 392959ms   Max: 413928ms   Avg: 406991ms
AsyncFSWAL: Min: 359566ms   Max: 397469ms   Avg: 391964ms
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;AsyncFSWAL is a bit faster. So I think this is the right way to increase the performance of AsyncFSWAL.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; Can you try to see if this also works for you sir? Both &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ram_krish&quot; class=&quot;user-hover&quot; rel=&quot;ram_krish&quot;&gt;ramkrishna.s.vasudevan&lt;/a&gt; and I can get a better result with multiwal(although in ram&apos;s test AsyncFSWAL is still a bit slower).&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15725863" author="stack" created="Tue, 6 Dec 2016 15:47:57 +0000"  >&lt;p&gt;Will do. Doing other tests at mo. Will be back to this soon.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13020354">HBASE-17085</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12839361" name="delay-sync.patch" size="12052" author="Apache9" created="Thu, 17 Nov 2016 12:41:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 16 Nov 2016 05:04:53 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i362gv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>