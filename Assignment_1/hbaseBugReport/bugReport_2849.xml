<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:05:16 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2849/HBASE-2849.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2849] HBase clients cannot recover when their ZooKeeper session becomes invalid</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2849</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Someone made mention of this loop last week but I don&apos;t think I filed an issue.  Here is another instance, again from a secret hbase admirer:&lt;/p&gt;

&lt;p&gt;&quot;It seems that when Zookeeper dies and restarts, all client applications need to be restarted too. I just restarted HBase in non-distributed mode (which includes a ZK) and now my application can&apos;t reconnect to ZK unless I restart it too.  I&apos;m stuck in this loop:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-07-19 00:13:05,725 INFO org.apache.zookeeper.server.NIOServerCnxn:
  Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /127.0.0.1:55153 (no session established &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client)
2010-07-19 00:13:07,052 INFO org.apache.zookeeper.server.NIOServerCnxn:
  Accepted socket connection from /127.0.0.1:55154
2010-07-19 00:13:07,053 INFO org.apache.zookeeper.server.NIOServerCnxn:
  Refusing session request &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /127.0.0.1:55154 as it has seen zxid 0xf5 our last zxid is 0xd7
  client must &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; another server
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12469634">HBASE-2849</key>
            <summary>HBase clients cannot recover when their ZooKeeper session becomes invalid</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tsuna">Benoit Sigoure</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Jul 2010 16:52:10 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:34 +0000</updated>
                            <resolved>Sat, 24 Jul 2010 05:19:53 +0000</resolved>
                                    <version>0.89.20100621</version>
                                    <fixVersion>0.90.0</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="12889919" author="tsuna" created="Mon, 19 Jul 2010 17:02:21 +0000"  >&lt;p&gt;Reformatting a little bit.&lt;/p&gt;</comment>
                            <comment id="12889934" author="streamy" created="Mon, 19 Jul 2010 17:32:13 +0000"  >&lt;p&gt;Client+ZK interaction just got a makeover in the master rewrite branch.  It now handles master failovers properly and re-initializes zk connections but I&apos;m not sure it will sustain a zk restart.  Any chance of a reproducing unit test?&lt;/p&gt;</comment>
                            <comment id="12891848" author="tsuna" created="Fri, 23 Jul 2010 23:01:50 +0000"  >&lt;p&gt;&lt;a href=&quot;http://hadoop.apache.org/zookeeper/docs/r3.3.1/api/org/apache/zookeeper/ZooKeeper.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://hadoop.apache.org/zookeeper/docs/r3.3.1/api/org/apache/zookeeper/ZooKeeper.html&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If for some reason, the client fails to send heart beats to the server for a prolonged period of time (exceeding the sessionTimeout value, for instance), the server will expire the session, and the session ID will become invalid. The client object will no longer be usable. To make ZooKeeper API calls, the application must create a new client object.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So apparently, a new &lt;tt&gt;ZooKeeper&lt;/tt&gt; object must be created when the session becomes invalid.  This sounds like a bad API, not sure why they did it this way.  In HBase&apos;s source code, it seems that the only thing that creates a &lt;tt&gt;ZooKeeper&lt;/tt&gt; instance is in &lt;tt&gt;ZooKeeperWrapper#reconnectToZk&lt;/tt&gt;.  This method, although it&apos;s public, is only called from 3 other methods in that class: the constructor, &lt;tt&gt;exists&lt;/tt&gt; and &lt;tt&gt;deleteUnassignedRegion&lt;/tt&gt;.  The latter, &lt;tt&gt;deleteUnassignedRegion&lt;/tt&gt;, is only used by the master.  The former, &lt;tt&gt;exists&lt;/tt&gt;, is only called from the following locations:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;ZKUnassignedWatcher&lt;/tt&gt;&apos;s constructor.  This is only used in the master.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RSZookeeperUpdater#startRegionCloseEvent&lt;/tt&gt;.  This is only used in the region server.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ZooKeeperWrapper#createOrUpdateUnassignedRegion&lt;/tt&gt;.  This is only used by the master&apos;s &lt;tt&gt;RegionManager&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ZooKeeperWrapper#createUnassignedRegion&lt;/tt&gt; and &lt;tt&gt;ZooKeeperWrapper#updateUnassignedRegion&lt;/tt&gt;.  Those two methods, even though they&apos;re public, are only called from &lt;tt&gt;ZooKeeperWrapper#createOrUpdateUnassignedRegion&lt;/tt&gt;, which itself is only used by the master&apos;s &lt;tt&gt;RegionManager&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In other words, for someone writing an HBase application, only a single &lt;tt&gt;ZooKeeper&lt;/tt&gt; instance gets created when the &lt;tt&gt;ZooKeeperWrapper&lt;/tt&gt; is instantiated.  Any failure that causes the client&apos;s session to become invalid will is unrecoverable with the current code and the client has to be killed and restarted.&lt;/p&gt;

&lt;p&gt;Jonathan, is the work being done for the master rewrite branch going to address this issue?  Bear in mind that here I&apos;m concerned about HBase &lt;b&gt;client&lt;/b&gt; applications.&lt;/p&gt;</comment>
                            <comment id="12891851" author="streamy" created="Fri, 23 Jul 2010 23:06:21 +0000"  >&lt;p&gt;It would be possible for the client to try to reconnect after being expired.  It&apos;s not built-in to the way I have it now but it&apos;s possible to add it.&lt;/p&gt;</comment>
                            <comment id="12891923" author="tsuna" created="Sat, 24 Jul 2010 03:58:09 +0000"  >&lt;p&gt;Patch that fixes the issue.  Actually there was some logic I didn&apos;t notice earlier in &lt;tt&gt;HConnectionManager&lt;/tt&gt; to attempt to deal with ZK failures and reconnect when needed, but the code wasn&apos;t doing the right thing and didn&apos;t work when there was a disconnection between the HBase client and the ZK quorum.  So the patch is rather simple and consists in fixing the existing logic in &lt;tt&gt;HConnectionManager.ClientZKWatcher&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I tested this by starting a long running HBase application, killing the whole ZooKeeper ensemble and restarting it.  The application experiences a hiccup while ZK is unavailable and is able to recover automatically soon after the ZK quorum is back online.  Someone else is more than welcome to write a unit test that simulates this scenario if they feel like it.&lt;/p&gt;</comment>
                            <comment id="12891933" author="stack" created="Sat, 24 Jul 2010 05:19:53 +0000"  >&lt;p&gt;Committed.  Thats for the &apos;duh&apos; patch Ben&#244;it.&lt;/p&gt;</comment>
                            <comment id="15016746" author="lars_francke" created="Fri, 20 Nov 2015 12:40:34 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12450384" name="0001-HBASE-2849-Have-HBase-clients-recover-from-ZooKeeper.patch" size="2321" author="tsuna" created="Sat, 24 Jul 2010 03:58:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 19 Jul 2010 17:02:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26495</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hji7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100422</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>reliability, zookeeper</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>