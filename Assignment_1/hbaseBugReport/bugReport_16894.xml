<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:18:53 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-16894/HBASE-16894.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-16894] Create more than 1 split per region, generalize HBASE-12590</title>
                <link>https://issues.apache.org/jira/browse/HBASE-16894</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;A common request from users is to be able to better control how many map tasks are created per region. Right now, it is always 1 region = 1 input split = 1 map task. Same goes for Spark since it uses the TIF. With region sizes as large as 50 GBs, it is desirable to be able to create more than 1 split per region.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12590&quot; title=&quot;A solution for data skew in HBase-Mapreduce Job&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12590&quot;&gt;&lt;del&gt;HBASE-12590&lt;/del&gt;&lt;/a&gt; adds a config property for MR jobs to be able to handle skew in region sizes. The algorithm is roughly: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
If (region size &amp;gt;= average size*ratio) : cut the region into two MR input splits
If (average size &amp;lt;= region size &amp;lt; average size*ratio) : one region as one MR input split
If (sum of several continuous regions size &amp;lt; average size * ratio): combine these regions into one MR input split.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Although we can set data skew ratio to be 0.5 or something to abuse &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12590&quot; title=&quot;A solution for data skew in HBase-Mapreduce Job&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12590&quot;&gt;&lt;del&gt;HBASE-12590&lt;/del&gt;&lt;/a&gt; into creating more than 1 split task per region, it is not ideal. But there is no way to create more with the patch as it is. For example we cannot create more than 2 tasks per region. &lt;/p&gt;

&lt;p&gt;If we want to fix this properly, we should extend the approach in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12590&quot; title=&quot;A solution for data skew in HBase-Mapreduce Job&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12590&quot;&gt;&lt;del&gt;HBASE-12590&lt;/del&gt;&lt;/a&gt;, and make it so that the client can specify the desired num of mappers, or desired split size, and the TIF generates the splits based on the current region sizes very similar to the algorithm in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12590&quot; title=&quot;A solution for data skew in HBase-Mapreduce Job&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12590&quot;&gt;&lt;del&gt;HBASE-12590&lt;/del&gt;&lt;/a&gt;, but a more generic way. This also would eliminate the hand tuning of data skew ratio.&lt;/p&gt;

&lt;p&gt;We also can think about the guidepost approach that Phoenix has in the stats table which is used for exactly this purpose. Right now, the region can be split into powers of two assuming uniform distribution within the region. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="13014022">HBASE-16894</key>
            <summary>Create more than 1 split per region, generalize HBASE-12590</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="easyliangjob">Yi Liang</assignee>
                                    <reporter username="enis">Enis Soztutar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Oct 2016 19:06:53 +0000</created>
                <updated>Tue, 13 Dec 2016 03:21:14 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                <comments>
                            <comment id="15593036" author="esteban" created="Thu, 20 Oct 2016 21:15:09 +0000"  >&lt;p&gt;+1 I have seen this request few times and one solution is to override TableInputFormat#getSplits are you suggesting just to add a tunable parameter only? or should we pass a custom split list?&lt;/p&gt;</comment>
                            <comment id="15593219" author="enis" created="Thu, 20 Oct 2016 22:26:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;or should we pass a custom split list?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think the users will generally not know these splits points. It should be hbase which keeps track of region boundaries and internally split points within the regions. As a user, the API should be like create a split for every 5GB, or there should be a total of X map tasks. &lt;/p&gt;</comment>
                            <comment id="15677428" author="easyliangjob" created="Fri, 18 Nov 2016 18:48:13 +0000"  >&lt;p&gt;   I have not seen any activity on this jira, so I will work on this one. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;, from your description, if I understand correctly for you intention, then I have some proposal for this jira&lt;br/&gt;
     (1) To split large regions and maybe merge too small regions:&lt;br/&gt;
     (2) It is better for customer to specify desired split size for each split&lt;br/&gt;
     (2) Algorithm to extend the algorithm in HBase-12590&lt;br/&gt;
           If (region size &amp;gt; split size + threshold) : cut the region into (regionsize/splitsize)  MR input splits&lt;br/&gt;
           If (split size - threshold &amp;lt;= region size &amp;lt;= split size + threshold) : one region as one MR input split&lt;br/&gt;
           If (sum of several continuous regions size &amp;lt; split size - threshold): combine these continuous regions into one MR input split. &lt;br/&gt;
        The threshold may be based on the input split size.&lt;br/&gt;
Is there any other suggestion?  Thanks&lt;/p&gt;</comment>
                            <comment id="15678039" author="enis" created="Fri, 18 Nov 2016 23:01:48 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=easyliangjob&quot; class=&quot;user-hover&quot; rel=&quot;easyliangjob&quot;&gt;Yi Liang&lt;/a&gt; for picking up this. My suggestion is to start with at least these requirements: &lt;br/&gt;
For jobs that READ from HBase, we would like the user to be able to use any of these three methods:  &lt;br/&gt;
(1) Users should be able to specify total number of maps desired, and HBase comes up with Splits grouping / splitting regions based on sizes and number of required maps. Example is that if table has 100 regions, but we want the MR jobs to run with 200 splits, or if table has 100 regions but we want to run only 50 map tasks. &lt;br/&gt;
(2) Users should be able to specify the input split size, which will then determine how many map tasks are created. User will specify the size as let&apos;s say 2GB, and HBase TableInputFormat will create 1 split per roughly 2 GB of data depending on existing region sizes (An 8GB region will be split into 4, two 1GB neighbor regions are combined into 2GB regions, etc). &lt;br/&gt;
(3) Users should be able to specify how many splits per region she wants. If 100 regions, and tasks per region is 3, then we will generate 300 splits. The current way HBase works will be using 1 task-per-region as default. &lt;/p&gt;

&lt;p&gt;For Jobs that WRITE to HBase, then we should be able to specify any of these two methods: &lt;br/&gt;
(1) Users should be able to specify total number of reducers desired, and HBase comes up with partitioning based on region boundaries. Note that especially in bulk load, we do not want to group more than 1 region per task (unlike the map case). The number of requested reducers will be just a hint, and HBase might end up generating more reducers. &lt;br/&gt;
(2) Users should be able to specify how many reducers per region we want. &lt;/p&gt;

&lt;p&gt;Let me know if makes sense or not. There is usually no good way to know the exact split points within the region to see how you can divide the region into N pieces. The code that &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12590&quot; title=&quot;A solution for data skew in HBase-Mapreduce Job&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12590&quot;&gt;&lt;del&gt;HBASE-12590&lt;/del&gt;&lt;/a&gt; assumes text or binary keys and uniform distribution. We can also look into improving that, by asking the region server hosting the region about the split points (which should be calculated from hfile indexes, similar to the mid point calculation that we have in region splits) or we can look into maintaining equi-width histograms for keys (Phoenix guideposts). We can do these suggestions in a follow up issue. &lt;/p&gt;</comment>
                            <comment id="15678066" author="easyliangjob" created="Fri, 18 Nov 2016 23:13:16 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; for your reply, it is really helpful &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I will do more research and focus on this jira to see if I can come up with better solution.&lt;/p&gt;</comment>
                            <comment id="15678115" author="esteban" created="Fri, 18 Nov 2016 23:34:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; I&apos;ve created another JIRA so we can discuss the WRITE case there: &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-17130&quot; title=&quot;Add support to specify an arbitrary number of reducers when writing HFiles for bulk load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-17130&quot;&gt;HBASE-17130&lt;/a&gt;. The expectation for a user would be to specify a fixed number of reducer. We have been discussing an interesting edge case when a table has some skew due the key design and it would be helpful to write in a single reducer HFiles for multiple regions.&lt;/p&gt;</comment>
                            <comment id="15678327" author="enis" created="Sat, 19 Nov 2016 01:33:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;We have been discussing an interesting edge case when a table has some skew due the key design and it would be helpful to write in a single reducer HFiles for multiple regions.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For HBase TableOutputFormat where the output record writer directly writes to HBase, it might be fine to combine multiple regions in a single reducer since the client will do the correct thing of finding relevant locations to write to. However, for bulk load and HFileOutputFormat, we should not have more than 1 region per reduce task. It is &quot;by design&quot; that we should have at least one reducer per region since the bulk load process cannot load partial ranges from an hfile. Created HFile must fit into the region boundaries otherwise the BL client will manually split and rewrite the file, thus causing serial and unnecessary work. &lt;/p&gt;</comment>
                            <comment id="15687897" author="easyliangjob" created="Tue, 22 Nov 2016 21:09:23 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;, &lt;br/&gt;
   I just did some research on how to find split points for region, and come up with a idea using hfile index in the attached google doc,  I think you are expert on this part,  could you take a look, Thanks. &lt;br/&gt;
This doc is only for read from HBase&lt;br/&gt;
  (3) Users should be able to specify how many splits per region she wants.&lt;/p&gt;

&lt;p&gt; The link is &lt;a href=&quot;https://docs.google.com/document/d/1C4_ggQ8MZM_COVLJe8JqiPC1FWTBdA-rDKACelTOojw/edit?usp=sharing&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://docs.google.com/document/d/1C4_ggQ8MZM_COVLJe8JqiPC1FWTBdA-rDKACelTOojw/edit?usp=sharing&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15688128" author="davelatham" created="Tue, 22 Nov 2016 22:29:33 +0000"  >&lt;p&gt;Deriving split points from the actual distribution of data as captured in HFiles sounds great.  However, as a user of a large cluster I&apos;m worried that a single threaded process doing HDFS operations for every region in a table with 10k, 100k, or more regions could take a great deal of time and/or bottleneck on the NameNode.  Since the region servers already likely have the index data cached, taking advantage of it would be great if possible.&lt;/p&gt;</comment>
                            <comment id="15715737" author="easyliangjob" created="Fri, 2 Dec 2016 17:26:41 +0000"  >&lt;p&gt;After discuss with Enis, we have some ideas for this jira,&lt;br/&gt;
 (1) Given the requirements in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-16894&quot; title=&quot;Create more than 1 split per region, generalize HBASE-12590&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-16894&quot;&gt;HBASE-16894&lt;/a&gt;, generalize the logic of doing more than 1 mapper / reducer per region. This will use the RegionSplitter to calculate the split points within the regions if needed. This will assume uniform distribution, and will calculate split points from just the start / end keys, not the actual data. &lt;br/&gt;
 (2) Find a way to calculate split points from existing data. &lt;/p&gt;

&lt;p&gt;Notice that doing (1) does not require (2) but (1) will give us a lot of benefits even without (2). So, I would suggest we should concentrate on doing the patch for (1) in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-16894&quot; title=&quot;Create more than 1 split per region, generalize HBASE-12590&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-16894&quot;&gt;HBASE-16894&lt;/a&gt;. Again, we won&apos;t use any statistics or ask the regionservers, etc for this. We will use just the region start / end key boundaries and uniform distribution. &lt;/p&gt;

&lt;p&gt;After doing (1), we can create a follow up jira to do (2). There is already some work that is recent in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-16169&quot; title=&quot;Make RegionSizeCalculator scalable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-16169&quot;&gt;&lt;del&gt;HBASE-16169&lt;/del&gt;&lt;/a&gt;. This makes it so that the client asks every regionserver for the region size calculation. I think we can piggy-back on this and have the region server return some split points based on the actual indexes as well as a part of the RegionLoad object. The Region itself can maintain a small list of guideposts and make that available in the RegionLoad object when asked. This way we won&apos;t have to maintain this info externally in a table or something, but it will still be available on demand.  &lt;/p&gt;

&lt;p&gt;Again, I think we should do the patch for (1) first, then only after that focus on solving (2). &lt;/p&gt;</comment>
                            <comment id="15733167" author="easyliangjob" created="Thu, 8 Dec 2016 19:18:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=esteban&quot; class=&quot;user-hover&quot; rel=&quot;esteban&quot;&gt;Esteban Gutierrez&lt;/a&gt;,&lt;br/&gt;
   I have attach the code for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; requirement, you can review it at &lt;a href=&quot;https://reviews.apache.org/r/54512/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.apache.org/r/54512/&lt;/a&gt;&lt;br/&gt;
and also attach the implementation doc and some question in the attached file. Could you guys take a look. Thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13021880">HBASE-17130</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12842396" name="ImplementaionAndSomeQuestion.docx" size="153608" author="easyliangjob" created="Thu, 8 Dec 2016 19:17:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 20 Oct 2016 21:15:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i356hj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>