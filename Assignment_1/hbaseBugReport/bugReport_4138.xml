<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:16:14 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4138/HBASE-4138.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4138] If zookeeper.znode.parent is not specifed explicitly in Client code then HTable object loops continuously waiting for the root region by using /hbase as the base node.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4138</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Change the zookeeper.znode.parent property (default is /hbase).&lt;br/&gt;
Now do not specify this change in the client code.&lt;/p&gt;

&lt;p&gt;Use the HTable Object.&lt;br/&gt;
The HTable is not able to find the root region and keeps continuously looping.&lt;/p&gt;

&lt;p&gt;Find the stack trace:&lt;br/&gt;
====================&lt;br/&gt;
Object.wait(long) line: not available &lt;span class=&quot;error&quot;&gt;&amp;#91;native method&amp;#93;&lt;/span&gt;		 &lt;br/&gt;
RootRegionTracker(ZooKeeperNodeTracker).blockUntilAvailable(long) line: 122&lt;/p&gt;

&lt;p&gt;RootRegionTracker.waitRootRegionLocation(long) line: 73		 &lt;br/&gt;
HConnectionManager$HConnectionImplementation.locateRegion(byte[],&lt;br/&gt;
byte[], boolean) line: 578&lt;br/&gt;
HConnectionManager$HConnectionImplementation.locateRegion(byte[],&lt;br/&gt;
byte[]) line: 558&lt;br/&gt;
HConnectionManager$HConnectionImplementation.locateRegionInMeta(byte[],&lt;br/&gt;
byte[], byte[], boolean, Object) line: 687&lt;br/&gt;
HConnectionManager$HConnectionImplementation.locateRegion(byte[],&lt;br/&gt;
byte[], boolean) line: 589&lt;br/&gt;
HConnectionManager$HConnectionImplementation.locateRegion(byte[],&lt;br/&gt;
byte[]) line: 558&lt;br/&gt;
HConnectionManager$HConnectionImplementation.locateRegionInMeta(byte[],&lt;br/&gt;
byte[], byte[], boolean, Object) line: 687&lt;br/&gt;
HConnectionManager$HConnectionImplementation.locateRegion(byte[],&lt;br/&gt;
byte[], boolean) line: 593&lt;br/&gt;
HConnectionManager$HConnectionImplementation.locateRegion(byte[],&lt;br/&gt;
byte[]) line: 558&lt;br/&gt;
HTable.&amp;lt;init&amp;gt;(Configuration, byte[]) line: 171		 &lt;br/&gt;
HTable.&amp;lt;init&amp;gt;(Configuration, String) line: 145		 &lt;br/&gt;
HBaseTest.test() line: 45&lt;/p&gt;</description>
                <environment></environment>
        <key id="12515226">HBASE-4138</key>
            <summary>If zookeeper.znode.parent is not specifed explicitly in Client code then HTable object loops continuously waiting for the root region by using /hbase as the base node.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ram_krish">ramkrishna.s.vasudevan</assignee>
                                    <reporter username="ram_krish">ramkrishna.s.vasudevan</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Jul 2011 09:02:58 +0000</created>
                <updated>Fri, 20 Nov 2015 11:56:07 +0000</updated>
                            <resolved>Thu, 25 Aug 2011 10:54:36 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.92.0</fixVersion>
                                    <component>Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13070520" author="ram_krish" created="Mon, 25 Jul 2011 14:28:42 +0000"  >&lt;p&gt;1. I tried to identify the problem in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4138&quot; title=&quot;If zookeeper.znode.parent is not specifed explicitly in Client code then HTable object loops continuously waiting for the root region by using /hbase as the base node.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4138&quot;&gt;&lt;del&gt;HBASE-4138&lt;/del&gt;&lt;/a&gt;.  I ended up in the following analysis,&lt;/p&gt;

&lt;p&gt;The HMaster creates the BASENODE along with unassigned node, RS node and table node based on &lt;br/&gt;
the zookeeper.znode.parent property.&lt;/p&gt;

&lt;p&gt;Currently when we use the HTable() as part of getConnection() if the this value is  not configured&lt;br/&gt;
we tend to create a new connection.&lt;/p&gt;

&lt;p&gt;Two points to not here is - &lt;br/&gt;
1)The HTable documentation clearly states us to use the same configuration object.&lt;/p&gt;


&lt;p&gt;But what if its not done, particularly someone forgets to set this base node property.  Even it may be&lt;br/&gt;
like in my RS instance i have configured the property but not in the master instance.&lt;/p&gt;

&lt;p&gt;2)The reuse of the getConnection() logic across all levels, was it intended ?&lt;/p&gt;

&lt;p&gt;The major problem lies in the the HConnectionManager.setupZookeeperTrackers() which tries to&lt;br/&gt;
create the BASENODES again.&lt;/p&gt;

&lt;p&gt;What i feel here is,&lt;br/&gt;
this should not be done as only the master should have the rights to create it else there are&lt;br/&gt;
high possibility that muliple basenodes can be created.&lt;/p&gt;

&lt;p&gt;Currently as the Client creates the node once again with the default value &apos;/hbase&apos;&lt;br/&gt;
the client keeps waiting to know the root location indefinitely.&lt;/p&gt;

&lt;p&gt;What happens in the Admin case:&lt;br/&gt;
The same thing happens in admin case but in HBaseAdmin() we call the connection.getMaster api&lt;br/&gt;
which throws an exception.  &lt;br/&gt;
&apos;ZooKeeper available but no active master location found&apos;&lt;/p&gt;

&lt;p&gt;So we should prevent the Admin or HTable (In general any client even RS ) from creating the &lt;br/&gt;
base nodes and what ever is created by the master should be used by the clients.&lt;/p&gt;</comment>
                            <comment id="13070755" author="stack" created="Mon, 25 Jul 2011 21:04:13 +0000"  >&lt;p&gt;@Ram Your reasoning sounds right to me.  I agree &quot;...we should prevent the Admin or HTable (In general any client even RS ) from creating the base nodes and what ever is created by the master should be used by the clients.&quot;&lt;/p&gt;

&lt;p&gt;Thanks for digging in on this.&lt;/p&gt;</comment>
                            <comment id="13071153" author="ram_krish" created="Tue, 26 Jul 2011 15:26:07 +0000"  >&lt;p&gt;I am planning to make the following changes, &lt;br/&gt;
If the ZookeeperWatcher is called by the HMaster then I will be creating a new constructor allowing it to create the base node.&lt;br/&gt;
For all other components RS, HBaseAdmin, HTable I will not allow the base node creation.  Including Replication related code.  &lt;br/&gt;
This will ensure that only master creates the base node and no other component can create it.&lt;br/&gt;
Is this change fine ? I have tested it in my testing environment.  &lt;br/&gt;
There are some related testcases which I had to change so the changes may be in  more places.&lt;br/&gt;
If it is fine, should i give patch for trunk and 0.90.x version or only for trunk so that I can prepare the patch and upload it asap.  &lt;br/&gt;
Thanks in advance.&lt;/p&gt;</comment>
                            <comment id="13071180" author="yuzhihong@gmail.com" created="Tue, 26 Jul 2011 15:59:19 +0000"  >&lt;p&gt;I think the above plan looks good.&lt;br/&gt;
Prepare patch for TRUNK for now. If users complain about this in 0.90.4, we can consider back porting.&lt;/p&gt;</comment>
                            <comment id="13072336" author="ram_krish" created="Thu, 28 Jul 2011 13:27:16 +0000"  >&lt;p&gt;Uploaded patch once again as the ZookeeperWatcher.java got changed after i prepared the first patch. &lt;/p&gt;</comment>
                            <comment id="13072359" author="yuzhihong@gmail.com" created="Thu, 28 Jul 2011 14:05:14 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; errorMsg = &lt;span class=&quot;code-quote&quot;&gt;&quot;ZooKeeper available but base node mismatch.  Check the value configured in the &apos;zookeeper.znode.parent&apos;.  &quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The first sentence looks redundant with succeeding sentences, making the line longer than 80 characters. It can be omitted.&lt;br/&gt;
For ZooKeeperNodeTracker.java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+      abortable
+          .abort(
+              &lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected exception handling &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; checking &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; basenode exists.&quot;&lt;/span&gt;,
+              e);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;can be condensed into one line with message &quot;Exception while checking if basenode exists&quot;&lt;br/&gt;
For ZooKeeperWatcher ctor, the following is redundant:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ZooKeeperConnectionException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Remove this comment which you have done in this JIRA:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
       &lt;span class=&quot;code-comment&quot;&gt;// TODO: Move &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to an init method somewhere so not everyone calls it?&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Are all tests passing for you ?&lt;/p&gt;

&lt;p&gt;Good work.&lt;/p&gt;</comment>
                            <comment id="13072409" author="ram_krish" created="Thu, 28 Jul 2011 16:14:47 +0000"  >&lt;p&gt;Ted, &lt;br/&gt;
Thanks for your comments.&lt;/p&gt;

&lt;p&gt;I have addressed your comments and resubmitted.&lt;br/&gt;
I ran the test cases and it worked.  &lt;/p&gt;
</comment>
                            <comment id="13072616" author="yuzhihong@gmail.com" created="Fri, 29 Jul 2011 00:09:05 +0000"  >&lt;p&gt;Running test suite on patch version 3.&lt;/p&gt;</comment>
                            <comment id="13072677" author="yuzhihong@gmail.com" created="Fri, 29 Jul 2011 04:50:57 +0000"  >&lt;p&gt;Test suite timed out:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Running org.apache.hadoop.hbase.master.TestSplitLogManager
killed.
[INFO] ------------------------------------------------------------------------
[ERROR] BUILD ERROR
[INFO] ------------------------------------------------------------------------
[INFO] Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; executing forked tests.; nested exception is org.apache.maven.surefire.booter.shade.org.codehaus.plexus.util.cli.CommandLineException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; executing external command, process killed.

&lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt; timeout out after 900 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Running this test manually I saw:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; prio=10 tid=0x0000000049d4c000 nid=0x356 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00000000403bb000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
        - waiting on &amp;lt;0x00000000e61b9d30&amp;gt; (a org.apache.hadoop.hbase.master.SplitLogManager$TaskBatch)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:485)
        at org.apache.hadoop.hbase.master.TestSplitLogManager.testTaskDone(TestSplitLogManager.java:338)
        - locked &amp;lt;0x00000000e61b9d30&amp;gt; (a org.apache.hadoop.hbase.master.SplitLogManager$TaskBatch)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But this test didn&apos;t hang on Jenkins ...&lt;/p&gt;</comment>
                            <comment id="13072706" author="ram_krish" created="Fri, 29 Jul 2011 06:38:50 +0000"  >&lt;p&gt;@Ted, &lt;br/&gt;
The TestSplitLogManager.java has passed in  #2056.  After that it is getting skipped till the latest build.&lt;/p&gt;

&lt;p&gt;The failure you are saying should not be because of this patch.  Anyway will just try to see if i can findout anything in that. Thanks Ted.&lt;/p&gt;</comment>
                            <comment id="13072711" author="yuzhihong@gmail.com" created="Fri, 29 Jul 2011 07:00:31 +0000"  >&lt;p&gt;I don&apos;t think failure of TestSplitLogManager was related to this JIRA either.&lt;br/&gt;
TestSplitLogManager hung in build 2061 on Jenkins.&lt;/p&gt;</comment>
                            <comment id="13072826" author="yuzhihong@gmail.com" created="Fri, 29 Jul 2011 13:46:28 +0000"  >&lt;p&gt;Integrated to TRUNK.&lt;/p&gt;

&lt;p&gt;Thanks for the patch Ramkrishna.&lt;/p&gt;</comment>
                            <comment id="13072882" author="hudson" created="Fri, 29 Jul 2011 16:05:11 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2063 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2063/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2063/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4138&quot; title=&quot;If zookeeper.znode.parent is not specifed explicitly in Client code then HTable object loops continuously waiting for the root region by using /hbase as the base node.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4138&quot;&gt;&lt;del&gt;HBASE-4138&lt;/del&gt;&lt;/a&gt;  If zookeeper.znode.parent is not specifed explicitly in Client&lt;br/&gt;
               code then HTable object loops continuously waiting for the root region&lt;br/&gt;
               by using /hbase as the base node.(ramkrishna.s.vasudevan)&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperWatcher.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestRestartCluster.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/RootRegionTracker.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/zookeeper/TestZKTable.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/handler/TestOpenRegionHandler.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13089590" author="yuzhihong@gmail.com" created="Tue, 23 Aug 2011 17:14:52 +0000"  >&lt;p&gt;It is unfortunate that this JIRA resulted in intermittent test failures.&lt;br/&gt;
In build 2132, we saw:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalArgumentException: Check the value configured in &apos;zookeeper.znode.parent&apos;. There could be a mismatch with the one configured in the master.
	at org.apache.hadoop.hbase.zookeeper.RootRegionTracker.waitRootRegionLocation(RootRegionTracker.java:78)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:754)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:734)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegionInMeta(HConnectionManager.java:867)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:766)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:734)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegionInMeta(HConnectionManager.java:867)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:770)
	at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.locateRegion(HConnectionManager.java:734)
	at org.apache.hadoop.hbase.client.HTable.&amp;lt;init&amp;gt;(HTable.java:199)
	at org.apache.hadoop.hbase.client.HTable.&amp;lt;init&amp;gt;(HTable.java:155)
	at org.apache.hadoop.hbase.client.TestHTablePool$TestHTablePoolType$1.&amp;lt;init&amp;gt;(TestHTablePool.java:165)
	at org.apache.hadoop.hbase.client.TestHTablePool$TestHTablePoolType.testReturnDifferentTable(TestHTablePool.java:165)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13089616" author="ram_krish" created="Tue, 23 Aug 2011 17:47:09 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
Will look into the reason for failure.&lt;/p&gt;</comment>
                            <comment id="13090049" author="ram_krish" created="Wed, 24 Aug 2011 07:18:11 +0000"  >&lt;p&gt;Even build #2119 failed and the same 3 testcases failed due to the same exception.&lt;/p&gt;</comment>
                            <comment id="13090147" author="ram_krish" created="Wed, 24 Aug 2011 11:51:43 +0000"  >&lt;p&gt;@Ted,&lt;br/&gt;
I debugged and arrived at some points about test failure.  Pls check and correct me if my analysis is wrong.&lt;br/&gt;
-&amp;gt; In all the failure scenarios we can see that the just before the exception has occured a new connection was formed.  The test cases invoke new HTable(), in which it flows to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;HConnectionManager.getConnection(conf);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;-&amp;gt; now a new connection is retrieved. The new zookeeper connection tries to watch the master and root region server node.(MasterAddressTracker.start() and RootRegionTracker().start()&lt;br/&gt;
-&amp;gt; In ZKUtil.watchAndCheckExists() api &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      Stat s = zkw.getRecoverableZooKeeper().exists(znode, zkw);
      LOG.debug(zkw.prefix(&lt;span class=&quot;code-quote&quot;&gt;&quot;Set watcher on existing znode &quot;&lt;/span&gt; + znode));
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; s != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; : &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We were printing the log msg and then returning.  If you see the failure logs this znode has the proper value like /hbase/master. Now if this had returned true, the next step &lt;br/&gt;
in start() api will be to get the data&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; [] data = ZKUtil.getDataAndWatch(watcher, node);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But if there had been some data then the log&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LOG.debug(zkw.prefix(&lt;span class=&quot;code-quote&quot;&gt;&quot;Retrieved &quot;&lt;/span&gt; + ((data == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)? 0: data.length) +
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;should be present but it is not present and there are no exceptions also.&lt;br/&gt;
So ideally what has happened is &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ZKUtil.watchAndCheckExists()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; has returned false.  This api will return false when the node does not exist.&lt;br/&gt;
Now what we need to know is in what scenario the node /hbase itself will get deleted and also what made the new HTable() to create a new connection.  (May be the connection got deleted.)&lt;br/&gt;
One more thing we need to add is in HConnectionManager.setupZookeeperTrackers() &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    masterAddressTracker.start()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;if he is not able to establish watch he should throw error.  Correct me if am wrong. &lt;/p&gt;</comment>
                            <comment id="13090237" author="yuzhihong@gmail.com" created="Wed, 24 Aug 2011 14:08:30 +0000"  >&lt;p&gt;@Ramkrishna:&lt;br/&gt;
Thanks for the analysis.&lt;br/&gt;
masterAddressTracker.start() doesn&apos;t have return value. How do you think we should check for inability of establishing watch ?&lt;/p&gt;

&lt;p&gt;I am adding the following log in ZooKeeperNodeTracker.start():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
           &lt;span class=&quot;code-comment&quot;&gt;// It existed but now does not, &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; again to ensure a watch is set
&lt;/span&gt;+          LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Try starting again because there is no data from &quot;&lt;/span&gt; + node);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13090251" author="ram_krish" created="Wed, 24 Aug 2011 14:25:15 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
One more thing we can add.&lt;br/&gt;
In ZKUtil.watchAndCheckExists() we can make a small change&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != s){
      LOG.debug(zkw.prefix(&lt;span class=&quot;code-quote&quot;&gt;&quot;Set watcher on existing znode &quot;&lt;/span&gt; + znode));
      }
      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;{
        LOG.debug(zkw.prefix(&lt;span class=&quot;code-quote&quot;&gt;&quot;znode &quot;&lt;/span&gt; + znode+&lt;span class=&quot;code-quote&quot;&gt;&quot; does not exist.  No data retrieved from it.&quot;&lt;/span&gt;));
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Instead of &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      LOG.debug(zkw.prefix(&lt;span class=&quot;code-quote&quot;&gt;&quot;Set watcher on existing znode &quot;&lt;/span&gt; + znode));
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; s != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; : &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This will let us know in future in case of same failure if really the node existed or not. &lt;/p&gt;</comment>
                            <comment id="13090253" author="ram_krish" created="Wed, 24 Aug 2011 14:26:20 +0000"  >&lt;p&gt;Because the existing code first prints a debug msg saying a watcher is set without checking if the node exists or not.&lt;br/&gt;
This is actually a bit confusing.( I felt so).&lt;/p&gt;</comment>
                            <comment id="13090315" author="hudson" created="Wed, 24 Aug 2011 16:02:32 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2139 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2139/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2139/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4138&quot; title=&quot;If zookeeper.znode.parent is not specifed explicitly in Client code then HTable object loops continuously waiting for the root region by using /hbase as the base node.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4138&quot;&gt;&lt;del&gt;HBASE-4138&lt;/del&gt;&lt;/a&gt; Add debug log in ZooKeeperNodeTracker.start()&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13090335" author="ram_krish" created="Wed, 24 Aug 2011 16:48:29 +0000"  >&lt;p&gt;@Ted&lt;br/&gt;
Thanks for adding the change ZKUtil.java also.  What could be the reason for the node not to exist and why was a new connection established?&lt;br/&gt;
These 2 we may have to figure out exactly.&lt;/p&gt;</comment>
                            <comment id="13090370" author="hudson" created="Wed, 24 Aug 2011 17:52:31 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-23 #4 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-23/4/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-23/4/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4138&quot; title=&quot;If zookeeper.znode.parent is not specifed explicitly in Client code then HTable object loops continuously waiting for the root region by using /hbase as the base node.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4138&quot;&gt;&lt;del&gt;HBASE-4138&lt;/del&gt;&lt;/a&gt; Change debug log in ZKUtil.watchAndCheckExists()&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4138&quot; title=&quot;If zookeeper.znode.parent is not specifed explicitly in Client code then HTable object loops continuously waiting for the root region by using /hbase as the base node.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4138&quot;&gt;&lt;del&gt;HBASE-4138&lt;/del&gt;&lt;/a&gt; Add debug log in ZooKeeperNodeTracker.start()&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperNodeTracker.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13090419" author="hudson" created="Wed, 24 Aug 2011 19:23:22 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #2140 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/2140/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/2140/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4138&quot; title=&quot;If zookeeper.znode.parent is not specifed explicitly in Client code then HTable object loops continuously waiting for the root region by using /hbase as the base node.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4138&quot;&gt;&lt;del&gt;HBASE-4138&lt;/del&gt;&lt;/a&gt; Change debug log in ZKUtil.watchAndCheckExists()&lt;/p&gt;

&lt;p&gt;tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13090877" author="ram_krish" created="Thu, 25 Aug 2011 09:04:53 +0000"  >&lt;p&gt;I have cracked the reason for the build failure.&lt;br/&gt;
There are two problems:&lt;br/&gt;
-&amp;gt; Some prev zk cluster was not shutdown (or the port 21818 was busy)&lt;br/&gt;
-&amp;gt; The connection caching logic uses zookeeper client port as the connection key.&lt;/p&gt;

&lt;p&gt;Consider the log in the failed build #2132 for the testcase TestScannerTimeOut&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2011-08-23 04:30:11,195 INFO  [main] zookeeper.MiniZooKeeperCluster(141): Failed binding ZK Server to client port: 21818
2011-08-23 04:30:11,226 INFO  [main] zookeeper.MiniZooKeeperCluster(164): Started MiniZK Cluster and connect 1 ZK server on client port: 21819
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;By default we try connecting to 21818 but as it was not bindable we connect to 21819. (may be the port was busy).&lt;/p&gt;

&lt;p&gt;After starting the miniZkCluster&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;hbase.zookeeper.property.clientPort&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.toString(clientPort));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;we set this port in the config object.&lt;br/&gt;
So for RS and Master the zookeeper client port will be 21819.&lt;br/&gt;
Now when the testcase starts running there is no testcase till test3686a where we need a client connection.&lt;br/&gt;
Now as part of test3686a we create new HTable() which calls&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;(HBaseConfiguration.create(), tableName);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here we create a new configuration object.  Hence the zookeeper client port is taken to be 21818.&lt;br/&gt;
Ideally due to improper shutdown of some prev zk cluster that was running in 21818 the test case was able to connect to this but the port being different it could not find the /hbase node.&lt;br/&gt;
Hence the failure has happened.&lt;br/&gt;
The remaining two testcases in TestHTablePool that failed also has the similar problem.  Even the failure in build #2119 is exactly the same.&lt;br/&gt;
There should be a mechanism from the test for the client code to know to which zk he should connect to.  I have reproduced this problem. Can we provide a fix for this? &lt;/p&gt;
</comment>
                            <comment id="13090879" author="ram_krish" created="Thu, 25 Aug 2011 09:07:24 +0000"  >&lt;p&gt;While creating the MiniZKCluster we can first kill the zk if anything is running in the default port and then create a new one.&lt;br/&gt;
Is there any possibility of getting this in production code also?&lt;/p&gt;</comment>
                            <comment id="13090880" author="ram_krish" created="Thu, 25 Aug 2011 09:19:32 +0000"  >&lt;p&gt;Another intersting thing&lt;br/&gt;
All testcases are using new HTable(conf, tablename).&lt;br/&gt;
Only these 3 test cases are using it like new HTable(tablename).  Hence the problem.&lt;/p&gt;

&lt;p&gt;I will submit a patch with the change so that it becomes a permanent fix.&lt;/p&gt;</comment>
                            <comment id="13090884" author="ram_krish" created="Thu, 25 Aug 2011 09:25:31 +0000"  >&lt;p&gt;Since the build failure mentioned in this issue is not related raising a seperate issue for handling this.&lt;/p&gt;</comment>
                            <comment id="13090900" author="ram_krish" created="Thu, 25 Aug 2011 09:52:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;-&amp;gt; The connection caching logic uses zookeeper client port as the connection key.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I am not sure if this is a problem. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13090927" author="yuzhihong@gmail.com" created="Thu, 25 Aug 2011 10:54:36 +0000"  >&lt;p&gt;Thanks for the finding.&lt;br/&gt;
It is good that the enhancement in this JIRA catches deficiencies in existing test cases.&lt;/p&gt;</comment>
                            <comment id="13091616" author="stack" created="Fri, 26 Aug 2011 06:07:44 +0000"  >&lt;p&gt;The stuff where we&apos;d start up zk on other than the default node and then subsequent tests would fail because they are expected zk on default port is an old issue; a revamp of tests made it so they should work in this scenario.  Maybe the failing ones are new tests that do HBaseConfiguration.create rather than use the test Configuration which will have the proper zk port set?&lt;/p&gt;</comment>
                            <comment id="13091624" author="ram_krish" created="Fri, 26 Aug 2011 06:30:44 +0000"  >&lt;p&gt;@Stack&lt;br/&gt;
Yes Stack. what you say is right.  But it took a lot of time to identify the problem.&lt;br/&gt;
After 1 day only i found that there is a port change that the ZK was using and the one in the error msg.&lt;br/&gt;
May be i was not aware of this existing thing.  But finally found the problem. &lt;/p&gt;</comment>
                            <comment id="13091956" author="stack" created="Fri, 26 Aug 2011 19:03:20 +0000"  >&lt;p&gt;@Ram I am not denying it took a long time to find (It probably took me 2x what it took you to figure it).  So, you did the fix elsewhere?&lt;/p&gt;</comment>
                            <comment id="13092176" author="stack" created="Sat, 27 Aug 2011 03:12:41 +0000"  >&lt;p&gt;Ok, I see that &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4253&quot; title=&quot;Intermittent test failure because of missing config parameter in new HTable(tablename)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4253&quot;&gt;&lt;del&gt;HBASE-4253&lt;/del&gt;&lt;/a&gt; is fixing this.&lt;/p&gt;</comment>
                            <comment id="13092229" author="ram_krish" created="Sat, 27 Aug 2011 08:33:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;@Ram (It probably took me 2x what it took you to figure it)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  &lt;/p&gt;</comment>
                            <comment id="13766832" author="ranjitbhaskar" created="Fri, 13 Sep 2013 19:11:55 +0000"  >&lt;p&gt;I&apos;m running Version 0.94.6-cdh4.3.0 (Cloudera Hadoop VM). I&apos;m still getting this error while trying to run the status command in the shell. Can you please help me out with this?&lt;/p&gt;</comment>
                            <comment id="15016663" author="lars_francke" created="Fri, 20 Nov 2015 11:56:07 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12520084">HBASE-4253</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12488065" name="HBASE-4138_trunk_1.patch" size="17969" author="ram_krish" created="Thu, 28 Jul 2011 06:12:38 +0000"/>
                            <attachment id="12488096" name="HBASE-4138_trunk_2.patch" size="15365" author="ram_krish" created="Thu, 28 Jul 2011 13:18:37 +0000"/>
                            <attachment id="12488113" name="HBASE-4138_trunk_3.patch" size="15212" author="ram_krish" created="Thu, 28 Jul 2011 16:13:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 25 Jul 2011 21:04:13 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27186</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hpjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101401</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>