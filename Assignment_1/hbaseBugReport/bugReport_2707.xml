<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:04:07 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2707/HBASE-2707.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2707] Can&apos;t recover from a dead ROOT server if any exceptions happens during log splitting</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2707</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;There&apos;s an almost easy way to get stuck after a RS holding ROOT dies, usually from a GC-like event. It happens frequently to my TestReplication in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2223&quot; title=&quot;Handle 10min+ network partitions between clusters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2223&quot;&gt;&lt;del&gt;HBASE-2223&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Some logs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2010-06-10 11:35:52,090 INFO  [master] wal.HLog(1175): Spliting is done. Removing old log dir hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:55814/user/jdcryans/.logs/10.10.1.63,55846,1276194933831
&lt;/span&gt;2010-06-10 11:35:52,095 WARN  [master] master.RegionServerOperationQueue(183): Failed processing: ProcessServerShutdown of 10.10.1.63,55846,1276194933831; putting onto delayed todo queue
java.io.IOException: Cannot delete: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:55814/user/jdcryans/.logs/10.10.1.63,55846,1276194933831
&lt;/span&gt;        at org.apache.hadoop.hbase.regionserver.wal.HLog.splitLog(HLog.java:1179)
        at org.apache.hadoop.hbase.master.ProcessServerShutdown.process(ProcessServerShutdown.java:298)
        at org.apache.hadoop.hbase.master.RegionServerOperationQueue.process(RegionServerOperationQueue.java:149)
        at org.apache.hadoop.hbase.master.HMaster.run(HMaster.java:456)
Caused by: java.io.IOException: java.io.IOException: /user/jdcryans/.logs/10.10.1.63,55846,1276194933831 is non empty
2010-06-10 11:35:52,097 DEBUG [master] master.RegionServerOperationQueue(126): -ROOT- isn&apos;t online, can&apos;t process delayedToDoQueue items
2010-06-10 11:35:53,098 DEBUG [master] master.RegionServerOperationQueue(126): -ROOT- isn&apos;t online, can&apos;t process delayedToDoQueue items
2010-06-10 11:35:53,523 INFO  [main.serverMonitor] master.ServerManager$ServerMonitor(131): 1 region servers, 1 dead, average load 14.0[10.10.1.63,55846,1276194933831]
2010-06-10 11:35:54,099 DEBUG [master] master.RegionServerOperationQueue(126): -ROOT- isn&apos;t online, can&apos;t process delayedToDoQueue items
2010-06-10 11:35:55,101 DEBUG [master] master.RegionServerOperationQueue(126): -ROOT- isn&apos;t online, can&apos;t process delayedToDoQueue items
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The last lines are my own debug. Since we don&apos;t process the delayed todo if ROOT isn&apos;t online, we&apos;ll never reassign the regions. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12466680">HBASE-2707</key>
            <summary>Can&apos;t recover from a dead ROOT server if any exceptions happens during log splitting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Jun 2010 18:44:48 +0000</created>
                <updated>Fri, 20 Nov 2015 12:42:39 +0000</updated>
                            <resolved>Sat, 26 Jun 2010 00:06:16 +0000</resolved>
                                                    <fixVersion>0.90.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12877599" author="jdcryans" created="Thu, 10 Jun 2010 22:17:46 +0000"  >&lt;p&gt;Stack and I talked a lot about it, here&apos;s what we came up with. It&apos;s very hard for me to come up with a unit test since it&apos;s all deep in the master and very much time-based, but I tested the patch with TestReplication a lot and 1) it doesn&apos;t fail anymore and 2) I see in the logs that the master does the right thing.&lt;/p&gt;

&lt;p&gt;Should I commit this?&lt;/p&gt;</comment>
                            <comment id="12877705" author="stack" created="Fri, 11 Jun 2010 04:24:48 +0000"  >&lt;p&gt;I think we need  a test for this because i can&apos;t see how &lt;del&gt;ROOT&lt;/del&gt; is recovered if the code in processervershutdown#process is like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!rootRescanned) {
      &lt;span class=&quot;code-comment&quot;&gt;// Scan the ROOT region
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ScanRootRegion(
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MetaRegion(master.getRegionManager().getRootRegionLocation(),
              HRegionInfo.ROOT_REGIONINFO), &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master).doWithRetries();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// Master is closing - give up
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
      }

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt; server shutdown scanning root region on &quot;&lt;/span&gt; +
          master.getRegionManager().getRootRegionLocation().getBindAddress() +
          &lt;span class=&quot;code-quote&quot;&gt;&quot; finished &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName());
      }
      rootRescanned = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the current server being processed held the &lt;del&gt;ROOT&lt;/del&gt; and the first thing we do processing a shutdown of a server that held root is to clear the root location, how is the above code succeeding?&lt;/p&gt;

&lt;p&gt;Assigning myself to mess w/ a test.&lt;/p&gt;</comment>
                            <comment id="12877706" author="stack" created="Fri, 11 Jun 2010 04:25:34 +0000"  >&lt;p&gt;Oh, regards the patch, I think it definetly an improvement over what was there before (what was there before was silly &amp;#8211; it made this bug that J-D filed).&lt;/p&gt;</comment>
                            <comment id="12881976" author="jdcryans" created="Thu, 24 Jun 2010 00:18:50 +0000"  >&lt;p&gt;I&apos;m marking this a as blocker for &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2223&quot; title=&quot;Handle 10min+ network partitions between clusters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2223&quot;&gt;&lt;del&gt;HBASE-2223&lt;/del&gt;&lt;/a&gt;, my test fails sometimes without the patch. Also I must have ran my test with this patch almost 40 times (I&apos;m almost always running it) and I never got any issue. &lt;/p&gt;</comment>
                            <comment id="12882638" author="jdcryans" created="Fri, 25 Jun 2010 17:10:57 +0000"  >&lt;p&gt;So actually the code of process is looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Log split complete, meta reassignment and scanning:&quot;&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.isRootServer) {
      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;ProcessServerShutdown reassigning ROOT region&quot;&lt;/span&gt;);
      master.getRegionManager().reassignRootRegion();
      isRootServer = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;  &lt;span class=&quot;code-comment&quot;&gt;// prevent &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; reassignment... heh.
&lt;/span&gt;    }

    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MetaRegion metaRegion : metaRegions) {
      LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;ProcessServerShutdown setting to unassigned: &quot;&lt;/span&gt; + metaRegion.toString());
      master.getRegionManager().setUnassigned(metaRegion.getRegionInfo(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    }
    &lt;span class=&quot;code-comment&quot;&gt;// one the meta regions are online, &lt;span class=&quot;code-quote&quot;&gt;&quot;forget&quot;&lt;/span&gt; about them.  Since there are explicit
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// checks below to make sure meta/root are online, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is likely to occur.
&lt;/span&gt;    metaRegions.clear();

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!rootAvailable()) {
      &lt;span class=&quot;code-comment&quot;&gt;// Return &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; so that worker does not put &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; request back on the
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// toDoQueue.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// rootAvailable() has already put it on the delayedToDoQueue
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!rootRescanned) {
      &lt;span class=&quot;code-comment&quot;&gt;// Scan the ROOT region
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ScanRootRegion(
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MetaRegion(master.getRegionManager().getRootRegionLocation(),
              HRegionInfo.ROOT_REGIONINFO), &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.master).doWithRetries();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// Master is closing - give up
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
      }

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt; server shutdown scanning root region on &quot;&lt;/span&gt; +
          master.getRegionManager().getRootRegionLocation().getBindAddress() +
          &lt;span class=&quot;code-quote&quot;&gt;&quot; finished &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName());
      }
      rootRescanned = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So if the RS had &lt;del&gt;ROOT&lt;/del&gt;, it will be reassigned right away and then the method returns if !rootAvailable. Later when we come back and root was assigned, process server shutdown will finish its job. This is how the code you pasted succeeds.&lt;/p&gt;</comment>
                            <comment id="12882649" author="stack" created="Fri, 25 Jun 2010 17:28:31 +0000"  >&lt;p&gt;So its broken then?  We assign &lt;del&gt;ROOT&lt;/del&gt; but don&apos;t recover its edits?&lt;/p&gt;</comment>
                            <comment id="12882653" author="stack" created="Fri, 25 Jun 2010 17:35:18 +0000"  >&lt;p&gt;Hmm... chatted with J-D and he points out that the above runs AFTER logs are split so I had it incorrect.  Above should be good.&lt;/p&gt;</comment>
                            <comment id="12882773" author="stack" created="Fri, 25 Jun 2010 23:58:34 +0000"  >&lt;p&gt;Test that puts off the processing of the shutdown of the server that was carrying root.  This test never completes.  With the patch in place, it does.&lt;/p&gt;</comment>
                            <comment id="12882776" author="jdcryans" created="Sat, 26 Jun 2010 00:03:44 +0000"  >&lt;p&gt;+1 but minor nit, why isn&apos;t DELAY private?&lt;/p&gt;</comment>
                            <comment id="12882777" author="stack" created="Sat, 26 Jun 2010 00:06:16 +0000"  >&lt;p&gt;Committed.  Thanks for review J-D (I removed DELAY altogether).&lt;/p&gt;</comment>
                            <comment id="12882870" author="stack" created="Sat, 26 Jun 2010 17:58:43 +0000"  >&lt;p&gt;Backport to 0.20.  Please review.  I&apos;d like this to go into 0.20 since it hoses cluster if it ever happens.&lt;/p&gt;</comment>
                            <comment id="12882871" author="stack" created="Sat, 26 Jun 2010 17:59:45 +0000"  >&lt;p&gt;Moving into 0.20.6.&lt;/p&gt;</comment>
                            <comment id="12882876" author="stack" created="Sat, 26 Jun 2010 18:26:44 +0000"  >&lt;p&gt;Taking out of 0.20.6.  Open separate issue.  The attached 0.20 patch is not enough.  The change would be more major than this patch presumes.&lt;/p&gt;</comment>
                            <comment id="12888959" author="stack" created="Thu, 15 Jul 2010 23:54:39 +0000"  >&lt;p&gt;Latest iteration.  What is currently in place is currently broke it turns out.  More on this later.&lt;/p&gt;</comment>
                            <comment id="15017307" author="lars_francke" created="Fri, 20 Nov 2015 12:42:39 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12456177">HBASE-2223</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12448135" name="2707-0.20.txt" size="1116" author="stack" created="Sat, 26 Jun 2010 17:58:43 +0000"/>
                            <attachment id="12448111" name="2707-test.txt" size="13525" author="stack" created="Fri, 25 Jun 2010 23:58:34 +0000"/>
                            <attachment id="12446804" name="HBASE-2707.patch" size="1890" author="jdcryans" created="Thu, 10 Jun 2010 22:17:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 11 Jun 2010 04:24:48 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26424</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hiun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100316</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>