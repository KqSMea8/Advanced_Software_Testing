<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:50:10 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-14141/HBASE-14141.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-14141] HBase Backup/Restore Phase 3: Filter WALs on backup to include only edits from backup tables</title>
                <link>https://issues.apache.org/jira/browse/HBASE-14141</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description></description>
                <environment></environment>
        <key id="12846691">HBASE-14141</key>
            <summary>HBase Backup/Restore Phase 3: Filter WALs on backup to include only edits from backup tables</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="3" iconUrl="https://issues.apache.org/jira/images/icons/statuses/inprogress.png" description="This issue is being actively worked on at the moment by the assignee.">In Progress</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="vrodionov">Vladimir Rodionov</assignee>
                                    <reporter username="vrodionov">Vladimir Rodionov</reporter>
                        <labels>
                            <label>backup</label>
                    </labels>
                <created>Tue, 21 Jul 2015 21:17:02 +0000</created>
                <updated>Wed, 7 Dec 2016 22:36:08 +0000</updated>
                                            <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                <comments>
                            <comment id="15200124" author="vrodionov" created="Thu, 17 Mar 2016 18:34:02 +0000"  >&lt;p&gt;Moved to Phase 3.&lt;/p&gt;</comment>
                            <comment id="15437847" author="jinghe" created="Thu, 25 Aug 2016 22:31:27 +0000"  >&lt;p&gt;Given the multiWAL support now available, is it something we can leverage, by manipulating the RegionGroupingStrategy?&lt;/p&gt;</comment>
                            <comment id="15438144" author="vrodionov" created="Thu, 25 Aug 2016 23:41:54 +0000"  >&lt;p&gt;Good idea, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinghe&quot; class=&quot;user-hover&quot; rel=&quot;jinghe&quot;&gt;Jerry He&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15438215" author="yuzhihong@gmail.com" created="Fri, 26 Aug 2016 00:47:47 +0000"  >&lt;p&gt;Suppose there&apos;re two backup sets:&lt;br/&gt;
set A contains tables X and Y&lt;br/&gt;
set B contains tables Y and Z&lt;/p&gt;

&lt;p&gt;Would tables X, Y and Z each have their own WALs ?&lt;/p&gt;</comment>
                            <comment id="15645161" author="vrodionov" created="Mon, 7 Nov 2016 19:24:08 +0000"  >&lt;p&gt;Two approaches&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Directfiltering&quot;&gt;&lt;/a&gt;Direct filtering&lt;/h5&gt;

&lt;p&gt;We can filter WAL during copy operation to include only edits for a tables being backed up.&lt;/p&gt;

&lt;p&gt;Pro:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Flexibility ?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Contra:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Complexity. Requires new version of DistCp or other custom MR job&lt;/li&gt;
	&lt;li&gt;Complexity. Tracking WALs eligible for deletion becomes a nightmare.  When WAL is closed we need to write all tables in a current incremental backup set in hbase:backup table and create record for every table:WAL with initial state something like WAIT. Then we will have to update state of these records after each incremental backup session and keep WAL until all records are updated. Two issues:
	&lt;ol&gt;
		&lt;li&gt;Atomicity of combination of events: WAL closing and getting list of tables from hbase:backup.&lt;/li&gt;
		&lt;li&gt;Handling of table deletion and removing tables from backup set&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Complexity. All backup destination file structures needs to be changed&lt;/li&gt;
&lt;/ol&gt;


&lt;h5&gt;&lt;a name=&quot;HaveaseparateWALgroupfortablesinbackup&quot;&gt;&lt;/a&gt;Have a separate WAL group for tables in backup&lt;/h5&gt;

&lt;p&gt;We have a dedicated WAL group for tables we want to backup. Table MUST be assigned to this group if we want to backup it. This is something that could be done by  manipulating RegionGroupingStrategy, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinghe&quot; class=&quot;user-hover&quot; rel=&quot;jinghe&quot;&gt;Jerry He&lt;/a&gt; suggested.&lt;/p&gt;

&lt;p&gt;Pro:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Simplicity of implementation&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Contra:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Requires documentation how-to to explain how to optimize backup in case of subset of tables.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I personally like the latter one.&lt;/p&gt;
</comment>
                            <comment id="15648714" author="vrodionov" created="Tue, 8 Nov 2016 20:33:06 +0000"  >&lt;p&gt;Continued.&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;RegionGroupingProvider%2CRegionGroupingStrategyAPIchange&quot;&gt;&lt;/a&gt;RegionGroupingProvider, RegionGroupingStrategy API change&lt;/h5&gt;

&lt;p&gt;Currently both work on encoded region names, where it is impossible to extract table names from.  So we will need to modify API and add table names to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; WAL getWAL(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] identifier, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] namespace)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;calls. &lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;NewRegionGroupingStrategyBackupRegionGroupingStrategy&quot;&gt;&lt;/a&gt;New RegionGroupingStrategy - BackupRegionGroupingStrategy&lt;/h5&gt;

&lt;ul&gt;
	&lt;li&gt;There will be a dedicated group for tables in backups.&lt;/li&gt;
	&lt;li&gt;It is a wrapper for default or a user specified RegionGroupingStrategy. It returns backup group name for  a table in a  backup list (from hbase:backup), otherwise it calls default strategy&lt;/li&gt;
	&lt;li&gt;Group name for backup tables is well known (hardcoded)&lt;/li&gt;
&lt;/ul&gt;


&lt;h5&gt;&lt;a name=&quot;Changestocurrentimplementation&quot;&gt;&lt;/a&gt;Changes to current implementation&lt;/h5&gt;

&lt;h6&gt;&lt;a name=&quot;Allbackupoperationsonlyonbackupsets&quot;&gt;&lt;/a&gt;All backup operations only on backup sets&lt;/h6&gt;

&lt;p&gt;Users won&apos;t be able to run backup on table or list of tables - only on backup sets, but users still be able to restore a single table.&lt;/p&gt;

&lt;h6&gt;&lt;a name=&quot;Backupsetadd%2Fremove&quot;&gt;&lt;/a&gt;Backup set add / remove&lt;/h6&gt;

&lt;p&gt;After adding/removing table to/from backup set, system disables/enables table to read new backup set content (for activating/deactivating backup WAL for a table)&lt;/p&gt;

&lt;p&gt;Upd. Instead of direct disable/enable we can implement procedure, which updates WAL instance in HRegion (may be tricky)&lt;/p&gt;








</comment>
                            <comment id="15648716" author="vrodionov" created="Tue, 8 Nov 2016 20:34:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=devaraj&quot; class=&quot;user-hover&quot; rel=&quot;devaraj&quot;&gt;Devaraj Das&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu&quot; class=&quot;user-hover&quot; rel=&quot;tedyu&quot;&gt;Ted Yu&lt;/a&gt;, what do you think?&lt;/p&gt;</comment>
                            <comment id="15648765" author="yuzhihong@gmail.com" created="Tue, 8 Nov 2016 20:57:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;Group name for backup tables is well known (hardcoded)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can you elaborate on the above hardcode ?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;system disables/enables table to read new backup set content &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why is the above needed ? Is this for the BACKUPREGIONGROUPINGSTRATEGY to reflect the change ?&lt;/p&gt;</comment>
                            <comment id="15648837" author="vrodionov" created="Tue, 8 Nov 2016 21:26:21 +0000"  >&lt;p&gt;WAL is updated on open region only. That is why we need disable/enable table after table being added to backup set.&lt;/p&gt;

&lt;p&gt;As for hardcoded group name - there is no need to make it configurable I think. That is internal id used by backup exclusively. &lt;/p&gt;</comment>
                            <comment id="15648875" author="vrodionov" created="Tue, 8 Nov 2016 21:41:56 +0000"  >&lt;p&gt;Continued&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Twomodeofdeployments&quot;&gt;&lt;/a&gt;Two mode of deployments&lt;/h5&gt;

&lt;h6&gt;&lt;a name=&quot;Standard&quot;&gt;&lt;/a&gt;Standard &lt;/h6&gt;
&lt;p&gt;When all or majority of tables require backup/restore. This is what we have right now.&lt;/p&gt;

&lt;h6&gt;&lt;a name=&quot;Limited&quot;&gt;&lt;/a&gt;Limited&lt;/h6&gt;
&lt;p&gt;Usually small subset of table will require backup/restore. This is subject of this JIRA.&lt;/p&gt;

&lt;h6&gt;&lt;a name=&quot;Switchingbetweenmodes&quot;&gt;&lt;/a&gt;Switching between modes &lt;/h6&gt;
&lt;p&gt;Switching will delete all backup meta - basically all backup data will be lost. This is by design to not encourage users to switch back and forth and to simplify implementation.&lt;/p&gt;
</comment>
                            <comment id="15650007" author="devaraj" created="Wed, 9 Nov 2016 06:57:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vrodionov&quot; class=&quot;user-hover&quot; rel=&quot;vrodionov&quot;&gt;Vladimir Rodionov&lt;/a&gt; is there a way in which we can reliably identify the WALs that need to be kept track of, when a request for an incremental backup comes. Like, if there are multiple WALs, and some of them are part of a backup set or something, and some are not, can we make that distinction, and store the metadata about these. We could totally stay out of the business of doing anything WAL specific, but we should just be able to query some metadata state about which specific WALs we should back up when a request for an incremental backup comes... The default implementation could be returning all the WALs that are currently present in the WAL directory, and they are all backed up (this is what we have today).&lt;br/&gt;
I guess it&apos;s an extension to what you say above, but am trying to see if things can be simplified. So am proposing we flip it around, and say that if someone wants to take backups, they need to plan for it, and set up WALs appropriately.&lt;/p&gt;</comment>
                            <comment id="15651473" author="vrodionov" created="Wed, 9 Nov 2016 17:09:54 +0000"  >&lt;p&gt;In case of multiWAL only group name is common for WAL files belonging to that group. So you will have to specify group name.&lt;/p&gt;</comment>
                            <comment id="15652509" author="enis" created="Thu, 10 Nov 2016 00:29:54 +0000"  >&lt;p&gt;I think it is not a good idea to permanently couple the backup-set with the WAL grouping. These are orthogonal concerns, multi-wal is mainly used for performance and using more disks and should not be bound by how backup sets are defined. Let&apos;s say I have a single huge table in the cluster, and a single backup set. This means that we cannot use multi-wal at all, making the design decision a non-starter. &lt;/p&gt;

&lt;p&gt;We also have to think about the failure case where a WAL will be left un-closed in case of RS dead. We cannot rely on a mechanism to write data in WAL close because it will never be reliable. Even if we do a solution where we keep track of Tables/Regions in the WAL and retroactively write this info to the backup metadata, we have to design the system so that WALs from RS failures are handled. &lt;/p&gt;</comment>
                            <comment id="15652672" author="vrodionov" created="Thu, 10 Nov 2016 01:47:08 +0000"  >&lt;blockquote&gt;
&lt;p&gt;We also have to think about the failure case where a WAL will be left un-closed in case of RS dead. We cannot rely on a mechanism to write data in WAL close because it will never be reliable. Even if we do a solution where we keep track of Tables/Regions in the WAL and retroactively write this info to the backup metadata, we have to design the system so that WALs from RS failures are handled.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We already depend on WALs for incremental backup. If WAL is unreliable so is HBase. Backup can&apos;t be more reliable than WAL/HBase. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Let&apos;s say I have a single huge table in the cluster, and a single backup set. This means that we cannot use multi-wal at all, making the design decision a non-starter.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No. In this case, default mode is the way to go (what we have now).&lt;/p&gt;</comment>
                            <comment id="15654894" author="enis" created="Thu, 10 Nov 2016 19:29:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;We already depend on WALs for incremental backup. If WAL is unreliable so is HBase. Backup can&apos;t be more reliable than WAL/HBase.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not sure whether I understand what you are saying. The above paragraph is not talking about WAL being unreliable, but the fact that we cannot design the backup to depend on writing some metadata reliably on WAL close. writing to WAL and writing metadata to backup table on WAL close are very different things. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;No. In this case, default mode is the way to go (what we have now).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Why are we complicating the design with two different modes, and switching and everything. How will any user chose which one to use? I think we should stick to a single mode / solution that will work for most of the cases rather than complicating the life of the user and also maintaining the backup code for two different code paths.  &lt;/p&gt;</comment>
                            <comment id="15655207" author="vrodionov" created="Thu, 10 Nov 2016 21:30:43 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Why are we complicating the design with two different modes, and switching and everything. How will any user chose which one to use? I think we should stick to a single mode / solution that will work for most of the cases rather than complicating the life of the user and also maintaining the backup code for two different code paths.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We introduce non-default mode for those customers who wants to save some bytes in a backup remote storage. This mode is not default one and must be activated explicitly.&lt;/p&gt;

&lt;p&gt;The pro- of this approach - it does not require &lt;b&gt;significant&lt;/b&gt; code change (read my first post).&lt;br/&gt;
I do not think that adding additional system switch (mode) complicates life of end user.&lt;br/&gt;
There will be no two different code paths for these modes - just one. &lt;/p&gt;</comment>
                            <comment id="15730155" author="vrodionov" created="Wed, 7 Dec 2016 22:36:08 +0000"  >&lt;p&gt;Overall high level design:&lt;/p&gt;

&lt;p&gt;Backup:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;New MR job (WAL2HFile), which runs in a first phase of incremental backup.
	&lt;ol&gt;
		&lt;li&gt;WAL2HFile first get list of tables registered in hbase:backup, then for every table from this list generates HFiles (one per region)&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;In a second phase DistCp moves these files to a backup destination&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Restore (incremental)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;No need to WALPlayer job&lt;/li&gt;
	&lt;li&gt;For every table from restore list, HFileSplitter job will collect all HFile(s), split them into new region boundaries.&lt;/li&gt;
	&lt;li&gt;LoadHFileIncremental loads newly created files.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Security: no issues we run under hbase user.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;We no longer keep WAL files in backup destination - only HFiles&lt;/b&gt;. This significantly reduce storage requirements for backup data.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12863549">HBASE-14414</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 25 Aug 2016 22:31:27 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2hirr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>