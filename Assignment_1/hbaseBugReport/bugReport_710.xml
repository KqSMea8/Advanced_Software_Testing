<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:46:48 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-710/HBASE-710.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-710] If clocks are way off, then we can have daughter split come before rather than after its parent in .META.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-710</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;On the Jon Gray cluster, his clocks are skewed badly.  I see weird stuff in .META.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-06-25 14:57:57,728 DEBUG org.apache.hadoop.hbase.HMaster: HMaster.metaScanner regioninfo: {regionname: items,823ce1e3-d414-474f-ac70-c4081cecef0f,1214416614697, startKey: &amp;lt;823ce1e3-d414-474f-ac70-c4081cecef0f&amp;gt;, endKey: &amp;lt;86f8df20-e237-4bb3-9748-88cef892bd70&amp;gt;, encodedName: 1157924217, offline: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, split: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, tableDesc: {name: items, families: {cfrecs:={name: cfrecs, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, clusters:={name: clusters, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, content:={name: content, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, readby:={name: readby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, receivedby:={name: receivedby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, savedby:={name: savedby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, sentby:={name: sentby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}}}, server: 192.168.249.223:60020, startCode: 1214406344634
2008-06-25 14:57:57,732 DEBUG org.apache.hadoop.hbase.HMaster: HMaster.metaScanner regioninfo: {regionname: items,823ce1e3-d414-474f-ac70-c4081cecef0f,1214416641213, startKey: &amp;lt;823ce1e3-d414-474f-ac70-c4081cecef0f&amp;gt;, endKey: &amp;lt;83fca0e2-f324-4f9e-99c1-1fdbeff63b3d&amp;gt;, encodedName: 541300165, tableDesc: {name: items, families: {cfrecs:={name: cfrecs, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, clusters:={name: clusters, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, content:={name: content, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, readby:={name: readby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, receivedby:={name: receivedby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, savedby:={name: savedby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, sentby:={name: sentby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}}}, server: 192.168.249.220:60020, startCode: 1214424347649
2008-06-25 14:57:57,738 DEBUG org.apache.hadoop.hbase.HMaster: HMaster.metaScanner regioninfo: {regionname: items,823ce1e3-d414-474f-ac70-c4081cecef0f,1214434560891, startKey: &amp;lt;823ce1e3-d414-474f-ac70-c4081cecef0f&amp;gt;, endKey: &amp;lt;9066d4f3-314b-4d9c-90e8-7aa08a52fdd4&amp;gt;, encodedName: 1673833201, offline: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, split: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, tableDesc: {name: items, families: {cfrecs:={name: cfrecs, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, clusters:={name: clusters, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, content:={name: content, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, readby:={name: readby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, receivedby:={name: receivedby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, savedby:={name: savedby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}, sentby:={name: sentby, max versions: 2, compression: NONE, in memory: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, max length: 2147483647, bloom filter: none}}}}, server: 192.168.249.221:60020, startCode: 1214406358315
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thats 3 regions with same start code; 2 are offline.&lt;/p&gt;

&lt;p&gt;Looking at the regionids &amp;#8211; these are timestamps &amp;#8211; I see that they don&apos;t jibe with how they should be aligned.  Parents should come before daughters in timestamps.&lt;/p&gt;

&lt;p&gt;Looking at clocks on cluster, they are badly skewed:&lt;/p&gt;

{code
&amp;lt;st^ack&amp;gt;	[hbase@mb0 logs]$ for i in 0 1 2 3 4 5 6 7 8 9; do ssh hb$i &quot;hostname; date&quot;; done
	&amp;lt;st^ack&amp;gt;	hb0.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 16:47:29 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb1.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 11:47:39 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb2.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 11:47:40 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb3.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 11:47:26 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb4.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 11:47:35 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb5.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 16:47:29 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb6.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 16:47:29 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb7.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 16:47:29 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb8.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 16:47:30 PDT 2008
	&amp;lt;st^ack&amp;gt;	hb9.streamy.com
	&amp;lt;st^ack&amp;gt;	Wed Jun 25 16:47:30 PDT 2008
{code}

&lt;p&gt;Looking at split code, looks like the regionserver sets the regionid/timestamp on the new daughter regions inside in the HRegionInfo constructor that gets called when splitting:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionId = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Daughters update the .META. table; they need to have a basic check that they are not inserting with a timestamp that is older than the parent they are splitting.&lt;/p&gt;

&lt;p&gt;This is a bit like &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-609&quot; title=&quot;Master doesn&amp;#39;t see regionserver edits because of clock skew&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-609&quot;&gt;&lt;del&gt;HBASE-609&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12399052">HBASE-710</key>
            <summary>If clocks are way off, then we can have daughter split come before rather than after its parent in .META.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="stack">stack</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Jun 2008 00:45:42 +0000</created>
                <updated>Fri, 22 Aug 2008 21:14:46 +0000</updated>
                            <resolved>Fri, 27 Jun 2008 16:03:09 +0000</resolved>
                                                    <fixVersion>0.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                <comments>
                            <comment id="12608248" author="bryanduxbury" created="Thu, 26 Jun 2008 01:42:47 +0000"  >&lt;p&gt;We&apos;ve been bitten by clock skew issues a few times now. Maybe we should create a bit of functionality that checks the time skew between the master and regionservers, and if it&apos;s greater than some reasonably low threshold, it won&apos;t run. It&apos;d make it much, much easier to detect and diagnose this kind of problem.&lt;/p&gt;</comment>
                            <comment id="12608258" author="stack" created="Thu, 26 Jun 2008 03:10:25 +0000"  >&lt;p&gt;Wouldn&apos;t be hard to have regionservers volunteer local time when they check in and if very different from the master&apos;s, it could at least flag it.  I made a new issue to do this, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-711&quot; title=&quot;Complain if clock skew across the cluster is badly out of sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-711&quot;&gt;&lt;del&gt;HBASE-711&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12608268" author="stack" created="Thu, 26 Jun 2008 04:10:59 +0000"  >&lt;p&gt;Splitting, ensure daughter&apos;s regionid/timestamp is not &amp;lt; than parents.&lt;/p&gt;</comment>
                            <comment id="12608815" author="stack" created="Fri, 27 Jun 2008 16:03:09 +0000"  >&lt;p&gt;Confirmed fixed by Jon.  Closing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12384733" name="hbase-710.patch" size="3376" author="stack" created="Thu, 26 Jun 2008 04:10:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 26 Jun 2008 01:42:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25352</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0h8z3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>98716</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>