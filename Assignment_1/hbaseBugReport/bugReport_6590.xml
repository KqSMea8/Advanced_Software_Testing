<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:38:06 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6590/HBASE-6590.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6590] [0.89-fb] Assign sequence number to bulk loaded data</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6590</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Currently bulk loaded files are not assigned a sequence number. Thus, they can only be used to import historical data, dating to the past. There are cases where we want to bulk load &quot;current data&quot;; but the bulk load mechanism does not support this, as the bulk loaded files are always sorted behind the non-bulkloaded hfiles. Assigning Sequence Id to bulk loaded files should solve this issue.&lt;/p&gt;

&lt;p&gt;StoreFiles within a store are sorted based on the sequenceId. SequenceId is a monotonically increasing number that accompanies every edit written to the WAL. For entries that update the same cell, we would like the latter edit to win. This comparision is accomplished using memstoreTS, at the KV level; and sequenceId at the StoreFile level (to order scanners in the KeyValueHeap).&lt;/p&gt;

&lt;p&gt;BulkLoaded files are generated outside of HBase/RegionServer, so they do not have a sequenceId written in the file.  This causes HBase to lose track of the point in time, when the BulkLoaded file was imported to HBase. Resulting in a behavior, that *&lt;b&gt;only&lt;/b&gt;* supports viewing bulkLoaded files as files back-filling data from the begining of time.&lt;/p&gt;

&lt;p&gt;By assigning a sequence number to the file, we can allow the bulk loaded file to fit in where we want. Either at the &quot;current time&quot; or the &quot;begining of time&quot;. The latter is the default, to maintain backward compatibility.&lt;/p&gt;

&lt;p&gt;Design approach:&lt;br/&gt;
  Store files keep track of the sequence Id in the trailer. Since we do not wish to edit/rewrite the bulk loaded file upon import, we will encode the assigned sequenceId into the fileName. The filename RegEx is updated for this regard. If the sequenceId is encoded in the filename, the sequenceId will be used as the sequenceId for the file. If none is found, the sequenceId will be considered 0 (as per the default, backward-compatible behavior).&lt;/p&gt;

&lt;p&gt;  To enable clients to request pre-existing behavior, the command line utility allows for 2 ways to import BulkLoaded Files: to assign or not assign a sequence Number. &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If a sequence Number is assigned, the imporeted file will be imported with the &quot;current sequence Id&quot;.&lt;/li&gt;
	&lt;li&gt;if the sequence Number is not assigned, it will be as if it was backfilling old data, from the begining of time.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Compaction behavior:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;With the current compaction algorithm, bulk loaded files &amp;#8211; that backfill data, to the begining of time &amp;#8211; can cause a compaction storm, converting every minor compaction to a major compaction. To address this, these files are excluded from minor compaction, based on a config param. (enabled for the messages use case).&lt;/li&gt;
	&lt;li&gt;Since, bulk loaded files that are not back-filling data do not cause this issue, they will not be ignored during minor compactions based on the config parameter. This is also required to ensure that there are no holes in the set of files selected for compaction &amp;#8211; this is necessary to preserve the order of KV&apos;s comparision before and after compaction.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12603606">HBASE-6590</key>
            <summary>[0.89-fb] Assign sequence number to bulk loaded data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amitanand">Amitanand Aiyer</assignee>
                                    <reporter username="amitanand">Amitanand Aiyer</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Aug 2012 15:54:36 +0000</created>
                <updated>Sat, 8 Sep 2012 23:40:09 +0000</updated>
                            <resolved>Fri, 17 Aug 2012 18:24:23 +0000</resolved>
                                                    <fixVersion>0.89-fb</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                            <comments>
                            <comment id="13435301" author="zhihyu@ebaysf.com" created="Wed, 15 Aug 2012 17:06:08 +0000"  >&lt;p&gt;Interesting idea.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;this is necessary to preserve the order of KV&apos;s comparision before and after comparision.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Did you mean to say &apos;before and after compaction&apos; ?&lt;/p&gt;

&lt;p&gt;If this JIRA is for 0.89-fb branch, please edit the subject accordingly.&lt;/p&gt;</comment>
                            <comment id="13435441" author="lhofhansl" created="Wed, 15 Aug 2012 19:27:48 +0000"  >&lt;p&gt;+1, great idea!&lt;/p&gt;</comment>
                            <comment id="13436942" author="amitanand" created="Fri, 17 Aug 2012 18:26:17 +0000"  >&lt;p&gt;Thanks Ted/Lars. &lt;/p&gt;

&lt;p&gt;Here is the diff that was reviewed for 0.89-fb:&lt;br/&gt;
&lt;a href=&quot;https://reviews.facebook.net/D3789&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://reviews.facebook.net/D3789&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Will be happy to port it to trunk, if you think it&apos;ll be useful.&lt;/p&gt;</comment>
                            <comment id="13436944" author="amitanand" created="Fri, 17 Aug 2012 18:27:43 +0000"  >&lt;p&gt;Yes, thanks. I did mean compaction. Have updated the summary/subject accordingly.&lt;/p&gt;</comment>
                            <comment id="13436949" author="zhihyu@ebaysf.com" created="Fri, 17 Aug 2012 18:33:35 +0000"  >&lt;p&gt;@Amit:&lt;br/&gt;
Please create another JIRA and rebase your patch for HBase trunk.&lt;/p&gt;

&lt;p&gt;Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="13436952" author="lhofhansl" created="Fri, 17 Aug 2012 18:36:23 +0000"  >&lt;p&gt;@Amit: If you have time to make a trunk patch that&apos;d be cool.&lt;/p&gt;</comment>
                            <comment id="13436972" author="stack" created="Fri, 17 Aug 2012 19:01:31 +0000"  >&lt;p&gt;How would we get current sequence number on bulk load?  We&apos;s ask the regionserver we were bulk loading into?  Would there be a rename of the hfile on successful bulk load to add the sequenceid to the filename?&lt;/p&gt;

&lt;p&gt;I like the notion of adding sequenceid to filename.  It&apos;d be after current filename which is ts IIRC?  Or is it random number.&lt;/p&gt;</comment>
                            <comment id="13439095" author="amitanand" created="Tue, 21 Aug 2012 22:07:33 +0000"  >&lt;p&gt;@stack: yes. the regionserver gets the sequenceId from the HLog when doing the bulkLoad operation. &lt;br/&gt;
On success, the file is renamed to a random name. If we are assigning sequenceIds, this random name is appended with a string of the form &lt;em&gt;SeqId_XXXX&lt;/em&gt; that can be parsed by StoreFile to get the sequence number.&lt;/p&gt;</comment>
                            <comment id="13451418" author="hudson" created="Sat, 8 Sep 2012 21:58:21 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #3316 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/3316/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/3316/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6630&quot; title=&quot;Port HBASE-6590 to trunk : Assign sequence number to bulk loaded files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6630&quot;&gt;&lt;del&gt;HBASE-6630&lt;/del&gt;&lt;/a&gt; Port &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6590&quot; title=&quot;[0.89-fb] Assign sequence number to bulk loaded data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6590&quot;&gt;&lt;del&gt;HBASE-6590&lt;/del&gt;&lt;/a&gt; to trunk 0.94 : Assign sequence number to bulk loaded files (Amitanand) (Revision 1382351)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/mapreduce/LoadIncrementalHFiles.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/protobuf/ProtobufUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/protobuf/RequestConverter.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/protobuf/generated/ClientProtos.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreFile.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLog.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/protobuf/Client.proto&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/mapreduce/TestLoadIncrementalHFiles.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionServerBulkLoad.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStoreFile.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/wal/TestWALReplay.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13451437" author="hudson" created="Sat, 8 Sep 2012 23:40:09 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK-on-Hadoop-2.0.0 #166 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/166/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK-on-Hadoop-2.0.0/166/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6630&quot; title=&quot;Port HBASE-6590 to trunk : Assign sequence number to bulk loaded files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6630&quot;&gt;&lt;del&gt;HBASE-6630&lt;/del&gt;&lt;/a&gt; Port &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-6590&quot; title=&quot;[0.89-fb] Assign sequence number to bulk loaded data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-6590&quot;&gt;&lt;del&gt;HBASE-6590&lt;/del&gt;&lt;/a&gt; to trunk 0.94 : Assign sequence number to bulk loaded files (Amitanand) (Revision 1382351)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
tedyu : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/mapreduce/LoadIncrementalHFiles.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/protobuf/ProtobufUtil.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/protobuf/RequestConverter.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/protobuf/generated/ClientProtos.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HStore.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreFile.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLog.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/main/protobuf/Client.proto&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/mapreduce/TestLoadIncrementalHFiles.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionServerBulkLoad.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStoreFile.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/wal/TestWALReplay.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="12604289">HBASE-6630</subtask>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 15 Aug 2012 17:06:08 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240881</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i016qn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4861</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>