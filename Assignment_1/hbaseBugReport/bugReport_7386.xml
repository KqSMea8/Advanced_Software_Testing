<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:45:17 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-7386/HBASE-7386.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-7386] Investigate providing some supervisor support for znode deletion</title>
                <link>https://issues.apache.org/jira/browse/HBASE-7386</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;There a couple of JIRAs for deleting the znode on a process failure:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5844&quot; title=&quot;Delete the region servers znode after a regions server crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5844&quot;&gt;&lt;del&gt;HBASE-5844&lt;/del&gt;&lt;/a&gt; (RS)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5926&quot; title=&quot;Delete the master znode after a master crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5926&quot;&gt;&lt;del&gt;HBASE-5926&lt;/del&gt;&lt;/a&gt; (Master)&lt;br/&gt;
which are pretty neat; on process failure, they delete the znode of the underlying process so HBase can recover faster.&lt;/p&gt;

&lt;p&gt;These JIRAs were implemented via the startup scripts; i.e. the script hangs around and waits for the process to exit, then deletes the znode.&lt;/p&gt;

&lt;p&gt;There are a few problems associated with this approach, as listed in the below JIRAs:&lt;br/&gt;
1) Hides startup output in script&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13463401&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13463401&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13463401&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13463401&lt;/a&gt;&lt;br/&gt;
2) two hbase processes listed per launched daemon&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13463409&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13463409&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13463409&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13463409&lt;/a&gt;&lt;br/&gt;
3) Not run by a real supervisor&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13463409&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13463409&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13463409&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13463409&lt;/a&gt;&lt;br/&gt;
4) Weird output after kill -9 actual process in standalone mode&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5926?focusedCommentId=13506801&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13506801&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5926?focusedCommentId=13506801&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13506801&lt;/a&gt;&lt;br/&gt;
5) Can kill existing RS if called again&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13463401&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13463401&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13463401&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13463401&lt;/a&gt;&lt;br/&gt;
6) Hides stdout/stderr&lt;span class=&quot;error&quot;&gt;&amp;#91;6&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13506832&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13506832&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HBASE-5844?focusedCommentId=13506832&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13506832&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I suspect running in via something like supervisor.d can solve these issues if we provide the right support.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12624557">HBASE-7386</key>
            <summary>Investigate providing some supervisor support for znode deletion</summary>
                <type id="3" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/task.png">Task</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="gchanan">Gregory Chanan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Dec 2012 00:44:17 +0000</created>
                <updated>Tue, 9 Sep 2014 06:10:22 +0000</updated>
                                                            <fixVersion>2.0.0</fixVersion>
                                    <component>master</component>
                    <component>regionserver</component>
                    <component>scripts</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13535517" author="gchanan" created="Wed, 19 Dec 2012 00:51:22 +0000"  >&lt;p&gt;I&apos;m going to first tackle the Master case, &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5926&quot; title=&quot;Delete the master znode after a master crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5926&quot;&gt;&lt;del&gt;HBASE-5926&lt;/del&gt;&lt;/a&gt;.  The proposal is to rip out the script modification of &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5926&quot; title=&quot;Delete the master znode after a master crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5926&quot;&gt;&lt;del&gt;HBASE-5926&lt;/del&gt;&lt;/a&gt; and replace with supervisor.d support.  The java code from &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5926&quot; title=&quot;Delete the master znode after a master crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5926&quot;&gt;&lt;del&gt;HBASE-5926&lt;/del&gt;&lt;/a&gt; would of course stay, only the restart/cleanup code in the scripts would go.  The goal is to solve the above listed issues:&lt;br/&gt;
#2 is solved by running via supervisor (jps reports only one HMaster process when HMaster started via supervisor.d)&lt;br/&gt;
#3 is self-evidently solved by running on a real supervisor&lt;br/&gt;
#5 is clearly not relevant, as it is only related to the RS.&lt;/p&gt;

&lt;p&gt;So, we are left with #1, #4, and #6.&lt;br/&gt;
#1 and #6 are solved because the previous script behavior returns when not run in supervisor and supervisor can redirect stdout/stderr when run.&lt;br/&gt;
#4 is solved because the old script behavior returns when not run in supervisor and I don&apos;t think it makes any sense to run a standalone HBase via supervisor.&lt;/p&gt;

&lt;p&gt;Example patch coming soon.&lt;/p&gt;</comment>
                            <comment id="13535518" author="enis" created="Wed, 19 Dec 2012 00:52:21 +0000"  >&lt;p&gt;Please also see &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7334&quot; title=&quot;We should expire the zk session for crashed servers rather than deleting ephemeral znodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7334&quot;&gt;HBASE-7334&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13535562" author="gchanan" created="Wed, 19 Dec 2012 02:18:09 +0000"  >&lt;p&gt;Thanks for pointing that out, Enis.  What I&apos;m doing here is compatible with that, I think.  Rather than deleting the znode we just expire the session.  Should be a small change.&lt;/p&gt;</comment>
                            <comment id="13535578" author="gchanan" created="Wed, 19 Dec 2012 02:21:35 +0000"  >&lt;ul&gt;
	&lt;li&gt;Attached &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-7386&quot; title=&quot;Investigate providing some supervisor support for znode deletion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-7386&quot;&gt;HBASE-7386&lt;/a&gt;-v0*&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Does the following:&lt;br/&gt;
-Rips out the script changes made by &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5844&quot; title=&quot;Delete the region servers znode after a regions server crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5844&quot;&gt;&lt;del&gt;HBASE-5844&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5926&quot; title=&quot;Delete the master znode after a master crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5926&quot;&gt;&lt;del&gt;HBASE-5926&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Adds a new command to the master &quot;supervise&quot; which does clean + start.  It should probably be called &quot;autorestart&quot; but that is taken by the script.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Todos:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Need to include supervisor configs.  I&apos;ll do that separately as I&apos;m not sure whether we want them to be samples or full-fledged configs people can use.&lt;/li&gt;
	&lt;li&gt;I didn&apos;t pull out &quot;autorestart&quot; from the scripts, but it&apos;s probably broken by this.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13535583" author="gchanan" created="Wed, 19 Dec 2012 02:25:26 +0000"  >&lt;p&gt;Here are some sample supervisord scripts for restarting the master.&lt;/p&gt;

&lt;p&gt;They are not fully fledged yet; a better attempt would go through all the config files in hbase-daemon and do something appropriate.&lt;/p&gt;

&lt;p&gt;This requires that HBASE_HOME and HBASE_LOG_DIR are set and does not respect any other environment settings (e.g. HBASE_CONF_DIR).&lt;/p&gt;</comment>
                            <comment id="13535587" author="gchanan" created="Wed, 19 Dec 2012 02:34:41 +0000"  >&lt;p&gt;Here is how I verified this all works (apply both patches and set HBASE_HOME, HBASE_LOG_DIR in your environment but nothing else).  Also make sure supervisord is installed.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;1. $HBASE_HOME/bin/hbase-daemons.sh --config &quot;&quot; start zookeeper
2. cd $HBASE_HOME/conf/supervisord
3. supervisord -c supervisord.conf (call &quot;jps&quot; and record the pid of the HMaster)
4. $HBASE_HOME/bin/hbase-daemons.sh --config &quot;&quot; --hosts localhost.txt start regionserver (localhost.txt is a text file with the line &quot;localhost&quot;)
5. $HBASE_HOME/bin/./local-master-backup.sh start 1
6. kill -9 [PID_OF_HMASTER_RECORDED_AT_STEP_3]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and notice the backup master takes over right away.  Also use start-hbase.sh and notice it has the same behavior as before (does not swallow output).&lt;/p&gt;</comment>
                            <comment id="13535590" author="gchanan" created="Wed, 19 Dec 2012 02:40:59 +0000"  >&lt;p&gt;Open Questions:&lt;br/&gt;
1) Do we think this is a useful direction?&lt;br/&gt;
2) If so, what level of supervisor scripts do we provide?&lt;br/&gt;
None?&lt;br/&gt;
Samples?&lt;br/&gt;
Actual scripts that can be run &lt;span class=&quot;error&quot;&gt;&amp;#91;i.e. mimicking HBASE-daemon.sh -- probably want to move all the config setup to a common file&amp;#93;&lt;/span&gt;?&lt;br/&gt;
Actual scripts + ssh scripting to actually run with a &quot;start-hbase.sh&quot;, i.e. &quot;start-supervised-hbase.sh&quot;&lt;/p&gt;</comment>
                            <comment id="13535721" author="nkeywal" created="Wed, 19 Dec 2012 06:53:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;1) Do we think this is a useful direction?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Personally, I do. We just need to have a default way to start/stop and ideally monitor HBase. Scripts are the simplest way. Supervisor is better.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2) If so, what level of supervisor scripts do we provide?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Samples are doomed to be broken. So I would go for  Actual scripts + ssh scripting to actually run with a &quot;start-hbase.sh&quot;, i.e. &quot;start-supervised-hbase.sh&quot;.&lt;/p&gt;

&lt;p&gt;Is there any reason not to use supervisor by default (licenses, supported platforms?)&lt;/p&gt;</comment>
                            <comment id="13535744" author="stack" created="Wed, 19 Dec 2012 07:30:01 +0000"  >&lt;p&gt;I&apos;d say just repurpose &apos;autorestart&apos;, especially if now broke.  What was there previous was mickey mouse.  This is real deal.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... and does not respect any other environment settings (e.g. HBASE_CONF_DIR).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Would this be fixed if we &quot;...through all the config files in hbase-daemon and do something appropriate.&quot;?&lt;/p&gt;

&lt;p&gt;On questions:&lt;/p&gt;

&lt;p&gt;1. Yes this is valid direction.  Perhaps we could extract the stuff you hacked out into a &apos;wrapper&apos; script, a poor-mans&apos; supervise such that it was there as an option... you could run it if you wanted poor-mans&apos; supervise but otherwise, scripts ran as they used to.  But this would likely be wasted effort... effort better spent getting it so optionally, if supervisord was installed, you could just run with it.&lt;br/&gt;
2. I agree with nkeywal that templates/samples inevitably rot.  Unused software also rots so providing supervisord scripts unless they are used, they will go bad.  How much work involved making it so could do ./bin/start-supervisord-hbase.sh?  Would be coolio if you could do ./bin/start-hbase.sh and ./bin/start-supervisord-hbase.sh if supervisor available (likely on most systems I&apos;d say) and then in doc. we encourage folks to do the latter.&lt;/p&gt;

&lt;p&gt;What to do for the case where a shop has chosen other than supervisord to monitor their processes?  I suppose we could let them do the convertion from &apos;supervise&apos; to &apos;god&apos;, etc.?&lt;/p&gt;

&lt;p&gt;This is great stuff G.&lt;/p&gt;



</comment>
                            <comment id="13536656" author="gchanan" created="Thu, 20 Dec 2012 01:08:08 +0000"  >&lt;p&gt;Thanks for the feedback, I agree with what both of you are saying.  I&apos;m working on an a start-hbase like script.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What to do for the case where a shop has chosen other than supervisord to monitor their processes? I suppose we could let them do the convertion from &apos;supervise&apos; to &apos;god&apos;, etc.?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t think we should worry about it for the first pass.  I figure if a shop is familiar with a different tool they should be able to write their own scripts/configs with the supervisord ones we provide as a guide.&lt;/p&gt;</comment>
                            <comment id="13695160" author="stack" created="Thu, 27 Jun 2013 23:29:55 +0000"  >&lt;p&gt;Pulling into 0.95 because of discussion here: &lt;a href=&quot;http://search-hadoop.com/m/PIMWWYRIuk1&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://search-hadoop.com/m/PIMWWYRIuk1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Assigning myself.&lt;/p&gt;</comment>
                            <comment id="13735993" author="stack" created="Sat, 10 Aug 2013 18:40:47 +0000"  >&lt;p&gt;Moving out though I think it a shame we don&apos;t have it.  It is not being worked on.&lt;/p&gt;</comment>
                            <comment id="13836520" author="asamir" created="Mon, 2 Dec 2013 13:53:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;, &lt;/p&gt;

&lt;p&gt;Is someone is working on this currently? This looks like great idea. I would like to continue this work if we  still think that this is good direction ?&lt;/p&gt;

&lt;p&gt;Cheers&lt;/p&gt;</comment>
                            <comment id="13856860" author="asamir" created="Thu, 26 Dec 2013 13:02:24 +0000"  >&lt;p&gt;Based on what was discussed here i have created set of scripts and configs that support running hbase processes under python supervisor control. I did not touch any scrips from bin directory as i see this as optional solution for managing hbase processes. Only change in hbase source is adding &apos;autorestart&apos; option in HMasterCommandLine.java.  Scripts does not require any config changes or additional env variables. &lt;br/&gt;
All testing was done on 0.96 branch and partially on 0.94 using supervisor 3.0 version, OS was Centos 5.8 and 5.10.&lt;br/&gt;
All suggestions and critics are welcome&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Cheers    &lt;/p&gt;</comment>
                            <comment id="13857589" author="stack" created="Fri, 27 Dec 2013 17:44:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asamir&quot; class=&quot;user-hover&quot; rel=&quot;asamir&quot;&gt;Samir Ahmic&lt;/a&gt;  Excellent!  Thank you for working on this.  If you add a little detail on how it looks when in place working &amp;#8211; I can add a section to the reference guide that points at these scripts (I can commit the autorestart changes no problem).&lt;/p&gt;

&lt;p&gt;We &apos;could&apos; commit these scripts.  It might encourage folks to go the supervised route.  Only issue is they may &apos;rot&apos;.&lt;/p&gt;

&lt;p&gt;Do you have to &apos;copy&apos; the graceful_stop.sh script, can you not point at the original (any needed changes we can make no problem) &amp;#8211; ditto for any other changes you&apos;d need to you could reduce the amount of copy/paste.&lt;/p&gt;

&lt;p&gt;FYI, these lines are unnecessary &apos;+# * Copyright 2007 The Apache Software Foundation&apos;&lt;/p&gt;

&lt;p&gt;You probably don&apos;t want this in the scripts: +email=&quot;samir@personal.com&quot;  (call out the necessary config in README?)&lt;/p&gt;

&lt;p&gt;How do these migrate scripts work?  They look nice if they are doing what I think they are doing.&lt;/p&gt;

&lt;p&gt;I see mail notification but do you actually do the removal of a znode?&lt;/p&gt;

&lt;p&gt;When you say python supervise, you just mean the script that supervise has as callback is in python?&lt;/p&gt;

&lt;p&gt;Nice job &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asamir&quot; class=&quot;user-hover&quot; rel=&quot;asamir&quot;&gt;Samir Ahmic&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13857994" author="asamir" created="Sat, 28 Dec 2013 10:26:09 +0000"  >&lt;p&gt;Thanks for review add comments &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;]&lt;br/&gt;
In respect of usage and documentation this scripts are following same logic as scripts in bin directory. For example here is output of start-supervisord-hbase.sh command:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ $HBASE_HOME/bin/supervisord/start-supervisord-hbase.sh
localhost: hbase-ZK: started
hbase-MASTER: started
localhost: hbase-RS: started
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so considering usage this relations are true:&lt;br/&gt;
start-hbase.sh ~= start-supervisord-hbase.sh&lt;br/&gt;
stop-hbase.sh ~= stop-supervisord-hbase.sh&lt;br/&gt;
hbase-daemon.sh ~= hbase-supervisord.sh&lt;/p&gt;

&lt;p&gt;I agree there is danger that scripts &apos;rot&apos;  but also i believe that this approach can solve number of issues for ops people and generally improve hbase MTTR .  What is your suggestion how to address &apos;rot&apos; scripts issue ?&lt;/p&gt;

&lt;p&gt;graceful-stop.sh from bin dir can be modified to avoid copy/paste. I will also check rest of scripts to try to reduce amount of copy/paste.&lt;/p&gt;

&lt;p&gt;migrate_to_supervisord.sh will switch running cluster that was started with scripts from bin directory  to use supervisor. It will stop hbase daemons on nodes using hbase-daemon.sh and then it will start then using hbase-supervisord.sh script (revert_to_scripts.sh will do opposite).&lt;/p&gt;

&lt;p&gt;For master znode is removed by autostart method (patch in HMasterCommandLine.java ) in moment of starting. We have supervisor config autorestart=true so if master process dies unexpectedly supervisor will kick off autorestart and in that moment znode will be removed giving enough time for backup master to become active.  Alternative is to craft listener script similar to mail_notification.py that will remove master znode when detects that process is exiting.&lt;/p&gt;

&lt;p&gt;Regarding RS znodes scripts does not  remove them yet. I was thinking about listener script (similar to  mail_notification.py) calling &apos;hbase zkcli rmr  RSznode&apos;  or we can modify HRegionServerCommadLine.java and add &apos;autorestart&apos; like in  HMasterCommandLine.java. What is your suggestion how to address this ?&lt;/p&gt;

&lt;p&gt;Basically all this scripts are wrappers around &apos;supervisord&apos;  and &apos;supervisorctl&apos; commands which are python based, &lt;br/&gt;
I hope i have clarify some details. &lt;/p&gt;

&lt;p&gt;Cheers&lt;/p&gt;


</comment>
                            <comment id="13865262" author="asamir" created="Wed, 8 Jan 2014 09:54:50 +0000"  >&lt;p&gt;Here is summary of v2 patches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Unnecessary comments removed&lt;/li&gt;
	&lt;li&gt;graceful_stop.sh modified to support case when supervisord is used (to reduce copy/paste), also script had issue with restoring balancer state that is now fixed&lt;/li&gt;
	&lt;li&gt;added  option &quot;clean_znode&quot; in hbase-daemon.sh that calls cleanZNode(). This used by zk_cleaner.py listener script.&lt;/li&gt;
	&lt;li&gt;added zk_cleaner.py supervisord event listener which removes znode when regionserver crash and send mail notification about that event.  Sending email is optional&lt;/li&gt;
	&lt;li&gt;i have verify that supervisor approach improves master failover in my testing this time is ~7s when using supervisor and when using standard scripts it is ~40s&lt;/li&gt;
	&lt;li&gt;since we have &apos;autorestart=true&apos; in supervisord config if any process fails unexpectedly supervisor will restart it automatically&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="13865272" author="nkeywal" created="Wed, 8 Jan 2014 10:13:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;i have verify that supervisor approach improves master failover in my testing this time is ~7s when using supervisor and when using standard scripts it is ~40s&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is strange. Do you know why? What is the test scenario?&lt;/p&gt;</comment>
                            <comment id="13865479" author="asamir" created="Wed, 8 Jan 2014 14:31:48 +0000"  >&lt;p&gt;From what i could see it is all about removing master znode in zookeeper. In supervisor scenario master znode is deleted by autorestart and in standard scripts we don&apos;t delete master znode. Is master znode ephemeral ?  It should be gone when master dies. &lt;br/&gt;
Test scenario is very simple:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;distrubuted cluster 0.96&lt;/li&gt;
	&lt;li&gt;start master and backup master on different machines&lt;/li&gt;
	&lt;li&gt;date; kill -9 master and watch logs on backup master to see when it become active&lt;/li&gt;
	&lt;li&gt;i have also used python based script that watches &apos;/hbase/master&apos; znode and detect changes&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="13865513" author="nkeywal" created="Wed, 8 Jan 2014 14:53:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;standard scripts we don&apos;t delete master znode&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We should, that&apos;s what &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-5926&quot; title=&quot;Delete the master znode after a master crash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-5926&quot;&gt;&lt;del&gt;HBASE-5926&lt;/del&gt;&lt;/a&gt; is about.It used to work for sure.&lt;br/&gt;
It&apos;s better to delete it just after the server death, as the restart may never happen...&lt;/p&gt;</comment>
                            <comment id="13865571" author="asamir" created="Wed, 8 Jan 2014 15:51:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s better to delete it just after the server death, as the restart may never happen...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Are you suggesting that i modify &apos;zk_cleaner.py&apos; listener script to delete master znode when detects that master is in one of this states (&apos;PROCESS_STATE_STOPPING&apos;, &apos;PROCESS_STATE_EXITED&apos;, &apos;PROCESS_STATE_UNKNOWN) ? I&apos;m already doing this for regionservers so it should few lines of code.&lt;/p&gt;</comment>
                            <comment id="13865594" author="nkeywal" created="Wed, 8 Jan 2014 16:23:36 +0000"  >&lt;p&gt;may be &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Just that if the process exit, we can clean the ZK node immediately, ideally w/o relying on a separate watchdog. &lt;br/&gt;
What&apos;s the PROCESS_STATE_UNKNOWN? &lt;/p&gt;</comment>
                            <comment id="13865644" author="asamir" created="Wed, 8 Jan 2014 17:02:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;What&apos;s the PROCESS_STATE_UNKNOWN?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;According to supervisor documentation &lt;a href=&quot;http://supervisord.org/subprocess.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://supervisord.org/subprocess.html&lt;/a&gt; &quot;The process is in an unknown state (supervisord programming error)&quot;.&lt;/p&gt;</comment>
                            <comment id="13868220" author="stack" created="Fri, 10 Jan 2014 19:57:19 +0000"  >&lt;p&gt;Related, from our boys at Xiaomi  &lt;a href=&quot;https://github.com/XiaoMi/minos&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/XiaoMi/minos&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13869578" author="asamir" created="Mon, 13 Jan 2014 14:32:22 +0000"  >&lt;p&gt;Update, with &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10310&quot; title=&quot;ZNodeCleaner session expired for /hbase/master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10310&quot;&gt;&lt;del&gt;HBASE-10310&lt;/del&gt;&lt;/a&gt; fixed  master---&amp;gt;backupmaster failover time is 4s when cluster is controlled with supervisor and 3s when is controlled with standard scripts.    &lt;/p&gt;</comment>
                            <comment id="13869629" author="nkeywal" created="Mon, 13 Jan 2014 15:54:49 +0000"  >&lt;p&gt;Thanks a lot for the fix of  &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10310&quot; title=&quot;ZNodeCleaner session expired for /hbase/master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10310&quot;&gt;&lt;del&gt;HBASE-10310&lt;/del&gt;&lt;/a&gt;, Samir. I went through your patch. It&apos;s a difficult read when you don&apos;t know supervisor &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. The definition of &apos;PROCESS_STATE_UNKNOWN&apos; is a little scary (as we kill the region server when we reach this state).&lt;/p&gt;

&lt;p&gt;There are some typos (&apos;Test is supevisored installed&apos; instead of supevisord).&lt;/p&gt;

&lt;p&gt;I&apos;m not sure about stuff like &apos;subprocess.call(&apos;/bin/mail -s &quot;HBASE_PROCESS_EVENT&quot; %s &amp;lt; %s&apos;%(email, tmp_file), shell=True)&apos;: seems machine dependent, there is no /bin/mail on my ubuntu desktop.&lt;/p&gt;

&lt;p&gt;Do we have to use python?&lt;/p&gt;

&lt;p&gt;It would be good to have a review from someone who knows supervisor... As well, this should be documented in the hbase reference guide imho.&lt;/p&gt;</comment>
                            <comment id="13869915" author="asamir" created="Mon, 13 Jan 2014 20:11:47 +0000"  >&lt;p&gt;Thanks for review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkeywal&quot; class=&quot;user-hover&quot; rel=&quot;nkeywal&quot;&gt;Nicolas Liochon&lt;/a&gt;. &lt;br/&gt;
I agree about &apos;PROCESS_STATE_UNKNOWN&apos;,  i checked it in supervisor source code and it is look like that  is used for actions if supervisor is unable to determine state of process. I will remove it from event listener since it can cause issues. &lt;/p&gt;

&lt;p&gt;I was planing to make mail notification optional even to create separate event listener that will handle email notifications. &apos;/bin/mail&apos; is most simple solution and following that example folks could develop there own solution. What do you think how this should be handled ?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Do we have to use python?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;According to documentation: &quot;Event listener can be written in any language supported by the platform you&#8217;re using to run supervisor. There is special library support for Python in the form of a supervisor.childutils module, which makes creating event listeners in Python slightly easier than in other languages.&quot; Any suggestions what should we use instead of python ? Java ?&lt;br/&gt;
When we complete this work it should be documented probably under &quot;15. Apache HBase Operational Management&quot; ?&lt;/p&gt;



</comment>
                            <comment id="13880854" author="asamir" created="Fri, 24 Jan 2014 09:39:54 +0000"  >&lt;p&gt;Here is summary of v3 patches:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;PROCESS_STATE_UNKNOWN removed for zk_cleaner.py, now we clean znode in case that process is in state STOPING or EXITED&lt;/li&gt;
	&lt;li&gt;mail notifications are moved to separate listener mail_notifications.py and disabled by default. I have updated README file with instructions how to enable mail notification&lt;/li&gt;
	&lt;li&gt;some typos fixed&lt;/li&gt;
	&lt;li&gt;master failover time ~4s, dead rs detection time 3s&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14005054" author="ipodfans" created="Wed, 21 May 2014 18:32:42 +0000"  >&lt;p&gt;Any updates ? Are we going to merge the latest patch ? This is a pretty cool feature and please let me know if there are things I can help &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="14005062" author="stack" created="Wed, 21 May 2014 18:35:38 +0000"  >&lt;p&gt;Putting against 0.99 so I look at this.  Agree this is &apos;cool&apos; feature and would be a shame to let it rot after the good work done.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12623482">HBASE-7334</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12623482">HBASE-7334</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12551767">HBASE-5844</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12553765">HBASE-5926</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12551766">HBASE-5843</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12688242">HBASE-10310</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12621953" name="HBASE-7386-bin-v2.patch" size="37630" author="asamir" created="Wed, 8 Jan 2014 09:54:50 +0000"/>
                            <attachment id="12625019" name="HBASE-7386-bin-v3.patch" size="41128" author="asamir" created="Fri, 24 Jan 2014 09:39:54 +0000"/>
                            <attachment id="12620497" name="HBASE-7386-bin.patch" size="36980" author="asamir" created="Thu, 26 Dec 2013 13:01:28 +0000"/>
                            <attachment id="12621954" name="HBASE-7386-conf-v2.patch" size="22262" author="asamir" created="Wed, 8 Jan 2014 09:54:50 +0000"/>
                            <attachment id="12625020" name="HBASE-7386-conf-v3.patch" size="22481" author="asamir" created="Fri, 24 Jan 2014 09:39:54 +0000"/>
                            <attachment id="12620498" name="HBASE-7386-conf.patch" size="22234" author="asamir" created="Thu, 26 Dec 2013 13:01:28 +0000"/>
                            <attachment id="12620499" name="HBASE-7386-src.patch" size="2038" author="asamir" created="Thu, 26 Dec 2013 13:01:28 +0000"/>
                            <attachment id="12561625" name="HBASE-7386-v0.patch" size="3450" author="gchanan" created="Wed, 19 Dec 2012 02:21:35 +0000"/>
                            <attachment id="12561626" name="supervisordconfigs-v0.patch" size="1622" author="gchanan" created="Wed, 19 Dec 2012 02:25:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 19 Dec 2012 00:52:21 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>300378</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 30 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i167k7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244357</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>