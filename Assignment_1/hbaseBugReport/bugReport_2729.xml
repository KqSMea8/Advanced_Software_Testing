<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:04:17 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-2729/HBASE-2729.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-2729] flushCache should write to a tmp directory and then move into the store directory</title>
                <link>https://issues.apache.org/jira/browse/HBASE-2729</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Currently it appears that internalFlushCache writes directly to the target spot of the flushed data. The finally() block appends the metadata and closes the file as if nothing bad went wrong in case of an exception. This is really bad, since it means that an IOE in the middle of flushing cache could easily write a valid looking file with only half the data, which would then prevent us from recovering those edits during log replay.&lt;/p&gt;

&lt;p&gt;Instead, it should flush to a tmp location and move it into the region dir only after it&apos;s successfully written.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12466950">HBASE-2729</key>
            <summary>flushCache should write to a tmp directory and then move into the store directory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stack">stack</assignee>
                                    <reporter username="tlipcon">Todd Lipcon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Jun 2010 01:56:29 +0000</created>
                <updated>Fri, 20 Nov 2015 12:40:54 +0000</updated>
                            <resolved>Wed, 23 Jun 2010 19:07:17 +0000</resolved>
                                    <version>0.90.0</version>
                                    <fixVersion>0.90.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12881104" author="hbasereviewboard" created="Tue, 22 Jun 2010 07:01:49 +0000"  >&lt;p&gt;Message from: &quot;Todd Lipcon&quot; &amp;lt;todd@cloudera.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/216/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hbase, stack and Ryan Rawson.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Fixes bugs where an exception in the middle of flushing a file leaves a half-written StoreFile in the region dir, preventing that region from recovering, or, in the case of transient errors, causing silent loss of half a file&apos;s worth of data.&lt;/p&gt;

&lt;p&gt;I also got rid of the compaction dir here, and am just using one region-wide tmp dir. Is there some reason this is a bad idea?&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2729&quot; title=&quot;flushCache should write to a tmp directory and then move into the store directory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2729&quot;&gt;&lt;del&gt;HBASE-2729&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-2729&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-2729&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 1794df8 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 04b7522 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java 9e5ca46 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java a65e947 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.hbase.org/r/216/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Ran TestCompaction and TestStore. Will start a cluster test running before I go to bed.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Todd&lt;/p&gt;

</comment>
                            <comment id="12881113" author="hbasereviewboard" created="Tue, 22 Jun 2010 07:20:02 +0000"  >&lt;p&gt;Message from: stack@duboce.net&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/216/#review261&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/#review261&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;+1 (if it passes all tests).  Nit-picks below.&lt;/p&gt;


&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/216/#comment1110&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/#comment1110&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    ? There was notion of a &apos;_tmp&apos; already?&lt;/p&gt;

&lt;p&gt;    I&apos;d say name it &apos;.tmp&apos;... since a &apos;.&apos; prefix seems to be our convention given logs dir at top-level has a &apos;.&apos; prefix.&lt;/p&gt;



&lt;p&gt;src/main/java/org/apache/hadoop/hbase/regionserver/Store.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/216/#comment1111&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/#comment1111&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Why not keep old name and just move dirs?  Why create a new unique name?&lt;/p&gt;



&lt;p&gt;src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;http://review.hbase.org/r/216/#comment1112&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/#comment1112&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Nice test.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stack&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="12881117" author="hbasereviewboard" created="Tue, 22 Jun 2010 07:24:03 +0000"  >&lt;p&gt;Message from: &quot;Todd Lipcon&quot; &amp;lt;todd@cloudera.com&amp;gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 00:14:05, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; +1 (if it passes all tests).  Nit-picks below.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Cool, I&apos;ll run it through my Hudson overnight, plus running a cluster test on my 5-node test cluster now. Will commit tomorrow midday with changes below addressed assuming testing goes OK.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 00:14:05, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/Store.java, line 333&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/216/diff/1/?file=1529#file1529line333&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/diff/1/?file=1529#file1529line333&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     ? There was notion of a &apos;_tmp&apos; already?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I&apos;d say name it &apos;.tmp&apos;... since a &apos;.&apos; prefix seems to be our convention given logs dir at top-level has a &apos;.&apos; prefix.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yea, the bulk load stuff uses a tmp dir if you ask the regionserver to load a file which is stored on a different filesystem than the region itself.&lt;/p&gt;

&lt;p&gt;I&apos;ll switch to .tmp though as you suggest (and move it into HConstants to replace the now-unused compactions.dir or what have you)&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 00:14:05, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/main/java/org/apache/hadoop/hbase/regionserver/Store.java, line 464&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/216/diff/1/?file=1529#file1529line464&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/diff/1/?file=1529#file1529line464&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Why not keep old name and just move dirs?  Why create a new unique name?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was worried that what&apos;s unique in the old dir might not be unique in the new&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2010-06-22 00:14:05, stack wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java, line 411&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;http://review.hbase.org/r/216/diff/1/?file=1531#file1531line411&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/diff/1/?file=1531#file1531line411&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Nice test.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;thx! at some point I&apos;d like to combine this with the one in TestFSErrorsExposed and make a little mini-framework out of it... something for next month perhaps.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Todd&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/216/#review261&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/#review261&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


</comment>
                            <comment id="12881437" author="hbasereviewboard" created="Tue, 22 Jun 2010 23:02:08 +0000"  >&lt;p&gt;Message from: &quot;Todd Lipcon&quot; &amp;lt;todd@cloudera.com&amp;gt;&lt;/p&gt;

&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;http://review.hbase.org/r/216/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2010-06-22 15:55:16.514925)&lt;/p&gt;


&lt;p&gt;Review request for hbase, stack and Ryan Rawson.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;TestMasterTransitions exposed a clunker of a bug here. In the previous iteration, I had put the tmp directory in /hbase/table/.tmp instead of /hbase/table/region/.tmp - I thought region.basedir was the region dir, not the table dir. So, when a new region was opened, it removed the tmp files being written by other region servers and made the world explode.&lt;/p&gt;

&lt;p&gt;This iteration renames those variables to be more clear, and fixes the bug so the tmp dir is within the region, not the table.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Fixes bugs where an exception in the middle of flushing a file leaves a half-written StoreFile in the region dir, preventing that region from recovering, or, in the case of transient errors, causing silent loss of half a file&apos;s worth of data.&lt;/p&gt;

&lt;p&gt;I also got rid of the compaction dir here, and am just using one region-wide tmp dir. Is there some reason this is a bad idea?&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-2729&quot; title=&quot;flushCache should write to a tmp directory and then move into the store directory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-2729&quot;&gt;&lt;del&gt;HBASE-2729&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;http://issues.apache.org/jira/browse/HBASE-2729&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/HBASE-2729&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java 1794df8 &lt;br/&gt;
  src/main/java/org/apache/hadoop/hbase/regionserver/Store.java 04b7522 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/HBaseTestCase.java dc38b3b &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestCompaction.java 9e5ca46 &lt;br/&gt;
  src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java a65e947 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;http://review.hbase.org/r/216/diff&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://review.hbase.org/r/216/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Ran TestCompaction and TestStore. Will start a cluster test running before I go to bed.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Todd&lt;/p&gt;

</comment>
                            <comment id="12881548" author="tlipcon" created="Wed, 23 Jun 2010 05:04:08 +0000"  >&lt;p&gt;Here&apos;s patch that was previously up on reviewboard (rb is down due to EC2 suckage)&lt;br/&gt;
One change on top of what was on reviewboard: had to update heap sizes for HRegion and Store to get tests to pass again.&lt;/p&gt;</comment>
                            <comment id="12881575" author="stack" created="Wed, 23 Jun 2010 06:44:25 +0000"  >&lt;p&gt;The patch has &apos; &quot;_tmp&quot;);&apos; in it rather than &apos;.tmp&apos;.&lt;/p&gt;

&lt;p&gt;We just going to let compaction dross pile up over life of a region?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;doRegionCompactionCleanup();&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Otherwise, patch looks good to me.  I&apos;m +1 on commit.&lt;/p&gt;</comment>
                            <comment id="12881579" author="tlipcon" created="Wed, 23 Jun 2010 06:50:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;The patch has &apos; &quot;_tmp&quot;);&apos; in it rather than &apos;.tmp&apos;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;oops... let me double check this is the latest patch, I thought I fixed that. Will make sure it&apos;s right before commit.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We just going to let compaction dross pile up over life of a region?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think a compaction should leave data in tmp except if the compaction fails, right? Looking at my load test I&apos;m running right now, the .tmp dirs are there but they&apos;re empty, even though compactions have run.&lt;/p&gt;</comment>
                            <comment id="12881581" author="tlipcon" created="Wed, 23 Jun 2010 06:51:53 +0000"  >&lt;p&gt;Aha, here is the real patch...&lt;/p&gt;</comment>
                            <comment id="12881819" author="stack" created="Wed, 23 Jun 2010 18:45:42 +0000"  >&lt;p&gt;+1 (basedir -&amp;gt; tableDir is improvement)&lt;/p&gt;</comment>
                            <comment id="12881831" author="tlipcon" created="Wed, 23 Jun 2010 19:07:17 +0000"  >&lt;p&gt;Committed to 0.89.20100621 and trunk&lt;/p&gt;</comment>
                            <comment id="15016826" author="lars_francke" created="Fri, 20 Nov 2015 12:40:54 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12447805" name="hbase-2729.txt" size="26346" author="tlipcon" created="Wed, 23 Jun 2010 06:51:53 +0000"/>
                            <attachment id="12447797" name="hbase-2729.txt" size="16955" author="tlipcon" created="Wed, 23 Jun 2010 05:04:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 22 Jun 2010 07:01:49 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26435</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hiy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>100332</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>