<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:10:28 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-10100/HBASE-10100.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-10100] Hbase replication cluster can have varying peers under certain conditions</title>
                <link>https://issues.apache.org/jira/browse/HBASE-10100</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We were trying to replicate hbase data over to a new datacenter recently.  After we turned on replication and then did our copy tables.  We noticed that verify replication had discrepancies.  &lt;/p&gt;

&lt;p&gt;We ran a list_peers and it returned back both peers, the original datacenter we were replicating to and the new datacenter (this was correct).  &lt;/p&gt;

&lt;p&gt;When grepping through the logs for a few regionservers we noticed that a few regionservers had the following entry in their logs:&lt;/p&gt;

&lt;p&gt;2013-09-26 10:55:46,907 ERROR org.apache.hadoop.hbase.replication.regionserver.ReplicationSourceManager: Error while adding a new peer java.net.UnknownHostException: xxx.xxx.flurry.com (this was due to a transient dns issue)&lt;/p&gt;

&lt;p&gt;Thus a very small subet of our regionservers were not replicating to this new cluster while most were. &lt;/p&gt;

&lt;p&gt;We probably don&apos;t want to abort if this type of issue comes up, it could potentially be fatal if someone does an &quot;add_peer&quot; operation with a typo.  This could potentially shut down the cluster. &lt;/p&gt;

&lt;p&gt;One solution I can think of is keeping some flag in ReplicationSourceManager which is a boolean that keeps track of whether there was an errorAddingPeer.  Then in the logPositionAndCleanOldLogs we can do something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (errorAddingPeer) {
      LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;There was an error adding a peer, logs will not be marked &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deletion&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;thus we are not deleting these logs from the queue.  You will notice your replicating queue rising on certain machines and you can still replay the logs, thus avoiding a lengthy copy table. &lt;/p&gt;

&lt;p&gt;I have a patch (with unit test) for the above proposal, if everyone thinks that is an okay solution.&lt;/p&gt;

&lt;p&gt;An additional idea would be to add some retry logic inside the PeersWatcher class for the nodeChildrenChanged method.  Thus if there happens to be some issue we could sort it out without having to bounce that particular regionserver.  &lt;/p&gt;

&lt;p&gt;Would love to hear everyones thoughts.&lt;/p&gt;




</description>
                <environment></environment>
        <key id="12683237">HBASE-10100</key>
            <summary>Hbase replication cluster can have varying peers under certain conditions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="churromorales">churro morales</reporter>
                        <labels>
                    </labels>
                <created>Sat, 7 Dec 2013 00:42:27 +0000</created>
                <updated>Mon, 26 Jan 2015 22:29:31 +0000</updated>
                                            <version>0.94.5</version>
                    <version>0.95.0</version>
                    <version>0.96.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13842197" author="jmspaggi" created="Sat, 7 Dec 2013 11:52:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdcryans&quot; class=&quot;user-hover&quot; rel=&quot;jdcryans&quot;&gt;Jean-Daniel Cryans&lt;/a&gt; probably something you want to look at...&lt;/p&gt;</comment>
                            <comment id="13842424" author="lhofhansl" created="Sun, 8 Dec 2013 06:23:49 +0000"  >&lt;p&gt;Can do that + have ReplicationSource recheck periodically (it can interrogate the state from ZK). If we keep track when replication should have started and all logs are still present, we can automatically restart replication when the transient condition has been fixed.&lt;/p&gt;

&lt;p&gt;Also check out &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9746&quot; title=&quot;RegionServer can&amp;#39;t start when replication tries to replicate to an unknown host&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9746&quot;&gt;&lt;del&gt;HBASE-9746&lt;/del&gt;&lt;/a&gt;, the issue there is that a RegionServer won&apos;t start up if it has outstanding edit for a host that it can no longer resolve.&lt;/p&gt;</comment>
                            <comment id="13842922" author="churromorales" created="Mon, 9 Dec 2013 05:51:51 +0000"  >&lt;p&gt;Hi lars,&lt;/p&gt;

&lt;p&gt;I was thinking that we put some retry logic in the zk watcher, as well as have a Set&amp;lt;String&amp;gt; of ids where we failed to addPeers.  When we finally add the peer we remove it from the set.&lt;/p&gt;

&lt;p&gt;Then in logPositionAndCleanOldLogs method of ReplicationSourceManager we simply check to see if the id passed in is contained in the est of failed peers, if it is log a warning or error message and simply return.  When the peer finally does get added we can replay those logs.&lt;/p&gt;

&lt;p&gt;Does that sound like a viable solution?  If so I&apos;d love to submit a patch and get this fixed.&lt;br/&gt;
Thanks &lt;/p&gt;</comment>
                            <comment id="13843439" author="davelatham" created="Mon, 9 Dec 2013 19:25:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9746&quot; title=&quot;RegionServer can&amp;#39;t start when replication tries to replicate to an unknown host&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9746&quot;&gt;&lt;del&gt;HBASE-9746&lt;/del&gt;&lt;/a&gt; definitely seems related.  At least in that case you won&apos;t be accepting writes but failing to replicate or queue them to all defined peers.  I think it would be good to have this change apply to both scenarios - whether you add a peer to an existing RS or add a RS with an existing peer.  If it cannot resolve / reach the peer then the RS should continue to run and accept writes but queue them up until it can reach the peer.&lt;/p&gt;</comment>
                            <comment id="13880399" author="churromorales" created="Thu, 23 Jan 2014 21:41:15 +0000"  >&lt;p&gt;Sorry to take so long to come back to this.  But I have proposed a patch for this issue.  &lt;/p&gt;

&lt;p&gt;When adding a peer, if a certain subset of regionservers encounter DNS issues they should still queue up their replication logs until the connection to the peer can be established.  &lt;/p&gt;

&lt;p&gt;I&apos;d love to know what you guys think.&lt;/p&gt;</comment>
                            <comment id="14288051" author="churromorales" created="Thu, 22 Jan 2015 19:24:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; i just looked at trunk and 98 and I think its an easy patch (with tests).  I just took care of the low hanging fruit where we at least queue up the logs if this situation occurs.  Would you guys be interested in getting this upstream? &lt;/p&gt;</comment>
                            <comment id="14288117" author="apurtell" created="Thu, 22 Jan 2015 19:57:10 +0000"  >&lt;p&gt;Yes&lt;/p&gt;</comment>
                            <comment id="14288124" author="stack" created="Thu, 22 Jan 2015 19:59:28 +0000"  >&lt;p&gt;Yes from me too!&lt;/p&gt;</comment>
                            <comment id="14288143" author="lhofhansl" created="Thu, 22 Jan 2015 20:10:22 +0000"  >&lt;p&gt;My fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-9746&quot; title=&quot;RegionServer can&amp;#39;t start when replication tries to replicate to an unknown host&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-9746&quot;&gt;&lt;del&gt;HBASE-9746&lt;/del&gt;&lt;/a&gt; did not resolve this?&lt;/p&gt;

&lt;p&gt;The issue here is that we cannot resolve the ZK quorum, right?&lt;/p&gt;</comment>
                            <comment id="14292528" author="churromorales" created="Mon, 26 Jan 2015 22:29:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhofhansl&quot; class=&quot;user-hover&quot; rel=&quot;lhofhansl&quot;&gt;Lars Hofhansl&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Yes I believe that was the issue, we were having DNS issues and some of our regionservers received UnknownHostExceptions and then the source shutdown.  So about 200 machines out of 1100 or so were not replicating for a while and we found this out weeks later when doing consistency checks.  &lt;/p&gt;

&lt;p&gt;I am not very familiar with trunk, but looking at the code:&lt;br/&gt;
In HBaseInterClusterReplicationEndpoint.init() we do the following&lt;br/&gt;
this.conn = HConnectionManager.createConnection(this.conf);&lt;br/&gt;
and that connection is just passed off to &lt;br/&gt;
the constructor of ReplicationSinkManager&lt;/p&gt;

&lt;p&gt;Instead maybe we can lazily load the connection in ReplicationSinkManager and not even bother with it in HBaseInterClusterReplicationEndpoint since it doesn&apos;t really need it.  &lt;/p&gt;

&lt;p&gt;That way ReplicationSourceManager.getReplicationSource() should not throw that Exception. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; what do you guys think?  I haven&apos;t had too much time to look at the code and I&apos;m still trying to figure out a way to write some tests to reproduce this.  Since I am not as familiar with this code path as of yet, would love to hear your thoughts. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12624919" name="HBASE_10100-0.94.5.patch" size="11526" author="churromorales" created="Thu, 23 Jan 2014 21:46:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Sat, 7 Dec 2013 11:52:24 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362489</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 46 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qhfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362783</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>