<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:15:16 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4028/HBASE-4028.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4028] Hmaster crashes caused by splitting log.</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4028</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;In my performance cluster(0.90.3), The Hmaster memory from 100 M up to 4G when one region server crashed.&lt;br/&gt;
I added some print in function doneWriting and found the values of totalBuffered is negative.&lt;/p&gt;

&lt;p&gt;10:29:52,119 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: gjc:release Used -565832&lt;br/&gt;
hbase-root-master-157-5-111-21.log:2011-06-24 10:29:52,119 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: gjc:release Used -565832release size25168&lt;/p&gt;

&lt;p&gt;void doneWriting(RegionEntryBuffer buffer) {&lt;br/&gt;
      synchronized (this) &lt;/p&gt;
{
    	LOG.warn(&quot;gjc1: relase currentlyWriting +biggestBufferKey &quot; + buffer.encodedRegionName );
        boolean removed = currentlyWriting.remove(buffer.encodedRegionName);
        assert removed;
      }
&lt;p&gt;      long size = buffer.heapSize();&lt;/p&gt;

&lt;p&gt;      synchronized (dataAvailable) &lt;/p&gt;
{
        totalBuffered -= size;
        LOG.warn(&quot;gjc:release Used &quot; + totalBuffered );
        // We may unblock writers
        dataAvailable.notifyAll();
      }
&lt;p&gt;      LOG.warn(&quot;gjc:release Used &quot; + totalBuffered + &quot;release size&quot;+ size);&lt;br/&gt;
    }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12511441">HBASE-4028</key>
            <summary>Hmaster crashes caused by splitting log.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sunnygao">gaojinchao</assignee>
                                    <reporter username="sunnygao">gaojinchao</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Jun 2011 06:14:17 +0000</created>
                <updated>Fri, 20 Nov 2015 11:55:57 +0000</updated>
                            <resolved>Sun, 26 Jun 2011 00:34:46 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.90.4</fixVersion>
                                    <component>master</component>
                        <due>Fri, 24 Jun 2011 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13054385" author="koven2049" created="Fri, 24 Jun 2011 11:50:35 +0000"  >&lt;p&gt;gao, do you fix this problem after move &quot;totalBuffered += incrHeap;&quot; into &quot;synchronized (dataAvailable)&quot;?&lt;/p&gt;</comment>
                            <comment id="13054846" author="sunnygao" created="Sat, 25 Jun 2011 09:20:41 +0000"  >&lt;p&gt;Oh, my god! There is another bugs. It is Hidden.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
following code snippet&lt;br/&gt;
protected AtomicReference&amp;lt;Throwable&amp;gt; thrown = new AtomicReference&amp;lt;Throwable&amp;gt;();&lt;/p&gt;

&lt;p&gt;thrown.get is null but not thrown. So the below condition is wrong.&lt;br/&gt;
 while (totalBuffered &amp;gt; maxHeapUsage &amp;amp;&amp;amp; thrown == null) &lt;/p&gt;

&lt;p&gt;I have made a new patch. Please review it. Thanks.&lt;/p&gt;</comment>
                            <comment id="13054847" author="sunnygao" created="Sat, 25 Jun 2011 09:27:23 +0000"  >&lt;p&gt;The verified result:&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:18:53,768 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:18:56,768 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:18:59,768 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:19:02,768 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:19:05,769 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:19:08,769 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:19:11,769 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:19:14,769 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:19:17,769 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:19:20,770 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO threads...&lt;br/&gt;
hbase-root-master-157-5-111-22.log:2011-06-25 17:19:23,770 WARN org.apache.hadoop.hbase.regionserver.wal.HLogSplitter: Used 134314752 bytes of buffered edits, waiting for IO thre&lt;/p&gt;</comment>
                            <comment id="13054852" author="yuzhihong@gmail.com" created="Sat, 25 Jun 2011 10:06:21 +0000"  >&lt;p&gt;Thanks Gao for the patch. &lt;br/&gt;
I think the following can be simplified:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (totalBuffered &amp;gt; maxHeapUsage &amp;amp;&amp;amp; (thrown == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || thrown.get()== &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)){
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to this because writerThreadError() would only set thrown to a non-null Throwable:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (totalBuffered &amp;gt; maxHeapUsage &amp;amp;&amp;amp; thrown.get()== &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;){
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I am running the modified patch on 0.90 branch. Will commit if tests pass.&lt;/p&gt;</comment>
                            <comment id="13054853" author="yuzhihong@gmail.com" created="Sat, 25 Jun 2011 10:16:12 +0000"  >&lt;p&gt;@Jinchao: please generate the patch at the root of source tree.&lt;br/&gt;
Trying to apply your patch directly would give us:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[hadoop@xxx 90hbase]$ patch -p0 -i 4028.txt 
(Stripping trailing CRs from patch.)
can&apos;t find file to patch at input line 5
Perhaps you used the wrong -p or --strip option?
The text leading up to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; was:
--------------------------
|Index: java/org/apache/hadoop/hbase/regionserver/wal/HLogSplitter.java
|===================================================================
|--- java/org/apache/hadoop/hbase/regionserver/wal/HLogSplitter.java    (revision 1139163)
|+++ java/org/apache/hadoop/hbase/regionserver/wal/HLogSplitter.java    (working copy)
--------------------------
File to patch: 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The correct header of patch should be:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLogSplitter.java
===================================================================
--- src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLogSplitter.java    (revision 1139163)
+++ src/main/java/org/apache/hadoop/hbase/regionserver/wal/HLogSplitter.java    (working copy)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13054866" author="yuzhihong@gmail.com" created="Sat, 25 Jun 2011 11:42:20 +0000"  >&lt;p&gt;Patch committed to TRUNK.&lt;br/&gt;
Seems to have permission issue on 0.90 branch.&lt;/p&gt;</comment>
                            <comment id="13054867" author="yuzhihong@gmail.com" created="Sat, 25 Jun 2011 11:44:15 +0000"  >&lt;p&gt;All tests in 0.90 branch passed.&lt;/p&gt;</comment>
                            <comment id="13054990" author="yuzhihong@gmail.com" created="Sun, 26 Jun 2011 00:34:39 +0000"  >&lt;p&gt;Committed to 0.90 branch.&lt;/p&gt;

&lt;p&gt;Thanks for the patch jinchao.&lt;/p&gt;</comment>
                            <comment id="13055248" author="sunnygao" created="Mon, 27 Jun 2011 00:39:10 +0000"  >&lt;p&gt;Ted, Thanks for your work.&lt;/p&gt;</comment>
                            <comment id="13056849" author="hudson" created="Tue, 28 Jun 2011 22:42:49 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1995 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/1995/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/1995/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="15016621" author="lars_francke" created="Fri, 20 Nov 2015 11:55:57 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12483810" name="HBASE-4028-0.90V2" size="1332" author="sunnygao" created="Sat, 25 Jun 2011 09:21:17 +0000"/>
                            <attachment id="12483672" name="Screenshot-2.png" size="67941" author="sunnygao" created="Fri, 24 Jun 2011 06:17:12 +0000"/>
                            <attachment id="12483811" name="Verifiedresult.png" size="255875" author="sunnygao" created="Sat, 25 Jun 2011 09:38:36 +0000"/>
                            <attachment id="12483673" name="hbase-root-master-157-5-100-8.rar" size="29725" author="sunnygao" created="Fri, 24 Jun 2011 06:22:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 24 Jun 2011 11:50:35 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27135</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hp27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101322</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>