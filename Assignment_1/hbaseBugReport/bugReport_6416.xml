<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:36:34 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-6416/HBASE-6416.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-6416] hbck dies on NPE when a region folder exists but the table does not</title>
                <link>https://issues.apache.org/jira/browse/HBASE-6416</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;This is what I&apos;m getting for leftover data that has no .regioninfo&lt;/p&gt;

&lt;p&gt;First:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;12/07/17 23:13:37 WARN util.HBaseFsck: Failed to read .regioninfo file for region null&lt;br/&gt;
java.io.FileNotFoundException: File does not exist: /hbase/stumble_info_urlid_user/bd5f6cfed674389b4d7b8c1be227cb46/.regioninfo&lt;br/&gt;
	at org.apache.hadoop.hdfs.DFSClient$DFSInputStream.openInfo(DFSClient.java:1822)&lt;br/&gt;
	at org.apache.hadoop.hdfs.DFSClient$DFSInputStream.&amp;lt;init&amp;gt;(DFSClient.java:1813)&lt;br/&gt;
	at org.apache.hadoop.hdfs.DFSClient.open(DFSClient.java:544)&lt;br/&gt;
	at org.apache.hadoop.hdfs.DistributedFileSystem.open(DistributedFileSystem.java:187)&lt;br/&gt;
	at org.apache.hadoop.fs.FileSystem.open(FileSystem.java:456)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck.loadHdfsRegioninfo(HBaseFsck.java:611)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck.access$2200(HBaseFsck.java:140)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck$WorkItemHdfsRegionInfo.call(HBaseFsck.java:2882)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck$WorkItemHdfsRegionInfo.call(HBaseFsck.java:2866)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:206)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Then it hangs on:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;12/07/17 23:13:39 INFO util.HBaseFsck: Attempting to handle orphan hdfs dir: hdfs://sfor3s24:10101/hbase/stumble_info_urlid_user/bd5f6cfed674389b4d7b8c1be227cb46&lt;br/&gt;
12/07/17 23:13:39 INFO util.HBaseFsck: checking orphan for table null&lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck$TableInfo.access$100(HBaseFsck.java:1634)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck.adoptHdfsOrphan(HBaseFsck.java:435)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck.adoptHdfsOrphans(HBaseFsck.java:408)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck.restoreHdfsIntegrity(HBaseFsck.java:529)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck.offlineHdfsIntegrityRepair(HBaseFsck.java:313)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck.onlineHbck(HBaseFsck.java:386)&lt;br/&gt;
	at org.apache.hadoop.hbase.util.HBaseFsck.main(HBaseFsck.java:3227)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The NPE is sent by:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Preconditions.checkNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;Table &quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; not present!&quot;&lt;/span&gt;, tableInfo);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I wonder why the condition checking was added if we don&apos;t handle it... In any case hbck dies but it hangs because there are some non-daemon hanging around.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12599192">HBASE-6416</key>
            <summary>hbck dies on NPE when a region folder exists but the table does not</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="jmhsieh">Jonathan Hsieh</assignee>
                                    <reporter username="jdcryans">Jean-Daniel Cryans</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jul 2012 23:18:59 +0000</created>
                <updated>Sun, 12 Oct 2014 03:55:21 +0000</updated>
                                                            <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                <comments>
                            <comment id="13450616" author="grace.huang" created="Fri, 7 Sep 2012 13:34:06 +0000"  >&lt;p&gt;Yes. The problem can be reproduced in my test environment. And here attaches one fix for this bug to solve that &lt;b&gt;hanging around&lt;/b&gt; issue. &lt;/p&gt;

&lt;p&gt;According to the jstack result, the most suspicious threads are those &quot;pool-1-thread-*&quot; threads (which are not daemon).  I guess it is caused by the following ExecutionException, which leads to an incomplete FutureTask.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i&amp;lt;hbiFutures.size(); i++) {
      WorkItemHdfsRegionInfo work = hbis.get(i);
      Future&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; f = hbiFutures.get(i);
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        f.get();
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(ExecutionException e) {
        LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to read .regioninfo file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region &quot;&lt;/span&gt; +
              work.hbi.getRegionNameAsString(), e.getCause());
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The simple and quick fix is to shutdown the ExecutorService finally in exec() function.&lt;br/&gt;
Now, in my test environment, the process will be terminated with that NPE after applied this patch. &lt;/p&gt;</comment>
                            <comment id="13450810" author="jmhsieh" created="Fri, 7 Sep 2012 17:27:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=grace.huang&quot; class=&quot;user-hover&quot; rel=&quot;grace.huang&quot;&gt;Jie Huang&lt;/a&gt; do you want to tackle the other part of the problem as well?&lt;/p&gt;

&lt;p&gt;We could probably do the check but instead of using Precondtions, handled it like the dirs == null case where we warn, and return.&lt;/p&gt;</comment>
                            <comment id="13451588" author="grace.huang" created="Sun, 9 Sep 2012 12:46:47 +0000"  >&lt;p&gt;Yes. No problem. I will try to handle the other part too. Thanks for your suggestion. I will upload a new patch file soon. &lt;/p&gt;

&lt;p&gt;Meanwhile, I wonder if we need to tell the user to run &quot;-fixOrphanTable&quot; at first, and then re-run &quot;-fixHdfsOrphan&quot; again. Since it can somehow help them repair the system when facing the similar problems.&lt;/p&gt;</comment>
                            <comment id="13451733" author="grace.huang" created="Mon, 10 Sep 2012 02:22:12 +0000"  >&lt;p&gt;Done with quick fix. &lt;/p&gt;</comment>
                            <comment id="13451746" author="jmhsieh" created="Mon, 10 Sep 2012 03:26:37 +0000"  >&lt;p&gt;You mean -fixTableOrphans in here instead of -fixHdfsOrphans right?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-    Preconditions.checkNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;Table &quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; not present!&quot;&lt;/span&gt;, tableInfo);
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tableInfo == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Table &apos;&quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; not present!&quot;&lt;/span&gt;);
+      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Try to fix table &apos;&quot;&lt;/span&gt; + tableName + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos; before -fixHdfsOrphans&quot;&lt;/span&gt;);
+      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, I&apos;d be fine if 1) the code fixed tableinfo orphans and then fixed region orphans if both option are specified, or 2) if the table orphans are fixed and we warn the user about having to run again using the option.  Off the top of my head, I don&apos;t know if that is the case.  Can you look into that and pick one of the approaches?&lt;/p&gt;</comment>
                            <comment id="13455521" author="grace.huang" created="Fri, 14 Sep 2012 01:29:19 +0000"  >&lt;p&gt;Sorry for my late response. &lt;/p&gt;

&lt;p&gt;My concern is that now we try to fix .tableinfo file during the online phase, which only happens after the offline phase. However, the fixHdfsOrphan does happen during the offline phase. I wonder if it is possible to recover those missing files respectively. And then, re-run the hbck for a better status.&lt;/p&gt;</comment>
                            <comment id="13455771" author="jmhsieh" created="Fri, 14 Sep 2012 13:16:17 +0000"  >&lt;p&gt;I think that having to run hbck multiple times to clean up the corruptions, though not ideal, is acceptable.  Ideally the tool will tell the user that they need to do that.  At the end of the day, if hbase is down, having a slightly inefficient automatic solution to fix it is better than having no solution to automatically fix it.&lt;/p&gt;</comment>
                            <comment id="13482995" author="lhofhansl" created="Wed, 24 Oct 2012 05:35:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmhsieh&quot; class=&quot;user-hover&quot; rel=&quot;jmhsieh&quot;&gt;Jonathan Hsieh&lt;/a&gt; Are you saying we should close this?&lt;/p&gt;</comment>
                            <comment id="13535737" author="lhofhansl" created="Wed, 19 Dec 2012 07:18:29 +0000"  >&lt;p&gt;Shifting to 0.94.5&lt;/p&gt;</comment>
                            <comment id="13651146" author="jdcryans" created="Tue, 7 May 2013 18:26:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmhsieh&quot; class=&quot;user-hover&quot; rel=&quot;jmhsieh&quot;&gt;Jonathan Hsieh&lt;/a&gt; so were you cool with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=grace.huang&quot; class=&quot;user-hover&quot; rel=&quot;grace.huang&quot;&gt;Jie Huang&lt;/a&gt;&apos;s patch or not?&lt;/p&gt;</comment>
                            <comment id="13861067" author="jmhsieh" created="Fri, 3 Jan 2014 01:22:48 +0000"  >&lt;p&gt;sorry I went awol here.  let me page this back in to make a call on this patch.&lt;/p&gt;</comment>
                            <comment id="13861073" author="jmhsieh" created="Fri, 3 Jan 2014 01:29:02 +0000"  >&lt;p&gt;As it stands, we need a unit test for this patch.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=grace.huang&quot; class=&quot;user-hover&quot; rel=&quot;grace.huang&quot;&gt;Jie Huang&lt;/a&gt; if you are still around sorry for the long delay &amp;#8211; ping and I&apos;ll review again.  For now I&apos;ll assign to myself for now and fix it eventually.&lt;/p&gt;</comment>
                            <comment id="14168508" author="enis" created="Sun, 12 Oct 2014 03:55:21 +0000"  >&lt;p&gt;Unscheduling from branch-1. Feel free to bring back if there is an updated patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12544425" name="hbase-6416-v1.patch" size="4883" author="grace.huang" created="Mon, 10 Sep 2012 02:22:12 +0000"/>
                            <attachment id="12544214" name="hbase-6416.patch" size="2240" author="grace.huang" created="Fri, 7 Sep 2012 13:34:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 7 Sep 2012 13:34:06 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241814</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02dbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11758</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>