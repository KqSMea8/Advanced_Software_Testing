<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 18:55:47 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-1718/HBASE-1718.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-1718] Reuse of KeyValue during log replay could cause the wrong data to be used</title>
                <link>https://issues.apache.org/jira/browse/HBASE-1718</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;Our meta table got a row key of METAROW in it.  Hard to explain how it happened, but under code inspection stack found that we are reusing the same KV instance for each replayed key.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12431642">HBASE-1718</key>
            <summary>Reuse of KeyValue during log replay could cause the wrong data to be used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="streamy">Jonathan Gray</assignee>
                                    <reporter username="streamy">Jonathan Gray</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Jul 2009 23:46:10 +0000</created>
                <updated>Sun, 13 Sep 2009 22:24:53 +0000</updated>
                            <resolved>Wed, 29 Jul 2009 00:59:53 +0000</resolved>
                                    <version>0.20.0</version>
                                    <fixVersion>0.20.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                <comments>
                            <comment id="12736367" author="streamy" created="Tue, 28 Jul 2009 23:49:58 +0000"  >&lt;p&gt;Instantiates a new KeyValue at the end of the while loop, meaning we only re-instantiate once we&apos;ve passed forward the KV (we can reuse the times we do continue).&lt;/p&gt;</comment>
                            <comment id="12736369" author="jdcryans" created="Tue, 28 Jul 2009 23:53:25 +0000"  >&lt;p&gt;+1 seems fine.&lt;/p&gt;</comment>
                            <comment id="12736384" author="stack" created="Wed, 29 Jul 2009 00:33:57 +0000"  >&lt;p&gt;+1 on patch.&lt;/p&gt;

&lt;p&gt;Its hard to test.&lt;/p&gt;

&lt;p&gt;Here is my supposition as to why this might be responsible for hbase-1638.&lt;/p&gt;

&lt;p&gt;Server crashes, its logs are split.  The crashed servers regions are opened anew and there are logs for them to replay.&lt;/p&gt;

&lt;p&gt;The inner loop playing the reconstruction logs is this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (logReader.next(key, val)) {
        maxSeqIdInLog = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(maxSeqIdInLog, key.getLogSeqNum());
        .....
        &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; edit is &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; me. Also, guard against writing the special
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// METACOLUMN info such as HBASE::CACHEFLUSH entries
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (/* commented out &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; now - stack via jgray key.isTransactionEntry() || */
            val.matchingFamily(HLog.METAFAMILY) ||
          !Bytes.equals(key.getRegionName(), regioninfo.getRegionName()) ||
          !val.matchingFamily(family.getName())) {
          &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
        }
        &lt;span class=&quot;code-comment&quot;&gt;// Add anything as value as &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; as we use same instance each time.
&lt;/span&gt;        reconstructedCache.add(val);
        ....
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, a value might clear the family checks and get added to the reconstructionCache.&lt;/p&gt;

&lt;p&gt;We call next again.  The &apos;val&apos; instance is up in reconstructionCache.  The next deserializes a new KV into same instance.   The deserialized value might not make it past family checks but its already in the reconstructionCache.&lt;/p&gt;

&lt;p&gt;This would account for our adding a single value. &lt;/p&gt;</comment>
                            <comment id="12736385" author="stack" created="Wed, 29 Jul 2009 00:34:11 +0000"  >&lt;p&gt;Single bad value.&lt;/p&gt;</comment>
                            <comment id="12736401" author="streamy" created="Wed, 29 Jul 2009 00:59:53 +0000"  >&lt;p&gt;Committed.  Upon further thought, this &lt;em&gt;could&lt;/em&gt; create cross-family scenario we&apos;ve seen in &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1638&quot; title=&quot;hfile has entry from wrong family&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1638&quot;&gt;&lt;del&gt;HBASE-1638&lt;/del&gt;&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-1715&quot; title=&quot;compaction failure in ScanWildcardColumnTracker.checkColumn&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-1715&quot;&gt;&lt;del&gt;HBASE-1715&lt;/del&gt;&lt;/a&gt; (but apurtell says no replay).  It does, however, seem to be the case that this bug completely broke log replay as you would always end up only having the last seen KV.&lt;/p&gt;</comment>
                            <comment id="12736408" author="stack" created="Wed, 29 Jul 2009 01:32:31 +0000"  >&lt;p&gt;So, at a minimum, this patch fixes replaying of logs:&lt;/p&gt;

&lt;p&gt;Below I added logging.  Replay had 17k edits.  Only one was added, the last one.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
....
2009-07-29 01:27:15,274 [regionserver/208.76.44.139:60020.worker] INFO org.apache.hadoop.hbase.regionserver.Store: ADDED TO RECON CACHE: \x00\x00\x00\x03\x00\x01\x07\x02\x08\x05/info:data/1248830494586/Put/vlen=1000
2009-07-29 01:27:15,274 [regionserver/208.76.44.139:60020.worker] DEBUG org.apache.hadoop.hbase.regionserver.Store: Applied 17286, skipped 0 because sequence id &amp;lt;= 22830124
2009-07-29 01:27:15,274 [regionserver/208.76.44.139:60020.worker] DEBUG org.apache.hadoop.hbase.regionserver.Store: flushing reconstructionCache: 1
2009-07-29 01:27:15,274 [regionserver/208.76.44.139:60020.worker] INFO org.apache.hadoop.hbase.regionserver.Store: DUMP \x00\x00\x00\x03\x00\x01\x07\x02\x08\x05/info:data/1248830494586/Put/vlen=1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I thought this was hbase-1483 but that was in splitLog.  This is something else.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12414819" name="HBASE-1718-v1.patch" size="638" author="streamy" created="Tue, 28 Jul 2009 23:49:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Tue, 28 Jul 2009 23:53:25 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25937</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 21 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hevj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>99672</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>