<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 20:17:52 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-10859/HBASE-10859.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-10859] Use HFileLink in opening region files from secondaries</title>
                <link>https://issues.apache.org/jira/browse/HBASE-10859</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We sometimes see the following stack trace on test logs (TestReplicasClient), but this is not test-specific:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2014-03-26 21:44:18,662 ERROR [RS_OPEN_REGION-c64-s12:35852-2] handler.OpenRegionHandler(481): Failed open of region=TestReplicasClient,,1395895445056_0001.5f8b8db27e36d2dde781193d92a05730., starting to roll back the global memstore size.
java.io.IOException: java.io.IOException: java.io.FileNotFoundException: File does not exist: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:56276/user/jenkins/hbase/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/TestReplicasClient/856934fb87781c9030975706b66137a5/info/589000f197b048e0897e1d81dd7e3a90
&lt;/span&gt;  at org.apache.hadoop.hbase.regionserver.HRegion.initializeRegionStores(HRegion.java:739)
  at org.apache.hadoop.hbase.regionserver.HRegion.initializeRegionInternals(HRegion.java:646)
  at org.apache.hadoop.hbase.regionserver.HRegion.initialize(HRegion.java:617)
  at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:4447)
  at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:4417)
  at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:4389)
  at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:4345)
  at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:4296)
  at org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler.openRegion(OpenRegionHandler.java:465)
  at org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler.process(OpenRegionHandler.java:139)
  at org.apache.hadoop.hbase.executor.EventHandler.run(EventHandler.java:128)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
Caused by: java.io.IOException: java.io.FileNotFoundException: File does not exist: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:56276/user/jenkins/hbase/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/TestReplicasClient/856934fb87781c9030975706b66137a5/info/589000f197b048e0897e1d81dd7e3a90
&lt;/span&gt;  at org.apache.hadoop.hbase.regionserver.HStore.openStoreFiles(HStore.java:531)
  at org.apache.hadoop.hbase.regionserver.HStore.loadStoreFiles(HStore.java:486)
  at org.apache.hadoop.hbase.regionserver.HStore.&amp;lt;init&amp;gt;(HStore.java:254)
  at org.apache.hadoop.hbase.regionserver.HRegion.instantiateHStore(HRegion.java:3357)
  at org.apache.hadoop.hbase.regionserver.HRegion$1.call(HRegion.java:710)
  at org.apache.hadoop.hbase.regionserver.HRegion$1.call(HRegion.java:707)
  at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
  at java.util.concurrent.FutureTask.run(FutureTask.java:166)
  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
  at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
  at java.util.concurrent.FutureTask.run(FutureTask.java:166)
  ... 3 more
Caused by: java.io.FileNotFoundException: File does not exist: hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:56276/user/jenkins/hbase/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/TestReplicasClient/856934fb87781c9030975706b66137a5/info/589000f197b048e0897e1d81dd7e3a90
&lt;/span&gt;  at org.apache.hadoop.hdfs.DistributedFileSystem$17.doCall(DistributedFileSystem.java:1128)
  at org.apache.hadoop.hdfs.DistributedFileSystem$17.doCall(DistributedFileSystem.java:1120)
  at org.apache.hadoop.fs.FileSystemLinkResolver.resolve(FileSystemLinkResolver.java:81)
  at org.apache.hadoop.hdfs.DistributedFileSystem.getFileStatus(DistributedFileSystem.java:1120)
  at org.apache.hadoop.fs.FilterFileSystem.getFileStatus(FilterFileSystem.java:397)
  at org.apache.hadoop.hbase.regionserver.StoreFileInfo.&amp;lt;init&amp;gt;(StoreFileInfo.java:95)
  at org.apache.hadoop.hbase.regionserver.HStore.createStoreFileAndReader(HStore.java:600)
  at org.apache.hadoop.hbase.regionserver.HStore.access$000(HStore.java:121)
  at org.apache.hadoop.hbase.regionserver.HStore$1.call(HStore.java:506)
  at org.apache.hadoop.hbase.regionserver.HStore$1.call(HStore.java:503)
  ... 8 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The region fails to open for the region replica, because at this time, the primary region is performing a compaction. The file is moved to the archive directory in between listing of store files and opening those store files from the secondary. &lt;/p&gt;

&lt;p&gt;The secondary region should able to deal with this through usage of StoreFileInfo and HFile, but since we are reconstructing the StoreFileInfo object twice between HStore.openStoreFiles() and createStoreFileAndReader() we are getting this exception. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12704142">HBASE-10859</key>
            <summary>Use HFileLink in opening region files from secondaries</summary>
                <type id="7" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png">Sub-task</type>
                            <parent id="12682280">HBASE-10070</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enis">Enis Soztutar</assignee>
                                    <reporter username="enis">Enis Soztutar</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Mar 2014 00:06:20 +0000</created>
                <updated>Sat, 21 Feb 2015 23:30:39 +0000</updated>
                            <resolved>Tue, 8 Apr 2014 15:53:03 +0000</resolved>
                                                    <fixVersion>0.99.0</fixVersion>
                    <fixVersion>hbase-10070</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13950326" author="enis" created="Fri, 28 Mar 2014 03:31:43 +0000"  >&lt;p&gt;This turned out to be a bit more involved than the description. It seems that the way we open the store files of the primary from secondaries (&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10352&quot; title=&quot;Region and RegionServer changes for opening region replicas, and refreshing store files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10352&quot;&gt;&lt;del&gt;HBASE-10352&lt;/del&gt;&lt;/a&gt;) does not use the HFileLink. I thought it was using it automatically, but does not look like it is the case. The secondary region reads was still working even when the primary does compaction (TestRegionReplicas.testRefreshStoreFiles() for example) because we open the file handle in hdfs, and even if the file is moved we would be able to read it because blocks are open. &lt;/p&gt;

&lt;p&gt;However, it seems that we should force using the HFileLink for opening the store files from secondaries using the FileLink.FileLinkInputStream, which gives us the guarantees for reading hfile from data or archive location. &lt;/p&gt;</comment>
                            <comment id="13950327" author="enis" created="Fri, 28 Mar 2014 03:34:39 +0000"  >&lt;p&gt;Here is a patch, which basically enforces use of HFileLink. I&apos;ll also add a more comprehensive concurrent compaction + read from secondary test. &lt;/p&gt;</comment>
                            <comment id="13951011" author="ndimiduk" created="Fri, 28 Mar 2014 16:49:07 +0000"  >&lt;p&gt;The patch looks good overall. This comment catches my attention though&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+    // else create a store file link. The link file does not exists on filesystem though.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think this could come as a surprise to other parts of the code, assuming the link does indeed exist.&lt;/p&gt;</comment>
                            <comment id="13951015" author="ndimiduk" created="Fri, 28 Mar 2014 16:51:51 +0000"  >&lt;p&gt;Further, it establishes a divergent model &amp;#8211; what&apos;s understood in the in-memory model vs the reality of what&apos;s on disk.&lt;/p&gt;</comment>
                            <comment id="13951098" author="devaraj" created="Fri, 28 Mar 2014 17:32:37 +0000"  >&lt;p&gt;The patch looks good to me.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndimiduk&quot; class=&quot;user-hover&quot; rel=&quot;ndimiduk&quot;&gt;Nick Dimiduk&lt;/a&gt;, on the topic of in-memory vs disk, we probably could abstract away some functionality from HFileLink to something like InMemoryFileLink. Have HFileLink extend InMemoryFileLink and implement the &quot;real&quot; file-link stuff...&lt;/p&gt;</comment>
                            <comment id="13951146" author="sershe" created="Fri, 28 Mar 2014 18:01:34 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13951201" author="enis" created="Fri, 28 Mar 2014 18:40:29 +0000"  >&lt;p&gt;Thanks for reviews. I have a test where there is a writer, a flush and compaction requester and a thread which does reads against the secondary. I am trying to get this test failing before the patch to demonstrate the problem but it seems that it is more robust than expected. I&apos;ll try to adjust the test. &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Further, it establishes a divergent model &#8211; what&apos;s understood in the in-memory model vs the reality of what&apos;s on disk.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That is a valid concern. I&apos;ve thought about making the hfilelinks concrete. We can create region directories for the secondary replicas, and save the hfile links to the primary replica in those directories. We opted not to do so, because it looks like these will be not required and an unnecessary burden on the namenode. We can revisit that decision if it becomes a problem. &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;InMemoryFileLink&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;let me see whether I can do a subclass of HFileLink. &lt;/p&gt;</comment>
                            <comment id="13951823" author="enis" created="Sat, 29 Mar 2014 10:04:55 +0000"  >&lt;p&gt;Here is a v2 patch, which apart from the v1 patch: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Adds a unit test for doing concurrent compaction+flushes in primary, and reading and reopening from secondary. This test reveals two minor issues as below which are fixed in this patch as well.&lt;/li&gt;
	&lt;li&gt;compute hdfs block distribution does not work for hfile link if the link location is moved in between getting the file status and getting the block locations. We now retry on FileNotFoundException&lt;/li&gt;
	&lt;li&gt;On region open, the secondaries does not replay the recovered edits file (since it causes a flush and deletes the log files). Also .tmp directory is not removed.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13951824" author="enis" created="Sat, 29 Mar 2014 10:05:10 +0000"  >&lt;p&gt;This version should be ready to go in. &lt;/p&gt;</comment>
                            <comment id="13956675" author="stack" created="Tue, 1 Apr 2014 15:54:51 +0000"  >&lt;p&gt;Patch looks great &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enis&quot; class=&quot;user-hover&quot; rel=&quot;enis&quot;&gt;Enis Soztutar&lt;/a&gt; +1&lt;/p&gt;</comment>
                            <comment id="13956783" author="ndimiduk" created="Tue, 1 Apr 2014 17:18:08 +0000"  >&lt;p&gt;Nice. Only one question/nit: for these loops, does it make sense/matter to throw the first exception instead of the last one?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+        for (int i = 0; i &amp;lt; this.link.getLocations().length; i++) {
+          // HFileLink Reference
+          try {
+            status = link.getFileStatus(fs);
+            return computeRefFileHDFSBlockDistribution(fs, reference, status);
+          } catch (FileNotFoundException ex) {
+            // try the other location
+            exToThrow = ex;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13963108" author="enis" created="Tue, 8 Apr 2014 15:53:03 +0000"  >&lt;p&gt;Thanks for reviews! I&apos;ve committed this to hbase-10070. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Nice. Only one question/nit: for these loops, does it make sense/matter to throw the first exception instead of the last one?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;All exceptions are FNFE from the locations of the FileLink. It won&apos;t matter that much whether we are throwing the first or the last. &lt;/p&gt;</comment>
                            <comment id="14046630" author="enis" created="Sat, 28 Jun 2014 01:47:55 +0000"  >&lt;p&gt;Attaching rebased patch for master that is committed&lt;/p&gt;</comment>
                            <comment id="14046678" author="enis" created="Sat, 28 Jun 2014 02:08:53 +0000"  >&lt;p&gt;Committed to master as part of hbase-10070 branch merge&lt;/p&gt;</comment>
                            <comment id="14046746" author="hudson" created="Sat, 28 Jun 2014 06:13:55 +0000"  >&lt;p&gt;FAILURE: Integrated in HBase-TRUNK #5245 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/5245/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/5245/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-10859&quot; title=&quot;Use HFileLink in opening region files from secondaries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-10859&quot;&gt;&lt;del&gt;HBASE-10859&lt;/del&gt;&lt;/a&gt; Use HFileLink in opening region files from secondaries (enis: rev 7d247524b355c1014453d2a6ef69797ce8f54769)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/util/ServerRegionReplicaUtil.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreFileInfo.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerNoMaster.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestReplicasClient.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStoreFileRefresherChore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestStore.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionReplicas.java&lt;/li&gt;
	&lt;li&gt;hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionFileSystem.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14330721" author="enis" created="Sat, 21 Feb 2015 23:30:39 +0000"  >&lt;p&gt;Closing this issue after 0.99.0 release. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12652968" name="0030-HBASE-10859-Use-HFileLink-in-opening-region-files-fr.patch" size="27051" author="enis" created="Sat, 28 Jun 2014 01:47:54 +0000"/>
                            <attachment id="12637321" name="hbase-10859_v1.patch" size="11799" author="enis" created="Fri, 28 Mar 2014 03:34:39 +0000"/>
                            <attachment id="12637620" name="hbase-10859_v2.patch" size="22791" author="enis" created="Sat, 29 Mar 2014 10:04:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 28 Mar 2014 16:49:07 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382476</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tw73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382745</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>