<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 19:15:08 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-4016/HBASE-4016.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-4016] HRegion.incrementColumnValue() doesn&apos;t have a consistent behavior when the field that we are incrementing is less than 8 bytes long</title>
                <link>https://issues.apache.org/jira/browse/HBASE-4016</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;We wanted to use an int (32-bit) atomic counter and we initialize it with a certain value when the row is created. Later, we increment the counter using HTable.incrementColumnValue(). This call results in one of two outcomes. &lt;/p&gt;

&lt;p&gt;1. The call succeeds, but the column value now is a long (64-bit) and is corrupt (by additional data that was in the buffer read).&lt;br/&gt;
2. Throws IOException/IllegalArgumentException.&lt;br/&gt;
Java.io.IOException: java.io.IOException: java.lang.IllegalArgumentException: offset (65547) + length (8) exceed the capacity of the array: 65551&lt;br/&gt;
        at org.apache.hadoop.hbase.util.Bytes.explainWrongLengthOrOffset(Bytes.java:502)&lt;br/&gt;
        at org.apache.hadoop.hbase.util.Bytes.toLong(Bytes.java:480)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.HRegion.incrementColumnValue(HRegion.java:3139)&lt;br/&gt;
        at org.apache.hadoop.hbase.regionserver.HRegionServer.incrementColumnValue(HRegionServer.java:2468)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor24.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.hadoop.hbase.ipc.HBaseRPC$Server.call(HBaseRPC.java:570)&lt;br/&gt;
        at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.java:1039)&lt;/p&gt;

&lt;p&gt;Based on our incorrect usage of counters (initializing it with a 32 bit value and later using it as a counter), I would expect that we fail consistently with mode 2 rather than silently corrupting data with mode 1. However, the exception is thrown only rarely and I am not sure what determines the case to be executed. I am wondering if this has something to do with flush.&lt;/p&gt;

&lt;p&gt;Here is a HRegion unit test that can reproduce this problem. &lt;a href=&quot;http://paste.lisp.org/display/122822&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://paste.lisp.org/display/122822&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We modified our code to initialize the counter with a 64 bit value. But, I was also wondering if something has to change in HRegion.incrementColumnValue() to handle inconsistent counter sizes gracefully without corrupting existing data.&lt;/p&gt;

&lt;p&gt;Please let me know if you need additional information.&lt;/p&gt;</description>
                <environment>&lt;p&gt;$ cat /etc/release &lt;br/&gt;
                      Oracle Solaris 11 Express snv_151a X86&lt;br/&gt;
     Copyright (c) 2010, Oracle and/or its affiliates.  All rights reserved.&lt;br/&gt;
                           Assembled 04 November 2010&lt;/p&gt;

&lt;p&gt;$ java -version&lt;br/&gt;
java version &quot;1.6.0_21&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_21-b06)&lt;br/&gt;
Java HotSpot(TM) Server VM (build 17.0-b16, mixed mode)&lt;/p&gt;</environment>
        <key id="12511184">HBASE-4016</key>
            <summary>HRegion.incrementColumnValue() doesn&apos;t have a consistent behavior when the field that we are incrementing is less than 8 bytes long</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="li">Li Pi</assignee>
                                    <reporter username="kprav33n">Praveen Kumar</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Jun 2011 23:07:46 +0000</created>
                <updated>Fri, 20 Nov 2015 11:53:05 +0000</updated>
                            <resolved>Tue, 28 Jun 2011 23:36:32 +0000</resolved>
                                    <version>0.90.3</version>
                                    <fixVersion>0.92.0</fixVersion>
                                    <component>regionserver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13052963" author="tlipcon" created="Wed, 22 Jun 2011 00:13:17 +0000"  >&lt;p&gt;Your code is storing strings in the cells, but incrementColumnValue expects a big-endian encoded long, not a string.&lt;/p&gt;</comment>
                            <comment id="13053367" author="jdcryans" created="Wed, 22 Jun 2011 18:08:25 +0000"  >&lt;p&gt;Todd, I reviewed this with Praveen before he created this jira and his point is that the error reporting seems buggy when trying to increment a cell that doesn&apos;t contain a long, not that a string or int cannot be incremented.&lt;/p&gt;</comment>
                            <comment id="13053539" author="kprav33n" created="Wed, 22 Jun 2011 23:32:55 +0000"  >&lt;p&gt;The cell that is being incremented, (row1,fam1,qual1) store an int (4 bytes) not a string. I think you are confusing the row key with the cell value. There was a minor issue with the old patch and I have revised it to fix it. The new one is available at &lt;a href=&quot;http://paste.lisp.org/+2MRQ/1&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://paste.lisp.org/+2MRQ/1&lt;/a&gt; I am reopening the issue.&lt;/p&gt;</comment>
                            <comment id="13054075" author="li" created="Thu, 23 Jun 2011 20:12:30 +0000"  >&lt;p&gt;Fixed this. Btw - Praveen, your test is broken. even if you comment out    l&lt;br/&gt;
    long result;&lt;br/&gt;
    try &lt;/p&gt;
{
        result = region.incrementColumnValue(row1, fam1, qual1, 1, true);
        fail(&quot;Expected to fail here&quot;);
    }
&lt;p&gt; catch (Exception exception) &lt;/p&gt;
{
        // Expected.
    }
&lt;p&gt;,&lt;/p&gt;

&lt;p&gt;the assertICV&apos;s still fail.&lt;/p&gt;</comment>
                            <comment id="13054100" author="li" created="Thu, 23 Jun 2011 21:16:10 +0000"  >&lt;p&gt;checks length of stored value before incrementing.&lt;/p&gt;</comment>
                            <comment id="13054102" author="li" created="Thu, 23 Jun 2011 21:16:39 +0000"  >&lt;p&gt;also fixed Praveen&apos;s tests.&lt;/p&gt;</comment>
                            <comment id="13056888" author="stack" created="Tue, 28 Jun 2011 23:36:32 +0000"  >&lt;p&gt;Applied to TRUNK.  Thanks for the patch Li Pi.&lt;/p&gt;</comment>
                            <comment id="13056938" author="hudson" created="Wed, 29 Jun 2011 01:25:26 +0000"  >&lt;p&gt;Integrated in HBase-TRUNK #1996 (See &lt;a href=&quot;https://builds.apache.org/job/HBase-TRUNK/1996/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/HBase-TRUNK/1996/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-4016&quot; title=&quot;HRegion.incrementColumnValue() doesn&amp;#39;t have a consistent behavior when the field that we are incrementing is less than 8 bytes long&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-4016&quot;&gt;&lt;del&gt;HBASE-4016&lt;/del&gt;&lt;/a&gt; HRegion.incrementColumnValue() doesn&apos;t have a consistent behavior when the field that we are incrementing is less than 8 bytes long&lt;/p&gt;

&lt;p&gt;stack : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegion.java&lt;/li&gt;
	&lt;li&gt;/hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15015904" author="lars_francke" created="Fri, 20 Nov 2015 11:53:05 +0000"  >&lt;p&gt;This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12483641" name="4016.diff" size="5391" author="li" created="Thu, 23 Jun 2011 21:16:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 22 Jun 2011 00:13:17 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>27130</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hozr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>101311</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Throws IOException if you attempt to increment a column that isn&amp;#39;t exactly 8 bytes long. Includes test for this.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>